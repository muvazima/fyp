@&#MAIN-TITLE@&#Bilateral filter regularized accelerated Demons for improved discontinuity preserving registration

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           Replacement the Gaussian filter with a bilateral filter were proposed.


                        
                        
                           
                           Image registration approach that better handles the discontinuities proposed.


                        
                        
                           
                           Approach was tested and compared on 2D liver and 3D lung images.


                        
                        
                           
                           Higher computational cost for the method is caused by the complex computation.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Image-guided therapy

Medical image registration

Discontinuities

Demons method

Bilateral filter

@&#ABSTRACT@&#


               
               
                  The classical accelerated Demons algorithm uses Gaussian smoothing to penalize oscillatory motion in the displacement fields during registration. This well known method uses the L2 norm for regularization. Whereas the L2 norm is known for producing well behaving smooth deformation fields it cannot properly deal with discontinuities often seen in the deformation field as the regularizer cannot differentiate between discontinuities and smooth part of motion field.
                  In this paper we propose replacement the Gaussian filter of the accelerated Demons with a bilateral filter. In contrast the bilateral filter not only uses information from displacement field but also from the image intensities. In this way we can smooth the motion field depending on image content as opposed to the classical Gaussian filtering. By proper adjustment of two tunable parameters one can obtain more realistic deformations in a case of discontinuity. The proposed approach was tested on 2D and 3D datasets and showed significant improvements in the Target Registration Error (TRE) for the well known POPI dataset.
                  Despite the increased computational complexity, the improved registration result is justified in particular abdominal data sets where discontinuities often appear due to sliding organ motion.
               
            

@&#INTRODUCTION@&#

In medical image processing, a lot of research has and still is devoted to image registration [1].
                        1
                     
                     
                        1
                        This work has been supported by the SCOPES project of the Swiss National Science Foundation (http://www.snf.ch)
                      The non-rigid image registration methods play an important role in today's modern medical diagnostics and Image-Guided Therapy (IGT) systems. Medical image registration seeks geometrical transformations which map one of the images into the spatial domain of the other image. In general, image registration is not restricted to the same modality but can also handle multi-modal image pairs.

During the last decade, imaging techniques capable of acquiring four-dimensional (4D) organ motion (3D+time), for example 4D MRI [3] became available. With the introduction of these imaging principles also the need for image registration approaches able to handle the discontinuities in the motion field, e.g., due organs sliding along the chest wall, grew [9].

Discontinuities preserving regularization methods can be based on local and global support, or with or without prior segmentation of region of interest. In Ruan et al. [5] the authors propose a regularization energy that encodes a discriminative treatment of different types of motion discontinuities, by using Helmholtz-Hodge decomposition. Heinrich et al. [6] presented a framework using a variational formulation of the optical flow model for 3D medical image registration, using robust discontinuity preserving non-quadratic regularization. This allows globally smooth deformations with local discontinuities, such as seen in sliding motion of the abdominal organs during respiration.

Applying discontinuities preserving regularization across the entire volume domain, i.e., globally, does not distinguish between different structures producing unrealistic motion fields.

On the other hand, in Staring et al. [2] the locally adapted, tissue-dependent filtering technique were developed. The degree of filtering is related to tissue stiffness. The tissue-dependent filter is incorporated in registration algorithm which uses mutual information as a similarity measure and cubic B-splines to model the deformation field.

In Werner et al. [10] authors apply Thirions Demons registration with masked and unmasked force calculation, and the most accurate approach is then applied to local lung motion analysis. Ding et al. [11] proposed a method to evaluate the sliding motion of the lobar surfaces during respiration using lobe-by-lobe mass-preserving non-rigid image registration. They, however, segmented the lobes during preprocessing in the three parts. In Schmidt-Richberg et al. [7] a diffusion-based model for incorporating physiological knowledge in image registration is presented. They estimate slipping motion at the organ borders by decoupling normal- and tangential- directed smoothing for the estimation of respiratory lung motion. A different approach based on anisotropic diffusion to accommodate the deformation field discontinuities seen during sliding motion is shown in Pace et al. [8]. In [4] for example Kiriyanthan et al. proposed a unified variational approach that simultaneously segments and registers the images.

With the state-of-the-art registration methods this problem can only be handled when manual segmentations of the different tissues are provided. This, however, implies significant manual work. On the other side, the assumption about the type of the tissues, or decomposition to basic components that are regularized separately, sliding motion detection are some of the disadvantage of the state-of-the art implementations. In contrast we propose in this paper an automatic bilateral filter based Demons registration approach that can handle discontinuous motion fields intuitively.

Our contribution is mainly inspired by the work proposed in [2] and also Manduchi et al. [18] and Xiao et al. [14]. The proposed regularization of deformation fields is a spatially adaptive, and it is able to produce more realistic deformations. Proposed regularization use two controllable parameters for detection local changes: spatial and intensity smoothness. Proposed method does not need prior information. The quantitative analysis shows improved Target Registration Error (TRE) when compared to original Gaussian smoothing.

@&#METHODS@&#

The goal of image registration can in general be described as finding a displacement field T that warps each pixel of the moving image M onto the static fixed image S in an optimal sense. The optimality criterion is defined by the similarity measure and can change depending on the nature and modality of the input images. The optimization of the similarity measure is an ill-posed problem that needs further physically inspired constraints which reduce oscillations and guide the registration process.

In this paper a modification to the accelerated Demons registration algorithm [13] is presented. This modification replaces the Gaussian filter regularization of the deformation field with a bilateral filter. Inspiration for this modification stems from the work of optical flow discontinuity handling from [14] where the flow vectors are smoothed with a modified version of bilateral filter.

Proposed method does not need any manual segmentation prior to registration. This modification improves the deformation fields around discontinuities and forms the basis for further research in this direction.

Organ motion represents a significant problem in medical image analysis. Movement in medical images is associated with tissue deformation, which should be fairly smooth except at the sliding regions, where edge is located. Due to a sliding motion at different types of tissues, discontinuities in the deformation field are formed (Fig. 1
                        ). Elastic registration algorithms tend to find the deformation based only on a similarity measure, which leads to an ill-posed problem. Therefore, regularization of the displacement field is necessary. We can introduce the regularization term S(u) to smooth deformation field u, so the problem of registration is defined as minimizing the following energy functional


                        
                           
                              (1)
                              
                                 C
                                 (
                                 u
                                 )
                                 :
                                 =
                                 D
                                 (
                                 
                                    I
                                    S
                                 
                                 ,
                                 
                                    T
                                    u
                                 
                                 (
                                 
                                    I
                                    M
                                 
                                 )
                                 )
                                 +
                                 S
                                 (
                                 u
                                 )
                              
                           
                        where I
                        
                           S
                         and I
                        
                           M
                         are static and moving images respectively, and T represents elastic transformation which iteratively transforms the moving image I
                        
                           M
                         to better align the I
                        
                           F
                        .

In Eq. (1) the term D(I
                        
                           S
                        , T
                        
                           u
                        (I
                        
                           M
                        )) represents the similarity measure, usually the sum of squared differences (SSD), and S(u) is regularization, usually with Gaussian smoothing. This leads to smooth deformations, as in Thirions Demons approach [15].

Typically, common image registration methods tend to isotropically smooth all components of the motion field, which is not appropriate when dealing with sliding organ motion with discontinuity in the deformation field.

Isotropically smoothed motion field enforced upon the sliding object, which slides along the stationary object, will be incorrectly applied to the stationary tissue, making it appear to move (Fig. 1a). The key part in discontinuity preserving registration is to preserve discontinuities in this affected regions, and also differentiate among different types of tissues and regularize them accordingly.

The Demons algorithm as proposed by Thirion [15] draws an analogy to thermodynamical principles found by Maxwell in the 19th century when describing a thermodynamical paradox. The aim of the Demons algorithm is to find a displacement field T that maps all pixels m of the moving image M onto the corresponding pixels s of the static image S. The algorithm is iterative and new forces are calculated at each step by evaluating an optical flow-like equation. Different modifications with additional forces have been proposed to speed-up convergence of the basic Demon algorithm. To improve convergence of the algorithm, Wang combined his active force approach with the normalization factor α proposed in [13]. The factor α functions as a step size that can be adaptively changed after each iteration. They proposed to reduce the step size when the algorithm approaches convergence. Eq. (2) shows how the tunable normalization factor α is integrated into Wang's Demon force calculation:


                        
                           
                              (2)
                              
                                 
                                    
                                       
                                          
                                             v
                                             i
                                          
                                       
                                       →
                                    
                                 
                                 =
                                 (
                                 m
                                 −
                                 s
                                 )
                                 
                                    
                                       
                                          
                                             ∇
                                             →
                                          
                                       
                                       s
                                    
                                    
                                       
                                          
                                             (
                                             
                                                
                                                   ∇
                                                   →
                                                
                                             
                                             s
                                             )
                                          
                                          2
                                       
                                       +
                                       
                                          α
                                          1
                                       
                                       
                                          
                                             (
                                             m
                                             −
                                             s
                                             )
                                          
                                          2
                                       
                                    
                                 
                                 +
                                 
                                    
                                       
                                          m
                                          −
                                          s
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             ∇
                                             →
                                          
                                       
                                       m
                                    
                                    
                                       
                                          
                                             (
                                             
                                                
                                                   ∇
                                                   →
                                                
                                             
                                             m
                                             )
                                          
                                          2
                                       
                                       +
                                       
                                          α
                                          2
                                       
                                       
                                          
                                             (
                                             s
                                             −
                                             m
                                             )
                                          
                                          2
                                       
                                    
                                 
                              
                           
                        
                     

As image registration is an ill-posed problem and the displacement field is calculated only from local information, regularization is essential. Thus, the current displacement field requires a regularization after each iteration with a Gaussian filter. Wang's integration of the moving image gradient and Cachier's α factor [16] significantly improved convergence in comparison to Thirion's Demon implementation. Another well known strategy to reduce computational complexity is the multiresolution approach in which image resolution of the images is increased from coarse to fine.

A starting point for this research is Thirions Demons algorithm, a well-known and widely used algorithm for image registration tasks, due its simplicity and fast convergence. Furthermore, the Thirions Demons can be expressed in similar terms like the well known optical flow algorithm. The both algorithms use isotropic smoothing of the deformation fields.

The main deficiency of Gaussian smoothing is its ignorance of image content such as for example edges. As a result edges in the images are blurred because pixels across edges, i.e., discontinuities are averaged together. Gaussian smoothing is thus equivalent to low-pass filtering, and the smoothed image is calculated with the following equation


                        
                           
                              (3)
                              
                                 
                                    I
                                    ′
                                 
                                 (
                                 
                                    x
                                    1
                                 
                                 )
                                 =
                                 
                                    1
                                    
                                       k
                                       (
                                       
                                          x
                                          1
                                       
                                       )
                                    
                                 
                                 
                                    ∫
                                    Ω
                                 
                                 I
                                 (
                                 x
                                 )
                                 ·
                                 
                                    g
                                    s
                                 
                                 (
                                 x
                                 −
                                 
                                    x
                                    1
                                 
                                 )
                                 dx
                              
                           
                        where k(x
                        1) is a normalization term, which preserves DC component (image mean) of the low-pass signal. Gaussian filtering is a weighted average of intensities of adjacent positions with a weight decreasing with the spatial distance to a center position. In fact, this filtering is completely independent of the image content.

Various edge preserving smoothing methods have been proposed: anisotropic-diffusion, bilateral filtering and mean shift filtering. For example, the very well known anisotropic diffusion approach, introduced by [17], which is based on the physical principle of diffusion to smooth images while preserving edges. In Manduchi et. al [18] authors proposed a different edge preserving filtering approach based on bilateral filtering. The Bilateral filter [18] is defined as a weighted average of neighboring pixels similar to the Gaussian filter. The Bilateral filter in contrast takes into account image differences between neighbors to preserve edges (Fig. 2
                        ). Distant pixels penalize the domain component and pixels with different intensity were penalized with a range component. The combination of both components ensures that only nearby similar pixels contribute to the final result [19]. A Bilateral filter is then given by the following equation


                        
                           
                              (4)
                              
                                 
                                    I
                                    
                                       ′
                                       ′
                                    
                                 
                                 (
                                 
                                    x
                                    1
                                 
                                 )
                                 =
                                 
                                    1
                                    
                                       k
                                       (
                                       
                                          x
                                          1
                                       
                                       )
                                    
                                 
                                 
                                    ∫
                                    Ω
                                 
                                 I
                                 (
                                 x
                                 )
                                 ·
                                 
                                    g
                                    s
                                 
                                 (
                                 x
                                 −
                                 
                                    x
                                    1
                                 
                                 )
                                 ·
                                 
                                    g
                                    I
                                 
                                 (
                                 I
                                 (
                                 x
                                 )
                                 −
                                 I
                                 (
                                 
                                    x
                                    1
                                 
                                 )
                                 )
                                 dx
                              
                           
                        
                     

Here, filtering is dependent on image context, as neighboring pixels have an influence on each other. The main idea of the bilateral filter is that pixels influencing each other should not only be close but also have a similar intensity value. In a smooth region pixel values in a small neighborhood are similar to each other. In this case the bilateral filter acts as a standard domain filter given in Eq. (3). The Bilateral filter need two parameters σ
                        
                           s
                         and σ
                        
                           I
                         with the following properties: as the σ
                        
                           I
                         increases, the bilateral filter gradually approximates a Gaussian, i.e., because of the wider and flatter impact over the intensity of the image. On the other side, increasing the σ
                        
                           s
                         larger features are smoothed.

Another important characteristics of bilateral filter which can be seen from Eq. (4) is that the weights are multiplied. This has two-fold influence to smoothing. If either of the weights are close to zero no smoothing occurs. Because of this, a large spatial Gaussian combined with narrow intensity Gaussian achieved limited smoothing despite the large spatial component.

In medical processing domain one can be interested in registration when one organ or tissue slides along other. Proper handling of this case need a special type of regularization. This case introduce can induce discontinuities: when we have a sharp boundary between two image regions edges are preserved according to spatial component of the filter and crisp edges are preserved according to intensity component.

Proposed algorithm is based on the well known accelerated Demons algorithm [13]. Our method works on original images, i.e., does not use segmented images. Instead of Gaussian smoothing in the regularization part, we use bilateral smoothing to regularize the deformation field according to Section 2.3. Each component of the deformation field is smoothed by the bilateral filter with the same parameters σ
                        
                           S
                         and σ
                        
                           I
                        . Pseudo code for one multiresolution level of the proposed accelerated Demons with bilateral regularization is given in Fig. 3
                        . The fast approximation of the bilateral filter as described in [20] implemented in ITK was used for our experiments.

@&#RESULTS@&#

The first experiment is using clinical liver MR images extracted during the inspiration phase. The first Fig. 4
                        (a) shows the floating image and Fig. 4(b) depicts the fusion of the floating and fixed image. As the liver slides along the chest a discontinuity in deformation field can be expected along chest wall. The registered images and the corresponding deformation fields for the red marked region-of-interest are shown for Demons with Gaussian smoothing and for the proposed bilateral filter smoothed Demon (Fig. 4c and d) respectively. For this experiment we tested both approaches on 107 image pairs. For the experiments shown in Fig. 4 we use four resolution levels with 50 iterations at each level, σ
                        =10 for Demons, and σ
                        
                           S
                        
                        =10 and σ
                        
                           I
                        
                        =50 for the proposed accelerated Demons with bilateral filtering. The impact of the additional intensity component in bilateral filter is that allows discontinuities in the deformation fields.

For a simulation of clinical data, the well known POPI dataset 
                           2
                        
                        
                           2
                           Obtained from the Léon Bérard Cancer Center & CREATIS Laboratory, Lyon, France.
                         was used [21]. Here we evaluated the registration error of the POPI dataset with corresponding landmarks and with the Target Registration Error (TRE) as a validation measure. For validation purposes we calculated mean distance for TRE before and after registration and maximal distance after registration. We used seven pairs of lung volumes from seven patients with volume sizes ranging from 512×512×107 to 512×512×141. Voxel sizes were different for these volumes and ranged from 0.78×0.78×2.0 to 1.17×1.17×2.0. The number of landmarks varied from 40 to 117 per volume, which in total gives 660 landmarks. The Bilateral filter Demons was implemented using the ITK framework [22]. All experiments were carried out on an Intel Core i5 2500 processor with 8GB of RAM. For the Demons method we used the existing ITK version with unchanged internal parameters, and four resolution levels with 50 iterations for each level. For the bilateral filtered Demons we also used four resolution levels with 50 iterations each.

In order to find the optimal settings for σ, σ
                        
                           s
                        , σ
                        
                           I
                         we carried out experiments with both approaches by varying the parameters over parameter space observing their influence on the TRE. The results for the TRE for Patient 7 are given in Table 1
                        . As expected the error increases with bigger σ in the Gaussian filtered Demons. As two parameters have to be optimized for the Bilateral filtered Demons, more extensive tests were required to find a suitable choice of parameters. For accelerated Demons researchers usually choose σ
                        
                           s
                        
                        =1.0 with 50 iterations at each resolution level. From our experiments we could see that doubling the number of iterations does not have a significant impact on TRE. Furthermore, we found that a σ
                        
                           s
                        
                        =2.0 is marginally better than the standard value. Similarly, a suitable parameter setting could be found for the Bilateral filtered Demons, namely σ
                        
                           s
                        
                        =4 and σ
                        
                           I
                        
                        =50.0. Using these parameters, the target registration error for patient 7 could be reduced from 2.10±1.1mm to 1.13±0.55mm for Demons and 0.96±0.54mm for bilateral filtered Demons (Tables 2 and 3
                        
                        ).

Anisotropic nature of bilateral kernel improves the TRE, but still some smoothing across the tissue borders can be visible (i.e., averaging the deformation field). This can be minimized by choosing a proper sigma values, which is image data-dependant. A major disadvantage of the smoothing with bilateral filter can be seen near edges of similar intensity, for example sliding organs of similar intensity value.

To verify that the improvement is significant we statistically analyzed the data. All these statistical analyzes were performed using the software package R (release 2.14.1 for Linux, http://www.r-project.org). The normal distributed mean values were compared with a paired t-test. Normality of the distributions was tested with the Kolmogorof–Smirnov test. A p value <0.05 was considered statistically significant for all tests. The statistical analysis showed that both registration approaches perform significantly better (p
                        <0.05) than not registering the images at all. Taking the accelerated Demons algorithm with Gaussian filtering as the standard, it can be shown that bilateral filtering significantly improved (p
                        <0.05) when registering with the proposed Bilateral-Demons.

The higher maximal TRE is related to a bigger magnitude of movement of sliding motion. This needs a better tuning with the two parameters of bilateral filter. To the best of our knowledge, there is no available study to correlate the parameters σ
                        
                           s
                        , σ
                        
                           I
                         of the bilateral filter. Some authors (Zhang et al. [12]) show that optimal value of range component is linearly proportional to the standard deviation of the noise. Bilateral filter parameters should be properly selected. For example, if the range parameter σ
                        
                           I
                         is too high, we obtained results similar to Demons with Gaussian smoothing. In this case, the sliding motion is not well handled. For a small range parameter deformation fields is less penalized which may lead to unplausible deformations. On the other hand, spatial parameter σ
                        
                           s
                         should be large enough to smooth the structure of interest, but not to over smooth across boundaries, i.e., to properly segment structure of interest. Ensuring the deformation to be diffeometric is required that Jacobian determinant to be positive. For our registrations deformation fields have a positive value of Jacobian. Running times for registering one pair of volumes were for Demons and Bilateral-Demons about 4min and 15min respectively. The higher computational cost for the proposed method is caused by the rather complex computation of the bilateral filter. Although we applied the Fast Bilateral filter, which is typically faster than the classical implementation, there are still situations where classical performs better. This is specifically the case with smaller values of sigma. According to the implementation, the smaller the values of sigma the less sampling can be done to the data. Second, the linear interpolation in 3D dimensions adds another level of complexity. Furthermore, the proposed algorithm can benefit less from the utilization of a multithreaded implementation as compared to the original accelerated Demons.

@&#DISCUSSION@&#

When dealing with medical image registration of moving organs problems with discontinuities in the motion field arise. To overcome these problems, we proposed an image registration approach that better handles the discontinuities in the motion field by looking at the underlying image content.

We thus proposed on replacing the Gaussian regularization commonly used in the accelerated Demons method by anisotropic smoothness. We proposed on using bilateral filtering, an extension of the basic Gaussian filtering, which additionally takes into account image contents namely the position and intensity values of the images. The proposed approach was tested and compared on 2D liver image pairs and 3D lung images from the POPI data set. From the experiments can be seen that using bilateral filtering for regularization indeed significantly improves the registration performance (TRE) as compared to the classical accelerated Demons. Further research can be directed in the following directions. Allowing discontinuities near the tissues of similar intensity values, and sensitivity analysis of bilateral filter parameters for the registration with lung datasets.

@&#REFERENCES@&#

