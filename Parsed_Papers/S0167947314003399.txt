@&#MAIN-TITLE@&#An external field prior for the hidden Potts model with application to cone-beam computed tomography

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           External field prior improves image segmentation accuracy.


                        
                        
                           
                           Manual segmentation of one image is used as a prior for subsequent images.


                        
                        
                           
                           Applicable to longitudinal imaging, such as image-guided radiation therapy.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Bayesian image analysis

Hidden Markov random field

Image-guided radiation therapy

Ising/Potts model

Longitudinal imaging

@&#ABSTRACT@&#


               
               
                  In images with low contrast-to-noise ratio (CNR), the information gain from the observed pixel values can be insufficient to distinguish foreground objects. A Bayesian approach to this problem is to incorporate prior information about the objects into a statistical model. A method for representing spatial prior information as an external field in a hidden Potts model is introduced. This prior distribution over the latent pixel labels is a mixture of Gaussian fields, centred on the positions of the objects at a previous point in time. It is particularly applicable in longitudinal imaging studies, where the manual segmentation of one image can be used as a prior for automatic segmentation of subsequent images. The method is demonstrated by application to cone-beam computed tomography (CT), an imaging modality that exhibits distortions in pixel values due to X-ray scatter. The external field prior results in a substantial improvement in segmentation accuracy, reducing the mean pixel misclassification rate for an electron density phantom from 87% to 6%. The method is also applied to radiotherapy patient data, demonstrating how to derive the external field prior in a clinical context.
               
            

@&#INTRODUCTION@&#

Longitudinal imaging is a popular method in a wide range of scientific fields including environment, economics, agriculture, biology, and medicine. Remote sensing is used for long-term monitoring of land use (Strickland et al., 2011), water quality (McClain, 2009) and economic growth (Henderson et al., 2011). X-ray computed tomography (CT), magnetic resonance imaging (MRI) and ultrasound are used for in vivo studies of livestock production (Alston et al., 2007), tumour progression (Albanese et al., 2013) and neurodegenerative disease (Thompson et al., 2004). These images can exhibit artefacts and distortions such as cloud cover in remote sensing, magnetic field inhomogeneities in MRI and X-ray scatter in CT. The resulting poor contrast-to-noise ratio (CNR) creates difficulties in interpreting the images. Multiple images acquired of the same subject increase the information available compared to that obtained from a single acquisition. In order to perform well in this setting, an image processing algorithm must efficiently incorporate all of the available knowledge that characterises the specific types of images encountered.

In this paper we focus on a specific example of longitudinal imaging: daily cone-beam CT scans for image-guided radiotherapy. Flat-detector, cone-beam CT was introduced in the previous decade for image-guided medical interventions (Jaffray et al., 2002; Kalender, 2011). Since then, it has been widely adopted for clinical use in dental surgery, brachytherapy and external-beam radiotherapy. Cone-beam CT produces a 3D image of the patient similar to conventional, fan-beam CT. An axial slice from a cone-beam CT scan of a radiotherapy patient is shown in Fig. 1
                     (a). For comparison, a fan-beam CT scan of the same patient is shown in Fig. 1(b). The advantage of cone-beam CT over fan-beam CT is that the X-ray source and the detector panel are mounted on retractable arms that rotate around the image subject, enabling the image to be obtained in situ during a medical procedure.

A drawback of cone-beam CT is that it is more susceptible to artefacts induced by X-ray scatter (Siewerdsen and Jaffray, 2001) or high density objects such as metal implants (Müller and Buzug, 2009) compared to other imaging modalities. The increased magnitude of X-ray scatter in cone-beam CT is due to the larger area that is exposed to the X-ray beam. This leads to shading artefacts that manifest as inhomogeneities in the pixel values. Metal-induced artefacts can be due to implanted gold fiducial markers or surgical clips inside the patient. These manifest as streaking and banding in the image. These distortions result in a lower CNR and thus many methods that can be successfully used for analysing conventional, fan-beam CT or other imaging modalities encounter difficulties when applied to cone-beam CT.

The goal of image-guided radiotherapy is to target the delivery of a prescribed radiation dose, while avoiding nearby organs at risk (OAR) and other sensitive tissue. The individualised treatment plan for each patient is based on diagnostic-quality fan-beam CT and MRI scans. Fractionated, radiotherapeutic doses are delivered 5 days a week over a number of weeks. Thus, a significant amount of time can elapse between the creation of the treatment plan and the completion of a course of treatment. Even on a daily basis, changes in the size of the bladder and rectum in prostate cancer patients can result in displacement of the target site. To detect these changes, a cone-beam CT scan is taken in situ, immediately prior to irradiation. This information is currently underutilised due to the level of precision and detail required for volumetric variation analysis, coupled with the short timeframe in which the radiotherapy procedure is to be carried out in the clinic. Automated methods have the potential to aid in the decision-making process by labelling the image voxels according to tissue type, estimating the boundaries of the tumour and neighbouring organs, and highlighting any regions where changes in these boundaries might have exceeded tolerance.

Recent approaches to boundary estimation in cone-beam CT have used deformable models that evolve according to partial differential equations. The two major approaches are 3D mesh models (Costa et al., 2007) and level sets (Chen and Radke, 2009). These methods fit within the information-theoretical framework developed by Grenander and Miller (2007). Deformable template models need to be initialised very close to the boundary of interest, as they are prone to becoming stuck on local minima. Thus, they are more suited as a post-processing step to refine an approximate solution that was obtained via other means, as in Chen et al. (2009), Zhou et al. (2010) and Lu et al. (2011).

A related but far more complex problem is non-rigid image registration, where every voxel in the cone-beam CT scan is mapped via transformation onto a voxel in the reference, fan-beam CT. This transformation can then be used to estimate the actual radiation dose absorbed by the patient in each treatment fraction and update the treatment plan accordingly (Elstrøm et al., 2010). This approach is limited by the length of time available before treatment delivery for the algorithm to reach an acceptable global solution, with the result that these calculations generally need to be performed offline. In order to determine what action needs to be taken to accurately target the treatment, the radiation therapist is primarily concerned with the structures in proximity to the high-dose region, not with the alignment of every voxel in the image.

The “demons” algorithm, introduced by Thirion (1996), is a popular method for deformable image registration and has been incorporated into a commercial product (Thörnqvist et al., 2010; Thor et al., 2011). The algorithm matches the voxel intensity values in the two images by solving an optical flow diffusion equation using finite differences. Chen et al. (2010) combine the “demons” force with an organ-specific regularisation based on meshless deformable models. This model works well for the bladder and prostate, but does not generalise to the irregular deformation of the rectum. Chen et al. also found that the greyscale-based registration was unable to cope with extreme regions of pixel intensity, such as the metal fiducial markers and the gas in the rectum. The shading artefacts that distort cone-beam CT scans violate the assumption of optical flow, that the values of corresponding voxels in cone-beam CT and fan-beam CT are directly related to each other.

Another approach that is commonly used in medical imaging is a probabilistic anatomical atlas. Atlas-based methods were originally developed in neuroimaging, with the goal of mapping measurements from multiple experimental subjects onto an average anatomy, so that they could be compared (Fox et al., 1985; Evans et al., 1988, 2012). Methods for atlas-based segmentation of prostate MRI have been developed by Klein et al. (2008), Martin et al. (2010) and Dowling et al. (2011), but this has yet to be demonstrated on cone-beam CT. A drawback of atlas-based methods is their dependence on an average anatomy, since this conflates within-subject and between-subject variability. There can be large differences between radiotherapy patients, which is why individualised treatment plans are required. Image-guided radiotherapy is focused on geometric changes within a patient over time, rather than on comparisons between patients.

A Bayesian statistical model can combine information from multiple images as well as from other sources, such as published studies, previous experiments and expert opinion. The Bayesian approach to image analysis began with the seminal papers of Geman and Geman (1984) and Besag (1986), who used Markov random field (MRF) models to represent the spatial dependence between neighbouring pixels. Bayesian methods for image analysis were reviewed by Hurn et al. (2003a,b). Woolrich (2012) has provided a more recent overview of methods for analysing medical images, particularly functional MRI. Alston et al. (2007) used a Potts (1952) model with additive Gaussian noise for segmentation of CT scans. They derived informative priors for the means and variances of the hidden Potts model from an adjacent slice of the 3D image, or from an earlier scan of the same subject.

In this paper we demonstrate how sources of spatial information can be incorporated into an external field prior for the hidden Potts model. This prior is derived from a previous image of the same subject, combined with published studies of geometric variation. Thus, it satisfies the criteria of Whitfield et al. (2013) for techniques that utilise prior knowledge, make sophisticated use of greyscale information and allow clinical expertise to be integrated. The prior can be updated sequentially as each image is processed to build a subject-specific spatial model. It can be computed offline and is amenable to massively parallel implementation. We show that it improves the accuracy of image segmentation in the presence of noise.

The remainder of this article is organised as follows. Section  2 describes the hidden Potts model and introduces the external field prior. Bayesian computation using Markov chain Monte Carlo (MCMC) is described in Section  3. We review chequerboard updating, path sampling and the algorithm of Swendsen and Wang (1987) in the context of our method. In Section  4 we illustrate our methodology using cone-beam CT scans of an electron density (ED) phantom as well as radiotherapy patient data. The external field prior is well suited to this application, but it would also be broadly applicable to a range of longitudinal imaging datasets. The article concludes with a discussion.

Digital raster images are discretised into a regular lattice of pixels (or voxels, in 3D). Image segmentation can be viewed as the task of labelling each pixel to identify which parts of the image correspond to objects and which comprise the background. If these objects are contiguous then neighbouring pixels are more likely to share the same label. The Potts model represents this spatial dependence as a Markov random field (MRF), which is defined in terms of its conditional probabilities: 
                        
                           (1)
                           
                              π
                              
                                 (
                                 
                                    
                                       z
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       z
                                    
                                    
                                       ∖
                                       i
                                    
                                 
                                 ,
                                 β
                                 )
                              
                              =
                              
                                 
                                    exp
                                    
                                       {
                                       β
                                       
                                          
                                             ∑
                                          
                                          
                                             i
                                             ∼
                                             ℓ
                                          
                                       
                                       δ
                                       
                                          (
                                          
                                             
                                                z
                                             
                                             
                                                i
                                             
                                          
                                          ,
                                          
                                             
                                                z
                                             
                                             
                                                ℓ
                                             
                                          
                                          )
                                       
                                       }
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          j
                                          =
                                          1
                                       
                                       
                                          k
                                       
                                    
                                    exp
                                    
                                       {
                                       β
                                       
                                          
                                             ∑
                                          
                                          
                                             i
                                             ∼
                                             ℓ
                                          
                                       
                                       δ
                                       
                                          (
                                          j
                                          ,
                                          
                                             
                                                z
                                             
                                             
                                                ℓ
                                             
                                          
                                          )
                                       
                                       }
                                    
                                 
                              
                              ,
                           
                        
                      where 
                        
                           
                              z
                           
                           
                              i
                           
                        
                        ∈
                        1
                        …
                        k
                      is the label of pixel 
                        i
                        ,
                        
                           
                              z
                           
                           
                              ∖
                              i
                           
                        
                      represents all of the labels except 
                        
                           
                              z
                           
                           
                              i
                           
                        
                        ,
                        i
                        ∼
                        ℓ
                      are the neighbouring pixels of 
                        i
                        ,
                        β
                      is the inverse temperature, and 
                        δ
                        
                           (
                           u
                           ,
                           v
                           )
                        
                      is the Kronecker delta function. Thus, 
                        
                           
                              ∑
                           
                           
                              i
                              ∼
                              ℓ
                           
                        
                        δ
                        
                           (
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 z
                              
                              
                                 ℓ
                              
                           
                           )
                        
                      is a count of the neighbours of pixel 
                        i
                      that share the same label.

If the coordinates of 
                        
                           
                              z
                           
                           
                              i
                           
                        
                      are 
                        
                           (
                           x
                           ,
                           y
                           )
                        
                      in 2 dimensions, then the first-order neighbours are 
                        
                           (
                           x
                           −
                           1
                           ,
                           y
                           )
                        
                        ,
                        
                           (
                           x
                           +
                           1
                           ,
                           y
                           )
                        
                        ,
                        
                           (
                           x
                           ,
                           y
                           −
                           1
                           )
                        
                        ,
                        
                           (
                           x
                           ,
                           y
                           +
                           1
                           )
                        
                     . Pixels situated at the edge of the image domain have less than four neighbours. Likewise, voxels in a regular 3D lattice have a maximum of 6 first-order neighbours. Since diagonal voxels are conditionally independent, the entire image can be partitioned into two blocks such that all of the voxels in block1 are independent given the values of block2 and vice versa (Besag, 1974). The pixels within each block can be updated concurrently, providing a computational advantage of the first-order neighbourhood restriction (Winkler, 2003, chap. 8). This is discussed further in Section  3.1.

The inverse temperature of the Potts model governs spatial cohesion. When 
                        β
                        =
                        0
                      the pixel labels are independent, while if 
                        β
                        >
                        0
                      then adjacent labels are more likely to have the same value. At small values of 
                        β
                      this has the effect of smoothing the labels and emphasising patterns in the external field. As 
                        β
                        →
                        ∞
                      all of the labels have the same value almost surely. Thus, the inverse temperature can have a substantial influence over the labels that are assigned to each pixel.

A key question when fitting this type of model is how much smoothing is appropriate for the observed data. For this reason we would like to treat 
                        β
                      as a free parameter and perform posterior inference to draw samples from its distribution. The posterior distribution of 
                        β
                      is as follows: 
                        
                           (2)
                           
                              p
                              
                                 (
                                 β
                                 |
                                 
                                    z
                                 
                                 )
                              
                              ∝
                              C
                              
                                 
                                    
                                       (
                                       β
                                       )
                                    
                                 
                                 
                                    −
                                    1
                                 
                              
                              π
                              
                                 (
                                 β
                                 )
                              
                              exp
                              
                                 {
                                 
                                    
                                       β
                                    
                                    
                                       2
                                    
                                 
                                 
                                    
                                       ∑
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       n
                                    
                                 
                                 
                                    
                                       ∑
                                    
                                    
                                       i
                                       ∼
                                       ℓ
                                    
                                 
                                 δ
                                 
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    ,
                                    
                                       
                                          z
                                       
                                       
                                          ℓ
                                       
                                    
                                    )
                                 
                                 }
                              
                              ,
                           
                        
                      where 
                        C
                        
                           (
                           β
                           )
                        
                      is an intractable normalising constant and 
                        π
                        
                           (
                           β
                           )
                        
                      is the prior for 
                        β
                     . A variety of computational methods have been developed for dealing with the intractability of this distribution, as explained in Section  3.2.

Under the assumption of additive white noise, the pixels that comprise each object have a mean intensity value 
                        
                           
                              μ
                           
                           
                              j
                           
                        
                      and variance 
                        
                           
                              σ
                           
                           
                              j
                           
                           
                              2
                           
                        
                     . The hidden Potts model can thus be viewed as a spatial generalisation of an independent mixture of Gaussians: 
                        
                           (3)
                           
                              
                                 
                                    y
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    μ
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    σ
                                 
                                 
                                    j
                                 
                                 
                                    2
                                 
                              
                              ,
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              =
                              j
                              
                              ∼
                              
                              N
                              
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       j
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       j
                                    
                                    
                                       2
                                    
                                 
                                 )
                              
                              ,
                           
                        
                      where 
                        
                           
                              y
                           
                           
                              i
                           
                        
                      is the observed value of pixel 
                        i
                     . The latent labels are related to their corresponding pixel values by the log-likelihood: 
                        
                           (4)
                           
                              
                                 
                                    α
                                 
                                 
                                    i
                                    ,
                                    j
                                 
                              
                              =
                              log
                              
                                 {
                                 ϕ
                                 
                                    (
                                    
                                       
                                          y
                                       
                                       
                                          i
                                       
                                    
                                    ;
                                    
                                       
                                          μ
                                       
                                       
                                          j
                                       
                                    
                                    ,
                                    
                                       
                                          σ
                                       
                                       
                                          j
                                       
                                       
                                          2
                                       
                                    
                                    )
                                 
                                 }
                              
                              ,
                           
                        
                      where 
                        ϕ
                        
                           (
                           y
                           ;
                           μ
                           ,
                           
                              
                                 σ
                              
                              
                                 2
                              
                           
                           )
                        
                      is the normal density function. This log-likelihood is combined with the spatial prior to determine the full conditional posteriors of the pixel labels: 
                        
                           (5)
                           
                              p
                              
                                 (
                                 
                                    
                                       z
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       z
                                    
                                    
                                       ∖
                                       i
                                    
                                 
                                 ,
                                 β
                                 ,
                                 
                                    μ
                                 
                                 ,
                                 
                                    
                                       
                                          σ
                                       
                                    
                                    
                                       
                                          2
                                       
                                    
                                 
                                 ,
                                 
                                    
                                       y
                                    
                                    
                                       i
                                    
                                 
                                 )
                              
                              =
                              
                                 
                                    exp
                                    
                                       {
                                       
                                          
                                             α
                                          
                                          
                                             i
                                             ,
                                             
                                                
                                                   z
                                                
                                                
                                                   i
                                                
                                             
                                          
                                       
                                       +
                                       β
                                       
                                          
                                             ∑
                                          
                                          
                                             i
                                             ∼
                                             ℓ
                                          
                                       
                                       δ
                                       
                                          (
                                          
                                             
                                                z
                                             
                                             
                                                i
                                             
                                          
                                          ,
                                          
                                             
                                                z
                                             
                                             
                                                ℓ
                                             
                                          
                                          )
                                       
                                       }
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          j
                                          =
                                          1
                                       
                                       
                                          k
                                       
                                    
                                    exp
                                    
                                       {
                                       
                                          
                                             α
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                       +
                                       β
                                       
                                          
                                             ∑
                                          
                                          
                                             i
                                             ∼
                                             ℓ
                                          
                                       
                                       δ
                                       
                                          (
                                          j
                                          ,
                                          
                                             
                                                z
                                             
                                             
                                                ℓ
                                             
                                          
                                          )
                                       
                                       }
                                    
                                 
                              
                              .
                           
                        
                     
                  

In this study, we extend the hidden Potts model by defining a prior 
                           π
                           
                              (
                              
                                 γ
                              
                              )
                           
                         over the latent labels 
                           
                              z
                           
                        . This prior incorporates additional information on the spatial distribution of the unobserved labels. Such information can be derived from a manual segmentation of a previous image, combined with a measure of the spatial uncertainty associated with the labels. Sources of uncertainty include object motion, errors in labelling, and misalignment between images.

For the purpose of illustration, we consider a simple model of isotropic translation in two dimensions. The spatial distribution of pixel labels is represented as a mixture of Gaussians, with one mixture component per pixel. The magnitude of the displacement vector can be calculated for each pixel and the resulting probabilities can be averaged over all of the pixels in the object: 
                           
                              (6)
                              
                                 
                                    
                                       γ
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 =
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                                 
                                    
                                       ∑
                                    
                                    
                                       h
                                       ∈
                                       j
                                    
                                 
                                 ϕ
                                 
                                    (
                                    Δ
                                    
                                       (
                                       h
                                       ,
                                       i
                                       )
                                    
                                    |
                                    
                                       
                                          μ
                                       
                                       
                                          Δ
                                          j
                                       
                                    
                                    ,
                                    
                                       
                                          σ
                                       
                                       
                                          Δ
                                          j
                                       
                                       
                                          2
                                       
                                    
                                    )
                                 
                                 ,
                              
                           
                         where 
                           h
                           ∈
                           j
                         are the pixels with label 
                           j
                           ,
                           
                              
                                 n
                              
                              
                                 j
                              
                           
                         is the number of pixels with label 
                           j
                        , and 
                           Δ
                           
                              (
                              u
                              ,
                              v
                              )
                           
                         is the Euclidean distance between the coordinates of pixel 
                           u
                         and pixel 
                           v
                        . The locations of the pixels 
                           h
                           ∈
                           j
                         can be obtained from an exemplar image that has been manually labelled. The mean 
                           
                              
                                 μ
                              
                              
                                 Δ
                                 j
                              
                           
                         is the average spatial displacement of the object between images, while the variance 
                           
                              
                                 σ
                              
                              
                                 Δ
                                 j
                              
                              
                                 2
                              
                           
                         represents the degree of uncertainty. Fig. 2
                         illustrates external field priors with increasing levels of spatial uncertainty for the ED phantom that is described in Section  4.

Since this prior information is independent of the data, it can be incorporated into the Potts model as an external field. The relationship in Eq. (5) is modified as follows: 
                           
                              (7)
                              
                                 p
                                 
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    |
                                    
                                       
                                          z
                                       
                                       
                                          ∖
                                          i
                                       
                                    
                                    ,
                                    β
                                    ,
                                    
                                       μ
                                    
                                    ,
                                    
                                       
                                          
                                             σ
                                          
                                       
                                       
                                          
                                             2
                                          
                                       
                                    
                                    ,
                                    
                                       
                                          y
                                       
                                       
                                          i
                                       
                                    
                                    )
                                 
                                 =
                                 
                                    
                                       exp
                                       
                                          {
                                          
                                             
                                                α
                                             
                                             
                                                i
                                                ,
                                                
                                                   
                                                      z
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                          
                                          }
                                       
                                       
                                          
                                             γ
                                          
                                          
                                             i
                                             ,
                                             
                                                
                                                   z
                                                
                                                
                                                   i
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             1
                                          
                                          
                                             k
                                          
                                       
                                       exp
                                       
                                          {
                                          
                                             
                                                α
                                             
                                             
                                                i
                                                ,
                                                j
                                             
                                          
                                          }
                                       
                                       
                                          
                                             γ
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                    
                                 
                                 π
                                 
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    |
                                    
                                       
                                          z
                                       
                                       
                                          ∖
                                          i
                                       
                                    
                                    ,
                                    β
                                    )
                                 
                                 ,
                              
                           
                         where 
                           
                              
                                 α
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         is the log-likelihood in Eq. (4), 
                           
                              
                                 γ
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         is the external field prior defined in Eq. (6), and 
                           π
                           
                              (
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    z
                                 
                                 
                                    ∖
                                    i
                                 
                              
                              ,
                              β
                              )
                           
                         is the MRF defined by Eq. (1). Furthermore, if the pixel resolution of the image is known in advance, then the values of 
                           
                              
                                 γ
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         can be calculated offline. This means that much more realistic and sophisticated dynamic models could be employed, in order to estimate the spatial prior distribution from the labels of an exemplar image.

In cases where the pixel resolution is not known in advance, or if there is mismatch between the pixel coordinates of successive images, the discretisation of the Gaussian prior into individual 
                           
                              
                                 γ
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         values would need to be performed at the model fitting stage. This step is computationally intensive, but since the 
                           
                              
                                 γ
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         values are independent from each other the operation is embarrassingly parallel. Thus the computation of the external field prior would be well suited to implementation in graphical processing units (GPUs) to meet the performance requirements of practical, real world applications.

Unlike the atlas-based methods that are currently employed in medical imaging, this external field prior represents within-subject geometric variation. The prior can be updated as each image is acquired to gradually build a subject-specific profile of motion and variability. A machine learning approach to this problem would be to train the model using a corpus of images from a variety of subjects, thus forming a generic picture of the typical subject. However, this fails to account for large differences between individual subjects, thereby conflating within-subject and between-subject variability. Our method develops a subject-specific distribution using a labelled reference image as a starting point, then updating the prior dynamically as more images of the same subject are processed.


                        Alston et al. (2007) introduced a method for updating the parameters 
                           
                              
                                 μ
                              
                              
                                 j
                              
                              
                                 ′
                              
                           
                         and 
                           
                              
                                 σ
                              
                              
                                 j
                              
                              
                                 2
                                 ′
                              
                           
                         of the additive Gaussian noise, using the posterior distribution from one image as the prior for the next. A similar approach could be used for the inverse temperature. Although there is no natural conjugate prior for 
                           β
                        , a distribution from the exponential family could be used to approximate the posterior. A four parameter (scaled) Beta distribution could represent a posterior with finite support, or a Gamma could be used for 
                           β
                           >
                           0
                        . When the external field prior is modelled as a mixture of Gaussian fields, its parameters can also be updated in a similar manner.

We place hyper-priors on the parameters of the external field in Eq. (6): 
                           
                              
                                 (8)
                                 
                                    
                                       
                                          μ
                                       
                                       
                                          Δ
                                          j
                                       
                                    
                                    |
                                    
                                       
                                          σ
                                       
                                       
                                          Δ
                                          j
                                       
                                       
                                          2
                                       
                                    
                                    ∼
                                    N
                                    
                                       (
                                       
                                          
                                             m
                                          
                                          
                                             j
                                          
                                       
                                       ,
                                       
                                          
                                             
                                                
                                                   σ
                                                
                                                
                                                   Δ
                                                   j
                                                
                                                
                                                   2
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   j
                                                
                                             
                                          
                                       
                                       )
                                    
                                    ,
                                    
                                    and
                                 
                              
                              
                                 (9)
                                 
                                    
                                       
                                          σ
                                       
                                       
                                          Δ
                                          j
                                       
                                       
                                          2
                                       
                                    
                                    ∼
                                    IG
                                    
                                       (
                                       
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   j
                                                
                                             
                                          
                                          
                                             2
                                          
                                       
                                       ,
                                       
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   j
                                                
                                             
                                             
                                                
                                                   s
                                                
                                                
                                                   j
                                                
                                                
                                                   2
                                                
                                             
                                          
                                          
                                             2
                                          
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                         The hyper-parameters 
                           
                              
                                 m
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                         and 
                           
                              
                                 ν
                              
                              
                                 j
                              
                           
                         can be updated sequentially as each image is processed, replacing the previous values 
                           
                              
                                 m
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                           ,
                           
                              
                                 s
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                         and 
                           
                              
                                 ν
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                         with their Bayesian updates 
                           
                              
                                 m
                              
                              
                                 j
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 s
                              
                              
                                 j
                              
                              
                                 ′
                              
                           
                         and 
                           
                              
                                 ν
                              
                              
                                 j
                              
                              
                                 ′
                              
                           
                        .

It is assumed that there is no uncertainty associated with the pixel labels in the exemplar image. When the external field is derived as described in the previous section, 
                           
                              
                                 ν
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                         will be the number of pixels that were assigned label 
                           j
                         in the reference image, while 
                           
                              
                                 m
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                         and 
                           
                              
                                 s
                              
                              
                                 j
                              
                              
                                 ∘
                              
                           
                         describe the spatial variability of the labels in future images.

The hyper-parameters can be updated in the usual manner for the Gaussian distribution: 
                           
                              
                                 
                                    
                                       
                                          ν
                                       
                                       
                                          j
                                       
                                       
                                          ′
                                       
                                    
                                    =
                                    
                                       
                                          ν
                                       
                                       
                                          j
                                       
                                       
                                          ∘
                                       
                                    
                                    +
                                    
                                       
                                          
                                             
                                                ν
                                             
                                             
                                                ˆ
                                             
                                          
                                       
                                       
                                          Δ
                                          j
                                       
                                    
                                    ,
                                 
                              
                              
                                 
                                    
                                       
                                          m
                                       
                                       
                                          j
                                       
                                       
                                          ′
                                       
                                    
                                    =
                                    
                                       
                                          1
                                       
                                       
                                          
                                             
                                                ν
                                             
                                             
                                                j
                                             
                                             
                                                ′
                                             
                                          
                                       
                                    
                                    
                                       (
                                       
                                          
                                             ν
                                          
                                          
                                             j
                                          
                                          
                                             ∘
                                          
                                       
                                       
                                          
                                             m
                                          
                                          
                                             j
                                          
                                          
                                             ∘
                                          
                                       
                                       +
                                       
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   ˆ
                                                
                                             
                                          
                                          
                                             Δ
                                             j
                                          
                                       
                                       
                                          
                                             
                                                
                                                   m
                                                
                                                
                                                   ˆ
                                                
                                             
                                          
                                          
                                             Δ
                                             j
                                          
                                       
                                       )
                                    
                                    ,
                                    
                                    and
                                 
                              
                              
                                 
                                    
                                       
                                          s
                                       
                                       
                                          j
                                       
                                       
                                          2
                                          ′
                                       
                                    
                                    =
                                    
                                       
                                          1
                                       
                                       
                                          
                                             
                                                ν
                                             
                                             
                                                j
                                             
                                             
                                                ′
                                             
                                          
                                       
                                    
                                    
                                       (
                                       
                                          
                                             ν
                                          
                                          
                                             j
                                          
                                          
                                             ∘
                                          
                                       
                                       
                                          
                                             s
                                          
                                          
                                             j
                                          
                                          
                                             ∘
                                             2
                                          
                                       
                                       +
                                       
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   ˆ
                                                
                                             
                                          
                                          
                                             Δ
                                             j
                                          
                                       
                                       
                                          
                                             
                                                
                                                   s
                                                
                                                
                                                   ˆ
                                                
                                             
                                          
                                          
                                             Δ
                                             j
                                          
                                          
                                             2
                                          
                                       
                                       +
                                       
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   j
                                                
                                                
                                                   ∘
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         ν
                                                      
                                                      
                                                         ˆ
                                                      
                                                   
                                                
                                                
                                                   Δ
                                                   j
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ν
                                                
                                                
                                                   j
                                                
                                                
                                                   ′
                                                
                                             
                                          
                                       
                                       
                                          
                                             
                                                (
                                                
                                                   
                                                      
                                                         
                                                            m
                                                         
                                                         
                                                            ˆ
                                                         
                                                      
                                                   
                                                   
                                                      Δ
                                                      j
                                                   
                                                
                                                −
                                                
                                                   
                                                      m
                                                   
                                                   
                                                      j
                                                   
                                                   
                                                      ′
                                                   
                                                
                                                )
                                             
                                          
                                          
                                             2
                                          
                                       
                                       )
                                    
                                    ,
                                 
                              
                           
                         where 
                           
                              
                                 
                                    
                                       ν
                                    
                                    
                                       ˆ
                                    
                                 
                              
                              
                                 Δ
                                 j
                              
                           
                           ,
                           
                              
                                 
                                    
                                       m
                                    
                                    
                                       ˆ
                                    
                                 
                              
                              
                                 Δ
                                 j
                              
                           
                         and 
                           
                              
                                 
                                    
                                       s
                                    
                                    
                                       ˆ
                                    
                                 
                              
                              
                                 Δ
                                 j
                              
                              
                                 2
                              
                           
                         are the sufficient statistics that are calculated from the posterior of the hidden Potts model. These are defined as the sum of the weights, the weighted mean of the Euclidean distances, and the weighted variance: 
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                ν
                                             
                                             
                                                ˆ
                                             
                                          
                                       
                                       
                                          Δ
                                          j
                                       
                                    
                                    =
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                    
                                       
                                          w
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    ,
                                 
                              
                              
                                 
                                    
                                       
                                          
                                             
                                                m
                                             
                                             
                                                ˆ
                                             
                                          
                                       
                                       
                                          Δ
                                          j
                                       
                                    
                                    =
                                    
                                       
                                          1
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      ν
                                                   
                                                   
                                                      ˆ
                                                   
                                                
                                             
                                             
                                                Δ
                                                j
                                             
                                          
                                       
                                    
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                    
                                       
                                          w
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    
                                    
                                       
                                          d
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    ,
                                    
                                    and
                                 
                              
                              
                                 
                                    
                                       
                                          
                                             
                                                s
                                             
                                             
                                                ˆ
                                             
                                          
                                       
                                       
                                          Δ
                                          j
                                       
                                       
                                          2
                                       
                                    
                                    =
                                    
                                       
                                          1
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      ν
                                                   
                                                   
                                                      ˆ
                                                   
                                                
                                             
                                             
                                                Δ
                                                j
                                             
                                          
                                       
                                    
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                    
                                       
                                          w
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    
                                       
                                          
                                             (
                                             
                                                
                                                   d
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                             −
                                             
                                                
                                                   
                                                      
                                                         m
                                                      
                                                      
                                                         ˆ
                                                      
                                                   
                                                
                                                
                                                   Δ
                                                   j
                                                
                                             
                                             )
                                          
                                       
                                       
                                          2
                                       
                                    
                                    .
                                 
                              
                           
                        
                     

The location of the region of interest in subsequent images is uncertain. For this reason, we apply weights to the pixel labels according to their posterior probability. A Monte Carlo estimate of this probability can be obtained by dividing the number of times that a given pixel was allocated a specific label by the total number of MCMC iterations (after burn-in): 
                           
                              (10)
                              
                                 
                                    
                                       w
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 =
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             i
                                             t
                                             e
                                             r
                                          
                                       
                                    
                                 
                                 
                                    
                                       ∑
                                    
                                    
                                       t
                                       =
                                       1
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             i
                                             t
                                             e
                                             r
                                          
                                       
                                    
                                 
                                 δ
                                 
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                       
                                          
                                             (
                                             t
                                             )
                                          
                                       
                                    
                                    ,
                                    j
                                    )
                                 
                                 ,
                              
                           
                         where 
                           
                              
                                 z
                              
                              
                                 i
                              
                              
                                 
                                    (
                                    t
                                    )
                                 
                              
                           
                         is the label that was allocated to pixel 
                           i
                         at iteration 
                           t
                        , thus 
                           
                              
                                 w
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                           ≥
                           0
                        
                        
                        
                           ∀
                           j
                           ∈
                           1
                           …
                           k
                         and 
                           
                              
                                 ∑
                              
                              
                                 j
                                 =
                                 1
                              
                              
                                 k
                              
                           
                           
                              
                                 w
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                           =
                           1
                         for each pixel 
                           i
                        . It will usually be necessary to adjust this estimate to account for autocorrelation of the Markov chain.

To compute the sufficient statistics for the posterior distribution, the average distance between each pixel and the original labels 
                           h
                           ∈
                           j
                         is also required: 
                           
                              (11)
                              
                                 
                                    
                                       d
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 =
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             ν
                                          
                                          
                                             j
                                          
                                          
                                             ∘
                                          
                                       
                                    
                                 
                                 
                                    
                                       ∑
                                    
                                    
                                       h
                                       ∈
                                       j
                                    
                                 
                                 Δ
                                 
                                    (
                                    h
                                    ,
                                    i
                                    )
                                 
                                 .
                              
                           
                         This calculation requires 
                           O
                           
                              (
                              
                                 
                                    n
                                 
                                 
                                    2
                                 
                              
                              )
                           
                         operations, but it can be computed offline in the same manner as the external field prior itself. It would also be possible to approximate 
                           
                              
                                 d
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         using a subsample of 
                           h
                        , since the individual pixels are exchangeable within each object 
                           j
                        . If all of the subsequent images have the same coordinates and pixel resolution, then the matrix 
                           
                              d
                           
                         only needs to be computed once.

One option for updating the individual 
                           
                              
                                 γ
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                         values for each pixel would be to take the expectations 
                           E
                           
                              [
                              
                                 
                                    σ
                                 
                                 
                                    Δ
                                    j
                                 
                                 
                                    2
                                 
                              
                              |
                              
                                 
                                    s
                                 
                                 
                                    j
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    ν
                                 
                                 
                                    j
                                 
                                 
                                    ′
                                 
                              
                              ]
                           
                         and 
                           E
                           
                              [
                              
                                 
                                    μ
                                 
                                 
                                    Δ
                                    j
                                 
                              
                              |
                              
                                 
                                    m
                                 
                                 
                                    j
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    ν
                                 
                                 
                                    j
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    σ
                                 
                                 
                                    Δ
                                    j
                                 
                                 
                                    2
                                 
                              
                              ]
                           
                         and plug them in to Eq. (6). This would be the simplest approach and the least computationally intensive, but replacing the posterior distributions with point estimates would underestimate the level of uncertainty. Alternatively, the external field prior could be simulated using MCMC, either offline or during model fitting. This would be the preferred option if a more complex dynamic model was used.

We use natural conjugate priors for the mean and variance of each mixture component, so updates can be drawn using Gibbs sampling. However, this approach is unsuitable for the other parameters of interest. Instead, we use chequerboard updating for the latent labels and path sampling for the inverse temperature. Our implementation of these algorithms using RcppArmadillo (Eddelbuettel and Sanderson, 2014) is available as an R source package from the RunMyCode companion website. The details of these algorithms are described below.


                        
                           
                              
                           
                        
                     

The pixels within each block are independent of each other, as mentioned in Section  2. The auxiliary variable 
                           
                              
                                 b
                              
                              
                                 i
                              
                           
                           ∈
                           
                              {
                              0
                              ,
                              1
                              }
                           
                         allocates each pixel to a block. Winkler (2003) described this partially synchronous algorithm as chequerboard updating, since the alternating allocations of pixels to blocks forms a chequerboard pattern in two dimensions. Roberts and Sahu (1997) showed for the Ising model with 
                           β
                           ∈
                           
                              {
                              0.001
                              ,
                              0.010
                              ,
                              0.100
                              }
                           
                         that parallel, chequerboard updating can reduce the elapsed computation time without any impact on convergence. The dissertation of Feng (2008) provides a more detailed description of chequerboard updating and also generalises this algorithm to 3D, as well as to other neighbourhood schemes.

The full conditional distribution of the inverse temperature (Eq. (2)) involves an intractable normalising constant, so there is no closed-form solution for sampling from it directly. Gelman and Meng (1998) derived an approximation to the log ratio of normalising constants using the path sampling identity: 
                           
                              (12)
                              
                                 log
                                 
                                    {
                                    
                                       
                                          C
                                          
                                             (
                                             
                                                
                                                   β
                                                
                                                
                                                   ∘
                                                
                                             
                                             )
                                          
                                       
                                       
                                          C
                                          
                                             (
                                             
                                                
                                                   β
                                                
                                                
                                                   ′
                                                
                                             
                                             )
                                          
                                       
                                    
                                    }
                                 
                                 =
                                 
                                    
                                       ∫
                                    
                                    
                                       
                                          
                                             β
                                          
                                          
                                             ′
                                          
                                       
                                    
                                    
                                       
                                          
                                             β
                                          
                                          
                                             ∘
                                          
                                       
                                    
                                 
                                 E
                                 
                                    
                                       
                                    
                                    
                                       
                                          z
                                       
                                       |
                                       β
                                    
                                 
                                 
                                    [
                                    
                                       S
                                    
                                    
                                       (
                                       
                                          z
                                       
                                       )
                                    
                                    ]
                                 
                                 
                                 
                                    d
                                 
                                 β
                                 ,
                              
                           
                         where 
                           
                              
                                 β
                              
                              
                                 ∘
                              
                           
                         is the current value of the parameter, 
                           
                              
                                 β
                              
                              
                                 ′
                              
                           
                         is the Metropolis–Hastings (M–H) proposal, 
                           
                              S
                           
                           
                              (
                              
                                 z
                              
                              )
                           
                           =
                           
                              
                                 1
                              
                              
                                 2
                              
                           
                           
                              
                                 ∑
                              
                              
                                 i
                                 =
                                 1
                              
                              
                                 n
                              
                           
                           
                              
                                 ∑
                              
                              
                                 i
                                 ∼
                                 ℓ
                              
                           
                           δ
                           
                              (
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    z
                                 
                                 
                                    ℓ
                                 
                              
                              )
                           
                         is the sufficient statistic of the Potts model, and 
                           E
                           
                              
                                 
                              
                              
                                 
                                    z
                                 
                                 |
                                 β
                              
                           
                         is the expectation with respect to the distribution of 
                           
                              z
                           
                         given 
                           β
                        . The value of this definite integral can be approximated by simulating from the MRF defined by Eq. (1) for fixed values of 
                           β
                         and then interpolating between them. We used the Swendsen–Wang algorithm for simulating from 
                           
                              z
                           
                           |
                           β
                        , as explained in Section  3.3. We performed 1000 iterations for each value of 
                           β
                        , discarding the first 500 as burn-in. Convergence was monitored by tracing the value of 
                           
                              S
                           
                           
                              (
                              
                                 z
                              
                              )
                           
                        . Fig. 3
                         illustrates linear interpolation of 
                           
                              S
                           
                           
                              (
                              
                                 z
                              
                              )
                           
                         on a 3D lattice for 
                           k
                           =
                           9
                         and 
                           β
                         ranging from 0 to 2 in increments of 0.1.


                        
                           
                              
                           
                        
                     

Path sampling is explained in further detail by Hurn et al. (2003a) and Marin and Robert (2014, chap. 8). This algorithm has an advantage over auxiliary variable methods such as the exchange algorithm (Murray et al., 2006) or ABC (Grelaud et al., 2009) because the additional simulations are performed prior to fitting the model, rather than at each iteration. This is particularly the case when analysing multiple images that all have approximately the same dimensions, as in the example of Section  4.

MCMC takes longer to converge for larger values of 
                           β
                        , since the latent labels tend to keep the same value for many iterations. The algorithm of Swendsen and Wang (1987) avoids this problem by coalescing adjacent pixels with the same label into clusters, then updating all of the labels within a cluster to the same value. 
                           
                              
                           
                        
                     

A disadvantage of Algorithm 3 is that it performs poorly in the presence of a strong external field (Hurn, 1997). Thus it is unsuitable for posterior inference, but can be used for simulating from 
                           
                              z
                           
                           |
                           β
                         as required for path sampling.

There are two essential ingredients for the external field prior: reference coordinates, which we derive from a manually-labelled image; and spatial uncertainty, which we model using published studies of geometric variation. We have chosen to illustrate our method using cone-beam CT scans because both of these elements are readily available in a clinical context. However, it should be noted that this method could also be applied to longitudinal imaging studies in many other scientific fields, such as satellite remote sensing or confocal laser microscopy.

To evaluate the segmentation accuracy of our method, we applied it to 27 cone-beam CT scans of a commercially available electron density (ED) phantom, Computerised Imaging Reference Systems (CIRS) Model 062 (Norfolk, VA, USA). The ED phantom is manufactured from epoxy and contains cylindrical inserts that mimic the X-ray absorption of human tissue: lung (inhale); lung (exhale); adipose (fatty tissue); breast (50% fat); water-equivalent solid; muscle; liver; spongy (trabecular) bone; and dense (cortical) bone. Since the geometry and density of this object are known, the segmentation can be compared to the ground truth to evaluate accuracy. This provides an advantage over using scans of patients to evaluate the method because in clinical data the true segmentation is unknown (Bouix et al., 2007). A reference segmentation can be provided by a clinical expert, but this also introduces a source of error. Due to the irregularity and complexity of the medical images, there can be significant discrepancies between segmentations of the same image by different experts (Lütgendorf-Caucig et al., 2011; Weiss et al., 2010).

The 27 cone-beam CT scans were taken with the inner ring of imaging phantom inserts rotated by between 0° and 16°, corresponding to a translation of between 0 mm and 25 mm. These displacements were intended to mimic the physiological variability observed in daily cone-beam CT scans of prostate cancer patients, as studied by Frank et al. (2008). We chose to use this as the basis of our experimental design because image-guided radiotherapy for prostate cancer is the most common application of cone-beam CT imaging.

The cone-beam CT scans were acquired using a medical linear accelerator with On Board Imager (OBI) CBCT imaging system (Varian Medical Systems, Palo Alto, USA) according to the same clinical protocol that is used for scanning prostate cancer patients. A half bow-tie filter was used to achieve a 450 mm field of view. The dimensions of the reconstructed voxels were 0.88×0.88×2 mm. The images were cropped using external image processing software (Schneider et al., 2012) to conform to the dimensions of the phantom: 376×308 pixels and 23 slices, or approximately 330×270×46 mm. Summary statistics (observed mean and standard deviation) for each cone-beam CT scan are summarised in the supplementary material accompanying the electronic version of this paper (see Appendix A). An axial slice from one of the cone-beam CT scans is shown in Fig. 4
                        (b).

The external field prior was precomputed according to Eq. (6). This prior was centred on the geometry of the ED phantom at 0 offset. We used a mean displacement of 1.2 mm with standard deviation 7.3 mm. This spatial variability corresponds to the prostate motion observed by Frank et al. (2008) in their study of 15 radiotherapy patients. The external field is illustrated in Fig. 4(a).

We also used informative priors for the means and variances of the mixture components, using a similar method to Alston et al. (2007). To determine the distribution of pixel intensities for each tissue type, we obtained an independent set of 26 cone-beam CT scans of the ED phantom. The resulting priors for 
                           
                              
                                 μ
                              
                              
                                 j
                              
                           
                           ∼
                           N
                           
                              (
                              
                                 
                                    m
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    φ
                                 
                                 
                                    j
                                 
                                 
                                    2
                                 
                              
                              )
                           
                         and 
                           
                              
                                 σ
                              
                              
                                 j
                              
                              
                                 2
                              
                           
                           ∼
                           
                              IG
                           
                           
                              (
                              
                                 
                                    ν
                                 
                                 
                                    2
                                 
                              
                              ,
                              
                                 
                                    ν
                                    
                                       
                                          s
                                       
                                       
                                          2
                                       
                                    
                                 
                                 
                                    2
                                 
                              
                              )
                           
                         are listed in Table 1
                        .

We fitted the hidden Potts model to the data both with and without the external field prior, to measure the difference in the resulting segmentation accuracy. Both models were run for 55,000 MCMC iterations, discarding the first 5,000 as burn-in. This took between 9 and 14 h per scan on a 2.66 GHz Intel Xeon computer with 12GB RAM, running 64bit GNU/Linux 3.0.38 and R 2.15.3. As well as monitoring the values of the model parameters 
                           
                              
                                 μ
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 σ
                              
                              
                                 j
                              
                              
                                 2
                              
                           
                         and 
                           β
                        , we also calculated the sum of like neighbours and the number of correctly-classified voxels at each iteration. These additional statistics were used as convergence diagnostics, to check that the model was mixing well and that it had reached a steady state.

The voxels were labelled according to the most frequently-assigned value of 
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                         over the remaining 50,000 iterations. Classification accuracy was measured using the Dice similarity coefficient (Dice, 1945): 
                           
                              (14)
                              
                                 D
                                 S
                                 
                                    
                                       C
                                    
                                    
                                       j
                                    
                                 
                                 =
                                 
                                    
                                       2
                                       ×
                                       
                                          |
                                          
                                             
                                                ȷ
                                             
                                             
                                                ˆ
                                             
                                          
                                          ∩
                                          j
                                          |
                                       
                                    
                                    
                                       
                                          |
                                          
                                             
                                                ȷ
                                             
                                             
                                                ˆ
                                             
                                          
                                          |
                                       
                                       +
                                       
                                          
                                             n
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                           
                         where 
                           D
                           S
                           
                              
                                 C
                              
                              
                                 j
                              
                           
                         is the Dice similarity coefficient for label 
                           j
                           ,
                           
                              |
                              
                                 
                                    ȷ
                                 
                                 
                                    ˆ
                                 
                              
                              |
                           
                         is the count of voxels that were classified with the label 
                           j
                           ,
                           
                              
                                 n
                              
                              
                                 j
                              
                           
                         is the number of voxels that are known to truly belong to component 
                           j
                        , and 
                           
                              |
                              
                                 
                                    ȷ
                                 
                                 
                                    ˆ
                                 
                              
                              ∩
                              j
                              |
                           
                         is the count of voxels in 
                           j
                         that were labelled correctly.

The results are summarised in Table 2
                        . Individual results for each cone-beam CT scan are available in the online supplementary material (see Appendix A). An example of one of the segmentations is illustrated in Fig. 4(d). When we estimated the effect size of the external field prior using paired differences, we found that it was dependent on the tissue type. For soft tissue (adipose, breast, liver and muscle) the 95% highest posterior density (HPD) interval for the paired differences in Dice coefficient (with and without the external field) was between 0.64 and 0.66. The smallest improvement was between 0.34 and 0.38 for lung (inhale). Overall, the mean voxel misclassification rate improved from 86.8% to 6.2%.

The posterior estimate of the inverse temperature was almost identical for all 27 cone-beam CT scans. Without the external field prior, the pooled 95% HPD interval for 
                           β
                         was [0.793;0.795]. With the prior, the HPD interval for 
                           β
                         converged to [1.151;1.197]. As discussed in Section  4.2, the value of 
                           β
                         changes with the strength of the prior, as measured by the standard deviation.

The amount of spatial variability in our application is quite small (standard deviation of 7.3 mm) relative to the size of the images (330×270×46 mm). We reran the model using external field priors with increasing levels of uncertainty (
                           2
                           
                              
                                 σ
                              
                              
                                 Δ
                              
                           
                         up to 
                           5
                           
                              
                                 σ
                              
                              
                                 Δ
                              
                           
                        , illustrated in Fig. 2) to measure the relationship between the strength of the prior and the resulting segmentation accuracy. The pixel-wise misclassification rates for the 27 cone-beam CT scans are shown in Fig. 5
                        . We found that there was a strong relationship, with the proportion of misclassified pixels increasing sharply at first, but then gradually levelling off. As the uncertainty increases, we would expect that the misclassification rate would approach 86.8%, the accuracy that is observed without the external field prior.

Fixing the value of 
                           β
                         at the point estimate of 1.2 did not have any significant effect on segmentation accuracy (mean pairwise difference of 0.1% with standard deviation of 0.1). In terms of computational cost for path sampling, there was a mean pairwise difference of 9 h (standard deviation 4.3 h) in CPU time. However, this did not make any significant difference to the elapsed runtime, due to the variability in execution of the multi-threaded process.

We also measured the effect on segmentation accuracy when 
                           β
                         was fixed at zero, which is equivalent to an independent mixture of Gaussians. When 
                           
                              
                                 σ
                              
                              
                                 Δ
                              
                           
                           =
                           7.3
                           
                           mm
                         the average misclassification rate was 7.3% (mean pairwise difference of 1.07% with standard deviation of 0.03). This indicates that the Potts model contributed very little to the result. Most of the spatial dependence in the model was accounted for by the external field prior, while the local smoothing of the labels made a small but significant difference. When 
                           
                              
                                 σ
                              
                              
                                 Δ
                              
                           
                         was doubled to 14.6 mm, the segmentation accuracy decreased overall but the contribution from the Potts model was larger (mean pairwise difference of 4.41% with standard deviation of 0.21). When the uncertainty was increased still further, the Potts model actually made the accuracy worse. This can be seen in Fig. 5 for 
                           
                              
                                 σ
                              
                              
                                 Δ
                              
                           
                           ∈
                           
                              {
                              21.9
                              ,
                              29.2
                              ,
                              36.5
                              }
                           
                        . This is because the Potts model relies on the labels of the neighbouring pixels. If many of the pixels are misclassified, this will then bias the probabilities of the labels towards an incorrect value.

The value of the inverse temperature obtained by path sampling also changed as the uncertainty in the prior increased. Fig. 6
                         shows the posterior mean of 
                           β
                         for the 27 cone-beam CT scans. It is evident from Eq. (7) that 
                           β
                         is a free parameter that balances the strength of spatial association against the external field (which in our model is data 
                           ×
                         prior). The external field prior becomes weaker as the standard deviation increases, thus the value of 
                           β
                         is lower to compensate.

In this section we demonstrate how the external field prior can be applied to biological data. Our retrospective study has been approved by the Human Research Ethics Committees of Queensland Health (Metro South HREC/12/QPAH/475 and SSA/12/QPAH/493) and Queensland University of Technology (1200000724). The radiotherapy treatment plan, with its associated fan-beam CT scan and manual contours, as well as daily cone-beam CT scans are collected routinely as part of the standard clinical protocol for external-beam radiotherapy of prostate cancer patients.

The patient was treated with a Varian linear accelerator using the same scanning protocol that we employed in Section  4.1 for our ED phantom study. Fan-beam CT scanners are calibrated in Hounsfield units (HU) with air at −1000 HU and water at 0 HU (Kalender, 2011). There is a well-known linear relationship between tissue density (ED×1023/cm3) and the corresponding HU values, as shown in Fig. 7
                        (a). The cone-beam CT scanner was not calibrated on the same scale, but there was still a linear relationship, shown in Fig. 7(b). We obtained estimates of the densities of the organs of interest (prostate, seminal vesicles, bladder and rectum), shown in Table 3
                        , from the Pinnacle3 v9.4 treatment planning system (Philips Healthcare, Fitchburg, WI, USA). As expected, these fell somewhere between the value of adipose and muscle, in the region of soft tissue. We obtained priors for the pixel intensities by predicting from a linear regression model. We found that the estimates of cone-beam CT pixel intensity derived from the ED phantom were biased towards underestimating the pixel intensity values in patient scans. This is why there is a difference of 200 between the values of Tables 1 and 3.

The treatment planning contours of the prostate, seminal vesicles, solid bladder and rectal wall were exported to Pinnacle3. ROI files for computation of the spatial prior. An axial slice of the fan-beam CT scan with planning contours is shown in Fig. 8
                        (a). The coordinate reference system was translated to account for differences in spatial resolution and isocentre between the fan-beam CT and cone-beam CT scans. We used multivariate normal distributions to represent spatial uncertainty, rather than the isotropic model in Eq. (6): 
                           
                              
                                 
                                    
                                       
                                          Δ
                                       
                                       
                                          prostate
                                       
                                    
                                    ∼
                                    MV N
                                    
                                       (
                                       
                                          [
                                          
                                             
                                                
                                                   0.1
                                                
                                             
                                             
                                                
                                                   0.2
                                                
                                             
                                             
                                                
                                                   −
                                                   0.5
                                                
                                             
                                          
                                          ]
                                       
                                       ,
                                       
                                          [
                                          
                                             
                                                
                                                   4
                                                   .
                                                   
                                                      
                                                         1
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                                
                                                   0
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   0
                                                   .
                                                   
                                                      
                                                         9
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   0
                                                
                                                
                                                   2
                                                   .
                                                   
                                                      
                                                         9
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                             
                                          
                                          ]
                                       
                                       )
                                    
                                    ,
                                    
                                    and
                                 
                              
                              
                                 
                                    
                                       
                                          Δ
                                       
                                       
                                          SV
                                       
                                    
                                    ∼
                                    MV N
                                    
                                       (
                                       
                                          [
                                          
                                             
                                                
                                                   1.2
                                                
                                             
                                             
                                                
                                                   −
                                                   0.9
                                                
                                             
                                             
                                                
                                                   −
                                                   0.7
                                                
                                             
                                          
                                          ]
                                       
                                       ,
                                       
                                          [
                                          
                                             
                                                
                                                   7
                                                   .
                                                   
                                                      
                                                         3
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                                
                                                   0
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   1
                                                   .
                                                   
                                                      
                                                         9
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   0
                                                
                                                
                                                   4
                                                   .
                                                   
                                                      
                                                         5
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                
                                             
                                          
                                          ]
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                         These values (in mm) for the means and variances were published by Frank et al. (2008). Although we have treated the three axes (anteroposterior, lateral and superoinferior) as independent, a model that included negative correlation might be more realistic. A meta-analysis of similar studies could be conducted to produce a more accurate estimate of the distribution. Computation of the external field prior took 7 h for the prostate, 4 h for the seminal vesicles, 15.5 h for the bladder, and 8 h for the rectum. A visualisation of the spatial distribution is shown in Fig. 8(b).

The cone-beam CT scan was cropped to the region of interest, 182×182×80 voxels (a cube 160×160×160 mm). An axial slice from the cone-beam CT is shown in Fig. 8(c). Muscle, adipose tissue and bone was treated as spatially homogeneous within that region, with a uniform prior on the external field. Precomputation for path sampling took 1 h and 9 min for 41 values of 
                           β
                        . The model was run for 55,000 iterations, discarding the first 5000 as burn-in, which took 16 h. The resulting segmentation is shown in Fig. 8(d).

@&#DISCUSSION@&#

We have proposed a novel formulation for introducing additional spatial prior information into the hidden Potts model, via an external field. We fit this model using a combination of Gibbs sampling, chequerboard updating and path sampling. The full source code for our implementation of these algorithms is available from the companion website. The method is particularly applicable in longitudinal imaging, where the segmentation of one image can be used as a prior for the next. In this paper we have used the same prior for every image, since we focused on comparing the results that were obtained when the prior was not used. In a longitudinal setting it would also be possible to update the prior dynamically as each image is processed, using a similar approach to Alston et al. (2007) for the mean and variance.

In situations where the intensity values and spatial homogeneity are insufficient for accurate classification of the image pixels, an external field prior substantially improves segmentation accuracy. We demonstrated our method by applying it to cone-beam CT scans, which are medical images that are used for image-guided interventions, such as external-beam radiotherapy. The external field prior improved the pixel misclassification rate from 87% to 6%. We have also applied our method to biological data, demonstrating that the external field prior can be computed from the planning CT scan and manual contours that are routinely available in a clinical setting.

This method shows great potential for application in automated analysis of daily cone-beam CT scans of radiotherapy patients. By deriving the external field prior from a patient’s treatment plan, the method would better accommodate within-patient variation than the probabilistic anatomical atlases currently in use. The method could also be applied to other images, such as MRI or satellite remote sensing. These applications involve repeated observations of a subject over time. In order for the external field prior to be most effective, the rate of change in the subject should be gradual, relative to the frequency with which the process is observed.

Due to the runtime of 16 h, the MCMC algorithms described in this paper would be unsuitable for online use during patient treatment. However, they could be used offline for dose tracking and other monitoring activities. Approximate algorithms such as iterated conditional modes (ICM;  Besag, 1986) or variational Bayes (VB;  McGrory et al., 2009) could also be used to fit the model in time-critical applications such as image-guided radiotherapy. In Moores et al. (2014) we have previously shown that the hidden Potts model with external field prior can be fit using ICM with an average runtime of only 9 min. A drawback of these methods is that the options for estimating the inverse temperature are more limited, although a fixed value of 
                        β
                      would be sufficient for most purposes.

@&#ACKNOWLEDGEMENTS@&#

The authors thank Louise Ryan, Nial Friel and Anthony Pettitt for useful discussions, as well as the co-editor and two anonymous reviewers for their comments on earlier versions of this work. Moores thanks Queensland University of Technology and the Australian federal government Department of Education, Science and Training for financial support. Mengersen’s research is funded by Discovery Project grant from the Australian Research Council. Computational resources and services used in this work were provided by the HPC and Research Support Group, Queensland University of Technology, Brisbane, Australia.

Supplementary material related to this article can be found online at http://dx.doi.org/10.1016/j.csda.2014.12.001. The complete source code for the R package bayesImageS is available from the RunMyCode companion website, http://www.runmycode.org/companion/view/546.

The following is the Supplementary material related to this article. 
                        
                           MMC S1
                           
                              Tables of summary statistics for the electron density phantom.
                           
                           
                        
                     
                  

@&#REFERENCES@&#

