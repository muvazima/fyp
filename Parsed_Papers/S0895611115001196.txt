@&#MAIN-TITLE@&#Non-rigid image registration with anatomical structure constraint for assessing locoregional therapy of hepatocellular carcinoma

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           Propose nonrigid registration for quantitatively assessing the treated region with LT.


                        
                        
                           
                           Edit the anatomical landmarks as constrained for maintaining the internal structure.


                        
                        
                           
                           From the viewpoint of physics, the landmarks carry the energy in displacement field.


                        
                        
                           
                           The proposed method achieved the promising performance.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Non-rigid registration

Cost function

Anatomical structure

Locoregional therapy

Hepatocellular carcinoma

@&#ABSTRACT@&#


               
               
                  Purpose
                  Assessing the treated region with locoregional therapy (LT) provides valuable information for predicting hepatocellular carcinoma (HCC) recurrence. The commonly used of assessment method is inefficient because it only compares two-dimensional CT images manually. In our previous work, we automatically aligned the two CT volumes to evaluate the therapeutic efficiency using registration algorithms. The non-rigid registration is applied to capture local deformation, however, it usually destroys internal structure. Taking these into consideration, this paper proposes a novel non-rigid registration approach for evaluating LT of HCC to maintain the image integrity.
               
               
                  Method
                  In our registration algorithm, a global affine transformation combined with localized cubic B-spline is used to estimate the significant non-rigid motions of two livers. The proposed method extends a classical non-rigid registration based on mutual information (MI) that uses an anatomical structure term to constrain the local deformation. The energy function can be defined based on the total one associated with the anatomical structure and deformation information. Optimal transformation is obtained by finding the equilibrium state in which the total energy is minimized, indicating that the anatomical landmarks have found their correspondences. Thus, we can use the same transformation to automatically transform the ablative region to the optimal position.
               
               
                  Results
                  Registration accuracy is evaluated using the clinical data. Improved results are obtained with respect to all criteria in our proposed method (MI-LC) than those in the MI-based non-rigid registration. The landmark distance error (LDE) of MI-LC is decreased by an average of 3.93mm compared to the case of MI-based registration. Moreover, it could be found regardless of how many landmarks applied in our proposed method, a significant reduction in LDE values using registrations based on MI-LC compared with those based on MI is confirmed.
               
               
                  Conclusion
                  Our proposed approach can guarantee the continuity, the accuracy and the smoothness of structures by constraining the anatomical features. The results clearly indicate that our method can retain the local deformation of the image. In addition, it assures the anatomical structure stability.
               
            

@&#INTRODUCTION@&#

Locoregional therapy (LT) is a choice for the treatment of hepatocellular carcinoma (HCC). It targets the specific inflicted region of the liver by injecting a higher dose of drugs into the tumor without exposing the rest of the patient's body. This therapy reduces the chances of infection and shortens recovery time. However, in certain situations, tumors cannot be removed clearly with LT. Thus, it is desirable to assess the therapeutic efficiency after treatment of HCC. Currently, the assessment method widely used compares the two-dimensional (2D) CT images (axial, coronal, and sagittal) manually; however, selecting the corresponding slices is a time-consuming process. Hence, in [1], we proposed a three-dimensional (3D) imaging fusion technique that considered a few nearby slices to assess HCC of the treated region before and after LT. This method only performed two factors of transformation: rotation and translation, while other factors should also be taken into account. However, the accuracy in determining the location of the ablative region is significantly limited due to manual adjustment.

To resolve these problems, in our previous research [2], we applied an automatic registration method for this application. However, as Archip described in [3] and Lee described in [4], registering soft tissues with rigid registration may result in errors as high as 19–20mm, due to deformations that may be caused by liver movements such as respiration, variations of position and corporal mass changes over time. To improve detection and characterization in terms of volume and relation with HCC, an accurate non-rigid image registration algorithm is required. Currently, rich literatures on non-rigid registration method have been published [5–14]. It can be summarized as: intensity-based [14–16] (such as B-spline, demons), landmark-based [17,18] (such as thin-plate, ICP) registration method. Meyer et al. [19] proposed a notable registration algorithm based on a thin-plate spline deformation. Due to prohibitive computational complexity of the thin-plate spline warps, the registration was restricted to a very limited number of degrees of freedom. Hence, landmark-based nonrigid registration is not sufficient for most applications, especially the liver registration. Because the number of landmarks for liver which located in the discernible anatomical points is very few that affect the accuracy of registration. In addition, it is a complex task to find the corresponding landmarks. Some studies have presented that intensity-based non-rigid registration methods would be more robust and easier to implement than landmark-based. Intensity-based non-rigid registration, however, poses a number of challenges. It will breaks the internal structure of the organ volume during the intensity-based registration process, and hence results in the loss of anatomical information.

As already explained above, the intensity-based rigid registration is performed to capture the global alignment between images without considering local deformation. The intensity-based non-rigid registration techniques can capture local deformation, which results in a change in the anatomical structure of the volume. However, it is essential that medical images maintain their anatomical structure stability and integrality. Hence, the objective of our work is to provide a new option for non-rigid registration to guarantee the anatomical structure of shape. In this study, we add a landmark penalty term into mutual information (MI) as a new energy function (MI-LC) to constrain the local deformation. If we treated the landmark as an elastic material, from the viewpoint of physics, when the landmarks are not in the optimal positions, the resulting distortion will produce a displacement field. The landmarks in the displacement field carry potential energy. When they move and interact, the total energy associated with them is change. According to the principle of minimum total potential energy, optimal transformation is obtained by reaching the equilibrium state in which the total energy is minimized. Experimental demonstrate our proposed method successfully overcame the disadvantage of intensity-based non-rigid registration.

The rest of this paper is organized as follows: An overview of our registration implementation integrated with the illustration of landmark positions is presented in Section 2. Extensive evaluation of our method is illuminated in Section 3. Section 4 is devoted to the discussion of performance and Section 5 concludes the paper.

To evaluate LT of HCC, we need to register the ablative region onto the tumor using registration method. The objective of image registration is to find the optimal transformation parameters μ, which maps every point in the postoperative liver (after LT) which is called the moving image M onto its corresponding point in the preoperative liver (before LT) which is called the fixed image R, so that the similarity function, which measures the difference between M and R can be minimized. Then, it can automatically transform the ablative region to the optimal position using the same transformation parameters.

The input images are given as two 3D discrete signals: the moving image M and the fixed image R with intensities f
                        
                           m
                        (x) and f
                        
                           r
                        (x), respectively, where x
                        ∈
                        I
                        ⊂
                        Z
                        
                           N
                        , and I is a 3D discrete interval representing the set of all voxel coordinates in the image. The transformed moving image W can be obtained by using the optimal transformation parameters μ, that can be defined as 
                           
                              
                                 f
                                 w
                              
                           
                           (
                           
                              
                                 x
                              
                           
                           )
                           =
                           
                              
                                 f
                                 m
                              
                           
                           (
                           
                              
                                 x
                              
                           
                           ;
                           
                              
                                 μ
                              
                           
                           )
                        .

Nevertheless the majority of the image registration methods can be viewed as a combination of the four distinctive components: transformation, interpolation, the similarity metric based on cost function, optimization. As shown in Fig. 1
                        , among the four components, the similarity metric based on cost function is the most important significant critical for the registration algorithm, as it defines the goal of optimization and measures how well the transformed moving image W matches the fixed image R. In the following, the non-rigid registration algorithm is described in detail.

As explained above, we estimate the parameter of transformation by optimizing a cost function (similarity metric) in the processing of registration. In general, the solution to the registration problem can be computed by optimizing the following cost function [14,20,21]:
                              
                                 (1)
                                 
                                    
                                       
                                          
                                             E
                                             (
                                             
                                                
                                                   μ
                                                
                                             
                                             )
                                             =
                                             
                                                
                                                   E
                                                   sim
                                                
                                             
                                             (
                                             R
                                             ,
                                             W
                                             )
                                             =
                                             
                                                
                                                   E
                                                   sim
                                                
                                             
                                             (
                                             
                                                
                                                   f
                                                   r
                                                
                                             
                                             ,
                                             
                                                
                                                   f
                                                   m
                                                
                                             
                                             ·
                                             T
                                             (
                                             
                                                
                                                   μ
                                                
                                             
                                             )
                                             )
                                             =
                                             
                                                
                                                   E
                                                   sim
                                                
                                             
                                             (
                                             
                                                
                                                   f
                                                   r
                                                
                                             
                                             (
                                             
                                                
                                                   x
                                                
                                             
                                             )
                                             ,
                                             
                                                
                                                   f
                                                   m
                                                
                                             
                                             (
                                             
                                                
                                                   x
                                                
                                             
                                             ;
                                             
                                                
                                                   μ
                                                
                                             
                                             )
                                             )
                                          
                                       
                                    
                                 
                              
                           
                        

According to the intensity-based registration process, the aim is to minimize/maximize the similarity E
                           
                              sim
                            between the two images. There are several image metrics that are used in voxel similarity-based image registration [5–9]: correlation coefficient, sum of squared differences (SSD), or mutual information (MI). SSD is one of the simplest voxel similarity based cost functions which should be minimized during registration. SSD is based on the strict assumption that the two images only differ from the Gaussian noise, but this is not true for medical images, especially for multi-modal images. Therefore, this method can be only used for mono-modal registration. However, MI [10,11] is the most widely used for medical image similarity measures that no limit to the image content about the modalities (mono-modal and multi-modal). MI can measure the statistical dependence or information redundancy between the image intensities of corresponding voxels in both images, which is assumed to be maximal if the images are registered.

However, the biggest serious drawback of MI is the absence of spatial information [12,14,22,23], due to it's definition being based on Shannon's Entropy, which assumes each pixels is independent of its neighbors. Hence, intensity relationships in one region can occasionally cause errors to occur in another region where the intensity relationships are vary considerable. In [13], Loeckx et al. described that MI-based non-rigid registration might reduce smaller image details or have problems with spatially-varying intensity inhomogeneity due to a bias field.

The classical non-rigid registration based on intensity exhibits an inherent weakness in that it destroys internal structures of the volume. Hence, in this study, we proposed a novel non-rigid registration algorithm using an anatomical structure term to constrain the deformation, which promised to outperform the classical intensity-based non-rigid registration method in terms of maintaining the anatomical structural stability.

Based on intensity similarity metric, a different approach is used to constrain the anatomical structure to be stable by adding a landmark penalty term. On the basis of minimizing the cost function, the proposed similarity metric MI-LC is defined as:
                              
                                 (2)
                                 
                                    E
                                    (
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    =
                                    
                                       
                                          E
                                          sim
                                       
                                    
                                    (
                                    R
                                    ,
                                    W
                                    )
                                    +
                                    λ
                                    
                                    LC
                                    (
                                    
                                       
                                          L
                                          r
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          w
                                       
                                    
                                    )
                                    =
                                    
                                       
                                          E
                                          sim
                                       
                                    
                                    (
                                    
                                       
                                          f
                                          r
                                       
                                    
                                    ,
                                    
                                       
                                          f
                                          m
                                       
                                    
                                    ·
                                    T
                                    (
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    )
                                    +
                                    λ
                                    
                                    LC
                                    (
                                    
                                       
                                          L
                                          r
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          m
                                       
                                    
                                    ·
                                    T
                                    (
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    )
                                    =
                                    
                                       
                                          E
                                          sim
                                       
                                    
                                    (
                                    
                                       
                                          f
                                          r
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    )
                                    ,
                                    
                                       
                                          f
                                          m
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    ;
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    )
                                    +
                                    λ
                                    
                                    LC
                                    (
                                    
                                       
                                          L
                                          r
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          
                                             m
                                             ;
                                             
                                                
                                                   μ
                                                
                                             
                                          
                                       
                                    
                                    )
                                 
                              
                           where L
                           
                              r
                            and L
                           
                              m
                            are the fixed landmarks and moving landmarks, respectively. 
                              
                                 
                                    L
                                    w
                                 
                              
                              =
                              
                                 
                                    L
                                    
                                       m
                                       ;
                                       μ
                                    
                                 
                              
                            is the corresponding transformed moving landmarks. The first term is the driving force behind the intensity-based registration process, we can evaluate the similarity by computing SSD or MI metric. Due to SSD having limitations, it can be only used for the mono-modal registration. Hence, for future applications, we apply MI into our method for the multi-modal images. For the second term, LC is a landmark penalty term with the weight λ used to constrain the anatomical structure. The definition of mutual information would be explained in Appendix A.

Considering that a landmark penalty term is introduced in the cost function for guaranteeing the anatomical structure stability. To be reliable, the landmarks are taken as being clearly discernible geometrical features of the medical image. In this study, we have had the following four sets of landmarks between before LT and after LT manually defined by the medical experts. These landmarks are shown in Fig. 2
                           .

Combining the anatomical structure constraint term into the mutual information (MI), the cost function is as follows:
                              
                                 (3)
                                 
                                    E
                                    (
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    =
                                    −
                                    
                                       
                                          I
                                          MI
                                       
                                    
                                    (
                                    R
                                    ,
                                    W
                                    )
                                    +
                                    λ
                                    
                                    LC
                                    (
                                    
                                       
                                          L
                                          
                                             
                                                r
                                             
                                          
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          
                                             
                                                w
                                             
                                          
                                       
                                    
                                    )
                                    =
                                    −
                                    
                                       
                                          I
                                          MI
                                       
                                    
                                    (
                                    
                                       
                                          f
                                          r
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    )
                                    ,
                                    
                                       
                                          f
                                          m
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    ;
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    )
                                    +
                                    λ
                                    
                                    LC
                                    (
                                    
                                       
                                          L
                                          
                                             
                                                r
                                             
                                          
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          
                                             
                                                
                                                   m
                                                
                                             
                                             ;
                                             
                                                
                                                   μ
                                                
                                             
                                          
                                       
                                    
                                    )
                                 
                              
                           where I
                           MI is the mutual information value between two livers before LT and after LT given in Eq. A.1.

We introduce an additional information based on the anatomical structure constraint term that can be written into:


                           
                              
                                 (4)
                                 
                                    LC
                                    (
                                    
                                       
                                          L
                                          
                                             
                                                r
                                             
                                          
                                       
                                    
                                    ,
                                    
                                       
                                          L
                                          
                                             
                                                w
                                             
                                          
                                       
                                    
                                    )
                                    =
                                    
                                       1
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       ∑
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        r
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                   −
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        w
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                
                                             
                                          
                                          2
                                       
                                    
                                    =
                                    
                                       1
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       ∑
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        r
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                   −
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        
                                                                           m
                                                                        
                                                                     
                                                                     ;
                                                                     
                                                                        
                                                                           μ
                                                                        
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                
                                             
                                          
                                          2
                                       
                                    
                                 
                              
                           
                        

Our proposed similarity metric (MI-LC) is defined using the above concepts as:


                           
                              
                                 (5)
                                 
                                    E
                                    (
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    =
                                    −
                                    
                                       
                                          I
                                          MI
                                       
                                    
                                    (
                                    
                                       
                                          f
                                          r
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    )
                                    ,
                                    
                                       
                                          f
                                          m
                                       
                                    
                                    (
                                    
                                       
                                          x
                                       
                                    
                                    ;
                                    
                                       
                                          μ
                                       
                                    
                                    )
                                    )
                                    +
                                    
                                       1
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       ∑
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        r
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                   −
                                                   
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  L
                                                                  
                                                                     
                                                                        
                                                                           m
                                                                        
                                                                     
                                                                     ;
                                                                     
                                                                        
                                                                           μ
                                                                        
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                         i
                                                      
                                                   
                                                
                                             
                                          
                                          2
                                       
                                    
                                 
                              
                           
                        

Notice that with our proposed method we are not neglecting the spatial information of the image, as a landmark penalty term is introduced into the 3D intensity distributions and optimized together. The similarity calculation is based on which kind of interpolation method is used, so the B-spline interpolation is adopt in this paper.

In general, depending on the global deformation alone is not sufficient for image registration. Therefore, a method that can capture the local deformation was needed. To achieve better accuracy, the transformation in our algorithm comprised of a global and a local transformation. Our work aimed to attain a local warp that is not affected the stability of the structure. The global transformation describe the global or large motions on the two volumes, such as rotation, translation and scaling; while the local transformation describe the local or detailed motions, such as deformation of the tissues. The parameters of global transformation are first determined by registration and the results are the initial values to estimate the parameters of local transformation. By such a combination, the deformation is estimated after the large differences on the volumes are eliminated. This not only ensures the estimated deformation is more reasonable, but also makes the registration to end earlier:
                           
                              (6)
                              
                                 
                                    
                                       T
                                    
                                 
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             T
                                          
                                       
                                       Global
                                    
                                 
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                                 +
                                 
                                    
                                       
                                          
                                             T
                                          
                                       
                                       Local
                                    
                                 
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                              
                           
                        where x
                        =[x, y, z]
                           T
                         is the coordinate of a 3D point.

The simplest transformation of the global deformation method is the affine transformation [24]. For the 3D case, it can be definite by:
                           
                              (7)
                              
                                 
                                    
                                       
                                          
                                             T
                                          
                                       
                                       Global
                                    
                                 
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       Ax
                                    
                                 
                                 +
                                 
                                    
                                       t
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         a
                                                         1
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         2
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         3
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         a
                                                         4
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         5
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         6
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         a
                                                         7
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         8
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         a
                                                         9
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   x
                                                
                                             
                                             
                                                
                                                   y
                                                
                                             
                                             
                                                
                                                   z
                                                
                                             
                                          
                                       
                                    
                                 
                                 +
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         t
                                                         x
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         t
                                                         y
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         t
                                                         z
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where A is the linear transformation matrix. t is the translation vector [t
                        
                           x
                        , t
                        
                           y
                        , t
                        
                           z
                        ]
                           T
                         along each axis. Hence, the global transformation is parameterized by 12 degrees of freedom.

B-spline functions [24,25] have been widely used to represent deformations, because of their compact support, computational simplicity, good approximation properties, and implicit smoothness. Hence, in our registration process, the cubic B-spline function based free form deformation (FFD) model is chose to describe the localized characteristics or detailed motions.

The FFD model [22] is parameterized by the coefficients of a set of sparse, uniformly-spaced control points. We denote Φ as the lattice which is an integer grid of control points with uniform spacing ρ
                        =(ρ
                        
                           x
                        , ρ
                        
                           y
                        , ρ
                        
                           z
                        ). Given the coefficients of the control point are denoted as κ
                        
                           i,j,k
                        , the deformation of each point can be calculated from these coefficients by cubic B-spline interpolation, according to Eq. 8.

Let T
                        
                           Local
                        (x
                        ;
                        κ) be a B-spline transformation function. It is represented as:


                        
                           
                              (8)
                              
                                 
                                    
                                       T
                                       Local
                                    
                                 
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 ;
                                 
                                    
                                       κ
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       x
                                    
                                 
                                 +
                                 
                                    ∑
                                    
                                       l
                                       =
                                       0
                                    
                                    3
                                 
                                 
                                    
                                       ∑
                                       
                                          m
                                          =
                                          0
                                       
                                       3
                                    
                                    
                                       
                                          ∑
                                          
                                             n
                                             =
                                             0
                                          
                                          3
                                       
                                       
                                          
                                             
                                                B
                                                n
                                             
                                          
                                          (
                                          u
                                          )
                                          
                                             
                                                B
                                                m
                                             
                                          
                                          (
                                          v
                                          )
                                          
                                             
                                                B
                                                l
                                             
                                          
                                          (
                                          w
                                          )
                                       
                                    
                                 
                                 
                                    
                                       κ
                                       
                                          i
                                          +
                                          n
                                          ,
                                          j
                                          +
                                          m
                                          ,
                                          k
                                          +
                                          l
                                       
                                    
                                 
                              
                           
                        where i
                        =⌊
                        x/ρ
                        
                           x
                        
                        ⌋−1, j
                        =⌊
                        y/ρ
                        
                           y
                        
                        ⌋−1, k
                        =⌊
                        z/ρ
                        
                           z
                        
                        ⌋−1, and u
                        =
                        x/ρ
                        
                           x
                        −⌊
                        x/ρ
                        
                           x
                        
                        ⌋, 
                           v
                           =
                           y
                           /
                           
                              
                                 ρ
                                 y
                              
                           
                           −
                           ⌊
                           
                              y
                              /
                              
                                 
                                    ρ
                                    y
                                 
                              
                           
                           ⌋
                        , 
                           w
                           =
                           z
                           /
                           
                              
                                 ρ
                                 z
                              
                           
                           −
                           ⌊
                           
                              z
                              /
                              
                                 
                                    ρ
                                    z
                                 
                              
                           
                           ⌋
                        .


                        B
                        
                           l
                        , B
                        
                           m
                        , B
                        
                           n
                         are the basis function of the cubic B-spline kernel and the definition are given by:


                        
                           
                              (9)
                              
                                 
                                    
                                       
                                          
                                             
                                                B
                                                0
                                             
                                          
                                          (
                                          u
                                          )
                                          =
                                          
                                             
                                                (
                                                −
                                                
                                                   
                                                      u
                                                      3
                                                   
                                                
                                                +
                                                3
                                                
                                                   
                                                      u
                                                      2
                                                   
                                                
                                                −
                                                3
                                                u
                                                +
                                                1
                                                )
                                             
                                             6
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                B
                                                1
                                             
                                          
                                          (
                                          u
                                          )
                                          =
                                          
                                             
                                                (
                                                3
                                                
                                                   
                                                      u
                                                      3
                                                   
                                                
                                                −
                                                6
                                                
                                                   
                                                      u
                                                      2
                                                   
                                                
                                                +
                                                4
                                                )
                                             
                                             6
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                B
                                                2
                                             
                                          
                                          (
                                          u
                                          )
                                          =
                                          
                                             
                                                (
                                                −
                                                3
                                                
                                                   
                                                      u
                                                      3
                                                   
                                                
                                                +
                                                3
                                                
                                                   
                                                      u
                                                      2
                                                   
                                                
                                                +
                                                3
                                                u
                                                +
                                                1
                                                )
                                             
                                             6
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                B
                                                3
                                             
                                          
                                          (
                                          u
                                          )
                                          =
                                          
                                             
                                                
                                                   
                                                      u
                                                      3
                                                   
                                                
                                             
                                             6
                                          
                                       
                                    
                                 
                              
                           
                        
                     


                        κ can be regarded as the parameters of the local transformation and the degrees of non-rigid deformation which can be modeled depends essentially on the resolution of the mesh of control points. A small spacing of control points allowed modeling of highly local non-rigid deformations. In our application, the spacing on each axis is equal to 16-voxel-width, so the number of the control points approximate 4096 and the number of the parameters is about 12288. According to Eqs. 8 and 9, the set of parameters for the transformation is μ
                        ={A, t, κ}. Using this parameters of transformation, the transformed moving image 
                           
                              
                                 f
                                 w
                              
                           
                           (
                           
                              
                                 x
                              
                           
                           )
                           =
                           
                              f
                              m
                              
                           
                           (
                           T
                           (
                           
                              
                                 x
                              
                           
                           ;
                           
                              
                                 μ
                              
                           
                           )
                           )
                         can be computed.

In our application, in order to minimize the cost function E(μ), the L-BFGS-B optimization method [26] are applied to find the optimal transformation parameters. The parameters of global and local transformation are optimized separately. Initially, rigid registration is used, the parameters of affine transformation are adjusted by L-BFGS-B optimization method. When this process is finished, the parameters of global transformation are set to be fixed. Then, the L-BFGS-B optimization method is applied to find the optimal parameters of local transformation in nonrigid registration process.

@&#RESULTS@&#

A dataset consisting of 9 clinical subjects with the HCC of pathological scenarios was used from a Kansai Medical University clinical dataset. Each sets of the clinical subject were imaged CT image from the same patients at pre-operation and post-operation (before LT and after LT). All of the volumes were stored in DICOM image format with a depth of 12 bits per pixel. For the first 6 sets of CT volumes, we call it Group-I in this paper. The data had 49–55 slices with 5–7mm section thickness and their in-plane dimensions were 0.65mm×0.65mm with a 512×512mm2 in field of view (FOV). To better observe the hepatocellular carcinoma (HCC), the portal venous phase scanning was imaged after injection of a nonionic iodinated contrast agent. The contrast-enhanced portal venous (PV) phase CTs were performed in all Group-I registration process. For the remaining 3 sets of CT volumes, we call it Group-II in this paper. Resolution of the image was 0.5859×0.5859×2m3 with a size of 512×512×(110–151). Each CT volume in Group-II had one contrast-enhanced portal venous phase CT and one arterial (ART) phase CT, it would also be used to investigate the robustness of our registration method with various contrast phases.

To evaluate the HCC treatment, it was necessary to align the ablative region onto the tumor by transforming the two livers before and after LT. However, it was unreasonable to register some of non-liver organs. It was necessary to segment the liver out and only do registration on livers. After the registration, the optimal transformation can be achieved for the parameters and then they can be used to register the ablative region with LT to the tumor.

Before registration some crucial pre-processing steps were required, including tumor and liver segmentation on the two volumes. We first segmented the preoperative liver and the postoperative liver on the corresponding contrast-enhanced portal-phase CT by using our previous semi-automatic segmentation method [27]. Then, the segmentation result was modified by the medical expert. The tumor and the treated region with LT were both manually segmented. (Fig. 3
                        ) shows the segmentation results for Case 5 and Case 6. The tumor (orange) in preoperative liver (red) and the treated region (blue) in the postoperative liver (yellow) were shown in the 3D coordinate system, respectively. In our work, the liver before LT was used as the fixed image, and the corresponding liver after LT was regarded as the moving image.

The algorithm was run on in a MS-Windows-based personal computer (IntelCoreTM-i7 3770QM 3.40GHz and 16GB-DRAM). The programming environment was coded in C++ language based on ITK [28]. Visualization of the shapes were performed using VTK [29].

To verify the effectiveness of our proposed algorithm, we performed experiments on the registration methods with two criteria metric.

To assess the quality of local warp of the entire medical images in more detail, the intensity differences were calculated for a voxel-by-voxel using the root mean squared error (RMSE).
                              
                                 (10)
                                 
                                    RMSE
                                    (
                                    R
                                    ,
                                    W
                                    )
                                    =
                                    
                                       
                                          
                                             1
                                             
                                                
                                                   I
                                                
                                             
                                          
                                          
                                             
                                                ∑
                                                
                                                   
                                                      
                                                         x
                                                      
                                                   
                                                   ∈
                                                   I
                                                
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            R
                                                            (
                                                            
                                                               
                                                                  x
                                                               
                                                            
                                                            )
                                                            −
                                                            W
                                                            (
                                                            
                                                               
                                                                  x
                                                               
                                                            
                                                            )
                                                         
                                                      
                                                   
                                                   2
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           where I is a three-dimensional discrete interval representing the set of all voxel indexes in the two volumes. For registration of different CT phases, W is normalized to have the same mean with R (W
                           =
                           W
                           ·
                           μ
                           
                              R
                           /μ
                           
                              W
                           , where μ
                           
                              R
                            and μ
                           
                              W
                            are the mean of R and W, respectively).

The distance error of the correspondence landmarks provide a directly measure of the anatomical structure stability as the position of the landmarks change.


                           
                              
                                 (11)
                                 
                                    LDE
                                    (
                                    R
                                    ,
                                    W
                                    )
                                    =
                                    
                                       1
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       ∑
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          
                                             n
                                             L
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  (
                                                                  
                                                                     
                                                                        L
                                                                        
                                                                           
                                                                              r
                                                                           
                                                                        
                                                                     
                                                                  
                                                                  )
                                                               
                                                               i
                                                            
                                                         
                                                         −
                                                         
                                                            
                                                               
                                                                  (
                                                                  
                                                                     
                                                                        L
                                                                        
                                                                           
                                                                              w
                                                                           
                                                                        
                                                                     
                                                                  
                                                                  )
                                                               
                                                               i
                                                            
                                                         
                                                      
                                                   
                                                
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                           where n
                           
                              L
                            represents the number of landmarks.

@&#EVALUATION@&#

To investigate the function of constrained weight, we tested the performance of the algorithm with different weights. The experiential results of one typical real clinical subject was shown in Fig. 4
                           .

As explained in Fig. 2, we defined four pairs of landmarks between before LT and after LT in this paper. One pair was randomly selected for evaluating the accuracy. The remaining landmarks were regarded as the constrained landmarks. Fig. 4(a) shows one landmark applied to constrain the anatomical structure. First, we can observe an important improvement for the LDE values compared with the MI-based non-rigid registration. A significant reduction in LDE values using non-rigid registrations based on MI-LC compared with those based on MI was confirmed. It can be seen the RMSE value to increase accordantly with the reduction of the weight values. Then, it was observed that with smaller weight values, the LDE value will be closer to that of the unconstrained model (MI-based non-rigid registration), as shown in the Fig. 4.

The additional experiments were performed with different weight parameters to assess the capability of our algorithm. Various numbers of landmarks, from 1 to 3 landmarks were applied as structuring constrain term, and the effect on the registration results were studied by using the same one landmark. Fig. 4(a)–(c) shows the effect on the registration results of the number of landmarks in one real subject for the MI-LC criteria. The overall RMSE value was on a slow but steady downward curve. All of the LDE curve were approximated a stretched upward shape, and can be considered to be a classical (MI) non-rigid registration when λ
                           =0. In general, events along a upward LDE (downward RMSE) curve can be compatible with an uninterrupted decrease of the constrained weights along these curves. The curve included points on it, which represented the RMSE/LDE assets.


                           Fig. 5
                            shows the results based on the classical (MI) non-rigid registration and the proposed (MI-LC) non-rigid registration. The tumor (orange) in preoperative volume (red) and the treated region (blue) in the postoperative volume (yellow) were shown in the same coordinate system. The liver transformed by our proposed method looked similar to the registered liver using the classical MI-based non-rigid registration. However, the distance between the fixed landmark and the transformed moving landmark was different. It could be found regardless of how many landmarks applied in our proposed method, a significant reduction in LDE values using registrations based on MI-LC compared with those based on MI was confirmed.

As seen in Fig. 5, all the moving livers were transformed back to the coordinate system of fixed livers by using different registrations. Following the corresponding transformation parameters, the treated region of the moving liver can be also aligned onto the tumor of the fixed liver. Apart from a visual inspection, a quantitative evaluation was also conducted between the structure volume of fixed liver and the transformed structure volume of moving liver. Hence, for Fig. 5(c)–(e), Table 1
                            gives a more detailed view of the corresponding accurate results for our proposed method with λ
                           =0.0001. The results clearly show that our proposed non-rigid registration method had better performance for maintaining the anatomical structure stability.

In order to see the effect on the registration results accuracy when using different number of landmarks for the MI-LC criteria, we have performed independent registration experiments with the same constrained weight λ
                           =0.0001 on 18 sets of CT volumes: 6 sets of the same phases Group-I (PV vs PV), 6 sets of the same phases Group-II (PV vs PV and ART vs ART), 6 sets of the different phases Group-II (PV vs ART and ART vs PV). For each subject, we randomly chose one landmark for evaluating the registration result, and the remaining landmarks were chosen as the constrained landmarks. Considering the number of the manually defined landmarks, we only applied the number of landmarks from 1 to 3 as the structure constrained term.

Average LDE and RMSE with their standard deviation were summarized in Fig. 6
                           . When the number of landmarks is 0, it can be considered to be a classical MI-based non-rigid registration. Improved results were obtained with respect to all criteria with MI-LC compared with MI results. It can be shown that LDE/RMSE improvements with MI-LC with respect to the use of MI in the non-rigid registration. It can be found regardless of how many landmarks were applied in our proposed method, a significant reduction in LDE values using registrations based on MI-LC compared with those based on MI was confirmed. These showed that our method slightly outperforms MI-based registration. Additionally, with the number of landmarks increased, the overall LDE value was on a slow but steady downward curve. Meanwhile, comparison of Fig. 4(a)–(c), indicates that as the number of landmarks increased, the value of constrained weight λ for obtaining an equilibrium state decreased.

To investigate the robustness of our registration method with various contrast phases, we applied our proposed registration method into the Group-II sets. Each CT volume in the Group-II had one contrast-enhanced portal venous (PV) phase image and one arterial (ART) phase image. Regarding to the HCC of the treated region before and after LT, one typical case with PV-phase and ART-phase was shown in Fig. 7
                           . It shows the enhancement of the liver on the PV-phase (Fig. 7(a)) was the hyperintense signal compared with total enhancement on the ART-phase (Fig. 7(b)). Moreover, the lesion was slightly hypointense to the liver on the PV-phase and ART-phase.

In order to observe the effect on the registration results accuracy with different contrast phases, we have performed independent registration experiments on the Group-II data sets with the same constrained weight λ
                           =0.0001 to check the robustness. To quantitatively analyze the robustness of our registration method, the comparison of registration accuracies for same phases and different phases were shown in Tables 2 and 3
                           
                           . We used the same one landmark (the first branch of the portal vein in Fig. 2(c)) to evaluate the registration. As shown in Table 2 and 3, it can be found the registration accuracy (both LDE and RMSE) for different phases were almost identical as the registration of same phases. Experiment results demonstrated our proposed MI-LC method was robust to register the HCC images with various phases.

@&#DISCUSSION@&#

In this paper, a non-rigid method based on MI in combination with anatomical structure has been proposed to assess LT of HCC. Due to MI absence of spatial information, the classical MI-based non-rigid registration potentially could reduce smaller image details or have problems with spatially-varying intensity inhomogeneity. This study is based on a new cost function (MI-LC) for constraining the anatomical structure by adding a landmark penalty term into MI. The proposed cost function successfully overcame the disadvantage of MI-based non-rigid registration.

In our proposed method, the landmarks played an important role in solving the problem about the absence of spatial information for MI-based registration method. Hence, the landmarks should be located where the geometrical features are clearly discernible. From the viewpoint of physics, if the landmark is treated as an elastic material, when the landmarks are not in the optimal positions, the resulting distortion would produce a displacement field. The landmarks in the displacement field carry potential energy. According to the principle of minimum total potential energy, when the landmarks were placed in a common space, they moved and interacted so that the total energy associated with them was minimized and the equilibrium state was reached.

For the MI-LC metric, a landmark penalty term with the weight λ was used to constrain the anatomical structure. Hence, in the experiments, we tested the performance of our algorithm with three aspects. (1) Effect of constrained weight. With the reduction of the weight values, the LDE curve was approximated a upward shape and was closer to that of the unconstrained model (MI-based non-rigid registration). In contrast, RMSE value was on a slow but steady downward curve. (2) Effect of number of landmarks. On the one side, as described in Fig. 6, it can be found regardless of how many landmarks applied in our proposed method, a significant reduction in LDE values using registrations based on MI-LC compared with those based on MI. On the other side, from Fig. 4, the impact of the number of landmarks can be seen. The value of constrained weight λ for reaching the equilibrium state decreases with an increase in the number of landmarks used. (3) Effect of various CT phases. Compared Table 2 with Table 3, our proposed MI-LC method was robust to register the HCC images with various phases.

Moreover, from the field of views on application, our method can be regarded as an automatic 3D imaging fusion technology that assess HCC of the treated region before and after LT. Fusion images enable easier understanding of the relationship between the tumor and ablation region, thus, helping evaluation of the therapeutic efficiency of HCC. This proposed algorithm can predict the local recurrence after LT for HCC.

@&#CONCLUSION@&#

This paper described a new non-rigid registration method for 3D medical image which was inspired by the points of anatomical structure. We extended a classical MI-based non-rigid registration algorithm using an anatomical structure term to constrain the deformation. Our approach can ensure the continuity, accuracy, and smoothness of a medical image. Even though these properties are possible with the existing non-rigid registration method, maintaining the stability and integrality of the anatomical features has been challenging. Experiments showed our proposed method had a good performance. From a practical standpoint, our approach can be applied to evaluate the therapeutic efficiency of LT for HCC.

@&#ACKNOWLEDGEMENTS@&#

This research was supported in part by the Grant-in Aid for Scientific Research from the Japanese Ministry for Education, Science, Culture and Sports (MEXT) under the Grant Nos. 2430076 and 15H01130, in part by the MEXT Support Program for the Strategic Research Foundation at Private Universities (2013–2017), in part by the R-GIRO Research Fund from Ritsumeikan University, in part by National Science and Technology Support Program of China under the Grant No. 2013BAF02B10, and in part by the Recruitment Program of Global Experts (HAIOU Program) from Zhejiang Province, China.


                  Conflict of interest statement: The authors have declared that no conflict of interests exist.

The definition of mutual information (MI) can be presented as:


                     
                        
                           (A.1)
                           
                              
                                 
                                    I
                                    MI
                                 
                              
                              (
                              R
                              ,
                              W
                              )
                              =
                              H
                              (
                              W
                              )
                              +
                              H
                              (
                              R
                              )
                              −
                              H
                              (
                              R
                              ,
                              W
                              )
                           
                        
                     where H(W) and H(R) are the marginal entropy, H(W, R) is the joint entropy. The Shannon marginal and joint entropy are defined as:


                     
                        
                           (A.2)
                           
                              
                                 
                                    
                                       H
                                       (
                                       R
                                       ,
                                       W
                                       )
                                       =
                                       
                                          ∑
                                          
                                             ∀
                                             m
                                          
                                       
                                       
                                          
                                             ∑
                                             
                                                ∀
                                                r
                                             
                                          
                                          
                                             p
                                             (
                                             r
                                             ,
                                             m
                                             ;
                                             μ
                                             )
                                             ·
                                             log
                                             p
                                             (
                                             r
                                             ,
                                             m
                                             ;
                                             μ
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                       H
                                       (
                                       W
                                       )
                                       =
                                       
                                          ∑
                                          
                                             ∀
                                             m
                                          
                                       
                                       
                                          p
                                          (
                                          m
                                          ;
                                          μ
                                          )
                                          ·
                                          log
                                          p
                                          (
                                          m
                                          ;
                                          μ
                                          )
                                       
                                    
                                 
                                 
                                    
                                       H
                                       (
                                       R
                                       )
                                       =
                                       
                                          ∑
                                          
                                             ∀
                                             r
                                          
                                       
                                       
                                          p
                                          (
                                          r
                                          )
                                          ·
                                          log
                                          p
                                          (
                                          r
                                          )
                                       
                                    
                                 
                              
                           
                        
                     
                  

The joint histogram is estimated by the Parzen window method. The joint histogram of two images can be used to estimate a joint probability distribution of their gray values by dividing each entry in the histogram by the total number of entries. Intensities 
                        
                           
                              
                                 
                                    f
                                    w
                                 
                              
                              ,
                              
                                 
                                    f
                                    r
                                 
                              
                           
                        
                      can take values in a continuum in the ranges 
                        (
                        
                           
                              
                                 f
                                 
                                    w
                                    min
                                 
                              
                           
                           ,
                           
                              
                                 f
                                 
                                    w
                                    max
                                 
                              
                           
                        
                        )
                      and (f
                     
                        rmin, f
                     
                        rmax), respectively. Since the intensities of 
                        
                           f
                           w
                        
                      and f
                     
                        r
                      usually have different magnitude and dynamic range, especially for the multi-modal volumes, a linear scaling is used to first normalize the intensities to a common valid range. The discrete joint probability of co-occurring intensities in the overlap of the two images 
                        
                           f
                           w
                        
                      and f
                     
                        r
                      is expressed as:
                        
                           (A.3)
                           
                              p
                              (
                              r
                              ,
                              m
                              ;
                              μ
                              )
                              =
                              α
                              
                                 ∑
                                 
                                    
                                       
                                          x
                                       
                                    
                                    ∈
                                    I
                                 
                              
                              
                                 h
                                 (
                                 m
                                 −
                                 τ
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 ;
                                 μ
                                 )
                                 )
                                 ·
                                 h
                                 (
                                 r
                                 −
                                 σ
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                                 )
                              
                           
                        
                     
                  

The discrete marginal probability distributions for the warped moving and fixed images are defined as:
                        
                           (A.4)
                           
                              p
                              (
                              m
                              ;
                              μ
                              )
                              =
                              α
                              
                                 ∑
                                 
                                    
                                       
                                          x
                                       
                                    
                                    ∈
                                    I
                                 
                              
                              
                                 h
                                 (
                                 m
                                 −
                                 τ
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 ;
                                 μ
                                 )
                                 )
                              
                           
                        
                     
                     
                        
                           (A.5)
                           
                              p
                              (
                              r
                              )
                              =
                              α
                              
                                 ∑
                                 
                                    
                                       
                                          x
                                       
                                    
                                    ∈
                                    I
                                 
                              
                              
                                 h
                                 (
                                 r
                                 −
                                 σ
                                 (
                                 
                                    
                                       x
                                    
                                 
                                 )
                                 )
                              
                           
                        
                     where h() is a kernel function of Parzen windows, α is a coefficient which ensures ∑
                        m
                     ∑
                        r
                     
                     p(m, r
                     ;
                     μ)=1, x
                     ∈
                     I corresponds to a set of sample voxels in the intersection. τ and σ are the moving and fixed images after scaling the continuous interval (0, n
                     
                        binM
                     
                     −1) and (0, n
                     
                        binR
                     
                     −1), respectively:


                     
                        
                           (A.6)
                           
                              
                                 
                                    
                                       τ
                                       (
                                       
                                          
                                             x
                                          
                                       
                                       ;
                                       μ
                                       )
                                       =
                                       (
                                       
                                          
                                             f
                                             w
                                          
                                       
                                       (
                                       
                                          
                                             x
                                          
                                       
                                       ;
                                       μ
                                       )
                                       −
                                       
                                          
                                             f
                                             
                                                w
                                                min
                                             
                                          
                                       
                                       )
                                       ·
                                       
                                          
                                             
                                                
                                                   n
                                                   binM
                                                
                                             
                                             −
                                             1
                                          
                                          
                                             
                                                
                                                   f
                                                   
                                                      w
                                                      max
                                                   
                                                
                                             
                                             −
                                             
                                                
                                                   f
                                                   
                                                      w
                                                      min
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       σ
                                       (
                                       
                                          
                                             x
                                          
                                       
                                       )
                                       =
                                       (
                                       
                                          
                                             f
                                             r
                                          
                                       
                                       (
                                       
                                          
                                             x
                                          
                                       
                                       )
                                       −
                                       
                                          
                                             f
                                             
                                                r
                                                min
                                             
                                          
                                       
                                       )
                                       ·
                                       
                                          
                                             
                                                
                                                   n
                                                   binR
                                                
                                             
                                             −
                                             1
                                          
                                          
                                             
                                                
                                                   f
                                                   
                                                      r
                                                      max
                                                   
                                                
                                             
                                             −
                                             
                                                
                                                   f
                                                   
                                                      r
                                                      min
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                  

@&#REFERENCES@&#

