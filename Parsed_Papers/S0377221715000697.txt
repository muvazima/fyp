@&#MAIN-TITLE@&#Routing a mixed fleet of electric and conventional vehicles

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           E-VRPWTMF optimizes the routes of a mixed fleet of electric and diesel vehicles


                        
                        
                           
                           A realistic energy consumption model with speed, gradient and cargo load is used


                        
                        
                           
                           An efficient and effective Adaptive Large Neighborhood Search algorithm is proposed


                        
                        
                           
                           We design new instances for the E-VRPTWMF


                        
                        
                           
                           The impact of load distribution and different objective functions is investigated


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Electric vehicles

Energy consumption

Vehicle routing

Metaheuristic

Green logistics

@&#ABSTRACT@&#


               
               
                  In this paper, we propose the Electric Vehicle Routing Problem with Time Windows and Mixed Fleet (E-VRPTWMF) to optimize the routing of a mixed fleet of electric commercial vehicles (ECVs) and conventional internal combustion commercial vehicles (ICCVs). Contrary to existing routing models for ECVs, which assume energy consumption to be a linear function of traveled distance, we utilize a realistic energy consumption model that incorporates speed, gradient and cargo load distribution. This is highly relevant in the context of ECVs because energy consumption determines the maximal driving range of ECVs and the recharging times at stations. To address the problem, we develop an Adaptive Large Neighborhood Search algorithm that is enhanced by a local search for intensification. In numerical studies on newly designed E-VRPTWMF test instances, we investigate the effect of considering the actual load distribution on the structure and quality of the generated solutions. Moreover, we study the influence of different objective functions on solution attributes and on the contribution of ECVs to the overall routing costs. Finally, we demonstrate the performance of the developed algorithm on benchmark instances of the related problems VRPTW and E-VRPTW.
               
            

@&#INTRODUCTION@&#

In Europe, recent years have seen a steady increase in energy costs while more and more laws are passed to regulate the emission of greenhouse gases in the transportation sector. These external factors and the society’s rising environmental and social awareness have triggered numerous green initiatives at companies. In the logistics field, electric commercial vehicles (ECVs) are now considered a serious alternative to conventional internal combustion commercial vehicles (ICCVs). ECVs have no local greenhouse gas emission and produce only minimal noise, however, they are currently hardly competitive with ICCVs from a cost point of view (Davis and Figliozzi, 2013). Nevertheless, several companies have started to employ ECVs in their last-mile delivery operations, e.g., in the field of small-package shipping (Kleindorfer, Neboian, Roset, and Spinler, 2012) or the distribution of food (National Renewable Energy Laboratory, 2014) and beverages (Heineken International, 2014). Moreover, governments and private companies are starting to provide the required infrastructure to further boost this electrification trend (International Energy Agency, 2012; 2013; Tesla Motors, Inc., 2014).

One important aspect to render ECVs more competitive is to consider their special characteristics – a limited driving range and the potential need to recharge en route – in the planning of last-mile delivery operations employing ECVs. These distribution tasks are generally represented as vehicle routing problems (VRPs), whose goal is to find minimum-cost routes to serve a given set of customers from a central depot (Toth and Vigo, 2014). The first VRPs to address ECVs (or alternative fuel vehicles) with a limited driving range and the possibility of recharging (refueling) at dedicated stations have recently been presented in the literature (Conrad and Figliozzi, 2011; Erdogan and Miller-Hooks, 2012; Schneider, Stenger, and Goeke, 2014). Although two important constraints of last-mile delivery operations, namely vehicle capacity constraints and customer time windows have already been considered (Conrad and Figliozzi, 2011; Schneider, Stenger, and Goeke, 2014), many relevant real-life constraints are not yet covered by routing models for ECVs and dedicated solution methods.

In this work, we consider two important aspects for route planning with ECVs:

                        
                           
                              Mixed fleet: Most companies do not operate pure ECV fleets but are gradually introducing ECVs into their existing ICCV fleet. Therefore, our route planning method is able to handle a mixed fleet of ECVs and ICCVs. Compared to ICCVs, energy costs for operating ECVs are generally lower while labor costs may increase due to time spent on potentially necessary recharging activities along the routes. Energy and labor costs are among the main components of total operating costs (see, e.g., Bektaş and Laporte, 2011), so high-quality route planning with a mixed vehicle fleet has to consider the cost tradeoff between the two vehicle types.


                              Energy consumption: Real-life energy consumption is not a linear function of traveled distance as assumed in the models of Erdogan and Miller-Hooks (2012) and Schneider, Stenger, and Goeke (2014). We use realistic energy consumption functions of ECVs and ICCVs that incorporate vehicle speed, gradients and cargo load. In recent years, realistic energy consumption models have started to play an important role in routing models that consider fuel costs and vehicle emissions (Bektaş and Laporte, 2011; Jabali, Van Woensel, and de Kok, 2012). In the context of ECVs, energy consumption determines electricity costs on the one hand, but, more importantly, also the driving range of an ECV and thus the latest possible moment at which a recharge has to take place in order to prevent an ECV from getting stranded.

We propose the Electric VRP with Time Windows and Mixed Fleet (E-VRPTWMF) to determine optimal routes (according to different alternative objective functions considered in this work) for a given mixed fleet of ECVs and ICCVs. E-VRPTWMF incorporates time window and vehicle capacity constraints. We assume that ECVs can be recharged at any of the available stations causing a recharging time that depends on the battery level on arrival at the station. The energy consumption of ICCVs is calculated by means of the model presented in Demir, Bektaş, and Laporte (2012) and we extend this model to compute the battery energy consumption of ECVs.

As E-VRPTWMF extends the notoriously hard-to-solve VRPTW, exact methods will not be able to solve instances of realistic size within fast computation times. Therefore, we develop a heuristic solution method to address the problem, namely an Adaptive Large Neighborhood Search (ALNS) enhanced by a Local Search (LS) for intensification. Besides new operators considering recharging stations, our ALNS features several new ideas: (i) an adaptive mechanism to choose the number of customers to be removed in each iteration, (ii) the use of surrogate violations in order to handle the complexity of calculating time window and battery capacity violations, and (iii) an acceptance criterion taking into account the different penalty factors that were used when calculating the objective value of the solutions to be compared.

In numerical studies, we assess the performance of our ALNS on benchmark instances of related problems: ALNS achieves convincing results on the well-studied VRPTW benchmark of Solomon (1987), and outperforms previous methods on the E-VRPTW benchmark set of Schneider, Stenger, and Goeke (2014). In addition, we generate a set of new E-VRPTWMF instances based on the Pollution Routing Problem (PRP) benchmark of Demir et al. (2012). In experiments on these newly designed instances, we find that consideration of the actual load strongly improves the quality of the generated solutions in comparison to solutions that are generated based on load estimates. Moreover, we find that a large number of solutions that are generated with “optimistic” load estimates are actually infeasible due to battery capacity or time window violations. We further show that our ALNS works effectively with all of the investigated cost functions and that the traditional objective of minimizing traveled distance fails to produce high-quality solutions if routing costs including energy, labor and battery depreciation are considered. The choice of objective function additionally has a strong influence on the level of usage of the ECVs in the fleet.

This paper is organized as follows: In Section 2, we briefly review the literature related to E-VRPTWMF. Section 3 introduces the energy consumption models for ECVs and ICCVs. Section 4 presents a mixed-integer program of E-VRPTWMF. The ALNS is detailed in Section 5. The parameter setting, the generation of new E-VRPTWMF instances and the numerical studies on the new instances and on the test instances of related problems are presented in Section 6. Section 7 summarizes and concludes the paper.

In the following, we discuss the literature related to the E-VRPTWMF. First, we review works on routing alternative fuel vehicles. Second, VRP papers that explicitly model energy consumption or account for the impact of load distribution are presented. Third, we discuss other related fields.


                     Conrad and Figliozzi (2011) study the Recharging VRP, in which vehicles with limited range can recharge at certain customer locations. Time window constraints are considered and a fixed recharging time is assumed. The authors compute bounds to predict average tour lengths and study the impact of driving range, recharging times, and time window existence. Erdogan and Miller-Hooks (2012) propose two heuristics for the Green VRP. In this problem, alternative fuel is only available at dedicated points that have to be visited en route. Refueling time is assumed fixed and no capacity or time window constraints are included. Other works addressing the Green VRP or extensions of this problem are (Felipe, Ortuño, Righini, and Tirado, 2014; Montoya, Guéret, Mendoza, and Villegas, 2014; Schneider, Stenger, and Hof, 2014). Schneider, Stenger, and Goeke (2014) develop a hybrid of Variable Neighborhood Search (VNS) and Tabu Search (TS) to address E-VRPTW, in which ECVs with a limited battery capacity may visit recharging stations en route, and customer time windows and vehicle capacities have to be respected. Recharging time is proportional to the amount of energy required to recharge the battery to full capacity. Desaulniers, Errico, Irnich, and Schneider (2014) present branch-price-and-cut algorithms to address four variants of the E-VRPTW. In a recent working paper, Hiermann, Puchinger, and Hartl (2014) combine the E-VRPTW and the Fleet Size and Mix VRP with Fixed costs (FSMF). In the resulting E-FSMVRPTW an unlimited number of ECVs with different battery capacities and vehicle-independent routing costs are available. Cost-optimal routes are determined by means of an ALNS enhanced by a labeling algorithm. Barco, Guerra, Muñoz, and Quijano (2013) propose a comprehensive approach for planning the deployment of electric vehicles in an airport shuttle service. They first determine a minimal consumption graph, on which routing decisions under consideration of a limited battery capacity are made. The assignment of vehicles to routes and the scheduling of recharges is determined by an evolutionary algorithm. Finally, Preis, Frank, and Nachtigall (2014) investigate an ECV routing model with customer time windows, fixed recharging times, and the goal of minimizing total energy consumption, which depends on gradients and cargo load. A simple TS algorithm based on a relocate operator is presented.

The second strand of relevant literature integrates energy considerations and the resulting fuel consumption and emissions of ICCVs into routing models. Bektaş and Laporte (2011) propose the PRP, in which they estimate the price of pollution and introduce it as part of the objective function, besides costs for driver wages and fuel consumption. They allow the choice between different speed levels for arcs and consider speed, gradients, and load to calculate the fuel consumption and corresponding emissions. Demir, Bektaş, and Laporte (2011) provide a comparison of vehicle emission models. Demir et al. (2012) propose an ALNS and a speed optimization algorithm for the PRP. Computational experiments show moderate run-times for problem sizes with 200 customers. Demir, Bektaş, and Laporte (2014a) address a bi-objective function for the PRP that models the conflicting targets of minimizing driver time and usage of fuel and thus avoid the problematic representation of emissions in terms of monetary cost. An extensive review of related literature can be found in Demir, Bektaş, and Laporte (2014b). Kopfer, Schönberger, and Kopfer (2014) use CPLEX to solve a heterogeneous VRP with the objective of minimizing fuel consumption. To this end, the authors derive linear relationships between fuel consumption and cargo load for the different vehicle types.


                     Xiao, Zhao, Kaku, and Xu (2012) calculate a fuel consumption rate depending on the mass of the remaining cargo and they find significant fuel saving potential for the CVRP. Zhang, Tang, and Fung (2011) propose a multi-depot VRP that includes, in the objective function, a cost term that increases linearly with the amount of cargo and the traveled distance and which depends on an empirical cost factor. Another related problem is the fuel or emission shortest-path problem, which may be used to define the arc set of a VRP. Nie and Li (2013) propose such a model to minimize total operating cost while meeting a limit on emissions.

E-VRPTWMF is further related to VRPs with intermediate replenishment facilities (Crevier, Cordeau, and Laporte, 2007; Hemmelmayr, Doerner, Hartl, and Rath, 2013) or with distance constraints (Laporte, Nobert, and Desrochers, 1985) due to the similar structure of the problems, to refueling problems with a dense infrastructure (Bousonville, Hartmann, Melo, and Kopfer, 2011; Suzuki, 2012), to energy shortest path problems (Artmeier, Haselmayr, Leucker, and Sachenbacher, 2010), and in a more general sense to the field of green logistics from an OR perspective (Dekker, Bloemhof, and Mallidis, 2012; Sbihi and Eglese, 2010). Moreover, the planning of electric infrastructure has attracted increasing research interest (He, Wu, Yin, and Guan, 2013; Mak, Rong, and Shen, 2013; Nie and Ghamami, 2013; Wang and Lin, 2013). Finally, Davis and Figliozzi (2013) and Feng and Figliozzi (2013) address the competitiveness of ECVs. Davis and Figliozzi (2013) show that ECVs are competitive in comparison to ICCVs for certain application scenarios with large route distances and low vehicle speeds.

Our VRP model incorporates two specific characteristics of employing ECVs, namely a reduced operating range and the possibility to recharge at certain stations in order to increase this range. The necessity to visit a recharging station and the recharging time at the station depend on the battery level of the ECV, which itself depends on the energy consumption along the route. Previous works on vehicle routing problems with refueling or recharging (Erdogan and Miller-Hooks, 2012; Schneider, Stenger, and Goeke, 2014) assume energy consumption to be a linear function of the traveled distance. In this work, we use a more realistic model and consider the following factors that influence the energy consumption of a vehicle:

                        
                           
                              Vehicle mass: The mass of the vehicle is composed of its curb mass and the load. Concerning the routing of the vehicle, the order in which customers are visited and cargo is unloaded, i.e., the distribution of the load during the course of a route, can strongly influence the energy consumption on the route.


                              Speed: Accelerating a vehicle and keeping the vehicle in motion at a certain speed consumes energy due to the aerodynamic and rolling resistance that has to be overcome. We assume travel speeds to be constant on a each arc, i.e., we neglect acceleration phases, but vehicle speed may be different for different arcs. Note that in principle vehicle speed could be handled as a decision variable and could be increased in order to fulfill time window requirements and be reduced to decrease energy consumption (see, e.g., Demir et al., 2014b). As traffic conditions have a strong impact on vehicle speed, we chose to refrain from this modeling.


                              Gradient of the terrain: We assume a non-flat terrain with grades. Going uphill requires higher amounts of energy than traveling flat terrain or going downhill. ECVs may be able to recharge their battery when going downhill, a process called recuperation.

In the following, we present the methods for determining the energy consumption of ECVs (Section 3.1) and ICCVs (Section 3.2).

We calculate the energy consumption of an ECV in three steps as shown in Fig. 1
                        . First, we determine the mechanical power P
                        M using the model presented in Bektaş and Laporte (2011), which determines energy consumption based on the factors described above (mass, speed, gradient) and the physical environment (road surface, vehicle dimensions, engine properties). Second, P
                        M is translated into the electric power P
                        E that the electric motor needs to provide the required amount of mechanical power. This amount is determined by the efficiency of the electric motor.

Third, the required electric power is converted into the amount of power that has to be taken from the battery (P
                        B), which depends on the battery efficiency. In the following, these three steps are described in more detail.

The mechanical power P
                        M is needed to overcome rolling resistance and aerodynamic resistance and is influenced by the gravitational force. Let m denote the total vehicle mass, g the gravitational constant, c
                        r the rolling friction coefficient (which depends on tire pressure, road surface conditions and other factors) and α the gradient angle. Then the rolling resistance F
                        r can be determined as

                           
                              
                                 
                                    
                                       F
                                       r
                                    
                                    =
                                    
                                       c
                                       r
                                    
                                    ·
                                    m
                                    ·
                                    g
                                    ·
                                    cos
                                    
                                       (
                                       α
                                       )
                                    
                                    .
                                 
                              
                           
                        With ν denoting the speed, c
                        d the aerodynamic drag coefficient, ρ
                        a the air density and A
                        f the frontal area of the vehicle, the aerodynamic resistance is:

                           
                              
                                 
                                    
                                       F
                                       a
                                    
                                    =
                                    
                                       1
                                       2
                                    
                                    ·
                                    
                                       ρ
                                       a
                                    
                                    ·
                                    
                                       A
                                       f
                                    
                                    ·
                                    
                                       c
                                       d
                                    
                                    ·
                                    
                                       ν
                                       2
                                    
                                    .
                                 
                              
                           
                        Adding the gravitational force F
                        g = m · g ·  sin(α), the total mechanical power P
                        M is:

                           
                              (1)
                              
                                 
                                    
                                       
                                          
                                             P
                                             M
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             (
                                             m
                                             ·
                                             a
                                             +
                                             
                                                1
                                                2
                                             
                                             ·
                                             
                                                c
                                                d
                                             
                                             ·
                                             ρ
                                             ·
                                             A
                                             ·
                                             
                                                ν
                                                2
                                             
                                             +
                                             m
                                             ·
                                             g
                                             ·
                                             sin
                                             
                                                (
                                                α
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                c
                                                r
                                             
                                             ·
                                             m
                                             ·
                                             g
                                             ·
                                             cos
                                             
                                                (
                                                α
                                                )
                                             
                                             )
                                             ·
                                             ν
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        where a denotes the acceleration. As mentioned above, a is assumed to be zero in the following as we do not consider acceleration and braking processes.

In the second step, the electric power P
                        E that is needed to achieve the required mechanical power P
                        M is calculated, taking into account energy losses that occur in the electric engine. To this end, we use the Quantized State System (QSS) model of an electric engine presented in (Guzzella and Amstutz, 2005). The authors provide values for the engine efficiency at given pairs of torque and rotational velocity. We directly convert torque and rotational velocity to mechanical power. Using homogeneous regression, i.e. a linear regression with a y-axis intercept of zero, on the converted values, we obtain the following relationship between P
                        M and the discharged electric energy 
                           
                              P
                              E
                              d
                           
                         (respectively the recuperated electric energy 
                           
                              P
                              
                                 E
                              
                              r
                           
                        ) that is described by the regression coefficient ϕ:

                           
                              
                                 
                                    
                                       
                                          
                                             P
                                             
                                                E
                                             
                                             d
                                          
                                       
                                       
                                          
                                             =
                                             
                                                ϕ
                                                d
                                             
                                             ·
                                             
                                                P
                                                M
                                             
                                             
                                             for
                                             
                                          
                                       
                                       
                                          
                                             0
                                             
                                             kilowatts
                                             ≤
                                          
                                       
                                       
                                          
                                             
                                                P
                                                M
                                             
                                             ≤
                                             100
                                             
                                             kilowatts
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             P
                                             E
                                             r
                                          
                                       
                                       
                                          
                                             =
                                             
                                                ϕ
                                                r
                                             
                                             ·
                                             
                                                P
                                                M
                                             
                                             
                                             for
                                             
                                          
                                       
                                       
                                          
                                             −
                                             100
                                             
                                             kilowatts
                                             ≤
                                          
                                       
                                       
                                          
                                             
                                                P
                                                M
                                             
                                             <
                                             0
                                             
                                             kilowatts
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The determined relationship is adequate for a mechanical power demand of up to 100 kilowatts, which we consider a realistic threshold for commonly employed ECV models.

In the third step, we compute the battery power P
                        B that is necessary to obtain the required electric energy P
                        E. For this purpose, we use the relationship for converting electric power P
                        E into battery power P
                        B for a lithium-ion accumulator presented in van Keulen, de Jager, Serrarens, and Steinbuch (2010). The presented relationship does not account for external effects (e.g., the ambient temperature) or the influence of the current charge level of the battery. We approximate the given relation by means of a homogeneous regression and obtain as final equations for discharging (
                           
                              P
                              B
                              d
                           
                        ) and recuperating (
                           
                              P
                              B
                              r
                           
                        )

                           
                              
                                 
                                    
                                       
                                          
                                             P
                                             B
                                             d
                                          
                                       
                                       
                                          
                                             =
                                             
                                                φ
                                                d
                                             
                                             ·
                                             
                                                P
                                                E
                                             
                                             
                                             for
                                             
                                          
                                       
                                       
                                          
                                             
                                                P
                                                E
                                             
                                             ≥
                                             0
                                             
                                             kilowatts
                                          
                                       
                                    
                                    
                                       
                                          
                                             P
                                             B
                                             r
                                          
                                       
                                       
                                          
                                             =
                                             
                                                φ
                                                r
                                             
                                             ·
                                             
                                                P
                                                E
                                             
                                             
                                             for
                                             
                                          
                                       
                                       
                                          
                                             
                                                P
                                                E
                                             
                                             <
                                             0
                                             
                                             kilowatts
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        with the regression coefficient φ that describes the battery efficiency.

To compute energy consumption on a graph, vehicle mass is defined as a function of the currently loaded amount of cargo u, i.e., m(u) = m
                        c + m
                        u · u, where m
                        c is the curb mass of the vehicle and m
                        u the mass of one unit of cargo. Let uj
                         denote the amount of cargo when arriving at customer j (before unloading), i.e., the amount required to fulfill the demand at customer j and all following customers. Further, let Pij
                        (uj
                        ) denote the constant mechanical power demand over the course of an arc (i, j) with a load that is equivalent to the remaining customer demand:

                           
                              
                                 
                                    
                                       P
                                       
                                          i
                                          j
                                       
                                    
                                    
                                       (
                                       
                                          u
                                          j
                                       
                                       )
                                    
                                    =
                                    
                                       (
                                       
                                          1
                                          2
                                       
                                       ·
                                       
                                          c
                                          d
                                       
                                       ·
                                       ρ
                                       ·
                                       A
                                       ·
                                       
                                          ν
                                          2
                                       
                                       +
                                       m
                                       
                                          (
                                          
                                             u
                                             j
                                          
                                          )
                                       
                                       ·
                                       g
                                       ·
                                       
                                          (
                                          sin
                                          
                                             (
                                             
                                                α
                                                
                                                   i
                                                   j
                                                
                                             
                                             )
                                          
                                          +
                                          
                                             c
                                             r
                                          
                                          ·
                                          cos
                                          
                                             (
                                             
                                                α
                                                
                                                   i
                                                   j
                                                
                                             
                                             )
                                          
                                          )
                                       
                                       
                                       )
                                    
                                    ·
                                    
                                       ν
                                       
                                          i
                                          j
                                       
                                    
                                 
                              
                           
                        Then, the battery power demand on this arc is given by P
                        B(P
                        E(Pij
                        (uj
                        )))). Multiplying with the associated travel time tij
                         of the arc yields the electric energy consumption bij
                         for traveling this particular arc:

                           
                              (2)
                              
                                 
                                    
                                       
                                          
                                             
                                                b
                                                
                                                   i
                                                   j
                                                
                                             
                                             
                                                (
                                                
                                                   u
                                                   j
                                                
                                                )
                                             
                                          
                                       
                                       
                                          
                                             =
                                             
                                                {
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ϕ
                                                               d
                                                            
                                                            ·
                                                            
                                                               φ
                                                               d
                                                            
                                                            ·
                                                            
                                                               P
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  j
                                                               
                                                               )
                                                            
                                                            ·
                                                            
                                                               t
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                            if
                                                            
                                                            
                                                               P
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  j
                                                               
                                                               )
                                                            
                                                            ≥
                                                            0
                                                            
                                                            kilowatts
                                                         
                                                      
                                                   
                                                   
                                                      
                                                         
                                                            
                                                               ϕ
                                                               r
                                                            
                                                            ·
                                                            
                                                               φ
                                                               r
                                                            
                                                            ·
                                                            
                                                               P
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  j
                                                               
                                                               )
                                                            
                                                            ·
                                                            
                                                               t
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                            if
                                                            
                                                            
                                                               P
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  j
                                                               
                                                               )
                                                            
                                                            <
                                                            0
                                                            
                                                            kilowatts
                                                            .
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        All variables except the amount of cargo uj
                         are constant for a given arc. Therefore, it is possible to split bij
                        (uj
                        ) into a fixed and a load-dependent part and precompute parts of the expression.

Mechanical power can be directly translated to diesel fuel consumption as shown in Demir et al. (2012). The fuel rate is given by 
                           
                              FR
                              =
                              
                                 ξ
                                 
                                    κ
                                    ·
                                    ψ
                                 
                              
                              
                              
                                 (
                                 k
                                 N
                                 D
                                 
                                 +
                                 
                                 
                                    
                                       P
                                       M
                                    
                                    
                                       η
                                       ·
                                       
                                          η
                                          tf
                                       
                                    
                                 
                                 )
                              
                              ,
                           
                         where P
                        M is the mechanical power as defined in Eq. (1), ξ the fuel-to-air mass ratio, κ the heating value of typical diesel fuel, k the engine friction factor, N the engine speed, D the engine displacement, ψ a factor converting the fuel rate from grams per second to liters per second, η the efficiency parameter for diesel engines and ηtf
                         the drive train efficiency. We assume that driving downhill in gear can reduce the engine consumption down to 0. The constant fuel rate over the course of an arc is given by:

                           
                              
                                 
                                    
                                       FR
                                       
                                          i
                                          j
                                       
                                    
                                    
                                       (
                                       
                                          u
                                          j
                                       
                                       )
                                    
                                    =
                                    max
                                    
                                       (
                                       
                                          ξ
                                          
                                             κ
                                             ·
                                             ψ
                                          
                                       
                                       
                                       
                                          (
                                          kND
                                          
                                          +
                                          
                                          
                                             
                                                
                                                   P
                                                   ij
                                                
                                                
                                                   (
                                                   
                                                      u
                                                      j
                                                   
                                                   )
                                                
                                             
                                             
                                                η
                                                ·
                                                
                                                   η
                                                   tf
                                                
                                             
                                          
                                          )
                                       
                                       ,
                                       0
                                       )
                                    
                                    .
                                 
                              
                           
                        Thus, the fuel consumption of an ICCV traversing an arc (i, j) with cargo uj
                         can be calculated as:

                           
                              (3)
                              
                                 
                                    
                                       f
                                       
                                          i
                                          j
                                       
                                    
                                    
                                       (
                                       
                                          u
                                          j
                                       
                                       )
                                    
                                    =
                                    
                                       t
                                       
                                          i
                                          j
                                       
                                    
                                    ·
                                    
                                       FR
                                       
                                          i
                                          j
                                       
                                    
                                    
                                       (
                                       
                                          u
                                          j
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                        
                     

We define E-VRPTWMF on a complete, directed graph 
                        
                           G
                           =
                           (
                           
                              V
                              
                                 0
                                 ,
                                 N
                                 
                                 +
                                 
                                 1
                              
                              ′
                           
                           ,
                           A
                           )
                        
                     . V = {1, …, N} denotes the set of customers, F the set of recharging stations, F′ the set of visits to vertices in F and V′ denotes the union of V and F′. Vertices 0 and N + 1 denote instances of the depot, and all routes start at 0 and end at N + 1. Inclusion of one or both depot instances is indicated by subscripting the respective set, e.g., the set 
                        
                           V
                           
                              0
                              ,
                              N
                              
                              +
                              
                              1
                           
                           ′
                        
                      contains both instances of the depot. The set of arcs is given by 
                        
                           A
                           =
                           {
                           
                              (
                              i
                              ,
                              j
                              )
                           
                           ∣
                           i
                           ,
                           j
                           ∈
                           
                              V
                              
                                 0
                                 ,
                                 N
                                 
                                 +
                                 
                                 1
                              
                              ′
                           
                           ,
                           i
                           ≠
                           j
                           }
                        
                     .

With each vertex 
                        
                           i
                           ∈
                           
                              V
                              
                                 0
                                 ,
                                 N
                                 
                                 +
                                 
                                 1
                              
                              ′
                           
                           ,
                        
                      we associate a nonnegative demand qi
                      (
                        
                           
                              q
                              i
                           
                           =
                           0
                           ,
                           i
                           ∉
                           V
                        
                     ), a nonnegative service time si
                      (
                        
                           
                              s
                              i
                           
                           =
                           0
                           ,
                           i
                           ∉
                           V
                        
                     ) and a time window [ei, li
                     ], within which service at the customer has to start. Time windows are hard, i.e., starting service late is not allowed but waiting in case of early arrival is possible. The time window [e
                     0, l
                     
                        N + 1] at the depot specifies the scheduling horizon of the problem. Each arc is described by the following properties: distance dij
                     , travel speed νij
                     , travel time tij
                      = dij
                     /νij
                      and a factor αij
                      representing the gradient of the terrain.

A mixed vehicle fleet of fixed size consisting of m
                     E ECVs and m
                     IC ICCVs is positioned at the depot. All vehicles have the same maximal cargo loading capacity Q. On each visit to a recharging station, ECVs are recharged to their maximum battery capacity B. The recharging time depends on the recharging rate r and the difference between B and charge level on arrival at the station. Electricity and fuel consumption of a vehicle traveling an arc are determined by the models introduced in Section 3.

Thus, E-VRPTWMF can be formulated as a (nonlinear) mixed-integer program. For every arc (i, j) ∈ A, we define the following binary decision variables: Variables 
                        
                           x
                           
                              i
                              j
                           
                           E
                        
                      are equal to 1 if an arc (i, j) is traveled by an ECV, variables 
                        
                           x
                           
                              i
                              j
                           
                           IC
                        
                      if the arc is traveled by an ICCV. Otherwise, the decision variables are 0. Variables τi
                      define the arrival time, uj
                      the remaining cargo (before unloading) and yi
                      the remaining charge level on arrival at vertex 
                        
                           i
                           ∈
                           
                              V
                              
                                 0
                                 ,
                                 N
                                 
                                 +
                                 
                                 1
                              
                              ′
                           
                        
                     . Table 1
                      summarizes the variables and parameters of our model.

In this work, we consider three alternative objective functions for E-VRPTWMF:

                        
                           1.
                           Minimize traveled distance f
                              d:

                                 
                                    (4)
                                    
                                       
                                          
                                             f
                                             d
                                          
                                          =
                                          
                                             ∑
                                             
                                                i
                                                ∈
                                                
                                                   V
                                                   0
                                                   ′
                                                
                                                ,
                                                
                                                j
                                                ∈
                                                
                                                   V
                                                   
                                                      N
                                                      +
                                                      1
                                                   
                                                   ′
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             d
                                             
                                                i
                                                j
                                             
                                          
                                          
                                          
                                             (
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             +
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          →
                                          min
                                       
                                    
                                 
                              
                           

Minimize cost f
                              c, consisting of the cost for vehicle propulsion and labor cost. Cost factors c
                              E and c
                              IC denote the cost of electric energy, respective diesel fuel and c
                              D the driver wage per time unit:

                                 
                                    (5)
                                    
                                       
                                          
                                             
                                                
                                                   f
                                                   c
                                                
                                             
                                             
                                                =
                                             
                                             
                                                
                                                   
                                                      ∑
                                                      
                                                         i
                                                         ∈
                                                         
                                                            V
                                                            0
                                                            ′
                                                         
                                                         ,
                                                         
                                                         j
                                                         ∈
                                                         
                                                            V
                                                            
                                                               N
                                                               +
                                                               1
                                                            
                                                            ′
                                                         
                                                         ,
                                                         
                                                         i
                                                         ≠
                                                         j
                                                      
                                                   
                                                   
                                                      [
                                                      
                                                         c
                                                         E
                                                      
                                                      ·
                                                      
                                                         b
                                                         
                                                            i
                                                            j
                                                         
                                                      
                                                      
                                                         (
                                                         
                                                            u
                                                            j
                                                         
                                                         )
                                                      
                                                      ·
                                                      
                                                         x
                                                         
                                                            i
                                                            j
                                                         
                                                         E
                                                      
                                                      +
                                                      
                                                         c
                                                         IC
                                                      
                                                      ·
                                                      
                                                         f
                                                         
                                                            i
                                                            j
                                                         
                                                      
                                                      
                                                         (
                                                         
                                                            u
                                                            j
                                                         
                                                         )
                                                      
                                                      ·
                                                      
                                                         x
                                                         
                                                            i
                                                            j
                                                         
                                                         IC
                                                      
                                                      ]
                                                   
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   +
                                                   
                                                   
                                                      ∑
                                                      
                                                         i
                                                         ∈
                                                         
                                                            V
                                                            ′
                                                         
                                                      
                                                   
                                                   
                                                      c
                                                      D
                                                   
                                                   
                                                   
                                                      (
                                                      
                                                         x
                                                         
                                                            i
                                                            N
                                                            +
                                                            1
                                                         
                                                         E
                                                      
                                                      +
                                                      
                                                         x
                                                         
                                                            i
                                                            N
                                                            +
                                                            1
                                                         
                                                         IC
                                                      
                                                      )
                                                   
                                                   
                                                      (
                                                      
                                                         τ
                                                         i
                                                      
                                                      +
                                                      
                                                         s
                                                         i
                                                      
                                                      +
                                                      
                                                         t
                                                         
                                                            i
                                                            N
                                                            +
                                                            1
                                                         
                                                      
                                                      )
                                                   
                                                   →
                                                   min
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           

Minimize cost including cost for battery replacement f
                              cb. The distance traveled by ECVs is multiplied by a cost factor c
                              B that accounts for the cost of battery replacement. It is expressed as cost per kilometer by dividing acquisition cost by the expected total lifetime mileage.

                                 
                                    (6)
                                    
                                       
                                          
                                             f
                                             cb
                                          
                                          =
                                          
                                             f
                                             c
                                          
                                          +
                                          
                                             ∑
                                             
                                                i
                                                ∈
                                                
                                                   V
                                                   0
                                                   ′
                                                
                                                ,
                                                
                                                j
                                                ∈
                                                
                                                   V
                                                   
                                                      N
                                                      +
                                                      1
                                                   
                                                   ′
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             c
                                             B
                                          
                                          ·
                                          
                                             d
                                             
                                                i
                                                j
                                             
                                          
                                          ·
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          →
                                          min
                                       
                                    
                                 
                              
                           

The constraints of E-VRPTWMF are as follows:

                        
                           (7)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   ′
                                                
                                             
                                          
                                          
                                             (
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             +
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          =
                                          1
                                          
                                          ∀
                                          i
                                          ∈
                                          V
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (8)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   
                                                      N
                                                      +
                                                      1
                                                   
                                                   ′
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          ≤
                                          1
                                          
                                          ∀
                                          i
                                          ∈
                                          
                                             F
                                             ′
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (9)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   
                                                      N
                                                      +
                                                      1
                                                   
                                                   ′
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          −
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   0
                                                   ′
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             x
                                             
                                                j
                                                i
                                             
                                             E
                                          
                                          =
                                          0
                                          
                                          ∀
                                          i
                                          ∈
                                          
                                             V
                                             ′
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (10)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   
                                                      N
                                                      +
                                                      1
                                                   
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             IC
                                          
                                          −
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   0
                                                
                                                ,
                                                
                                                i
                                                ≠
                                                j
                                             
                                          
                                          
                                             x
                                             
                                                j
                                                i
                                             
                                             IC
                                          
                                          =
                                          0
                                          
                                          ∀
                                          i
                                          ∈
                                          V
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (11)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   V
                                                   ′
                                                
                                             
                                          
                                          
                                             x
                                             
                                                0
                                                j
                                             
                                             E
                                          
                                          ≤
                                          
                                             m
                                             E
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (12)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                V
                                             
                                          
                                          
                                             x
                                             
                                                0
                                                j
                                             
                                             IC
                                          
                                          ≤
                                          
                                             m
                                             IC
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (13)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             τ
                                             i
                                          
                                          +
                                          
                                             (
                                             
                                                s
                                                i
                                             
                                             +
                                             
                                                t
                                                
                                                   i
                                                   j
                                                
                                             
                                             )
                                          
                                          
                                          
                                             (
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             +
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          −
                                          
                                             l
                                             0
                                          
                                          
                                          
                                             (
                                             1
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          ≤
                                          
                                             τ
                                             j
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ∀
                                          i
                                          ∈
                                          
                                             V
                                             0
                                          
                                          ,
                                          ∀
                                          j
                                          ∈
                                          
                                             V
                                             
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (14)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             τ
                                             i
                                          
                                          +
                                          
                                             t
                                             
                                                i
                                                j
                                             
                                          
                                          ·
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          +
                                          r
                                          
                                          
                                             (
                                             B
                                             −
                                             
                                                y
                                                i
                                             
                                             )
                                          
                                          
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          −
                                          
                                             (
                                             
                                                l
                                                0
                                             
                                             +
                                             r
                                             B
                                             )
                                          
                                          
                                          
                                             (
                                             1
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             )
                                          
                                          ≤
                                          
                                             τ
                                             j
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ∀
                                          i
                                          ∈
                                          
                                             F
                                             ′
                                          
                                          ,
                                          ∀
                                          j
                                          ∈
                                          
                                             V
                                             
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (15)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             e
                                             i
                                          
                                          ≤
                                          
                                             τ
                                             i
                                          
                                          ≤
                                          
                                             l
                                             i
                                          
                                          
                                          ∀
                                          i
                                          ∈
                                          
                                             V
                                             
                                                0
                                                ,
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (16)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             u
                                             i
                                          
                                          −
                                          
                                             q
                                             i
                                          
                                          
                                          
                                             (
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             +
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          +
                                          Q
                                          
                                          
                                             (
                                             1
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                IC
                                             
                                             )
                                          
                                          ≥
                                          
                                             u
                                             j
                                          
                                          ≥
                                          0
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ∀
                                          i
                                          ∈
                                          
                                             V
                                             0
                                             ′
                                          
                                          ,
                                          ∀
                                          j
                                          ∈
                                          
                                             V
                                             
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (17)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          0
                                          ≤
                                          
                                             u
                                             0
                                          
                                          ≤
                                          Q
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (18)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             y
                                             i
                                          
                                          −
                                          
                                             b
                                             
                                                i
                                                j
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                          ·
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          +
                                          B
                                          
                                          
                                             (
                                             1
                                             −
                                             
                                                x
                                                
                                                   i
                                                   j
                                                
                                                E
                                             
                                             )
                                          
                                          ≥
                                          
                                             y
                                             j
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ∀
                                          i
                                          ∈
                                          V
                                          ,
                                          
                                          ∀
                                          j
                                          ∈
                                          
                                             V
                                             
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (19)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          B
                                          −
                                          
                                             b
                                             
                                                i
                                                j
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                          ·
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          ≥
                                          
                                             y
                                             j
                                          
                                          
                                          ∀
                                          i
                                          ∈
                                          
                                             F
                                             0
                                             ′
                                          
                                          ,
                                          ∀
                                          j
                                          ∈
                                          
                                             V
                                             
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (20)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          B
                                          ≥
                                          
                                             y
                                             i
                                          
                                          ≥
                                          0
                                          
                                          ∀
                                          i
                                          ∈
                                          
                                             V
                                             
                                                0
                                                ,
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (21)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             E
                                          
                                          ,
                                          
                                             x
                                             
                                                i
                                                j
                                             
                                             IC
                                          
                                          ∈
                                          
                                             {
                                             0
                                             ,
                                             1
                                             }
                                          
                                          
                                          ∀
                                          i
                                          ,
                                          j
                                          ∈
                                          
                                             V
                                             
                                                0
                                                ,
                                                N
                                                +
                                                1
                                             
                                             ′
                                          
                                          ,
                                          i
                                          ≠
                                          j
                                       
                                    
                                 
                              
                           
                        
                     
                  

Constraints (7) enforce that each customer visit has exactly one successor. Constraints (8) guarantee that each visit to a recharging station is used at most once, i.e., not all recharging visit vertices must be used. Flow conservation constraints (9) and (10) guarantee for each vertex that the number of incoming arcs is equal to the number of outgoing arcs for each vehicle type. Constraints (11) and (12) ensure that the maximum number of employed vehicles adheres to the fleet composition. Constraints (13) and (14) link arrival times at vertices i and j if the arc from i to j is traveled. Constraints (14) covers the case with recharging visits: Here, recharging times that depend on the remaining charge level yi
                      when arriving at station i have to be taken into account. Constraints (15) guarantee arrival within the time window at each vertex. Constraints (16) enforce the fulfillment of demand at customer vertices. Constraint (17) restricts the initial cargo load level to the maximum capacity of a vehicle.

Constraints (18) set the battery level at a vertex succeeding a customer visit in accordance with the energy consumption for discharging or recuperating. For vertices succeeding a visit to a recharging station or the depot, Constraints (19) set the battery level equal to the maximum battery capacity reduced by the energy required on the respective arc. Here, the battery is either discharged or recuperation takes place. Constraints (20) restricts the charge level to the maximum battery capacity in order to prevent recuperation beyond the maximal capacity. Finally, binary decision variables are defined in constraints (21).

Although our model covers several real-world aspects of ECVs, we still use some simplifications. Gradient and speed are considered fixed over the course of an arc. However, a more fine-grained topology and acceleration patterns can be integrated, e.g., by considering a path p(i, j) instead of the arc (i, j). A path p(i, j) is defined by a fixed sequence of n(i, j) + 1 intermediate vertices (v
                     0 = i, v
                     1, …, v
                     
                        n(i, j) − 1, v
                     
                        n(i, j) = j) located on arc (i, j), where each of the vertices marks a change in gradient or acceleration. Let A(p(i, j)) denote the arcs of path p. Now, we can use the energy consumption function for ECVs in Eq. (2) to calculate the energy consumption on each arc a ∈ A(p(i, j)) of the path p:

                        
                           
                              
                                 
                                    
                                       
                                          
                                             b
                                             a
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                       
                                    
                                    
                                       
                                          =
                                          
                                             P
                                             a
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                          ·
                                          
                                             t
                                             a
                                          
                                          ·
                                          
                                             {
                                             
                                                
                                                   
                                                      
                                                         
                                                            ϕ
                                                            d
                                                         
                                                         ·
                                                         
                                                            φ
                                                            d
                                                         
                                                      
                                                   
                                                   
                                                      
                                                         
                                                         if
                                                         
                                                         
                                                            P
                                                            a
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         ≥
                                                         0
                                                         
                                                         kilowatts
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            ϕ
                                                            r
                                                         
                                                         ·
                                                         
                                                            φ
                                                            r
                                                         
                                                      
                                                   
                                                   
                                                      
                                                         
                                                         if
                                                         
                                                         
                                                            P
                                                            a
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         <
                                                         0
                                                         
                                                         kilowatts
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     Now, given the energy consumptions on each arc of path p(i, j), we can recursively define the energy consumption on arc (i, j) taking into account that (i) recuperation is restricted by the total battery capacity, and (ii) that we are not allowed to have a negative remaining battery level at any point traveling p. To do so, we let 
                        
                           y
                           
                              v
                              k
                           
                        
                      denote the battery level at each intermediate vertex vk
                      and define:

                        
                           
                              
                                 
                                    
                                       
                                          
                                             y
                                             
                                                v
                                                0
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                       
                                    
                                    
                                       
                                          =
                                          
                                             y
                                             i
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             y
                                             
                                                v
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                       
                                    
                                    
                                       
                                          =
                                          
                                          
                                             {
                                             
                                                
                                                   
                                                      
                                                         min
                                                         (
                                                         
                                                            y
                                                            
                                                               v
                                                               
                                                                  k
                                                                  −
                                                                  1
                                                               
                                                            
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         −
                                                         
                                                            b
                                                            
                                                               
                                                                  v
                                                                  
                                                                     k
                                                                     −
                                                                     1
                                                                  
                                                               
                                                               
                                                                  v
                                                                  k
                                                               
                                                            
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         ,
                                                         B
                                                         )
                                                      
                                                   
                                                   
                                                      
                                                         
                                                         if
                                                         
                                                         
                                                            y
                                                            
                                                               v
                                                               
                                                                  k
                                                                  −
                                                                  1
                                                               
                                                            
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         −
                                                         
                                                            b
                                                            
                                                               
                                                                  v
                                                                  
                                                                     k
                                                                     −
                                                                     1
                                                                  
                                                               
                                                               
                                                                  v
                                                                  k
                                                               
                                                            
                                                         
                                                         
                                                            (
                                                            
                                                               u
                                                               j
                                                            
                                                            )
                                                         
                                                         ≥
                                                         0
                                                      
                                                   
                                                
                                                
                                                   
                                                   
                                                      
                                                         
                                                         
                                                         
                                                         k
                                                         =
                                                         1
                                                         ,
                                                         …
                                                         ,
                                                         n
                                                         (
                                                         i
                                                         ,
                                                         j
                                                         )
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         −
                                                         ∞
                                                      
                                                   
                                                   
                                                      
                                                         
                                                         
                                                         else
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             b
                                             
                                                i
                                                j
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                       
                                    
                                    
                                       
                                          =
                                          
                                             y
                                             
                                                v
                                                0
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                          −
                                          
                                             y
                                             
                                                v
                                                
                                                   n
                                                   (
                                                   i
                                                   ,
                                                   j
                                                   )
                                                
                                             
                                          
                                          
                                             (
                                             
                                                u
                                                j
                                             
                                             )
                                          
                                       
                                    
                                 
                              
                           
                        
                     The original Eq. (3) for calculating the fuel consumption of ICCVs can be adapted in analogous fashion. In this way, the energy consumption on an arc (i, j) is defined by means of the energy consumptions on the path p(i, j), which can be used to represent gradients and accelerations in an arbitrarily fine-grained fashion.

Our model uses additional simplifications. We neglect the influence of outside temperatures on battery capacity. A related issue is the need to power the car heating, which requires additional energy in contrast to ICCVs, for which the waste heat is sufficient to ensure a comfortable temperature in the driver cabin. Further, we neither consider the dependency between charge level and battery efficiency (Hoke, Brissette, Maksimovic, Pratt, and Smith, 2011), nor the non-linear relationship between charge level and recharging duration (Marra et al., 2012), which are present in real-world recharging processes.

This section details our ALNS for addressing E-VRPTWMF. LNS, originally introduced by Shaw (1998), iteratively destroys and repairs potentially larger parts of an initial solution in order to gradually improve the solution. Ropke and Pisinger (2006a) proposed Adaptive LNS, an approach that uses several destroy and repair methods and selects the operators in each iteration based on a probability that depends on the previous success of the respective method.

Our ALNS is inspired by the work of Ropke and Pisinger (2006a) but differs regarding several aspects. First, most ALNS implementations operate on feasible solutions (see, e.g., Ropke and Pisinger, 2006b; 2006a; Demir et al., 2012) and do not reinsert removed customers if their insertion leads to a constraint violation. Contrary to this, we always insert all removed customers in each ALNS step and handle the resulting infeasible solutions by means of a penalty mechanism (cp.  Hemmelmayr, Cordeau, and Crainic, 2012; Dayarian, Crainic, Gendreau, and Rei, 2013). Second, we select the number of customers for removal from dynamically changing intervals. Third, our ALNS features a local search component, which is used for intensification, while the main purpose of the ALNS component is the diversification of search. Finally, we introduce a new mechanism for the acceptance decision of the ALNS, where solutions with objective function values calculated based on different penalty factors are compared.


                     Fig. 2
                      shows a pseudocode overview of our solution method. First, a preprocessing step is applied to determine arcs that cannot be part of a feasible solution (Section 5.1). Next, we generate an initial solution S with a given number of ECVs and ICCVs (Section 5.3). The initial solution and solutions in the improvement phase may be infeasible and are handled through a penalty mechanism (Section 5.2). ALNS and LS are iteratively applied to improve the solution (Section 5.4).

In the preprocessing step, we remove all arcs that cannot be part of a feasible solution, i.e., their inclusion leads to a constraint violation. An arc (v, w) is infeasible if one of the following conditions holds:

                           
                              1.
                              
                                 v, w ∈ V∧qv
                                  + qw
                                  > Q
                              


                                 
                                    
                                       v
                                       ∈
                                       
                                          V
                                          0
                                          ′
                                       
                                       ,
                                       w
                                       ∈
                                       
                                          V
                                          
                                             N
                                             +
                                             1
                                          
                                          ′
                                       
                                       ∧
                                       
                                          e
                                          v
                                       
                                       +
                                       
                                          s
                                          v
                                       
                                       +
                                       
                                          t
                                          
                                             v
                                             w
                                          
                                       
                                       >
                                       
                                          l
                                          w
                                       
                                    
                                 
                              


                                 
                                    
                                       v
                                       ∈
                                       
                                          V
                                          0
                                          ′
                                       
                                       ,
                                       w
                                       ∈
                                       
                                          V
                                          ′
                                       
                                       ∧
                                       
                                          e
                                          v
                                       
                                       +
                                       
                                          s
                                          v
                                       
                                       +
                                       
                                          t
                                          
                                             v
                                             w
                                          
                                       
                                       +
                                       
                                          s
                                          w
                                       
                                       +
                                       
                                          t
                                          
                                             w
                                             N
                                             +
                                             1
                                          
                                       
                                       >
                                       
                                          l
                                          0
                                       
                                    
                                 
                              


                                 
                                    
                                       v
                                       ∈
                                       
                                          V
                                          0
                                          ′
                                       
                                       ,
                                       w
                                       ∈
                                       
                                          V
                                          ′
                                       
                                       ∧
                                       
                                          α
                                          
                                             v
                                             w
                                          
                                       
                                       ≥
                                       0
                                       ∧
                                       
                                          b
                                          
                                             v
                                             w
                                          
                                       
                                       
                                          (
                                          
                                             q
                                             w
                                          
                                          )
                                       
                                       >
                                       B
                                    
                                 
                              


                                 
                                    
                                       v
                                       ∈
                                       
                                          V
                                          0
                                          ′
                                       
                                       ,
                                       w
                                       ∈
                                       
                                          V
                                          ′
                                       
                                       ∧
                                       ∀
                                       j
                                       ∈
                                       
                                          F
                                          0
                                          ′
                                       
                                       ,
                                       i
                                       ∈
                                       
                                          F
                                          
                                             N
                                             +
                                             1
                                          
                                          ′
                                       
                                       
                                       :
                                       
                                          α
                                          
                                             j
                                             v
                                          
                                       
                                       ,
                                       
                                          α
                                          
                                             v
                                             w
                                          
                                       
                                       ,
                                       
                                          α
                                          
                                             w
                                             i
                                          
                                       
                                       ≥
                                       0
                                       ∧
                                       
                                          b
                                          
                                             j
                                             v
                                          
                                       
                                       
                                          (
                                          
                                             q
                                             v
                                          
                                          +
                                          
                                             q
                                             w
                                          
                                          )
                                       
                                       +
                                       
                                          b
                                          
                                             v
                                             w
                                          
                                       
                                       
                                          (
                                          
                                             q
                                             w
                                          
                                          )
                                       
                                       +
                                       
                                          b
                                          
                                             w
                                             i
                                          
                                       
                                       
                                          (
                                          0
                                          )
                                       
                                       >
                                       B
                                    
                                 
                              

Rules 1–3 eliminate arcs because of capacity and time window violations (cp. Schneider, Stenger, and Goeke, 2014). Rules 4 and 5 are specific to E-VRPTWMF and only hold for ECV routes. Rule 4 determines those arcs that cannot be traveled without violating battery capacities, even if only the demand qw
                         has to be transported on the arc. Note that a gradient αvw
                         ≥ 0 is necessary as otherwise recuperation might render the considered arc feasible. Rule 5 additionally considers visits to the best possible recharging station before and after the arc. Note that Rule 4 is not contained in Rule 5 as we have to make the additional assumption that all involved gradients αjv, αwi
                         are greater or equal to zero.

As Rules 4 and 5 are only valid for ECV routes, we keep two separate reduced arc sets: The set A
                        − contains all arcs that are feasible for ICCVs. The set 
                           
                              
                                 A
                                 E
                                 −
                              
                              ⊆
                              
                                 A
                                 −
                              
                           
                         excludes arcs that are not feasible in ECV routes.

During the search, we allow infeasible solutions in order to be more flexible in traversing the solution space. The objective function of a solution S is computed by a generalized cost function f
                        gen(S) (see, e.g., Gendreau, Hertz, and Laporte, 1994):

                           
                              
                                 
                                    
                                       f
                                       gen
                                    
                                    
                                       (
                                       S
                                       )
                                    
                                    =
                                    f
                                    
                                       (
                                       S
                                       )
                                    
                                    +
                                    
                                       γ
                                       cap
                                    
                                    ·
                                    
                                       L
                                       cap
                                    
                                    
                                       (
                                       S
                                       )
                                    
                                    +
                                    
                                       γ
                                       tw
                                    
                                    ·
                                    
                                       L
                                       tw
                                    
                                    
                                       (
                                       S
                                       )
                                    
                                    +
                                    
                                       γ
                                       batt
                                    
                                    ·
                                    
                                       L
                                       batt
                                    
                                    
                                       (
                                       S
                                       )
                                    
                                    .
                                 
                              
                           
                        
                        f(S) denotes the considered objective function: total traveled distance f
                        d(S) (Eq. 4), routing costs without battery deprecation f
                        c(S) (Eq. 5), or routing costs including battery deprecation f
                        cb(S) (Eq. 6). Violations of capacity L
                        cap(S), time windows L
                        tw(S) and battery capacity L
                        batt(S) are scaled by penalty factors γ
                        cap, γ
                        tw and γ
                        batt.

The penalty factors are dynamically adjusted as follows: If a constraint has been violated for βpen
                         iterations, the respective penalty factor is multiplied by a factor ϱ to guide the search towards feasibility. In analogous manner, the respective penalty factor is divided by ϱ if the constraint is met for β
                        pen iterations. The penalty factors are initially set to 
                           
                              
                                 γ
                                 cap
                                 0
                              
                              =
                              
                                 γ
                                 tw
                                 0
                              
                              =
                              
                                 γ
                                 batt
                                 0
                              
                              =
                              100
                           
                         and are restricted to the intervals 
                           
                              [
                              
                                 γ
                                 cap
                                 min
                              
                              ,
                              
                                 γ
                                 cap
                                 max
                              
                              ]
                              ,
                           
                        
                        
                           
                              [
                              
                                 γ
                                 tw
                                 min
                              
                              ,
                              
                                 γ
                                 tw
                                 max
                              
                              ]
                           
                         and 
                           
                              [
                              
                                 γ
                                 batt
                                 min
                              
                              ,
                              
                                 γ
                                 batt
                                 max
                              
                              ]
                           
                         respectively. In order to scale the penalty factors to the problem setting and the order of magnitude of the objective function value, we set 
                           
                              
                                 γ
                                 cap
                                 max
                              
                              ,
                           
                        
                        
                           
                              γ
                              tw
                              max
                           
                         and 
                           
                              γ
                              batt
                              max
                           
                         to the objective function value of the initial solution. The lower limits 
                           
                              
                                 γ
                                 cap
                                 min
                              
                              ,
                           
                        
                        
                           
                              γ
                              tw
                              min
                           
                         and 
                           
                              γ
                              batt
                              min
                           
                         are set to 0.5.

The efficient calculation of changes in constraint violations caused by an LS move is crucial for the quality of our algorithm. Vehicle capacity violations are not affected by the energy consumption model considered in this paper and therefore changes in capacity violations can be calculated in constant time as described in Kindervater and Savelsbergh (1997). However, the considered energy consumption model influences the calculation of changes in battery capacity and time window violations for ECV routes. ICCV routes are also affected if the objective functions f
                        cb or f
                        c are used.

Let a sequence of customers 〈v
                        0, v
                        1, … , vn, v
                        
                           n + 1〉, with v
                        0 and v
                        
                           n + 1 representing the depot, define a route r. A solution S is defined as the union of the set of ECV routes S
                        E = {rk, k = 1, … , m
                        E} and the set of ICCV routes S
                        IC = {rk, k = m
                        E + 1, … , m
                        E + m
                        IC}, i.e., 
                           
                              S
                              =
                              
                                 S
                                 E
                              
                              ⋃
                              
                                 S
                                 IC
                              
                           
                        . Let Vert(r) denote the set of vertices that are part of route r.

We are interested in the constraint violations of a route that is constructed by concatenating two partial routes 〈v
                        0, …, u〉 and 〈w, …, v
                        
                           n + 1〉 or by inserting a vertex v between the two partial routes. To calculate battery capacity violations of ECV routes, we define the following two variables for each vertex of a route r: 
                           
                              Υ
                              
                                 v
                                 i
                              
                              →
                           
                         is the battery charge that is needed to travel either from the previous visit to a recharging station or from the depot (in case no recharging visit is part of the route) to vertex vi
                        . 
                           
                              Υ
                              
                                 v
                                 i
                              
                              ←
                           
                         is the battery charge that is needed to travel from vi
                         to either the next recharging station or the depot. The variables are calculated as follows:

                           
                              
                                 
                                    
                                       
                                          
                                             Υ
                                             
                                                v
                                                i
                                             
                                             →
                                          
                                       
                                       
                                          
                                             =
                                             
                                                {
                                                
                                                   
                                                      
                                                         
                                                            max
                                                            (
                                                            
                                                               b
                                                               
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        −
                                                                        1
                                                                     
                                                                  
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                               
                                                               )
                                                            
                                                            ,
                                                            0
                                                            )
                                                         
                                                      
                                                      
                                                         
                                                            
                                                            
                                                            if
                                                            
                                                            
                                                               v
                                                               
                                                                  i
                                                                  −
                                                                  1
                                                               
                                                            
                                                            ∈
                                                            
                                                               F
                                                               
                                                                  0
                                                               
                                                               ′
                                                            
                                                         
                                                      
                                                   
                                                   
                                                      
                                                      
                                                         
                                                            
                                                            
                                                            
                                                            i
                                                            =
                                                            1
                                                            ,
                                                            …
                                                            ,
                                                            n
                                                            +
                                                            1
                                                         
                                                      
                                                   
                                                   
                                                      
                                                         
                                                            max
                                                            (
                                                            
                                                               Υ
                                                               
                                                                  v
                                                                  
                                                                     i
                                                                     −
                                                                     1
                                                                  
                                                               
                                                               →
                                                            
                                                            +
                                                            
                                                               b
                                                               
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        −
                                                                        1
                                                                     
                                                                  
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                               
                                                               )
                                                            
                                                            ,
                                                            0
                                                            )
                                                         
                                                      
                                                      
                                                         
                                                            
                                                            
                                                            if
                                                            
                                                            
                                                               v
                                                               
                                                                  i
                                                                  −
                                                                  1
                                                               
                                                            
                                                            ∉
                                                            
                                                               F
                                                               
                                                                  0
                                                               
                                                               ′
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                          
                                             Υ
                                             
                                                v
                                                i
                                             
                                             ←
                                          
                                       
                                       
                                          
                                             =
                                             
                                                {
                                                
                                                   
                                                      
                                                         
                                                            max
                                                            (
                                                            
                                                               b
                                                               
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        +
                                                                        1
                                                                     
                                                                  
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        +
                                                                        1
                                                                     
                                                                  
                                                               
                                                               )
                                                            
                                                            ,
                                                            0
                                                            )
                                                         
                                                      
                                                      
                                                         
                                                            if
                                                            
                                                            
                                                               v
                                                               
                                                                  i
                                                                  +
                                                                  1
                                                               
                                                            
                                                            ∈
                                                            
                                                               F
                                                               
                                                                  n
                                                                  +
                                                                  1
                                                               
                                                               ′
                                                            
                                                         
                                                      
                                                   
                                                   
                                                      
                                                      
                                                         
                                                            
                                                            
                                                            
                                                            i
                                                            =
                                                            0
                                                            ,
                                                            …
                                                            ,
                                                            n
                                                            .
                                                         
                                                      
                                                   
                                                   
                                                      
                                                         
                                                            max
                                                            (
                                                            
                                                               Υ
                                                               
                                                                  v
                                                                  
                                                                     i
                                                                     +
                                                                     1
                                                                  
                                                               
                                                               ←
                                                            
                                                            +
                                                            
                                                               b
                                                               
                                                                  
                                                                     v
                                                                     i
                                                                  
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        +
                                                                        1
                                                                     
                                                                  
                                                               
                                                            
                                                            
                                                               (
                                                               
                                                                  u
                                                                  
                                                                     v
                                                                     
                                                                        i
                                                                        +
                                                                        1
                                                                     
                                                                  
                                                               
                                                               )
                                                            
                                                            ,
                                                            0
                                                            )
                                                         
                                                      
                                                      
                                                         
                                                            if
                                                            
                                                            
                                                               v
                                                               
                                                                  i
                                                                  +
                                                                  1
                                                               
                                                            
                                                            ∉
                                                            
                                                               F
                                                               
                                                                  n
                                                                  +
                                                                  1
                                                               
                                                               ′
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        The battery capacity violation of a solution S can be calculated by summing up the individual violations at every visit to a recharging station and on return to the depot:

                           
                              
                                 
                                    
                                       L
                                       batt
                                    
                                    
                                       (
                                       S
                                       )
                                    
                                    =
                                    
                                       ∑
                                       
                                          
                                             r
                                             k
                                          
                                          ∈
                                          
                                             S
                                             E
                                          
                                       
                                    
                                    
                                       (
                                       
                                          ∑
                                          
                                             
                                                v
                                                i
                                             
                                             ∈
                                             Vert
                                             
                                                (
                                                
                                                   r
                                                   k
                                                
                                                )
                                             
                                             ∩
                                             
                                                F
                                                
                                                   N
                                                   +
                                                   1
                                                
                                                ′
                                             
                                          
                                       
                                       
                                          max
                                          
                                          (
                                          
                                             Υ
                                             
                                                v
                                                i
                                             
                                             →
                                          
                                          −
                                          B
                                          ,
                                          0
                                          )
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                        
                     

If energy consumption is independent of cargo load, changes in battery capacity violation can be calculated in 
                           
                              O
                              (
                              1
                              )
                           
                         for conventional neighborhood operators (see Schneider, Stenger, and Goeke, 2014). If load is considered, concatenation of partial routes or inserting a customer vertex between partial routes alter the energy consumption of all arcs preceding the point of route concatenation or vertex insertion. Thus, individual battery capacity violations at each recharging visit before and the next visit directly after the point of change are modified and therefore necessitate a recalculation. To lower the computational burden, we substitute a surrogate violation 
                           
                              
                                 
                                    L
                                    ˜
                                 
                                 batt
                              
                              
                                 (
                                 S
                                 )
                              
                           
                         for the real battery capacity violation L
                        batt(S). The surrogate assumes that violations at the preceding recharging visits remain unmodified. In this way, we are able to compute surrogates of the battery capacity violations in 
                           
                              O
                              (
                              1
                              )
                           
                        . Note that the insertion of a recharging station can be handled in constant time without using surrogates.

Time window violations are calculated based on the principle of time travel described in Nagata, Bräysy, and Dullaert (2010); Schneider, Sand, and Stenger (2013), which allows to compute the change in time window violation for conventional inter-route moves in 
                           
                              O
                              (
                              1
                              )
                           
                        . In short, the violation of a time window is counted once at the vertex v where the violation occurs and for the calculation of consecutive violations the vehicle is assumed to start service at the latest feasible moment lv
                        . Schneider, Stenger, and Goeke (2014) adapt this principle to the E-VRPTW. Here, if the partial route 〈w, …, v
                        
                           n + 1〉 contains a recharging station z, i.e., 〈w, …, z, z + 1, …, v
                        
                           n + 1〉, variables have to be recalculated for 〈v, …, z + 1〉 in case of vertex insertion and for 〈w, …, z + 1〉 for route concatenation.

In case of the E-VRPTWMF, for both vertex insertion and route concatenation, a recalculation from the beginning of the route to the first recharging station contained in the second partial route, i.e., of the partial route 〈v
                        0, …, z + 1〉, becomes necessary. This is because the amount of required energy (affected by the change in mass along the route as explained above) is needed to calculate recharging times. We again use a surrogate 
                           
                              
                                 
                                    L
                                    ˜
                                 
                                 tw
                              
                              
                                 (
                                 S
                                 )
                              
                           
                         to reduce computational effort and assume time window violations of vertices preceding the point of change to remain unmodified.

The generalized cost function using surrogates for both battery capacity violation and time window violation is denoted as 
                           
                              
                                 f
                                 ˜
                              
                              gen
                           
                        .

We generate an initial solution with m = m
                        E + m
                        IC. First, we build m ECV routes, of which m
                        IC routes are later converted to ICCV routes. Each route is initialized with a seed customer. The seed customers are determined by first sorting the customers in ascending order of their latest start time of service lv
                         and then selecting the first m entries. The remaining customers in the list are successively inserted into the existing routes at the cost-minimal position according to the generalized cost function f
                        gen(S). As soon as a route becomes battery capacity infeasible, recharging visits are added at cost-minimal positions (according to f
                        gen(S)) until the route again becomes battery feasible.

After all customers are inserted into routes, we convert long routes with strong constraint violations to ICCV routes by removing recharging visits. More precisely, we sort the routes in descending order of their contribution to the generalized cost function and select the first m
                        IC entries for conversion.

The steps of the solution improvement phase are shown in Fig. 2. First, we select the number of customers to be removed in the ALNS step. This number is commonly defined as percentage of the overall number of customers N and is usually drawn from a given interval [Ω
                        
                           min
                        , Ω
                        max]. In preliminary studies, we found that the size of this interval influences the quality of the solution and that a good choice for the interval is instance-dependent. Therefore, we use an adaptive mechanism to select promising intervals (in analogous fashion to the selection of destroy and repair operators). To this end, we split the original interval in ω subintervals without overlap. ALNS then chooses a subinterval according to the probabilities 
                           
                              
                                 π
                                 i
                                 ∥
                              
                              ,
                              
                              i
                              =
                              1
                              ,
                              …
                              
                              ,
                              ω
                           
                        . From the subinterval, we draw a random number δ of customers and/or stations. Afterwards, we consecutively apply a destroy and repair operator (Section 5.4.1).

The resulting solution is improved by an LS step (Section 5.4.2), which determines a locally optimal solution S′ using dynamic penalties as described in Section 5.2. Solution acceptance is based on a Simulated Annealing (SA) criterion (Section 5.4.3). Finally, selection probabilities of the destroy and repair operators, and of the intervals for the numbers of customers to remove are adjusted (Section 5.4.4). To find a feasible solution, the search is run for at most βfeas
                         iterations. After a feasible solution is found, the search continues for another βobj
                         to improve the solution.

Our ALNS uses the following destroy operators:

                              
                                 
                                    Random removal removes arbitrary vertices. We implement two versions, the first only removes customers, the second removes customers and recharging visits.


                                    Worst removal was introduced by Ropke and Pisinger (2006b) and aims at removing vertices that are unfavorable at their current position in a route. We sort all vertices in descending order of their contribution to the cost of the current solution, which is determined as the change in 
                                       
                                          
                                             f
                                             ˜
                                          
                                          gen
                                       
                                     that is caused by removing the respective vertex. From this list the vertex at position 
                                       
                                          ⌊
                                          D
                                          ·
                                          
                                             b
                                             
                                                χ
                                                worst
                                             
                                          
                                          ⌋
                                       
                                     is chosen, where D is the size of the list, b is a uniform random number ∈ [0, 1] and χ
                                    worst a parameter to weight the impact that the change in objective value has on the selection. Again a version considering customers and a version considering customers and recharging visits is implemented.


                                    Shaw removal was introduced in Shaw (1997). The idea is to remove customers that are similar to each other with respect to several criteria and are thus likely to be interchangeable. We define the relatedness between two customers i and j by geographical distance dij
                                    , difference in demand |qi
                                     − qj
                                    | and difference of the earliest start time of service |ei
                                     − ej
                                    |. Each criterion is weighted with a parameter χ and normalized. The relatedness can be calculated as:

                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         R
                                                         (
                                                         i
                                                         ,
                                                         j
                                                         )
                                                      
                                                   
                                                   
                                                      =
                                                   
                                                   
                                                      
                                                         
                                                            χ
                                                            d
                                                         
                                                         
                                                            
                                                               d
                                                               
                                                                  i
                                                                  j
                                                               
                                                            
                                                            
                                                               
                                                                  max
                                                                  
                                                                     i
                                                                     ,
                                                                     j
                                                                     ∈
                                                                     V
                                                                  
                                                               
                                                               
                                                                  (
                                                                  
                                                                     d
                                                                     
                                                                        i
                                                                        j
                                                                     
                                                                  
                                                                  )
                                                               
                                                            
                                                         
                                                         +
                                                         
                                                            χ
                                                            q
                                                         
                                                         
                                                            
                                                               
                                                                  |
                                                               
                                                               
                                                                  q
                                                                  i
                                                               
                                                               −
                                                               
                                                                  q
                                                                  j
                                                               
                                                               
                                                                  |
                                                               
                                                            
                                                            
                                                               
                                                                  max
                                                                  
                                                                     i
                                                                     ∈
                                                                     V
                                                                  
                                                               
                                                               
                                                                  (
                                                                  
                                                                     q
                                                                     i
                                                                  
                                                                  )
                                                               
                                                               −
                                                               
                                                                  min
                                                                  
                                                                     i
                                                                     ∈
                                                                     V
                                                                  
                                                               
                                                               
                                                                  (
                                                                  
                                                                     q
                                                                     i
                                                                  
                                                                  )
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                   
                                                   
                                                      
                                                         +
                                                         
                                                         
                                                            χ
                                                            e
                                                         
                                                         
                                                            
                                                               
                                                                  |
                                                               
                                                               
                                                                  e
                                                                  i
                                                               
                                                               −
                                                               
                                                                  e
                                                                  j
                                                               
                                                               
                                                                  |
                                                               
                                                            
                                                            
                                                               
                                                                  max
                                                                  
                                                                     i
                                                                     ∈
                                                                     V
                                                                  
                                                               
                                                               
                                                                  (
                                                                  
                                                                     e
                                                                     i
                                                                  
                                                                  )
                                                               
                                                               −
                                                               
                                                                  min
                                                                  
                                                                     i
                                                                     ∈
                                                                     V
                                                                  
                                                               
                                                               
                                                                  (
                                                                  
                                                                     e
                                                                     i
                                                                  
                                                                  )
                                                               
                                                            
                                                         
                                                         .
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 

The first customer to be removed is selected randomly. Then, in each iteration, one customer is drawn randomly from the already removed customers and all non-removed customers are sorted in ascending order of their relatedness value to the selected customer (a small value of R(i, j) corresponds to a high relatedness). From this list, the customer at position 
                                       
                                          ⌊
                                          D
                                          ·
                                          
                                             b
                                             
                                                χ
                                                shaw
                                             
                                          
                                          ⌋
                                       
                                     is chosen, where D is the size of the list, b is a uniform random number ∈ [0, 1] and χ
                                    shaw a parameter to weight the impact that relatedness has on the selection. Shaw removal is only defined for customer vertices.


                                    Cluster removal identifies and removes clusters of geographically close vertices and was proposed in Ropke and Pisinger (2006b). First, a route is selected at random and vertices contained in the route are separated into two clusters. To this end, Kruskal’s algorithm for the minimal spanning tree problem is stopped when two subtrees remain. We randomly select one of the trees as cluster for removal. For the next clustering step, we determine the route closest to a randomly selected customer of the removed cluster. This process is repeated until the required number of vertices is removed. If the overall number of customers in a cluster exceeds the number of vertices that are still to be removed, we randomly select customers from the cluster until the given number is reached. Only one version of cluster removal exists, which does not distinguish between customers and recharging visits.


                                    Station vicinity removal is a special type of the cluster removal operator, which aims at reordering customer visits in the vicinity of recharging stations. We observed that routes in these regions tend to be complex and intertwined because recharging and customer visits have to be scheduled in a manner respecting time window requirements and battery capacity level. To define the vicinity of a station, we randomly choose a radius r in the interval 
                                       
                                          [
                                          
                                             χ
                                             
                                                radius
                                             
                                             min
                                          
                                          ·
                                          
                                             max
                                             
                                                i
                                                ,
                                                j
                                                ∈
                                                V
                                             
                                          
                                          
                                             (
                                             
                                                d
                                                
                                                   i
                                                   j
                                                
                                             
                                             )
                                          
                                          ,
                                          
                                             χ
                                             
                                                radius
                                             
                                             max
                                          
                                          ·
                                          
                                             max
                                             
                                                i
                                                ,
                                                j
                                                ∈
                                                V
                                             
                                          
                                          
                                             (
                                             
                                                d
                                                
                                                   i
                                                   j
                                                
                                             
                                             )
                                          
                                          ]
                                          ,
                                       
                                     i.e., the radius r is determined instance-dependent as percentage 
                                       
                                          χ
                                          
                                             radius
                                          
                                          min
                                       
                                     (
                                       
                                          χ
                                          
                                             radius
                                          
                                          max
                                       
                                    ) of the maximal distance between two customers. Next, we randomly select a recharging station R and remove all customers i with a distance diR
                                     < r. This step is repeated until q customers are removed. We implement a second version that also removes all visits to the considered recharging stations.

The following repair operators are used in our ALNS:

                              
                                 
                                    Greedy insertion iteratively performs the best possible insertion. For each still unassigned vertex the increase of the surrogate cost function 
                                       
                                          
                                             f
                                             ˜
                                          
                                          gen
                                       
                                     for the insertion at every route position is evaluated and the vertex and position with minimal cost increase are chosen.


                                    Regret insertion was described by Ropke and Pisinger (2006b) in the context of ALNS. The idea is to anticipate the future effect of an insertion operation. The k-regret value for each vertex is calculated as the difference between the insertion cost in the best route and in the k-best route, i.e., k describes the extent to which the future is anticipated. The cost of insertion is evaluated with 
                                       
                                          
                                             f
                                             ˜
                                          
                                          gen
                                       
                                     under the assumption that the insertion is performed at the best possible position within the route. We implement the regret-2 and regret-3 heuristic.

Greedy and Regret insertion are both realized in four variants: the first version only inserts customer vertices, the second version inserts customer vertices and recharging visits, and versions three and four additionally use a diversification penalty to evaluate the costs of inserting a vertex. The diversification penalty is based on the continuous diversification principle introduced in (Cordeau, Laporte, and Mercier, 2001) and later adapted to the E-VRPTW by Schneider, Stenger, and Goeke (2014).


                                    GRASP insertion is based on the GRASP metaheuristic introduced in Feo and Resende (1989). Analogous to greedy insertion, the cost increase for the insertion of all remaining vertices is calculated and the vertices are stored in a list of size D in ascending order of cost increase. Instead of selecting the best vertex for insertion, a random vertex of the first ⌊χ
                                    grasp · D⌋ best vertices is selected, where χ
                                    grasp denotes the degree of randomness. GRASP only inserts customer vertices.

The LS follows a best-improvement strategy using a composite neighborhood of Relocate (Savelsbergh, 1992), Exchange (Savelsbergh, 1992), 2-opt* (Potvin and Rousseau, 1995) and an operator for inserting and removing visits to recharging stations, called stationInRe (Schneider, Stenger, and Goeke, 2014). Relocate and Exchange are applied for intra- and inter-route moves, 2-opt* is only defined for inter-route moves. Moreover, Relocate is defined to handle recharging visits and 2-opt* allows to modify routes including recharging visits, while Exchange is explicitly not applied to recharging visits. 2-opt* is not allowed between ECV and ICCV routes. Relocate moves inserting recharging visits into ICCV routes are forbidden and also stationInRe moves on ICCV routes.

Moves are realized by means of the generator arc principle introduced in Toth and Vigo (2003). Moves leading to the inclusion of an infeasible arc, i.e., moves that insert an arc from the set A∖A
                           − into an ICCV route or moves inserting an arc from the set 
                              
                                 A
                                 ∖
                                 
                                    A
                                    E
                                    −
                                 
                              
                            into an ECV route, are not evaluated. As described in Section 5.2, we use a surrogate cost function whose evaluation is less demanding (see, e.g., Crainic, Gendreau, Soriano, and Toulouse, 1993; Gendreau and Potvin, 2010).

In each iteration of the LS, we determine a list 
                              M
                            of the best ε solutions that can be generated in the composite neighborhood. The costs used to determine whether a solution is included in the list are either surrogate or exact cost values that were determined in previous iterations (Due to caching, exact values are available for moves that have been evaluated in previous iterations and that only affect routes which have not been changed since the exact evaluation). Then, for each solution with surrogate cost included in the list, we evaluate the exact cost and carry out the best of the ε moves based on exact costs.

The LS stops as soon as a local optimum (based on the current penalty factors) is reached.

In order to overcome local optima, ALNS uses an SA-based acceptance criterion (Kirkpatrick, Gelatt, and Vecchi, 1983). Besides always accepting an improving solution, SA accepts a new deteriorating solution with a certain probability that depends (i) on the difference between cost values of the new and the current solution and (ii) a temperature which follows a predefined cooling schedule.

As described above, we allow infeasible solutions and handle them with a dynamic penalty mechanism. Consequently, the cost value of a solution is strongly dependent on the current values of the penalty factors. The dynamic nature of the penalty factors raises the question which penalty factors to use in order to compare the cost value of the current and the new solution. Evaluating both solutions with different penalty factors, e.g., the ones that were valid at the time the solutions were created, can be misleading because differences in cost values may be solely caused by the difference in penalty factors.

Let 
                              
                                 (
                                 
                                    γ
                                    cap
                                    S
                                 
                                 ,
                                 
                                    γ
                                    tw
                                    S
                                 
                                 ,
                                 
                                    γ
                                    batt
                                    S
                                 
                                 )
                              
                            be the vector of penalty factors used for evaluating f
                           gen(S) and 
                              
                                 (
                                 
                                    γ
                                    cap
                                    
                                       S
                                       ′
                                    
                                 
                                 ,
                                 
                                    γ
                                    tw
                                    
                                       S
                                       ′
                                    
                                 
                                 ,
                                 
                                    γ
                                    batt
                                    
                                       S
                                       ′
                                    
                                 
                                 )
                              
                            the penalty factors used for evaluating f
                           gen(S′) at the time of solution creation. Then, in order to make solutions comparable, the cost values 
                              
                                 
                                    f
                                    gen
                                    eval
                                 
                                 
                                    (
                                    S
                                    )
                                 
                              
                            and 
                              
                                 
                                    f
                                    gen
                                    eval
                                 
                                 
                                    (
                                    
                                       S
                                       ′
                                    
                                    )
                                 
                              
                            to compute the acceptance probability are determined with penalty factors

                              
                                 
                                    
                                       
                                          
                                          
                                          
                                             
                                                (
                                                
                                                   γ
                                                   cap
                                                   eval
                                                
                                                ,
                                                
                                                   γ
                                                   tw
                                                   eval
                                                
                                                ,
                                                
                                                   γ
                                                   batt
                                                   eval
                                                
                                                )
                                             
                                          
                                       
                                       
                                          
                                          
                                          
                                             
                                                
                                                =
                                                
                                                   (
                                                   
                                                      1
                                                      2
                                                   
                                                   ·
                                                   
                                                      (
                                                      
                                                         γ
                                                         cap
                                                         
                                                            S
                                                            ′
                                                         
                                                      
                                                      +
                                                      
                                                         γ
                                                         cap
                                                         S
                                                      
                                                      )
                                                   
                                                   ,
                                                   
                                                      1
                                                      2
                                                   
                                                   ·
                                                   
                                                      (
                                                      
                                                         γ
                                                         tw
                                                         
                                                            S
                                                            ′
                                                         
                                                      
                                                      +
                                                      
                                                         γ
                                                         tw
                                                         S
                                                      
                                                      )
                                                   
                                                   ,
                                                   
                                                      1
                                                      2
                                                   
                                                   ·
                                                   
                                                      (
                                                      
                                                         γ
                                                         batt
                                                         
                                                            S
                                                            ′
                                                         
                                                      
                                                      +
                                                      
                                                         γ
                                                         batt
                                                         S
                                                      
                                                      )
                                                   
                                                   )
                                                
                                                .
                                             
                                          
                                       
                                    
                                 
                              
                           
                        

If solutions stay infeasible for longer periods, penalty factors and thus the absolute difference between cost values of solutions increase. To avoid the undesired effect that these (potentially better) solutions have a low chance to be accepted because of high penalty factors, we use the relative difference between cost values to calculate the acceptance probabilities:

                              
                                 
                                    
                                       Δ
                                       
                                          f
                                          rel
                                       
                                       
                                          (
                                          
                                             S
                                             ′
                                          
                                          ,
                                          S
                                          )
                                       
                                       =
                                       
                                          
                                             
                                                f
                                                gen
                                                eval
                                             
                                             
                                                (
                                                
                                                   S
                                                   ′
                                                
                                                )
                                             
                                             −
                                             
                                                f
                                                gen
                                                eval
                                             
                                             
                                                (
                                                S
                                                )
                                             
                                          
                                          
                                             
                                                f
                                                gen
                                                eval
                                             
                                             
                                                (
                                                S
                                                )
                                             
                                          
                                       
                                       .
                                    
                                 
                              
                           Thus, we always accept improving solutions, while, given the current temperature T, deteriorating solutions are accepted with probability:

                              
                                 
                                    
                                       p
                                       
                                          (
                                          S
                                          ,
                                          
                                             S
                                             ′
                                          
                                          ,
                                          T
                                          )
                                       
                                       =
                                       
                                          e
                                          
                                             
                                                −
                                                Δ
                                                
                                                   f
                                                   rel
                                                
                                                
                                                   (
                                                   
                                                      S
                                                      ′
                                                   
                                                   ,
                                                   S
                                                   )
                                                
                                             
                                             T
                                          
                                       
                                       .
                                    
                                 
                              
                           
                        

The starting temperature is chosen in a fashion that a solution that deteriorates the initial solution by ι percent is accepted with a probability of 50 percent. The temperature is decreased by a constant factor such that the temperature is below T
                           threshold = 0.0001 in the last 20 percent of iterations.

Adaptive weight adjustment assesses the importance of each destroy and repair operator by modifying the probability π with which the respective operator is chosen based on the previous performance of the operator. In more detail, we periodically adjust the probabilities of the destroy operators (
                              
                                 π
                                 i
                                 −
                              
                           ), of the repair operators (
                              
                                 π
                                 i
                                 +
                              
                           ), and of the intervals from which the number of customers to remove is drawn (
                              
                                 π
                                 i
                                 ∥
                              
                           ).

Performance is measured by assigning scores σi
                            to the destroy and repair operators and the intervals. If an operator or interval i is used in the current iteration of ALNS, we increase the respective score by σA
                            if the following LS results in a new global best solution, by σB
                            if a new improving solution is found, and by σC
                            if a new deteriorating solution is found and accepted by the SA-based criterion. We consider a solution to be new if we did not obtain the cost value f
                           gen(S′) before (evaluated with a standard set of penalty factors γ
                           cap, γ
                           tw, γ
                           batt = 1).

After βπ
                            iterations, we update the weights 
                              
                                 
                                    λ
                                    i
                                    ∥
                                 
                                 ,
                              
                           
                           
                              
                                 λ
                                 i
                                 −
                              
                            and 
                              
                                 λ
                                 i
                                 +
                              
                            to:

                              
                                 
                                    
                                       
                                          λ
                                          i
                                       
                                       :
                                       =
                                       w
                                       
                                          
                                             σ
                                             i
                                          
                                          
                                             n
                                             i
                                          
                                       
                                       +
                                       
                                          (
                                          1
                                          −
                                          w
                                          )
                                       
                                       
                                          λ
                                          i
                                       
                                       ,
                                    
                                 
                              
                           where w denotes the weight of the current phase of evaluation, (1 − w) the weight put on the previous success of the operator or interval, and ni
                            the number of times the operator or interval was selected during the last βπ
                            iterations. Then, the scores of each operator or interval are reset to 0. Subsequently, we determine the corresponding probabilities 
                              
                                 
                                    π
                                    i
                                    ∥
                                 
                                 ,
                              
                           
                           
                              
                                 π
                                 i
                                 −
                              
                            and 
                              
                                 π
                                 i
                                 +
                              
                            to:

                              
                                 
                                    
                                       
                                          π
                                          i
                                       
                                       =
                                       
                                          
                                             λ
                                             i
                                          
                                          
                                             
                                                ∑
                                                i
                                             
                                             
                                                λ
                                                i
                                             
                                          
                                       
                                       .
                                    
                                 
                              
                           
                        

We conduct numerical experiments on two different types of instances: First, we use newly generated E-VRPTWMF instances to investigate (i) the influence of using the surrogate objective function on the solution process, (ii) the effect of considering the actual distribution of load in comparison to assuming constant load over all traveled arcs, and (iii) the influence of different objective functions on the structure and costs of generated solutions and the share that ECVs contribute to this cost. Second, to assess the performance of ALNS in terms of solution quality and run-time, we conduct tests on available benchmark instances of the related problems VRPTW and E-VRPTW.

The section is structured as follows. The parameter tuning is presented in Section 6.1, the generation of the E-VRPTWMF benchmark instance in Section 6.2, the tests performed on these instances in Section 6.3, and the tests on the benchmark instances of related problems in Section 6.4.

All experiments are conducted on a desktop computer with an Intel Core i7 processor at 2.8 gigahertz, 8 gigabytes of RAM, running Windows 7 Enterprise. Our ALNS is implemented as single-thread code in Java. The parameter setting of the ALNS is determined using a subset of 20 randomly selected E-VRPTWMF instances with 50 and 100 customers (details on the generation of E-VRPTWMF instances are given in Section 6.2). Parameter tests are carried out using the objective of minimizing traveled distance.

During the development of our algorithm, we identified (i) a set of parameters that have a stronger influence on the solution quality of the algorithm, and (ii) for each of these parameters a well-performing base setting. In the parameter tuning, we investigate the influence of modifying this base setting in two directions, i.e., three settings are tested per parameter. More precisely, we consecutively assess each of the parameters and always keep the best setting found for this parameter for the tuning of the remaining parameters. The order in which the parameters are tuned is determined randomly. Table 2
                         shows, for each parameter, the three tested settings and the deviation 
                           
                              Δ
                              
                                 f
                                 d
                              
                           
                         of the best solution found in 10 runs with the respective setting to the result obtained with the best setting for this parameter. The best setting for each parameter is given in bold.

In the described fashion, we test the following parameters: the number of iterations after which the weights of ALNS are adjusted (βπ
                        ), the scores used in the adaptive weight adjustment (σA, σB, σC
                        ), the reaction factor (w) of the weight adjustment, the maximal percentage of removed customers (Ω
                        max), the minimal and maximal radius for the station vicinity removal operator (
                           
                              
                                 χ
                                 
                                    radius
                                 
                                 min
                              
                              ,
                              
                                 χ
                                 
                                    radius
                                 
                                 max
                              
                           
                        ), the percentage of deterioration that is accepted at the beginning of SA (ι), the penalty update factor (ϱ), and the number of solutions in each iteration that are evaluated with the original objective function instead of the surrogate (ε). We observe that none of the tested settings leads to a significant deterioration of solution quality (the deviation is always below 0.28 percent). Consequently, our ALNS seems relatively insensitive to parameter variations.

In order to achieve a good tradeoff between run-time and solution quality, we set the maximal number of ALNS iterations to find a feasible solution to β
                        feas = 2000 and the number of iterations for further improvement to β
                        obj = 750 for all instances with less than 100 customers. For larger instances, we use β
                        obj = 750/(0.01 · |N|)1.5 in order to keep run-times acceptable. Table 3
                         summarizes the final parameter setting, which is used for all of the following experiments.

This section describes the generation of E-VRPTWMF test instances. The instances are based on the PRP instances proposed in Demir et al. (2012). The customer locations in these instances represent real cities in the UK, customer demands and time windows are generated in random fashion. The benchmark consists of nine instance sets grouped according to the size of the instances contained in each set (10–200 customers). Each set contains 20 instances with the respective size. Contrary to the PRP, speed is not a decision variable in E-VRPTWMF and we set a fixed speed that corresponds to the upper speed limit given in the PRP instances, i.e, we set 
                           
                              
                                 v
                                 
                                    i
                                    j
                                 
                              
                              =
                              90
                              
                              
                                 kilometers
                                 
                                 per
                                 
                                 hour
                              
                              ,
                              
                              ∀
                              i
                              ,
                              j
                              ∈
                              
                                 V
                                 
                                    0
                                    ,
                                    N
                                    +
                                    1
                                 
                                 ′
                              
                           
                        . In this way, we also ensure that all instances can be feasibly solved (with respect to time windows) when using a fleet of ICCVs.

The number of recharging stations is adapted to the number of customers N of the instances. More precisely, we locate ⌊0.1 · |N|⌋ recharging stations at randomly drawn customer locations and one additional station at the depot. To determine the number of ECVs and ICCVs of each instance, we proceed as follows: We start with a total vehicle number m that corresponds to the number of ICCVs given in the PRP solutions of Demir et al. (2012), and gradually substitute ICCVs with ECVs until either m
                        E = ⌊m/2⌋, or our ALNS is no longer able to find a feasible solution.

We use the physical constants, vehicle properties and coefficients provided in Demir et al. (2012). The battery capacity is set to 80 kWh, which is a realistic for ECVs according to Davis and Figliozzi (2013). Efficiency parameters for engine and battery during discharge and recuperation are determined as described in Section 3.1. The recharging power at stations is assumed equivalent to that of the Tesla supercharger network for passenger cars (Tesla Motors, Inc., 2014).

When using the objectives f
                        c or f
                        cb, we assume the following cost structure: Driver costs are equal for ICCVs and ECVs and correspond to the time spend en route. Hourly wages are given in Demir et al. (2012). The diesel price, electricity price and costs for battery replacement used for calculating driving costs are taken from Davis and Figliozzi (2013). To determine the battery replacement cost on a per kilometer basis, we assume that a battery has to be replaced after 241,350 kilometers (150,000 miles) at a cost of 600 dollars per kilowatt-hour. Table 4
                         summarizes the data. The complete instances are available for download at http://www.logistikplanung.tu-darmstadt.de/logistikplanung_und_informationssysteme/forschung_16/publikationen_14/index.de.jsp.

We conducted tests with our ALNS for the complete set of instances described above. The detailed results are given in the appendix in Appendix A as comparison values for researchers addressing the same instances in the future. In this section, we describe the numerical tests that investigate the research questions introduced above:

                           
                              1.
                              impact of using the surrogate objective function (Section 6.3.1)
                              

effect of considering load in the calculation of energy consumption (Section 6.3.2)
                              

influence of different objective functions and the resulting level of usage of ECVs (Section 6.3.3).

As described in Section 5.4.2, the LS determines the best move in each iteration based on exactly evaluating a list 
                              M
                            of promising candidate moves that were found using a surrogate cost function 
                              
                                 
                                    f
                                    ˜
                                 
                                 gen
                              
                           . We assess the impact of using the surrogate cost function (i) on the course of the search, and (ii) on the solution quality of our ALNS.

First, we conduct 50 iterations of ALNS on the 100-customer instance E-UK_100_03 with the objective of minimizing traveled distance. The size of the list 
                              M
                            is set to ε = 50. In each iteration, we calculate the best move based on the surrogate cost function, i.e., we fill 
                              M
                            using the surrogate cost, then determine the exact costs of the entries in 
                              M
                            and select the best entry. The quality of this move is assessed by determining its rank among the possible moves in this iteration if all moves were evaluated exactly (not only those in 
                              
                                 M
                                 )
                              
                           .

In Fig. 3
                           , we plot these ranks. Applications of destroy and repair operators are marked with an “x”. Thus, we identify how often and to what degree we miss the best possible move. In 45 percent of iterations we choose the rank 1 move and in 59 percent of iterations we choose one of the top 3 moves. Only in 3.5 percent of iterations, the selected move is not among the top 10.

Second, we carry out additional experiments to investigate the effect of using the surrogate cost function on the solution quality of ALNS by comparing the solutions obtained with the surrogate and with the exact cost function. To keep computation times reasonable, the tests are run on a reduced subset of the E-VRPTWMF instances, which is obtained by randomly selecting 5 out of 20 instances for each problem size. Due to the very high run-times when using the exact cost function, we further have to restrict the size of the considered instances to maximally 75 customers for this study. Summarizing, we randomly select 5 of the 20 instances for the problem sizes |N| = 5, 10, 15, 20, 25, 50, 75 and conduct 10 runs for each instance with the surrogate cost function and with the exact cost function, following the objective of minimizing traveled distance. The size of the list 
                              M
                            is again set to ε = 50.

For the exact cost function, Table 5
                            reports the best solution found in the 10 runs (
                              
                                 f
                                 
                                    d
                                 
                                 best
                              
                           ), the average solution quality (
                              
                                 f
                                 
                                    d
                                 
                                 avg
                              
                           ) and the average run-time in minutes (t
                           avg) as averages of groups of instances of the same size. For the surrogate cost function, the same measures are evaluated and the solution quality is reported as gaps 
                              
                                 Δ
                                 
                                    d
                                 
                                 best
                              
                            and 
                              
                                 Δ
                                 
                                    d
                                 
                                 avg
                              
                            (in percent) to the solutions obtained with the exact cost function. The run-time using the surrogate cost function is presented using a run-time reduction factor 
                              
                                 T
                                 ,
                              
                            which is obtained by dividing the average run-time using the exact cost function by the average run-time using the surrogate cost function. At the bottom of the table, average results over the investigated instance groups are given.

The results show that using the surrogate cost function has only minimal negative effect on the solution quality concerning the best as well as the average solution quality. However, the run-time savings using the surrogate are really impressive with a factor 
                              T
                            of 194 for the 75-customer instances.

This study investigates the importance of considering the distribution of load when routing a mixed fleet of ICCVs and ECVs. To this end, we compare the quality of the solutions obtained based on the actual load distribution to the solutions obtained with the following two load estimates. First, the cautious load estimate is to assume that all vehicles are fully loaded during their whole trip (
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                              
                           ). This is a worst-case estimate in some sense because it implies maximal energy consumption. This estimate guarantees that all obtained solutions are still feasible with respect to battery capacity and time windows if the actual load distribution is considered. The second load estimate assumes the average case that the vehicles travel half-loaded (
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                                 /
                                 2
                              
                           ). This may result in solutions that are infeasible when taking into account the actual load due to either violations of battery capacity, i.e., ECVs that get stranded, or due to violations of time windows, which are caused by a wrong estimation of the recharging time of ECVs.

We are interested in:

                              
                                 •
                                 the quality of solutions S obtained with the estimates 
                                       
                                          S
                                          (
                                          
                                             u
                                             ¯
                                          
                                          =
                                          Q
                                          )
                                       
                                     and 
                                       
                                          S
                                          (
                                          
                                             u
                                             ¯
                                          
                                          =
                                          Q
                                          /
                                          2
                                          )
                                       
                                     when afterwards evaluating the costs considering the actual load (denoted as 
                                       
                                          
                                             f
                                             c
                                             
                                                u
                                                i
                                             
                                          
                                          
                                             (
                                             S
                                             )
                                          
                                       
                                    ), and

the error of determined costs when the solutions are obtained and evaluated based on the load estimates (denoted as 
                                       
                                          
                                             f
                                             c
                                             
                                                
                                                   u
                                                   ¯
                                                
                                                
                                                =
                                                
                                                Q
                                             
                                          
                                          
                                             (
                                             S
                                             )
                                          
                                       
                                     and 
                                       
                                          
                                             f
                                             c
                                             
                                                
                                                   u
                                                   ¯
                                                
                                                
                                                =
                                                
                                                Q
                                                /
                                                2
                                             
                                          
                                          
                                             (
                                             S
                                             )
                                          
                                       
                                    ). These cases are interesting as these are the cost estimates that will often be used in practical planning situations.

We conduct experiments addressing the above points on a reduced subset of the E-VRPTWMF instances (5 randomly chosen instances out of 20 for each group), again, in order to keep computation times reasonable. For each instance, 10 ALNS runs are performed following the objective of minimizing costs without battery costs f
                           c and the reported results are based on the best of the 10 runs. Table 6
                            provides for each of the instances the number of ICCVs (m
                           IC) and ECVs (m
                           E), the cost of the solution obtained based on the actual load distribution and evaluated using the actual load (
                              
                                 
                                    f
                                    c
                                    
                                       u
                                       i
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          i
                                       
                                       )
                                    
                                    )
                                 
                              
                           ), and the percentage gap (to the costs 
                              
                                 
                                    f
                                    c
                                    
                                       u
                                       i
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          i
                                       
                                       )
                                    
                                    )
                                 
                              
                           ) of the solutions obtained considering load estimates and evaluated using (i) the actual load (columns 
                              
                                 Δ
                                 
                                    f
                                    c
                                    
                                       u
                                       i
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          ¯
                                       
                                       =
                                       Q
                                       )
                                    
                                    )
                                 
                              
                            and 
                              
                                 Δ
                                 
                                    f
                                    c
                                    
                                       u
                                       i
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          ¯
                                       
                                       =
                                       Q
                                       /
                                       2
                                       )
                                    
                                    )
                                 
                              
                           ), and (ii) the load estimate (columns 
                              
                                 Δ
                                 
                                    f
                                    c
                                    
                                       
                                          u
                                          ¯
                                       
                                       
                                       =
                                       
                                       Q
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          ¯
                                       
                                       =
                                       Q
                                       )
                                    
                                    )
                                 
                              
                            and 
                              
                                 Δ
                                 
                                    f
                                    c
                                    
                                       
                                          u
                                          ¯
                                       
                                       
                                       =
                                       
                                       Q
                                       /
                                       2
                                    
                                 
                                 
                                    (
                                    S
                                    
                                       (
                                       
                                          u
                                          ¯
                                       
                                       =
                                       Q
                                       /
                                       2
                                       )
                                    
                                    )
                                 
                              
                           ). Instances for which the solution found with the estimate 
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                                 /
                                 2
                              
                            is not feasible if the actual load is considered are marked with a dash. At the bottom of the table, average results over the investigated instances are given.

As mentioned above, using the estimate 
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                              
                            guarantees feasibility, however, the obtained solutions show an average gap of 1.89 percent if the actual load distribution is used for evaluating costs. Further, cost evaluation based on this estimate leads to an overestimation of costs by more than 5 percent on average. On the other hand, using the estimate 
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                                 /
                                 2
                              
                            leads to infeasible solutions for 17 out of 45 instances and an average gap of approximately 1 percent over the instances for which a feasible solution is found. Costs based on this estimate underestimate real costs by − 0.94 percent.

The results show that the quality of solutions obtained using estimates is clearly inferior to the quality of the solutions obtained considering the actual load. Moreover, costs evaluated with estimates strongly differ from real costs. Both deviations are stronger in the case of 
                              
                                 
                                    u
                                    ¯
                                 
                                 =
                                 Q
                              
                           . However, in the context of ECVs, using a load estimate other than this “worst-case estimate” may result in infeasible solutions due to stranded ECVs or time window violations caused by wrong assessment of the required recharging times of ECVs. This is different from ICCV fleet, where load estimates can only lead to wrong cost estimations and wrong routing decisions but not to infeasible solutions. Also note that it may happen that using a certain load estimate, it is not possible to find a feasible solution although a feasible solution exists for the actual load distribution. For example, this may be the case if time windows are very restrictive and ECVs have to travel with very little load in order to avoid recharging operations.

Overall, the study clearly demonstrates the importance of considering load information in the route planning of ECVs from a feasibility as well as a cost perspective. While the problem of stranded ECVs may be counteracted by allotting high safety margins, an adequate consideration of energy consumption allows to better utilize expensive battery capacity. Finally, we note that our ALNS is capable to solve all instances with the same number of vehicles as determined originally for the PPR and we can substitute approximately half of the ICCVs in the fleet (m
                           E/(m
                           E + m
                           IC) = 47.2 percent) by ECVs.

In this study, we compare the solutions obtained with the different objective functions of minimizing traveled distance (f
                           d), costs without battery depreciation cost (f
                           c) and costs including battery costs (f
                           cb) in terms of their performance regarding the different objectives. In the second part of the study, we investigate to what extent ECVs are employed when different objective functions are used.

We conduct 10 ALNS runs with each of the objective functions f
                           d, f
                           c and f
                           cb on the reduced instance set described above, and we assess the results of the best of the 10 runs for each instance. Table 7
                            reports the results as averages over the instance groups with different customer numbers 10, 15, 20, 25, 50, 75, 100, 150 and 200. Let Sx, x ∈ {d, c, cb} denote the solution obtained when minimizing with objective fx
                            and let fy
                           (S), y ∈ {d, c, cb} denote the objective value of evaluating solution S with objective function fy
                           . The table reports the average values over the instance group for the solutions S
                           d obtained with the objective of minimizing traveled distance (columns f
                           d(S
                           d), f
                           c(S
                           d), and f
                           cb(S
                           d)), and the percentage gaps (to these values) of the objective values of the solutions obtained when minimizing costs (columns Δf
                           d(S
                           c), Δf
                           c(S
                           c), and Δf
                           cb(S
                           c)) and when minimizing costs including battery costs (columns Δf
                           d(S
                           cb), Δf
                           c(S
                           cb), and Δf
                           cb(S
                           cb)).

The results show that the ALNS is effective with regard to the different optimization objectives: The best results found with respect to a certain objective function are always found when optimizing according to this objective. The gaps of the solutions found with other objectives are partly significant with nearly 5 percent. In particular, the results show that the traditional objective of minimizing traveled distance does not provide satisfying solutions when costs for fuel (diesel and electricity), labor, and battery are considered. This is in line with the results of Bektaş and Laporte (2011) for pure ICCV fleets, who note similar effects considering the cost components fuel, labor and emission costs. If battery costs are included, the quality of distance-minimizing solutions rises as traveled distance becomes more expensive (there is only a gap of − 3.84 percent for Δf
                           cb(S
                           cb) compared to a gap of − 4.92 percent for Δf
                           c(S
                           c)).

In Table 8
                           , we report the percentage share that ECVs contribute to the traveled distance of the solutions obtained with the different objective functions, denoted as d
                           E(f(S)). If ICCVs and ECVs were used to the same extent, ECVs would contribute with m
                           E/(m
                           E + m
                           IC) = 47.2 percent to the traveled distance. We find that when minimizing traveled distance, ECVs travel a noticeably smaller part of the total distance because long routes will mostly be assigned to ICCVs in order to save detours. The share of traveled distance rises significantly when costs without battery costs are considered because ECV travel is cheaper than ICCV travel if only fuel and electricity consumption is considered. Finally, if costs including battery costs are considered, the contribution of ECVs decreases perceptibly because ECVs become relatively expensive if battery deprecation costs are added to the travel costs.

To assess the performance of the proposed ALNS, we conduct experiments on available benchmark instances for the related problems VRPTW and E-VRPTW, which are both special cases of the E-VRPTWMF. In the VRPTW, only ICCVs are available and no energy consumption is considered. In the E-VRPTW, only ECVs are available and instead of the energy consumption function described in Section 3, consumed energy is a linear function of the distance traveled. The following two sections present the detailed results.

We use the well-known Solomon 100-customer instances as VRPTW benchmark set (Solomon, 1987). The set contains 56 instances, which are grouped according to the distribution of customer locations – random (R), clustered (C), random-clustered (RC) – and the considered scheduling horizon. Heuristic methods for VRPTW use a hierarchical objective (minimize number of vehicles first, minimize traveled distance second). Our ALNS is not designed to minimize vehicle routes but to minimize traveled distance with a given number of vehicles. Therefore, we set the initial number of routes for each instance to the best known number given in the literature. If ALNS is not able to determine a feasible solution with the given number of vehicles after β
                           feas iterations, the number of vehicles is increased by one.

As comparison method for our ALNS, we use the currently best-performing VRPTW method in the literature, the memetic algorithm proposed by Nagata, Bräysy, and Dullaert (2010) (NBD). Note that for all Solomon instances the solution found by NBD corresponds to the best-known solution in the literature (Vidal, Crainic, Gendreau, and Prins, 2013). Table 9
                            reports the best solution with respect to the vehicle number m and the distance traveled f out of 10 runs for our ALNS (out of 5 runs for NBD). Results are given as averages over the instance groups R1, R2, C1, C2, RC1 and RC2. Finally, the cumulative number of vehicles (CNV) and the cumulative traveled distance (CTD) over all instances are reported. ALNS achieves a gap to NBD of 0 percent concerning the CNV and a gap of 0.37 percent with regard to the CTD. Although a direct comparison of run-times between different platforms (using different operating systems, programming languages, and compilers) is always difficult, we state that ALNS has an average computation time of 87 seconds per run compared to 300 seconds of NBD. These results prove the capability of ALNS to find high-quality VRPTW solutions in fast computation times. This is a prerequisite to be able to address the computationally demanding E-VRPTWMF instances.

Experiments for the E-VRPTW are conducted on the instance set presented in Schneider, Stenger, and Goeke (2014), where also a detailed description of the instances can be found. The set contains 56 instances which are based on the Solomon VRPTW instances but additionally contain 21 recharging stations. The vehicle fleet consists solely of ECVs with a limited battery capacity, whose energy consumption depends linearly on the distance traveled. Recharging times at stations are assumed a linear function of the required charge. The objective of E-VRPTW is hierarchical like in the VRPTW and we use the numbers of vehicles reported in Schneider, Stenger, and Goeke (2014) as start values for our ALNS. As comparison method, we use the ALNS of Hiermann, Puchinger, and Hartl (2014) (HPH), and the VNS/TS hybrid of Schneider, Stenger, and Goeke (2014) (SSG).

In Table 10
                           , for each instance, we provide the previous best-known solution (BKS) as reported in Hiermann et al. (2014); Schneider, Stenger, and Goeke (2014) in terms of number of vehicles m and traveled distance f. For the algorithms HPH, SSG, and our ALNS, we report the best result out of 10 runs: the vehicle number m and the percentage gap of the traveled distance to the BKS (Δ
                           best). Since our ALNS uses the same vehicle numbers as reported in Schneider, Stenger, and Goeke (2014), it is only reported once for SSG. Moreover, for HPH and our ALNS, we additionally provide the average run-time for each instance, for SSG only the average run-time over all instances is given. A precise comparison of run-times is only possible for ALNS and SSG because both algorithms were run on the same platform. However, although HPH was run on a different platform, we think that a rough comparison of run-times may be valid since all algorithms were run on modern computers with comparable computing power.

Column 
                              
                                 ALNS
                                 ¯
                              
                            lists the overall best results that we found during the testing of our ALNS. The best solution for each instance is marked in bold. Moreover, we mark in italics those results for which the number of vehicles used by HPH and SSG/ALNS differ. Finally, the cumulative number of vehicles (CNV), the averages over the gaps and the average run-times in minutes are reported at the bottom of the table. The average gap is the average over all instances, the corrected average gap only includes the instances for which all algorithms use the same number of vehicles. We deem the latter measure more important due to the influence of the number of vehicles on the traveled distance. It may be quite easy to find a better distance when using one more vehicle, but this distorts the comparison between the algorithms with regard to traveled distance.

The results show that our ALNS outperforms HPH and SSG. In comparison to SSG, ALNS finds the same CNV and improves the average gap of the traveled distance from 0.49 percent to 0.11 percent. In comparison to HPH, ALNS is able to reduce the CNV by one vehicle and to improve the distance gap by 0.62 percent. The average run-time decreases from about 15 minutes for SSG and HPH to less than 3 minutes. Considering the solutions found during the overall testing, our ALNS is able to improve the previous BKS for 34 out of the 56 instances, for 20 instances the previous BKS is matched. On average, the previous BKS is improved by 0.35 percent.

@&#CONCLUSION@&#

We introduce the E-VRPTWMF, a VRP to optimize the routing of a mixed vehicle fleet consisting of ICCVs and ECVs. Contrary to existing VRPs for ECVs which assume energy consumption to be a linear function of traveled distance, we utilize a realistic energy consumption model that incorporates speed, gradient and load distribution. This is highly relevant in the context of ECVs, as energy consumption determines the maximal driving range of ECVs and the recharging times at stations. To address the problem, we develop an ALNS algorithm that is enhanced by an LS for intensification.

In numerical studies on newly designed E-VRPTWMF test instances, we find that consideration of the actual load strongly improves the quality of the generated solutions in comparison to solutions that are generated based on load estimates. Moreover, we find that a large number of solutions that are generated with “optimistic” load estimates are actually infeasible due to battery capacity or time window violations. We further show that our ALNS works effectively with all of the investigated cost functions and that the traditional objective of minimizing traveled distance fails to produce high-quality solutions if routing costs including fuel, labor and battery depreciation are considered. The choice of objective function additionally has a strong influence on the level of usage of the ECVs in the fleet. Finally, the performance of the developed algorithm is proven on benchmark instances of related problems: The ALNS provides convincing results in moderate run-times on the well-known Solomon VRPTW benchmark. On E-VRPTW instances, the ALNS outperforms all comparison methods with respect to both solution quality and run-time.

There are several interesting avenues for future research. From a modeling perspective, the real-world processes related to ECVs should be modeled in a more realistic fashion, see our discussion at the end of Section 4 on how to integrate topology and acceleration processes. Another important point in this respect is a more realistic modeling of the recharging processes. From the computational viewpoint, the development of exact solution methods for solving basic electric VRPs, and the design of efficient metaheuristics for solving rich variants featuring realistic energy consumption and recharging models as well as relevant side constraints of practical routing problems are both interesting topics.

To enable researchers that address the E-VRPTWMF in the future to compare the performance of their algorithms with ours, we provide results on the complete set of E-VRPTWMF instances introduced in Section 6.2 (see Table 11
                     ). The reported results are based on the best of 10 ALNS runs. As objective function, we used the minimization of traveled distance f
                     d (in kilometers).

@&#REFERENCES@&#

