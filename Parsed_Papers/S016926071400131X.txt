@&#MAIN-TITLE@&#Automatic multiple sclerosis lesion detection in brain MRI by FLAIR thresholding

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           An algorithm for multiple sclerosis lesion detection in brain MRI is presented.


                        
                        
                           
                           An initial segmentation of brain tissues is performed by a modified EM algorithm.


                        
                        
                           
                           Lesions are located as outliers of the grey matter FLAIR intensity distribution.


                        
                        
                           
                           45 cases from three different scanner machines were used to evaluate the algorithm.


                        
                        
                           
                           The results show a moderate agreement between manual and automatic detections.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Multiple sclerosis

Lesion segmentation

MRI

@&#ABSTRACT@&#


               
               
                  Magnetic resonance imaging (MRI) is frequently used to detect and segment multiple sclerosis lesions due to the detailed and rich information provided. We present a modified expectation-maximisation algorithm to segment brain tissues (white matter, grey matter, and cerebro-spinal fluid) as well as a partial volume class containing fluid and grey matter. This algorithm provides an initial segmentation in which lesions are not separated from tissue, thus a second step is needed to find them. This second step involves the thresholding of the FLAIR image, followed by a regionwise refinement to discard false detections. To evaluate the proposal, we used a database with 45 cases comprising 1.5T imaging data from three different hospitals with different scanner machines and with a variable lesion load per case. The results for our database point out to a higher accuracy when compared to two of the best state-of-the-art approaches.
               
            

@&#INTRODUCTION@&#

Conventional magnetic resonance imaging (MRI) techniques are highly sensitive for detecting brain abnormalities, like multiple sclerosis (MS) plaques, and can provide quantitative assessment of inflammatory activity and lesion load. MRI-derived metrics have become established as the most important paraclinical tool for a large variety of applications, like brain lesions diagnosing and monitoring [24], longitudinal studies of cognitive aging [16], or even the analysis of the fetal brain development [28]. MRI offers a high contrast between the main brain tissues, namely grey matter (GM), whitte matter (WM), and the cerebrospinal fluid (CSF).

For a quantitative analysis of focal MS lesions in both individual and temporal studies, manual or semi-automated segmentations of different MR images have been used to compute the total number of lesions and the total lesion volume. Manual delineation of MS lesions, however, is both challenging and time-consuming because of the large number of MRI slices for each patient that compose the three-dimensional information. Moreover, it is prone to intra-observer variability (the same study analysed by the same neuroradiologist at a different time) and inter-observer variability (the same study analysed by different neuroradiologists).

The development of fully automated white matter lesions detection methods, which can segment large amounts of MRI data and do not suffer from intra- or inter-observer variability, is not a new topic [19] but nowadays it is still an active research field [13,21,22,25]. These approaches can be classified between supervised and unsupervised algorithms. The inherent advantage of supervised algorithms is that they can automatically learn the characteristics of both normal tissue and lesions. However, their main problem is that they rely on having a good training set, which may be difficult to obtain. Two supervised strategies can be identified according to the procedure the annotations are introduced into the algorithms: using an atlas registration step or training a classification algorithm. The advantage of atlas-based approaches is that spatial information is inherently used, although registration is also a challenging task. On the other hand, training-based approaches allow to use real characteristics of the tissues and the lesions, but spatial information has to be imposed in a further step since it is not included in the training process.

The expectation-maximisation (EM) [8] algorithm is one of the most widely used in the literature for tissue segmentation with atlases [6]. For instance, Souplet et al. [35] adapted the EM algorithm to tackle partial volume (PV) effects and segment lesions. In their approach, which is an extension of the algorithm presented by Dugas-Phocion et al. [10], two main types of classes are defined: pure tissue classes, which are assumed to follow a Gaussian distribution and comprise CSF, GM, and WM; and partial volume classes, which are defined as proportions between GM and CSF. While other interactions may occur (such as WM and CSF around the ventricle boundaries), those are excluded due to their slight influence and the possibility of defining them using CSF and GM proportions.

In this paper, we will further explain the basics of this approach and present our contributions, introduced as part of our lesion segmentation pipeline. These contributions comprise a similarity map to weight the atlas, the use of neighbourhood information combined with the weighted atlases, the introduction of a partial volume probability map, and a regionwise false positive reduction step based on clinical rules. All the steps in the proposed pipeline are applied to the images after the preprocessing. The rest of the paper is structured as follows: in Section 2 our database is described and all the preprocessing and segmentation steps are explained, in Section 3 we present our parameter tuning with the quantitative and qualitative results obtained with our database consisting of 45 patients followed by a comparison with two state of the art techniques [30,35]. Finally, conclusions are presented in Section 4.

Our database comprises images from three different hospitals to evaluate the performance of the proposed automatic segmentation of brain tissues and lesions in different scanning machines. For each hospital, 15 different patients were scanned with the same protocol (T1-w, T2-w, PD-w and FLAIR): from Hospital Vall d’Hebron (H
                        1), using a 1.5T Siemens Simphony Quantum with 2D conventional spin-echo T1-w (TR 450ms, TE 17ms), dual echo PD T2-w (TR 3750ms, TE 14 / 86 ms), and FLAIR (TR 9000ms, TE 114ms, and TI 2500ms); from Hospital Josep Trueta (H
                        2), using a 1.5T Philips Intera (R12) with 2D conventional spin-echo T1-w (TR 653ms, TE 14ms), dual echo PD T2-w (TR 2800ms, TE 16 / 80ms), and FLAIR (TR 8153ms, TE 105ms, and TI 2200ms); and from Clínica Girona (H
                        3), using a 1.5T GE Signa HDxt, with 3D fast spoiled gradient T1-w (TR 30ms, TE 9ms), fast spin echo T2-w (TR 5000-5600ms, TE 74-77ms), PD-w (TR 2700ms, TE 11.9ms), and FLAIR (TR 9002ms, TE 80ms, and TI 2250ms). All the images were acquired in axial-view with a slice thickness of 3mm (1mm × 1mm × 3mm) and were co-registered using an affine transform.

From each hospital, patients with different lesion load were scanned as illustrated in Fig. 1
                        . By looking at the bar plot, there is a clear difference between the lesion load among the three hospitals. H
                        1 showed the lowest mean (3.1cm3) and median lesion load (1.62cm3) per patient. On the other hand, H
                        2 has the highest mean (18.03cm3) and median lesion load (10.54cm3) of all three hospitals. This hospital also has a high variability in terms of lesion load. For instance, the minimum and maximum lesion loads are 0.19cm3 and 52.48cm3 respectively. The last hospital, H
                        3, presents a mean (10.34cm3) and median (5.03cm3) value in-between the other two hospitals. Furthermore, the lesion load of these cases presents a similar variability to H
                        1, even though H
                        3 has the case with the highest lesion load of all three hospitals with 67.78cm3. Looking at all 45 patients, most have a lesion load lower than the mean lesion load for each hospital. This is due some of the cases having an exceptionally higher lesion load than the other cases handled at each hospital.

All the lesions of each patient were accurately annotated by a trained technician and confirmed by expert radiologists from H
                        1. All the annotations were done on the PD-w images and semiautomatically delineated using JIM© software
                           1
                        
                        
                           1
                           Xinapse Systems, JIM software webpage, http://www.xinapse.com/home.php.
                        . These annotations will be used as ground truth (GT).

The presence of non-brain tissues affects intensity distributions in the image. It is not clear how the probability density function of each main tissue (GM, WM, and CSF) is altered by these external intensities, but segmentation results are usually improved when those voxels are masked out. There are different available methods to perform this step [3,32,34], although none of them has been shown to be superior to the others. In our pipeline, we decided to apply the BET algorithm [34] to remove these tissues. BET, a tool from the FSL toolbox [17], is a freely available algorithm based on T1-w images and is widely used in brain MRI processing.

A robust and automatic brain MRI segmentation is difficult to achieve due to numerous facts: variable imaging parameters, overlapping intensities, noise, partial volume effects, gradients, motion, echoes, blurred edges, normal anatomical variations, and susceptibility artefacts [31]. This can lead to inaccurate segmentation. However, from the image processing viewpoint, it is common to simplify all these problems [18,33] by defining the observed intensities, 
                           
                              I
                              ˆ
                           
                        , of each voxel x as:


                        
                           
                              (1)
                              
                                 
                                    
                                       I
                                       ˆ
                                    
                                 
                                 (
                                 x
                                 )
                                 =
                                 β
                                 
                                    I
                                    (
                                    x
                                    )
                                 
                                 +
                                 ɛ
                              
                           
                        where I(x) is the real intensity, β is a multiplicative smooth bias field that causes intensity inhomogeneities due to the sensitivity of the reception coil and ɛ represents additive noise. While it is assumed that ɛ follows a Rician distribution [9], there have been different approaches to correct the bias field β. This is an important issue since voxels belonging to different tissues may be assigned with the same grey-level value when varying this term.

Following this model, the first step to recover the real intensity values would be to eliminate, or reduce, the noise signal since the bias field is assumed to affect the original intensity values independently of the noise. Therefore, after the skull stripping, we use an anisotropic diffusion filter that tends to preserve edges over smoother regions according to the gradient magnitude at each point. This filter is part of the Insight toolkit (ITK) software library 
                           2
                        
                        
                           2
                           Publicly available at http://www.itk.org.
                         and is implemented as an N-dimensional version of the classic Perona and Malik anisotropic diffusion equation for scalar images [26].

After noise reduction, the only issue from Eq. (1) that remains is the multiplicative bias field. Amongst the various bias correction algorithms that deal with this smooth multiplicative field, the well-known nonparametric nonuniform normalisation (N3) [33] has become a de facto standard for a variety of imaging acquisition strategies. Recently, Tustison et al. [37] proposed two improvements to this method and a new implementation renamed Nick's N3 (N4) based on the ITK library. These two major changes affect the B-splines modelling and the iterative optimisation scheme. Summarising, we decided to use the N4 bias correction filter combined with the anisotropic diffusion filter to recover the original intensity image I(x). We applied both filters to all the images (PD-w, T1-w, T2-w and FLAIR).

Rigid registration is usually sufficient when dealing with intra-subject medical applications, such as temporal studies of the same subject. However, when dealing with inter-subject applications, such as atlas matching, nonrigid algorithms can explain local anatomical variations between the template and the subject brain that global methods fail to reproduce [4].

In our proposal, we have decided to use the ICBM atlas [12] and implement with ITK one of the most common methods based on a multi-resolution approach [29], with a starting alignment using affine transformations to globally align the atlas template and the patient's scan, followed by a multi-resolution B-spline transformation. Within the registration framework, the mutual information metric is used as part of the optimisation process.

When the registration is completed, a similarity volume is computed comparing the moved atlas template and the patient's T1-w image. For both images, we create a patch of 3×3×3 for each voxel and compute a similarity metric between them. Bigger patches produce smoother similarity maps, decreasing the effect of the weighting in the probabilistic maps. The normalised cross-correlation metric is chosen over other similarity metrics due to its invariance to linear intensity brightness, and also to decouple the similarity volume process from the optimisation one and reduce the bias introduced when using the same metrics for both processes. Therefore, the similarity map ϕ(x) is normalised between 0 and 1 by definition and is defined by the following equation:


                        
                           
                              (2)
                              
                                 ϕ
                                 (
                                 x
                                 )
                                 =
                                 
                                    
                                       
                                          ∑
                                          
                                             i
                                             ∈
                                             {
                                             x
                                             ,
                                             
                                                N
                                                x
                                             
                                             }
                                          
                                       
                                       (
                                       
                                          I
                                          
                                             
                                                T
                                                1
                                             
                                          
                                       
                                       (
                                       i
                                       )
                                       −
                                       
                                          
                                             
                                                I
                                                ¯
                                             
                                          
                                          x
                                          
                                             
                                                T
                                                1
                                             
                                          
                                       
                                       )
                                       (
                                       
                                          π
                                          I
                                       
                                       (
                                       i
                                       )
                                       −
                                       
                                          
                                             
                                                π
                                                ¯
                                             
                                          
                                          x
                                          I
                                       
                                       )
                                    
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   ∈
                                                   {
                                                   x
                                                   ,
                                                   
                                                      N
                                                      x
                                                   
                                                   }
                                                
                                             
                                             
                                                
                                                   (
                                                   
                                                      I
                                                      
                                                         
                                                            T
                                                            1
                                                         
                                                      
                                                   
                                                   (
                                                   i
                                                   )
                                                   −
                                                   
                                                      
                                                         
                                                            I
                                                            ¯
                                                         
                                                      
                                                      x
                                                      
                                                         
                                                            T
                                                            1
                                                         
                                                      
                                                   
                                                   )
                                                
                                                2
                                             
                                          
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   ∈
                                                   {
                                                   x
                                                   ,
                                                   
                                                      N
                                                      x
                                                   
                                                   }
                                                
                                             
                                             
                                                
                                                   (
                                                   
                                                      π
                                                      I
                                                   
                                                   (
                                                   i
                                                   )
                                                   −
                                                   
                                                      
                                                         
                                                            π
                                                            ¯
                                                         
                                                      
                                                      x
                                                      I
                                                   
                                                   )
                                                
                                                2
                                             
                                          
                                       
                                    
                                 
                                 ,
                              
                           
                        where I
                        
                           T
                           1
                        (x) is the T1-w image of the patient (used as the fixed image), π
                        
                           I
                        (x) is the atlas template image (used as the moving image). 
                           
                              
                                 
                                    I
                                    ¯
                                 
                              
                              x
                              
                                 
                                    T
                                    1
                                 
                              
                           
                         and 
                           
                              
                                 
                                    π
                                    ¯
                                 
                              
                              x
                              I
                           
                         are the mean intensities of the 3D neighbouring area 
                           
                              N
                              x
                           
                         centred on pixel x for images I
                        
                           T
                           1
                        (x) and π
                        
                           I
                        (x) respectively, computed as follows:


                        
                           
                              (3)
                              
                                 
                                    
                                       
                                          I
                                          ¯
                                       
                                    
                                    x
                                    
                                       
                                          T
                                          1
                                       
                                    
                                 
                                 =
                                 
                                    1
                                    
                                       |
                                       
                                          N
                                          x
                                       
                                       |
                                    
                                 
                                 
                                    ∑
                                    
                                       i
                                       ∈
                                       {
                                       x
                                       ,
                                       
                                          N
                                          x
                                       
                                       }
                                    
                                 
                                 
                                    I
                                    
                                       
                                          T
                                          1
                                       
                                    
                                 
                                 (
                                 i
                                 )
                                 ,
                              
                           
                        
                        
                           
                              (4)
                              
                                 
                                    
                                       
                                          π
                                          ¯
                                       
                                    
                                    x
                                    I
                                 
                                 =
                                 
                                    1
                                    
                                       |
                                       
                                          N
                                          x
                                       
                                       |
                                    
                                 
                                 
                                    ∑
                                    
                                       i
                                       ∈
                                       {
                                       x
                                       ,
                                       
                                          N
                                          x
                                       
                                       }
                                    
                                 
                                 
                                    π
                                    I
                                 
                                 (
                                 i
                                 )
                                 .
                              
                           
                        
                     

The resulting similarity map expresses a local relation between the resulting transformation and the image we want to segment, highlighting those regions where the deformation adapts to the new case and darkening the regions where the optimisation process could not reach the desired accuracy. Therefore, this map can then be used as a weighting volume for the probabilistic atlases in a similar manner to the fusion step of multi-atlas propagation strategies [2,15].

As stated earlier, the original method from Dugas-Phocion et al. [10] proposed to segment the brain introducing the concept of partial volume effects [23]. To that extent, partial volume classes are introduced in what follows.

Within this framework, we define the pure tissue class set PT
                        ={CSF, GM, WM}. For each class c
                        ∈
                        PT, we assume its intensity distribution is modelled as the following multidimensional Gaussian distribution:


                        
                           
                              (5)
                              
                                 
                                    y
                                    c
                                 
                                 ∼
                                 N
                                 (
                                 
                                    μ
                                    c
                                 
                                 ,
                                 
                                    Σ
                                    c
                                 
                                 )
                                 .
                              
                           
                        
                     

As stated in Dugas-Phocion et al. [10] MRI noise can be approximated to a Gaussian distribution, making this distribution a common choice when modelling tissue distributions. Given two pure tissue classes, c
                        1 and c
                        2, a PV voxel x with a proportion α of class c
                        1 (and hence a proportion 1−
                        α of class c
                        2), its intensity I(x) is a random variable y
                        
                           PV
                         that can be computed as 
                           
                              y
                              PV
                           
                           =
                           α
                           
                              y
                              
                                 
                                    c
                                    1
                                 
                              
                           
                           +
                           (
                           1
                           −
                           α
                           )
                           
                              y
                              
                                 
                                    c
                                    2
                                 
                              
                           
                        . Considering all the PV voxels, α is uniformly distributed, however, if α is set as a constant, y
                        
                           PV
                         follows the subsequent Gaussian distribution:


                        
                           
                              (6)
                              
                                 
                                    y
                                    PV
                                 
                                 ∼
                                 N
                                 (
                                 α
                                 
                                    μ
                                    
                                       
                                          c
                                          1
                                       
                                    
                                 
                                 +
                                 (
                                 1
                                 −
                                 α
                                 )
                                 
                                    μ
                                    
                                       
                                          c
                                          2
                                       
                                    
                                 
                                 ,
                                 
                                    α
                                    2
                                 
                                 
                                    Σ
                                    
                                       
                                          c
                                          1
                                       
                                    
                                 
                                 +
                                 
                                    
                                       (
                                       1
                                       −
                                       α
                                       )
                                    
                                    2
                                 
                                 
                                    Σ
                                    
                                       
                                          c
                                          2
                                       
                                    
                                 
                                 )
                              
                           
                        
                     

We assume that the pure tissue distributions that compose the partial volume classes are independent, as was previously addressed and discussed in González Ballester et al. [23]. Since we assume that the bias correction step reduces the effect of intensity inhomogeneities and the underlying tissues have no relationship, we can assume that the intensity distributions obtained using an MRI scanning machine are also independent.

Dugas-Phocion et al. [10] and Souplet et al. [35] decided to sample α at different constant values in the range [0, 1] and set c
                        1 and c
                        2 as CSF and GM. A constant for the number of PV classes was defined in order to select those proportions. Furthermore, they introduced two different outlier classes to deal with imaging artefacts. For instance, Dugas-Phocion et al. defined an outlier class to differentiate between what the atlas considers as CSF but is actually a vessel, while Souplet et al. also defined a pure outlier class based on the Mahalanobis distance.

While these two strategies reduce the variance of the PV and CSF classes, they create small clusters that do not provide extra information and can sometimes collapse and become an empty set. For example, vessels may not be visible in low resolution images or may be represented by only a few voxels. Therefore, we simplified the partial volume approach fixing α to 0.5 and using only a PV class. In fact, we observed that most artefacts and lesions are classified inside this class, as well as the interfaces between CSF and GM.

Initialisation is a crucial aspect of the EM algorithm. Without proper initial parameters the algorithm may take longer to converge or, even worse, reach a local maximum. Commonly, distribution parameters are estimated either semi-automatically or automatically, and the algorithm starts in the expectation step. However, probability maps (such as atlases) can also be used to estimate the initial tissue parameters as part of the maximisation step. This is the case in tissue segmentation approaches that rely on atlas-based segmentation. For instance, Souplet et al., used the registered atlas for pure tissue classes and, afterwards, PV class parameters were calculated following Eq. (6).

However, atlas registration may cause several errors close to the cortex region even when using deformable registration. This is due to the high spatial variability caused by the gyri and sulci of the brain. Moreover, lesions are usually masked inside WM due to their nonexistence in healthy tissue atlases, even though they do not share the same intensity distribution.

Therefore, initial estimates relying solely on the probabilistic maps after registration may be corrupted by those errors, causing biased initial estimates for the mean and a high variability for each tissue. While those issues can later be overcome with several iterations, reducing them decreases computation time and improves convergence. In our proposal, we combine the atlas probabilities with the similarity map computed during registration and set a threshold T
                           
                              π
                            to select only those atlas probabilities that are meaningful to the class. As a consequence, not all the voxels are used to initialise the model.

In the expectation step, the probability of belonging to the different classes of each voxel is updated with the application of Bayes’ rule:


                           
                              
                                 (7)
                                 
                                    p
                                    (
                                    c
                                    |
                                    I
                                    (
                                    x
                                    )
                                    )
                                    =
                                    
                                       
                                          p
                                          (
                                          I
                                          (
                                          x
                                          )
                                          |
                                          c
                                          )
                                          p
                                          (
                                          c
                                          )
                                       
                                       
                                          p
                                          (
                                          I
                                          (
                                          x
                                          )
                                          )
                                       
                                    
                                    ,
                                 
                              
                           
                           
                              
                                 (8)
                                 
                                    p
                                    (
                                    I
                                    (
                                    x
                                    )
                                    )
                                    =
                                    
                                       ∑
                                       
                                          c
                                          =
                                          1
                                       
                                       C
                                    
                                    p
                                    (
                                    I
                                    (
                                    x
                                    )
                                    |
                                    c
                                    )
                                    p
                                    (
                                    c
                                    )
                                    .
                                 
                              
                           being C the total number of classes. As we explained before, each class (including the partial volume class) follows a Gaussian distribution with parameters θ
                           
                              c
                           
                           ={μ
                           
                              c
                           , Σ
                              c
                           }, where c
                           ∈{CSF, GM, WM, PV}. Therefore, p(I(x)|c) can be estimated using the following probability density function:


                           
                              
                                 (9)
                                 
                                    
                                       
                                          
                                             p
                                             ˆ
                                          
                                       
                                       i
                                    
                                    (
                                    I
                                    (
                                    x
                                    )
                                    |
                                    c
                                    ,
                                    
                                       
                                          
                                             θ
                                             ˆ
                                          
                                       
                                       c
                                       
                                          i
                                          −
                                          1
                                       
                                    
                                    )
                                    =
                                    
                                       
                                          
                                             e
                                             
                                                −
                                                
                                                   1
                                                   2
                                                
                                                
                                                   
                                                      (
                                                      I
                                                      (
                                                      x
                                                      )
                                                      −
                                                      
                                                         
                                                            
                                                               μ
                                                               ˆ
                                                            
                                                         
                                                         c
                                                         
                                                            i
                                                            −
                                                            1
                                                         
                                                      
                                                      )
                                                   
                                                   t
                                                
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            
                                                               Σ
                                                               ˆ
                                                            
                                                         
                                                         c
                                                         
                                                            i
                                                            −
                                                            1
                                                         
                                                      
                                                      )
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   (
                                                   I
                                                   (
                                                   x
                                                   )
                                                   −
                                                   
                                                      
                                                         
                                                            μ
                                                            ˆ
                                                         
                                                      
                                                      c
                                                      
                                                         i
                                                         −
                                                         1
                                                      
                                                   
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      (
                                                      2
                                                      π
                                                      )
                                                   
                                                   D
                                                
                                                |
                                                
                                                   Σ
                                                   c
                                                
                                                |
                                             
                                          
                                       
                                    
                                    ,
                                 
                              
                           where 
                              
                                 
                                    
                                       p
                                       ˆ
                                    
                                 
                                 i
                              
                              (
                              I
                              (
                              x
                              )
                              |
                              c
                              ,
                              
                                 
                                    
                                       θ
                                       ˆ
                                    
                                 
                                 c
                                 
                                    i
                                    −
                                    1
                                 
                              
                              )
                           , is the estimation of p(I(x)|c) at iteration i with the parameters 
                              
                                 
                                    
                                       θ
                                       ˆ
                                    
                                 
                                 c
                                 
                                    i
                                    −
                                    1
                                 
                              
                            estimated at iteration i
                           −1, and D is the number of features. In our case D
                           =3, since we use T1-w, PD-w, and T2-w images, the most commonly used MR images for tissue and lesion segmentation.

To compute the priors for each class p(c), Dugas-Phocion et al. proposed two different approaches. If probabilistic atlases are available for all classes, then 
                              p
                              (
                              c
                              )
                              =
                              
                                 π
                                 c
                                 P
                              
                           , where 
                              
                                 π
                                 c
                                 P
                              
                            represents the probabilistic map for the class c. On the other hand, when no atlases are available, p(c) is re-estimated at each iteration using the following equation:


                           
                              
                                 (10)
                                 
                                    
                                       
                                          
                                             p
                                             ˆ
                                          
                                       
                                       i
                                    
                                    (
                                    c
                                    )
                                    =
                                    
                                       ∑
                                       
                                          x
                                          =
                                          1
                                       
                                       
                                          
                                             N
                                             voxels
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             
                                                i
                                                −
                                                1
                                             
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          x
                                          )
                                          )
                                       
                                       
                                          
                                             N
                                             voxels
                                          
                                       
                                    
                                    ,
                                 
                              
                           where N
                           
                              voxels
                            is the total number of voxels. The first approach, introduces a local estimate for each voxel, imposing contextual and spatial constraints, while the second one is a global estimate for all the voxels. However, no hybrid approach was proposed by either Dugas-Phocion et al. or Souplet et al. for when some probability atlases are present (i.e. pure tissue classes). Therefore, we propose to create a PV atlas defined as:


                           
                              
                                 (11)
                                 
                                    
                                       π
                                       PV
                                       P
                                    
                                    (
                                    x
                                    )
                                    =
                                    
                                       1
                                       2
                                    
                                    (
                                    
                                       π
                                       CSF
                                       P
                                    
                                    (
                                    x
                                    )
                                    +
                                    
                                       π
                                       GM
                                       P
                                    
                                    (
                                    x
                                    )
                                    )
                                    ,
                                 
                              
                           since we defined the class PV as an equal proportion of both CSF and GM. With this new atlas, we finally have a probability map for each class that can be used as a local prior probability. However, the probability maps must be normalised again since 
                              
                                 ∑
                                 
                                    c
                                    =
                                    1
                                 
                                 C
                              
                              
                                 π
                                 c
                                 P
                              
                              (
                              x
                              )
                              =
                              1
                           .

Registration errors are common when registering a template to a new image. These errors arise from differences in anatomy that cannot be captured by the optimisation procedure and increase when dealing with an outlier class, such as MS lesions, that is not present in the atlas template. To take these errors into account, we compute a similarity map as explained in Section 2.4 to weight the probability maps as priors. However, to reduce the effect of the atlas on those regions where anatomical differences are present, we use another prior estimation since the weighting is applied equally to all classes for each voxel. Therefore, we propose the introduction of a simple neighbouring factor as expressed by the following equation:


                           
                              
                                 (12)
                                 
                                    
                                       
                                          
                                             p
                                             ˆ
                                          
                                       
                                       i
                                    
                                    (
                                    c
                                    )
                                    =
                                    ϕ
                                    (
                                    x
                                    )
                                    
                                       π
                                       c
                                       P
                                    
                                    (
                                    x
                                    )
                                    +
                                    (
                                    1
                                    −
                                    ϕ
                                    (
                                    x
                                    )
                                    )
                                    
                                       ∑
                                       
                                          j
                                          ∈
                                          
                                             N
                                             x
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             
                                                i
                                                −
                                                1
                                             
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          j
                                          )
                                          )
                                       
                                       
                                          |
                                          
                                             N
                                             x
                                          
                                          |
                                       
                                    
                                    .
                                 
                              
                           where ϕ(x) represents the similarity map, 
                              
                                 N
                                 x
                              
                            represents the 3D neighbouring voxels of x, and 
                              
                                 
                                    
                                       p
                                       ˆ
                                    
                                 
                                 
                                    i
                                    −
                                    1
                                 
                              
                              (
                              c
                              |
                              I
                              (
                              j
                              )
                              )
                            represents the probability of voxel j of pertaining to class c computed at the previous iteration.

In the maximisation step, the parameters of each class are computed from the voxels’ intensities and their probabilities of belonging to the different classes. The partial volume class parameters are obtained as a proportion of the pure tissue parameters.

A common way to compute the mean and covariance matrix is to use the maximum likelihood estimator (MLE) [10,35]:


                           
                              
                                 (13)
                                 
                                    
                                       
                                          θ
                                          ˆ
                                       
                                       c
                                    
                                    =
                                    
                                       
                                          arg
                                          
                                          max
                                       
                                       
                                          
                                             θ
                                             c
                                          
                                       
                                    
                                    
                                       ∏
                                       
                                          x
                                          =
                                          1
                                       
                                       
                                          
                                             N
                                             voxels
                                          
                                       
                                    
                                    p
                                    (
                                    I
                                    (
                                    x
                                    )
                                    |
                                    
                                       θ
                                       c
                                    
                                    )
                                    .
                                 
                              
                           
                        

However, the MLE is sensitive to outliers and, as a consequence, one of the parameters can become arbitrarily large. García-Lorenzo et al. [14] proposed using a trimmed likelihood estimator to reduce the effect of those outliers. This new estimator uses the Mahalanobis distance to discard those voxels that could be considered outliers when computing the Gaussian parameters.

In our approach, we use an aproximation of such estimator where a probability threshold is used instead of the Mahalanobis distance to compute the class parameters 
                              
                                 
                                    θ
                                    ˆ
                                 
                                 c
                                 i
                              
                            as follows:


                           
                              
                                 (14)
                                 
                                    
                                       
                                          μ
                                          ˆ
                                       
                                       c
                                       i
                                    
                                    =
                                    
                                       
                                          
                                             ∑
                                             
                                                x
                                                ∈
                                                
                                                   
                                                      X
                                                      ˜
                                                   
                                                
                                             
                                          
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             i
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          x
                                          )
                                          )
                                          I
                                          (
                                          x
                                          )
                                       
                                       
                                          
                                             ∑
                                             
                                                x
                                                ∈
                                                
                                                   
                                                      X
                                                      ˜
                                                   
                                                
                                             
                                          
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             i
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          x
                                          )
                                          )
                                       
                                    
                                    ,
                                 
                              
                           
                           
                              
                                 (15)
                                 
                                    
                                       
                                          Σ
                                          ˆ
                                       
                                       c
                                       i
                                    
                                    =
                                    
                                       
                                          
                                             ∑
                                             
                                                x
                                                ∈
                                                
                                                   
                                                      X
                                                      ˜
                                                   
                                                
                                             
                                          
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             i
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          x
                                          )
                                          )
                                          
                                             
                                                (
                                                I
                                                (
                                                x
                                                )
                                                −
                                                
                                                   
                                                      μ
                                                      ˆ
                                                   
                                                   c
                                                   i
                                                
                                                )
                                             
                                             t
                                          
                                          (
                                          I
                                          (
                                          x
                                          )
                                          −
                                          
                                             
                                                μ
                                                ˆ
                                             
                                             c
                                             i
                                          
                                          )
                                       
                                       
                                          
                                             ∑
                                             
                                                x
                                                ∈
                                                
                                                   
                                                      X
                                                      ˜
                                                   
                                                
                                             
                                          
                                          
                                             
                                                
                                                   p
                                                   ˆ
                                                
                                             
                                             i
                                          
                                          (
                                          c
                                          |
                                          I
                                          (
                                          x
                                          )
                                          )
                                       
                                    
                                    ,
                                 
                              
                           
                           
                              
                                 (16)
                                 
                                    
                                       
                                          X
                                          ˜
                                       
                                    
                                    =
                                    {
                                    x
                                    :
                                    
                                       
                                          
                                             p
                                             ˆ
                                          
                                       
                                       i
                                    
                                    (
                                    c
                                    |
                                    I
                                    (
                                    x
                                    )
                                    )
                                    >
                                    
                                       T
                                       π
                                    
                                    }
                                    ,
                                 
                              
                           where T
                           
                              π
                            is the probability threshold used during the initialisation step.

Lesions appear hyperintense in FLAIR images. Moreover, GM voxels, the normal appearing tissue with the highest intensity in these images, have a darker distribution than lesion voxels. As a consequence, there is a noticeable difference between normal appearing tissues and lesions in these images. Therefore, lesions that are misclassified by the EM algorithm are actually hyperintense outliers of the GM FLAIR intensity distribution.

In order to find a threshold for the FLAIR image, we first assume that GM intensities follow a Gaussian distribution in the FLAIR image (as we did for the other MRI images to segment the tissues). We also assume that lesions are hyperintense outliers of this distribution. With these two assumptions, we can estimate a threshold T
                           
                              F
                            as follows:


                           
                              
                                 (17)
                                 
                                    
                                       T
                                       F
                                    
                                    =
                                    
                                       μ
                                       GM
                                       F
                                    
                                    +
                                    γ
                                    
                                       σ
                                       GM
                                       F
                                    
                                    ,
                                 
                              
                           where the 
                              
                                 μ
                                 GM
                                 F
                              
                            and 
                              
                                 σ
                                 GM
                                 F
                              
                            are the distribution parameters of GM on the FLAIR image and γ is an empirical parameter used to determine the outliers.

To estimate the tissue parameters, the GM mask, obtained in the previous step, is applied to the FLAIR image to compute a histogram (see Fig. 2
                           ). Since lesions are usually part of the GM mask (due to their intensity similarities in PD-w and T2-w images), the histogram is biased by the high lesion intensities. This bias does not affect the peak of the histogram, which is used to define the mean, however, it can affect the estimation of the standard deviation. Therefore, we use the full width at half maximum (FWHM) expression to compute it [7].

Upon obtaining 
                              
                                 μ
                                 GM
                                 F
                              
                            and 
                              
                                 σ
                                 GM
                                 F
                              
                            and using them to compute T
                           
                              F
                            by means of Eq. (17), we apply it to the FLAIR image to obtain an initial lesion mask where other hyperintense artefacts are also included. This mask must be refined, since a large number of false positive lesions are usually found.

After thresholding, the mask is relabelled in order to divide it into different regions. A region is defined as a set of voxels that are connected using a 3D neighbourhood cube of connectivity 26. That means that 2 voxels belong to the same region if they are directly connected in a 3D space. We decided to use a region-wise refinement step [1,7,27] to reduce FP in terms of detection due to artefacts.

In order to differentiate lesions from other regions, we define a set of rules that are true for white matter lesions (WML):
                              
                                 •
                                 
                                    Lesions are mostly classified as WM and GM-based classes (PV and pure GM). In the case of WM, most lesions share a similar intensity profile to that tissue in T1-w images and have a high probability in the WM map (due to registration limitations); while in the case of GM, lesions share the same intensity profile in T2-w and PD-w images. Furthermore, hypointense lesions share the same intensity profile in T1-w images and present low values in the similarity map (weighting down the atlas probabilities during segmentation). To determine if a region follows this rule, a positive mask (containing WM, PV, and pure GM) and a negative mask (containing the background and all other tissues) are defined and for each region the proportion between positively and negatively masked voxels is computed. If this proportion is higher than the user-defined threshold T
                                    
                                       ω
                                       
                                          t
                                       
                                    , the region is labelled as WML.


                                    Lesions are surrounded by WM. We are only focusing on WML, therefore all lesion regions should be surrounded (mostly) by WM voxels. To determine if a region follows this rule, a positive mask (containing only WM) and a negative mask (containing the background and all other tissues) are defined and for each region the proportion between all its positive and negative neighbouring voxels is computed. If this proportion is higher than a user-defined threshold 
                                       
                                          T
                                          
                                             
                                                ω
                                                N
                                             
                                          
                                       
                                    , the region is labelled as WML.


                                    Lesions should not be present between the ventricles. One of the typical MS lesion locations is the surrounding of the ventricles. However, these lesions rarely appear between them and hyperintense regions in these areas are usually due to artefacts. Therefore, we remove all the regions that are close to the centre of the brain (which is usually between the ventricles).


                                    Lesions should be of a minimum size. Due to noise and inhomogeneities, some voxels may present random high intensities. These voxels are usually corrected during the preprocessing, however, some of them might still be considered as lesions after thresholding the FLAIR image. To remove these small outliers, we discard all regions that do not conform to a minimum size.

Finally, all the regions discarded according to one (or more) of these rules are reclassified according to the tissue segmentation. An example of the final segmentation (including lesions and tissues) is presented in Fig. 3
                           .

@&#EXPERIMENTAL RESULTS@&#

We separate the evaluation measures between regionwise measures that evaluate the detection and voxelwise measures that evaluate the segmentation.

Detection is the most important process in clinical practice since radiologists usually count the number of lesions instead of looking at the total lesion volume. Therefore, it is important to first evaluate if a method can detect all the lesions of a given case. Consequently one common measure is the true positive fraction (TPF):


                           
                              
                                 (18)
                                 
                                    
                                       TPF
                                       r
                                    
                                    =
                                    
                                       
                                          |
                                          
                                             A
                                             r
                                          
                                          ∩
                                          
                                             M
                                             r
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             M
                                             r
                                          
                                          |
                                       
                                    
                                    ,
                                 
                              
                           where |A
                           
                              r
                           
                           ∩
                           M
                           
                              r
                           | represents the number of lesions detected by the algorithm that overlap by at least one voxel with a manually annotated lesion, and |M
                           
                              r
                           | is the total number of manually annotated lesions. This relative measure provides information about how many lesions are detected (and missed): a value of 0 indicates that no lesion was found, while a value of 1 indicates that all the lesions were correctly detected. However, it does not take into account how many of the lesions detected are actually lesions. Therefore, it is also common to estimate the false positive fraction (FPF):


                           
                              
                                 (19)
                                 
                                    
                                       FPF
                                       r
                                    
                                    =
                                    
                                       
                                          |
                                          
                                             A
                                             r
                                          
                                          ∩
                                          ¬
                                          
                                             M
                                             r
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             A
                                             r
                                          
                                          |
                                       
                                    
                                    ,
                                 
                              
                           where |A
                           
                              r
                           
                           ∩¬
                           M
                           
                              r
                           | represents the number of lesions detected by the algorithm that do not overlap with any manually annotated lesion, and |A
                           
                              r
                           | is the total number of detected lesions. Similarly to the TPF measure, the FPF is a relative measure. A value of 0 indicates that all the lesions detected are actually lesions, while a value of 1 indicates that all the regions detected are not lesions. In order to complement these two measures, we also compute the Dice similarity coefficient (DSC):
                              
                                 (20)
                                 
                                    
                                       DSC
                                       r
                                    
                                    =
                                    
                                       
                                          2
                                          ·
                                          |
                                          
                                             A
                                             r
                                          
                                          ∩
                                          
                                             M
                                             r
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             A
                                             r
                                          
                                          |
                                          +
                                          |
                                          
                                             M
                                             r
                                          
                                          |
                                       
                                    
                                    .
                                 
                              
                           
                        

This measure gives a high value to the TP detections, while also taking into account missed and wrongly detected lesions, and its values vary between 
                              
                                 
                                    0
                                    ,
                                    1
                                 
                              
                           , where 1 denotes the exact similarity and 0 denotes that no lesion was correctly detected. To further ease the interpretation of the DSC, we can utilize the relationship between the DSC and the Kappa coefficient [11]. Zijdenbos et al. [38] showed that under certain assumptions, that apply in our case, (independent inter-raters and a higher number of TN than the sum of TP, FP and FN) the DSC is asymptotically equal to the Kappa coefficient. According to Landis et al. [20], the Kappa coefficient values can be divided into six categories: less than 0, “No agreement”; 0–0.2, “Slight agreement”; 0.2–0.4, “Fair agreement”; 0.4–0.6, “Moderate agreement”; 0.6–0.8, “Substantial agreement”; and 0.8–1.0, “Almost perfect agreement”.

Even though we presented the previous measures to validate detection, they can also be used to evaluate the segmentation. The only difference is that instead of looking at detected regions and manually annotated lesions, we have to compare the voxels labelled as lesion by the segmentation method and those labelled by the expert. Therefore, the previous equations are redefined as follows:


                           
                              
                                 (21)
                                 
                                    
                                       TPF
                                       v
                                    
                                    =
                                    
                                       
                                          |
                                          
                                             A
                                             v
                                          
                                          ∩
                                          
                                             M
                                             v
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             M
                                             v
                                          
                                          |
                                       
                                    
                                    ,
                                 
                              
                           
                           
                              
                                 (22)
                                 
                                    
                                       FPF
                                       v
                                    
                                    =
                                    
                                       
                                          |
                                          
                                             A
                                             v
                                          
                                          ∩
                                          ¬
                                          
                                             M
                                             v
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             A
                                             v
                                          
                                          |
                                       
                                    
                                    ,
                                 
                              
                           
                           
                              
                                 (23)
                                 
                                    
                                       DSC
                                       v
                                    
                                    =
                                    
                                       
                                          2
                                          ·
                                          |
                                          
                                             A
                                             v
                                          
                                          ∩
                                          
                                             M
                                             v
                                          
                                          |
                                       
                                       
                                          |
                                          
                                             A
                                             v
                                          
                                          |
                                          +
                                          |
                                          
                                             M
                                             v
                                          
                                          |
                                       
                                    
                                    ,
                                 
                              
                           where 
                              |
                              
                                 A
                                 v
                              
                              ∩
                              
                                 M
                                 v
                              
                              |
                            represents the number of voxels labelled as lesion by both the expert and the segmentation, 
                              |
                              
                                 A
                                 v
                              
                              ∩
                              ¬
                              
                                 M
                                 v
                              
                              |
                            represents the number of voxels mislabelled as lesion, 
                              |
                              
                                 A
                                 v
                              
                              |
                            represents the total number of voxels automatically segmented as lesion and 
                              |
                              
                                 M
                                 v
                              
                              |
                            represents the total number of voxels in the ground truth.

Finally, we compute also the average surface distance (ASD) [36], which provides a different evaluation of the segmentation. For each bordering voxel of a segmentation (manual or automatic) the closest bordering voxel of the other segmentation is found and the distance between them is computed. Finally, all the distances are averaged to compute the final ASD. A value of 0 indicates a perfect overlap between the ground truth and the segmentation obtained. This measure does not check if the lesion is detected in both segmentations; therefore, bordering voxels for FP and FN lesions will always obtain values higher than 0.

In this section we will analyse the choice of parameters for each step of the presented pipeline.

For the initial tissue segmentation, a convergence parameter was introduced. This parameter, which is a probability threshold, discards voxels with low probabilities to reduce the variability of the estimated Gaussian distributions for pure tissues and improve convergence. Theoretically, a probability lower than 0.5 would indicate that the voxel has a higher chance of not being part of the tissue, and, therefore, it should not be included during the parameter estimation. Higher probability thresholds provide thicker distributions, with their probability density concentrated close to the mean. However, if this threshold is set too high, the real tissue variability might be misrepresented by a small set of the data. Therefore, we propose setting the T
                           
                              π
                            threshold to 0.75, which is an intermediate value.

However, as pointed out previously, this initial tissue segmentation presents a misclassification of lesion voxels due to the lack of a lesion class. As a consequence, a second step to resegment these lesions proved essential. In our case, a thresholding followed by a refinement based on rules is used to obtain this lesion segmentation.

We defined lesions as hyperintense GM outliers in FLAIR. Moreover, we assumed that the pure GM tissue follows a Gaussian distribution and is the most intense, normal appearing tissue in FLAIR. In order to differentiate between lesions and tissues, we proposed using a thresholding technique based on these assumptions were the threshold is obtained using the mean and standard deviation of GM in FLAIR. The equation of this threshold depends on a positive empirical parameter γ.

According to the formal definition of a Gaussian distribution G(μ, σ), given a random variable 
                              Y
                              ∼
                              G
                              (
                              μ
                              ,
                              σ
                              )
                           , there is a 0.5 probability that a random sample 
                              y
                              ∈
                              Y
                            will have a value higher than μ. This probability is reduced to 0.022 for a value higher than μ
                           +2σ. Extrapolating this to our case, theoretically, 97.8% of GM voxels should have a value under 
                              
                                 μ
                                 GM
                                 F
                              
                              +
                              2
                              
                                 σ
                                 GM
                                 F
                              
                           , while outlier voxels (not belonging to GM) should present a higher intensity value. Therefore, theoretically, a value greater or equal to 2 could be used for γ.

In practice, not all the lesion voxels are actually outliers (due to partial volume effects or inhomogeneities in extreme slices) and not all the hyperintensities are actually lesions. To fix the second issue, we used the above mentioned parameters as part of a refinement step. On the other hand, to include as many lesion voxels as possible, σ must be set empirically (preferably between 2 and 3). Since the refinement step may mask the real effect of the thresholding parameter, in what follows, we present an exhaustive comparison of the result of varying γ between 0 and 3 without refinement.


                           Fig. 4
                            offers a summary of the effect of varying γ to estimate the threshold in terms of detection and segmentation. For each γ value, a threshold was obtained in all 45 cases which was evaluated using the TPF and FPF measures in terms of detection and segmentation. Looking at the obtained detection measures we observed the FPF slowly decreased as the threshold increased. However, the TPF presented a different tendency: there was an initial increase (until γ
                           =2), and then it stabilised. This phenomenon is explained by how the TPF is computed. To estimate the number of detected TP, the automatically segmented lesions are counted only once. Therefore, if a big lesion contains 3 different GT lesions, only 1 TP will be counted. As the threshold increases, this big lesion tends to split into smaller lesions, increasing the detection rate.

On the other hand, analysing the segmentation values, we observed both FPF and TPF decreased as the threshold increased, even though the TPF decreased at a higher rate. This phenomenon is caused by the decrease in number of voxels segmented by the higher threshold. This also proves how most artefacts segmented as lesions are also hyperintense, and hence, more information is needed to differentiate them from real lesion voxels.

Due to γ
                           =2 being the highest TPF point in terms of detection, we set this value as default and reduce the elevated FPF (both in terms of detection and segmentation) using the refinement step.

As mentioned before, lesions are misclassified as a tissue during the first step of this approach. Due to their intensities, lesions tend to be classified as either WM or a GM-related class as demonstrated in Fig. 5
                           . In other words, lesion voxels are rarely classified as CSF (on average only 1.42% of the voxels). Therefore, the threshold T
                           
                              ω
                              
                                 t
                              
                           , according to the first rule stating that lesion areas should not contain CSF, can be restrictive and can be set to 0.9 to discard those lesions that are completely inside CSF. Moreover, a similar threshold is also used when checking the neighbouring voxels of the lesion areas. As observed in Fig. 5, most of the voxels surrounding lesions are, in fact, WM voxels (with an average of 63.98% and a minimum case of 36.70% of the voxels). Hence, a low 
                              
                                 T
                                 
                                    
                                       ω
                                       N
                                    
                                 
                              
                            (0.6 in our experiments), would be adequate to discard voxels completely inside GM or CSF and keep lesions that are close to the ventricles or the cortex.

While the bar plots presented in Fig. 5 comprise only cases from our database, a clear tendency in both phenomena is observed, even though the cases are obtained from three different scanning machines with different lesion load. Consequently, it is expected that new cases should also present a similar behaviour.

The other parameter used as part of the refinement is the minimum size a lesion is allowed. In our experiments, we set this parameter to 10 voxels (representing 30mm3 approximately), which would approximately represent a cube with 3mm edges [5].

With the final parameter configuration, the computational cost of the whole pipeline per patient was in the order of minutes for the pre-processing stage and tissue segmentation, and less than a minute for the lesion segmentation step for the images of the three databases. The implementation of our pipeline was done in C++ using ITK, running all the experiments in a QuadCore 2.3Gz with 16Gb of RAM.

@&#EVALUATION@&#

To evaluate the method, we will use the parameter values presented in the previous section. First, we will present the results for this pipeline in terms of detection, followed by the results in terms of segmentation.


                           Fig. 6
                            presents the results in terms of detection for all the cases. The first plot, which is ordered by number of lesions in the GT, presents a regionwise comparison between the TPF and FPF for each case separated by hospitals, while the box plot presents the comparison for each hospital.

For all three hospitals, there is a clear tendency for the FPF to decrease as the lesion load increases. On the one hand, this tendency is explained due to the highest probability of correctly detecting lesions when there is a higher number of GT lesions. On the other hand, this tendency is also explained by the number of the measure. By being a proportional measure, the effect of a FP lesion in the measure is higher when there is a small number of detected lesions (which is indirectly related to the number of real lesions). This tendency can also be observed in the boxplot for H
                           1, which has the lowest number of GT lesions (774 as opposed to 1514 and 926 for H
                           2 and H
                           3 respectively). In any case, these results also demonstrate the strength of the refinement step. Before this refinement the mean FPF for any γ value exceeds 90% (see Fig. 4), while the mean FPF value for the final segmentation is 40.75%, (47.08%, 40.60% and 33.90% for H
                           1, H
                           2, and H
                           3 respectively).

On the other hand, looking at the TPF, there is no clear tendency for this measure for any hospital. Furthermore, when looking at the boxplots for each hospital, the results in terms of TPF are similar for H
                           1 and H
                           2, while H
                           3's obtains a much higher mean (38.25% and 40.56% compared to 55.22%) and median (32.94% and 43.75% compared to 58.93%).

Finally, Fig. 6 also shows the DSC in terms of detection for all cases. Once again, the first plot presents this measure for each case separated by hospitals and ordered by number of GT lesions, while the box plot presents the measure for each hospital. These two graphics, present a summary of the aforementioned characteristics. Due to the decreasing tendency for FPF as the number of GT lesions increases, as well as the TPF increasing tendency for H
                           1's cases, the DSC also increases alongside the number of GT lesions. Moreover, due to the lack of a clear tendency in terms of TPF for the other two hospitals, no tendency is observed for the DSC measure either. Furthermore, H
                           1's cases present the lowest DSC mean (0.39) and median (0.37), as well as a wider box, while the other two hospitals present a smaller box with H
                           3 presenting the highest mean of the two (0.62 as opposed to 0.49) and median (0.66 as opposed to 0.51). In categorical terms, H
                           1 shows a fair agreement, H
                           2 a moderate agreement, and H
                           3 a substantial agreement between manual and automated annotations.


                           Fig. 7
                            presents results in terms of segmentation for all the cases. The first plot, which is ordered by the total lesion load instead of the number of GT lesions, presents a voxelwise comparison between the TPF and FPF for each case separated by hospitals, while the box plot presents the comparison for each hospital.

Looking at the plot for each case, a tendency to decrease of the voxelwise FPF is also globally observed according to the lesion load. This decrease is strongly related to the FPF decrease in terms of detection. By removing FP lesions, many FP voxels are also removed. However, the mean FPF segmentation percentages are higher than the detection percentages for each hospital: H
                           1, which obtained a 47.08% for detection, presents a 78.27% for segmentation; H
                           2, which obtained a 40.60% for detection, presents a 62.07% for segmentation; and H
                           3, which obtained a 33.99% for detection, presents a 61.42%. In terms of TPF, only H
                           1 presents a clear tendency to increase when the total lesion volume increases. This can be explained by the small lesion load of most of this hospital's cases. This trend is not as clearly observed for the other two hospitals.

According to these two segmentation measures, and looking at the box plot, we can see that the best ranking hospitals in terms of TPF are H2 and H
                           3 which obtained a similar mean (51.73% and 53.93%, respectively) compared to 26.04% obtained for H
                           1, and median (53.64% and 58.41% compared to 23.42%). Similarly, the best ranking hospitals in terms of FPF are again H
                           2 and H
                           3, with the lowest mean and median (62.39% and 60.46%, respectively compared to 78.90% for H
                           1). For both measures, H
                           1's cases obtain the lowest scores, partially due to the low lesion load present in the data.

Closely related to these two measures, the DSC values for each case, separated by hospital, are also presented in Fig. 7. Similar to Fig. 6, the results observed in terms of voxelwise TPF and FPF can be summarised by this measure. For instance, there is a tendency for DSC to increase according to the lesion load of each hospital. This is partially due to the decrease in FPF, but is also strengthened for H
                           1 by the increase in the TPF. Furthermore, we observe how the worst ranking hospital for both TPF and FPF also obtains the worst ranking in terms of DSC, while the other two hospitals obtain similar results: H
                           1 scoring a 0.22 mean and 0.17 median; H
                           2 scoring a 0.43 mean and 0.45 median; and H
                           3 scoring a 0.44 mean and 0.45 median. According to the DSC-Kappa relationship, the values for the latter hospitals represent a moderate agreement between the proposed pipeline and the GT. Moreover, as observed in Fig. 7, the results obtained for most of the cases would be considered as moderate agreement between both the manual and automatic segmentation. In four cases, the agreement could be considered as substantial (with a maximum value of 0.73).

Finally, Fig. 7 also shows the boxplot for the average surface distance. The mean average surface distance for all cases was 7.57mm and the median 3.37mm. This difference is mainly caused by the bias of FP and FN detections having a higher impact in H
                           1's cases. Notice that this boxplot reinforce the results observed in the DSC segmentation values. On the one hand, H
                           1 scores the highest average surface distance (with a wide box) and the lowest average DSC per TP lesion. On the other hand, the boxes for the other two hospitals show better results, being similar to each other, with only slightly differences in their mean and median.

In this section we present a comparison between the proposed pipeline and two state of the art approaches, Souplet et al. [35] and Schmidt et al. (LST) [30]. The first approach was implemented as part of the SepINRIA software tool
                           3
                        
                        
                           3
                           SepINRIA software webpage, http://www-sop.inria.fr/asclepios/software/SepINRIA.
                        , while the second one has been recently integrated into the SPM software package
                           4
                        
                        
                           4
                           SPM refers to the Statistical Parametric Mapping software repository, http://www.fil.ion.ucl.ac.uk/spm/. The LST toolbox can be downloaded from http://www.applied-statistics.de/lst.html.
                        . A qualitative comparison between the three strategies with a slice from each hospital is presented in Fig. 8
                        . The approaches were tested in a leave-one-case-out in order to obtain the best parameters for each case.

Following the structure of the previous sections Fig. 9
                         summarises the results for the different strategies. The best results in terms of detection are obtained using the proposed pipeline and the LST approach, being slightly superior the LST for the first hospital and our proposed approach for H
                        2 and H
                        3 hospitals. Looking at the regionwise DSC, it is also clear that Souplet et al.'s approach obtained lower results. This approach is usually restrictive, causing low accuracy and a high number of FN. As a consequence, some of the detected lesions are actually artefacts, which in turn causes a high FPF. This issue is further accentuated when analysing the DSC measures. Part of this lower performance might also be explained by the fact that Souplet et al.'s strategy was optimised for 3T images.

Following with the segmentation DSC, the performance of LST and our pipeline is similar, while the results reveal that Souplet et al.'s approach obtains worse mean results and a higher variability. Regarding each hospital, the performance obtained for H
                        1 is lower than obtained for the other two hospitals, obtaining scores below 0.2 for the three methods. This is due to the low lesion load of the cases of this hospital. On the other hand, the results for hospitals H
                        2 and H
                        3 show similar median, minimum, and maximum values for the LST and the proposed pipeline. With the aim to provide a more detailed comparison between the performance of the proposed pipeline and LST, Fig. 10
                         illustrates the regionwise and voxelwise DSC obtained with both approaches for each individual case of the database. These plots show in more detail the aforementioned trends.

To complement the previous results, Fig. 9 also illustrates the comparison of the average surface distance. Again, similar performances are obtained by our pipeline and the LST approach. Souplet approach shows a higher variability. Comparing hospitals, the results obtained in the first hospital are again worse than the ones obtained in the other two, where LST and the proposed pipeline obtained similar and more consistent results.

@&#CONCLUSIONS@&#

In this paper we have presented an approach that combines the atlas information with the intensity images to, first, produce a tissue segmentation estimate and, then, use this information as part of an outlier thresholding approach to segment lesions. The initial tissue segmentation is conducted as part of a modified EM approach where 4 main classes are identified: CSF, GM, WM, and PV. Once we obtain this initial tissue segmentation using T1-w, T2-w and PD-w images, we apply the GM mask to the FLAIR image, where lesions appear hyperintense in contrast with all the other tissues, to compute its distribution parameters from the histogram. Afterwards, a threshold based on those two parameters is applied to the image to obtain an initial lesion mask. This mask is further refined to reduce false positives by applying a set of rules based on MS lesion properties.

We have presented the results for the proposed pipeline with a database of 45 patients from 3 different hospitals with different scanner machines. In general, detection results were fairly higher than segmentation results due to the false positive reduction step, obtaining a good agreement between manual annotations and automatic segmentations. Moreover, we include a comparison with two of the most promising methods of the state-of-the-art. After a thorough numerical analysis, the proposed pipeline presented better detection results and similar segmentation results to those from LST. The improvement over the other two approaches can be explained by our contributions to improve the tissue estimation step by including atlas weighting using a similarity map and neighbourhood information, as well as the introduction of a false positive reduction step based on a regionwise analysis of the automatically segmented lesions.

All authors in this paper have no potential conflict of interests.

@&#ACKNOWLEDGEMENTS@&#

This study has been supported by the Instituto de Salud Carlos III Grant PI09/91018, and Grant VALTEC09-1-0025 from the Generalitat de Catalunya, and by the Fundació Esclerosi Múltiple de Catalunya through the CEM-Cat 2011 Grant Miquel Martí i Pol. E. Roura holds a BR-UdG2013 grant.

@&#REFERENCES@&#

