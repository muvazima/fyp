@&#MAIN-TITLE@&#A computerized framework for monitoring four-dimensional dose distributions during stereotactic body radiation therapy using a portal dose image-based 2D/3D registration approach

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           We have investigated a framework for monitoring 4D dose distributions.


                        
                        
                           
                           A portal dose image-based 2D/3D registration has been proposed.


                        
                        
                           
                           Dose errors can be calculated to ensure the quality of the radiation therapy.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Stereotactic body radiation therapy

Four-dimensional dose distribution

2D/3D registration

Optimization

@&#ABSTRACT@&#


               
               
                  A computerized framework for monitoring four-dimensional (4D) dose distributions during stereotactic body radiation therapy based on a portal dose image (PDI)-based 2D/3D registration approach has been proposed in this study. Using the PDI-based registration approach, simulated 4D “treatment” CT images were derived from the deformation of 3D planning CT images so that a 2D planning PDI could be similar to a 2D dynamic clinical PDI at a breathing phase. The planning PDI was calculated by applying a dose calculation algorithm (a pencil beam convolution algorithm) to the geometry of the planning CT image and a virtual water equivalent phantom. The dynamic clinical PDIs were estimated from electronic portal imaging device (EPID) dynamic images including breathing phase data obtained during a treatment. The parameters of the affine transformation matrix were optimized based on an objective function and a gamma pass rate using a Levenberg–Marquardt (LM) algorithm. The proposed framework was applied to the EPID dynamic images of ten lung cancer patients, which included 183 frames (mean: 18.3 per patient). The 4D dose distributions during the treatment time were successfully obtained by applying the dose calculation algorithm to the simulated 4D “treatment” CT images. The mean±standard deviation (SD) of the percentage errors between the prescribed dose and the estimated dose at an isocenter for all cases was 3.25±4.43%. The maximum error for the ten cases was 14.67% (prescribed dose: 1.50Gy, estimated dose: 1.72Gy), and the minimum error was 0.00%. The proposed framework could be feasible for monitoring the 4D dose distribution and dose errors within a patient's body during treatment.
               
            

@&#INTRODUCTION@&#

The aim of radiation therapy is to reduce the dose as low as possible to surrounding normal tissues, while concentrating the dose administered to target tumors. High-precision radiation therapies, such as stereotactic body radiation therapy (SBRT), have been employed to achieve this purpose. SBRT has several unique features, such as the delivery of large doses for small irradiation fields within several fractions (e.g. 48Gy/4fractions), and the use of seven to eight beam directions, including coplanar and non-coplanar beam arrangements for localized small tumors in the lung or liver [1]. It has been reported that the treatment outcome of radiation therapy has been similar to or better than that of surgery, depending on type of tumor, stage and location [2–4].

In SBRT, it is substantially necessary to ensure whether the high dose beam is correctly delivered with respect to geometrical and dosimetrical targeting according to the treatment plan. Regarding the geometrical targeting, if tumor location errors, such as patient setup errors, physiological motion, variations of tumors or organs occur at the treatment time, the location errors could result in increased normal tissue complication and decreased tumor control [5,6]. Therefore, in SBRT, electronic portal imaging device (EPID) dynamic images are acquired to verify the tumor location within the irradiation field during the treatment dose delivery. However, as for dosimetric targeting, it has not been verified whether the planned dose distribution has been accurately administered to the target during the treatment dose delivery. Therefore, it is essential to monitor four-dimensional (4D) dose distributions for the target and its surrounding normal tissues in the patients’ bodies during the treatment time in order to guarantee the quality of the radiation therapy.

A number of methods for estimating the dose distributions in patient bodies or phantoms during the treatment time have been developed [7–11]. The purpose of these methods was to estimate the 3D dose distributions in patient bodies or phantoms to verify the intensity-modulated radiation therapy (IMRT) plans. Several studies on 4D dose distributions obtained using four-dimensional computed tomography (4D-CT), which were affected by respiratory motion, have been reported [12–15]. A common approach of these studies was to apply dose calculation algorithms to breathing phase 4D-CT image sets, which were acquired under the free-breathing condition. These studies were based on the assumption that the breathing phase during the treatment time is very similar to that during 4D-CT scanning.

Gendrin developed a system of monitoring tumor motion by a real-time 2D/3D registration during radiotherapy [16]. The system can monitor three-dimensional tumor movements by registering 3D planning CT images to portal images, which were acquired during the treatment time [16]. In this study, we have proposed a computerized framework for monitoring 4D dose distributions during the SBRT using a portal dose image (PDI)-based 2D/3D registration approach.


                        Fig. 1
                         shows a conceptual diagram for monitoring 4D dose distributions during the treatment time. Fig. 2
                         shows a processing pipeline for monitoring 4D dose distributions using the PDI-based 2D/3D registration approach during the treatment delivery. The proposed framework mainly consists of the following four steps. First, a 2D dynamic clinical PDI was derived from the EPID dynamic image based on the deconvolution and convolution of lateral scatter kernels, and a pixel-to-dose conversion function. Second, a 2D planning PDI was obtained by calculating the total energy released per unit mass (TERMA) and applying a dose calculation algorithm for the 3D planning CT image. Third, simulated 4D “treatment” CT images were estimated by deforming 3D planning CT images by using affine transformation matrices so that a 2D planning PDI could be similar to a 2D dynamic clinical PDI at a certain time. The gamma pass rate was used as a similarity index. The parameters of the affine transformation matrices were optimized based on an objective function and a gamma pass rate by a Levenberg–Marquardt (LM) algorithm. Finally, 4D dose distributions during the treatment time were calculated by applying a dose calculation algorithm, i.e., a pencil beam convolution (PBC) algorithm, to simulated 4D “treatment” CT images.

This study was performed under a protocol approved by the institutional review board of our hospital. Ten patients with lung cancer, who were treated with SBRT from 2004 to 2005, were selected for this study. The patients (six males and four females) had a median age of 75 years (range, 51–84 years). Table 1
                         shows the characteristics of the ten cases evaluated in this study. All patients received a dose of 48Gy, prescribed at the isocenter in four fractions, with accelerating voltages of 6MV on linear accelerators (Clinac 21EX; Varian Medical Systems Inc., Palo Alto, USA). These patients were scanned by using a 4-slice CT scanner (Mx 8000; Philips, Amsterdam, The Netherlands) with 16-bit gray levels, a matrix size of 512×512pixels, and a slice thickness of 2.0mm. The treatment planning was performed by experienced radiation oncologists on a commercially available radiotherapy treatment planning system (Eclipse version 6.5; Varian Medical System Inc., Palo Alto, USA). The dynamic portal images were acquired on an EPID (Portal Vision aS-500; Varian Medical System Inc., Palo Alto, USA) using 6MV X-rays with an X-ray converter of amorphous silicon, a phosphor of terbium-activated gadolinium oxysulfide (Gd2O2S:Tb), a detection region of 400×300mm2, a matrix size of 512×384pixels, 16-bit gray levels, and a frame rate of 0.5 frames per second during SBRT. The average and total numbers of frames for the ten cases were 18.3 and 183, respectively. Our proposed framework was implemented in C, and performed by a general purpose personal computer, which was equipped with a 3.30GHz central processing unit (CPU) (Intel® Core™ i7-3960X CPU) and 32.0 gigabyte (GB) memory.

The dynamic clinical PDI was derived from an EPID dynamic image by applying the deconvolution and convolution of lateral scatter kernels, and a pixel-to-dose conversion function [17]. Fig. 3
                         shows a conceptual diagram for obtaining a dynamic clinical PDI. Algorithm 1 shows an algorithm for the production of the dynamic clinical PDI.
                           
                              Algorithm 1
                              
                                 An algorithm for the production of the dynamic clinical PDI.
                              
                              
                                 
                                 
                                 
                                    
                                       1.
                                       
                                          INPUT 
                                          i
                                          
                                             E
                                          : EPID dynamic image;
                                    
                                    
                                       2.
                                       
                                          
                                          
                                          
                                          k
                                          
                                             E
                                          : LSK in the EPID;
                                    
                                    
                                       3.
                                       
                                          
                                          
                                          
                                          k
                                          
                                             w
                                          : LSK of the water equivalent phantom;
                                    
                                    
                                       4.
                                       
                                          COMMENTS 
                                          p
                                          
                                             E
                                          : incident primary X-ray signal to the EPID;
                                    
                                    
                                       5.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          p
                                          
                                             w
                                          : incident primary X-ray dose to the water equivalent phantom;
                                    
                                    
                                       6.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          i
                                          
                                             w
                                          : X-ray dose in the water equivalent phantom;
                                    
                                    
                                       7.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          (Capital symbols indicate spatial frequency domains.)
                                    
                                    
                                       8.
                                       
                                          I
                                          
                                             E
                                          
                                          ←Fourier transform (i
                                          
                                             E
                                          ), K
                                          
                                             E
                                          
                                          ←Fourier transform (k
                                          
                                             E
                                          );
                                    
                                    
                                       9.
                                       
                                          //Calculation of the incident primary X-ray signal
                                       
                                    
                                    
                                       10.
                                       
                                          
                                             
                                                
                                                   P
                                                   E
                                                
                                                ←
                                                
                                                   
                                                      
                                                         I
                                                         E
                                                      
                                                   
                                                   
                                                      
                                                         K
                                                         E
                                                      
                                                   
                                                
                                             
                                          ;
                                    
                                    
                                       11.
                                       
                                          p
                                          
                                             E
                                          
                                          ←Inverse Fourier transform (P
                                          
                                             E
                                          );
                                    
                                    
                                       12.
                                       
                                          //Conversion of the X-ray signal into the X-ray dose
                                       
                                    
                                    
                                       13.
                                       
                                          p
                                          
                                             w
                                          
                                          ←Pixel-to-dose conversion function (p
                                          
                                             E
                                          );
                                    
                                    
                                       14.
                                       
                                          P
                                          
                                             w
                                          
                                          ←Fourier transform (p
                                          
                                             w
                                          ), K
                                          
                                             w
                                           ← Fourier transform (k
                                          
                                             w
                                          );
                                    
                                    
                                       15.
                                       
                                          //Calculation of the dynamic clinical PDI
                                       
                                    
                                    
                                       16.
                                       
                                          I
                                          
                                             w
                                          
                                          ←
                                          P
                                          
                                             w
                                          ·K
                                          
                                             w
                                          ;
                                    
                                    
                                       17.
                                       
                                          i
                                          
                                             w
                                          
                                          ←Inverse Fourier transform (I
                                          
                                             w
                                          );
                                    
                                    
                                       18.
                                       
                                          I
                                          
                                             c
                                          
                                          ←
                                          i
                                          
                                             w
                                          ;
                                    
                                    
                                       19.
                                       
                                          OUTPUT 
                                          I
                                          
                                             c
                                          : dynamic clinical PDI;
                                    
                                 
                              
                           
                        
                     

The lateral scatter kernel (LSK) was considered to be a function, which describes laterally scattered X-rays. In this study, the LSKs of EPID and the water equivalent phantom were calculated by a Monte Carlo simulation [18]. The number of histories was 108, which was used for estimation of the both LSKs in the Monte Carlo simulation. The uncertainty of the Monte Carlo simulation was less than 0.5%. In order to estimate the incident primary X-ray signal distributions to the EPID, the EPID dynamic images were deconvolved using the LSK of the EPID.

The incident primary X-ray signal to the EPID was converted into the incident primary X-ray dose to the water equivalent phantom using a pixel-to-dose conversion function.

The pixel-to-dose conversion function was estimated by using the EPID based on Chen's method [17]. The pixel-to-dose conversion function was experimentally measured using the EPID [18]. Errors of EPID dynamic image pixel value and absorbed dose in this measurement were ±0.02% and ±0.09%, respectively. Finally, dynamic clinical PDIs were calculated by convolution of the incident primary X-ray dose to the water equivalent phantom with the LSK of the water equivalent phantom.

The 2D planning PDI was estimated by calculating the TERMA and applying a dose calculation algorithm in a world coordinate system including a linear accelerator, the 3D planning CT image, and a virtual water phantom. Fig. 4
                         shows an illustration of a geometry used for the production of the planning PDI from the planning CT images. The source-to-axis distance (SAD) and source-to-image receptor distance (SID) were 100cm and 140cm, respectively. The geometric setting was the same as that of the EPID mounted on the linear accelerator. The isocenter in the planning CT image was placed at an SAD of 100cm. The isocenter coordinate was obtained from a digital imaging and communications in medicine (DICOM) file for radiation therapy, i.e., DICOM-RT. A divergent primary beam with a number of rays produced from the X-ray focal spot of the linear accelerator was virtually delivered to the planning CT image. The X-ray focal spot was estimated based on an actual focal spot size of 1.53mm [19,20] and a primary collimator angle of 13.9°.

Algorithm 2 shows an algorithm for the production of the planning PDI. The dose distribution was calculated in the planning CT image and the virtual water phantom by using the PBC algorithm [26–28]. The PBC algorithm is expressed by:
                           
                              Algorithm 2
                              
                                 An algorithm for the production of the planning PDI.
                              
                              
                                 
                                 
                                 
                                    
                                       1.
                                       
                                          INPUT 
                                          I
                                          
                                             p
                                          : planning CT image, K: dose deposition kernel,
                                    
                                    
                                       2.
                                       
                                          
                                          
                                          
                                          res: resolution of planning CT image;
                                    
                                    
                                       3.
                                       
                                          COMMENTS 
                                          
                                             
                                                
                                                   I
                                                   
                                                      p
                                                      ′
                                                   
                                                
                                             
                                          : isotropic planning CT image, r: position vector,
                                    
                                    
                                       4.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          vwp: virtual waterphantom, voi: VOI,
                                    
                                    
                                       5.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          ρ
                                          
                                             re
                                          : relative electron density to water,
                                    
                                    
                                       6.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          r
                                          
                                             i
                                          : ith sampling position vector, d
                                          r: sampling interval on a ray,
                                    
                                    
                                       7.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          T: TERMA, r
                                          0: the initial position vector of the X-ray source,
                                    
                                    
                                       8.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          ψ: X-ray energy fluence (MeVm−2), E: X-ray energy (MeV),
                                    
                                    
                                       9.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          μ
                                          
                                             w
                                          : linear attenuation coefficient of water (m−1),
                                    
                                    
                                       10.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                             
                                                
                                                   
                                                      (
                                                      μ
                                                      /
                                                      ρ
                                                      )
                                                   
                                                   w
                                                
                                             
                                          : mass attenuation coefficient of water (m2
                                          kg−1);
                                    
                                    
                                       11.
                                       
                                          INITIALIZATION 
                                          vwp
                                          ←0;
                                    
                                    
                                       12.
                                       
                                          //Isotropic Planning CT image by cubic interpolation 
                                          [21]
                                       
                                    
                                    
                                       13.
                                       
                                          FOR ALL r DO
                                       
                                    
                                    
                                       14.
                                       
                                          
                                          
                                             
                                                
                                                   I
                                                   
                                                      p
                                                      ′
                                                   
                                                
                                                (
                                                
                                                   r
                                                
                                                )
                                             
                                          
                                          ←Cubic interpolation (I
                                          
                                             p
                                          (r), res);
                                    
                                    
                                       15.
                                       
                                          //Deamination of VOI 
                                          [22]
                                       
                                    
                                    
                                       16.
                                       
                                          
                                          voi(r)←Cropping VOI (
                                             
                                                
                                                   I
                                                   
                                                      p
                                                      ′
                                                   
                                                
                                                (
                                                
                                                   r
                                                
                                                )
                                                ,
                                                v
                                                w
                                                p
                                                (
                                                
                                                   r
                                                
                                                )
                                             
                                          );
                                    
                                    
                                       17.
                                       
                                          //Conversion of the CT value into the electron density 
                                          [23]
                                       
                                    
                                    
                                       18.
                                       
                                          
                                          IF 
                                          voi(r)≠ 0 THEN
                                       
                                    
                                    
                                       19.
                                       
                                          
                                          
                                          ρ
                                          
                                             re
                                          (r)←CT to ED conversion 
                                             
                                                (
                                                
                                                   I
                                                   
                                                      p
                                                      ′
                                                   
                                                
                                                (
                                                
                                                   r
                                                
                                                )
                                                ,
                                                v
                                                w
                                                p
                                                (
                                                
                                                   r
                                                
                                                )
                                                )
                                             
                                          ;
                                    
                                    
                                       20.
                                       
                                          
                                          //Calculation of WEPL 
                                          [24,25]
                                       
                                    
                                    
                                       21.
                                       
                                          
                                          
                                          
                                             
                                                W
                                                (
                                                
                                                   r
                                                
                                                )
                                                ←
                                                
                                                   ∑
                                                   
                                                      i
                                                      =
                                                      0
                                                   
                                                   
                                                      S
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   
                                                      ρ
                                                      
                                                         r
                                                         e
                                                      
                                                   
                                                   (
                                                   
                                                      
                                                         r
                                                      
                                                      i
                                                   
                                                   )
                                                   ⋅
                                                   d
                                                   
                                                      r
                                                   
                                                
                                             
                                          ;
                                    
                                    
                                       22.
                                       
                                          
                                          
                                          
                                             
                                                T
                                                (
                                                
                                                   r
                                                
                                                )
                                                ←
                                                
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  
                                                                     
                                                                        r
                                                                     
                                                                     0
                                                                  
                                                               
                                                               
                                                                  r
                                                               
                                                            
                                                         
                                                      
                                                   
                                                   2
                                                
                                                ∫
                                                
                                                   ψ
                                                   (
                                                   E
                                                   ,
                                                   
                                                      
                                                         r
                                                      
                                                      0
                                                   
                                                   )
                                                   exp
                                                   (
                                                   −
                                                   
                                                      μ
                                                      w
                                                   
                                                   (
                                                   E
                                                   )
                                                   ⋅
                                                   W
                                                   (
                                                   
                                                      r
                                                   
                                                   −
                                                   
                                                      
                                                         r
                                                      
                                                      0
                                                   
                                                   )
                                                   )
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  μ
                                                                  ρ
                                                               
                                                            
                                                         
                                                      
                                                      w
                                                   
                                                   (
                                                   E
                                                   ,
                                                   
                                                      r
                                                   
                                                   )
                                                   d
                                                   E
                                                
                                             
                                          ;
                                    
                                    
                                       23.
                                       
                                          
                                          //Calculation of dose distribution
                                       
                                    
                                    
                                       24.
                                       
                                          
                                          
                                          
                                             
                                                D
                                                (
                                                
                                                   r
                                                
                                                )
                                                ←
                                                T
                                                (
                                                
                                                   r
                                                
                                                )
                                                ⋅
                                                K
                                                (
                                                
                                                   r
                                                
                                                )
                                             
                                          ;
                                    
                                    
                                       25.
                                       
                                          
                                          //Extraction of 2D dose distribution in detector plane
                                       
                                    
                                    
                                       26.
                                       
                                          
                                          
                                          IF r
                                          ∈detector plane THEN
                                       
                                    
                                    
                                       27.
                                       
                                          
                                          
                                          
                                          
                                             
                                                Φ
                                                (
                                                
                                                   r
                                                
                                                )
                                                ←
                                                D
                                                (
                                                
                                                   r
                                                
                                                )
                                             
                                          ;
                                    
                                    
                                       28.
                                       
                                          
                                          
                                          END IF
                                       
                                    
                                    
                                       29.
                                       
                                          
                                          END IF
                                       
                                    
                                    
                                       30.
                                       
                                          END FOR
                                       
                                    
                                    
                                       31.
                                       
                                          OUTPUT 
                                          Φ: planning PDI;
                                    
                                 
                              
                           
                        
                        
                           
                              (1)
                              
                                 
                                    D
                                    (
                                    
                                       r
                                    
                                    )
                                    =
                                    ∭
                                    
                                       T
                                       (
                                       
                                          r
                                       
                                       '
                                       )
                                       ⋅
                                       K
                                       (
                                       
                                          r
                                       
                                       −
                                       
                                          r
                                       
                                       '
                                       )
                                       d
                                       
                                          r
                                       
                                       '
                                       =
                                       T
                                       (
                                       
                                          r
                                       
                                       )
                                       *
                                       K
                                       (
                                       
                                          r
                                       
                                       )
                                    
                                    ,
                                 
                              
                           
                        where D is the absorbed dose (Gy), r is the 3D position vector, T is the TERMA and K is the dose deposition kernel (DDK). The DDK is a 3D spatial distribution of the energy deposited by electrons and positrons, which describes the energy spread from the site of a primary photon interaction [27]. A DDK modeled by Ahnesjö [27] was used in this study, and it is defined by:
                           
                              (2)
                              
                                 
                                    K
                                    (
                                    l
                                    ,
                                    θ
                                    )
                                    =
                                    
                                       
                                          
                                             A
                                             θ
                                          
                                          
                                             e
                                             
                                                −
                                                
                                                   a
                                                   θ
                                                
                                                l
                                             
                                          
                                          +
                                          
                                             B
                                             θ
                                          
                                          
                                             e
                                             
                                                −
                                                
                                                   b
                                                   θ
                                                
                                                l
                                             
                                          
                                       
                                       
                                          
                                             l
                                             2
                                          
                                       
                                    
                                    ,
                                 
                              
                           
                        where A
                        
                           θ
                        , a
                        
                           θ
                        , B
                        
                           θ
                        , and b
                        
                           θ
                         are the parameters of the scattering angle θ, and l is the distance between the interaction site and the dose deposition site. The first term in the numerator of Eq. (2) mainly describes the energy deposited as a primary dose, and the second term mainly describes the energy deposited as a scattered dose. A 2D dose distribution on the detector plane in the virtual water phantom was estimated as a planning PDI. The detector plane was set at the same position as the EPID on a central beam axis (z-axis).


                        Fig. 5
                         shows a processing pipeline for estimating the simulated 4D “treatment” CT images based on a PDI-based 2D/3D registration. The simulated 4D “treatment” CT image was estimated by deforming the 3D planning CT image with an affine transformation matrix, which is described in Appendix A.

Algorithm 3 shows an overall algorithm for the estimation of the simulated 4D “treatment” CT images by using a PDI-based 2D/3D registration between a 2D portal dynamic image and 3D planning CT image.
                           
                              Algorithm 3
                              
                                 An overall algorithm for the estimation of the simulated 4D “treatment” CT images by using a PDI-based 2D/3D registration between a 2D portal dynamic image and 3D planning CT image.
                              
                              
                                 
                                 
                                 
                                    
                                       1.
                                       
                                          INPUT 
                                          I
                                          
                                             p
                                          , I
                                          
                                             c
                                          , K, res;
                                    
                                    
                                       2.
                                       
                                          COMMENTS s
                                          =[θ
                                          
                                             x
                                          , θ
                                          
                                             y
                                          , θ
                                          
                                             z
                                          , τ
                                          
                                             x
                                          , τ
                                          
                                             y
                                          , τ
                                          
                                             z
                                          , μ
                                          
                                             x
                                          , μ
                                          
                                             y
                                          , μ
                                          
                                             z
                                          ]T: transformation parameter set,
                                    
                                    
                                       3.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          s
                                          
                                             opt
                                          : optimal transformation parameter set,
                                    
                                    
                                       4.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          TM: affine transformation matrix, I
                                          
                                             t
                                          : deformed planning CT image,
                                    
                                    
                                       5.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          gp: gamma pass rate (3mm/3%),
                                    
                                    
                                       6.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          I
                                          
                                             n
                                          : simulated “treatment” CT image in nth frame,
                                    
                                    
                                       7.
                                       
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          
                                          N: max. no. of frames;
                                    
                                    
                                       8.
                                       
                                          WHILE 
                                          n
                                          ≤
                                          N 
                                          DO
                                       
                                    
                                    
                                       9.
                                       
                                          
                                          INITIALIZATION
                                          
                                          
                                          s
                                          ←[0,0,0,0,0,0,1,1,1]T
                                       
                                    
                                    
                                       10.
                                       
                                          
                                          //Deformation of the planning CT image
                                       
                                    
                                    
                                       11.
                                       
                                          
                                          TM(s)←Affine matrix conversion (s);
                                    
                                    
                                       12.
                                       
                                          
                                          
                                             
                                                
                                                   I
                                                   t
                                                
                                                (
                                                
                                                   s
                                                
                                                )
                                                ←
                                                
                                                   TM
                                                
                                                (
                                                
                                                   s
                                                
                                                )
                                                ⋅
                                                
                                                   I
                                                   p
                                                
                                             
                                          ;
                                    
                                    
                                       13.
                                       
                                          
                                          //Production of planning PDI
                                       
                                    
                                    
                                       14.
                                       
                                          
                                          Φ(s)←Planning PDI (I
                                          
                                             t
                                          (s), K, res);
                                    
                                    
                                       15.
                                       
                                          
                                          //Gamma pass rate as a criteria
                                       
                                    
                                    
                                       16.
                                       
                                          
                                          gp
                                          ←Gamma evaluation (Φ(s), I
                                          
                                             c
                                          );
                                    
                                    
                                       17.
                                       
                                          
                                          IF 
                                          gp
                                          >98.0 THEN
                                       
                                    
                                    
                                       18.
                                       
                                          
                                          
                                          s
                                          
                                             opt
                                          
                                          ←
                                          s;
                                    
                                    
                                       19.
                                       
                                          
                                          
                                          ELSE THEN
                                       
                                    
                                    
                                       20.
                                       
                                          
                                          
                                          s
                                          
                                             opt
                                          
                                          ←Optimization of a parameter set of an affine transformation matrix using an LM algorithm (s, Φ(
                                             s
                                          ), I
                                          
                                             c
                                          , gp);
                                          
                                          //Algorithm 4
                                       
                                    
                                    
                                       21.
                                       
                                          
                                          END IF
                                       
                                    
                                    
                                       22.
                                       
                                          
                                          I
                                          
                                             n
                                          ←I
                                          
                                             t
                                          (s
                                          
                                             opt
                                          );
                                    
                                    
                                       23.
                                       
                                          END WHILE
                                       
                                    
                                    
                                       24.
                                       
                                          OUTPUT 
                                          
                                             
                                                I
                                                =
                                                {
                                                
                                                   I
                                                   1
                                                
                                                ,
                                                
                                                   I
                                                   2
                                                
                                                ,
                                                …
                                                
                                                   I
                                                   N
                                                
                                                }
                                             
                                          : simulated 4D “treatment” CT image;
                                    
                                 
                              
                           
                        
                     

A gamma pass rate (3mm/3%) between the planning PDI and the dynamic clinical PDI was calculated as a criterion for estimating the “treatment” CT image. The gamma evaluation is an analytical method, which can evaluate the agreement between two dose distributions based on the distance between compared points and the dose difference [29,30]. Fig. 6
                         shows a schematic representation of the theoretical concept of the gamma evaluation method. The gamma value is defined by:
                           
                              (3)
                              
                                 
                                    γ
                                    (
                                    
                                       
                                          r
                                       
                                       c
                                    
                                    )
                                    =
                                    min
                                    {
                                    
                                       Γ
                                       
                                          (
                                          
                                             
                                                r
                                             
                                             r
                                          
                                          ,
                                          
                                             
                                                r
                                             
                                             c
                                          
                                          )
                                       
                                    
                                    }
                                    ∀
                                    {
                                    
                                       
                                          r
                                       
                                       r
                                    
                                    }
                                    ,
                                 
                              
                           
                        where
                           
                              (4)
                              
                                 
                                    
                                       Γ
                                       
                                          (
                                          
                                             
                                                r
                                             
                                             r
                                          
                                          ,
                                          
                                             
                                                r
                                             
                                             c
                                          
                                          )
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   r
                                                   2
                                                
                                                (
                                                
                                                   
                                                      r
                                                   
                                                   r
                                                
                                                ,
                                                
                                                   
                                                      r
                                                   
                                                   c
                                                
                                                )
                                             
                                             
                                                
                                                   Δ
                                                
                                                
                                                   d
                                                   M
                                                   2
                                                
                                             
                                          
                                          +
                                          
                                             
                                                
                                                   δ
                                                   2
                                                
                                                (
                                                
                                                   
                                                      r
                                                   
                                                   r
                                                
                                                ,
                                                
                                                   
                                                      r
                                                   
                                                   c
                                                
                                                )
                                             
                                             
                                                
                                                   Δ
                                                
                                                
                                                   D
                                                   M
                                                   2
                                                
                                             
                                          
                                       
                                    
                                    ,
                                 
                              
                           
                        
                        r
                        
                           r
                         is the reference point, r
                        
                           c
                         is the compared point, r(r
                        
                           r
                        , r
                        
                           c
                        ) is the distance between the reference and the compared point, δ(r
                        
                           r
                        , r
                        
                           c
                        ) is the difference between the dose on the r
                        
                           r
                         and r
                        
                           c
                        , Δd
                        
                           M
                         is the distance criterion and ΔD
                        
                           M
                         is the dose difference criterion. The agreement and disagreement criteria become:
                           
                              (5)
                              
                                 
                                    
                                       
                                          
                                             
                                                γ
                                                (
                                                
                                                   
                                                      r
                                                   
                                                   c
                                                
                                                )
                                                ≤
                                                1
                                                ,
                                                 
                                                agreement
                                                ,
                                             
                                          
                                       
                                       
                                          
                                             
                                                and
                                             
                                          
                                       
                                       
                                          
                                             
                                                γ
                                                (
                                                
                                                   
                                                      r
                                                   
                                                   c
                                                
                                                )
                                                >
                                                1
                                                ,
                                                 
                                                disagreement
                                                .
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The gamma pass rate is defined by the following equation:
                           
                              (6)
                              
                                 
                                    Gamma pass rate
                                     
                                    (
                                    %
                                    )
                                    =
                                    
                                       
                                          No. of agreement points
                                       
                                       
                                          No. of all points
                                       
                                    
                                    ⋅
                                    100
                                    .
                                 
                              
                           
                        
                     

If the pass rate exceeded 98.0%, the deformed planning CT image and planning PDI were regarded as the “treatment” CT image and “treatment” PDI, respectively. Otherwise, a transformation parameter set was optimized by using the Levenberg–Marquardt (LM) algorithm [31,32], whose details are explained Appendix B. It should be noted that each parameter range was limited to avoid the use of unlikely large parameters, which may be calculated using the LM algorithm. Table 2
                         shows the ranges for the rotation, translation and scaling parameters in the affine transformation. If any of the parameters exceeded its range, the upper or lower limit value was used as the parameter. This procedure was applied to all frames of the EPID dynamic images to estimate the simulated 4D “treatment” CT image.


                        Fig. 7
                         shows an illustration of an estimation of the 4D dose distributions. The 4D dose distributions during the treatment delivery were calculated by applying the PBC algorithm to the simulated 4D “treatment” CT images.

The gamma evaluation mentioned above was used to evaluate the proposed framework with respect to the dose distribution similarity between the “treatment” PDI derived from simulated 4D “treatment” CT image and the dynamic clinical PDI derived from the EPID dynamic image. Gamma images, whose pixel value was a γ value, were calculated to visually verify the dose distribution similarity.

In addition, a percentage error between a prescribed dose and an estimated dose at an isocenter was also calculated to evaluate of the proposed framework. The percentage dose error was defined by the following equation:
                           
                              (7)
                              
                                 
                                    Dose error
                                     
                                    (
                                    %
                                    )
                                    =
                                    
                                       
                                          |estimated dose
                                          −
                                          prescribed dose|
                                       
                                       
                                          prescribed dose
                                       
                                    
                                    ⋅
                                    100
                                    .
                                 
                              
                           
                        
                     

@&#RESULTS@&#


                        Fig. 8
                         shows the 4D dose distributions on the isocenter planes of axial, sagittal and coronal sections at treatment times of 2, 4, and 6s during the treatment deliveries at a gantry angle of 45° for Case 6 (a) and at a gantry angle of 270° for Case 7 (b). These results suggest that the 4D dose distributions sequentially change in accordance with the respiratory motion.


                        Table 3
                         shows the mean±standard deviation (SD) of the gamma pass rates between the dynamic clinical PDIs and initial “treatment” PDIs, and those between the dynamic clinical PDIs and the “treatment” PDIs. The initial “treatment” PDIs are planning PDIs, which were obtained from planning CT images without applying the affine transformation, and “treatment” PDIs are also planning PDIs which were obtained by the optimized transformation parameter set. The mean±SD of the gamma pass rates between the dynamic clinical PDIs and “treatment” PDIs for ten cases was 94.61±2.71%, which was larger than that (89.27±3.44%) of those between the dynamic clinical PDIs and initial “treatment” PDIs. There was a statistically significant difference in the pass rates between the clinical PDIs versus the initial “treatment” PDIs, and the clinical PDIs versus “treatment” PDIs (P
                        <0.05).


                        Fig. 9
                         shows gamma images for Case 5 between the dynamic clinical PDIs and initial “treatment” PDIs, and those between the dynamic clinical PDIs and “treatment” PDIs. Agreement regions between the dynamic clinical PDIs and “treatment” PDIs seemed to be increased comparison with that of between the dynamic clinical PDIs and initial “treatment” PDIs. Dose distribution similarity could be visually verified by calculation of the gamma images.


                        Table 4
                         shows the prescribed doses at isocenters, the mean±SD of estimated doses for all frames at isocenters and the percentage errors for all cases. The mean±SD of the percentage errors between the prescribed dose and the estimated dose at an isocenter for all cases was 3.25±4.43%. The maximum error for ten cases was 14.67% for Case 7 (prescribed dose: 1.50Gy, estimated dose: 1.72Gy), and the minimum error was 0.00% for Case 2 (prescribed dose: 1.71Gy, estimated dose: 1.71Gy). This result suggests that the proposed framework can be useful to ensure the quality of the radiation therapy by calculating the dose errors between the delivered dose during the treatment time and the prescribed dose determined by the treatment planning.

@&#DISCUSSION@&#

As shown in Table 3, the pass rate between the dynamic clinical PDIs and “treatment” PDIs reached more than 90% for all but Case 8, whose pass rate was 75.53%. Consequently, the proposed framework could estimate the dose at an isocenter during the treatment time, as shown in Table 4. Therefore, the proposed framework could detect the discrepancies between the prescribed doses in treatment plans and estimated doses during the treatment time.

The advantage of using the LM algorithm is that it allows for fast computation of the optimization problems. The disadvantage is that the computation of the LM optimization algorithm may be trapped in a local minimum of the objective function, depending on the setting of the initial search points. However, we assumed that the initial point could be close to the global minimum point for two reasons. First, radiological technologists set patients up on a couch according to the treatment plans. Second, the patient bodies were immobilized by stereotactic body frames to limit respiratory motion in this study. Therefore, the propose framework based on the LM optimization algorithm could reach a global minimum.

In this study, the gamma pass rate was adopted as a criterion for the LM optimization. This LM algorithm is referred to as the gamma-pass-based LM algorithm (GP-LM). The reason why we adopted the criterion of the gamma pass rate was to reduce the computation time of the optimization while maintaining the optimization accuracy. In general, however, a L2-norm of the parameter increment is used as a criterion for the LM algorithm [32].

This typical method is referred to as the standard LM algorithm (S-LM) in this paper. Moreover, a normalized mutual information (NMI) was employed as a criterion for the LM algorithm (NMI-based LM algorithm: NMI-LM), because the NMI has been widely utilized for evaluation of the image similarity [33]. We compared the results obtained by the proposed framework based on the GP-LM, S-LM and NMI-LM. Table 5
                         shows the criterions of GP-LM, S-LM and NMI-LM. The threshold value of the NMI was empirically determined.


                        Table 6
                         shows the mean±SD of the gamma pass rates at treatment times of 2, 4, and 6s during treatment deliveries between the dynamic clinical PDIs and the “treatment” PDIs using the GP-LM, S-LM and NMI-LM. The mean±SD of the pass rates between the dynamic clinical PDIs and “treatment” PDIs based on the S-LM for the ten cases was 94.14±3.94%, which was slightly larger than the other pass rates (GP-LM: 93.76±3.54%, NMI-LM: 90.24±3.95%) between the dynamic clinical PDIs and “treatment” PDIs. There was not a statistically significant difference in the pass rates between the dynamic clinical PDIs versus “treatment” PDIs based on the S-LM compared to that based on the GP-LM (P
                        >0.05). On the other hand, the pass rates obtained by the GP-LM were significantly larger than those by the NMI-LM (P
                        <0.05). Therefore, the proposed framework based on the GP-LM appears to have the same optimization accuracy as that based on the S-LM, but it was superior to that based on the NMI-LM.

Moreover, the computation times were compared between the three frameworks. Table 7
                         shows the means of the calculation times for three EPID frames at treatment times of 2, 4, and 6s for all cases using the GP-LM, S-LM and NMI-LM. The mean calculation times for all cases based on the GP-LM, S-LM and NMI-LM were 160.2min, 290.8min and 170.4min, respectively. Therefore, the proposed framework based on the GP-LM was faster than the other two methods. However, there was not a statistically significant difference in the computational times between the GP-LM and NMI-LM (P
                        >0.05).

In summary, the proposed framework based on the GP-LM could be better than the other two methods in terms of the pass rate and computational time.

@&#LIMITATIONS@&#

There are three limitations that may be raised in this study. First, phantom experiments should be performed to evaluate the 4D dose distribution estimated by the proposed framework, because it is very difficult to verify the in vivo dose distribution. Second, the computation time (about 3h on average) should be reduced using parallel computing methods, such as general-purpose computing on a graphics processing unit (GPGPU), because it took a long time to calculate the 3D dose distributions using the PBC algorithm. Third, non-linear registration techniques should be employed in the PDI-based 2D/3D registration, because physiological organ and/or tumor motions are non-linear.

@&#CONCLUSION@&#

We have developed an automated framework for estimation of the 4D dose distributions in SBRT based on a PDI-based 2D/3D image registration between the EPID dynamic images and planning CT images. The proposed framework appears to be feasible for estimating the 4D dose distributions in patients’ bodies during treatment delivery. Moreover, the framework seems to be useful for ensuring the quality of the radiation therapy by calculating the dose errors between the delivered dose during the treatment time and the prescribed dose determined by the treatment planning.

@&#ACKNOWLEDGEMENTS@&#

This research was partially supported by the Ministry Education, Culture, Sports Science and Technology (MEXT), via a Grant-in-Aid for Scientific Research on Innovative Areas, 24103707, 2012–2013.

The affine transformation matrix includes a nine-dimensional transformation parameter vector, 
                        
                           
                              s
                           
                           =
                           
                              
                                 [
                                 
                                    θ
                                    x
                                 
                                 ,
                                 
                                    θ
                                    y
                                 
                                 ,
                                 
                                    θ
                                    z
                                 
                                 ,
                                 
                                    τ
                                    x
                                 
                                 ,
                                 
                                    τ
                                    y
                                 
                                 ,
                                 
                                    τ
                                    z
                                 
                                 ,
                                 
                                    μ
                                    x
                                 
                                 ,
                                 
                                    μ
                                    y
                                 
                                 ,
                                 
                                    μ
                                    z
                                 
                                 ]
                              
                              T
                           
                        
                     , which represents the internal or external patient body motion related to respiration, where θ
                     
                        x
                     , θ
                     
                        y
                     , and θ
                     
                        z
                      are the rotations around the x, y and z axes, respectively, τ
                     
                        x
                     , τ
                     
                        y
                     , and τ
                     
                        z
                      are the translations in x, y and z directions, respectively and μ
                     
                        x
                     , μ
                     
                        y
                     , and μ
                     
                        z
                      are the scaling factors in the x, y and z directions, respectively. Fig. 10
                      shows the nine affine transformation parameters. The affine transformation matrix, T
                     
                        aff
                      was expressed by:
                        
                           (8)
                           
                              
                                 
                                    
                                       T
                                    
                                    
                                       aff
                                    
                                 
                                 =
                                 
                                    RS
                                 
                                 +
                                 
                                    t
                                 
                                 ,
                              
                           
                        
                     where
                        
                           
                              
                                 
                                    R
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   cos
                                                   
                                                      θ
                                                      y
                                                   
                                                   cos
                                                   
                                                      θ
                                                      z
                                                   
                                                
                                             
                                             
                                                
                                                   cos
                                                   
                                                      θ
                                                      x
                                                   
                                                   sin
                                                   
                                                      θ
                                                      z
                                                   
                                                   +
                                                   sin
                                                   
                                                      θ
                                                      z
                                                   
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                   cos
                                                   
                                                      θ
                                                      z
                                                   
                                                
                                             
                                             
                                                
                                                   sin
                                                   
                                                      θ
                                                      x
                                                   
                                                   sin
                                                   
                                                      θ
                                                      z
                                                   
                                                   −
                                                   cos
                                                   
                                                      θ
                                                      x
                                                   
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                   cos
                                                   
                                                      θ
                                                      z
                                                   
                                                
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                
                                             
                                             
                                                
                                                   cos
                                                   
                                                      θ
                                                      x
                                                   
                                                   cos
                                                   
                                                      θ
                                                      z
                                                   
                                                   +
                                                   sin
                                                   
                                                      θ
                                                      x
                                                   
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                   sin
                                                   
                                                      θ
                                                      z
                                                   
                                                
                                             
                                             
                                                
                                                   sin
                                                   
                                                      θ
                                                      x
                                                   
                                                   cos
                                                   
                                                      θ
                                                      z
                                                   
                                                   +
                                                   cos
                                                   
                                                      θ
                                                      x
                                                   
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                   sin
                                                   
                                                      θ
                                                      z
                                                   
                                                
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                
                                                   sin
                                                   
                                                      θ
                                                      y
                                                   
                                                
                                             
                                             
                                                
                                                   sin
                                                   
                                                      θ
                                                      x
                                                   
                                                   cos
                                                   
                                                      θ
                                                      y
                                                   
                                                
                                             
                                             
                                                
                                                   cos
                                                   
                                                      θ
                                                      x
                                                   
                                                   cos
                                                   
                                                      θ
                                                      y
                                                   
                                                
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                1
                                             
                                          
                                       
                                    
                                 
                                 ,
                              
                           
                        
                     
                     
                        
                           
                              
                                 
                                    S
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      μ
                                                      x
                                                   
                                                
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                
                                                   
                                                      μ
                                                      y
                                                   
                                                
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                
                                                   
                                                      μ
                                                      z
                                                   
                                                
                                             
                                             
                                                0
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                1
                                             
                                          
                                       
                                    
                                 
                                 ,
                              
                           
                        
                     and
                        
                           (9)
                           
                              
                                 
                                    t
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                
                                                   
                                                      τ
                                                      x
                                                   
                                                
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                
                                                   
                                                      τ
                                                      y
                                                   
                                                
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                
                                                   
                                                      τ
                                                      z
                                                   
                                                
                                             
                                          
                                          
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                             
                                                0
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        
                     
                  

Here, R, S and t are the rotation, scaling and translation matrices, respectively.

The LM algorithm is a standard optimization technique used to solve non-linear least squares problems. In addition, the LM algorithm is one of gradient-based optimization techniques, which combines a Gauss–Newton method with a steepest descent method [31,32].

Algorithm 4 shows an overall algorithm of optimization of a parameter set of an affine transformation matrix using an LM algorithm. A new parameter set, s′ was calculated by:
                        
                           Algorithm 4
                           
                              An overall algorithm of optimization of a parameter set of an affine transformation matrix using an LM algorithm.
                           
                           
                              
                              
                              
                                 
                                    1.
                                    
                                       INPUT s, Φ(s), I
                                       
                                          c
                                       , gp;
                                 
                                 
                                    2.
                                    
                                       COMMENTS 
                                       J: objective function, (i, j): pixel coordinate,
                                 
                                 
                                    3.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       ▿
                                          s
                                       
                                       J: gradient of the objective function, H
                                       
                                          s
                                       : Hessian matrix,
                                 
                                 
                                    4.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       c: damping parameter, D[H
                                       
                                          s
                                       ]: diagonal matrix of Hessian matrix,
                                 
                                 
                                    5.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       Δs: parameter increment, s′: new transformation parameter vector,
                                 
                                 
                                    6.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       J′: new objective function, coarse: no. of coarse searching,
                                 
                                 
                                    7.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       fine: no. of fine searching;
                                 
                                 
                                    8.
                                    
                                       INITIALIZATION 
                                       gp
                                       
                                          max
                                       
                                       ←
                                       gp, s
                                       
                                          gpmax
                                       
                                       ←
                                       s, c
                                       ←0.0001, coarse
                                       ←0,
                                 
                                 
                                    9.
                                    
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       
                                       fine
                                       ←0;
                                 
                                 
                                    10.
                                    
                                       //Calculation of an objective function
                                    
                                 
                                 
                                    11.
                                    
                                       
                                          
                                             J
                                             ←
                                             
                                                1
                                                2
                                             
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                             
                                                
                                                   
                                                      {
                                                      Φ
                                                      
                                                         
                                                            (
                                                            
                                                               s
                                                            
                                                            )
                                                         
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                      
                                                      −
                                                      
                                                         I
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                         c
                                                      
                                                      }
                                                   
                                                   2
                                                
                                             
                                          
                                       ;
                                 
                                 
                                    12.
                                    
                                       LOOP1 //Coarse searching
                                    
                                 
                                 
                                    13.
                                    
                                       //Calculation of a gradient of the objective function and Hessian matrix
                                    
                                 
                                 
                                    14.
                                    
                                       
                                          
                                             
                                                ∇
                                                
                                                   s
                                                
                                             
                                             
                                                J
                                             
                                             ←
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                             
                                                {
                                                Φ
                                                
                                                   
                                                      (
                                                      
                                                         s
                                                      
                                                      )
                                                   
                                                   
                                                      i
                                                      ,
                                                      j
                                                   
                                                
                                                −
                                                
                                                   I
                                                   
                                                      i
                                                      ,
                                                      j
                                                   
                                                   c
                                                
                                                }
                                                ⋅
                                                {
                                                
                                                   ∇
                                                   
                                                      s
                                                   
                                                
                                                Φ
                                                
                                                   
                                                      (
                                                      
                                                         s
                                                      
                                                      )
                                                   
                                                   
                                                      i
                                                      ,
                                                      j
                                                   
                                                
                                                }
                                             
                                          
                                       ;
                                 
                                 
                                    15.
                                    
                                       
                                          
                                             
                                                
                                                   H
                                                
                                                s
                                             
                                             ←
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                             
                                                {
                                                
                                                   ∇
                                                   s
                                                
                                                Φ
                                                
                                                   
                                                      (
                                                      
                                                         s
                                                      
                                                      )
                                                   
                                                   
                                                      i
                                                      ,
                                                      j
                                                   
                                                
                                                }
                                                ⋅
                                                
                                                   
                                                      {
                                                      
                                                         ∇
                                                         
                                                            s
                                                         
                                                      
                                                      Φ
                                                      
                                                         
                                                            (
                                                            
                                                               s
                                                            
                                                            )
                                                         
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                      
                                                      }
                                                   
                                                   T
                                                
                                             
                                          
                                       ;
                                 
                                 
                                    16.
                                    
                                       LOOP2 //Fine searching
                                    
                                 
                                 
                                    17.
                                    
                                       //Calculation of the new transformation parameter set
                                    
                                 
                                 
                                    18.
                                    
                                       IF 
                                       det(H
                                       
                                          s
                                       
                                       +
                                       c
                                       D[H
                                       
                                          s
                                       ])=0.0 THEN
                                    
                                 
                                 
                                    19.
                                    
                                       
                                       s
                                       
                                          opt
                                       
                                       ←
                                       s
                                       
                                          gpmax
                                       ;
                                 
                                 
                                    20.
                                    
                                       
                                       GO TO 46 line
                                 
                                 
                                    21.
                                    
                                       END IF
                                    
                                 
                                 
                                    22.
                                    
                                       
                                          
                                             Δ
                                             
                                                s
                                             
                                             →
                                             
                                                
                                                   (
                                                   
                                                      
                                                         H
                                                      
                                                      
                                                         s
                                                      
                                                   
                                                   +
                                                   c
                                                   
                                                      D
                                                   
                                                   [
                                                   
                                                      
                                                         H
                                                      
                                                      s
                                                   
                                                   ]
                                                   )
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             ⋅
                                             (
                                             −
                                             
                                                ∇
                                                
                                                   s
                                                
                                             
                                             
                                                J
                                             
                                             )
                                          
                                       ;
                                 
                                 
                                    23.
                                    
                                       
                                          
                                             
                                                
                                                   s
                                                
                                                ′
                                             
                                             ←
                                             
                                                s
                                             
                                             +
                                             
                                                Δ
                                             
                                             
                                                s
                                             
                                          
                                       ;
                                 
                                 
                                    24.
                                    
                                       //Calculation of the new objective function and gamma pass rate
                                    
                                 
                                 
                                    25.
                                    
                                       gp
                                       ←Gamma evaluation (Φ(s′), I
                                       
                                          c
                                       );
                                 
                                 
                                    26.
                                    
                                       
                                          
                                             
                                                J
                                                ′
                                             
                                             ←
                                             
                                                1
                                                2
                                             
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                             
                                                
                                                   
                                                      {
                                                      Φ
                                                      
                                                         
                                                            (
                                                            
                                                               
                                                                  s
                                                               
                                                               ′
                                                            
                                                            )
                                                         
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                      
                                                      −
                                                      
                                                         I
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                         c
                                                      
                                                      }
                                                   
                                                   2
                                                
                                             
                                          
                                       ;
                                 
                                 
                                    27.
                                    
                                       IF 
                                       gp
                                       >
                                       gp
                                       
                                          max
                                        
                                       THEN
                                    
                                 
                                 
                                    28.
                                    
                                       
                                       
                                       gp
                                       
                                          max
                                       
                                       ←
                                       gp, s
                                       
                                          gpmax
                                       
                                       ←
                                       s′;
                                 
                                 
                                    29.
                                    
                                       END IF
                                    
                                 
                                 
                                    30.
                                    
                                       //Judgment
                                    
                                 
                                 
                                    31.
                                    
                                       IF 
                                       gp
                                       >98.0 THEN
                                    
                                 
                                 
                                    32.
                                    
                                       
                                       s
                                       
                                          opt
                                       
                                       ←
                                       s’;
                                 
                                 
                                    33.
                                    
                                       
                                       ELSE IF 
                                       coarse
                                       =5 OR 
                                       fine
                                       =10 THEN
                                    
                                 
                                 
                                    34.
                                    
                                       
                                       
                                       s
                                       
                                          opt
                                       
                                       ←
                                       s
                                       
                                          gpmax
                                       ;
                                 
                                 
                                    35.
                                    
                                       
                                       
                                       ELSE IF 
                                       J
                                       >
                                       J′ THEN
                                    
                                 
                                 
                                    36.
                                    
                                       
                                       
                                       
                                       
                                       s
                                       ←
                                       s′, 
                                          
                                             c
                                             ←
                                             
                                                c
                                                
                                                   10
                                                
                                             
                                          
                                       ;
                                 
                                 
                                    37.
                                    
                                       
                                       
                                       
                                       coarse++, fine
                                       ←0;
                                 
                                 
                                    38.
                                    
                                       
                                       
                                       
                                       GO TO LOOP1
                                    
                                 
                                 
                                    39.
                                    
                                       
                                       
                                       
                                       ELSE THEN
                                    
                                 
                                 
                                    40.
                                    
                                       
                                       
                                       
                                       c
                                       ←10c;
                                 
                                 
                                    41.
                                    
                                       
                                       
                                       
                                       fine++;
                                 
                                 
                                    42.
                                    
                                       
                                       
                                       
                                       GO TO LOOP2
                                    
                                 
                                 
                                    43.
                                    
                                       
                                       
                                       END IF
                                    
                                 
                                 
                                    44.
                                    
                                       
                                       END IF
                                    
                                 
                                 
                                    45.
                                    
                                       END IF
                                    
                                 
                                 
                                    46.
                                    
                                       OUTPUT s
                                       
                                          opt
                                       : optimal transformation parameter set;
                                 
                              
                           
                        
                     
                     
                        
                           (10)
                           
                              
                                 
                                    
                                       s
                                    
                                    ′
                                 
                                 =
                                 
                                    s
                                 
                                 +
                                 
                                    Δ
                                 
                                 
                                    s
                                 
                                 ,
                              
                           
                        
                     where s is a previous parameter set and Δs is a parameter increment. The parameter increment, Δs was calculated by:
                        
                           (11)
                           
                              
                                 Δ
                                 
                                    s
                                 
                                 =
                                 (
                                 
                                    
                                       H
                                    
                                    
                                       s
                                    
                                 
                                 +
                                 c
                                 
                                    D
                                 
                                 
                                    
                                       [
                                       
                                          
                                             H
                                          
                                          
                                             s
                                          
                                       
                                       ]
                                    
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 ⋅
                                 (
                                 −
                                 
                                    ∇
                                    
                                       s
                                    
                                 
                                 
                                    J
                                 
                                 )
                                 ,
                              
                           
                        
                     where H
                     
                        s
                      is the Hessian matrix, ▿
                        s
                     
                     J is the gradient of the objective function, D[H
                     
                        s
                     ] is the diagonal matrix of the Hessian matrix and c is the damping factor, whose initial value was 0.0001 [35]. If H
                     
                        s
                     
                     +
                     c
                     D[H
                     
                        s
                     ] has become a singular matrix, the iterative optimization has been stopped and the transformation parameter set with the largest pass rate in an entire iteration was regarded as the optimal transformation parameter set. An objective function, J, gradient, ▿
                        s
                     
                     J, and Hessian matrix, H
                     
                        s
                      were calculated by the following equations:
                        
                           (12)
                           
                              
                                 J
                                 =
                                 
                                    1
                                    2
                                 
                                 
                                    ∑
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 
                                    
                                       
                                          {
                                          Φ
                                          
                                             
                                                (
                                                
                                                   s
                                                
                                                )
                                             
                                             
                                                i
                                                ,
                                                j
                                             
                                          
                                          −
                                          
                                             I
                                             
                                                i
                                                ,
                                                j
                                             
                                             c
                                          
                                          }
                                       
                                       2
                                    
                                 
                                 ,
                              
                           
                        
                     
                     
                        
                           (13)
                           
                              
                                 
                                    ∇
                                    
                                       s
                                    
                                 
                                 
                                    J
                                 
                                 =
                                 
                                    ∑
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 
                                    {
                                    Φ
                                    
                                       
                                          (
                                          
                                             s
                                          
                                          )
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    −
                                    
                                       I
                                       
                                          i
                                          ,
                                          j
                                       
                                       c
                                    
                                    }
                                    ⋅
                                    {
                                    
                                       ∇
                                       
                                          s
                                       
                                    
                                    {
                                    Φ
                                    
                                       
                                          (
                                          
                                             s
                                          
                                          )
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    −
                                    
                                       I
                                       
                                          i
                                          ,
                                          j
                                       
                                       c
                                    
                                    }
                                    }
                                 
                                 =
                                 
                                    ∑
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 
                                    {
                                    Φ
                                    
                                       
                                          (
                                          
                                             s
                                          
                                          )
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    −
                                    
                                       I
                                       
                                          i
                                          ,
                                          j
                                       
                                       c
                                    
                                    }
                                    ⋅
                                    {
                                    
                                       ∇
                                       
                                          s
                                       
                                    
                                    Φ
                                    
                                       
                                          (
                                          
                                             s
                                          
                                          )
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    }
                                 
                                 ,
                              
                           
                        
                     and
                        
                           (14)
                           
                              
                                 
                                    
                                       H
                                    
                                    
                                       s
                                    
                                 
                                 =
                                 
                                    ∑
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ∂
                                                               2
                                                            
                                                            Φ
                                                            
                                                               
                                                                  (
                                                                  
                                                                     s
                                                                  
                                                                  )
                                                               
                                                               
                                                                  i
                                                                  ,
                                                                  j
                                                               
                                                            
                                                         
                                                         
                                                            ∂
                                                            
                                                               θ
                                                               x
                                                               2
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   ⋯
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ∂
                                                               2
                                                            
                                                            Φ
                                                            
                                                               
                                                                  (
                                                                  
                                                                     s
                                                                  
                                                                  )
                                                               
                                                               
                                                                  i
                                                                  ,
                                                                  j
                                                               
                                                            
                                                         
                                                         
                                                            ∂
                                                            
                                                               θ
                                                               x
                                                            
                                                            ∂
                                                            
                                                               μ
                                                               z
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   ⋮
                                                
                                                
                                                   ⋱
                                                
                                                
                                                   ⋮
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ∂
                                                               2
                                                            
                                                            Φ
                                                            
                                                               
                                                                  (
                                                                  
                                                                     s
                                                                  
                                                                  )
                                                               
                                                               
                                                                  i
                                                                  ,
                                                                  j
                                                               
                                                            
                                                         
                                                         
                                                            ∂
                                                            
                                                               μ
                                                               z
                                                            
                                                            ∂
                                                            
                                                               θ
                                                               x
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   ⋯
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ∂
                                                               2
                                                            
                                                            Φ
                                                            
                                                               
                                                                  (
                                                                  
                                                                     s
                                                                  
                                                                  )
                                                               
                                                               
                                                                  i
                                                                  ,
                                                                  j
                                                               
                                                            
                                                         
                                                         
                                                            ∂
                                                            
                                                               μ
                                                               z
                                                               2
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 ≈
                                 
                                    ∑
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                                 
                                    {
                                    
                                       ∇
                                       
                                          s
                                       
                                    
                                    Φ
                                    
                                       
                                          (
                                          
                                             s
                                          
                                          )
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    }
                                    ⋅
                                    
                                       
                                          {
                                          
                                             ∇
                                             
                                                s
                                             
                                          
                                          Φ
                                          
                                             
                                                (
                                                
                                                   s
                                                
                                                )
                                             
                                             
                                                i
                                                ,
                                                j
                                             
                                          
                                          }
                                       
                                       T
                                    
                                 
                                 ,
                              
                           
                        
                     where i and j are the pixel coordinates, Φ(
                        s
                     ) is the planning PDI calculated from deformed planning CT images using s, I
                     
                        c
                      is the dynamic clinical PDI and 
                        
                           
                              ∇
                              
                                 s
                              
                           
                           Φ
                           (
                           
                              s
                           
                           )
                           =
                           
                              
                                 
                                    
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                θ
                                                x
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                θ
                                                y
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                θ
                                                z
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                τ
                                                x
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                τ
                                                y
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                τ
                                                z
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                μ
                                                x
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                μ
                                                y
                                             
                                          
                                       
                                       ,
                                       
                                          
                                             ∂
                                             Φ
                                             
                                                
                                                   (
                                                   
                                                      s
                                                   
                                                   )
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          
                                             ∂
                                             
                                                μ
                                                z
                                             
                                          
                                       
                                    
                                 
                              
                              T
                           
                        
                      is the gradient vector of the planning PDI. The first derivative was approximated by a finite difference [36] as follows:
                        
                           (15)
                           
                              
                                 
                                    
                                       ∂
                                       Φ
                                       
                                          
                                             (
                                             
                                                s
                                             
                                             )
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                    
                                    
                                       ∂
                                       
                                          τ
                                          x
                                       
                                    
                                 
                                 ≈
                                 
                                    
                                       Φ
                                       
                                          
                                             (
                                             
                                                s
                                             
                                             +
                                             
                                                Δ
                                             
                                             
                                                
                                                   s
                                                
                                                
                                                   
                                                      τ
                                                      x
                                                   
                                                
                                             
                                             )
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                       −
                                       Φ
                                       
                                          
                                             (
                                             
                                                s
                                             
                                             )
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                    
                                    
                                       
                                          Δ
                                       
                                       
                                          τ
                                          x
                                       
                                    
                                 
                                 ,
                              
                           
                        
                     where 
                        
                           
                              Δ
                           
                           
                              
                                 s
                              
                              
                                 
                                    τ
                                    x
                                 
                              
                           
                           =
                           
                              
                                 [
                                 0,0,0
                                 ,
                                 
                                    Δ
                                 
                                 
                                    τ
                                    x
                                 
                                 ,
                                 0,0,0,0,0
                                 ]
                              
                              T
                           
                        
                     . The 
                        
                           Φ
                           (
                           
                              s
                           
                           +
                           
                              Δ
                           
                           
                              
                                 s
                              
                              
                                 
                                    τ
                                    x
                                 
                              
                           
                           )
                        
                      is obtained from the planning PDI by changing the translation τ
                     
                        x
                      to τ
                     
                        x
                     
                     +Δτ
                     
                        x
                     , while keeping the other parameters fixed. This calculation was applied to all elements of the transformation parameter set. A new objective function, J′, and the gamma pass rate, gp were calculated by using the s′. If the gp exceeded 98.0%, the optimization was finished, and the new parameter set, s′ was regarded as an optimal solution. If the gp did not exceeded 98.0%, the algorithm proceeded to the next step of evaluation of the objective function. If the J′ was smaller than the J, the parameters of c, J′ and s′ were updated to c/10, J and s, and the procedure returned to the calculation of the gradient and Hessian matrix. This process was called coarse searching. If the J′ was not smaller than the J, the c was updated to 10c, and the procedure returned to the step of calculating the Δs. This process was denoted as fine searching. The maximum number of coarse searching iterations and that of fine searching iterations were 5 and 10 times respectively. If the procedure was iterated until the maximum numbers, the iterative optimization has been stopped and the transformation parameter set with the largest pass rate in an entire iteration was regarded as the optimal transformation parameter set.

@&#REFERENCES@&#

