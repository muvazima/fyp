@&#MAIN-TITLE@&#Digital reconstruction of high-quality daily 4D cone-beam CT images using prior knowledge of anatomy and respiratory motion

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           By taking advantages of deformable image registration, we can successfully convert a single a low-quality cone-beam CT into a high-quality multi-phase cone-beam CT images.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Deformable image registration

4D CT

CBCT

Respiratory motion

Principal component analysis

@&#ABSTRACT@&#


               
               
                  Conventional in-room cone-beam computed tomography (CBCT) lacks explicit representation of patient respiratory motion and usually has poor image quality and inaccurate CT numbers for target delineation and/or adaptive treatment planning. In-room four-dimensional (4D) CBCT image acquisition is still time consuming and suffers the same issue of poor image quality. To overcome this limitation, we developed a computational framework to digitally synthesize high-quality daily 4D CBCT images using the prior knowledge of motion and appearance learned from the planning 4D CT dataset. A patient-specific respiratory motion model was first constructed from the planning 4D CT images using principal component analysis of displacement vector fields across different respiratory phases. Subsequently, the respiratory motion model as well as the image content of the planning CT was spatially mapped onto the daily CBCT using deformable image registration. The synthesized 4D images possess explicit patient motion while maintaining the geometric accuracy of patient's anatomy at the time of treatment. We validated our model by quantitatively comparing the synthesized 4D CBCT against the 4D CT dataset acquired in the same day from protocol patients undergoing daily in-room CBCT setup and weekly 4D CT for treatment evaluation. Our preliminary results have demonstrated good agreement of contours in different motion phases between the synthesized and acquired scans. Various imaging artifacts were also suppressed and soft-tissue visibility was enhanced.
               
            

@&#INTRODUCTION@&#

In radiation therapy, it is well known that patient anatomy can undergo significant changes, such as tumor shrinkage or expansion and weight loss, from the simulation phase to the delivery of radiation beam. Apparently, those changes cannot be fully compensated by rigid image alignment. Therefore, image guidance on a regular basis is critical to monitoring anatomic changes during the course of treatment. Although routine assessment of patient anatomy can generally be achieved using conventional CT, the advent of in-room cone-beam computed tomography (CBCT) [1–4] provides an accurate representation of patient anatomy prior to treatment delivery, allowing for daily patient setup, evaluation of changes in the tumor and critical structures, treatment re-planning, and dose verification/accumulation in adaptive radiotherapy [5]. However, owing to the lack of temporal information, a single 3D CBCT image may not be adequate to characterize patient anatomy when intra-fractional motion is involved during the delivery of radiation, such as the respiratory motion encountered in the treatment of thoracic cancers. Another typical challenge in the clinical application of CBCT lies in the degraded quality of CBCT images, which is mainly caused by the scatter effect when using a large flat-panel detector, imperfect beam-hardening correction, uncorrected detector signal lag, and motion artifacts during image acquisition [6]. Particularly in thoracic radiotherapy, the artifacts caused by respiratory motion generally dominate and appear as blurs and streaks in the thoracic and abdominal region (Fig. 1
                     ). These adverse effects may influence the operator's clinical decision-making, increase the inter-observer variations in image evaluation, and lead to inaccurate dose calculations [7].

Although conventional four-dimensional (4D) CT has already become a routine practice in the simulation/planning phase of radiation treatment [8–10], in-room respiratory-correlated CBCT acquisition remains a time-consuming procedure (over 4min) and thus comprises its clinical use, despite considerable research efforts that have been made on 4D CBCT image reconstruction [11–14]. Reducing 4D CBCT scan time comes at the cost of image quality. Short scan times produce images with streak artifacts, which can degrade the ability for the assessment of tumor motion from the 4D images. Therefore, alternative techniques/algorithms incorporating temporal information into daily CBCT imaging are needed. To address the aforementioned challenges, we herein propose a computational framework for the digital synthesis of high-quality daily 4D CBCT images for image-guided treatment of thoracic cancer. The synthesized daily 4D images possess explicit respiratory motion of the patient, and their quality is comparable to that of conventional CT images, while maintaining the shape and geometric representation of the patient defined by in-room CT prior to the treatment. The motivation for developing our algorithm is to use the prior knowledge of the respiratory motion and CT number explicitly defined in the treatment planning/simulation 4D CT images. Simply put, our strategy is to transfer the respiratory motion pattern and calibrated CT number from planning CT images to daily CBCT images. The transferred respiratory motion will be used to derive 4D CBCT images, whereas the mapped CT number will enhance the CBCT image quality. The assumption underlying our algorithm is that, although the patient's anatomy may deviate significantly after the treatment planning phase, the pattern of respiratory motion can be characterized using a parametric motion model for a specific subject. Previous studies have shown that patients’ breathing motion is not reproducible for each breathing cycle, and irregular breathing is usually not predictable [15,16]. Nonetheless, it is a viable approach to characterize patient's regular respiratory motion components using planning 4D CT images.

Previous research efforts have presented interesting work toward deriving a prior patient-specific respiratory motion model and the use of prior knowledge of motion to correct CBCT artifacts. Broadly speaking, this research effort can be categorized into two streams. The first stream is direct acquisition of 4D CBCT images, which involves sorting CBCT projections based on the respiratory signal. Although 4D CBCT reconstructions have been successfully demonstrated by some researchers [11–14], the compromise between image acquisition time and image quality still poses a challenge to its practical use as an in-room image guidance solution. In-room image guidance usually requires a short scanning time, but reducing the scan time comes at the cost of image quality. Usually, the reconstruction of 4D CBCT images within clinically acceptable periods results in images with streaky aliasing artifacts caused by insufficient angular sampling of CBCT projections at each respiratory phase. The degraded image quality thus compromises the accuracy of tumor motion assessment and patient positioning. The alternative solution for dealing with respiratory motion is to reconstruct motion-compensated daily CBCT images with reduced motion artifacts. The key is to incorporate patient motion into the CBCT reconstruction procedure, which involves the challenging problem of estimating patient motion from the cone-beam projections. To address this problem, some authors have proposed taking advantage of knowledge of prior respiratory motion obtained using conventional CT images. In a study, researchers estimated patient motion by matching the CBCT projection sequence with the CT projection sequence simulated from a B-spline deformed reference CT image; complicated optimization was involved in the estimation of the B-spline parameters [26]. Also, Sonke et al. 
                     [24] described an approach to reconstruct respiratory motion-compensated CBCT images using prior motion knowledge in the planning 4D CT, in which the prior motion was directly represented by displacement vector fields from a reference phase to the rest phases calculated using a phase-based optical flow algorithm. Similarly, Vandemeulebroucke et al. 
                     [25] used the motion defined in the planning 4D CT set; they also used a B-spline temporal model to represent displacement vector fields to reduce the number of parameters. More recently, Zhang et al. 
                     [23] developed an algorithm to correct CBCT motion artifacts using a PCA-based patient-specific motion model [19]. They used this patient-specific motion model to deformably combine respiratory-correlated CBCT data sets into a single high-quality CBCT set with reduced motion-introduced blur. More recently, digital reconstruction of daily free breathing 4D CT images has been reported by Wu et al. [35]. However, the reconstruction of 4D CBCT presents more challenges than that of 4D CT due to the inherent poor image quality.

In our approach, deformable image registration plays a key role in establishing dense voxel-by-voxel correspondences across different phases of planning 4D CT images (intra-fractional displacement vector fields) and between daily CBCT and planning 4D CT images (inter-fractional displacement vector fields). Specifically, we first used intra-fractional displacement vector fields to create a low-dimensional respiratory motion model and then spatially mapped this model as well as calibrated CT number of planning CT images to CBCT image domain using inter-fractional displacement vector fields. Proof-of-concept experimental results on a proton protocol of lung cancer patients have demonstrated the potential of this approach.

A patient's respiratory motion can be explicitly described by a 4D CT image set, which consists of a set of phase-binned CT images (usually ten phases) representing different respiratory motion states. However, incorrect phase tagging due to irregular motion can lead to severe motion artifacts, and the 4D CT reconstructions are available only at discrete phases. To have a better motion representation, a respiratory motion model is desirable to allow for image interpolations at arbitrary phases during a respiratory cycle. On the other hand, the use of a respiratory motion model makes it easier for 4D CT images to be transferred to the CBCT with minimal impact from motion artifacts.

To create the respiratory motion model, a reference image should be identified from the 4D CT image set. In this study, we chose the averaged planning CT as the reference image, which is defined as
                        
                           (1)
                           
                              
                                 
                                    CT
                                    
                                       ave
                                    
                                 
                                 (
                                 
                                    x
                                    →
                                 
                                 )
                                 =
                                 
                                    1
                                    T
                                 
                                 
                                    ∑
                                    
                                       t
                                       =
                                       1
                                    
                                    T
                                 
                                 
                                    CT
                                    (
                                 
                                 
                                    x
                                    →
                                 
                                 ,
                                    
                                 t
                                 )
                              
                           
                        
                     
                  

where, vector 
                        
                           x
                           →
                        
                      indicates the voxel location in 3D space, t indices the phases in 4D CT image set, and T is the number of phases (T
                     =10 phases are reconstructed for our scanners). Averaged CT is generally used as the planning CT to account for tumor motion in radiation therapy. Deformable image registration was then performed from each of the phases to the averaged planning CT to establish dense correspondences. We used a dual-force demons deformable image registration algorithm [28], which was proved to be of good accuracy and better convergence than the traditional one [29]. The validation of this in-house algorithm in the context of 4D CT images has been investigated on published data sets. Each of the displacement vector fields can be represented as a 3-tuple 
                        
                           
                              
                                 
                                    
                                       D
                                       →
                                    
                                    
                                       LR
                                    
                                 
                                 (
                                 
                                    x
                                    →
                                 
                                 ,
                                    
                                 t
                                 )
                                 ,
                                    
                                 
                                    
                                       D
                                       →
                                    
                                    
                                       AP
                                    
                                 
                                 (
                                 
                                    x
                                    →
                                 
                                 ,
                                    
                                 t
                                 )
                                 ,
                                    
                                 
                                    
                                       D
                                       ⇀
                                    
                                    
                                       SI
                                    
                                 
                                 (
                                 
                                    x
                                    →
                                 
                                 ,
                                    
                                 t
                                 )
                              
                           
                        
                     , where 
                        
                           
                              
                                 D
                                 →
                              
                              
                                 LR
                              
                           
                           (
                           .
                           )
                        
                     , 
                        
                           
                              
                                 D
                                 →
                              
                              
                                 AP
                              
                           
                           (
                           .
                           )
                        
                      and 
                        
                           
                              
                                 D
                                 →
                              
                              
                                 SI
                              
                           
                           (
                           .
                           )
                        
                      represent the displacement field matrices from phase t to the reference image along the left–right (LR), anterior–posterior (AP), and superior–inferior (SI) directions. We derived a patient-specific respiratory motion model using principal component analysis (PCA) of the displacement vector fields. Specifically, let 
                        
                           
                              
                                 d
                                 →
                              
                              i
                           
                           (
                           t
                           )
                        
                     , i
                     =LR, AP and SI, be the columnwise vectorization of the displacement field for phase t, and 
                        
                           
                              D
                              i
                           
                           =
                           {
                           
                              
                                 d
                                 →
                              
                              i
                           
                           (
                           1
                           )
                           ,
                              
                           
                              
                                 d
                                 →
                              
                              i
                           
                           (
                           2
                           )
                           ,
                           ...
                           ,
                           
                              
                                 d
                                 →
                              
                              i
                           
                           (
                           T
                           )
                           }
                        
                     , i
                     =LR, AP and SI, be the matrix consisting of T displacement fields (T
                     =10). First, we calculated the sample covariance matrix of D
                     
                        i
                     , given as
                        
                           (2)
                           
                              
                                 
                                    Σ
                                    i
                                 
                                 =
                                 
                                    1
                                    
                                       T
                                       −
                                       1
                                    
                                 
                                 
                                    ∑
                                    
                                       t
                                       =
                                       1
                                    
                                    T
                                 
                                 
                                    (
                                    
                                       
                                          d
                                          →
                                       
                                       i
                                    
                                    (
                                    t
                                    )
                                    −
                                    
                                       
                                          
                                             d
                                             ¯
                                          
                                          →
                                       
                                       i
                                    
                                    )
                                    
                                       
                                          (
                                          
                                             
                                                d
                                                →
                                             
                                             i
                                          
                                          (
                                          t
                                          )
                                          −
                                          
                                             
                                                
                                                   d
                                                   ¯
                                                
                                                →
                                             
                                             i
                                          
                                          )
                                       
                                       T
                                    
                                 
                                 ,
                                  
                                 i
                                 =
                                 LR,
                                    
                                 AP,
                                    
                                 SI
                              
                           
                        
                     where, the column vector 
                        
                           
                              
                                 
                                    d
                                    ¯
                                 
                                 →
                              
                              i
                           
                        
                      represented the sample mean given as
                        
                           (3)
                           
                              
                                 
                                    
                                       
                                          d
                                          ¯
                                       
                                       →
                                    
                                    i
                                 
                                 =
                                 
                                    1
                                    T
                                 
                                 
                                    ∑
                                    
                                       t
                                       =
                                       1
                                    
                                    T
                                 
                                 
                                    
                                       
                                          d
                                          →
                                       
                                       i
                                    
                                    (
                                    t
                                    )
                                 
                                 ,
                                  
                                 i
                                 =
                                 LR,
                                    
                                 AP,
                                    
                                 SI
                              
                           
                        
                     
                  

An optimal transformation that maps the original high-dimensional space onto a low-dimensional subspace can be obtained by solving eigen values and eigen vectors of the covariance matrix as
                        
                           (4)
                           
                              
                                 
                                    Σ
                                    i
                                 
                                 
                                    λ
                                    i
                                    
                                       (
                                       j
                                       )
                                    
                                 
                                 =
                                 
                                    λ
                                    i
                                    
                                       (
                                       j
                                       )
                                    
                                 
                                 
                                    
                                       φ
                                       →
                                    
                                    i
                                    
                                       (
                                       j
                                       )
                                    
                                 
                                 ,
                                  
                                 i
                                 =
                                 LR,
                                    
                                 AP,
                                    
                                 SI
                                 ;
                                    
                                 j
                                 =
                                 1,2,...
                                 ,
                                 T
                              
                           
                        
                     where, 
                        
                           
                              λ
                              i
                              
                                 (
                                 j
                                 )
                              
                           
                        
                      and 
                        
                           
                              
                                 φ
                                 →
                              
                              i
                              
                                 (
                                 j
                                 )
                              
                           
                        
                      are the jth eigen value and eigen vector of Σ
                     
                        i
                     , respectively. We observed from more than 50 4D CT image sets that the principal motion basis 
                        
                           
                              
                                 φ
                                 →
                              
                              i
                              
                                 (
                                 1
                                 )
                              
                           
                        
                     , the eigen vector corresponding to the largest eigen value, was capable of capturing more than 85% of the total variations of displacement fields. This means that the transformation matrix Σ
                     
                        i
                      
                     i
                     =LR, AP, SI can be described by the principal motion basis 
                        
                           
                              
                                 φ
                                 →
                              
                              i
                              
                                 (
                                 1
                                 )
                              
                           
                        
                      only. Dropping off the superscript in the principal motion basis, the displacement field at phase t, 
                        
                           
                              
                                 d
                                 →
                              
                              i
                           
                           (
                           t
                           )
                        
                      can be represented by the projection coefficient onto the one-dimensional subspace spanned by 
                        
                           
                              
                                 φ
                                 →
                              
                              i
                           
                        
                      as
                        
                           (5)
                           
                              
                                 
                                    α
                                    i
                                 
                                 (
                                 t
                                 )
                                 =
                                 
                                    
                                       φ
                                       →
                                    
                                    i
                                    T
                                 
                                 (
                                 
                                    
                                       d
                                       →
                                    
                                    i
                                 
                                 (
                                 t
                                 )
                                 −
                                 
                                    
                                       
                                          d
                                          ¯
                                       
                                       →
                                    
                                    i
                                 
                                 )
                                 ,
                                  
                                 i
                                 =
                                 LR,
                                    
                                 AP,
                                    
                                 SI
                              
                           
                        
                     
                  

To this point, the motion versus time is described by the projection coefficients 
                        
                           
                              
                                 
                                    α
                                    i
                                 
                                 (
                                 1
                                 )
                                 ,
                                    
                                 
                                    α
                                    i
                                 
                                 (
                                 2
                                 )
                                 ,
                                 ...
                                 ,
                                 
                                    α
                                    i
                                 
                                 (
                                 T
                                 )
                                  
                                 i
                                 =
                                 LR,
                                    
                                 AP,
                                    
                                 SI
                              
                           
                        
                      at T (T
                     =10) discrete points, which was determined inherently by the CT scanner. The limited temporal resolution impedes the reconstruction of 4D CT at many time points. To solve this problem, a continuous temporal function β
                     
                        i
                     (t) can be fitted to these discrete coefficients for each direction, i
                     =LR, AP, SI by minimizing the following Eq.:
                        
                           (6)
                           
                              
                                 
                                    β
                                    i
                                 
                                 (
                                 t
                                 )
                                 =
                                 
                                    
                                       arg
                                       min
                                    
                                    
                                       
                                          β
                                          i
                                       
                                       (
                                       t
                                       )
                                    
                                 
                                 
                                    
                                       λ
                                       
                                          ∑
                                          
                                             k
                                             =
                                             1
                                          
                                          T
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         β
                                                         i
                                                      
                                                      (
                                                      t
                                                      )
                                                      −
                                                      
                                                         α
                                                         i
                                                      
                                                      (
                                                      k
                                                      )
                                                   
                                                
                                             
                                             2
                                          
                                       
                                    
                                 
                                 
                                    
                                       +
                                       (
                                       1
                                       −
                                       λ
                                       )
                                       
                                          ∫
                                          1
                                          T
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               ∂
                                                               2
                                                            
                                                            
                                                               β
                                                               i
                                                            
                                                            (
                                                            t
                                                            )
                                                         
                                                         
                                                            ∂
                                                            
                                                               t
                                                               2
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             2
                                          
                                          d
                                          t
                                       
                                    
                                 
                                 ,
                              
                           
                        
                     where, the first term describes the data loyalty and the second term controls the smoothness. The parameter λ is the weighted parameters balancing the data loyalty and smoothness terms. In our implementation, λ was set to 0.9 based on experimental tests. The fitted continuous function β
                     
                        i
                     (t) turns to be a cubic spline function. With 
                        
                           
                              
                                 φ
                                 →
                              
                              i
                           
                        
                      and β
                     
                        i
                     (t), i
                     =LR, AP, SI available, the respiratory motion function was readily reconstructed along each direction via a linear combination of principal motion bases that characterized the regular motion component, resulting in the following function:
                        
                           (7)
                           
                              
                                 
                                    
                                       D
                                       →
                                    
                                    
                                       4DCT
                                    
                                 
                                 (
                                 
                                    x
                                    ⇀
                                 
                                 ,
                                    
                                 t
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         D
                                                         →
                                                      
                                                      
                                                         LR
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   ,
                                                      
                                                   t
                                                   )
                                                   =
                                                   
                                                      
                                                         
                                                            d
                                                            ¯
                                                         
                                                         →
                                                      
                                                      
                                                         LR
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                   +
                                                   
                                                      β
                                                      
                                                         LR
                                                      
                                                   
                                                   (
                                                   t
                                                   )
                                                   
                                                      
                                                         φ
                                                         →
                                                      
                                                      
                                                         LR
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      
                                                         D
                                                         →
                                                      
                                                      
                                                         AP
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   ,
                                                      
                                                   t
                                                   )
                                                   =
                                                   
                                                      
                                                         
                                                            d
                                                            ¯
                                                         
                                                         →
                                                      
                                                      
                                                         AP
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                   +
                                                   
                                                      β
                                                      
                                                         AP
                                                      
                                                   
                                                   (
                                                   t
                                                   )
                                                   
                                                      
                                                         φ
                                                         →
                                                      
                                                      
                                                         AP
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      
                                                         D
                                                         →
                                                      
                                                      
                                                         SI
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   ,
                                                      
                                                   t
                                                   )
                                                   =
                                                   
                                                      
                                                         
                                                            d
                                                            ¯
                                                         
                                                         →
                                                      
                                                      
                                                         SI
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                   +
                                                   
                                                      β
                                                      
                                                         SI
                                                      
                                                   
                                                   (
                                                   t
                                                   )
                                                   
                                                      
                                                         φ
                                                         →
                                                      
                                                      
                                                         SI
                                                      
                                                   
                                                   (
                                                   
                                                      x
                                                      →
                                                   
                                                   )
                                                
                                             
                                          
                                       
                                       ,
                                    
                                 
                              
                           
                        
                     where, 
                        
                           x
                           →
                        
                      indices the voxel location and 
                        
                           
                              
                                 
                                    d
                                    ¯
                                 
                                 →
                              
                              i
                           
                           (
                           .
                           )
                        
                      represents the mean displacement field over all phases as defined in Eq. (3). The variable t in Eq. (7) is continuous and can be sampled at any time point to obtain a reconstructed phased CT image [17]. Similar PCA models have been validated by several previous studies [18–22] to have the capability in accurately characterizing the respiratory motion.

Digital reconstruction of 4D CBCT images requires mapping the respiratory motion model and the calibrated CT number from the 4D CT images to the single daily CBCT image. To do so, we shall first establish the voxel-level correspondence between the planning 4D CT and the daily CBCT images.

Dense correspondences between planning 4D CT and daily CBCT can be established using aforementioned deformable image registration. An appropriate CT image should be first selected carefully from the 4D CT data set for the registration purpose. The CT number of this data set should be the one that best matches that of the daily CBCT images so that errors caused by intensity-based registration will be minimal. The CBCT projection images are acquired with a low gantry speed in the presence of respiratory motion; these motion-blurred 2D projections are used to reconstruct a 3D CBCT volume encoding information from all the different phases. As a result, the reconstructed 3D CBCT volume tends to have more similarities in intensity distribution with the averaged CT set than with any of the other phases in the planning 4D CT set. To establish dense correspondences across daily CBCT images and the averaged planning CT images, an in-house developed, dual-force intensity-based Demons algorithm was used. Therefore, averaged planning CT was registered to the daily CBCT image to serve as the connection between the planning 4D CT set with the daily CBCT. This is also the reason that we chose the averaged planning CT as the reference image in creating the respiratory motion model. An explicit assumption about intensity-based methods is that the intensity distribution will be consistent across the image pair to be registered. Unfortunately, this assumption may be violated when applied to CT-CBCT registration, as CBCT images usually do not possess the accurate Hounsfield units as calibrated in conventional CT. To alleviate this inconsistency, we used an intensity normalization approach to pre-process the CBCT–CT image pairs. By using local histogram equalization, this approach can simultaneously matche image intensities across an image pair and enhances image intensities within low-contrast regions. Our previous study [30] demonstrated the effectiveness of this intensity normalization algorithm in dealing with intensity inconsistency and low image contrast in CBCT–CT registration. A similar approach has been proposed and validated in [31]. Mathematically, the displacement vector field obtained from deformable image registration represents a dense mapping 
                           
                              
                                 x
                                 →
                              
                              =
                              
                                 γ
                                 →
                              
                              (
                              
                                 y
                                 →
                              
                              )
                           
                         from the daily CBCT domain 
                           
                              
                                 y
                                 →
                              
                              ∈
                              
                                 R
                                 3
                              
                           
                         to the planning average CT domain 
                           
                              
                                 x
                                 →
                              
                              ∈
                              
                                 R
                                 3
                              
                           
                        .

Since the respiratory motion model was defined on the averaged planning CT image, with the mapping between averaged planning CT and the daily CBCT image available, it is straightforward to transfer the respiratory motion from the planning CT domain to the daily CBCT domain. A compositional mapping could be created using the respiratory motion model described by Eq. (7) and the aforementioned mapping from the daily CBCT to the averaged planning CT. The respiratory motion model on the daily CBCT can be formally represented as
                           
                              (8)
                              
                                 
                                    
                                       
                                          D
                                          →
                                       
                                       
                                          CBCT
                                       
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    ,
                                       
                                    t
                                    )
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            D
                                                            →
                                                         
                                                         
                                                            LR
                                                         
                                                         
                                                            CBCT
                                                         
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      ,
                                                         
                                                      t
                                                      )
                                                      =
                                                      
                                                         
                                                            
                                                               d
                                                               ¯
                                                            
                                                            →
                                                         
                                                         
                                                            LR
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                      +
                                                      
                                                         β
                                                         
                                                            LR
                                                         
                                                      
                                                      (
                                                      t
                                                      )
                                                      
                                                         
                                                            φ
                                                            →
                                                         
                                                         
                                                            LR
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            D
                                                            →
                                                         
                                                         
                                                            AP
                                                         
                                                         
                                                            CBCT
                                                         
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      ,
                                                         
                                                      t
                                                      )
                                                      =
                                                      
                                                         
                                                            
                                                               d
                                                               ¯
                                                            
                                                            →
                                                         
                                                         
                                                            AP
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                      +
                                                      
                                                         β
                                                         
                                                            AP
                                                         
                                                      
                                                      (
                                                      t
                                                      )
                                                      
                                                         
                                                            φ
                                                            →
                                                         
                                                         
                                                            AP
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            D
                                                            →
                                                         
                                                         
                                                            SI
                                                         
                                                         
                                                            CBCT
                                                         
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      ,
                                                         
                                                      t
                                                      )
                                                      =
                                                      
                                                         
                                                            
                                                               d
                                                               ¯
                                                            
                                                            →
                                                         
                                                         
                                                            SI
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                      +
                                                      
                                                         β
                                                         
                                                            SI
                                                         
                                                      
                                                      (
                                                      t
                                                      )
                                                      
                                                         
                                                            φ
                                                            →
                                                         
                                                         
                                                            SI
                                                         
                                                      
                                                      (
                                                      
                                                         γ
                                                         →
                                                      
                                                      (
                                                      
                                                         y
                                                         →
                                                      
                                                      )
                                                      )
                                                   
                                                
                                             
                                          
                                       
                                    
                                    .
                                 
                              
                           
                        
                     

Using Eq. (8), we can derive the CBCT at any phase t by warping the original CBCT image using the following equation,
                           
                              (9)
                              
                                 
                                    
                                       I
                                       t
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    )
                                    =
                                    
                                       I
                                       
                                          CBCT
                                       
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    +
                                    
                                       
                                          D
                                          →
                                       
                                       
                                          CBCT
                                       
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    ,
                                    t
                                    )
                                    )
                                    .
                                 
                              
                           
                        
                     

Mapping respiratory motion model to the CBCT domain can be referred to Fig. 2
                        . To this end, we were able to create 4D CBCT images with the image contents defined by the CT numbers in the daily CBCT image.

Although the 4D CBCT data set can be synthesized as described in the preceding section, the image quality of synthesized images might be even worse than that of the original CBCT images after deformable warping of the poor-quality daily CBCT images. To address this problem, we used the well-calibrated Hounsfield units defined in the planning CT, and replaced the image content (CT number) in the daily CBCT with that of the planning CT on a voxel-by-voxel basis [32]. Although one can directly warp the averaged planning CT images to the CBCT images by 
                           
                              
                                 x
                                 →
                              
                              =
                              γ
                              (
                              
                                 y
                                 →
                              
                              )
                           
                        , but the image blur in the averaged CT image was also propagated to the mapped CBCT images (Fig. 3
                        ). To further reduce the blurring effect, we propose a two-step procedure that uses a particular phase from the planning 4D CT set as the original source of the image content, which is free of image blur. Our criterion is to find a phase from 4D CT images that undergoes the least amount of deformation from the average planning CT. Formally, if 
                           
                              
                                 
                                    D
                                    →
                                 
                                 
                                    4DCT
                                 
                              
                              (
                              
                                 x
                                 →
                              
                              ,
                                 
                              t
                              )
                           
                         denotes the 4D motion function defined in Eq. (7), the optimal phase is defined as 
                           
                              I
                              (
                              
                                 z
                                 →
                              
                              ,
                                 
                              
                                 t
                                 *
                              
                              )
                           
                        , in which 
                           
                              
                                 t
                                 *
                              
                              =
                              arg
                              
                                 
                                    min
                                 
                                 t
                              
                              
                                 
                                    
                                       
                                          D
                                          →
                                       
                                       
                                          4DCT
                                       
                                    
                                    (
                                    
                                       x
                                       →
                                    
                                    ,
                                    t
                                    )
                                 
                              
                           
                        . In our experiments, the optimal phase selected based on our procedure was usually about T30% or T70%, which is very close to that in mid-ventilation images [33,34]. To transfer CT numbers, a dense mapping, denoted by 
                           
                              
                                 z
                                 →
                              
                              =
                              κ
                              (
                              
                                 y
                                 →
                              
                              )
                           
                        , from the daily CBCT domain 
                           
                              y
                              →
                           
                         to the mid-ventilation phase domain 
                           
                              z
                              →
                           
                         must be established. In fact, the function 
                           
                              
                                 z
                                 →
                              
                              =
                              κ
                              (
                              
                                 y
                                 →
                              
                              )
                           
                         was reduced to the additive composition of two consecutive mappings 
                           
                              
                                 x
                                 →
                              
                              =
                              
                                 γ
                                 →
                              
                              (
                              
                                 y
                                 →
                              
                              )
                           
                        , which maps from the CBCT domain 
                           
                              y
                              →
                           
                         to the averaged planning CT domain 
                           
                              x
                              ⇀
                           
                        , and 
                           
                              
                                 z
                                 →
                              
                              =
                              
                                 
                                    D
                                    →
                                 
                                 
                                    4DCT
                                 
                              
                              (
                              
                                 x
                                 →
                              
                              ,
                              
                                 t
                                 *
                              
                              )
                           
                        , which maps from the averaged planning CT 
                           
                              x
                              ⇀
                           
                         to the mid-ventilation CT domain 
                           
                              z
                              →
                           
                        . This mapping was formally defined as Eq. (10).
                           
                              (10)
                              
                                 
                                    
                                       z
                                       →
                                    
                                    =
                                    κ
                                    (
                                    y
                                    )
                                    =
                                    γ
                                    (
                                    
                                       y
                                       →
                                    
                                    )
                                    +
                                    
                                       
                                          D
                                          →
                                       
                                       
                                          4DCT
                                       
                                    
                                    (
                                    
                                       γ
                                       →
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    )
                                    ,
                                       
                                    
                                       t
                                       *
                                    
                                    )
                                 
                              
                           
                        
                     

This mapping can be used to transfer the calibrated CT number in the selected phase image in 4D CT, to the synthesized 4D CBCT images. Combining Eqs. (9) and (10), this CT number mapping can be formally defined as
                           
                              (11)
                              
                                 
                                    
                                       I
                                       t
                                    
                                    (
                                    
                                       y
                                       →
                                    
                                    )
                                    =
                                    
                                       I
                                       
                                          
                                             t
                                             *
                                          
                                       
                                    
                                    (
                                    
                                       κ
                                       
                                          −
                                          1
                                       
                                    
                                    (
                                    
                                       z
                                       →
                                    
                                    )
                                    +
                                    
                                       
                                          D
                                          →
                                       
                                       
                                          CBCT
                                       
                                    
                                    (
                                    
                                       κ
                                       
                                          −
                                          1
                                       
                                    
                                    (
                                    
                                       z
                                       →
                                    
                                    )
                                    ,
                                       
                                    t
                                    )
                                    )
                                    .
                                 
                              
                           
                        
                     

The synthesized 4D CBCT images possessed the image quality comparable to that of conventional CT images, but maintained the anatomy representation at the time of treatment. Fig. 4
                         demonstrated the superior image quality of the proposed approach.

@&#RESULTS@&#

First-generation CBCT system (Trilogy, Varian Oncology Systems, Palo Alto, CA) was used to acquire the projection data and perform the 3D reconstruction. The 2D projections were acquired using the kilo-voltage X-ray mode at 125KVp. The spatial resolution of the projection images was 1024×768pixels. The SAD (source-to-axis distance) and SDD (source-to-detector distance) of the CBCT system were set to 100cm and 150cm, respectively, the image acquisition takes less than 1min. The axial resolution of the reconstructed CT images was 512×512pixels with a slice thickness of 2.5mm and a field of view of 45mm

The 4D CT images were acquired using a positron emission tomography/CT scanner in the axial mode (Discovery ST, GE Healthcare, Milwaukee, WI) via a technique described by Pan et al. 
                        [27]. For 4D CT image acquisition, a real-time positioning management system (Varian Medical Systems, Polo Alto, CA) was used to generate an external signal of the respiratory motion of the thorax. A cine scanning protocol was used to acquire time-dependent volumetric CT images with patient-specific time intervals per table position and a slab thickness of 2cm. After projection images were acquired, the projections were retrospectively sorted into 10 equal phases based on the time and phase information provided by the respiratory signal to construct the 4D CT images. The average CT set used for treatment planning at our institution was reconstructed using a simple calculation of the average intensity from ten phase images on a voxel-by-voxel basis.

We first evaluated the improvement in image quality using our proposed procedure to reconstruct the 4D CBCT images. For a fair comparison, we evaluated the image quality of the original CBCT against the converted image generated using Eq. (11) because these two images were in the same spatial domain. Two types of regions of interest were defined on both images: a uniform region with mono-modal density distribution (yellow contours in Fig. 4) and a region with bi-modal like distribution (green contours in Fig. 4), and the histograms in these regions were computed for the evaluation of image quality. It was clearly shown that the histogram of the uniform region was more peaked in converted image than in original CBCT image. The standard deviation of image intensities over this region was around 69 in the original CBCT image, and this number reduced to around 49 over the same region in the converted CT image. For the bi-modal like regions the two Gaussian modes in the histogram that represent the lung and soft tissue appears to be much more distinguishable and differentiable in the converted image, indicating better contrast across different anatomies. To quantitatively evaluate the improvement, we adopted fisher discriminant analysis, which is defined as the ratio of between-class scatter and within-class scatter to characterize the severability between two classes, denoted as 
                           
                              f
                              =
                              
                                 
                                    
                                       
                                          (
                                          
                                             μ
                                             1
                                          
                                          −
                                          
                                             μ
                                             2
                                          
                                          )
                                       
                                       2
                                    
                                 
                                 
                                    
                                       σ
                                       1
                                       2
                                    
                                    +
                                    
                                       σ
                                       2
                                       2
                                    
                                 
                              
                           
                        , where μ and σ stand for the mean and the standard deviation of each class, which were calculated by fitting a Gaussian mixture model of the histogram of the region of interest, and the larger f implies the better separability between two classes. For this case, f increases from 6.8 to 9.7 after applying CT number mapping.

An evaluation was also demonstrated in Fig. 5
                         with a set of synthesized 4D CBCT images for a lung cancer patient who underwent Stereotactic Body Radiation Therapy (SBRT) to treat a small tumor near diaphragm. As shown in Fig. 5, various CBCT imaging artifacts disappeared in the synthesized 4D CBCT images; the soft-tissue visibility and the image contrast were also improved. Particularly, whereas the small lesion close to the diaphragm is nearly indistinguishable from the diaphragm in the original CBCT image (indicated by the red arrow), the boundary across the lesion and diaphragm is clearly visible in the synthesized 4D CBCT images.

Treatment plan might need changes if the tumor or critical structures under irradiation may undergo significant change during radiation treatment course. Adaptive radiation therapy evaluates the anatomy and tumor changes by using daily/weekly imaging (e.g., CBCT) to determine the requirement of replanning. We will show that our algorithm is capable of endowing motion information to the up-to-date anatomy of the patient defined in the daily 3D CBCT. Although simultaneously reconstructed 4D CBCT images were not available as the ground-truth for the validation of our algorithm. Nonetheless, it is still useful to compare synthesized daily 4D CBCT images with the conventional daily 4D CT images (if available) acquired at the same time or close to the time the CBCT images were acquired. We evaluated images from patients undergoing adaptive thoracic proton radiotherapy as part of a protocol at our institution, under which weekly in-room CBCT scans and conventional 4D CT scans were acquired for adaptive replanning. In this study, we presented the results of three thoracic patients. These three patients had both weekly CBCT scans and weekly 4D CT scans acquired at the same day for replanning evaluation. Radiation oncologists drew the lung and tumor contours on the averaged planning CT manually (Picture A in Fig. 6
                        ). These contours were first deformed to the weekly 4D CT images, edited and approved by the physician. The contours on averaged planning CT were also rigidly transferred to the week 5 CBCT and overlaid on the image, as shown in the Picture B in Fig. 6. The rigidly transformed tumor contours showed the tumor shrinkage during the treatment, as indicated by the red arrow in the figure. The mapping defined by Eq. (8) was used to reconstruct the motion for 4D CBCT images, and it could also be used to transfer the contours on the averaged planning CT to any phase of the synthesized 4D CBCT. Picture C in Fig. 6 showed the synthesized week 5 4D CBCT image at inhale phase T
                        =0% using Eq. (8). along with the transferred contours We overlaid these transferred contours in picture C on the phase T
                        =0% of the weekly 4D CT (picture D in Fig. 6) acquired at the same time as the CBCT, and compared them with the clinically approved contours. The Dice similarity coefficients were calculated to quantitatively assess lung and tumor volume overlaps. For the lung, the Dice values were 92% for the first case and 97.1% for the second case, whereas for the tumor, the Dice values were 90.2% and 82.5%, respectively. Fig. 7
                         showed a case where the target defined in CBCT has significant shrinkage from planning phase. The check-board pattern based fusion of reconstructed CBCT image and 4D CT image was used for the assessment of the quality of the image maching. The good agreement of the contours and image implied that the synthesized 4D CBCT images were very similar to the corresponding weekly 4D CT images acquired directly from the scanner, thus demonstrated the potential of the proposed 4D CBCT reconstruction approach.

@&#DISCUSSION@&#

The procedure proposed in this study is different from, yet still related to the aforementioned research. Our approach does not explicitly reconstruct 4D CBCT images by sorting projection data. Instead, we take advantage of the prior respiratory motion information defined in the planning 4D CT set. Although other researchers have used prior motion model for motion-compensated CBCT reconstruction, our approach directly transfers motion and image content from conventional CT images onto CBCT domains using deformable registration between CT and CBCT images to account for anatomical changes. Therefore, the synthesized images possess explicit motion and accurate CT numbers along with up-to-date anatomical information defined in the original CBCT images. Although we originally defined this procedure for daily CBCT, the key idea can be readily applied to conventional daily free-breathing CT to synthesize conventional 4D CT images. The most computationally intensive portion of our procedure lies in the deformable registrations across the planning 4D CT set. However, it can be calculated off-line on planning 4D CT images, and applied to all the daily images during the course of radiation treatment. In fact, daily 4D image synthesis involves the use of single deformable registration (CBCT versus CT) and up to 10 image warping operations. This process takes less than 1min using a workstation with an Intel Pentium multi-core processor and a parallel implementation of deformable image registration algorithm. Although our preliminary results with limited data have shown some potential for daily 4D image guidance, comprehensive validation of these results is necessary in a future study to confirm the accuracy of our model. The key to our procedure is that deformable image registration can be accurately established between planning CT and daily CBCT so that both motion and image content can be mapped voxel by voxel to the CBCT domain. Unfortunately, this may not be true in some situations. A typical scenario is that when substantial tumor shrinkage presents, intensity-based registrations algorithms can fail to create meaningful dense correspondences. To address such difficulties, the integration of a prior shape model of the target defined automatically or interactively by the users may be useful to enhance the robustness of the deformable registrations.

In image-guided adaptive therapy, dose calculaton on daily CT images plays a crucial role in the evaluation of dosimetric impact of anatomical changes of the patient for possible replanning. Particularly for thoracic patients, the dosimetric effect of respiratory motion should also be assessed. Image and motion artifacts in daily CBCT images can severely distort the CT numbers as well as the shape of the targets, leading to inaccurate dose calculation. In addition, a single free breathing 3D CBCT image is not adequate to calculate dose at different stages of respiratory phases. The proposed approach transfers both the image content and motion model into daily 3D CBCT data to synthesize 4D CBCT images with enhanced image quality. The synthesized daily 4D CBCT images possess explicit respiratory motion of the patient, and their image quality is comparable with that of conventional CT images. Using images with better quality, there will be lese uncertainties in the dose calculation for the decision of replanning. With explicit respiratory information, one can evaluate dosimetric effect of the motion at the time of the daily treatment by calculating dose at exhale and inhale images (e.g., T
                     =0% and T
                     =50%).

@&#CONCLUSIONS@&#

We have proposed a novel framework for generating improved daily 4D CBCT images via deformable mapping of prior respiratory motion and appearance information defined in the planning 4D CT. The synthesized daily 4D CBCT images possess explicit respiratory motion of the patient, and their image quality is comparable with that of conventional CT images. At the same time, the patient's shape and geometric representation defined by in-room CT before daily treatment is maintained using our framework. Proof-of-principal experiments with various patient cases have demonstrated the potential of our approach in improving on-line image and motion evaluation for adaptive replanning and dose verification.

@&#ACKNOWLEDGMENTS@&#

This project is partially supported by CPRIT (Cancer Prevention Research Institute of Texas) grant RP110562-P2. The authors would also like to thank Donald Norwood and Markeda Wade from the Department of Scientific Publications at The University of Texas MD Anderson Cancer Center for editing this manuscript.

@&#REFERENCES@&#

