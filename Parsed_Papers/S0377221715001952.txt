@&#MAIN-TITLE@&#Optimal crude oil procurement under fluctuating price in an oil refinery

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           We consider a practical decision problem faced by many Chinese oil refineries—the optimal procurement of crude oil.


                        
                        
                           
                           This problem is extremely hard for three reasons—highly volatile crude oil prices, high dimensions and a multiperiod time horizon.


                        
                        
                           
                           We introduce an approximate stochastic dynamic programming method.


                        
                        
                           
                           Numerical results reveal that this complex oil procurement problem can be approximately solved with little loss of optimality.


                        
                        
                           
                           The approximate solution significantly outperforms a set of myopic policies that are currently used.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Uncertainty modelling

Risk management

Refinery operation

Procurement

Fluctuating price

@&#ABSTRACT@&#


               
               
                  In this paper, we study the optimal procurement and operation of an oil refinery. The crude oil prices follow geometric Brownian motion processes with correlation. We build a multiperiod inventory problem where each period involves an operation problem such as separation or blending. The decisions are the amount of crude oils to purchase and the amount of oil products to produce. We employ approximate dynamic programming methods to solve this multiperiod multiproduct optimization problem. Numerical results reveal that this complex problem can be approximately solved with little loss of optimality. Further, we find that the approximate solution significantly outperforms a set of myopic policies that are currently used.
               
            

@&#INTRODUCTION@&#

The economics of a refinery mainly depends on the interaction between two key elements: the crude oil operations management and procurement management. Traditionally, the focus of the refineries literature is on the operations management, such as crude oil scheduling and blending, refinery design/configuration, product blending control, etc. Studies on the procurement management with uncertain prices were scarce as crude oil prices were relatively stable. Since the new millennium, however, crude oil prices have become extremely volatile. As the crude oil procurement cost is about 90 percent of the total operation cost, ignoring uncertainties in the crude oil prices may result in significant losses.

Typical refinery operations involve a wide spectrum of activities, which are extremely complex and heavily linked. In this paper, we investigate optimal crude-oil procurement problem with consideration of the interaction between the price dynamics and the refinery operational decisions. This problem is extremely complex for three reasons.

First, crude oil prices are highly volatile. Fig. 1 plots two oils’ weekly average spot prices from January 2004 to November 2013. We observe that the prices fluctuate significantly in short periods. It is interesting to see that the path of a crude oil price resembles the path of a stock value. This similarity is not surprising as many financial institutes and funds play in the oil’s future market. According to Brennan and Schwartz (1985), Paddock, Siegel, and Smith (1988), and Mostafaei, Sani, and Askari (2013), oil prices approximately follow geometric Brownian motion (GBM) processes. The analysis on high-dimensional GBM can be very complex, and optimal solutions may be extremely hard to obtain.

Second, the procurement of crude oil is a multiperiod decision. For a Chinese state-owned oil refinery, purchase decisions are made every month or every two months. Managers frequently need to decide whether to purchase now or to wait. The purchase quantity of crude oil is also very hard to decide. No managers would like to purchase a lot of crude oil at very high prices. This multiperiod decision is very challenging and important. A bad decision hurts a manager’s reputation and performance.
                  

Third, oil refineries produce or consume multiple products at the same time. For instance, operations such as separation or blending involve multiple products at a given mix. As a result, different crude oils’ purchases are correlated. This correlation turns the problem into a high-dimensional optimization problem. In our project with a regional Chinese state-owned oil refinery, the dimension goes up to 26. This curse of dimensionality prohibits the search of optimal solutions.

The contribution of the paper is threefold. First, we approximate the dynamic programming problem using orthogonal array (OA) sampling method and multivariate adaptive regression splines (MARS) algorithm. Numerical results reveal that the optimal solution of the approximate problem is a near-optimal solution of the original problem. Second, we find that this optimal solution significantly outperforms a set of myopic policies, which first set a minimum inventory requirement at the end of each period and then solve each period independently. Third, numerical results suggest that the superiority is robust to the estimation of oil price drift rate, but not very robust to the volatility of oil price.

The remainder of the paper proceeds as follows: Section 2 briefly reviews the related literature. Sections 3 and 4 describe the single-period and multiperiod setup, respectively. Section 5 presents an approximate solution approach. We test this approximate solution approach in Section 6. Finally, Section 7 offers some concluding remarks. We conclude this introduction with some notational conventions. Vectors will be in boldface. All vectors are column vectors by default, and primes denote transposes. A bar (for example, 
                        
                           V
                           ¯
                        
                     ) placed above a variable represents the average value of observations on this variable. A hat (for example, 
                        
                           V
                           ^
                        
                     ) placed above a function represents an approximation of that function. 
                        E
                      denotes the expectation. Indicator function 1{x} equals 1 if event x is true and 0 otherwise. Throughout this paper, “increasing” and “decreasing” mean “nondecreasing” and “nonincreasing,” respectively.

@&#LITERATURE REVIEW@&#

Production process in an oil refinery is complicated, with multiple facilities, materials, and production constraints. Many researchers have worked to model and optimize the production process for oil refineries. Bodington and Baker (1990) summarize the use of mathematical programming in the petroleum industry before 1990. Linear programming models were used in the early times (Charnes, Cooper, & Mellon, 1952). With the growth of computer technology, nonlinear programming (NLP) models were introduced to formulate the process more accurately (Adhya, Tawarmalani, & Sahinidis, 1999; Amos, Rönnqvist, & Gill, 1997; Baker & Lasdon, 1985; Chryssolouris, Papakostas, & Mourtzis, 2005; Floudas & Aggarwal, 1990; Golovin, 1979; Lee, Pinto, Grossmann, & Park, 1996; Rigby, Lasdon, & Waren, 1995). Researchers have developed many different approaches to deal with nonlinear parts in refining processes, such as simulation approach (Chryssolouris et al., 2005; Golovin, 1979), successive linear programming (SLP) (Baker & Lasdon, 1985; Griffith & Stewart, 1961), Benders’ decomposition (Floudas & Aggarwal, 1990), mixed integer programming (Lee et al., 1996), least square programming (Amos et al., 1997), Lagrangian relaxation (Adhya et al., 1999), etc.

The literatures mentioned above concentrate on the modeling of the refining process. Recently, with the financialization of the oil market, fluctuations of crude oil prices have increased significantly (NA, 2010). As a result, refineries are facing larger risks in crude oil prices nowadays than 10 years ago. Many researchers have developed different models to describe price behaviors, such as geometric Brownian motion (GBM) (Brennan & Schwartz, 1985; Paddock et al., 1988), mean reversion (MR) (Schwartz, 1997), etc. Ederington, Fernando, Lee, Linn, and May (2011) gave a survey on the factors influencing oil prices and the stochastic models describing price behaviors. It is hard to argue which price model is the best for modeling crude oil prices. Al-Harthy (2007) explored the impact of three oil price models—GBM, MR, and MR with jumps—on the uncertainty output of a project’s NPV and concluded that the GBM model is a good approximation if the decision is based on the mean value rather than the standard deviation, and if the current oil price is close to the long-term price. Meade (2010) argued that both GBM and MR are not supportable as a long-term model and suggested a mixture of two Gaussian models. Aspen (2011) compared four price models—fixed price, GBM, MR, and a system thinking approach—and concluded that these four models would favor different projects, in which GBM would favor projects with high production at a later stage. Liu, Wang, Zhao, Pan, and Xiao (2012) argued that MR is more appropriate for cases with low future oil price volatility, and GBM is better for high future oil price volatility. Mostafaei et al. (2013) tried to select the best stochastic model for Russian crude oil price, and illustrated that GBM is the best model for the Russian crude oil price. In this paper, we chose GBM to describe crude oil prices.

Although there are many stochastic crude oil price models, few researchers applied those models into refinery operations. In fact, a stream of literatures studied the optimization of refinery operations under uncertainty (see the review by Leiras, Ribas, Hamacher, and Elkamel, 2011). The most popular approach to handle the uncertainty is two-stage stochastic programming (SP) with recourse models (Al-Othman, Lababidi, Alatiqi, & Al-Shayji, 2008; Aseeri & Bagajewicz, 2004; Carneiro, Ribas, & Hamacher, 2010; Escudero, Quintana, & Salmerón, 1999; Khor, Elkamel, Ponnambalam, & Douglas, 2008; Lababidi, Ahmed, Alatiqi, & Al-Enzi, 2004; Pongsakdi, Rangsunvigit, Siemanond, & Bagajewicz, 2006; Ribas, Hamacher, & Street, 2010), in which the first stage decided the crude supply and/or production rate under uncertainty, while the second stage decided detailed refinery operations. Dempster, Pedrón, Medova, Scott, and Sembos (2000) developed a multiperiod model that modeled stochastic prices as scenario trees. Besides the SP formulation, Ribas et al. (2010) proposed a robust min–max regret model and a max–min model. Dong, Kouvelis, and Wu (2013) proposed a different two-stage SP model to study the value of refinery operational flexibility, in which the first stage decided the crude supply under given crude prices and uncertain end-product prices. In conclusion, approaches in refinery operation literatures used two methods to model the crude oil prices: (1) stochastic variables which were independent through time periods and (2) scenario-based approach. In contrast, our GBM oil price model captures oil price fluctuations over time.

In this section, we assume that crude oil purchasing prices and selling prices are known and fixed. We discuss the optimal refinery operation in a single period.

We consider three typical and representative refinery processes: (1) separation, (2) mix, and (3) blend. In a separation process, several products are produced from a single input product according to a given formula. For example, a distillation plant can distillate crude oil into refinery gas, liquified gas, light naphtha, kerosine, etc. A mix process is the reverse of a separation process—that is, several input products can be mixed into an output product according to a specific formula. For example, mixing 5 portions of light naphtha, 10 portions of heavy naphtha, and 85 portions of kerosine cut produces 100 portions of a jet fuel. In both the separation and the mix processes, a specific formula is followed—the manufacturer cannot use any arbitrary formula. A blend process is similar to a mix process except that a blend process does not need to follow any specific formula. The output of a blend process is the mixture of all the input products. For instance, blending an input product of quantity y
                        1 and quality q
                        1 with another input product of quantity y
                        2 and quality q
                        2 yields an output product of quantity y
                        1 + y
                        2 and quality (y
                        1
                        q
                        1 + y
                        2
                        q
                        2)/(y
                        1 + y
                        2).

The objective function consists of three parts: sales, purchasing cost, and manufacturing cost. Let 
                           
                              M
                              =
                              {
                              1
                              ,
                              2
                              ,
                              …
                              ,
                              M
                              }
                           
                         be the set of products. This set includes all the crude oils. The unit selling price of product m is denoted pm
                        . The decision maker decides to sell sm
                         units of product m. The total sales is

                           
                              
                                 
                                    
                                       ∑
                                       
                                          m
                                          ∈
                                          M
                                       
                                    
                                    
                                       p
                                       m
                                    
                                    ·
                                    
                                       s
                                       m
                                    
                                    .
                                 
                              
                           
                        
                     

Let 
                           
                              M
                              P
                           
                         be the set of products to be purchased from the market, 
                           
                              
                                 M
                                 P
                              
                              ⊆
                              M
                           
                        . Let 
                           
                              c
                              m
                              P
                           
                         be the cost of purchasing one unit of product m. The superscript is short for “purchasing.” The decision maker buys xm
                         units of product m. The total purchasing cost is

                           
                              
                                 
                                    
                                       ∑
                                       
                                          m
                                          ∈
                                          
                                             M
                                             P
                                          
                                       
                                    
                                    
                                       c
                                       m
                                       P
                                    
                                    ·
                                    
                                       x
                                       m
                                    
                                    .
                                 
                              
                           
                        
                     

Let S, M, and B be the separation process, mix process, and blend process, respectively. Let 
                           
                              F
                              =
                              {
                              S
                              ,
                              M
                              ,
                              B
                              }
                           
                         be the set of three processes. Let 
                           
                              
                                 M
                                 S
                              
                              ⊆
                              M
                           
                         be the set of products that can be separated. For a product 
                           
                              m
                              ∈
                              
                                 M
                                 S
                              
                              ,
                           
                         let α
                        
                           m, n
                         be the amount of product n obtained from separating one unit of product m, and let 
                           
                              y
                              
                                 m
                              
                              S
                           
                         be the amount of product m inputted to a separation process. Let 
                           
                              
                                 M
                                 M
                              
                              ⊆
                              M
                           
                         be the set of products that can be obtained through the mix process. For a product 
                           
                              m
                              ∈
                              
                                 M
                                 M
                              
                              ,
                           
                         let β
                        
                           n, m
                         be the amount of product n mixed to get one unit of product m, and let 
                           
                              y
                              m
                              M
                           
                         be the amount of product m obtained from a mix process. Let 
                           
                              
                                 M
                                 B
                              
                              ⊆
                              M
                           
                         be the set of products that can be obtained from the blend process. Let γ
                        
                           n, m
                         = 1 if product m can be obtained from blending product n with other products, and γ
                        
                           n, m
                         = 0 otherwise. Let 
                           
                              y
                              
                                 n
                                 ,
                                 m
                              
                              B
                           
                         be the amount of product n used to produce product m through a blend process.

Let cS
                         be the manufacturing cost of separating one unit of input product. Let cM
                         be the manufacturing cost of obtaining one unit of output product through a mix process. Let cB
                         be the manufacturing cost of obtaining one unit of output product through a blend process. Therefore, the total manufacturing cost is

                           
                              
                                 
                                    
                                       c
                                       S
                                    
                                    ·
                                    
                                       ∑
                                       
                                          m
                                          ∈
                                          
                                             M
                                             S
                                          
                                       
                                    
                                    
                                       y
                                       m
                                       S
                                    
                                    +
                                    
                                       c
                                       M
                                    
                                    ·
                                    
                                       ∑
                                       
                                          m
                                          ∈
                                          
                                             M
                                             M
                                          
                                       
                                    
                                    
                                       y
                                       m
                                       M
                                    
                                    +
                                    
                                       c
                                       B
                                    
                                    ·
                                    
                                       ∑
                                       
                                          
                                             m
                                             ′
                                          
                                          ∈
                                          M
                                       
                                    
                                    
                                       ∑
                                       
                                          m
                                          ∈
                                          
                                             M
                                             B
                                          
                                       
                                    
                                    
                                       γ
                                       
                                          
                                             m
                                             ′
                                          
                                          ,
                                          m
                                       
                                    
                                    ·
                                    
                                       y
                                       
                                          
                                             m
                                             ′
                                          
                                          ,
                                          m
                                       
                                       B
                                    
                                    .
                                 
                              
                           
                        The decision maker’s objective is to choose 
                           s, x
                        , and 
                           y
                         to maximize his/her total profit,

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                max
                                                
                                                   s
                                                   ,
                                                   x
                                                   ,
                                                   y
                                                
                                             
                                             
                                                {
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      M
                                                   
                                                
                                                
                                                   p
                                                   m
                                                
                                                
                                                   s
                                                   m
                                                
                                                −
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         P
                                                      
                                                   
                                                
                                                
                                                   c
                                                   m
                                                   P
                                                
                                                
                                                   x
                                                   m
                                                
                                                −
                                                
                                                   c
                                                   S
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         S
                                                      
                                                   
                                                
                                                
                                                   y
                                                   m
                                                   S
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             
                                                
                                                −
                                                
                                                
                                                   c
                                                   M
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         M
                                                      
                                                   
                                                
                                                
                                                   y
                                                   m
                                                   M
                                                
                                                −
                                                
                                                   c
                                                   B
                                                
                                                
                                                   ∑
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ∈
                                                      M
                                                   
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         B
                                                      
                                                   
                                                
                                                
                                                   γ
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ,
                                                      m
                                                   
                                                
                                                
                                                   y
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ,
                                                      m
                                                   
                                                   B
                                                
                                                }
                                             
                                             .
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             (OBJ)
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The first type of constraints concerns the quantity balance of each product. For any 
                           
                              m
                              ∈
                              M
                              ,
                           
                         the sum of product m purchased and produced equals the sum of product m consumed and sold. The amount of product m consumed is

                           
                              
                                 
                                    
                                       
                                          
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                y
                                                m
                                                S
                                             
                                          
                                          ︸
                                       
                                       separation
                                    
                                    
                                    +
                                    
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                β
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                M
                                             
                                          
                                          ︸
                                       
                                       mix
                                    
                                    
                                    +
                                    
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                B
                                             
                                          
                                          ︸
                                       
                                       blend
                                    
                                    
                                    .
                                 
                              
                           
                        The amount of product m produced is

                           
                              
                                 
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                α
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                S
                                             
                                          
                                          ︸
                                       
                                       separation
                                    
                                    
                                    +
                                    
                                    
                                       
                                          
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                y
                                                m
                                                M
                                             
                                          
                                          ︸
                                       
                                       mix
                                    
                                    
                                    +
                                    
                                    
                                       
                                          
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                                B
                                             
                                          
                                          ︸
                                       
                                       blend
                                    
                                    
                                    .
                                 
                              
                           
                        Therefore, for any 
                           
                              m
                              ∈
                              
                                 M
                                 P
                              
                              ,
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                x
                                                m
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                α
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                S
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                y
                                                m
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                                B
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                s
                                                m
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                y
                                                m
                                                S
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                β
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                B
                                             
                                             .
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             (QB
                                             
                                             1)
                                          
                                       
                                    
                                 
                              
                           
                        For any 
                           
                              m
                              ∈
                              M
                              /
                              
                                 M
                                 P
                              
                              ,
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                α
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                S
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                   }
                                                
                                             
                                             
                                                y
                                                m
                                                M
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                                B
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                s
                                                m
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                   }
                                                
                                             
                                             ·
                                             
                                                y
                                                m
                                                S
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                β
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                                B
                                             
                                             .
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                                (
                                                QB
                                                
                                                2
                                                )
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The second type of constraints ensures that the optimization problem is bounded. For instance, capacity constraints guarantee that 
                           x, y
                        , and 
                           s
                         are bounded. Further, the blend process has quality concerns in practical situations. The quality level of an output product of a blend process must be within a range. Because all these constraints are simple linear inequalities, we refer to all the range constraints as (RC) for notational simplicity.
                     

In summary, a single period’s optimization problem is

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             max
                                             
                                             
                                             (OBJ)
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                                s
                                                .
                                                t
                                                .
                                             
                                             
                                             
                                             (QB
                                             
                                             1),
                                             
                                             (QB
                                             
                                             2)
                                             
                                             and
                                             
                                             (RC)
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                        Table 1 summarizes the main notation introduced in this section.

In this section, we consider a multiperiod problem of the optimal refinery operation. Both purchasing price 
                        
                           c
                           m
                           P
                        
                      and selling price pm
                      are stochastic over time. We consider a planning horizon of T discrete periods. We add a subscript t to existing notation to indicate that this notation is for period t. For instance, 
                        
                           c
                           
                              m
                              ,
                              t
                           
                           P
                        
                      denotes the unit purchasing price of product m in period t. At the beginning of period t, the decision maker can observe 
                        
                           c
                           
                              m
                              ,
                              t
                           
                           P
                        
                      and p
                     
                        m, t
                     , but cannot observe future prices 
                        
                           
                              c
                              
                                 m
                                 ,
                                 t
                                 +
                                 1
                              
                              P
                           
                           ,
                        
                     
                     
                        
                           
                              c
                              
                                 m
                                 ,
                                 t
                                 +
                                 2
                              
                              P
                           
                           ,
                           …
                           
                        
                     , 
                        
                           
                              c
                              
                                 m
                                 ,
                                 T
                              
                              P
                           
                           ,
                        
                      
                     p
                     
                        m, t + 1, p
                     
                        m, t + 2, …, and p
                     
                        m, T
                     .

We assume inventory carryover. Let I
                        
                           m, t
                         be the amount of product m at the end of period t. Product quantity balance constraints become

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                I
                                                
                                                   m
                                                   ,
                                                   t
                                                   −
                                                   1
                                                
                                             
                                             +
                                             
                                                x
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                α
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                S
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                   }
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                   }
                                                
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                   ,
                                                   t
                                                
                                                B
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                I
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             +
                                             
                                                s
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                   }
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                S
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                β
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                B
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             (NQB
                                             
                                             1)
                                          
                                       
                                    
                                 
                              
                           
                        for any 
                           
                              m
                              ∈
                              
                                 M
                                 P
                              
                              ,
                           
                         and

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                I
                                                
                                                   m
                                                   ,
                                                   t
                                                   −
                                                   1
                                                
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                α
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                S
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                   }
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                   }
                                                
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                   ,
                                                   t
                                                
                                                B
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                I
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             +
                                             
                                                s
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             +
                                             
                                                1
                                                
                                                   {
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                   }
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                S
                                             
                                             +
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                β
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                M
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   t
                                                
                                                B
                                             
                                             .
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             
                                             (NQB
                                             
                                             2)
                                          
                                       
                                    
                                 
                              
                           
                        for any 
                           
                              m
                              ∈
                              M
                              /
                              
                                 M
                                 P
                              
                           
                        . For notational convenience, let (NRC) be the set of range constraints for the multiperiod problem. (NRC) is the multiperiod version of (RC).

Define 
                           
                              
                                 V
                                 t
                              
                              
                                 (
                                 
                                    p
                                    t
                                 
                                 ,
                                 
                                    c
                                    t
                                    P
                                 
                                 ,
                                 
                                    I
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                              
                           
                         as period t’s profit-to-go function given prices 
                           p
                        
                        
                           t
                        , 
                           
                              
                                 
                                    c
                                 
                                 t
                                 P
                              
                              ,
                           
                         and inventory level 
                           I
                        
                        
                           t − 1. Let hm
                         be the inventory cost per unit product m per unit time. The end-of-horizon problem is

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                V
                                                T
                                             
                                             
                                                (
                                                
                                                   p
                                                   T
                                                
                                                ,
                                                
                                                   c
                                                   T
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   
                                                      T
                                                      −
                                                      1
                                                   
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                max
                                                
                                                   
                                                      s
                                                      T
                                                   
                                                   ,
                                                   
                                                      x
                                                      T
                                                   
                                                   ,
                                                   
                                                      y
                                                      T
                                                   
                                                   ,
                                                   
                                                      I
                                                      T
                                                   
                                                
                                             
                                             
                                                {
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      M
                                                   
                                                
                                                
                                                   p
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                
                                                ·
                                                
                                                   s
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                
                                                −
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         P
                                                      
                                                   
                                                
                                                
                                                   c
                                                   m
                                                   P
                                                
                                                ·
                                                
                                                   x
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                
                                                −
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      M
                                                   
                                                
                                                
                                                   h
                                                   m
                                                
                                                ·
                                                
                                                   I
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             
                                                −
                                                
                                                
                                                   c
                                                   S
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         S
                                                      
                                                   
                                                
                                                
                                                   y
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                   S
                                                
                                                −
                                                
                                                   c
                                                   M
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         M
                                                      
                                                   
                                                
                                                
                                                   y
                                                   
                                                      m
                                                      ,
                                                      T
                                                   
                                                   M
                                                
                                                −
                                                
                                                   c
                                                   B
                                                
                                                
                                                   ∑
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ∈
                                                      M
                                                   
                                                
                                                
                                                   ∑
                                                   
                                                      m
                                                      ∈
                                                      
                                                         M
                                                         B
                                                      
                                                   
                                                
                                                
                                                   γ
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ,
                                                      m
                                                   
                                                
                                                ·
                                                
                                                   y
                                                   
                                                      
                                                         m
                                                         ′
                                                      
                                                      ,
                                                      m
                                                      ,
                                                      T
                                                   
                                                   B
                                                
                                                
                                                }
                                             
                                             
                                             .
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                                s
                                                .
                                                t
                                                .
                                             
                                             
                                             (NQB
                                             
                                             1),
                                             
                                             (NQB
                                             
                                             2),
                                             
                                             (NRC),
                                             
                                             and
                                             
                                             
                                                I
                                                T
                                             
                                             ≥
                                             0
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        For 1 ≤ t < T, period t’s profit-to-go function is

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                V
                                                t
                                             
                                             
                                                (
                                                
                                                   p
                                                   t
                                                
                                                ,
                                                
                                                   c
                                                   t
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   
                                                      t
                                                      −
                                                      1
                                                   
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                max
                                                
                                                   
                                                      s
                                                      t
                                                   
                                                   ,
                                                   
                                                      x
                                                      t
                                                   
                                                   ,
                                                   
                                                      y
                                                      t
                                                   
                                                   ,
                                                   
                                                      I
                                                      t
                                                   
                                                
                                             
                                             {
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                p
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             ·
                                             
                                                s
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             −
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      P
                                                   
                                                
                                             
                                             
                                                c
                                                m
                                                P
                                             
                                             ·
                                             
                                                x
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                             −
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                h
                                                m
                                             
                                             ·
                                             
                                                I
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             −
                                             
                                             
                                                c
                                                S
                                             
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      S
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                S
                                             
                                             −
                                             
                                                c
                                                M
                                             
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      M
                                                   
                                                
                                             
                                             
                                                y
                                                
                                                   m
                                                   ,
                                                   t
                                                
                                                M
                                             
                                             −
                                             
                                                c
                                                B
                                             
                                             
                                                ∑
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ∈
                                                   M
                                                
                                             
                                             
                                                ∑
                                                
                                                   m
                                                   ∈
                                                   
                                                      M
                                                      B
                                                   
                                                
                                             
                                             
                                                γ
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                
                                             
                                             ·
                                             
                                                y
                                                
                                                   
                                                      m
                                                      ′
                                                   
                                                   ,
                                                   m
                                                   ,
                                                   t
                                                
                                                B
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             +
                                             
                                             E
                                             [
                                             
                                                V
                                                
                                                   t
                                                   +
                                                   1
                                                
                                             
                                             
                                                (
                                                
                                                   p
                                                   
                                                      t
                                                      +
                                                      1
                                                   
                                                
                                                ,
                                                
                                                   c
                                                   
                                                      t
                                                      +
                                                      1
                                                   
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   t
                                                
                                                )
                                             
                                             |
                                             
                                                p
                                                t
                                             
                                             ,
                                             
                                                c
                                                t
                                                P
                                             
                                             ]
                                             }
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                                s
                                                .
                                                t
                                                .
                                             
                                             
                                             (NQB
                                             
                                             1),
                                             
                                             (NQB
                                             
                                             2),
                                             
                                             (NRC),
                                             
                                             and
                                             
                                             
                                             
                                                I
                                                t
                                             
                                             ≥
                                             
                                                0
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The following proposition suggests an equivalent but simpler formulation of Vt
                        ( · ).

                           Proposition 1
                           
                              Period t’s profit-to-go function Vt
                              ( · ) is
                              
                                 
                                    
                                       
                                          
                                             
                                             
                                             
                                                
                                                   
                                                      V
                                                      t
                                                   
                                                   
                                                      (
                                                      
                                                         p
                                                         t
                                                      
                                                      ,
                                                      
                                                         c
                                                         t
                                                         P
                                                      
                                                      ,
                                                      
                                                         I
                                                         
                                                            t
                                                            −
                                                            1
                                                         
                                                      
                                                      )
                                                   
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   
                                                   =
                                                   
                                                      max
                                                      
                                                         
                                                            I
                                                            t
                                                         
                                                         ≥
                                                         
                                                            0
                                                         
                                                      
                                                   
                                                   
                                                      {
                                                      F
                                                      
                                                         (
                                                         
                                                            p
                                                            t
                                                         
                                                         ,
                                                         
                                                            c
                                                            t
                                                            P
                                                         
                                                         ,
                                                         
                                                            I
                                                            
                                                               t
                                                               −
                                                               1
                                                            
                                                         
                                                         ,
                                                         
                                                            I
                                                            t
                                                         
                                                         )
                                                      
                                                      +
                                                      E
                                                      
                                                         [
                                                         
                                                            V
                                                            
                                                               t
                                                               +
                                                               1
                                                            
                                                         
                                                         
                                                            (
                                                            
                                                               p
                                                               
                                                                  t
                                                                  +
                                                                  1
                                                               
                                                            
                                                            ,
                                                            
                                                               c
                                                               
                                                                  t
                                                                  +
                                                                  1
                                                               
                                                               P
                                                            
                                                            ,
                                                            
                                                               I
                                                               t
                                                            
                                                            )
                                                         
                                                         |
                                                         
                                                            p
                                                            t
                                                         
                                                         ,
                                                         
                                                            c
                                                            t
                                                            P
                                                         
                                                         ]
                                                      
                                                      }
                                                   
                                                   ,
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   1
                                                   ≤
                                                   t
                                                   <
                                                   T
                                                   ;
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   
                                                      V
                                                      T
                                                   
                                                   
                                                      (
                                                      
                                                         p
                                                         T
                                                      
                                                      ,
                                                      
                                                         c
                                                         
                                                            T
                                                         
                                                         P
                                                      
                                                      ,
                                                      
                                                         I
                                                         T
                                                      
                                                      )
                                                   
                                                   =
                                                   
                                                      max
                                                      
                                                         
                                                            I
                                                            
                                                               T
                                                               +
                                                               1
                                                            
                                                         
                                                         ≥
                                                         
                                                            0
                                                         
                                                      
                                                   
                                                   F
                                                   
                                                      (
                                                      
                                                         p
                                                         T
                                                      
                                                      ,
                                                      
                                                         c
                                                         T
                                                         P
                                                      
                                                      ,
                                                      
                                                         I
                                                         T
                                                      
                                                      ,
                                                      
                                                         I
                                                         
                                                            T
                                                            +
                                                            1
                                                         
                                                      
                                                      )
                                                   
                                                   ,
                                                
                                             
                                          
                                       
                                    
                                 
                              
                              where
                              
                                 
                                    
                                       
                                          
                                             
                                             
                                             
                                                
                                                   F
                                                   (
                                                   
                                                      p
                                                      t
                                                   
                                                   ,
                                                   
                                                      c
                                                      t
                                                      P
                                                   
                                                   ,
                                                   
                                                      I
                                                      
                                                         t
                                                         −
                                                         1
                                                      
                                                   
                                                   ,
                                                   
                                                      I
                                                      t
                                                   
                                                   )
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   
                                                   =
                                                   
                                                      max
                                                      
                                                         
                                                            s
                                                            t
                                                         
                                                         ,
                                                         
                                                            x
                                                            t
                                                         
                                                         ,
                                                         
                                                            y
                                                            t
                                                         
                                                      
                                                   
                                                   
                                                      {
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            M
                                                         
                                                      
                                                      
                                                         p
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                      
                                                      ·
                                                      
                                                         s
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                      
                                                      −
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            
                                                               M
                                                               P
                                                            
                                                         
                                                      
                                                      
                                                         c
                                                         m
                                                         P
                                                      
                                                      ·
                                                      
                                                         x
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                      
                                                      −
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            M
                                                         
                                                      
                                                      
                                                         h
                                                         m
                                                      
                                                      ·
                                                      
                                                         I
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   
                                                      
                                                      −
                                                      
                                                      
                                                         c
                                                         S
                                                      
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            
                                                               M
                                                               S
                                                            
                                                         
                                                      
                                                      
                                                         y
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                         S
                                                      
                                                      −
                                                      
                                                         c
                                                         M
                                                      
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            
                                                               M
                                                               M
                                                            
                                                         
                                                      
                                                      
                                                         y
                                                         
                                                            m
                                                            ,
                                                            t
                                                         
                                                         M
                                                      
                                                      −
                                                      
                                                         c
                                                         B
                                                      
                                                      
                                                         ∑
                                                         
                                                            
                                                               m
                                                               ′
                                                            
                                                            ∈
                                                            M
                                                         
                                                      
                                                      
                                                         ∑
                                                         
                                                            m
                                                            ∈
                                                            
                                                               M
                                                               B
                                                            
                                                         
                                                      
                                                      
                                                         γ
                                                         
                                                            
                                                               m
                                                               ′
                                                            
                                                            ,
                                                            m
                                                         
                                                      
                                                      ·
                                                      
                                                         y
                                                         
                                                            
                                                               m
                                                               ′
                                                            
                                                            ,
                                                            m
                                                            ,
                                                            t
                                                         
                                                         B
                                                      
                                                      }
                                                   
                                                
                                             
                                          
                                          
                                             
                                             
                                             
                                                
                                                   
                                                      s
                                                      .
                                                      t
                                                      .
                                                   
                                                   
                                                   
                                                      (
                                                      N
                                                      Q
                                                      B
                                                      1
                                                      )
                                                      ,
                                                      (
                                                      N
                                                      Q
                                                      B
                                                      2
                                                      )
                                                      ,
                                                      (
                                                      N
                                                      R
                                                      C
                                                      )
                                                   
                                                   .
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           


                        Proposition 1 separates the optimization of inventory level 
                           I
                        
                        
                           t
                         and the optimization of production quantities 
                           x
                        
                        
                           t
                        , 
                           y
                        
                        
                           t
                        , and 
                           s
                        
                        
                           t
                        . Proposition 1 implies that the decision maker can first optimize over inventory levels and then optimize over production quantities given the inventory strategy. This two-step optimization is consistent with the practice used by many Chinese refineries, where oil inventory is a planning decision but production quantities are operation decisions. The planning decisions are made over a year or half a year; then the operation decisions are made given the inventory decisions.

                           Proposition 2
                           
                              For any 1 ≤ t ≤ T, 
                                 
                                    F
                                    (
                                    
                                       p
                                       t
                                    
                                    ,
                                    
                                       c
                                       t
                                       P
                                    
                                    ,
                                    
                                       I
                                       
                                          t
                                          −
                                          1
                                       
                                    
                                    ,
                                    
                                       I
                                       t
                                    
                                    )
                                 
                               
                              is a concave function of 
                              
                                 I
                              
                              
                                 t − 1 
                              and 
                              
                                 I
                              
                              
                                 t
                              , and
                              
                                 
                                    
                                       V
                                       t
                                    
                                    
                                       (
                                       
                                          p
                                          t
                                       
                                       ,
                                       
                                          c
                                          t
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                 
                               
                              is a concave function of 
                              
                                 I
                              
                              
                                 t − 1.


                        Proposition 2 indicates that the optimization over 
                           I
                        
                        
                           t
                         is a convex optimization problem. This property indicates the tractability of the optimization of 
                           I
                        
                        
                           t
                        . One difficulty is that Vt
                         is not always differentiable. In our numerical examples, we use an algorithm implemented in Python package SciPy to solve this problem. The algorithm is a conjugate direction method based on Powell (1964).

The price vector 
                           
                              
                                 (
                                 
                                    
                                       c
                                    
                                    
                                       1
                                       ,
                                       t
                                    
                                    P
                                 
                                 ,
                                 
                                    
                                       c
                                    
                                    
                                       2
                                       ,
                                       t
                                    
                                    P
                                 
                                 ,
                                 …
                                 ,
                                 
                                    
                                       c
                                    
                                    
                                       
                                          |
                                       
                                       
                                          M
                                          P
                                       
                                       
                                          |
                                          ,
                                          t
                                       
                                    
                                    P
                                 
                                 ,
                                 
                                    p
                                    
                                       1
                                       ,
                                       t
                                    
                                 
                                 ,
                                 
                                    p
                                    
                                       2
                                       ,
                                       t
                                    
                                 
                                 ,
                                 …
                                 ,
                                 
                                    p
                                    
                                       |
                                       M
                                       |
                                       ,
                                       t
                                    
                                 
                                 )
                              
                              T
                           
                         follows a geometric Brownian motion of dimension 
                           
                              
                                 |
                              
                              
                                 M
                                 P
                              
                              
                                 |
                                 +
                                 |
                                 M
                                 |
                              
                           
                        . By definition,

                           
                              
                                 
                                    
                                       
                                          d
                                          
                                             
                                                c
                                             
                                             
                                                i
                                                ,
                                                t
                                             
                                             P
                                          
                                       
                                       
                                          
                                             c
                                          
                                          
                                             i
                                             ,
                                             t
                                          
                                          P
                                       
                                    
                                    =
                                    
                                       μ
                                       i
                                    
                                    d
                                    t
                                    +
                                    
                                       σ
                                       i
                                    
                                    d
                                    
                                       w
                                       
                                          i
                                          ,
                                          t
                                       
                                    
                                    ,
                                    
                                    
                                    for
                                    
                                    i
                                    =
                                    1
                                    ,
                                    2
                                    ,
                                    …
                                    ,
                                    
                                       |
                                       
                                          M
                                          P
                                       
                                       |
                                    
                                    ,
                                 
                              
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                          d
                                          
                                             p
                                             
                                                i
                                                ,
                                                t
                                             
                                          
                                       
                                       
                                          p
                                          
                                             i
                                             ,
                                             t
                                          
                                       
                                    
                                    =
                                    
                                       μ
                                       
                                          
                                             i
                                             +
                                             |
                                          
                                          
                                             M
                                             P
                                          
                                          
                                             |
                                          
                                       
                                    
                                    d
                                    t
                                    +
                                    
                                       σ
                                       
                                          
                                             i
                                             +
                                             |
                                          
                                          
                                             M
                                             P
                                          
                                          
                                             |
                                          
                                       
                                    
                                    d
                                    
                                       w
                                       
                                          i
                                          +
                                          
                                             n
                                             c
                                          
                                          ,
                                          t
                                       
                                    
                                    ,
                                    
                                    
                                    for
                                    
                                    i
                                    =
                                    1
                                    ,
                                    2
                                    ,
                                    …
                                    ,
                                    
                                       |
                                       M
                                       |
                                    
                                    ,
                                 
                              
                           
                        where μi
                         and σi
                         are the drift rate and volatility.

We define the log return of the price vector as follows:

                           
                              (1)
                              
                                 
                                    
                                       R
                                       t
                                    
                                    =
                                    ln
                                    
                                       
                                          (
                                          
                                             
                                                
                                                   c
                                                
                                                
                                                   1
                                                   ,
                                                   t
                                                   +
                                                   1
                                                
                                                P
                                             
                                             
                                                
                                                   c
                                                
                                                
                                                   1
                                                   ,
                                                   t
                                                
                                                P
                                             
                                          
                                          ,
                                          …
                                          ,
                                          
                                             
                                                
                                                   c
                                                
                                                
                                                   
                                                      |
                                                   
                                                   
                                                      M
                                                      P
                                                   
                                                   
                                                      |
                                                      ,
                                                      t
                                                      +
                                                      1
                                                   
                                                
                                                P
                                             
                                             
                                                
                                                   c
                                                
                                                
                                                   
                                                      |
                                                   
                                                   
                                                      M
                                                      P
                                                   
                                                   
                                                      |
                                                      ,
                                                      t
                                                   
                                                
                                                P
                                             
                                          
                                          ,
                                          
                                             
                                                p
                                                
                                                   1
                                                   ,
                                                   t
                                                   +
                                                   1
                                                
                                             
                                             
                                                p
                                                
                                                   1
                                                   ,
                                                   t
                                                
                                             
                                          
                                          ,
                                          …
                                          ,
                                          
                                             
                                                p
                                                
                                                   |
                                                   M
                                                   |
                                                   ,
                                                   t
                                                   +
                                                   1
                                                
                                             
                                             
                                                p
                                                
                                                   |
                                                   M
                                                   |
                                                   ,
                                                   t
                                                
                                             
                                          
                                          )
                                       
                                       T
                                    
                                    .
                                 
                              
                           
                        By Ito’s law, 
                           R
                        
                        
                           t
                         follows a multivariate normal distribution with dimension 
                           
                              
                                 |
                              
                              
                                 M
                                 P
                              
                              
                                 |
                                 +
                                 |
                                 M
                                 |
                              
                           
                        : 
                           
                              
                                 N
                                 
                                    
                                       |
                                    
                                    
                                       M
                                       P
                                    
                                    
                                       |
                                       +
                                       |
                                       M
                                       |
                                    
                                 
                              
                              
                                 (
                                 
                                    μ
                                 
                                 −
                                 
                                    σ
                                 
                                 /
                                 2
                                 ,
                                 Σ
                                 )
                              
                              ,
                           
                         where 
                           
                              
                                 μ
                              
                              =
                              
                                 
                                    (
                                    
                                       μ
                                       1
                                    
                                    ,
                                    
                                       μ
                                       2
                                    
                                    ,
                                    …
                                    ,
                                    
                                       μ
                                       
                                          
                                             |
                                          
                                          
                                             M
                                             P
                                          
                                          
                                             |
                                             +
                                             |
                                             M
                                             |
                                          
                                       
                                    
                                    )
                                 
                                 T
                              
                           
                         and 
                           
                              
                                 σ
                              
                              =
                              
                                 
                                    (
                                    
                                       σ
                                       1
                                       2
                                    
                                    ,
                                    
                                       σ
                                       2
                                       2
                                    
                                    ,
                                    …
                                    ,
                                    
                                       σ
                                       
                                          
                                             |
                                          
                                          
                                             M
                                             P
                                          
                                          
                                             |
                                             +
                                             |
                                             M
                                             |
                                          
                                       
                                       2
                                    
                                    )
                                 
                                 T
                              
                           
                         are the vectors of drift rates and square volatilities, and 
                           Σ
                         is the covariance matrix whose diagonal is 
                           σ
                        . Because 
                           R
                        
                        
                           t
                         is normally distributed, the price vector 
                           
                              (
                              
                                 
                                    c
                                 
                                 
                                    t
                                    +
                                    1
                                 
                                 P
                              
                              ,
                              
                                 p
                                 
                                    t
                                    +
                                    1
                                 
                              
                              )
                           
                         would follow a log-normal distribution with parameters 
                           μ
                         and 
                           Σ
                         under the condition that 
                           
                              (
                              
                                 
                                    c
                                 
                                 t
                                 P
                              
                              ,
                              
                                 p
                                 t
                              
                              )
                           
                         is given.

The main difficulty of solving 
                        
                           
                              V
                              t
                           
                           
                              (
                              
                                 p
                                 t
                              
                              ,
                              
                                 c
                                 t
                                 P
                              
                              ,
                              
                                 I
                                 
                                    t
                                    −
                                    1
                                 
                              
                              )
                           
                        
                      arises from the high dimension and continuity of system state. Previous researches have developed many approaches to approximate value function in stochastic dynamic programming problems, for example, Friedman (1991), Johnson, Stedinger, Shoemaker, Li, and Tejada-Guibert (1993), Chen, Ruppert, and Shoemaker (1999), and Fan, Tarun, and Chen (2013). We outline the application of their sampling and approximation approaches in our model:

                        
                           1.
                           Set t = T.

For period t, sample N points of system state 
                                 
                                    (
                                    
                                       p
                                       t
                                    
                                    ,
                                    
                                       c
                                       t
                                       P
                                    
                                    ,
                                    
                                       I
                                       
                                          t
                                          −
                                          1
                                       
                                    
                                    )
                                 
                              :

                                 
                                    
                                       
                                          {
                                          
                                             (
                                             
                                                p
                                                
                                                   t
                                                   ,
                                                   1
                                                
                                             
                                             ,
                                             
                                                c
                                                
                                                   t
                                                   ,
                                                   1
                                                
                                                P
                                             
                                             ,
                                             
                                                I
                                                
                                                   t
                                                   −
                                                   1
                                                   ,
                                                   1
                                                
                                             
                                             )
                                          
                                          ,
                                          
                                             (
                                             
                                                p
                                                
                                                   t
                                                   ,
                                                   2
                                                
                                             
                                             ,
                                             
                                                c
                                                
                                                   t
                                                   ,
                                                   2
                                                
                                                P
                                             
                                             ,
                                             
                                                I
                                                
                                                   t
                                                   −
                                                   1
                                                   ,
                                                   2
                                                
                                             
                                             )
                                          
                                          ,
                                          …
                                          ,
                                          
                                             (
                                             
                                                p
                                                
                                                   t
                                                   ,
                                                   N
                                                
                                             
                                             ,
                                             
                                                c
                                                
                                                   t
                                                   ,
                                                   N
                                                
                                                P
                                             
                                             ,
                                             
                                                I
                                                
                                                   t
                                                   −
                                                   1
                                                   ,
                                                   N
                                                
                                             
                                             )
                                          
                                          }
                                          .
                                       
                                    
                                 
                              
                           

Solve 
                                 
                                    
                                       V
                                       t
                                    
                                    
                                       (
                                       
                                          p
                                          
                                             t
                                             ,
                                             i
                                          
                                       
                                       ,
                                       
                                          c
                                          
                                             t
                                             ,
                                             i
                                          
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                             ,
                                             i
                                          
                                       
                                       )
                                    
                                 
                               for i = 1, 2, …, N.

Compute an approximate value function 
                                 
                                    
                                       
                                          V
                                          ^
                                       
                                       t
                                    
                                    
                                       (
                                       
                                          p
                                          t
                                       
                                       ,
                                       
                                          c
                                          t
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                 
                               based on


                              
                                 
                                    
                                       V
                                       t
                                    
                                    
                                       (
                                       
                                          p
                                          
                                             t
                                             ,
                                             i
                                          
                                       
                                       ,
                                       
                                          c
                                          
                                             t
                                             ,
                                             i
                                          
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                             ,
                                             i
                                          
                                       
                                       )
                                    
                                 
                               for i = 1, 2, …, N.

Let 
                                 
                                    
                                       V
                                       t
                                    
                                    
                                       (
                                       ·
                                       )
                                    
                                    ←
                                    
                                       
                                          V
                                          ^
                                       
                                       t
                                    
                                    
                                       (
                                       ·
                                       )
                                    
                                 
                               and t ← t − 1. If t > 0, go to step 2; otherwise, we end the algorithm.

In this paper, we take a fractional factorial design-orthogonal array (OA) approach for step 2’s sampling method and a multivariate adaptive regression splines (MARS) for step 3’s value function approximations. In the remaining part of this section, we provide a brief introduction of OA and MARS.

In our dynamic programming formulation, system state has dimension 
                           
                              
                                 2
                                 |
                              
                              
                                 M
                                 P
                              
                              
                                 |
                                 +
                                 |
                                 M
                                 |
                              
                           
                        . If we sample p points at each dimension, a full factorial design would contain 
                           
                              p
                              
                                 
                                    2
                                    |
                                 
                                 
                                    M
                                    P
                                 
                                 
                                    |
                                    +
                                    |
                                    M
                                    |
                                 
                              
                           
                         different points. The sample size grows exponentially with the dimension of system state. An OA with strength d is a fractional factorial design, which is a subset of a full factorial design and contains pd
                         points. In this design, the number of points sampled, pd
                        , does not grow with the dimension of system state. The pd
                         points are selected from all 
                           
                              p
                              
                                 
                                    2
                                    |
                                 
                                 
                                    M
                                    P
                                 
                                 
                                    |
                                    +
                                    |
                                    M
                                    |
                                 
                              
                           
                         points according to this property: if we look at any d of the 
                           
                              
                                 2
                                 |
                              
                              
                                 M
                                 P
                              
                              
                                 |
                                 +
                                 |
                                 M
                                 |
                              
                           
                         dimensions, each of the pd
                         points is sampled equally often (Chen et al., 1999). There are several public OA libraries on the Internet, for example, http://neilsloane.com/oadir/index.html
 and http://support.sas.com/techsup/technote/ts723.html. For anyone who is interested in the construction method of OA, we refer to the work of Chen (2001), Xu (1997), and Man and Murray (2012).

Let

                           
                              
                                 
                                    {
                                    
                                       (
                                       
                                          p
                                          
                                             t
                                             ,
                                             1
                                          
                                       
                                       ,
                                       
                                          c
                                          
                                             t
                                             ,
                                             1
                                          
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                             ,
                                             1
                                          
                                       
                                       )
                                    
                                    ,
                                    
                                       (
                                       
                                          p
                                          
                                             t
                                             ,
                                             2
                                          
                                       
                                       ,
                                       
                                          c
                                          
                                             t
                                             ,
                                             2
                                          
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                             ,
                                             2
                                          
                                       
                                       )
                                    
                                    ,
                                    …
                                    ,
                                    
                                       (
                                       
                                          p
                                          
                                             t
                                             ,
                                             N
                                          
                                       
                                       ,
                                       
                                          c
                                          
                                             t
                                             ,
                                             N
                                          
                                          P
                                       
                                       ,
                                       
                                          I
                                          
                                             t
                                             −
                                             1
                                             ,
                                             N
                                          
                                       
                                       )
                                    
                                    }
                                    ,
                                 
                              
                           
                        be the sampled points, where N = pd
                        . Given period t + 1’s approximate value function 
                           
                              
                                 
                                    V
                                    ^
                                 
                                 
                                    t
                                    +
                                    1
                                 
                              
                              
                                 (
                                 ·
                                 )
                              
                              ,
                           
                         we can solve

                           
                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             
                                                V
                                                t
                                             
                                             
                                                (
                                                
                                                   p
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                
                                                ,
                                                
                                                   c
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   
                                                      t
                                                      −
                                                      1
                                                      ,
                                                      i
                                                   
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                             =
                                             
                                                max
                                                
                                                   I
                                                   t
                                                
                                             
                                             
                                                {
                                                F
                                                
                                                   (
                                                   
                                                      p
                                                      
                                                         t
                                                         ,
                                                         i
                                                      
                                                   
                                                   ,
                                                   
                                                      c
                                                      
                                                         t
                                                         ,
                                                         i
                                                      
                                                      P
                                                   
                                                   ,
                                                   
                                                      I
                                                      
                                                         t
                                                         −
                                                         1
                                                         ,
                                                         i
                                                      
                                                   
                                                   ,
                                                   
                                                      I
                                                      t
                                                   
                                                   )
                                                
                                                +
                                                E
                                                
                                                   [
                                                   
                                                      
                                                         V
                                                         ^
                                                      
                                                      
                                                         t
                                                         +
                                                         1
                                                      
                                                   
                                                   
                                                      (
                                                      
                                                         p
                                                         
                                                            t
                                                            +
                                                            1
                                                         
                                                      
                                                      ,
                                                      
                                                         c
                                                         
                                                            t
                                                            +
                                                            1
                                                         
                                                         P
                                                      
                                                      ,
                                                      
                                                         I
                                                         t
                                                      
                                                      )
                                                   
                                                   |
                                                   
                                                      p
                                                      
                                                         t
                                                         ,
                                                         i
                                                      
                                                   
                                                   ,
                                                   
                                                      c
                                                      
                                                         t
                                                         ,
                                                         i
                                                      
                                                      P
                                                   
                                                   ]
                                                
                                                }
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             
                                                s
                                                .
                                                t
                                                .
                                             
                                             
                                             
                                                I
                                                t
                                             
                                             ≥
                                             
                                                0
                                             
                                             ,
                                             1
                                             ≤
                                             t
                                             ≤
                                             T
                                          
                                       
                                    
                                 
                              
                           
                        to determine the value function at each of the sampled points. We discuss how to construct an approximate value function given these values.

MARS algorithms were first proposed by Friedman (1991). The basic idea of MARS is to choose a set of basis functions to minimize the “distance” between the origin function and the approximate function. The “distance” is measured at the sampled system states.

The basis functions in MARS have the form

                           
                              
                                 
                                    
                                       ∏
                                       
                                          i
                                          =
                                          1
                                       
                                       L
                                    
                                    
                                       
                                          [
                                          ±
                                          
                                             (
                                             
                                                v
                                                
                                                   n
                                                   i
                                                
                                             
                                             −
                                             
                                                k
                                                i
                                             
                                             )
                                          
                                          ]
                                       
                                       +
                                    
                                 
                              
                           
                        where 
                           
                              
                                 
                                    [
                                    ·
                                    ]
                                 
                                 +
                              
                              
                                 =
                                 d
                              
                              max
                              
                                 {
                                 0
                                 ,
                                 ·
                                 }
                              
                              ,
                           
                        
                        
                           
                              v
                              =
                              
                                 (
                                 
                                    c
                                    t
                                    P
                                 
                                 ,
                                 
                                    p
                                    t
                                 
                                 ,
                                 
                                    I
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                              
                              =
                              
                                 (
                                 
                                    v
                                    1
                                 
                                 ,
                                 
                                    v
                                    2
                                 
                                 ,
                                 …
                                 ,
                                 
                                    v
                                    
                                       
                                          2
                                          |
                                       
                                       
                                          M
                                          P
                                       
                                       
                                          |
                                          +
                                          |
                                          M
                                          |
                                       
                                    
                                 
                                 )
                              
                              ,
                           
                        
                        
                           
                              1
                              ≤
                              
                                 n
                                 i
                              
                              
                                 ≤
                                 2
                                 |
                              
                              
                                 M
                                 P
                              
                              
                                 |
                                 +
                                 |
                                 M
                                 |
                                 ,
                              
                           
                         
                        ki
                         is the knot value corresponding to 
                           
                              
                                 v
                                 
                                    n
                                    i
                                 
                              
                              ,
                           
                         and L is the number of truncated linear functions multiplied in the basis function. L ∈ {0, 1, 2, …, K}, where K is the maximum interactions among state variables in the MARS process.

Algorithm 2 in Friedman (1991) described a forward selection stepwise procedure to select the basis functions. MARS algorithm chooses basis functions to minimize the squared error lack-of-fit criterion

                           
                              
                                 
                                    min
                                    
                                       {
                                       
                                          1
                                          N
                                       
                                       
                                          ∑
                                          
                                             j
                                             =
                                             1
                                          
                                          N
                                       
                                       
                                          
                                             [
                                             
                                                V
                                                t
                                             
                                             
                                                (
                                                
                                                   p
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                
                                                ,
                                                
                                                   c
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   
                                                      t
                                                      −
                                                      1
                                                      ,
                                                      i
                                                   
                                                
                                                )
                                             
                                             −
                                             
                                                
                                                   V
                                                   ^
                                                
                                                t
                                             
                                             
                                                (
                                                
                                                   p
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                
                                                ,
                                                
                                                   c
                                                   
                                                      t
                                                      ,
                                                      i
                                                   
                                                   P
                                                
                                                ,
                                                
                                                   I
                                                   
                                                      t
                                                      −
                                                      1
                                                      ,
                                                      i
                                                   
                                                
                                                )
                                             
                                             ]
                                          
                                          2
                                       
                                       }
                                    
                                    .
                                 
                              
                           
                        where 
                           
                              
                                 
                                    V
                                    ^
                                 
                                 t
                              
                              
                                 (
                                 ·
                                 )
                              
                           
                         is a linear combination of the basis function chosen. Also, the algorithm can use relative error or other criteria. The MARS algorithm selects basis function one by one until M
                        max basis functions have been accumulated. Constants M
                        max and K affect the efficiency and accuracy of the algorithm.

We investigated a refinery in Shandong, China. We list all the data in supplementary material files. Table 2
                         summarizes some descriptive statistics of the refining processes.

We consider the procurement and operation over 6 months, that is, T = 6. We fix the product selling prices as in our applications, selling prices are set by long-term contracts. The system state specifies the purchase prices of 13 crude oils. We assume the crude oil prices follow GBM processes.

We test the performance of MARS/OA. We vary the values of K, the maximum interaction orders, and M
                        max, the maximum number of selected basis functions. As we have 6 periods, the numerical algorithm generates 6 approximated value functions. We can measure the relative error introduced in each period. For period t, let the vector of state variables be

                           
                              
                                 
                                    
                                       v
                                       t
                                    
                                    =
                                    
                                       (
                                       
                                          
                                             c
                                          
                                          t
                                          P
                                       
                                       ,
                                       
                                          I
                                          t
                                       
                                       )
                                    
                                    =
                                    
                                       
                                          (
                                          
                                             
                                                c
                                             
                                             
                                                1
                                                ,
                                                t
                                             
                                             P
                                          
                                          ,
                                          
                                             
                                                c
                                             
                                             
                                                1
                                                ,
                                                t
                                             
                                             P
                                          
                                          ,
                                          …
                                          ,
                                          
                                             
                                                c
                                             
                                             
                                                13
                                                ,
                                                t
                                             
                                             P
                                          
                                          ,
                                          
                                             I
                                             
                                                1
                                                ,
                                                t
                                                −
                                                1
                                             
                                          
                                          ,
                                          
                                             I
                                             
                                                2
                                                ,
                                                t
                                                −
                                                1
                                             
                                          
                                          ,
                                          …
                                          ,
                                          
                                             I
                                             
                                                13
                                                ,
                                                t
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                       T
                                    
                                    .
                                 
                              
                           
                        
                     

Let 
                           
                              
                                 
                                    V
                                    ^
                                 
                                 t
                              
                              
                                 (
                                 
                                    v
                                    t
                                 
                                 )
                              
                           
                         and Vt
                        (
                           v
                        
                        
                           t
                        ) be the approximated value function and the real value function, respectively. Recall that Vt
                        (
                           v
                        
                        
                           t
                        ) is defined by

                           
                              (2)
                              
                                 
                                    
                                       V
                                       t
                                    
                                    
                                       (
                                       
                                          v
                                          t
                                       
                                       )
                                    
                                    =
                                    
                                       max
                                       
                                          I
                                          t
                                       
                                    
                                    
                                       {
                                       F
                                       
                                          (
                                          
                                             v
                                             t
                                          
                                          ,
                                          
                                             I
                                             t
                                          
                                          )
                                       
                                       +
                                       E
                                       
                                          [
                                          
                                             V
                                             
                                                t
                                                +
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                v
                                                
                                                   t
                                                   +
                                                   1
                                                
                                             
                                             )
                                          
                                          |
                                          
                                             v
                                             t
                                          
                                          ]
                                       
                                       }
                                    
                                    .
                                 
                              
                           
                        
                     

For any state point 
                           v
                        
                        
                           t
                        , we define the cumulated relative error
                        
                           
                              
                                 ɛ
                              
                              t
                              C
                           
                         as

                           
                              
                                 
                                    
                                       
                                          ɛ
                                       
                                       t
                                       C
                                    
                                    
                                       (
                                       
                                          v
                                          t
                                       
                                       )
                                    
                                    =
                                    
                                       |
                                       
                                          
                                             
                                                
                                                   V
                                                   ^
                                                
                                                t
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                             −
                                             
                                                V
                                                t
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                          
                                          
                                             
                                                V
                                                t
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                          
                                       
                                       |
                                    
                                    .
                                 
                              
                           
                        
                     

In Eq. (2), Vt
                         is derived by accurate future value function V
                        
                           t + 1, while in our algorithm, 
                           
                              
                                 V
                                 ^
                              
                              t
                           
                         is generated based on approximated future value function 
                           
                              
                                 V
                                 ^
                              
                              
                                 t
                                 +
                                 1
                              
                           
                        . So the error between Vt
                         and 
                           
                              
                                 V
                                 ^
                              
                              t
                           
                         (i.e., 
                           
                              
                                 ɛ
                              
                              t
                              C
                           
                        ) comes from two parts: (a) errors introduced by MARS in period t and (b) errors between V
                        
                           t + 1 and 
                           
                              
                                 V
                                 ^
                              
                              
                                 t
                                 +
                                 1
                              
                           
                        . As a result, 
                           
                              
                                 ɛ
                              
                              t
                              C
                           
                         consists of algorithm errors in period t and 
                           
                              
                                 
                                    ɛ
                                 
                                 
                                    t
                                    +
                                    1
                                 
                                 C
                              
                              ,
                           
                        
                        
                           
                              
                                 ɛ
                              
                              
                                 t
                                 +
                                 1
                              
                              C
                           
                         consist of algorithm errors in period t + 1 and 
                           
                              
                                 
                                    ɛ
                                 
                                 
                                    t
                                    +
                                    2
                                 
                                 C
                              
                              ,
                           
                         and so on. In other words, 
                           
                              
                                 ɛ
                              
                              t
                              C
                           
                         consists of errors introduced by our algorithm in all the periods after t. We conclude that 
                           
                              
                                 ɛ
                              
                              t
                              C
                           
                         measures the cumulated error from period t to the end of horizon. However, we cannot calculate 
                           
                              
                                 
                                    ɛ
                                 
                                 t
                                 C
                              
                              
                                 (
                                 
                                    v
                                    t
                                 
                                 )
                              
                           
                         directly because we cannot get the accurate value function V
                        
                           t + 1. Instead, we measure the period error
                        
                           
                              
                                 ɛ
                              
                              t
                              P
                           
                        :

                           
                              (3)
                              
                                 
                                    
                                       
                                          ɛ
                                       
                                       t
                                       P
                                    
                                    
                                       (
                                       
                                          v
                                          t
                                       
                                       )
                                    
                                    =
                                    
                                       |
                                       
                                          
                                             
                                                
                                                   V
                                                   ^
                                                
                                                t
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                             −
                                             
                                                V
                                                t
                                                ′
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                          
                                          
                                             
                                                V
                                                t
                                                ′
                                             
                                             
                                                (
                                                
                                                   v
                                                   t
                                                
                                                )
                                             
                                          
                                       
                                       |
                                    
                                    ,
                                 
                              
                           
                        where 
                           
                              
                                 V
                                 t
                                 ′
                              
                              
                                 (
                                 
                                    v
                                    t
                                 
                                 )
                              
                           
                         is defined by

                           
                              (4)
                              
                                 
                                    
                                       V
                                       t
                                       ′
                                    
                                    
                                       (
                                       
                                          v
                                          t
                                       
                                       )
                                    
                                    =
                                    
                                       max
                                       
                                          I
                                          t
                                       
                                    
                                    
                                       {
                                       F
                                       
                                          (
                                          
                                             v
                                             t
                                          
                                          ,
                                          
                                             I
                                             t
                                          
                                          )
                                       
                                       +
                                       E
                                       
                                          [
                                          
                                             
                                                V
                                                ^
                                             
                                             
                                                t
                                                +
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                v
                                                
                                                   t
                                                   +
                                                   1
                                                
                                             
                                             )
                                          
                                          |
                                          
                                             v
                                             t
                                          
                                          ]
                                       
                                       }
                                    
                                    .
                                 
                              
                           
                        
                     

In (4), we always use the approximate value function 
                           
                              
                                 V
                                 ^
                              
                              
                                 t
                                 +
                                 1
                              
                           
                         to solve 
                           
                              
                                 V
                                 t
                                 ′
                              
                              
                                 (
                                 
                                    v
                                    t
                                 
                                 )
                              
                           
                        . In contrast, 
                           
                              
                                 V
                                 ^
                              
                              t
                           
                         is obtained from the MARS algorithm. The relative error between 
                           
                              
                                 V
                                 ^
                              
                              t
                           
                         and 
                           
                              V
                              t
                              ′
                           
                         (i.e., 
                           
                              
                                 ɛ
                              
                              t
                              P
                           
                        ) measures the error introduced by MARS in period t. We generated 1000 state points randomly for each period, calculated the relative error on these point, and obtained 
                           
                              6
                              ×
                              1000
                              =
                              6000
                           
                         observations of relative error. We compared these errors under different settings of K and M
                        max. Figs. 2
                         and 3
                         plot the results.

In Fig. 2, the heights of the boxes represent the interquartile range defined by the difference between the third and the first quartiles of the data, and the line inside the box is the median of the data. The range of the whiskers are defined by the lowest and highest datum within 1.5 interquartile range. We observe that most of the relative errors are lower than 1 percent, and the error distributions have little differences between different K and M
                        max . We conclude that the MARS approach performs well on our problem.


                        Fig. 3 illustrates how much computational effort we need to solve the problem. We observe that the numerical tests can be completed in hours. The computational environment is

                           
                              •
                              CPU: 8 × Intel Xeon E7-8850, 2.0 gigahertz, 24 megabytes L3 Cache

RAM: 512 gigabytes, DDR3

System: Windows Server 2008 R2 X64

Tools: Matlab, Python packages, SciPy and Cvxopt

Coding environment: Python 2.7

After conversations with the managers of the refinery, we find that their procurement and operation plan was similar to a myopic policy. The manager first determines the minimum inventory level at the end of each period. This minimum inventory serves as a safety stock to hedge the supply risks. Then, they compute the optimal procurement and production plan under the minimum inventory constraint. In this section, we compare this myopic policy with the optimal solution.

Let 
                           I
                        
                        min  be the minimum inventory requirement at the end of each period. We generate 200 random price paths according to the GBM model. Let 
                           
                              V
                              ¯
                           
                         and 
                           
                              
                                 
                                    V
                                    ¯
                                 
                                 S
                              
                              
                                 (
                                 
                                    I
                                    min
                                 
                                 )
                              
                           
                         be the average profits of the optimal solution and myopic policy, respectively. Fig. 4
                         plots the average profits. We offer two insights: First, 
                           
                              V
                              ¯
                           
                         is always larger than 
                           
                              
                                 
                                    V
                                    ¯
                                 
                                 S
                              
                              
                                 (
                                 
                                    I
                                    min
                                 
                                 )
                              
                           
                         for a wide range of 
                           I
                        
                        min . Second, 
                           
                              
                                 
                                    V
                                    ¯
                                 
                                 S
                              
                              
                                 (
                                 
                                    I
                                    min
                                 
                                 )
                              
                           
                         first increases in 
                           I
                        
                        min , and then decreases in 
                           I
                        
                        min . Fig. 4 provides the average profit. In fact, we find that in at least 94 percent of the paths, optimal solution leads to a higher profit than the myopic policy.

We discuss the effects of forecast accuracy on the myopic policy and optimal solution. In the previous section, we show the significant sub-optimality of the myopic policy if the price parameters 
                           μ
                         and 
                           Σ
                         can be accurately estimated. One important question raised by the refinery manager is, what if the estimations of 
                           μ
                         and 
                           Σ
                         are not accurate? Does the optimal solution still outperform the myopic policy? In this section, we seek to numerically examine the effect of forecast accuracy on the preferences between optimal solution and myopic policy.

For given 
                           μ
                         and 
                           
                              Σ
                              ,
                           
                         we compute the optimal solution and the best myopic policy over all different minimum inventory constraints. We take 
                           μ
                         and 
                           Σ
                         as the manager’s estimation of the real drift rate and volatility. We assume different real drift rates and volatilities and examine its effects on the average profit. The same as previous simulation, we randomly generate 200 price paths and compute the average as the average profit.


                        Fig. 5
                         (a) plots the average profits for different real drift rates. We observe that the optimal solution outperforms the myopic policy consistently. Further, we find that the estimations of drift rates do not have much impact on the average profit. The curves are very flat with respect to the forecast accuracy. Fig. 5(b) shows the percent of random price paths where optimal solution outperforms myopic policy. We find that the optimal solution consistently performs better than the myopic policy. As a summary, Fig. 5(a) and (b) suggests that the preference between the optimal solution and the myopic policy is affected by forecast accuracy in drift rate 
                           μ
                        .

Fig. 5 (c) and (d) illustrates the effects of 
                           Σ
                        ’s forecast accuracy. We find that the gap between the optimal solution and the myopic policy decreases with 
                           Σ
                        . The result is striking as Fig. 5(d) shows that when the real 
                           Σ
                         is larger than expected, the optimal solution performs better than the myopic policy in only 70 percent of all the random price paths. The result implies that underestimating price volatility reduces the value of the optimal solution as opposed to the myopic policy. This result highlights the importance of accurately estimating 
                           Σ
                        .

@&#CONCLUSION@&#

In oil refineries, making procurement and operation decisions is extremely complex, due to highly volatile prices, multiperiod decision process, and multiple products. In previous researches, many researchers have developed different models to describe oil price behaviors, but few literatures applied those models into refinery operations. To our knowledge, this paper is among the first in refinery operation optimization to consider price behaviors over time.

We use GBM to model oil price behaviors and build a multiperiod stochastic dynamic programming model to optimize refinery operations. The model structure implies that refineries can separate decisions into long-term inventory planning decisions and short-term operation decisions. We use OA sampling and MARS algorithm to solve the multiperiod model approximately. We solve the multiperiod model numerically based on refinery data from a refinery in China and obtain the optimal solution of the approximate problem. Numerical results show that the OA/MARS algorithm performs well in computing time and accuracy.

We then compare the optimal solution with a set of myopic policies, which first set a minimum inventory requirement at the end of each period and then solve each period independently. We find that the optimal solution significantly outperforms the myopic policies, both on average profits and on profits under most price paths.

Finally, we study the effects of forecast accuracy on the myopic policy and optimal solution. We find that the optimal solution consistently performs better than the myopic policy under estimation inaccuracy on oil price drift rate. In contrast, estimation accuracy on oil price volatilities have a significant impact on both average profit and superiority of the optimal solution. Numerical results imply that underestimating price volatility reduces the value of the optimal solution as opposed to the myopic policy. This result highlights the importance of accurately estimating price volatilities.

This paper proposes an approach to apply price behavior models in refinery operation optimizations. We suggest three interesting future research directions on this problem: First, different price models can be tested and compared in the multiperiod model. There may exist some insights in the interactions between price behavior models and refinery operation decision processes. Second, the multiperiod model can be extended, such as considering uncertain demand, crude oil shipment, etc. Finally, risk management techniques can be applied in this problem. This paper optimizes refinery operations by maximizing the mean profit, without controlling the risk of losing profit. Risk measures can be applied to derive strategies with lower risk.

@&#ACKNOWLEDGMENTS@&#

The authors thank the editor, Lorenzo Peccati, and the anonymous referees for their valuable comments on this paper. This research was partially supported by the National Science Foundation of China grant nos. 71071084, 71332005, and 71401086.

Supplementary material associated with this article can be found, in the online version, at 10.1016/j.ejor.2015.03.002.


                     
                        
                           
                        
                     
                  

@&#REFERENCES@&#

