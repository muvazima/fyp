@&#MAIN-TITLE@&#Variational inference for medical image segmentation

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           We present a generalisation of the brain segmentation algorithm implemented in the SPM software, which exploits variational Bayesian inference


                        
                        
                           
                           We test the accuracy and robustness of our method in segmenting brain tissues using synthetic and real MRI data


                        
                        
                           
                           We introduce an empirical Bayes framework to learn tissue specific intensity priors from large data sets


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Image segmentation

Bayesian inference

Variational Bayes

Neuroimaging

MRI

@&#ABSTRACT@&#


               
               
                  Variational inference techniques are powerful methods for learning probabilistic models and provide significant advantages over maximum likelihood (ML) or maximum a posteriori (MAP) approaches. Nevertheless they have not yet been fully exploited for image processing applications. In this paper we present a variational Bayes (VB) approach for image segmentation. We aim to show that VB provides a framework for generalising existing segmentation algorithms that rely on an expectation–maximisation formulation, while increasing their robustness and computational stability. We also show how optimal model complexity can be automatically determined in a variational setting, as opposed to ML frameworks which are intrinsically prone to overfitting. Finally, we demonstrate how suitable intensity priors, that can be used in combination with the presented algorithm, can be learned from large imaging data sets by adopting an empirical Bayes approach.
               
            

@&#INTRODUCTION@&#

When analysing neuroimaging data, it is often necessary or helpful to partition brain tissues into different types. This represents indeed the primary stage for performing brain volumetry, which is extremely valuable both in research and for clinical practice (Ashburner and Friston, 2000; Giorgio and De Stefano, 2013). In fact, quantifying brain structure volume not only has a major role for unraveling the mechanisms underlying neurodegenerative and psychiatric disorders, but can also significantly help in disease diagnosis and treatment planning or monitoring (Mazzara et al., 2004).

For healthy subjects the tissues of interest are typically gray matter, white matter and cerebrospinal fluid, while for patients, additional classes may be defined, such as tumour, edema or necrosis (Moon et al., 2002; Prastawa et al., 2004). In this framework, magnetic resonance imaging (MRI) is usually the most convenient imaging modality to work with, as it provides simultaneously high spatial resolution, excellent soft tissue contrast and good signal to noise ratio.

Many widely used image segmentation algorithms rely on probabilistic modelling techniques to fit the intensity distributions of images. These methods commonly operate by means of unsupervised clustering algorithms and assume that the data are drawn from mixture distributions, with different mixture components being associated to different tissue types. In particular, Gaussian mixture models (GMM) have been extensively adopted as they provide a flexible and computationally efficient framework that can be easily applied to solve the problem of automatically partitioning images into homogeneous regions (Dugas-Phocion et al., 2004; Greenspan et al., 2006; Guillemaud and Brady, 1997; Moon et al., 2002; Noe and Gee, 2001; Van Leemput et al., 1999; Wells III et al., 1996; Woolrich et al., 2009; Zhang et al., 2001).

Intensity based segmentation tools of this sort have been developed profusely over the past twenty years. Most of them either rely directly on an explicit Bayesian formulation, or exhibit an implicit probabilistic interpretation. Nevertheless almost all of them are based on maximum likelihood (ML) or maximum a posteriori (MAP) estimation of the model parameters (Ashburner and Friston, 2005; Greenspan et al., 2006; Kovacevic et al., 2002; Liang et al., 1994; Lorenzo-Valdés et al., 2004; Rajapakse and Kruggel, 1998; Van Leemput et al., 2003; Wyatt and Noble, 2003; Xiaohua et al., 2004; Zhang et al., 2001), without exploiting the potential of full Bayesian inference.

Indeed, the choice of ML or MAP techniques ensures mathematical tractability and sufficient segmentation accuracy for many applications. Nonetheless there is still a crucial theoretical point that makes these methods somehow suboptimal, regardless of their mathematical and computational convenience: the fact that they just provide point estimates of the model parameters instead of full posterior probability distributions. In other words, information is missing on the posterior uncertainty in estimating unobserved variables, and this often results in the occurrence of overfitting as well as in the difficulty to perform model comparison (Attias, 1999).

On the other hand, full Bayesian inference has been poorly explored in the field of medical image segmentation, in spite of a promising potential, which was shown for example by Woolrich and Behrens (2006) and Tian et al. (2011). The reason for this is most probably related to the computational challenges that arise when trying to evaluate the model evidence or the posterior probability distributions over the model parameters. In fact, very often and also for relatively simple models, integrating out all the unobserved variables turns out to be intractable in analytical form. On the other hand, numerical integration is generally impractical because either the dimensionality, or the complexity, of the problem would make the computational resources necessary to integrate over all possible parameter configurations too large for real world applications.

One approach for dealing with the mathematical difficulties that arise in Bayesian inference is to make use of stochastic techniques to sample from the probability distributions that are of interest (Andrieu et al., 2003). In particular, Markov Chain Monte Carlo methods can provide rather accurate solutions at the expenses of a long processing time. As to be expected, the time required to reach convergence increases with the size of the data set. The result of this being the fact that, for large-scale problems, sampling techniques can become computationally prohibitive. The work of Iglesias et al. (2012) is among the very few attempts to exploit MCMC sampling methods to integrate out model parameters in the context of Bayesian medical image segmentation. Their atlas based segmentation method takes into account the uncertainty in the estimates of the deformations that bring the individual images in alignment with the reference anatomical space. However, they report a running time of the sampling of approximately three hours, which might still be non-viable for some applications, even if this additional computational time ensures higher segmentation accuracy. Related work, on solving image segmentations problems making use of stochastic techniques, has been done also by Fan et al. (2007), Kato (2008) and da Silva (2009).

A second family of approaches is based on introducing analytical approximations. For instance, one possibility is to approximate an unknown posterior probability distribution by a Gaussian, centred at the mode of the posterior, or at one of the modes, if the distribution is multimodal. Such a method, known as the Laplace approximation, overcomes many of the limitations of sampling techniques, since the number of required computations is much lower in this case. Nevertheless, depending on how different the actual posterior distribution is from a Gaussian, the method might provide a poor approximation. In particular the underlying Gaussian assumption might become inadequate for samples that are far from the mode of the density.

Variational Bayes (VB) represents an alternative way of obtaining approximate solutions to inference problems. It often relies on analytical approximations, as the Laplace method, and likewise it is much less computationally expensive than MCMC. However, the VB framework is more general and flexible than the Laplacian approach. In fact, even if for computational reasons it is often necessary to constrain the posterior distributions to have a specific form or factorisation, they are not necessarily forced to be Gaussian. In other words, variational Bayesian inference permits finding a trade off between allowing sufficient complexity and accuracy of the estimated posteriors and ensuring computational tractability. Stochastic variational algorithms have also been proposed (Hoffman et al., 2013).

Even if the estimated posteriors will almost never be exact, variational methods have proved to be more convenient than standard ML or MAP techniques, since, at a substantially similar computational cost, they significantly alleviate the problems related to overfitting, which are intrinsic to the other methods. In other words, variational techniques open up the possibility of learning the optimal model structure (the one with highest generalisation capability) without performing ad-hoc cross validation analyses (Attias, 1999; Bishop et al., 2006; Corduneanu and Bishop, 2001). Another interesting aspect of working within a VB framework is that it leads to a more general formulation of the EM algorithm, which has the same convergence properties and higher computational stability. In fact, one significant limitation of the ML formulation (for mixture models) is the presence of singular points of the likelihood function, which have to be avoided during the optimisation process to assure numerical stability.

So far, very few authors have explored the applicability of the variational Bayes framework to perform medical image segmentation. In particular, Woolrich and Behrens (2006) exploited variational inference to fit spatial mixture models to medical imaging data while automatically tuning the parameter controlling spatial regularisation. Tian et al. (2011) proposed a variational algorithm for segmenting brain MRI data, which combines variational Bayes techniques with a genetic algorithm to initialise the priors on tissue intensities.

In this paper, we present an extension of the tissue classification algorithm presented by Ashburner and Friston (2005) and publicly distributed as part of the SPM12 software. Specifically, we replace the maximum likelihood approach adopted in Ashburner and Friston (2005) to estimate the Gaussian mixture parameters that model the distribution of image intensities, with a fully Bayesian inference scheme relying on variational approximations.

This greatly increases the robustness of the method if suitable intensity priors are introduced, thus reducing significantly the chance of the algorithm failing due to the mismatch or misregistration of the tissue probability maps with the individual scans. Additionally we demonstrate that, in principle, having tissue specific intensity priors yields fairly accurate segmentations also in a completely atlas- (and registration-) free setting.

Secondly, we illustrate how the fundamental problem of determining the optimal model complexity, i.e. the number of Gaussian components that are necessary to model the distributions of the different tissues, can be effectively addressed in a variational setting. Such a framework, in fact, implicitly implements an automatic relevance determination scheme, where redundant mixture components are automatically pruned out of the model.

Finally we present a parametric empirical Bayes approach to learn informative intensity priors from sufficiently large data sets and demonstrate how the priors estimated in this fashion can increase the robustness of the presented segmentation algorithm. We also address the common problem of different MRI images having different intensity values by incorporating a free global rescaling parameter that is optimised, within the same Bayesian framework, so as to increase the consistency of intensities across scans.

In this section we summarise the underpinnings of variational Bayesian inference. We highlight the advantages of VB over point estimation techniques and illustrate some of the challenges that arise in the variational framework.

Variational Bayesian inference can be formulated as a maximisation (or minimisation) problem.

Let us consider the marginal log likelihood log p(X) given by

                        
                           (1)
                           
                              
                                 log
                                 p
                                 (
                                 X
                                 )
                                 =
                                 log
                                 ∫
                                 p
                                 (
                                 
                                    X
                                    ,
                                    Υ
                                 
                                 )
                                 
                                 d
                                 Υ
                                 
                                 ,
                              
                           
                        
                     where X indicates the observed data and ϒ the set of unobserved variables (model parameters and latent variables).

If we introduce a distribution q(ϒ) over the unobserved variables, the log evidence in (1) can be re-expressed as

                        
                           (2)
                           
                              
                                 
                                    
                                       
                                          log
                                          p
                                          (
                                          X
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          ∫
                                          q
                                          (
                                          Υ
                                          )
                                          log
                                          p
                                          (
                                          X
                                          )
                                          
                                          d
                                          Υ
                                       
                                    
                                 
                                 
                                    
                                    
                                       =
                                    
                                    
                                       
                                          ∫
                                          q
                                          
                                             (
                                             Υ
                                             )
                                          
                                          log
                                          
                                             {
                                             
                                                
                                                   p
                                                   (
                                                   
                                                      X
                                                      ,
                                                      Υ
                                                   
                                                   )
                                                
                                                
                                                   q
                                                   (
                                                   Υ
                                                   )
                                                
                                             
                                             }
                                          
                                          d
                                          Υ
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          ∫
                                          q
                                          
                                             (
                                             Υ
                                             )
                                          
                                          log
                                          
                                             {
                                             
                                                
                                                   q
                                                   (
                                                   Υ
                                                   )
                                                
                                                
                                                   p
                                                   (
                                                   
                                                      Υ
                                                      |
                                                      X
                                                   
                                                   )
                                                
                                             
                                             }
                                          
                                          d
                                          Υ
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     which is a decomposition of log p(X) that holds for any q(ϒ).

The second integral in the last line of (2) is the Kullback–Leibler divergence DKL
                     (q‖p) between q(ϒ), which is a variational approximating posterior, and p(ϒ|X), which is the true posterior distribution (Bishop et al., 2006).

Since DKL
                     (q‖p) ≥ 0, the first integral in the last line of (2) defines a lower bound 
                        
                           L
                           (
                           q
                           )
                        
                      on the logarithm of the model evidence

                        
                           (3)
                           
                              
                                 
                                    
                                       
                                          log
                                          p
                                          
                                             (
                                             X
                                             )
                                          
                                          ≥
                                          L
                                          
                                             (
                                             q
                                             )
                                          
                                          =
                                          ∫
                                          q
                                          
                                             (
                                             Υ
                                             )
                                          
                                          log
                                          
                                             {
                                             
                                                
                                                   p
                                                   (
                                                   
                                                      X
                                                      ,
                                                      Υ
                                                   
                                                   )
                                                
                                                
                                                   q
                                                   (
                                                   Υ
                                                   )
                                                
                                             
                                             }
                                          
                                          d
                                          Υ
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     The previous statement can also be derived from (1) by applying Jensen’s inequality.

In summary Eq. (2) can be rewritten as (Tzikas et al., 2008)

                        
                           (4)
                           
                              
                                 log
                                 p
                                 
                                    (
                                    X
                                    )
                                 
                                 =
                                 L
                                 
                                    (
                                    q
                                    )
                                 
                                 +
                                 
                                    D
                                    
                                       K
                                       L
                                    
                                 
                                 
                                    (
                                    q
                                    ∥
                                    p
                                    )
                                 
                                 
                                 .
                              
                           
                        
                     
                  

As anticipated, DKL
                     (q‖p) is always non negative and, in particular, it is equal to zero if and only if 
                        
                           q
                           (
                           Υ
                           )
                           =
                           p
                           (
                           Υ
                           |
                           X
                           )
                        
                     . In such a case the variational posterior is an exact solution and the lower bound is exactly equal to the evidence.

In all the other cases, DKL
                     (q‖p) > 0 and 
                        
                           L
                           (
                           q
                           )
                           <
                           log
                           p
                           (
                           X
                           )
                           ,
                        
                      which means that q(ϒ) is an approximate posterior.

In summary, the inference problem can be solved by maximizing the functional 
                        
                           L
                           (
                           q
                           )
                        
                      with respect to the distribution q(ϒ), which is equivalent to minimizing the Kullback–Leibler divergence between the variational and the true posterior distribution.

The lower bound on the model evidence (negative variational free energy) can be further decomposed as

                        
                           (5)
                           
                              
                                 L
                                 
                                    (
                                    q
                                    )
                                 
                                 =
                                 ∫
                                 q
                                 
                                    (
                                    Υ
                                    )
                                 
                                 log
                                 
                                    p
                                    (
                                    
                                       X
                                       |
                                       Υ
                                    
                                    )
                                 
                                 d
                                 Υ
                                 +
                                 ∫
                                 q
                                 
                                    (
                                    Υ
                                    )
                                 
                                 log
                                 
                                    {
                                    
                                       
                                          p
                                          (
                                          Υ
                                          )
                                       
                                       
                                          q
                                          (
                                          Υ
                                          )
                                       
                                    
                                    }
                                 
                                 d
                                 Υ
                                 
                                 .
                              
                           
                        
                     
                  

This shows that the lower bound comprises a likelihood term which is equal to the expected value of the log likelihood log p(X|Υ) under the variational posterior q(ϒ)

                        
                           (6)
                           
                              
                                 
                                    L
                                    1
                                 
                                 =
                                 ∫
                                 q
                                 
                                    (
                                    Υ
                                    )
                                 
                                 log
                                 
                                    p
                                    (
                                    
                                       X
                                       |
                                       Υ
                                    
                                    )
                                 
                                 d
                                 Υ
                                 =
                                 
                                    E
                                    Υ
                                 
                                 
                                    [
                                    log
                                    p
                                    (
                                    
                                       X
                                       |
                                       Υ
                                    
                                    )
                                    ]
                                 
                                 
                                 ,
                              
                           
                        
                     and a regularizing term which is the negative Kullback–Leibler divergence between the approximating posterior q(ϒ) and the prior distribution over the unobserved variables p(ϒ) (Attias, 1999)

                        
                           (7)
                           
                              
                                 
                                    L
                                    2
                                 
                                 =
                                 ∫
                                 q
                                 
                                    (
                                    Υ
                                    )
                                 
                                 log
                                 
                                    {
                                    
                                       
                                          p
                                          (
                                          Υ
                                          )
                                       
                                       
                                          q
                                          (
                                          Υ
                                          )
                                       
                                    
                                    }
                                 
                                 d
                                 Υ
                                 =
                                 −
                                 
                                    D
                                    
                                       K
                                       L
                                    
                                 
                                 
                                    (
                                    q
                                    ∥
                                    
                                       p
                                       0
                                    
                                    )
                                 
                                 
                                 .
                              
                           
                        
                     This last term penalises overly complex or implausible models (Occam factor) (Attias, 1999).

While in principle arbitrary variational posterior distributions q(ϒ) can be used, a commonly adopted strategy to solve the inference problem consists in restricting the space of q(ϒ) so as to ensure mathematical tractability, which also means that DKL
                     (q‖p) > 0, or, in other words, that q(ϒ) ≠ p(ϒ|X). In particular, it is often convenient to assume that q(ϒ) factorises into a product of terms, each one involving just a subset of ϒ (mean field theory): 
                        
                           q
                           
                              (
                              Υ
                              )
                           
                           =
                           
                              ∏
                              
                                 s
                                 =
                                 1
                              
                              S
                           
                           
                              q
                              s
                           
                           
                              (
                              
                                 Υ
                                 s
                              
                              )
                           
                        
                     .

In such a case, the lower bound depends on the generic factor 
                        
                           
                              q
                              
                                 s
                                 ^
                              
                           
                           
                              (
                              
                                 Υ
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                        
                      as follows (Bishop et al., 2006)

                        
                           (8)
                           
                              
                                 
                                    
                                       
                                          L
                                          
                                             (
                                             
                                                q
                                                
                                                   s
                                                   ^
                                                
                                             
                                             )
                                          
                                          =
                                          −
                                          
                                             D
                                             
                                                K
                                                L
                                             
                                          
                                          
                                             (
                                             
                                                q
                                                
                                                   s
                                                   ^
                                                
                                             
                                             
                                             ∥
                                             
                                             
                                                p
                                                ^
                                             
                                             
                                                (
                                                
                                                   
                                                      X
                                                      ,
                                                      Υ
                                                   
                                                   
                                                      s
                                                      ^
                                                   
                                                
                                                )
                                             
                                             )
                                          
                                          +
                                          const
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with

                        
                           (9)
                           
                              
                                 
                                    
                                       
                                          
                                             p
                                             ^
                                          
                                          
                                             (
                                             
                                                
                                                   X
                                                   ,
                                                   Υ
                                                
                                                
                                                   s
                                                   ^
                                                
                                             
                                             )
                                          
                                          ∝
                                          exp
                                          
                                             (
                                             
                                                E
                                                
                                                   s
                                                   ≠
                                                   
                                                      s
                                                      ^
                                                   
                                                
                                             
                                             
                                                [
                                                log
                                                p
                                                
                                                   (
                                                   
                                                      X
                                                      ,
                                                      Υ
                                                   
                                                   )
                                                
                                                ]
                                             
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  


                     Eq. (8) shows that the optimal form of the factor 
                        
                           
                              q
                              
                                 s
                                 ^
                              
                           
                           
                              (
                              
                                 Υ
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                        
                      corresponds to the one that minimises the Kullback–Leibler divergence between 
                        
                           
                              q
                              
                                 s
                                 ^
                              
                           
                           
                              (
                              
                                 Υ
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                        
                      and 
                        
                           
                              p
                              ^
                           
                           
                              (
                              
                                 
                                    X
                                    ,
                                    Υ
                                 
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                        
                      which is defined in (9). Therefore 
                        
                           
                              q
                              
                                 s
                                 ^
                              
                           
                           
                              (
                              
                                 Υ
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                           ≡
                           
                              p
                              ^
                           
                           
                              (
                              
                                 
                                    X
                                    ,
                                    Υ
                                 
                                 
                                    s
                                    ^
                                 
                              
                              )
                           
                        
                     .

Note that this solution is not analytical, since the different factors have optimal forms that depend on one another. As a result, the natural approach for solving this variational optimisation problem consist in iteratively updating each factor given the most recent forms of the other ones. This leads to a scheme that turns out to be very similar to the structure of the EM algorithm (Bishop et al., 2006; Tzikas et al., 2008).

For some complex models, a fully Bayesian treatment of all unobserved variables might still be extremely impractical, if not impossible, even when variational techniques are used. One other advantage from adopting a VB approach is that its generality allows it to be combined with standard MAP and ML techniques in a unified and principled framework. If one of the subsets 
                        
                           
                              {
                              
                                 Υ
                                 s
                              
                              }
                           
                           
                              s
                              =
                              1
                              ,
                              …
                              ,
                              S
                           
                        
                      of the unobserved variables cannot be treated in a fully Bayesian manner, it is still possible to obtain MAP point estimates for the corresponding parameters. Such values are obtained in a way that is a generalisation of the M-step in the EM algorithm. In particular, the function that needs to be optimised is the expectation of the logarithm of the joint probability of X and ϒ, 
                        
                           E
                           [
                           log
                           p
                           (
                           
                              X
                              ,
                              Υ
                           
                           )
                           ]
                        
                     . The main difference from the EM algorithm for ML (or MAP) estimation is that in the VBEM case, expectations are computed not only over the latent variables of the model (as in the EM), but also over all the model parameters that are described in terms of a full posterior distribution.

This section describes the mathematical model adopted for this work. We introduce all variables, illustrate their conditional dependencies and, finally, we derive a variational objective function (lower bound).

Let X denote the observed data, that is to say the intensities corresponding to D images of the same subject acquired with different modalities. The signal at voxel j can then be represented by a D-dimensional vector 
                        
                           
                              x
                              j
                           
                           ∈
                           
                              R
                              D
                           
                           ,
                        
                      with 
                        
                           j
                           ∈
                           {
                           1
                           ,
                           …
                           ,
                           N
                           }
                        
                     .

We can model the distribution of x
                     
                        j
                      as a multivariate Gaussian mixture consisting of K clusters parameterised by mean vectors 
                        
                           
                              {
                              
                                 
                                    μ
                                 
                                 k
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              …
                              ,
                              K
                           
                        
                      and covariance matrices 
                        
                           
                              {
                              
                                 
                                    Σ
                                 
                                 k
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              …
                              ,
                              K
                           
                        
                     . The mixing proportions of the different components are given by 
                        
                           
                              Θ
                              π
                           
                           =
                           
                              {
                              
                                 π
                                 
                                    j
                                    k
                                 
                              
                              }
                           
                        
                      with πjk
                      ∈ [0, 1] and 
                        
                           
                              ∑
                              k
                           
                           
                              π
                              
                                 j
                                 k
                              
                           
                           =
                           1
                        
                     . Essentially πjk
                      indicates the prior probability of signal at spatial location j being drawn from cluster k.

Moreover we can assume that the K Gaussians are partitioned into T subsets, corresponding to different tissue types. Let 
                        
                           
                              {
                              
                                 C
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      denote these subsets, with 
                        
                           
                              ⋃
                              t
                              T
                           
                           
                              C
                              t
                           
                           =
                           
                              {
                              1
                              ,
                              …
                              ,
                              K
                              }
                           
                        
                     . This means that each tissue 
                        
                           t
                           ∈
                           {
                           1
                           ,
                           …
                           ,
                           T
                           }
                        
                      is itself represented by a GMM consisting of Kt
                      components with 
                        
                           
                              ∑
                              t
                           
                           
                              K
                              t
                           
                           =
                           K
                        
                     .

The prior probability of voxel j belonging to tissue t is considered to be given a priori (through a probabilistic atlas) and is indicated by τjt
                     . Furthermore, these tissue priors are allowed to be rescaled by a set of weights 
                        
                           
                              {
                              
                                 w
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      to accommodate individual differences in tissue composition. Finally it is necessary to introduce a set of parameters 
                        
                           
                              {
                              
                                 g
                                 k
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              ⋯
                              ,
                              K
                           
                        
                      denoting the normalised weights of the different Gaussians associated with one tissue type, so that

                        
                           (10)
                           
                              
                                 
                                    
                                       
                                          ∀
                                          t
                                          ∈
                                          
                                             {
                                             1
                                             ,
                                             …
                                             ,
                                             T
                                             }
                                          
                                          :
                                          
                                             ∑
                                             
                                                k
                                                ∈
                                                
                                                   C
                                                   t
                                                
                                             
                                          
                                          
                                             g
                                             k
                                          
                                          =
                                          1
                                          .
                                       
                                    
                                 
                              
                           
                        
                     As a result the mixing proportions Θπ
                      of the presented GMM can be expressed as

                        
                           (11)
                           
                              
                                 
                                    
                                       
                                          
                                             π
                                             
                                                j
                                                k
                                             
                                          
                                          =
                                          
                                             g
                                             k
                                          
                                          
                                             
                                                
                                                   τ
                                                   
                                                      j
                                                      t
                                                   
                                                
                                                
                                                
                                                   w
                                                   t
                                                
                                             
                                             
                                                
                                                   ∑
                                                   
                                                      
                                                         t
                                                         ′
                                                      
                                                   
                                                   T
                                                
                                                
                                                   τ
                                                   
                                                      j
                                                      
                                                         t
                                                         ′
                                                      
                                                   
                                                
                                                
                                                
                                                   w
                                                   
                                                      t
                                                      ′
                                                   
                                                
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where {τjk
                     } are known parameters, while 
                        
                           
                              {
                              
                                 w
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      and 
                        
                           
                              {
                              
                                 g
                                 k
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              ⋯
                              ,
                              K
                           
                        
                      have to be estimated from the observed data X.

To correct for intensity non-uniformity artifacts, a multiplicative D-dimensional bias field, denoted by 
                        
                           
                              
                                 {
                                 
                                    b
                                    j
                                 
                                 
                                    (
                                    
                                       Θ
                                       β
                                    
                                    )
                                 
                                 }
                              
                              
                                 j
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 N
                              
                           
                           ,
                        
                      is introduced in the model, where Θβ
                      is a vector of parameters. Each of the D components of the bias is modelled as the exponential of a linear combination of discrete cosine transform basis functions (Ashburner and Friston, 2005).

Finally, to account for the variability of anatomical shapes among subjects, the probabilistic atlas given by 
                        
                           
                              {
                              
                                 
                                    τ
                                 
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      is allowed to be deformed according to a displacement field parameterised by the set of vectors 
                        
                           
                              Θ
                              α
                           
                           =
                           
                              
                                 {
                                 
                                    
                                       α
                                    
                                    j
                                 
                                 }
                              
                              
                                 j
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 N
                              
                           
                        
                     . The warped tissue priors can therefore be expressed as 
                        
                           
                              
                                 {
                                 
                                    
                                       τ
                                    
                                    t
                                 
                                 
                                    (
                                    φ
                                    
                                       (
                                       
                                          Θ
                                          α
                                       
                                       )
                                    
                                    )
                                 
                                 }
                              
                              
                                 t
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 T
                              
                           
                           ,
                        
                      where φ(Θα
                     ) is a coordinate mapping from the individual image space into the atlas space. The parameterisation adopted here consists in adding to the identity transform a small displacement field 
                        
                           
                              
                                 {
                                 
                                    
                                       α
                                    
                                    j
                                 
                                 }
                              
                              
                                 j
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 N
                              
                           
                           ,
                        
                      so that

                        
                           (12)
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                y
                                                ˜
                                             
                                             j
                                          
                                          =
                                          
                                             y
                                             j
                                          
                                          +
                                          
                                             
                                                α
                                             
                                             j
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where the vector y
                     
                        j
                      encodes the coordinates of the centre of voxel j.

If we introduce a set of binary latent variables Z denoting the class memberships of the observed data X, the probability of Z given the mixing proportions Θπ
                      and the deformation parameters Θα
                      is given by

                        
                           (13)
                           
                              
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             Z
                                             |
                                             
                                                Θ
                                                π
                                             
                                             ,
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                          =
                                          
                                             ∏
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             ∏
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      
                                                         τ
                                                         
                                                            j
                                                            t
                                                         
                                                      
                                                      
                                                         (
                                                         φ
                                                         (
                                                         
                                                            Θ
                                                            α
                                                         
                                                         )
                                                         )
                                                      
                                                      
                                                      
                                                         w
                                                         t
                                                      
                                                   
                                                   
                                                      
                                                         ∑
                                                         
                                                            
                                                               t
                                                               ′
                                                            
                                                         
                                                         T
                                                      
                                                      
                                                         τ
                                                         
                                                            j
                                                            
                                                               t
                                                               ′
                                                            
                                                         
                                                      
                                                      
                                                         (
                                                         φ
                                                         (
                                                         
                                                            Θ
                                                            α
                                                         
                                                         )
                                                         )
                                                      
                                                      
                                                      
                                                         w
                                                         
                                                            t
                                                            ′
                                                         
                                                      
                                                   
                                                
                                                )
                                             
                                             
                                                z
                                                
                                                   j
                                                   k
                                                
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where we have assumed that all data are independent.

The conditional distribution (class conditional density) of the observed intensities given the latent variables, the Gaussian means Θμ
                      and covariances ΘΣ
                      and the bias field parameters Θβ
                      can be expressed as

                        
                           (14)
                           
                              
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             X
                                             |
                                             Z
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             ,
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                          =
                                          
                                             ∏
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             ∏
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             
                                                (
                                                
                                                   |
                                                
                                                
                                                   B
                                                   j
                                                
                                                
                                                   |
                                                   
                                                   N
                                                
                                                
                                                   (
                                                   
                                                      B
                                                      j
                                                   
                                                   
                                                      x
                                                      j
                                                   
                                                   |
                                                   
                                                      
                                                         μ
                                                      
                                                      k
                                                   
                                                   ,
                                                   
                                                      
                                                         Σ
                                                      
                                                      k
                                                   
                                                   )
                                                
                                                )
                                             
                                             
                                                z
                                                
                                                   j
                                                   k
                                                
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with 
                        
                           
                              B
                              j
                           
                           =
                           diag
                           
                              (
                              
                                 b
                                 j
                              
                              )
                           
                           ,
                        
                      modelling the bias field.

The joint probability of all the random variables conditioned on the mixing proportions is given, for the presented model, by

                        
                           (15)
                           
                              
                                 
                                    
                                       
                                          p
                                          (
                                          X
                                          ,
                                          Z
                                          ,
                                          
                                             Θ
                                             μ
                                          
                                          ,
                                          
                                             Θ
                                             Σ
                                          
                                          ,
                                          
                                             Θ
                                             β
                                          
                                          ,
                                          
                                             Θ
                                             α
                                          
                                          |
                                          
                                             Θ
                                             π
                                          
                                          )
                                          =
                                       
                                    
                                 
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             X
                                             |
                                             Z
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             ,
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                          p
                                          
                                             (
                                             Z
                                             |
                                             
                                                Θ
                                                π
                                             
                                             ,
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                          p
                                          
                                             (
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                          p
                                          
                                             (
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                          p
                                          
                                             (
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     The voxel specific mixing proportions Θπ
                      are treated here as deterministic parameters depending on the available anatomical atlas, on the tissue weights 
                        
                           
                              {
                              
                                 w
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      and on the within-tissue mixing proportions 
                        
                           
                              
                                 {
                                 
                                    g
                                    k
                                 
                                 }
                              
                              
                                 k
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 K
                              
                           
                           ,
                        
                      therefore they are determined via ML estimation.

It should be noted that we have kept the formal distinction between latent variables Z and model parameters 
                        Θ
                      for clarity, even if the treatment of these is essentially the same with variational inference techniques.

The priors on the means and covariances of the different classes are modelled as Gaussian–Wishart distributions

                        
                           (16)
                           
                              
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                          =
                                          
                                             ∏
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          p
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          p
                                          
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with

                        
                           (17)
                           
                              
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          =
                                          N
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             ,
                                             
                                                b
                                                
                                                   0
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                             
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (18)
                           
                              
                                 
                                    
                                       
                                          p
                                          
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          =
                                          W
                                          
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                             
                                                W
                                                
                                                   0
                                                   k
                                                
                                             
                                             ,
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where 
                        
                           W
                           (
                           W
                           ,
                           ν
                           )
                        
                      indicates the probability density function of a Wishart distribution with ν degrees of freedom and scale matrix 
                        W
                      (see Appendix A for a more detailed description of Gaussian–Wishart priors).

Such a choice is algebraically convenient, as it leads to posterior distributions having the same functional form of the priors (conjugate priors).

The parameters governing the priors will be indicated as

                        
                           (19)
                           
                              
                                 
                                    Φ
                                    0
                                 
                                 
                                    =
                                    {
                                 
                                 
                                    
                                       
                                          β
                                          
                                             0
                                             k
                                          
                                       
                                       ,
                                       
                                          m
                                          
                                             0
                                             k
                                          
                                       
                                       ,
                                       
                                          ν
                                          
                                             0
                                             k
                                          
                                       
                                       ,
                                       
                                          W
                                          
                                             0
                                             k
                                          
                                       
                                       
                                          }
                                       
                                    
                                    
                                       k
                                       =
                                       1
                                       ,
                                       …
                                       ,
                                       K
                                    
                                 
                                 
                                 .
                              
                           
                        
                     
                  

The terms p(Θα
                     ) and p(Θβ
                     ) represent prior probability distributions over the deformation and bias field parameters. Their function is to regularise the solution obtained through model fitting by penalizing improbable parameters values. In doing so, they assure greater physical plausibility of the resulting non-uniformity and deformation fields, while also improving numerical stability within the optimisation process. Here the same regularisation scheme described in Ashburner and Friston (2005) is adopted. The question of how to determine optimal forms for the regularisation terms is beyond the scope of this work and therefore is not addressed here. Interestingly, such a problem could also be solved in a variational inference framework, as shown in Simpson et al. (2012).

A lower bound on the marginal likelihood p(X, Θβ, Θα
                     |Θπ
                     ) is given by

                        
                           (20)
                           
                              
                                 
                                    
                                       L
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             ∑
                                             Z
                                          
                                          
                                             
                                             
                                                ∫
                                             
                                             
                                                ∫
                                             
                                             
                                          
                                          q
                                          
                                             (
                                             Z
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ×
                                          log
                                          
                                             {
                                             
                                                
                                                   p
                                                   (
                                                   X
                                                   ,
                                                   Z
                                                   ,
                                                   
                                                      Θ
                                                      μ
                                                   
                                                   ,
                                                   
                                                      Θ
                                                      Σ
                                                   
                                                   ,
                                                   
                                                      Θ
                                                      β
                                                   
                                                   ,
                                                   
                                                      Θ
                                                      α
                                                   
                                                   |
                                                   
                                                      Θ
                                                      π
                                                   
                                                   )
                                                
                                                
                                                   q
                                                   (
                                                   Z
                                                   ,
                                                   
                                                      Θ
                                                      μ
                                                   
                                                   ,
                                                   
                                                      Θ
                                                      Σ
                                                   
                                                   )
                                                
                                             
                                             }
                                          
                                          d
                                          
                                             Θ
                                             μ
                                          
                                          d
                                          
                                             Θ
                                             Σ
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

To make the problem tractable we assume that the variational distribution q(Z, Θμ, ΘΣ
                     ) factorises as 
                        
                           q
                           
                              (
                              Z
                              ,
                              
                                 Θ
                                 μ
                              
                              ,
                              
                                 Θ
                                 Σ
                              
                              )
                           
                           =
                           q
                           
                              (
                              Z
                              )
                           
                           q
                           
                              (
                              
                                 Θ
                                 μ
                              
                              ,
                              
                                 Θ
                                 Σ
                              
                              )
                           
                           ,
                        
                      so that

                        
                           (21)
                           
                              
                                 
                                    
                                       L
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             ∑
                                             Z
                                          
                                          
                                             
                                             
                                                ∫
                                             
                                             
                                                ∫
                                             
                                             
                                          
                                          q
                                          
                                             (
                                             Z
                                             )
                                          
                                          q
                                          
                                             (
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                          log
                                          p
                                          
                                             (
                                             
                                                X
                                                |
                                                Z
                                             
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             ,
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                          d
                                          
                                             Θ
                                             μ
                                          
                                          d
                                          
                                             Θ
                                             Σ
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             ∑
                                             Z
                                          
                                          
                                             
                                             
                                                ∫
                                             
                                             
                                                ∫
                                             
                                             
                                          
                                          q
                                          
                                             (
                                             Z
                                             )
                                          
                                          q
                                          
                                             (
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          ×
                                          log
                                          
                                             {
                                             
                                                
                                                   p
                                                   
                                                      (
                                                      Z
                                                      |
                                                      
                                                         Θ
                                                         π
                                                      
                                                      ,
                                                      
                                                         Θ
                                                         α
                                                      
                                                      )
                                                   
                                                   p
                                                   
                                                      (
                                                      
                                                         Θ
                                                         μ
                                                      
                                                      ,
                                                      
                                                         Θ
                                                         Σ
                                                      
                                                      )
                                                   
                                                
                                                
                                                   q
                                                   
                                                      (
                                                      Z
                                                      )
                                                   
                                                   q
                                                   
                                                      (
                                                      
                                                         Θ
                                                         μ
                                                      
                                                      ,
                                                      
                                                         Θ
                                                         Σ
                                                      
                                                      )
                                                   
                                                
                                             
                                             }
                                          
                                          d
                                          
                                             Θ
                                             μ
                                          
                                          d
                                          
                                             Θ
                                             Σ
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          p
                                          
                                             (
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                          +
                                          p
                                          
                                             (
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

The described probabilistic model can be represented by a directed acyclic graph, as shown in Fig. 1
                     . It should be noted that such a model is generative. In fact Eq. (15) allows to generate synthetic observations X via sampling from the joint distribution of all random variables conditioned on the mixing proportions (Bishop et al., 2007).

Once the model has been learned, it is directly possible to infer the tissue labels by examining the posterior distribution p(Z|X). In fact, the decision on which class each voxel belongs to should be taken according to Bayes decision rule (BDR), which states that the class to be chosen is the one that minimises the probability (”risk”) of error. In practice,

                        
                           (22)
                           
                              
                                 
                                    x
                                    j
                                 
                                 ∈
                                 class
                                 
                                 k
                                 ⇔
                                 p
                                 
                                    (
                                    
                                       z
                                       
                                          j
                                          k
                                       
                                    
                                    =
                                    1
                                    |
                                    
                                       x
                                       j
                                    
                                    )
                                 
                                 >
                                 p
                                 
                                    (
                                    
                                       z
                                       
                                          j
                                          
                                             k
                                             ′
                                          
                                       
                                    
                                    =
                                    1
                                    |
                                    
                                       x
                                       j
                                    
                                    )
                                 
                                 
                                 ∀
                                 
                                    k
                                    ′
                                 
                                 ≠
                                 k
                                 
                                 .
                              
                           
                        
                     
                  

The statistical model descried in Section 3 can be fit to data adopting a variational version of the standard EM algorithm for MLE. The objective of this optimisation procedure is to learn optimal solutions for the variational posterior distribution q(Z)q(Θμ, ΘΣ
                     ), to estimate MAP values for the parameters {Θα, Θβ
                     } and ML values for 
                        
                           
                              {
                              
                                 g
                                 k
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              …
                              ,
                              K
                           
                        
                      and 
                        
                           
                              {
                              
                                 w
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                     .

In the variational generalisation of the EM algorithm (VBEM) we can still distinguish two steps: VE-step and VM-step. In the variational E-step the functional 
                           L
                         in (20) is maximised with respect to the posterior factor q(Z) over the latent variables (Bishop et al., 2006). Making use of (9) we find that

                           
                              (23)
                              
                                 
                                    
                                       
                                          
                                             q
                                             (
                                             Z
                                             )
                                          
                                       
                                       
                                          ∝
                                       
                                       
                                          
                                             exp
                                             (
                                             log
                                             p
                                             (
                                             Z
                                             |
                                             
                                                Θ
                                                π
                                             
                                             ,
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                                E
                                                
                                                   μ
                                                   ,
                                                   Σ
                                                
                                             
                                             
                                                [
                                                log
                                                p
                                                (
                                                X
                                                |
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                ,
                                                
                                                   Θ
                                                   β
                                                
                                                )
                                                ]
                                             
                                             )
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

If we define

                           
                              (24)
                              
                                 
                                    
                                       
                                          
                                             log
                                             
                                                ρ
                                                
                                                   j
                                                   k
                                                
                                             
                                             =
                                             log
                                             p
                                             
                                                (
                                                Z
                                                |
                                                
                                                   Θ
                                                   π
                                                
                                                ,
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                             
                                             +
                                             
                                                E
                                                
                                                   μ
                                                   ,
                                                   Σ
                                                
                                             
                                             
                                                [
                                                log
                                                p
                                                (
                                                X
                                                |
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                ,
                                                
                                                   Θ
                                                   β
                                                
                                                )
                                                ]
                                             
                                             
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        it follows that

                           
                              (25)
                              
                                 
                                    
                                       
                                          
                                             q
                                             
                                                (
                                                Z
                                                )
                                             
                                             ∝
                                             
                                                ∏
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                ∏
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             
                                                
                                                   (
                                                   
                                                      ρ
                                                      
                                                         j
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   z
                                                   
                                                      j
                                                      k
                                                   
                                                
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        By normalizing the variational distribution q(Z) we obtain

                           
                              (26)
                              
                                 
                                    
                                       
                                          
                                             q
                                             
                                                (
                                                Z
                                                )
                                             
                                             =
                                             
                                                ∏
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                ∏
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             
                                                
                                                   (
                                                   
                                                      
                                                         ρ
                                                         
                                                            j
                                                            k
                                                         
                                                      
                                                      
                                                         
                                                            ∑
                                                            
                                                               c
                                                               =
                                                               1
                                                            
                                                            K
                                                         
                                                         
                                                            ρ
                                                            
                                                               j
                                                               c
                                                            
                                                         
                                                      
                                                   
                                                   )
                                                
                                                
                                                   z
                                                   
                                                      j
                                                      k
                                                   
                                                
                                             
                                             =
                                             
                                                ∏
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                ∏
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             
                                                
                                                   (
                                                   
                                                      γ
                                                      
                                                         j
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   z
                                                   
                                                      j
                                                      k
                                                   
                                                
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The quantity log ρjk
                         can be computed from (24) to give

                           
                              (27)
                              
                                 
                                    
                                       
                                          
                                             log
                                             
                                                ρ
                                                
                                                   j
                                                   k
                                                
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             log
                                             
                                                π
                                                
                                                   j
                                                   k
                                                
                                             
                                             
                                                (
                                                φ
                                                
                                                   (
                                                   
                                                      Θ
                                                      α
                                                   
                                                   )
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             −
                                             
                                                D
                                                2
                                             
                                             log
                                             
                                                (
                                                2
                                                π
                                                )
                                             
                                             +
                                             
                                                1
                                                2
                                             
                                             
                                                E
                                                
                                                   
                                                      Σ
                                                   
                                                   k
                                                
                                             
                                             
                                                [
                                                
                                                   log
                                                   |
                                                
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            Σ
                                                         
                                                         k
                                                      
                                                      )
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   |
                                                
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             −
                                             
                                                1
                                                2
                                             
                                             
                                                E
                                                
                                                   
                                                      
                                                         μ
                                                      
                                                      k
                                                   
                                                   ,
                                                   
                                                      
                                                         Σ
                                                      
                                                      k
                                                   
                                                
                                             
                                             
                                                [
                                                
                                                   
                                                      (
                                                      
                                                         B
                                                         j
                                                      
                                                      
                                                         x
                                                         j
                                                      
                                                      −
                                                      
                                                         
                                                            μ
                                                         
                                                         k
                                                      
                                                      )
                                                   
                                                   T
                                                
                                                
                                                   
                                                      Σ
                                                   
                                                   k
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   (
                                                   
                                                      B
                                                      j
                                                   
                                                   
                                                      x
                                                      j
                                                   
                                                   −
                                                   
                                                      
                                                         μ
                                                      
                                                      k
                                                   
                                                   )
                                                
                                                ]
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The expectations that appear in (27) have to be computed with respect to the current estimates of the variational posterior distributions over 
                           
                              
                                 {
                                 
                                    
                                       μ
                                    
                                    k
                                 
                                 }
                              
                              
                                 k
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 K
                              
                           
                         and 
                           
                              
                                 {
                                 
                                    
                                       Σ
                                    
                                    k
                                 
                                 }
                              
                              
                                 k
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 K
                              
                           
                         (Appendix A).

The terms {γjk
                        } which are computed during the VE-step are equal to the expectations of the latent variables with respect to their posterior variational distribution (responsibilities) (Bishop et al., 2006). They can be used to compute the following sufficient statistics of the observed data, which will serve to update the posterior distributions of 
                           
                              
                                 {
                                 
                                    
                                       μ
                                    
                                    k
                                 
                                 }
                              
                              
                                 k
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 K
                              
                           
                         and 
                           
                              
                                 
                                    {
                                    
                                       
                                          Σ
                                       
                                       k
                                    
                                    }
                                 
                                 
                                    k
                                    =
                                    1
                                    ,
                                    …
                                    ,
                                    K
                                 
                              
                              ,
                           
                         during the VM-step

                           
                              (28)
                              
                                 
                                    
                                       
                                          
                                             s
                                             
                                                0
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             s
                                             
                                                1
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             S
                                             
                                                2
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                )
                                             
                                             
                                                
                                                   (
                                                   
                                                      B
                                                      j
                                                   
                                                   
                                                      x
                                                      j
                                                   
                                                   )
                                                
                                                T
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

It should be noted that the computational complexity of this VE-step is identical to that of the E-step in the standard EM algorithm.

In the following VM-step we can derive approximate solutions for the posterior distributions over the cluster means and covariance matrices (Bishop et al., 2006). Making again use of (9) we obtain

                           
                              (29)
                              
                                 
                                    
                                       
                                          
                                             q
                                             (
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             )
                                          
                                       
                                       
                                          ∝
                                       
                                       
                                          
                                             exp
                                             {
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             log
                                             N
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                |
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                ,
                                                
                                                   
                                                      Σ
                                                   
                                                   k
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             log
                                             p
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             }
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

It can be proved (Appendix B) that the posterior distributions on the means and covariances of the different Gaussians take the same form as the corresponding priors (Bishop et al., 2006), that is

                           
                              (30)
                              
                                 
                                    
                                       
                                          
                                             q
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             =
                                             
                                                ∏
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             q
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                |
                                                
                                                   
                                                      Σ
                                                   
                                                   
                                                      k
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                )
                                             
                                             q
                                             
                                                (
                                                
                                                   
                                                      Σ
                                                   
                                                   
                                                      i
                                                      k
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                )
                                             
                                             
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        with

                           
                              (31)
                              
                                 
                                    
                                       
                                          
                                             q
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                       
                                       
                                          
                                             =
                                             N
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                m
                                                k
                                             
                                             ,
                                             
                                                b
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                             
                                             )
                                             
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (32)
                              
                                 
                                    
                                       
                                          
                                             q
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                       
                                       
                                          
                                             =
                                             W
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                             
                                                W
                                                k
                                             
                                             ,
                                             
                                                ν
                                                k
                                             
                                             )
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The parameters that govern these posterior distributions

                           
                              (33)
                              
                                 
                                    Φ
                                    =
                                    {
                                    
                                       
                                          
                                             β
                                             k
                                          
                                          ,
                                          
                                             m
                                             k
                                          
                                          ,
                                          
                                             ν
                                             k
                                          
                                          ,
                                          
                                             W
                                             k
                                          
                                          
                                             }
                                          
                                       
                                       
                                          k
                                          =
                                          1
                                          ,
                                          …
                                          ,
                                          K
                                       
                                    
                                    
                                    ,
                                 
                              
                           
                        can be computed as a function of the prior hyperparameters and the sufficient statistics obtained in the previous VE-step, as follows (Appendix B)

                           
                              (34)
                              
                                 
                                    
                                       
                                          
                                             b
                                             k
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                b
                                                
                                                   0
                                                   k
                                                
                                             
                                             +
                                             
                                                s
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             m
                                             k
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         1
                                                         k
                                                      
                                                   
                                                
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                             
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             W
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                W
                                                
                                                   0
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             +
                                             
                                                S
                                                
                                                   2
                                                   k
                                                
                                             
                                             +
                                             
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                      T
                                                   
                                                
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                             
                                             −
                                             
                                                
                                                   
                                                      s
                                                      
                                                         1
                                                         k
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         1
                                                         k
                                                      
                                                      T
                                                   
                                                
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             −
                                             
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         1
                                                         k
                                                      
                                                   
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                      T
                                                   
                                                
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                             
                                             −
                                             
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         1
                                                         k
                                                      
                                                      T
                                                   
                                                
                                                
                                                   
                                                      b
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                             
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             ν
                                             k
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             +
                                             
                                                s
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The point estimates of the mixing proportions 
                           
                              
                                 {
                                 
                                    g
                                    k
                                 
                                 }
                              
                              
                                 k
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 K
                              
                           
                         within each tissue type can instead be updated by

                           
                              (35)
                              
                                 
                                    
                                       
                                          
                                             
                                                g
                                                k
                                             
                                             =
                                             
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   
                                                      ∑
                                                      
                                                         c
                                                         ∈
                                                         
                                                            C
                                                            t
                                                         
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         0
                                                         c
                                                      
                                                   
                                                
                                             
                                             
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        while for the tissue weights 
                           
                              
                                 {
                                 
                                    w
                                    t
                                 
                                 }
                              
                              
                                 t
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 T
                              
                           
                         we obtain the following

                           
                              (36)
                              
                                 
                                    
                                       
                                          
                                             
                                                w
                                                t
                                             
                                             =
                                             
                                                
                                                   
                                                      ∑
                                                      
                                                         k
                                                         ∈
                                                         
                                                            C
                                                            t
                                                         
                                                      
                                                   
                                                   
                                                      s
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         ∑
                                                         
                                                            j
                                                            =
                                                            1
                                                         
                                                         N
                                                      
                                                      
                                                         
                                                            
                                                               
                                                                  τ
                                                                  
                                                                     j
                                                                     t
                                                                  
                                                               
                                                               
                                                                  (
                                                                  φ
                                                                  
                                                                     (
                                                                     
                                                                        Θ
                                                                        α
                                                                     
                                                                     )
                                                                  
                                                                  )
                                                               
                                                            
                                                            
                                                               
                                                                  ∑
                                                                  
                                                                     
                                                                        t
                                                                        ′
                                                                     
                                                                     =
                                                                     1
                                                                  
                                                                  T
                                                               
                                                               
                                                                  τ
                                                                  
                                                                     j
                                                                     
                                                                        t
                                                                        ′
                                                                     
                                                                  
                                                               
                                                               
                                                                  (
                                                                  φ
                                                                  
                                                                     (
                                                                     
                                                                        Θ
                                                                        α
                                                                     
                                                                     )
                                                                  
                                                                  )
                                                               
                                                               
                                                                  w
                                                                  
                                                                     t
                                                                     ′
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

A brief discussion on how to solve the bias and deformation optimisation problems is provided in Appendix C and Appendix D.

The hyperparameters Φ
                        0 reflect prior beliefs on how signal intensities should be distributed within each tissue type. With a Gaussian–Wishart parameterisation, the following hyperparameter setting ensures minimally informative and non improper priors

                           
                              (37)
                              
                                 
                                    
                                       β
                                       
                                          0
                                          k
                                       
                                    
                                    ≃
                                    0
                                    ∧
                                    
                                       ν
                                       
                                          0
                                          k
                                       
                                    
                                    ≃
                                    D
                                    −
                                    1
                                    ⇒
                                    p
                                    
                                       (
                                       
                                          
                                             μ
                                          
                                          k
                                       
                                       ,
                                       
                                          
                                             Σ
                                          
                                          k
                                       
                                       )
                                    
                                    ≃
                                    const
                                    
                                    .
                                 
                              
                           
                        With such a choice, the posterior distributions of the Gaussian parameters would be essentially determined by fitting the data, in a similar way to the maximum likelihood framework, and the regularisation term of the lower bound would reduce to the entropy of the posterior distributions.

On the contrary, choosing more informative priors can potentially increase the robustness of the algorithm by enforcing meaningfulness and plausibility of the estimated posteriors and, at the same time, ensure faster convergence. However, defining pertinent priors is a non trivial problem, as ideally such priors should express information derived from previously acquired data, rather than simple subjective beliefs. Therefore an appropriate hyperparameter configuration should be learned from large population data. Essentially, informative empirical priors should allow transferring the posterior information inferred from a training data set onto new unseen testing data (Lawrence and Platt, 2004; Raina et al., 2006; Seeger, 2002).

Interestingly, the model described so far can be further extended to represent a data set comprising scans of different subjects and, therefore, it provides a natural framework for estimating empirical priors. In fact, a lower bound on the marginal likelihood can be expressed, for a population of M subjects, as follows

                           
                              (38)
                              
                                 
                                    
                                       
                                          L
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                ∑
                                                Z
                                             
                                             
                                                
                                                
                                                   ∫
                                                
                                                
                                                   ∫
                                                
                                                
                                             
                                             
                                                q
                                                i
                                             
                                             
                                                (
                                                
                                                   Z
                                                   i
                                                
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             ×
                                             log
                                             
                                                {
                                                
                                                   
                                                      
                                                         p
                                                         i
                                                      
                                                      
                                                         (
                                                         
                                                            X
                                                            i
                                                         
                                                         ,
                                                         
                                                            Z
                                                            i
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            μ
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            Σ
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            β
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            α
                                                         
                                                         |
                                                         
                                                            Θ
                                                            π
                                                         
                                                         )
                                                      
                                                   
                                                   
                                                      
                                                         q
                                                         i
                                                      
                                                      
                                                         (
                                                         
                                                            Z
                                                            i
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            μ
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            Σ
                                                         
                                                         )
                                                      
                                                   
                                                
                                                }
                                             
                                             d
                                             
                                                Θ
                                                μ
                                             
                                             d
                                             
                                                Θ
                                                Σ
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

Supposing that the posteriors 
                           
                              
                                 {
                                 
                                    q
                                    i
                                 
                                 
                                    (
                                    
                                       Θ
                                       μ
                                    
                                    ,
                                    
                                       Θ
                                       Σ
                                    
                                    )
                                 
                                 }
                              
                              
                                 i
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 M
                              
                           
                         have been estimated, Eq. (38) can be maximised with respect to p(Θμ, ΘΣ
                        ). Since we are assuming that the functional form of this distribution is parametric and known (Gaussian–Wishart), standard non-linear optimisation techniques can be exploited to find maximum likelihood estimates of the hyperparameters Φ
                        0.

Indeed, the lower bound in (38) can be expressed as a function of Φ
                        0
                        
                           
                              (39)
                              
                                 
                                    
                                       
                                          
                                             L
                                             (
                                             
                                                Φ
                                                0
                                             
                                             )
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                m
                                             
                                             ∫
                                             ∫
                                             
                                                q
                                                i
                                             
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             log
                                             p
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             
                                             d
                                             
                                                Θ
                                                μ
                                             
                                             d
                                             
                                                Θ
                                                Σ
                                             
                                             +
                                             const
                                          
                                       
                                    
                                    
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                1
                                                2
                                             
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             {
                                             E
                                             
                                                [
                                                
                                                   log
                                                   |
                                                
                                                
                                                   
                                                      Σ
                                                   
                                                   
                                                      i
                                                      k
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   |
                                                
                                                ]
                                             
                                             
                                                (
                                                
                                                   ν
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                −
                                                D
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             −
                                             
                                                ν
                                                k
                                             
                                             T
                                             r
                                             
                                                (
                                                
                                                   W
                                                   
                                                      0
                                                      k
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   W
                                                   
                                                      i
                                                      k
                                                   
                                                
                                                +
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   (
                                                   
                                                      m
                                                      
                                                         i
                                                         k
                                                      
                                                   
                                                   −
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   
                                                      (
                                                      
                                                         m
                                                         
                                                            i
                                                            k
                                                         
                                                      
                                                      −
                                                      
                                                         m
                                                         
                                                            0
                                                            k
                                                         
                                                      
                                                      )
                                                   
                                                   T
                                                
                                                
                                                   W
                                                   k
                                                
                                                )
                                             
                                             }
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                                M
                                                2
                                             
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             D
                                             log
                                             
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   2
                                                   π
                                                
                                             
                                             −
                                             D
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   β
                                                   
                                                      i
                                                      k
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             2
                                             M
                                             
                                                ∑
                                                
                                                   k
                                                   =
                                                   1
                                                
                                                K
                                             
                                             log
                                             
                                                B
                                                W
                                             
                                             
                                                (
                                                
                                                   W
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                ,
                                                
                                                   ν
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             +
                                             const
                                             
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        where BW
                         indicates the normalizing constant of the Wishart distribution.

We also derived the first and second derivatives of 
                           
                              L
                              (
                              
                                 Φ
                                 0
                              
                              )
                              ,
                           
                         which are useful to solve this optimisation problem using gradient based techniques. Such derivatives are reported in Appendix F.

In summary, a convenient strategy for learning Gaussian mixture priors consists in, first, initializing the hyperparameters so as to obtain weak priors, secondly, estimating the posterior distributions for a population of M subjects, finally, optimizing 
                           L
                         with respect to Φ
                        0. The estimates of the hyperparameters (Φ
                        0) can then be further refined by using these empirical priors to reestimate the posteriors and so on, thus leading to an iterative learning scheme.

@&#EXPERIMENTAL RESULTS@&#

In this section we present a series of experiments that were performed to assess the validity of our approach and to explore some of its properties and potential applications. The results presented in 5.1 were produced making use of synthetic data while the ones described in 5.2 were obtained on real, publicly available, MRI data.

The performance of our variational algorithm was first evaluated making use of simulated data produced by the Brainweb MRI simulator (Cocosco et al., 1997; Collins et al., 1998; Kwan et al., 1999).

To assess the accuracy of brain tissue classification performed by our method we employed twenty synthetic T1-weighted scans of healthy adult subjects (Aubert-Broche et al., 2006). The volumes were generated with the following MR simulation parameters: Spoiled Fast Low Angle Shot (SFLASH) sequence with repetition time (TR) of 22 ms, echo time (TE) of 9.2 ms, flip angle=30° and 1 mm isotropic voxel size.

We segmented these images using the algorithm presented in the previous section. We set the following hyperparameters values so as to obtain weakly informative intensity priors (WIP). This choice in fact permits quantifying the accuracy of our method in the most general case that no reliable information is available on the distribution of tissue intensities.

                           
                              (40)
                              
                                 
                                    
                                       
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             0.1
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             m
                                             
                                                0
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                1
                                                N
                                             
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                x
                                                j
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             D
                                             −
                                             0.9
                                             ,
                                          
                                       
                                    
                                    
                                       
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                1
                                                N
                                             
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                (
                                                
                                                   x
                                                   j
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             
                                                
                                                   (
                                                   
                                                      x
                                                      j
                                                   
                                                   −
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                T
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The resulting segmentations were compared to the anatomical models used to generate the data by computing Dice similarity coefficients (DSC). Results, which are reported in Fig. 2
                        , indicate that our method can segment gray and white matter with an accuracy that is at least equal to that of some widely used, state-of the-art segmentation tools, such as the ones provided with SPM (Ashburner and Friston, 2005), FSL (Zhang et al., 2001) and Freesurfer (Fischl et al., 2004), whose performance was assessed in Klauschen et al. (2009).

The Brainweb database also provides multimodality data, even if, in this case, only one anatomical model is available. We made use of these synthetic scans to test the performance of our algorithm in segmenting multispectral data. Specifically we simulated T1-weighted and T2-weighted volumes, with the pulse sequence parameters reported in Table 1
                         and then segmented the data with the same hyperparameter setting used for the previous experiment.

To examine the behaviour of the algorithm with respect to noise, we repeated the analyses for three different levels of noise in the data (3%, 5% and 9% of the brightest intensity).

Results are summarised in Table 2
                        . They clearly indicate that our method can successfully handle multimodality data sets and that, even if the use of a single modality (in this case T1-weighted) already ensures very accurate segmentations, the availability of scans with different contrast can provide additional robustness to noise.

A similar behaviour is exhibited by the ML algorithm provided with the SPM software (Table 2). However, by comparing the accuracy achieved by the two methods, we find that the variational implementation provides significantly better results.

With this simulated data we could also assess the validity of bias field correction performed by our method. To do so we computed Pearson’s correlation coefficients between the estimated non-uniformity fields and the ground truth. Results are shown in Table 3
                        , where we report as well the correlation coefficients achieved by SPM ML based segmentation algorithm. As to be expected the two methods perform quite similarly in estimating the non-uniformity field. In fact, they rely on the same parameterisation and optimisation of the bias. Nevertheless, because the accuracy in correcting intensity inhomogeneities depends heavily on how reliable the estimates of the Gaussian parameters are, our algorithm, which takes into account the posterior uncertainty of such estimates, can outperform the maximum likelihood implementation when noise in the data increases.

With our method, run time for each individual segmentation was approximately 3 min 30 s, on a Quad-Core PC at 3.19 GHz with 12 GB RAM.

Among the advantages of the variational framework that we present here is the fact that it allows incorporating priors on the parameters modelling the intensity distributions of brain (and potentially non brain) tissues. This form of a priori knowledge acts conjointly with the shape information carried by the tissue probability maps, thus ensuring additional robustness. The use of different intensity priors leads to differences in the estimated posteriors and segmentations, in the sense that the algorithm tries to simultaneously maximise the model fit (i.e. the likelihood of the data) while minimizing the divergence between the prior and posterior probability distributions.

Determining suitable priors for each application, or imaging modality, is a fundamental question. However, it should also be noted that the need to define priors does not limit the applicability of the method if compared to standard maximum likelihood techniques. In fact, whenever no information is available on what priors it is most convenient or correct to use, it is always possible to resort to minimally informative priors, which would simply let the algorithm determine the posterior distributions that explain the data best, given the assumption that all parameter settings within the admissible parameter space are equally (or almost equally) probable a priori.

As explained in Section 4.3 the variational framework presented in this paper can be exploited to learn empirical priors over the Gaussian mixture parameters from large population data. To demonstrate the efficacy of this procedure we used the same set of simulated T1-weighted scans employed for the previous experiments. We learned priors over the intensities of gray and white matter by first collecting the posterior probability distributions for all the subjects in the data set and then maximizing the functional in (39) with respect to Φ
                           0. This optimisation problem was solved making use of a Gauss-Newton scheme. In particular we iterated over optimizing the priors and updating the posteriors so as reduce the chance of finding suboptimal solutions.

Results are depicted in Fig. 3
                           . We report the estimated Gaussian priors over the mean intensity of gray (3 a) and white (3 b) matter. These should be compared to the modes of the corresponding posteriors (red crosses).

Our empirical Bayes learning scheme captures very precisely the information encoded in the variational posteriors. In particular the more the posteriors are peaked and the more they overlap, the more the priors will be informative. If one or more posteriors have relatively high variance, this uncertainty will be immediately reflected in the empirical priors, which will become less informative. In the case of the synthetic data set used for this experiment, all the volumes have the same contrast and intensity mapping, therefore the resulting priors are highly informative.

The true means (blue crosses) are also shown in Fig. 3. For white matter, they are extremely consistent with the estimated posterior means. In fact, for this data set, our algorithm exhibits higher accuracy in segmenting white matter than gray matter (see Fig. 2). A slightly higher discrepancy emerges between the true and estimated gray matter mean intensities, which also explains the relatively lower accuracy in classifying gray matter.

Atlas based segmentation methods rely heavily on the accuracy in estimating the deformations mapping from the atlas to the individual volumes. Solving the segmentation and registration problems within a single modelling and computational framework has been widely accepted as a powerful and effective strategy in order to assure the success of both processing tasks, additionally to being a theoretically principled approach (Ashburner and Friston, 2005; DAgostino et al., 2006; Pohl et al., 2006; Xiaohua et al., 2004; Yezzi et al., 2001). Nonetheless, it is possible to encounter cases in which aligning the template to an individual scan turns out to be particularly difficult, due for example to a poor initialisation of the deformations or to the presence of anatomical features (especially pathological ones) that the atlas does not capture correctly. In such cases segmentation accuracy can be strongly affected by misregistration errors.

Introducing priors over the intensity distribution parameters is a convenient and reliable solution to cope with these difficulties. In fact, it can help to prevent implausible parameter estimates, whenever registration errors are misleading the model fitting process.

To demonstrate this property, the synthetic data set consisting of twenty T1-weighted scans was split into a training and a testing subset, of ten volumes each. The first ten images were processed by our variational algorithm to learn population representative intensity priors, as explained in 5.1.1. Secondly, the remaining test images were segmented making use of these priors, while registration failure was simulated by imposing a 7.5 mm shift of the atlas from its optimal alignment position in each of the three spatial directions (Fig. 4
                           ).

The accuracy of the resulting segmentations was finally assessed by computing Dice overlap coefficients. Results are illustrated in Fig. 5
                           . Here the performance of the presented method, used in combination with the empirical priors, is compared to that of the same algorithm with uninformative priors, as well as to that of a maximum likelihood method (implemented in SPM12).

As to be expected the maximum likelihood method and the variational method with uninformative priors do not perform very differently, except for the fact that the ML algorithm shows higher variance in the results. On the contrary, when using the priors learned from the training data, the accuracy in segmenting gray and white matter increases significantly, with a relatively low variance of the overlap measures. This confirms that Bayesian inference can augment the robustness of standard maximum likelihood algorithms, while providing a general and flexible framework that can be applied to many real world problems, by learning appropriate priors from available data.

As an additional proof of validity, we implemented an atlas free version of the algorithm presented in this paper, which we tested on the same synthetic data. We do not expect this purely intensity based framework to achieve segmentation accuracy and reliability comparable to that of the full, atlas driven method. However by showing that, even in the absence of tissue probability maps, we obtain fairly accurate segmentations (Fig. 6
                           ) we demonstrate again the soundness of the algorithm presented in this paper.

The previous experiments, performed on simulated data, have demonstrated and quantified the accuracy of the presented method in segmenting brain tissues from MRI volumes. In fact, due to the availability the underlying ground truth, working with synthetic data is especially convenient for the objective testing of new techniques and for the comparison of their performance to that of the methods that have become established as current state-of-the-art.

Nonetheless, simulated data is intrinsically less complex than the data encoded in any real scan, from a biological point of view, as well as in terms of signal and noise properties. For this reason it is quite important to asses the behaviour of image processing tools also on real data.

In this section we present a series of experiments that we performed on real MRI data from two publicly available data sets: the OASIS (Open Access Series of Imaging Studies) (Marcus et al., 2007) and the IXI (Information eXtraction from Images) databases. Such experiments provide evidence regarding the accuracy of our method for segmenting brain tissues and illustrate some of its distinctive properties, which derive from adopting a variational inference scheme.

To assess the performance of our segmentation algorithm we used data from the cross-sectional OASIS database (http://www.oasis-brains.org), which includes T1-weighted scans of young, middle aged, nondemented and demented older adults, all acquired in one site with the same scanning protocol. Manual labels for a subset of this data set (35 subjects) are provided by Neuromorphometrics, Inc. (http://Neuromorphometrics.com) under academic subscription, thus allowing quantitative evaluation of image segmentation tools.

We processed this data with our segmentation algorithm and compared its performance to that of the SPM software.

In Fig. 7
                            we summarise the distributions of Dice coefficients for gray and white matter, which were obtained by comparing the manual labels with the segmentations produced by our VB method using minimally informative priors and by SPM ML algorithm.

For both tissue types we observe a statistically significant increase in segmentation accuracy, when we use our variational algorithm, compared to the maximum likelihood implementation.

As to be expected, the Dice scores are generally lower, compared to the experiments performed on synthetic data. This is due to the more complex nature of real MRI signals. Additionally, the subset of the OASIS database that was used for this experiment comprises few scans of elderly subjects with severe atrophy and abnormal signal intensities, which explains the presence of negative outliers in the distribution of accuracy scores.

We performed additional validation experiments using the freely available IXI brain database (http://www.ixi.org.uk), which, as opposed to the OASIS data sets, includes multiple modalities, in particular T1-, T2- and PD-weighted images of healthy adult subjects, acquired in three different sites, with different scanning systems. Ground truth segmentations are not available for such a data set. However, in this case, as opposed to the experiments performed on the OASIS data, our aim is to illustrate some of the properties and advantages of our method, rather than providing explicit accuracy measures.

One of the most significant advantages of variational inference over maximum likelihood estimation is its intrinsic capability of containing overfitting (Attias, 1999; Bishop et al., 2006). In the case of mixture models this allows, for instance, determining the optimal number of components (K) without performing cross-validation, which is usually rather demanding for the amount of computations and data that it requires (Bishop et al., 2006).

Indeed, the question of selecting model’s complexity has often been overlooked in the framework of medical image segmentation: throughout the literature, the most common way of handling the choice on the number of classes, is to manually tune K, based on visual inspection of the segmentations and/or intensity histograms. Clearly, this is too arbitrary and subjective for even being considered as a model selection strategy.

Instead, our method implements an implicit automated relevance determination scheme, where, if the number of Gaussians is set to a value that is higher than the optimal one, the redundant components will be automatically pruned out of the model (Corduneanu and Bishop, 2001; Tzikas et al., 2008), as their responsibilities γjk
                            are quickly driven to zero by the algorithm. This follows from adopting a variational lower bound to approximate the marginal likelihood, which causes overly complex models (that is to say models with additional clusters that do not significantly help to explain the observed data) to be implicitly penalised (Attias, 1999). A similar behaviour is inherently impossible to reproduce within model fitting strategies that do not take into account estimation uncertainty, such as the maximum likelihood framework.

To illustrate this property of our algorithm we use the images of one of the subjects included in the IXI database.

In particular, we processed the data illustrated in Fig. 8
                           a, 8(band 8 c with our method, after having set 5 Gaussians for each of the tissue types of interest. At convergence of the VBEM algorithm, we observed only two components surviving for gray matter, one for white matter, three for CSF, two for bone and four for soft tissues, as shown in Fig. 9
                           . The plots reported in Fig. 10
                            illustrate how the posterior densities over the means of white matter evolve during model learning and, in particular, how four irrelevant components are reverted to their prior distributions, which in this case are uninformative. In a similar setting a ML or MAP algorithm would have simply found the best fit to the data, making use of all the available components, but the optimal number of Gaussians would have had to be determined a priori, through some form of model comparison.

One of the difficulties of working with MRI data is the lack of a standardised intensity scale (Nyúl et al., 2000). With respect to our work, this makes it difficult to define, or learn, intensity priors that can effectively generalise to unseen data. Indeed, even for images of a single data set (comprising volumes acquired with the same scanner and protocol) the distribution of intensities across subjects might be poorly consistent.

Unsurprisingly, when we tried to learn intensity priors using real data from the IXI database, we were directly confronted with the problem of normalizing MR signal intensities. Initially we randomly selected 50 T1-weighted scans acquired in the same site and with the same scanner. We processed such data with our variational algorithm and made use of the resulting posterior distributions to estimate intensity priors as described in 4.3. Results are reported in Fig. 11
                           , where we illustrate the collection of individual posteriors over the means of gray (a) and white (b) matter, together with the resulting empirical priors (black curves).

It is easy to observe how, for this non-quantitative data, the empirical priors turn out to be weakly informative. In fact, they properly reflect the uncertainty due to the variability of the intensity scales. The situation would have been even worse if we had selected volumes acquired with different scanners.

Nonetheless, our generative model can also be exploited to address the problems associated with the non-standardised nature of MRI signals. In particular we can introduce a linear global scaling parameter of the intensities, which can be optimised in the same learning scheme presented in this paper.

We can formulate this as a maximisation problem, where our aim is to maximise the following term (
                              
                                 L
                                 2
                              
                           ) contributing to the lower bound

                              
                                 (41)
                                 
                                    
                                       
                                          
                                             
                                                L
                                                2
                                             
                                          
                                          
                                             =
                                          
                                          
                                             
                                                
                                                   
                                                   
                                                      ∫
                                                   
                                                   
                                                      ∫
                                                   
                                                   
                                                
                                                q
                                                
                                                   (
                                                   
                                                      Θ
                                                      μ
                                                   
                                                   ,
                                                   
                                                      Θ
                                                      Σ
                                                   
                                                   |
                                                   
                                                      Θ
                                                      
                                                         g
                                                         s
                                                      
                                                   
                                                   )
                                                
                                                log
                                                
                                                   {
                                                   
                                                      
                                                         p
                                                         (
                                                         
                                                            Θ
                                                            μ
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            Σ
                                                         
                                                         )
                                                      
                                                      
                                                         q
                                                         (
                                                         
                                                            Θ
                                                            μ
                                                         
                                                         ,
                                                         
                                                            Θ
                                                            Σ
                                                         
                                                         |
                                                         
                                                            Θ
                                                            
                                                               g
                                                               s
                                                            
                                                         
                                                         )
                                                      
                                                   
                                                   }
                                                
                                                d
                                                
                                                   Θ
                                                   μ
                                                
                                                d
                                                
                                                   Θ
                                                   μ
                                                
                                             
                                          
                                       
                                       
                                          
                                          
                                             =
                                          
                                          
                                             
                                                −
                                                
                                                   D
                                                   
                                                      K
                                                      L
                                                   
                                                
                                                
                                                   (
                                                   q
                                                   
                                                      (
                                                      
                                                         Θ
                                                         μ
                                                      
                                                      ,
                                                      
                                                         Θ
                                                         Σ
                                                      
                                                      |
                                                      
                                                         Θ
                                                         
                                                            g
                                                            s
                                                         
                                                      
                                                      )
                                                   
                                                   ∥
                                                   p
                                                   
                                                      (
                                                      
                                                         Θ
                                                         μ
                                                      
                                                      ,
                                                      
                                                         Θ
                                                         Σ
                                                      
                                                      )
                                                   
                                                   )
                                                
                                                
                                                ,
                                             
                                          
                                       
                                    
                                 
                              
                           which corresponds to minimizing the KL divergence between the intensity priors and the approximating posteriors. The problem can be solved using non linear, gradient based optimisation techniques, by computing the first and second derivatives of 
                              
                                 
                                    L
                                    2
                                 
                                 
                                    (
                                    
                                       Θ
                                       
                                          g
                                          s
                                       
                                    
                                    )
                                 
                              
                            with respect to the global scaling parameters Θgs
                           . If we iterate over updating the empirical priors and estimating the scaling factors for the individual scans, we manage to learn informative intensity priors, as illustrated in Fig. 12
                           , while automatically compensating for the inconsistency of MRI signal intensities.

Naturally, such a procedure requires accurate estimates of the intensity distribution, bias and deformation parameters for each individual, that is to say, the problems of learning priors and estimating individual posteriors are inherently related in a circular manner. As a result, for particularly critical data sets, i.e. pathological data, which often exhibit larger anatomical variability, the Bayesian framework described in this manuscript might not be able to provide informative priors, due to the lack of a sufficient number of samples or to poor initial estimates of the model parameters. Nonetheless, in such cases, the presented computational framework, which represents a coherent generalisation of some state-of-the-art segmentation algorithms that rely on ML model fitting, could be applied with minimally informative intensity priors and yet it would outperform ML estimation (as indicated by the experiments that we performed on the OASIS data).

@&#DISCUSSION@&#

Evaluating posterior probability distributions over model parameters and latent variables is often a very demanding task in the context of probabilistic modelling problems, especially when working with large-scale data sets. Unfortunately this is usually the case for image processing applications.

In general, finding exact solutions involves the computation of integrals whose treatment in analytical form is very difficult or impossible, while numerical integration is often unfeasible too, due to the volume of data and the complexity of the equations to be solved (Bishop et al., 2006). In such circumstances, stochastic approximation techniques, like MCMC, have turned out to be impracticable, at least so far, since they require large computational resources, which makes the resulting algorithms rather slow for dealing with real life applications.

Variational Bayes techniques instead formulate Bayesian inference as an optimisation problem, where the objective function is constructed to be a lower bound on the marginal likelihood. Despite not providing exact results, they allow learning of fully Bayesian models without the computational drawbacks of sampling techniques. The resulting algorithms have the interesting property of generalizing ML or MAP approaches, while automatically addressing the overfitting issues associated with ML estimation.

In this paper we have shown that VB represents a viable and effective framework for performing medical image segmentation, in spite of not having been exploited so far in such a field.

When tested on both synthetic and real data, the presented method provided very accurate results, at an equivalent computational cost compared to ML or MAP implementations. We also illustrated some of advantages deriving from adopting a fully Bayesian formulation, such as, the possibility of automatically determining optimal model complexity and performing model comparison by evaluating the model evidence. Finally we described an empirical Bayes learning scheme, that can serve to estimate informative intensity priors. Such priors can be used to ensure even greater robustness, for example in the presence of misalignment between the tissue probability maps and the individual scans, or whenever the available atlases are not best representative of the population of interest.

All of these properties can compensate for the corresponding limitations of standard maximum likelihood techniques, which are inherently prone to overfitting, inappropriate for comparing models and, in the context of atlas based image segmentation, highly sensitive to registration accuracy.

@&#ACKNOWLEDGMENTS@&#

Claudia Blaiotta is funded by a UCL Impact Studentship in partnership with Balgrist University Hospital, Zurich. The Wellcome Trust Centre for Neuroimaging is supported by core funding from the Wellcome Trust [grant number 091593/Z/10/Z].

The Gaussian–Wishart distribution is the conjugate prior of a multivariate D-dimensional normal distribution with unknown mean 
                        μ
                      and precision matrix 
                        Λ
                     . Its probability density function is

                        
                           (A.1)
                           
                              
                                 
                                    
                                       
                                          p
                                          (
                                          
                                             μ
                                          
                                          ,
                                          
                                             Λ
                                          
                                          |
                                          m
                                          ,
                                          β
                                          ,
                                          W
                                          ,
                                          ν
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          p
                                          (
                                          
                                             μ
                                          
                                          |
                                          
                                             Λ
                                          
                                          ,
                                          m
                                          ,
                                          β
                                          )
                                          p
                                          (
                                          
                                             Λ
                                          
                                          |
                                          W
                                          ,
                                          ν
                                          )
                                       
                                    
                                 
                                 
                                    
                                    
                                       =
                                    
                                    
                                       
                                          N
                                          (
                                          
                                             μ
                                          
                                          |
                                          m
                                          ,
                                          
                                             
                                                (
                                                β
                                                
                                                   Λ
                                                
                                                )
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                          W
                                          
                                             (
                                             
                                                Λ
                                             
                                             |
                                             W
                                             ,
                                             ν
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with

                        
                           (A.2)
                           
                              
                                 
                                    
                                       
                                          N
                                          
                                             (
                                             
                                                μ
                                             
                                             |
                                             m
                                             ,
                                             
                                                
                                                   (
                                                   β
                                                   
                                                      Λ
                                                   
                                                   )
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          =
                                          
                                             
                                                
                                                   |
                                                   β
                                                   
                                                      Λ
                                                   
                                                   |
                                                
                                                
                                                   1
                                                   /
                                                   2
                                                
                                             
                                             
                                                
                                                   (
                                                   2
                                                   π
                                                   )
                                                
                                                
                                                   D
                                                   /
                                                   2
                                                
                                             
                                          
                                          exp
                                          
                                             {
                                             −
                                             
                                                1
                                                2
                                             
                                             
                                                
                                                   (
                                                   
                                                      μ
                                                   
                                                   −
                                                   m
                                                   )
                                                
                                                T
                                             
                                             
                                                Λ
                                             
                                             
                                             
                                                (
                                                
                                                   μ
                                                
                                                −
                                                m
                                                )
                                             
                                             }
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     and

                        
                           (A.3)
                           
                              
                                 
                                    
                                       
                                          W
                                          
                                             (
                                             
                                                Λ
                                             
                                             |
                                             W
                                             ,
                                             ν
                                             )
                                          
                                          =
                                          
                                             B
                                             W
                                          
                                          
                                             (
                                             W
                                             ,
                                             ν
                                             )
                                          
                                          
                                             
                                                |
                                                
                                                   Λ
                                                
                                                |
                                             
                                             
                                                
                                                   ν
                                                   −
                                                   D
                                                   −
                                                   1
                                                
                                                2
                                             
                                          
                                          exp
                                          
                                             {
                                             −
                                             
                                                1
                                                2
                                             
                                             T
                                             r
                                             
                                                (
                                                
                                                   
                                                      W
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                
                                                   Λ
                                                
                                                )
                                             
                                             }
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     The normalizing constant BW
                      is given by

                        
                           (A.4)
                           
                              
                                 
                                    
                                       
                                          
                                             B
                                             W
                                          
                                          
                                             (
                                             W
                                             ,
                                             ν
                                             )
                                          
                                          =
                                          
                                             
                                                |
                                                W
                                                |
                                             
                                             
                                                −
                                                ν
                                                /
                                                2
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   2
                                                   
                                                      ν
                                                      D
                                                      /
                                                      2
                                                   
                                                
                                                
                                                   π
                                                   
                                                      D
                                                      (
                                                      D
                                                      −
                                                      1
                                                      )
                                                      /
                                                      4
                                                   
                                                
                                                
                                                   ∏
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   D
                                                
                                                Γ
                                                
                                                   (
                                                   
                                                      
                                                         ν
                                                         +
                                                         1
                                                         −
                                                         i
                                                      
                                                      2
                                                   
                                                   )
                                                
                                                )
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where Γ( · ) is the Gamma function

                        
                           (A.5)
                           
                              
                                 
                                    
                                       
                                          Γ
                                          
                                             (
                                             x
                                             )
                                          
                                          =
                                          
                                             ∫
                                             0
                                             ∞
                                          
                                          
                                             u
                                             
                                                x
                                                −
                                                1
                                             
                                          
                                          
                                             e
                                             
                                                −
                                                u
                                             
                                          
                                          d
                                          u
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

The expectation of the determinant of the precision matrix, which appears in Eq. (27) (VE-step), is equal to Bishop et al. (2006)
                     
                        
                           (A.6)
                           
                              
                                 
                                    
                                       
                                          E
                                          
                                             [
                                             log
                                             |
                                             
                                                Λ
                                             
                                             |
                                             ]
                                          
                                          =
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             D
                                          
                                          ψ
                                          
                                             (
                                             
                                                
                                                   ν
                                                   +
                                                   1
                                                   −
                                                   i
                                                
                                                2
                                             
                                             )
                                          
                                          +
                                          D
                                          log
                                          2
                                          +
                                          log
                                          
                                             |
                                             W
                                             |
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where ψ( · ) indicates the digamma function, which is the logarithmic derivative of the Gamma function

                        
                           (A.7)
                           
                              
                                 
                                    
                                       
                                          ψ
                                          
                                             (
                                             x
                                             )
                                          
                                          =
                                          
                                             d
                                             
                                                d
                                                x
                                             
                                          
                                          log
                                          Γ
                                          
                                             (
                                             x
                                             )
                                          
                                          =
                                          
                                             
                                                
                                                   Γ
                                                   ′
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                             
                                             
                                                Γ
                                                (
                                                x
                                                )
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     The following expectation has also to be computed during the VE-step

                        
                           (A.8)
                           
                              
                                 
                                    
                                       
                                          
                                             E
                                             
                                                
                                                   μ
                                                
                                                ,
                                                
                                                   Λ
                                                
                                             
                                          
                                          
                                             [
                                             
                                                
                                                   (
                                                   x
                                                   −
                                                   
                                                      μ
                                                   
                                                   )
                                                
                                                T
                                             
                                             
                                                Λ
                                             
                                             
                                             
                                                (
                                                x
                                                −
                                                
                                                   μ
                                                
                                                )
                                             
                                             ]
                                          
                                          =
                                          D
                                          
                                             β
                                             
                                                −
                                                1
                                             
                                          
                                          +
                                          ν
                                          
                                             
                                                (
                                                x
                                                −
                                                m
                                                )
                                             
                                             T
                                          
                                          
                                             W
                                          
                                          
                                             (
                                             x
                                             −
                                             m
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

From Eq. (29) we obtain

                        
                           (B.1)
                           
                              
                                 
                                    
                                       
                                          log
                                          q
                                          (
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          ,
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          +
                                          log
                                          N
                                          (
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          |
                                          
                                             m
                                             
                                                0
                                                k
                                             
                                          
                                          ,
                                          
                                             b
                                             
                                                0
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                          
                                          )
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          log
                                          W
                                          (
                                          
                                             
                                                Σ
                                             
                                             
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          |
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                          
                                          ,
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          )
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          N
                                          
                                             (
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             |
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             ,
                                             
                                                
                                                   Σ
                                                
                                                k
                                             
                                             )
                                          
                                          +
                                          const
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     which can be expanded as

                        
                           (B.2)
                           
                              
                                 
                                    
                                       
                                          log
                                          q
                                          (
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          ,
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          −
                                          
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             2
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             −
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                −
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             −
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          T
                                          r
                                          
                                             (
                                             
                                                
                                                   (
                                                   
                                                      
                                                         Σ
                                                      
                                                      k
                                                   
                                                   
                                                      W
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             1
                                             2
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             
                                                
                                                   ν
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                −
                                                D
                                                −
                                                1
                                             
                                             2
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

Let us first consider the terms containing 
                        μ
                     
                     
                        k
                     
                     
                        
                           (B.3)
                           
                              
                                 
                                    
                                       
                                          log
                                          q
                                          (
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          |
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                          −
                                          
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                
                                                   k
                                                
                                                T
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                −
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                )
                                             
                                             
                                             −
                                             
                                             
                                                
                                                   (
                                                   
                                                      B
                                                      j
                                                   
                                                   
                                                      x
                                                      j
                                                   
                                                   )
                                                
                                                T
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             2
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                
                                                   k
                                                
                                                T
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             −
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                                T
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

By rearranging and grouping terms we obtain

                        
                           (B.4)
                           
                              
                                 
                                    
                                       
                                          log
                                          q
                                          (
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          |
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          +
                                          
                                             
                                                μ
                                             
                                             
                                                k
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             +
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                          
                                             (
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             +
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   1
                                                
                                                N
                                             
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             )
                                          
                                          
                                          
                                             
                                                μ
                                             
                                             
                                                k
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             
                                                μ
                                             
                                             k
                                          
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

By completing the square we obtain

                        
                           (B.5)
                           
                              
                                 
                                    
                                       
                                          q
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          =
                                          N
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             |
                                             
                                                m
                                                k
                                             
                                             ,
                                             
                                                β
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                             
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with

                        
                           (B.6)
                           
                              
                                 
                                    
                                       
                                          
                                             β
                                             k
                                          
                                          =
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          +
                                          
                                             s
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     and

                        
                           (B.7)
                           
                              
                                 
                                    m
                                    k
                                 
                                 =
                                 
                                    
                                       
                                          b
                                          
                                             0
                                             k
                                          
                                       
                                       
                                          m
                                          
                                             0
                                             k
                                          
                                       
                                       +
                                       
                                          ∑
                                          
                                             j
                                             =
                                             1
                                          
                                          N
                                       
                                       
                                          γ
                                          
                                             j
                                             k
                                          
                                       
                                       
                                          B
                                          j
                                       
                                       
                                          x
                                          j
                                       
                                    
                                    
                                       
                                          b
                                          
                                             0
                                             k
                                          
                                       
                                       +
                                       
                                          s
                                          
                                             0
                                             k
                                          
                                       
                                    
                                 
                                 
                                 .
                              
                           
                        
                     
                  

The posterior 
                        
                           q
                           (
                           
                              
                                 Σ
                              
                              
                                 k
                              
                              
                                 −
                                 1
                              
                           
                           )
                        
                      can be computed by

                        
                           (B.8)
                           
                              
                                 log
                                 q
                                 
                                    (
                                    
                                       
                                          Σ
                                       
                                       k
                                       
                                          −
                                          1
                                       
                                    
                                    )
                                 
                                 =
                                 log
                                 q
                                 
                                    (
                                    
                                       
                                          μ
                                       
                                       k
                                    
                                    ,
                                    
                                       
                                          Σ
                                       
                                       k
                                       
                                          −
                                          1
                                       
                                    
                                    )
                                 
                                 −
                                 log
                                 q
                                 
                                    (
                                    
                                       
                                          μ
                                       
                                       k
                                    
                                    |
                                    
                                       
                                          Σ
                                       
                                       k
                                       
                                          −
                                          1
                                       
                                    
                                    )
                                 
                                 
                                 .
                              
                           
                        
                     
                  

Thus we obtain

                        
                           (B.9)
                           
                              
                                 
                                    
                                       
                                          log
                                          q
                                          (
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          −
                                          
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             2
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             −
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                −
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             −
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          T
                                          r
                                          
                                             (
                                             
                                                
                                                   (
                                                   
                                                      
                                                         Σ
                                                      
                                                      k
                                                   
                                                   
                                                      W
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          +
                                          
                                             
                                                
                                                   ν
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                −
                                                D
                                                −
                                                1
                                             
                                             2
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             
                                                β
                                                k
                                             
                                             2
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   k
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             
                                                Σ
                                             
                                             k
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             −
                                             
                                                m
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

Making use of the property 
                        
                           
                              
                                 u
                              
                              T
                           
                           A
                           u
                           =
                           T
                           r
                           
                              (
                              A
                              u
                              
                                 
                                    u
                                 
                                 T
                              
                              )
                           
                        
                      we can write

                        
                           (B.10)
                           
                              
                                 
                                    
                                       
                                          q
                                          (
                                          
                                             
                                                Σ
                                             
                                             
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             (
                                             
                                                γ
                                                
                                                   j
                                                   k
                                                
                                             
                                             +
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             −
                                             D
                                             −
                                             1
                                             )
                                          
                                          log
                                          
                                             |
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          T
                                          r
                                          {
                                          (
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          +
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             −
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             T
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             −
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             )
                                          
                                          
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                −
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                )
                                             
                                             T
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             β
                                             k
                                          
                                          
                                             (
                                             
                                                
                                                   μ
                                                
                                                k
                                             
                                             −
                                             
                                                m
                                                k
                                             
                                             )
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      μ
                                                   
                                                   k
                                                
                                                −
                                                
                                                   m
                                                   k
                                                
                                                )
                                             
                                             T
                                          
                                          )
                                          
                                             
                                                Σ
                                             
                                             
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          }
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

Substituting (B.6) and (B.7) into (B.10) we obtain

                        
                           (B.11)
                           
                              
                                 
                                    
                                       
                                          q
                                          
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             )
                                          
                                          =
                                          W
                                          
                                             (
                                             
                                                
                                                   Σ
                                                
                                                
                                                   k
                                                
                                                
                                                   −
                                                   1
                                                
                                             
                                             |
                                             
                                                W
                                                k
                                             
                                             ,
                                             
                                                ν
                                                k
                                             
                                             )
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where

                        
                           (B.12)
                           
                              
                                 
                                    
                                       
                                          
                                             ν
                                             k
                                          
                                          =
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          +
                                          
                                             s
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     and

                        
                           (B.13)
                           
                              
                                 
                                    
                                       
                                          W
                                          k
                                          
                                             −
                                             1
                                          
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          +
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                B
                                                j
                                             
                                             
                                                x
                                                j
                                             
                                             )
                                          
                                          
                                             
                                                (
                                                
                                                   B
                                                   j
                                                
                                                
                                                   x
                                                   j
                                                
                                                )
                                             
                                             T
                                          
                                          −
                                          
                                             
                                                
                                                   s
                                                   
                                                      1
                                                      k
                                                   
                                                
                                                
                                                   s
                                                   
                                                      1
                                                      k
                                                   
                                                   T
                                                
                                             
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                +
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                   T
                                                
                                             
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                +
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                             
                                          
                                          −
                                          
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   s
                                                   
                                                      1
                                                      k
                                                   
                                                
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                   T
                                                
                                             
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                +
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                             
                                          
                                          −
                                          
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   s
                                                   
                                                      1
                                                      k
                                                   
                                                   T
                                                
                                             
                                             
                                                
                                                   b
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                +
                                                
                                                   s
                                                   
                                                      0
                                                      k
                                                   
                                                
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

In order to estimate optimal parameters to represent the bias field we need, at each iteration of the algorithm, to maximise the lower bound (E.1) on the objective function with respect to the parameters Θβ
                     . A closed form solution does not exist in this case; therefore, recourse to numerical optimisation techniques cannot be avoided. The optimisation problem can be formulated as follows

                        
                           (C.1)
                           
                              
                                 
                                    
                                       
                                          
                                             Θ
                                             ^
                                          
                                          β
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          arg
                                          
                                             max
                                             
                                                Θ
                                                β
                                             
                                          
                                          
                                          {
                                          
                                             E
                                             
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             p
                                             (
                                             X
                                             |
                                             Z
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             ,
                                             
                                                Θ
                                                β
                                             
                                             )
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          log
                                          p
                                          (
                                          
                                             Θ
                                             β
                                          
                                          )
                                          }
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

A convenient and fast converging strategy to estimate the bias field, consists in adopting a Gauss–Newton iterative scheme. This involves computing the first and second derivatives of 
                        L
                      with respect to Θβ
                     . A very similar approach for finding MAP estimates of the bias field parameters has already been described in Ashburner and Friston (2005) for the same parameterisation of the non-uniformity field adopted in this work. Therefore, further details on how this optimisation problem can be solved are omitted.

The deformation field that best matches the population based atlas 
                        
                           
                              {
                              
                                 
                                    τ
                                 
                                 t
                              
                              }
                           
                           
                              t
                              =
                              1
                              ,
                              …
                              ,
                              T
                           
                        
                      to an individual image can be estimated by maximizing 
                        L
                      with respect to Θα
                     . This is equivalent to finding

                        
                           (D.1)
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                Θ
                                                ^
                                             
                                             α
                                          
                                          =
                                          arg
                                          
                                             max
                                             
                                                Θ
                                                α
                                             
                                          
                                          
                                          
                                             {
                                             
                                                E
                                                Z
                                             
                                             
                                                [
                                                log
                                                p
                                                (
                                                Z
                                                |
                                                
                                                   Θ
                                                   π
                                                
                                                ,
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                                ]
                                             
                                             +
                                             log
                                             p
                                             
                                                (
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                             
                                             }
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     Solutions can again be obtained making use of a Gauss–Newton scheme. This involves applying the following update rule

                        
                           (D.2)
                           
                              
                                 
                                    
                                       
                                          
                                             Θ
                                             
                                                α
                                             
                                             
                                                (
                                                n
                                                +
                                                1
                                                )
                                             
                                          
                                          =
                                          
                                             Θ
                                             
                                                α
                                             
                                             
                                                (
                                                n
                                                )
                                             
                                          
                                          −
                                          
                                             
                                                H
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          f
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where 
                        f
                      indicates the gradient and 
                        H
                      the Hessian of the objective function. Numerical techniques are required to solve the term 
                        
                           
                              
                                 H
                              
                              
                                 −
                                 1
                              
                           
                           f
                        
                      since a very local, and therefore highly dimensional, parameterisation of the deformations is adopted in this work. A very efficient strategy consist in using multigrid algorithms. In particular the method presented in this work employs a multigrid scheme with the same implementation described in Ashburner (2007).

The lower bound can be easily evaluated, once the sufficient statistics and the variational posterior distributions have been computed (Bishop et al., 2006), by

                        
                           (E.1)
                           
                              
                                 
                                    
                                       L
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             E
                                             
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             p
                                             
                                                (
                                                X
                                                |
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                ,
                                                
                                                   Θ
                                                   β
                                                
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             E
                                             Z
                                          
                                          
                                             [
                                             log
                                             p
                                             
                                                (
                                                Z
                                                |
                                                
                                                   Θ
                                                   π
                                                
                                                ,
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          
                                             E
                                             
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             p
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          log
                                          p
                                          
                                             (
                                             
                                                Θ
                                                α
                                             
                                             )
                                          
                                          +
                                          log
                                          p
                                          
                                             (
                                             
                                                Θ
                                                β
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             E
                                             Z
                                          
                                          
                                             [
                                             log
                                             q
                                             
                                                (
                                                Z
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             E
                                             
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             q
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             ]
                                          
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     with

                        
                           (E.2)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             E
                                             
                                                Z
                                                ,
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             p
                                             (
                                             X
                                             |
                                             Z
                                             ,
                                             
                                                Θ
                                                μ
                                             
                                             ,
                                             
                                                Θ
                                                Σ
                                             
                                             ,
                                             
                                                Θ
                                                β
                                             
                                             )
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          =
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             s
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          E
                                          
                                             [
                                             
                                                log
                                                |
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                |
                                             
                                             ]
                                          
                                          −
                                          D
                                          log
                                          
                                             (
                                             2
                                             π
                                             )
                                          
                                          −
                                          
                                             D
                                             
                                                β
                                                k
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             s
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             ν
                                             k
                                          
                                          
                                             m
                                             k
                                             T
                                          
                                          
                                             W
                                             k
                                          
                                          
                                             m
                                             k
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             ν
                                             k
                                          
                                          T
                                          r
                                          
                                             (
                                             
                                                W
                                                k
                                             
                                             
                                                S
                                                
                                                   2
                                                   k
                                                
                                             
                                             −
                                             2
                                             
                                                s
                                                
                                                   1
                                                   k
                                                
                                             
                                             
                                                m
                                                k
                                                T
                                             
                                             
                                                W
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          +
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          
                                             |
                                             
                                                B
                                                j
                                             
                                             |
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (E.3)
                           
                              
                                 
                                    
                                       
                                          
                                             E
                                             Z
                                          
                                          
                                             [
                                             log
                                             p
                                             
                                                (
                                                Z
                                                |
                                                
                                                   Θ
                                                   π
                                                
                                                ,
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                             
                                             ]
                                          
                                          =
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          
                                             π
                                             
                                                j
                                                k
                                             
                                          
                                          
                                             (
                                             φ
                                             
                                                (
                                                
                                                   Θ
                                                   α
                                                
                                                )
                                             
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (E.4)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             E
                                             
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             p
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          =
                                          +
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             {
                                             D
                                             log
                                             
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   2
                                                   π
                                                
                                             
                                             −
                                             D
                                             
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   β
                                                   k
                                                
                                             
                                             }
                                          
                                          +
                                          2
                                          K
                                          log
                                          
                                             B
                                             W
                                          
                                          
                                             (
                                             
                                                W
                                                
                                                   0
                                                   k
                                                
                                             
                                             ,
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          −
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          {
                                          
                                             
                                                ν
                                                k
                                             
                                             2
                                          
                                          T
                                          r
                                          
                                             (
                                             
                                                (
                                                
                                                   W
                                                   
                                                      0
                                                      k
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                                +
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   (
                                                   
                                                      m
                                                      k
                                                   
                                                   −
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                
                                                   
                                                      (
                                                      
                                                         m
                                                         k
                                                      
                                                      −
                                                      
                                                         m
                                                         
                                                            0
                                                            k
                                                         
                                                      
                                                      )
                                                   
                                                   T
                                                
                                                )
                                             
                                             
                                                W
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          +
                                          E
                                          
                                             [
                                             
                                                log
                                                |
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                |
                                             
                                             ]
                                          
                                          
                                             (
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             −
                                             D
                                             )
                                          
                                          }
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (E.5)
                           
                              
                                 
                                    
                                       
                                          
                                             E
                                             Z
                                          
                                          
                                             [
                                             log
                                             q
                                             
                                                (
                                                Z
                                                )
                                             
                                             ]
                                          
                                          =
                                          
                                             ∑
                                             
                                                j
                                                =
                                                1
                                             
                                             N
                                          
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          log
                                          
                                             γ
                                             
                                                j
                                                k
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (E.6)
                           
                              
                                 
                                    
                                    
                                    
                                       
                                          
                                             E
                                             
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                             
                                          
                                          
                                             [
                                             log
                                             q
                                             
                                                (
                                                
                                                   Θ
                                                   μ
                                                
                                                ,
                                                
                                                   Θ
                                                   Σ
                                                
                                                )
                                             
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          =
                                          
                                             ∑
                                             
                                                k
                                                =
                                                1
                                             
                                             K
                                          
                                          {
                                          
                                             1
                                             2
                                          
                                          D
                                          
                                             (
                                             log
                                             
                                                
                                                   β
                                                   k
                                                
                                                
                                                   2
                                                   π
                                                
                                             
                                             −
                                             1
                                             −
                                             
                                                ν
                                                k
                                             
                                             )
                                          
                                          +
                                          log
                                          
                                             B
                                             W
                                          
                                          
                                             (
                                             
                                                W
                                                k
                                             
                                             ,
                                             
                                                ν
                                                k
                                             
                                             )
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          
                                          
                                          +
                                          E
                                          
                                             [
                                             
                                                log
                                                |
                                             
                                             
                                                
                                                   Σ
                                                
                                                k
                                                
                                                   −
                                                   1
                                                
                                             
                                             
                                                |
                                             
                                             ]
                                          
                                          
                                             (
                                             
                                                1
                                                2
                                             
                                             
                                                ν
                                                k
                                             
                                             −
                                             D
                                             )
                                          
                                          }
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

The term BW
                     (
                        W
                     , ν) in Eqs. (E.4) and (E.6) indicates the normalizing constant for a Wishart distribution parametrised by 
                        W
                      and ν.

Given a data set of M individual scans, the lower bound on the marginal likelihood depends on the hyperparameters 
                        
                           
                              {
                              
                                 β
                                 
                                    0
                                    k
                                 
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              …
                              ,
                              K
                           
                        
                      as follows

                        
                           (F.1)
                           
                              
                                 
                                    
                                       
                                          L
                                          (
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             
                                                M
                                                D
                                             
                                             2
                                          
                                          log
                                          
                                             (
                                             
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                
                                                   2
                                                   π
                                                
                                             
                                             )
                                          
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          {
                                          D
                                          
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                                β
                                                
                                                   i
                                                   k
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   m
                                                   
                                                      i
                                                      k
                                                   
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             W
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             (
                                             
                                                m
                                                
                                                   i
                                                   k
                                                
                                             
                                             −
                                             
                                                m
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                          }
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          const
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     and the corresponding gradient and Hessian are given by

                        
                           (F.2)
                           
                              
                                 
                                    
                                       
                                          g
                                          β
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             
                                                M
                                                D
                                             
                                             
                                                β
                                                
                                                   0
                                                   k
                                                
                                             
                                          
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             {
                                             
                                                D
                                                
                                                   β
                                                   
                                                      i
                                                      k
                                                   
                                                
                                             
                                             −
                                             
                                                ν
                                                
                                                   i
                                                   k
                                                
                                             
                                             
                                                
                                                   (
                                                   
                                                      m
                                                      
                                                         i
                                                         k
                                                      
                                                   
                                                   −
                                                   
                                                      m
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   )
                                                
                                                T
                                             
                                             
                                                W
                                                
                                                   i
                                                   k
                                                
                                             
                                             
                                                (
                                                
                                                   m
                                                   
                                                      i
                                                      k
                                                   
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             }
                                          
                                          
                                          ,
                                       
                                    
                                 
                                 
                                    
                                       
                                          H
                                          β
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          −
                                          
                                             
                                                M
                                                D
                                             
                                             
                                                2
                                                
                                                   β
                                                   
                                                      0
                                                      k
                                                   
                                                   2
                                                
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

Similarly for 
                        
                           
                              {
                              
                                 m
                                 
                                    0
                                    k
                                 
                              
                              }
                           
                           
                              k
                              =
                              1
                              ,
                              …
                              ,
                              K
                           
                        
                      we find that 
                        
                           L
                           (
                           
                              m
                              
                                 0
                                 k
                              
                           
                           )
                        
                      can be expressed as

                        
                           (F.3)
                           
                              
                                 L
                                 
                                    (
                                    
                                       m
                                       
                                          o
                                          k
                                       
                                    
                                    )
                                 
                                 =
                                 
                                    1
                                    2
                                 
                                 
                                    ∑
                                    
                                       i
                                       =
                                       1
                                    
                                    M
                                 
                                 
                                    β
                                    
                                       0
                                       k
                                    
                                 
                                 
                                    ν
                                    
                                       i
                                       k
                                    
                                 
                                 
                                    
                                       (
                                       
                                          m
                                          
                                             i
                                             k
                                          
                                       
                                       −
                                       
                                          m
                                          
                                             0
                                             k
                                          
                                       
                                       )
                                    
                                    T
                                 
                                 
                                    W
                                    
                                       i
                                       k
                                    
                                 
                                 
                                    (
                                    
                                       m
                                       
                                          i
                                          k
                                       
                                    
                                    −
                                    
                                       m
                                       
                                          0
                                          k
                                       
                                    
                                    )
                                 
                                 +
                                 const
                                 
                                 .
                              
                           
                        
                     The first and second derivatives are instead

                        
                           (F.4)
                           
                              
                                 
                                    
                                       
                                          g
                                          m
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          −
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   m
                                                   
                                                      i
                                                      k
                                                   
                                                
                                                −
                                                
                                                   m
                                                   
                                                      0
                                                      k
                                                   
                                                
                                                )
                                             
                                             T
                                          
                                          
                                             W
                                             
                                                i
                                                k
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                                 
                                    
                                       
                                          H
                                          m
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             β
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             W
                                             
                                                i
                                                k
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

The following indicates the dependency of 
                        L
                      on the degrees of freedom of the Wishart priors

                        
                           (F.5)
                           
                              
                                 
                                    
                                       
                                          L
                                          (
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             
                                                ν
                                                
                                                   0
                                                   k
                                                
                                             
                                             2
                                          
                                          
                                             
                                             E
                                             [
                                             log
                                             |
                                          
                                          
                                             
                                                Σ
                                             
                                             
                                                i
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             |
                                             ]
                                             +
                                             M
                                             log
                                             |
                                          
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             
                                                |
                                             
                                             
                                                −
                                                
                                                   
                                                      ν
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   2
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          M
                                          log
                                          
                                             
                                                (
                                                
                                                   2
                                                   
                                                      
                                                         D
                                                         
                                                            ν
                                                            
                                                               0
                                                               k
                                                            
                                                         
                                                      
                                                      2
                                                   
                                                
                                                
                                                
                                                   π
                                                   
                                                      
                                                         D
                                                         (
                                                         D
                                                         −
                                                         1
                                                         )
                                                      
                                                      4
                                                   
                                                
                                                
                                                   ∏
                                                   
                                                      d
                                                      =
                                                      1
                                                   
                                                   D
                                                
                                                Γ
                                                
                                                   (
                                                   
                                                      
                                                         
                                                            ν
                                                            
                                                               0
                                                               k
                                                            
                                                         
                                                         +
                                                         1
                                                         −
                                                         d
                                                      
                                                      2
                                                   
                                                   )
                                                
                                                )
                                             
                                             
                                                −
                                                1
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          +
                                          const
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

In this case the gradient and Hessian can be computed by

                        
                           (F.6)
                           
                              
                                 
                                    
                                       
                                          g
                                          ν
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             E
                                             [
                                             log
                                             |
                                          
                                          
                                             
                                                Σ
                                             
                                             
                                                i
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             |
                                             ]
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             M
                                             2
                                          
                                          
                                             {
                                             
                                                log
                                                |
                                             
                                             
                                                W
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                                |
                                                +
                                                D
                                                log
                                                2
                                                +
                                             
                                             
                                                ∑
                                                
                                                   d
                                                   =
                                                   1
                                                
                                                D
                                             
                                             φ
                                             
                                                (
                                                
                                                   
                                                      
                                                         ν
                                                         
                                                            0
                                                            k
                                                         
                                                      
                                                      +
                                                      1
                                                      −
                                                      d
                                                   
                                                   2
                                                
                                                )
                                             
                                             }
                                          
                                          
                                          ,
                                       
                                    
                                 
                                 
                                    
                                       
                                          H
                                          ν
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          M
                                          
                                             φ
                                             1
                                          
                                          
                                             (
                                             
                                                
                                                   
                                                      ν
                                                      
                                                         0
                                                         k
                                                      
                                                   
                                                   +
                                                   1
                                                   −
                                                   d
                                                
                                                2
                                             
                                             )
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

Finally for the Wishart scale matrices we find that

                        
                           (F.7)
                           
                              
                                 
                                    
                                       
                                          L
                                          (
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                          
                                          )
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          M
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          log
                                          
                                             
                                                |
                                             
                                             
                                                C
                                                
                                                   0
                                                   k
                                                
                                             
                                             
                                                |
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                    
                                    
                                       
                                          −
                                          
                                             1
                                             2
                                          
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          T
                                          r
                                          
                                             (
                                             
                                                C
                                                
                                                   0
                                                   k
                                                
                                                T
                                             
                                             
                                                W
                                                
                                                   i
                                                   k
                                                
                                             
                                             
                                                C
                                                
                                                   0
                                                   k
                                                
                                             
                                             )
                                          
                                          +
                                          const
                                          
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where 
                        C
                     
                     0k
                      is the Cholesky factor of 
                        
                           W
                           
                              0
                              k
                           
                           
                              −
                              1
                           
                        
                     
                     
                        
                           (F.8)
                           
                              
                                 
                                    
                                       
                                          
                                             W
                                             
                                                0
                                                k
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          =
                                          
                                             C
                                             
                                                0
                                                k
                                             
                                          
                                          
                                             C
                                             
                                                0
                                                k
                                             
                                             T
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     The first and second derivatives are given by

                        
                           (F.9)
                           
                              
                                 
                                    
                                       
                                          g
                                          W
                                       
                                    
                                    
                                       
                                          =
                                          M
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          diag
                                          
                                             (
                                             1
                                             /
                                             
                                                C
                                                11
                                             
                                             ,
                                             …
                                             ,
                                             1
                                             /
                                             
                                                C
                                                
                                                   D
                                                   D
                                                
                                             
                                             )
                                          
                                          −
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             W
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             C
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          ,
                                       
                                    
                                 
                                 
                                    
                                       
                                          H
                                          W
                                       
                                    
                                    
                                       
                                          =
                                          −
                                          M
                                          
                                             ν
                                             
                                                0
                                                k
                                             
                                          
                                          
                                          diag
                                          
                                             (
                                             1
                                             /
                                             
                                                C
                                                
                                                   11
                                                
                                                2
                                             
                                             ,
                                             …
                                             ,
                                             1
                                             /
                                             
                                                C
                                                
                                                   D
                                                   D
                                                
                                                2
                                             
                                             )
                                          
                                          −
                                          
                                             ∑
                                             
                                                i
                                                =
                                                1
                                             
                                             M
                                          
                                          
                                             ν
                                             
                                                i
                                                k
                                             
                                          
                                          
                                             W
                                             
                                                i
                                                k
                                             
                                          
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     
                  

@&#REFERENCES@&#

