@&#MAIN-TITLE@&#Non-rigid registration using gradient of self-similarity response

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           For non-rigid registration, a hierarchical piece-wise affine transform is examined.


                        
                        
                           
                           We propose a metric to quantify the ability of being correctly registered.


                        
                        
                           
                           We examine ROC analysis on the proposed metric and Moran's spatial correlation.


                        
                        
                           
                           Proposed metric reflects the ability of being registered better than Moran's.


                        
                        
                           
                           Registration error is reduced by using the proposed metric as a sub-image indicator.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Non-rigid registration

Locally affine transformation

Hierarchical elastic registration

@&#ABSTRACT@&#


               Graphical abstract
               
                  
                     
                        
                           
                        
                     
                  
               
            

@&#INTRODUCTION@&#

Non-rigid image registration involves finding the non-linear geometric transformation (the deformation field) between two images [12]. It is broadly applied to medical image registration since most anatomical structures undergo non-rigid movement across time and the difference between body structures across patients cannot be fully described by rigid transformations. Generally, non-rigid registration can be classified into feature-based registration and intensity-based registration. The first type requires image preprocessing to extract the object features such as edges, surfaces and anatomical landmarks which are assumed to exist in both source and target images [11]. The goal is to find the deformation field that best matches the location of the features in both images. Without using intensity information, this approach largely reduces the computational complexity during optimization. However, this approach highly relies on the accuracy of image preprocessing tools such as segmentation and contour detection. Moreover, feature-based registration is not able to solve for non-rigid deformation without proper model assumption, which is usually case-dependent.

In contrast to matching features, intensity-based image registration uses intensity information to define a similarity function. It aims to determine the deformation field that maximizes the similarity between the deformed source image and the target image. Optical flow, which exploits a differential framework to estimate the motion vectors, is often applied to solve the registration problem [7,8]. However, having a high degree of freedom in the deformation model increases the computational complexity. For this reason, parametric model such as free-form deformation (FFD) has been proposed to represent the non-rigid deformation with a set of control points [10]. Another way to achieve non-rigid registration is by globally interpolating local deformation modeled by rigid or affine transformation while keeping the invertibility of global deformation [6,2]. The sub-image can be defined by segmentation based on the image intensity or recovered motion. Pitiot et al. [9] use a hierarchical clustering algorithm to partition the image into regions with similar motion, which is roughly estimated by a block matching algorithm. Based on the same idea, Zhuang et al. [13,14] develop a registration-based cardiac segmentation algorithm that maintains a global diffeomorphic transformation by interpolating the local affine transformation defined on a given set of regions, e.g. cardiac chambers. However, these methods are suitable for the objects with piecewise-affine motion and moreover, the number of local regions must be defined by the user based on prior knowledge, which is tedious and case-relevant. Non-rigid registration with locally affine transformation using sub-images defined on uniform grid is applied to general-purpose registration without any prior assumption [5]. A coarse-to-fine strategy sequentially decreases the size of sub-images and refines the cumulated deformation. Using the registration result from the coarse level as the starting point for searching the motion vector in the finer level speeds up the computation. Current study tries to improve the registration by only registering those sub-images which contain well-defined structure. Using mutual information as the similarity metric, [1] showed that a structure-less sub-image such as background and noisy data results in a misleading global optimum. The author used Moran's spatial correlation as the metric to detect such image patches. However, not all of the sub-images with well-defined structure can be correctly registered. In this paper, we propose a new approach to analyze the sub-image based on the gradient of the self-similarity response (GSR) which identifies not only the structure-less patch but also the patch having multiple optima in similarity function.

The remaining of this paper is constructed as the following. In Section 2, we describe the problem of Moran's spatial correlation as the motivation for GSR. We then introduce two sub-image quality metrics and discuss how to incorporate them into a non-rigid registration scheme using hierarchical locally affine transformation. Section 3 compares the performance of Moran's metric and GSR using receiver operating characteristic (ROC) analysis. We also compare the registration accuracy with known non-linear deformation as ground truth to give us a quantitative performance results. Finally, in Section 4 we provide some conclusions and point out several possible directions for future work.

@&#METHOD@&#

Non-rigid registration exploiting global parametric deformation models is usually computational expensive. The current studies reduce the complexity by registering part of the sub-images and then applying a global interpolation to find a smooth deformation. This technique usually comes with a hierarchical scheme which divides the sub-image sequentially to refine the deformation obtained from the previous decomposition level [5]. With regard to sub-image selection, the recent studies select the ones which contain well-defined structures. [1] employs Moran's spatial correlation as a metric to quantify the amount of structure. The author shows that a structure-less sub-image, such as background and noisy data, has a low Moran's score and tends to cause mis-registration. However, there are some well-structured patterns that would also result in mis-registration. This situation is described in Fig. 1
                         where we have two synthetic images centered at (0,0) with intensity varying in vertical (Fig. 1a) and radial (Fig. 1d) directions. For each case, we select a sub-image indicated by the solid line. Suppose now we move the sub-image away from the origin. To recover its original location relative to the big image, we simply evaluate the similarity as the sum of square difference (SSD) between the sub-image and the part of big image it overlaps with. Repeating the evaluation for each location produces a similarity map shown in Fig. 1b as a function of the displacement of the sub-image. Since the similarity achieves maximum at multiple location, we will never know where the sub-image comes from in the x-direction. Comparing with Fig. 1e where a single optimum can be found on the similarity map, we can recover the displacement of the sub-image by maximizing similarity. The problematic structure described in Fig. 1a can be easily found in a nature scene especially when the sub-image size is small. Registering such sub-images is prone to cause a misleading displacement vectors even though it has high spatial correlation. In Fig. 2
                        , we uniformly partition a test image and evaluate Moran's spatial correlation for each segment. We can observe that the sub-images with intensity varying in one direction only have high Moran's spatial correlation relative to other segments. Therefore, using Moran's metric may fail to identify such problematic structure. In contrast, the proposed method shown in Fig. 2c serves as a better indicator by producing relative lower scores to those sub-images.

Given 
                           
                              p
                              
                                 
                                    r
                                    →
                                 
                              
                           
                         and 
                           
                              q
                              
                                 
                                    r
                                    →
                                 
                              
                           
                         as the intensities of two images evaluated at coordinate 
                           
                              r
                              →
                           
                         and a functional 
                           
                              Q
                              
                                 
                                    p
                                    
                                       
                                          r
                                          →
                                       
                                    
                                    ;
                                    q
                                    
                                       
                                          r
                                          →
                                       
                                    
                                 
                              
                           
                        , which measures the similarity between two images, we define the self-similarity response for an image 
                           
                              p
                              
                                 
                                    r
                                    →
                                 
                              
                           
                         as the similarity between itself and its shifted version
                           
                              (1)
                              
                                 
                                    
                                       R
                                       
                                          Q
                                          ,
                                          p
                                       
                                    
                                    
                                       
                                          d
                                          →
                                       
                                    
                                    =
                                    Q
                                    
                                       
                                          p
                                          
                                             
                                                
                                                   r
                                                   →
                                                
                                                −
                                                
                                                   d
                                                   →
                                                
                                             
                                          
                                          ;
                                          p
                                          
                                             
                                                r
                                                →
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where 
                           
                              d
                              →
                           
                         is the displacement vector. We define GSR as the averaged normalized inner product between the gradient 
                           
                              ∇
                              
                                 R
                                 
                                    Q
                                    ,
                                    p
                                 
                              
                              
                                 
                                    d
                                    →
                                 
                              
                           
                         and the negative of displacement vector, 
                           
                              −
                              
                                 d
                                 →
                              
                           
                        .
                           
                              (2)
                              
                                 
                                    GSR
                                    =
                                    
                                       1
                                       
                                          
                                             S
                                          
                                          
                                             
                                                VAR
                                                
                                                   p
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          ∫
                                          S
                                       
                                       
                                          
                                             
                                                ∇
                                                
                                                   R
                                                   
                                                      Q
                                                      ,
                                                      p
                                                   
                                                
                                                
                                                   
                                                      d
                                                      →
                                                   
                                                
                                                ⋅
                                                
                                                   
                                                      −
                                                      
                                                         d
                                                         →
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         ∇
                                                         
                                                            R
                                                            
                                                               Q
                                                               ,
                                                               p
                                                            
                                                         
                                                         
                                                            
                                                               d
                                                               →
                                                            
                                                         
                                                      
                                                   
                                                   
                                                      l
                                                      2
                                                   
                                                
                                                
                                                   
                                                      
                                                         d
                                                         →
                                                      
                                                   
                                                   
                                                      l
                                                      2
                                                   
                                                
                                             
                                          
                                       
                                    
                                    d
                                    
                                       d
                                       →
                                    
                                 
                              
                           
                        where S is the range of the displacement vectors that we expect to recover and VAR(p) is the variance of the intensity of image p defined as
                           
                              (3)
                              
                                 
                                    VAR
                                    
                                       p
                                    
                                    =
                                    
                                       
                                          ∫
                                          S
                                       
                                       
                                          
                                             
                                                
                                                   p
                                                   
                                                      
                                                         r
                                                         →
                                                      
                                                   
                                                   −
                                                   
                                                      p
                                                      ¯
                                                   
                                                
                                             
                                             2
                                          
                                          d
                                          
                                             r
                                             →
                                          
                                       
                                    
                                    ,
                                    
                                    
                                       p
                                       ¯
                                    
                                    =
                                    
                                       
                                          ∫
                                          S
                                       
                                       
                                          p
                                          
                                             
                                                r
                                                →
                                             
                                          
                                          d
                                          
                                             r
                                             →
                                          
                                       
                                    
                                    .
                                 
                              
                           
                        
                     

Normalizing by the area of ROI |S| and the standard deviation of the image intensity 
                           
                              
                                 VAR
                                 
                                    p
                                 
                              
                           
                         makes GSR solely depend on the structure instead of image size and contrast. The intuition behind GSR is that when the direction of increasing similarity, 
                           
                              ∇
                              
                                 R
                                 
                                    Q
                                    ,
                                    p
                                 
                              
                              
                                 
                                    d
                                    →
                                 
                              
                           
                        , matches the opposite direction of the displacement vector, 
                           
                              −
                              
                                 d
                                 →
                              
                           
                        , the displaced image should be easier registered by simply maximizing the similarity using gradient. More precisely, consider the example shown in Fig. 1. While the cropped sub-image shifts with the displacement 
                           
                              d
                              →
                           
                        , 
                           
                              ∇
                              
                                 R
                                 
                                    Q
                                    ,
                                    p
                                 
                              
                              
                                 
                                    d
                                    →
                                 
                              
                           
                         in Fig. 1c indicates the direction of increasing similarity. Ideally, we want all the gradient vectors to point toward the origin so that by following the gradient, we would be able to bring the shifted sub-image back to its original location. This is shown in Fig. 1c and f, where the one with intensity varying in the vertical direction does not produce a gradient field pointing toward the origin but the one with a radial pattern does. By intuition, there is no way to recover the horizontal displacement for Fig. 1b whereas recovering the displacement on Fig. 1e is relatively easy. For implementation, given the goal of recovering the displacement within distance D, we may numerically approximate the integration defined in (2) as
                           
                              (4)
                              
                                 
                                    GSR
                                    =
                                    
                                       1
                                       
                                          
                                             D
                                          
                                          VAR
                                          
                                             p
                                          
                                       
                                    
                                    
                                       
                                          ∑
                                          
                                             
                                                
                                                   d
                                                   x
                                                
                                                
                                                   d
                                                   y
                                                
                                             
                                             ∈
                                             D
                                          
                                       
                                       
                                          
                                             
                                                ∇
                                                
                                                   R
                                                   
                                                      Q
                                                      ,
                                                      p
                                                   
                                                
                                                
                                                   
                                                      d
                                                      x
                                                   
                                                   
                                                      d
                                                      y
                                                   
                                                
                                                ⋅
                                                
                                                   
                                                      −
                                                      
                                                         d
                                                         x
                                                      
                                                      ,
                                                      −
                                                      
                                                         d
                                                         y
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         ∇
                                                         
                                                            R
                                                            
                                                               Q
                                                               ,
                                                               p
                                                            
                                                         
                                                         
                                                            
                                                               d
                                                               x
                                                            
                                                            
                                                               d
                                                               y
                                                            
                                                         
                                                      
                                                   
                                                   
                                                      l
                                                      2
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            d
                                                            x
                                                         
                                                         
                                                            d
                                                            y
                                                         
                                                      
                                                   
                                                   
                                                      l
                                                      2
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (5)
                              
                                 
                                    D
                                    ≡
                                    
                                       
                                          
                                             
                                                d
                                                x
                                             
                                             
                                                d
                                                y
                                             
                                          
                                          :
                                          
                                             
                                                
                                                   d
                                                   x
                                                   2
                                                
                                                +
                                                
                                                   d
                                                   y
                                                   2
                                                
                                             
                                          
                                          <
                                          D
                                          ,
                                          
                                             
                                                d
                                                x
                                             
                                             
                                                d
                                                y
                                             
                                          
                                          ∈
                                          
                                             ℤ
                                             2
                                          
                                       
                                    
                                 
                              
                           
                        where D represents the length of displacement we expect to recover. The gradient term can be simply implemented as
                           
                              (6)
                              
                                 
                                    ∇
                                    
                                       R
                                       
                                          Q
                                          ,
                                          p
                                       
                                    
                                    
                                       
                                          d
                                          x
                                       
                                       
                                          d
                                          y
                                       
                                    
                                    =
                                    
                                       
                                          
                                             ∂
                                             
                                                ∂
                                                x
                                             
                                          
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                d
                                                x
                                             
                                             
                                                d
                                                y
                                             
                                          
                                          ,
                                          
                                             ∂
                                             
                                                ∂
                                                y
                                             
                                          
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                d
                                                x
                                             
                                             
                                                d
                                                y
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (7)
                              
                                 
                                    
                                       ∂
                                       
                                          ∂
                                          x
                                       
                                    
                                    
                                       R
                                       
                                          Q
                                          ,
                                          p
                                       
                                    
                                    
                                       
                                          d
                                          x
                                       
                                       
                                          d
                                          y
                                       
                                    
                                    =
                                    
                                       
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                
                                                   d
                                                   x
                                                
                                                +
                                                1
                                                ,
                                                
                                                   d
                                                   y
                                                
                                             
                                          
                                          −
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                
                                                   d
                                                   x
                                                
                                                −
                                                1
                                                ,
                                                
                                                   d
                                                   y
                                                
                                             
                                          
                                       
                                       2
                                    
                                 
                              
                           
                        
                        
                           
                              (8)
                              
                                 
                                    
                                       ∂
                                       
                                          ∂
                                          y
                                       
                                    
                                    
                                       R
                                       
                                          Q
                                          ,
                                          p
                                       
                                    
                                    
                                       
                                          d
                                          x
                                       
                                       
                                          d
                                          y
                                       
                                    
                                    =
                                    
                                       
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                
                                                   d
                                                   x
                                                
                                                ,
                                                
                                                   d
                                                   y
                                                
                                                +
                                                1
                                             
                                          
                                          −
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                
                                                   d
                                                   x
                                                
                                                ,
                                                
                                                   d
                                                   y
                                                
                                                −
                                                1
                                             
                                          
                                       
                                       2
                                    
                                    .
                                 
                              
                           
                        
                     

For the example in Fig. 1, the synthetic images with intensity varying in the vertical and radial directions obtain GSR score 0.65 and 0.95, respectively. However, both images achieve high Moran's spatial correlation (0.95 and 0.96). Using Moran's metric may not be capable of identifying the problematic structure in Fig. 1a. We also note that similar to Moran's, GSR only depends on source image 
                           
                              p
                              
                                 
                                    r
                                    →
                                 
                              
                           
                        . In the task such as registering one source image to multiple target images, we only need to evaluate the GSR score once with respect to the source image.

We have shown that GSR quantifies the ability of recovering displacement averaged through all possible directions, 
                           
                              ∠
                              
                                 d
                                 →
                              
                              ∈
                              [
                              0
                              ,
                              2
                              π
                              )
                           
                        . We have seen that a sub-image with intensity varying in one direction, such as Fig. 1a, will give us a lower GSR value. However, the corresponding gradient field in Fig. 1c shows that such sub-image is still robust to vertical displacement. To quantify the ability of recovering displacement in certain direction, we introduce another metric named Directional GSR (DGSR) defined as
                           
                              (9)
                              
                                 
                                    DGSR
                                    
                                       θ
                                    
                                    =
                                    
                                       1
                                       
                                          |
                                          
                                             S
                                             θ
                                          
                                          |
                                          
                                             
                                                VAR
                                                
                                                   p
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          ∫
                                          
                                             S
                                             θ
                                          
                                       
                                       
                                    
                                    
                                    
                                       
                                          ∇
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                d
                                                →
                                             
                                          
                                          ⋅
                                          
                                             
                                                −
                                                sin
                                                
                                                   θ
                                                
                                                ,
                                                −
                                                cos
                                                
                                                   θ
                                                
                                             
                                          
                                       
                                       
                                          |
                                          |
                                          ∇
                                          
                                             R
                                             
                                                Q
                                                ,
                                                p
                                             
                                          
                                          
                                             
                                                d
                                                →
                                             
                                          
                                          |
                                          |
                                          
                                             
                                             2
                                          
                                       
                                    
                                    d
                                    
                                       d
                                       →
                                    
                                 
                              
                           
                        
                        
                           
                              (10)
                              
                                 
                                    
                                       S
                                       θ
                                    
                                    ≡
                                    
                                       
                                          
                                             d
                                             →
                                          
                                          :
                                          
                                             d
                                             →
                                          
                                          ⋅
                                          
                                             
                                                sin
                                                
                                                   θ
                                                
                                                ,
                                                cos
                                                
                                                   θ
                                                
                                             
                                          
                                          >
                                          0
                                          ,
                                          |
                                          |
                                          
                                             d
                                             →
                                          
                                          |
                                          |
                                          
                                             
                                             2
                                          
                                          <
                                          D
                                       
                                    
                                    .
                                 
                              
                           
                        
                     

DGSR is calculated as the goodness of match between the direction of increasing similarity, 
                           
                              ∇
                              
                                 R
                                 
                                    Q
                                    ,
                                    p
                                 
                              
                              
                                 
                                    d
                                    →
                                 
                              
                           
                        , and the direction toward the hyperplane, (−
                        sin(θ), −
                        cos(θ)). While GSR measures the quality of sub-images before local registration, DGSR measures the quality of recovered displacement vector instead. A sub-image with high DGSR score at θ is more robust to the displacements in the hyperplane S
                        
                           θ
                        . In other words, we can be more confident that the recovered displacement is oriented toward (−
                        cos(θ), −
                        sin(θ)) while registering such sub-image. Fig. 3
                         shows three synthetic sub-images with corresponding DGSR evaluated at θ
                        ∈[0,2π). It indicates that for those sub-images with intensity varying in one direction, we are more confident that the recovered displacement is parallel to the gradient of the pixel intensity. On the other hand, we should reject the local registration results with displacement perpendicular to the intensity gradient since they are more likely to be the local optima.

Given two images with intensity 
                           
                              p
                              
                                 
                                    r
                                    →
                                 
                              
                           
                         and 
                           
                              q
                              
                                 
                                    r
                                    →
                                 
                              
                           
                        , we aim to determine the deformation between them using a non-rigid registration technique based on locally affine registration. A hierarchical scheme sequentially decreases the size of the sub-image to refine the cumulated deformation field. At the i
                        
                           th
                         hierarchical level, we uniformly divide the source image into K
                        
                           i
                         sub-images 
                           
                              
                                 p
                                 
                                    i
                                    ,
                                    j
                                 
                              
                              
                                 
                                    r
                                    →
                                 
                              
                           
                         and j
                        ∈[1,⋯,
                        K
                        
                           i
                        ], each with size M
                        
                           i
                        
                        ×
                        M
                        
                           i
                        . Under this setting, we introduce two algorithms. The first algorithm employs GSR as a sub-image quality metric. In each decomposition level, we evaluate the GSR score for each sub-image GSR(p
                        
                           i,j
                        ) and only locally register those with GSR score higher than a threshold τ
                        
                           GSR
                         using affine transformation. The optimization is initialized by the affine coefficients 
                           
                              
                                 
                                    
                                       c
                                       →
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                              
                           
                         inherited from the registration result of the previous decomposition level. The sub-images with low GSR score will retain the same affine coefficients as the initialization. The recovered displacement vectors are then doubly checked with a consistency test [5] which enforces the local smoothness as the prior knowledge. More precisely, for each displacement vector, 
                           
                              
                                 
                                    d
                                    →
                                 
                                 
                                    i
                                    ,
                                    j
                                 
                              
                           
                        , a confidence region is calculated based on the displacement vectors of the neighboring sub-images,
                           
                              (11)
                              
                                 
                                    
                                       R
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    ≡
                                    
                                       
                                          
                                             
                                                
                                                   d
                                                   →
                                                
                                                
                                                   i
                                                   ,
                                                   j
                                                
                                             
                                          
                                          :
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            d
                                                            →
                                                         
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                      
                                                   
                                                   −
                                                   
                                                      
                                                         
                                                            d
                                                            →
                                                         
                                                         
                                                            i
                                                            ,
                                                            j
                                                         
                                                      
                                                   
                                                
                                             
                                             T
                                          
                                          
                                             Σ
                                             
                                                i
                                                ,
                                                j
                                             
                                             
                                                −
                                                1
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      
                                                         d
                                                         →
                                                      
                                                      
                                                         i
                                                         ,
                                                         j
                                                      
                                                   
                                                
                                                −
                                                
                                                   
                                                      
                                                         d
                                                         →
                                                      
                                                      
                                                         i
                                                         ,
                                                         j
                                                      
                                                   
                                                
                                             
                                          
                                          <
                                          f
                                          
                                             Pr
                                          
                                       
                                    
                                 
                              
                           
                        where 
                           
                              
                                 
                                    d
                                    →
                                 
                                 
                                    i
                                    ,
                                    j
                                 
                              
                           
                         and Σ
                        
                           i,j
                         are the mean and the covariance of the neighboring displacement vectors. f(⋅) is the inverse cumulative distribution function of an exponential distribution with λ
                        =2. Assuming the displacement vectors from a local neighborhood follow a Gaussian distribution, 
                           
                              
                                 
                                    
                                       d
                                       →
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                              
                              ∼
                              N
                              
                                 
                                    
                                       
                                          d
                                          →
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                 
                                 
                                    Σ
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                              
                           
                        , the probability of getting a displacement vector located in the confidence region R
                        
                           i,j
                         is Pr and we replace those outside the confidence region with 
                           
                              
                                 
                                    d
                                    →
                                 
                                 
                                    i
                                    ,
                                    j
                                 
                              
                           
                        . The resulting local affine coefficients are then linearly interpolated on a finer grid to generate the initial affine coefficients for the next decomposition level. Algorithm 1 shows the pseudo-code for the non-rigid registration algorithm using GSR. Affine registration 
                           
                              p
                              q
                              
                                 c
                                 →
                              
                           
                         represents registration using affine transformation with 
                           
                              c
                              →
                           
                         as the initial affine coefficients, and Linear interpolation represents bilinear interpolation with uniform weights. For the second algorithm, instead of selecting a sub-image to do local registration, we register every sub-image but only accept the recovered displacement vectors with high DGSR score, 
                           
                              DGSR
                              
                                 
                                    ∠
                                    
                                       
                                          
                                             d
                                             →
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                    
                                 
                              
                              >
                              
                                 τ
                                 DGSR
                              
                           
                        . The DGSR score can be calculated using Eq. (9) by substituting p
                        
                           i,j
                         and 
                           
                              ∠
                              
                                 
                                    
                                       d
                                       →
                                    
                                    
                                       i
                                       ,
                                       j
                                    
                                 
                              
                           
                         for p and θ, respectively. Similar to the first algorithm, the sub-images associated with the rejected displacements will keep the same affine coefficients inherited from the previous decomposition level. We also note that similar to GSR, DGSR does not depend on the target image either. Algorithm 2 illustrates the pseudo-code for non-rigid registration using DGSR. For both algorithms, after the finest decomposition level is completed, we use a multi-level b-spline kernel defined on a uniform grid [4] to interpolate the resulting displacement vectors and get the global deformation.
                           Algorithm 1
                           Non-rigid registration with GSR


                           
                              
                                 
                                    
                                 
                              
                           


                              
                                 
                                    
                                 
                              
                           

@&#RESULTS AND DISCUSSION@&#

To quantify the performance of the proposed sub-image quality metric relative to Moran's spatial correlation, we first examined the receiver operating characteristic (ROC) analysis which indicates the ability of classifying sub-images. In this experiment, we uniformly divide a 256×256, 8-bit gray-scale Lenna image into sub-images with a block size of 32×32 and shift each block by random displacement vector 
                           
                              
                                 d
                                 →
                              
                              =
                              
                                 
                                    d
                                    x
                                 
                                 
                                    d
                                    y
                                 
                              
                           
                         independently drawn from uniform distribution between ±8 pixels in both directions. Then we register each sub-image individually and estimate the probability of correct registration (
                           
                              |
                              |
                              
                                 
                                    d
                                    →
                                 
                                 ^
                              
                              −
                              
                                 d
                                 →
                              
                              |
                              |
                              
                                 
                                 
                                    l
                                    2
                                 
                              
                              ≤
                              0.25
                           
                         pixels) P
                        
                           c
                        (i) and misregistration (
                           
                              |
                              |
                              
                                 
                                    d
                                    →
                                 
                                 ^
                              
                              −
                              
                                 d
                                 →
                              
                              |
                              |
                              
                                 
                                 
                                    l
                                    2
                                 
                              
                              >
                              0.25
                           
                         pixels) based on 100 random trials. Two sub-image quality metrics, F
                        ∈{GSR,Moran}, are evaluated and we use F(i) to denote the score for the i
                        
                           th
                         sub-image. The true positive rate (TPR) and the false positive rate (FPR) are the functions of threshold τ defined as
                           
                              (12)
                              
                                 
                                    TPR
                                    
                                       τ
                                    
                                    =
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   F
                                                   
                                                      i
                                                   
                                                   >
                                                   τ
                                                
                                             
                                             
                                          
                                          
                                          
                                             P
                                             c
                                          
                                          
                                             i
                                          
                                       
                                       
                                          
                                             
                                                ∑
                                                i
                                             
                                             
                                          
                                          
                                          
                                             P
                                             c
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (13)
                              
                                 
                                    FPR
                                    
                                       τ
                                    
                                    =
                                    
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   ,
                                                   F
                                                   
                                                      i
                                                   
                                                   >
                                                   τ
                                                
                                             
                                             
                                          
                                          
                                          
                                             P
                                             m
                                          
                                          
                                             i
                                          
                                       
                                       
                                          
                                             
                                                ∑
                                                i
                                             
                                             
                                          
                                          
                                          
                                             P
                                             m
                                          
                                          
                                             i
                                          
                                       
                                    
                                    .
                                 
                              
                           
                        
                     

For Moran's spatial correlation, we use vicinity distance 4pixels [1]. Fig. 4
                         shows the resulting ROC curves corresponding to GSR and Moran's metric. In this example, GSR achieves larger area under the ROC curve which indicates that GSR is more capable of inferring sub-image quality. To compare the robustness of these two metrics to noise and various block sizes, we repeat the ROC analysis and compute the area under the ROC curves. For different block size, M, we generate random displacement vectors, 
                           
                              
                                 d
                                 →
                              
                              =
                              
                                 
                                    d
                                    x
                                 
                                 
                                    d
                                    y
                                 
                              
                           
                         within range 
                           
                              ±
                              
                                 
                                    M
                                    4
                                 
                              
                           
                        . In each trial, we add white Gaussian noise to source and target images independently. Fig. 5
                         shows the area under ROC curve as a function of the standard deviation of the noise. We can see that the performance degrades as the standard deviation of the noise σ increases, and GSR's classification performance is consistently better than that Moran's metric w.r.t. different block sizes.

To compare the performance of the non-rigid registration algorithm using GSR, DGSR and Moran's spatial correlation, we randomly generate synthetic deformation using a thin plate-spline [3] for 50 trials. In each trial, we generate 20 control points with random location and amplitude within [−16,16] in both x and y directions. A sample deformation is shown in Fig. 6
                        . Hierarchical registration schemes with different sub-image quality metrics are implemented as the pseudo-code shown in Algorithm 1 for Moran's metric and GSR and Algorithm 2 for DGSR. We use 7 hierarchical levels (L
                        =7) with the sub-image side length {M
                        
                           i
                        }={64,40,32,20,16,10,8} decreasing as the decomposition level proceeds. To compute GSR, we choose the recovery distance in (5) to be 
                           
                              D
                              =
                              
                                 
                                    M
                                    4
                                 
                              
                           
                        . For the threshold of GSR/DGSR, we choose τ
                        
                           GSR
                        
                        =0.65 and τ
                        
                           DGSR
                        
                        =0.01. We use a vicinity distance of 4pixels for Moran's metric and set the threshold of the standard Z score to be 1.96 [1]. For the consistency test [5], we choose the confidence region with probability Pr
                        =0.98. The target images are created by applying deformation on three 256×256, 8-bit gray-scale images which are Barbara, Lenna and Pirate. Under different noise level, we quantify the performance for three algorithms by the average Euclidean distance between the estimated deformation and the ground truth deformation.
                           
                              (14)
                              
                                 
                                    error
                                    =
                                    
                                       1
                                       N
                                    
                                    
                                       
                                          ∑
                                          
                                             n
                                             =
                                             1
                                          
                                          N
                                       
                                       
                                    
                                    
                                    
                                       
                                          
                                             1
                                             
                                                S
                                             
                                          
                                          
                                             
                                                ∑
                                                
                                                   
                                                      r
                                                      →
                                                   
                                                   ∈
                                                   S
                                                
                                             
                                             
                                          
                                          
                                          |
                                          |
                                          
                                             
                                                
                                                   T
                                                   ^
                                                
                                                n
                                             
                                          
                                          
                                             
                                                r
                                                →
                                             
                                          
                                          −
                                          
                                             T
                                             n
                                          
                                          
                                             
                                                r
                                                →
                                             
                                          
                                          |
                                          |
                                          
                                             
                                             
                                                l
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where N is the total number of trials, S is the support for both source and target images and |S| denotes the size of support in pixel. 
                           
                              
                                 
                                    T
                                    ^
                                 
                                 n
                              
                              
                                 
                                    r
                                    →
                                 
                              
                              ∈
                              
                                 ℝ
                                 2
                              
                           
                         and 
                           
                              
                                 T
                                 n
                              
                              
                                 
                                    r
                                    →
                                 
                              
                              ∈
                              
                                 ℝ
                                 2
                              
                           
                         are the n
                        
                           th
                         true and estimated deformation.

Applying a synthetic deformation on Lenna, Fig. 7
                         shows the registration process for registration algorithm using Moran's spatial correlation, GSR and DGSR. The second and the third rows demonstrate the rejection and acceptance behavior observed from an intermediate level. Moran's metric rejects the sub-images with high spatial frequency patterns whereas GSR also rejects the sub-images with intensity varying in one direction. DGSR rejects the recovered displacement which is perpendicular to the gradient of image intensity because this result might be caused from mis-registration. Fig. 8
                         demonstrates the registration results at the finest decomposition level (M
                        7
                        =8). Moran's metric results in unpredictable deformation in y-direction for the sub-images with intensity varying in x-direction locating around the left edge of the target image. The intensity difference between the registered and the target image indicates that DGSR is significantly better than GSR and Moran's metric in this example. Figs. 9 and 10
                        
                         demonstrate the registration results for different test images. Fig. 11
                         shows the mean and standard deviation of the registration error averaged over 50 random trials for different test images and noise levels. The results show that in the presence of noise, using GSR and DGSR for quantifying sub-image quality and recovered displacement analysis achieves an error reduction of 27% and 47% w.r.t. Moran's metric on average.

@&#CONCLUSIONS@&#

We have developed a new sub-image analysis method based on the gradient of the self-similarity response. Comparing to Moran's spatial correlation test, the proposed method takes into account the problematic structures such as the sub-image with constant intensity in one direction, which are prone to cause mis-registration in the direction perpendicular to the gradient of image intensity. Using ROC analysis, we have shown that the proposed method has better performance for identifying problematic sub-images than Moran's metric for different noise levels and sub-image block size. Since the problematic structure could still be capable of recovering the displacement in certain direction, we proposed another metric to quantify the reliability of recovered displacement. Incorporating the proposed metrics with a non-rigid registration scheme based on hierarchical locally affine transformation, we have shown that the proposed method achieves higher registration accuracy on average at different noise levels. Several possible future works will be considered such as extending the technique for multi-modality non-rigid registration with mutual information as similarity metric, designing a weighted GSR to improve the classification accuracy, taking second-order derivative into account, e.g. Hessian matrix, and determining the non-uniform image partition that maximizes the GSR.

@&#REFERENCES@&#

