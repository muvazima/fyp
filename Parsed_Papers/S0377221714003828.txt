@&#MAIN-TITLE@&#A priori orienteering with time windows and stochastic wait times at customers

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           We consider stochastic wait times resulting from queues of competing salespeople.


                        
                        
                           
                           The customer-specific recourse action is a novel addition to routing models.


                        
                        
                           
                           We derive an analytical formula for the expected reward from an a priori tour.


                        
                        
                           
                           We show the value of incorporating stochastic information into the routing model.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Orienteering

Stochastic wait times

Time window

Pharmaceutical sales

Recourse actions

@&#ABSTRACT@&#


               
               
                  In the pharmaceutical industry, sales representatives visit doctors to inform them of their products and encourage them to become an active prescriber. On a daily basis, pharmaceutical sales representatives must decide which doctors to visit and the order to visit them. This situation motivates a problem we more generally refer to as a stochastic orienteering problem with time windows (SOPTW), in which a time window is associated with each customer and an uncertain wait time at a customer results from a queue of competing sales representatives. We develop a priori routes with the objective of maximizing expected sales. We operationalize the sales representative’s execution of the a priori route with relevant recourse actions and derive an analytical formula to compute the expected sales from an a priori tour. We tailor a variable neighborhood search heuristic to solve the problem. We demonstrate the value of modeling uncertainty by comparing the solutions to our model to solutions of a deterministic version using expected values of the associated random variables. We also compute an empirical upper bound on our solutions by solving deterministic instances corresponding to perfect information.
               
            

@&#INTRODUCTION@&#

The pharmaceutical sales force has experienced a sizable reduction in recent years that is likely to continue. By the end of 2011, the number of pharmaceutical sales jobs in the US dropped to 72,000 from its peak of 105,000 in 2006 (Rockoff, 2012). In 2012, Britain’s second largest drugmaker, AstraZeneca, is cutting 1150 sales representatives in its US organizations, which is 24% of its sales force in the US (Arnold, 2012). Pharmaceutical companies have tried to compensate for the reduced sales force through the use of digital tools like websites and smartphone apps that allow doctors to directly query the company. However, sales representatives are not totally replaceable as they provide the means to develop relationships with customers that may otherwise go unreached. Dealing with a reduced number of sales representatives, pharmaceutical companies face the challenge of better managing their reduced sales forces to maximize their benefit to the company.

On a daily basis, pharmaceutical sales representatives must determine a daily schedule specifying which doctors to visit and the order to visit them in order to maximize potential sales. In general, a doctor’s accessibility to a sales representative is limited. Typically, the doctor specifies a time window during which she will meet representatives in between other work obligations (seeing patients, paperwork, etc.). We assume that the doctor meets with the representatives following a first-come-first-served protocol within the time window. To talk with a doctor, a representative must arrive at the doctor’s office before the closure of the doctor’s time window. However, after arriving, the representative may have to wait while the doctor attends to work obligations or meets with another representative. The time that doctors spend in with other work obligations is uncertain, while the duration of a meeting between a doctor and a representative is typically limited. In fact, representatives develop well-rehearsed sales pitches that fit within their brief time allocation. Thus, we assume that the meeting duration is known and constant while the time that a representative spends waiting to meet with a doctor is uncertain. This daily decision-making problem faced by pharmaceutical sales representatives is shared by other industries such as the textbook industry. Therefore, we more generally refer to this problem as a stochastic orienteering problem with time windows (SOPTW), in which a time window is associated with each customer and a uncertain wait time occurs at each customer.

We model the wait time faced by the representative as a random variable dependent on the arrival time and the queue length (of other representatives) upon arrival. In turn, we model queue length as a random variable dependent on the arrival time at the doctor’s office. We associate a deterministic economic value with each doctor representing the expected sales to the doctor if the representative meets with the doctor that day. In this paper, our objective is to construct an a priori route for the representative that maximizes the expected value collected on a given day. An a priori route is a pre-planned order of visits to customers (see Campbell & Thomas (2008) for an overview). That is, we seek to construct a static sequence of customers (doctors) that maximizes the expected value collected. A priori tours are usually used as subproblems in dynamic solution approaches (see Goodson, Ohlmann, & Thomas, 2013).

During the execution of an a priori route, after a random event is realized, a corrective action, often called a recourse action, may be required. In our treatment of the SOPTW, we consider two types of recourse actions, both of which preserve the route’s ordering of the visited customers. The first recourse action is motivated by the observation that a representative should skip a customer specified by an a priori route if she will not arrive within the customer’s time window. With the assumption of deterministic travel times, the representative can determine whether or not she can arrive at the next customer on the route within the respective time window given the departure time from the current customer. That is, the next customer visited by the representative will be the first customer in the remaining sequence of customers that can be visited within the time window. In Section 3, we generalize this recourse action to allow skipping if a representative will not arrive by any specified time.

The second recourse action operationalizes the notions of balking and reneging from queueing theory. The basic premise is that the representative may leave the queue immediately after arriving at a customer if observing a sufficiently long queue (balking) or she may leave after waiting in queue for a period of time without meeting with the customer (reneging). We propose a decision rule that takes as input the observed queue length upon the representative’s arrival to a customer to determine the latest time she will wait there. We elaborate on this second recourse action in Section 3.

This paper makes four primary contributions to the literature. First is the formulation of a routing model that explicitly accounts for the stochastic wait times resulting from queues of competing salespeople. Second, the customer-specific recourse action corresponding to the queueing notions of balking and reneging is a novel addition to routing models. We also derive an analytical formula to compute the expected reward from an a priori tour. Finally, our computational results demonstrate the value of incorporating stochastic information into the routing model for sales representatives.

To position our contribution, we review related literature in Section 2. In Sections 3 and 4, we provide a formal model of the problem and derive a closed-form computation of the objective. We discuss our solution approach to the SOPTW in Section 5. In Section 6, we discuss the generation of input data, notably the data for the transient queueing, for our SOPTW instances. Section 7 presents a deterministic version of the SOPTW in which waiting time distributions are replaced with expected wait times, resulting in an elementary longest path problem solvable via an exact solution method. Section 8 provides a computational comparison and Section 9 concludes with a summary and discussion of future work.

@&#LITERATURE REVIEW@&#

The SOPTW is rooted in the traveling salesman problem (TSP) with profits. The notion of profit or value can be incorporated in a TSP in several ways and the problem titling typically varies depending on the treatment of profit. One way to model profit is to minimize the overall travel costs in the objective function while using a constraint to ensure that a certain amount of profit is collected (prize collecting TSP). Another way is to maximize the overall profit collected while limiting the total travel cost to a specific upper bound (orienteering problem or selective TSP). The third way minimizes the travel costs minus collected profit in the objective function (profitable tour problem). Two extensions of the orienteering problem, usually referred to as the team orienteering problem and the selective vehicle routing problem, plan more than one tour and each tour collects rewards during the same period of time. Feillet, Dejax, and Gendreau (2005) provides a survey of the deterministic TSPs with profits and Vansteenwegen, Souffriau, and Oudheusden (2011) conducts a survey of the orienteering problem.

Stochastic elements have been incorporated in TSPs with profits in several ways. Teng, Ong, and Huang (2004) study a time-constrained TSP with uncertain travel and service time whose objective is to maximize the total profit collected on a tour. A limit is set to the total travel and service time of a route. They formulate the problem as a two-stage stochastic problem with recourse, where in the first stage a subset of customers are sequenced before the travel and service time are realized and in the second stage an expected penalty is imposed on the objective function for the violation of the limit time. Tang and Miller-Hooks (2005) propose a selective TSP with stochastic service times, travel times and travel costs. They formulate the problem as a chance-constrained stochastic integer program with an objective to maximize the total profit collected from an a priori tour while restricting the probability that the tour length exceeds a certain threshold to a given value. Campbell, Gendreau, and Thomas (2011) address an orienteering problem with stochastic travel and service times where a customer specific penalty is incurred for each scheduled customer not reached before a given known deadline. They investigate special versions of the problem that can be solved optimally and present variable neighborhood search heuristics to solve general versions of the problem. Similar to Campbell et al. (2011), Papapanagiotou, Weyland, Montemanni, and Gambardella (2013) investigate an orienteering problem with stochastic travel and service times and a given deadline. They focus on developing a Monte Carlo sampling procedure to approximate the objective function. They demonstrate the effectiveness of the objective approximation by comparing it with the exact objective evaluation. Evers, Glorie, van der Ster, Barros, and Monsuur (2014) study an orienteering problem with a stochastic weight on each arc and a hard constraint on the total weight of a tour. They introduce a two-stage recourse model where a recourse action of aborting the tour (returning to the depot) is taken in the second stage. They propose a sample average approximation (SAA) procedure to solve the problem, in which the objective function is approximated via Monte Carlo sampling.

The stochastic elements in the papers we describe in the preceding paragraph are similar to our SOPTW in that the arrival time at a customer is uncertain (in the SOPTW the arrival time at a customer is uncertain due to the uncertain waiting time at previous customers). However, we are unaware of any prior treatment of time windows in a stochastic TSP with profits that compares to our SOPTW. Voccia, Campbell, and Thomas (2013) conduct a study of a probabilistic traveling salesman problem with time windows (PTSPTW). Though inducing uncertain arrival time via uncertain presence of customers, this PTSPTW is not comparative to the SOPTW as the former’s objective is to minimize the expected traveling costs and does not consider any measure of profit.

Our work is related to research in queueing theory in terms of investigating the balking and reneging decision rules (Burnetas, 2013; D’Auria & Kanta, 2011; Yechiali, 1971, 1972). However, our work differs from the existing queueing literature by considering a network of queues rather than one or two queues (D’Auria & Kanta, 2011; Yechiali, 1971, 1972) and allowing the salesperson to go to another queue after leaving the current queue, rather than leaving the system permanently at the point of balking (Burnetas, 2013). As far as we are aware of, there are no other studies considering queueing mechanism in a routing problem as we do.

We define the SOPTW on a complete graph G
                     =
                     
                        
                           (
                           V
                           ,
                           E
                           )
                        
                     . The set V consists of 
                        
                           n
                           +
                           1
                        
                      nodes corresponding to a depot and n potential customers that a pharmaceutical representative may visit. The set E denotes the set of edges that is associated with each pair of vertices. A deterministic travel time, denoted 
                        
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                        
                     , is associated with each edge 
                        
                           (
                           i
                           ,
                           j
                           )
                        
                     . A profit 
                        
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                        
                      and a time window 
                        
                           [
                           
                              
                                 e
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 l
                              
                              
                                 i
                              
                           
                           ]
                        
                      are associated with each customer 
                        
                           i
                           ∈
                           V
                        
                     . Let 
                        
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                        
                      be a random variable representing the arrival time at customer i. Let 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                      be a random variable representing the queue length at customer i observed upon the representative’s arrival and 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                      be a realization of 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                     . We assume the distribution of 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                      to be a function of 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     , denoted with the probability mass function 
                        
                           g
                           (
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                     , where 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      is a realization of 
                        
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                        
                     . Let 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                      be a random variable representing the wait time at customer i and 
                        
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                        
                      be a realization of 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                     . We assume the distribution of 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                      to be a function of 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                      and 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     , denoted with the probability mass function 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                     . We note that the possible values of 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                      range from 
                        
                           max
                           
                              
                                 
                                    
                                       
                                          e
                                       
                                       
                                          i
                                       
                                    
                                    -
                                    
                                       
                                          a
                                       
                                       
                                          i
                                       
                                    
                                    ,
                                    0
                                 
                              
                           
                        
                      to 
                        
                           
                              
                                 l
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     . Let 
                        
                           
                              
                                 S
                              
                              
                                 i
                              
                           
                        
                      be a random variable with a known distribution representing the duration of the meeting between the sales representative and the customer. While our model can easily incorporate an uncertain amount of meeting time (as our analytical derivation in Section 4 shows), in our computational results of Section 8.2 we assume 
                        
                           
                              
                                 S
                              
                              
                                 i
                              
                           
                           =
                           s
                        
                      where s is a known and constant value. This assumption is based on the observation that meeting durations for pharmaceutical sales representatives are often short and pre-determined by the doctor.

As stated in the introduction, we consider two types of recourse actions in the model for the SOPTW, both of which incorporate the value of customers. The first recourse action is to skip a planned customer j on the a priori tour if the representative cannot arrive before a specified time 
                        
                           
                              
                                 τ
                              
                              
                                 j
                              
                           
                        
                     . That is, if 
                        
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           >
                           
                              
                                 τ
                              
                              
                                 j
                              
                           
                        
                      then the representative will skip customer j and consider the next customer on the a priori tour. Let 
                        
                           
                              
                                 D
                              
                              
                                 i
                              
                           
                        
                      be a random variable representing the departure time from customer i. Suppose customer i is followed by customer j on the a priori tour. Once we know the realization of 
                        
                           
                              
                                 D
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 d
                              
                              
                                 i
                              
                           
                        
                     , the arrival time at j can be computed as 
                        
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 d
                              
                              
                                 i
                              
                           
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                        
                     . The representative will skip customer j if 
                        
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 d
                              
                              
                                 i
                              
                           
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                           >
                           
                              
                                 τ
                              
                              
                                 j
                              
                           
                        
                     , where 
                        
                           
                              
                                 τ
                              
                              
                                 j
                              
                           
                           ∈
                           
                              
                                 
                                    0
                                    ,
                                    
                                       
                                          l
                                       
                                       
                                          j
                                       
                                    
                                 
                              
                           
                        
                     .

The value of 
                        
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      for customer i is determined by the value of the parameter 
                        
                           
                              
                                 r
                              
                              
                                 ̃
                              
                           
                        
                     , the minimum expected reward for which the representative is willing to travel to customer i, where 
                        
                           
                              
                                 r
                              
                              
                                 ̃
                              
                           
                           ∈
                           
                              
                                 
                                    0
                                    ,
                                    
                                       
                                          min
                                       
                                       
                                          i
                                       
                                    
                                    {
                                    
                                       
                                          r
                                       
                                       
                                          i
                                       
                                    
                                    }
                                 
                              
                           
                        
                     . We compute 
                        
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      as follows:
                        
                           (1)
                           
                              
                                 
                                    τ
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 max
                              
                              
                                 
                                    
                                       t
                                       ⩾
                                       0
                                       :
                                       P
                                       
                                          
                                             
                                                
                                                   
                                                      W
                                                   
                                                   
                                                      i
                                                   
                                                
                                                <
                                                
                                                   
                                                      l
                                                   
                                                   
                                                      i
                                                   
                                                
                                                -
                                                t
                                                |
                                                
                                                   
                                                      a
                                                   
                                                   
                                                      i
                                                   
                                                
                                                =
                                                t
                                             
                                          
                                       
                                       ×
                                       
                                          
                                             r
                                          
                                          
                                             i
                                          
                                       
                                       ⩾
                                       
                                          
                                             r
                                          
                                          
                                             ̃
                                          
                                       
                                       ,
                                       
                                       t
                                       ∈
                                       support
                                       (
                                       W
                                       )
                                    
                                 
                              
                              ,
                           
                        
                     where we obtain the probability measure from 
                        
                           g
                           (
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      and 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      via the law of total probability. Intuitively, 
                        
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      corresponds to a threshold value after which time the likelihood that the representative will meet with the customer i is deemed too low.

The second recourse action enables the representative either to leave the queue immediately after arriving and observing a sufficiently long queue (balking) or to leave after waiting in the queue for a period of time without having met the doctor (reneging). In the following, we establish a static decision rule to determine how long the representative should wait at a customer upon arriving.

Let the random variable 
                        
                           
                              
                                 Δ
                              
                              
                                 i
                              
                           
                        
                      represent the longest amount of time that the representative will wait at customer i. Let 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                        
                      be a parameter indicating the minimum expected reward for which the representative is willing to wait at customer i, where 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                           ∈
                           
                              
                                 
                                    0
                                    ,
                                    
                                       
                                          min
                                       
                                       
                                          i
                                       
                                    
                                    {
                                    
                                       
                                          r
                                       
                                       
                                          i
                                       
                                    
                                    }
                                 
                              
                           
                        
                     . We then specify 
                        
                           
                              
                                 Δ
                              
                              
                                 i
                              
                           
                        
                      such that the realized value of 
                        
                           
                              
                                 Δ
                              
                              
                                 i
                              
                           
                        
                     , denoted by 
                        
                           
                              
                                 δ
                              
                              
                                 i
                              
                           
                        
                     , is known with certainty given 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                        
                     , the arrival time 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      at customer i, and the observed queue length 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                      at customer i. Specifically,
                        
                           (2)
                           
                              
                                 
                                    δ
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 max
                              
                              
                                 
                                    
                                       t
                                       ⩾
                                       0
                                       :
                                       P
                                       
                                          
                                             
                                                
                                                   
                                                      W
                                                   
                                                   
                                                      i
                                                   
                                                
                                                <
                                                
                                                   
                                                      l
                                                   
                                                   
                                                      i
                                                   
                                                
                                                -
                                                
                                                   
                                                      a
                                                   
                                                   
                                                      i
                                                   
                                                
                                                |
                                                
                                                   
                                                      q
                                                   
                                                   
                                                      i
                                                   
                                                
                                                ,
                                                
                                                   
                                                      w
                                                   
                                                   
                                                      i
                                                   
                                                
                                                ⩾
                                                t
                                             
                                          
                                       
                                       ×
                                       
                                          
                                             r
                                          
                                          
                                             i
                                          
                                       
                                       ⩾
                                       
                                          
                                             r
                                          
                                          
                                             ˇ
                                          
                                       
                                       ,
                                       
                                       t
                                       ∈
                                       support
                                       (
                                       W
                                       )
                                    
                                 
                              
                              ,
                           
                        
                     where the probability measure is based on 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      and 
                        
                           support
                           (
                           W
                           )
                        
                      denotes the support of W. Intuitively, 
                        
                           
                              
                                 δ
                              
                              
                                 i
                              
                           
                        
                      establishes a threshold value after which the probability of meeting with the customer is considered too low to be valuable. If no value of t satisfies Eq. (2), we define 
                        
                           
                              
                                 δ
                              
                              
                                 i
                              
                           
                           =
                           0
                        
                     ; this case corresponds to the representative balking and immediately leaving customer i upon arrival.

Let 
                        
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           +
                           
                              
                                 Δ
                              
                              
                                 i
                              
                           
                        
                      be the latest time that the representative will stay at customer i without having started a conversation with the customer. Let 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                      be the realization of 
                        
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                        
                     . Given the arrival time and observed queue length at customer i, the value of 
                        
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                        
                      is fully specified, 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           +
                           
                              
                                 δ
                              
                              
                                 i
                              
                           
                        
                     . If there is no possibility of visiting a future customer for the representative who is supposed to leave customer i at 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                     , then the representative will stay at customer i until the end of customer i’s time window, i.e., 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 l
                              
                              
                                 i
                              
                           
                        
                      if customer i is the last unskipped customer in the sequence.

As an example, consider a case in which the representative arrives at customer i at time 10 and observes a queue length of four. Let customer i’s time window be [
                        
                           
                              
                                 e
                              
                              
                                 i
                              
                           
                           =
                           8
                           ,
                           
                              
                                 l
                              
                              
                                 i
                              
                           
                           =
                           28
                        
                     ] and economic value be 30. Further, suppose the distribution of 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           =
                           4
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           =
                           10
                           )
                        
                      is defined by the values 8, 12, 16, 18 with probabilities 0.2, 0.3, 0.4, 0.1, respectively. Then, define the distribution 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           =
                           4
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           =
                           10
                           ,
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           ⩾
                           12
                           )
                        
                      by the values of 12, 16 and 18 with probability 0.375, 0.5, 0.125, respectively. Define the distribution 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           =
                           4
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           =
                           10
                           ,
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           ⩾
                           16
                           )
                        
                      by the values of 16 and 18 with probabilities 0.8 and 0.2, respectively. The distribution of 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           =
                           4
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           =
                           10
                           ,
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           ⩾
                           18
                           )
                        
                      is defined by the value of 18 with probability 1. For a minimum expected reward 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                           =
                           15
                           ,
                           
                              
                                 δ
                              
                              
                                 i
                              
                           
                           =
                           16
                        
                      from Eq. (2), and consequently 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           =
                           26
                        
                     .

Our objective is to find an a priori tour that, armed with the two recourse actions described above, maximizes the expected revenue. To express this objective, let 
                        
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                        
                      be a random variable denoting the time that the representative starts a meeting with customer i. Due to the uncertainties in this problem, it is unlikely to be able to visit all customers; we let 
                        
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           =
                           ∞
                        
                      denote that customer i was not visited. Let 
                        
                           
                              
                                 Z
                              
                              
                                 i
                              
                           
                        
                      be a random variable representing the reward collected from customer i. We assume that a deterministic reward of 
                        
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                           >
                           0
                        
                      is collected from customer i if and only if a representative starts a meeting with customer i no later than 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                     . In other words, 
                        
                           
                              
                                 Z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                        
                      if 
                        
                           
                              
                                 b
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                      and 0 otherwise, where 
                        
                           
                              
                                 b
                              
                              
                                 i
                              
                           
                        
                      is a realization of 
                        
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                        
                     . The expected revenue for a priori tour v is 
                        
                           Ω
                           (
                           v
                           )
                           =
                           
                              
                                 ∑
                              
                              
                                 i
                                 ∈
                                 v
                              
                           
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                           P
                           [
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                           ]
                        
                     . The objective of this problem is to find an a priori tour 
                        
                           
                              
                                 v
                              
                              
                                 ∗
                              
                           
                        
                      such that 
                        
                           Ω
                           (
                           
                              
                                 v
                              
                              
                                 ∗
                              
                           
                           )
                           ⩾
                           Ω
                           (
                           v
                           )
                        
                      for every v.

To compute the expected revenue of an a priori tour, we must compute 
                        
                           P
                           [
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                           ]
                        
                      for each customer i. In the following derivation, the index i refers to the ith customer in tour v. To develop a recursion for computing these values of 
                        
                           P
                           [
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                           ]
                        
                     , we begin with the observation that
                        
                           (3)
                           
                              P
                              [
                              
                                 
                                    B
                                 
                                 
                                    i
                                 
                              
                              ⩽
                              
                                 
                                    Γ
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              +
                              
                                 
                                    W
                                 
                                 
                                    i
                                 
                              
                              ⩽
                              
                                 
                                    Γ
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    W
                                 
                                 
                                    i
                                 
                              
                              ⩽
                              
                                 
                                    Γ
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    W
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                              ]
                              ×
                              P
                              [
                              
                                 
                                    W
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    Q
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    Q
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             i
                                          
                                       
                                       ⩽
                                       
                                          
                                             γ
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              Λ
                              (
                              i
                              ,
                              
                                 
                                    γ
                                 
                                 
                                    i
                                 
                              
                              )
                              f
                              (
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              g
                              (
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              .
                           
                        
                     where the first equality follows from the definition of 
                        
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                        
                      and the second equality results from conditioning on the arrival time, queue length and wait time. The third equality results from several observations. First, the values for 
                        
                           P
                           [
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                      and 
                        
                           P
                           [
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                      are provided by the known probability mass distributions 
                        
                           g
                           (
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      and 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                     , respectively. Second, once the realizations of 
                        
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                        
                      and 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                      are known, the realization of 
                        
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                        
                      is determined, so 
                        
                           P
                           [
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 Γ
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           ]
                           =
                           Λ
                           (
                           i
                           ,
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           )
                        
                     , where 
                        
                           Λ
                           (
                           i
                           ,
                           t
                           )
                        
                      is an indicator function such that
                        
                           
                              Λ
                              (
                              i
                              ,
                              t
                              )
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                1
                                                ,
                                             
                                             
                                                if
                                                
                                                
                                                   
                                                      a
                                                   
                                                   
                                                      i
                                                   
                                                
                                                +
                                                
                                                   
                                                      w
                                                   
                                                   
                                                      i
                                                   
                                                
                                                ⩽
                                                t
                                             
                                          
                                          
                                             
                                                0
                                                ,
                                             
                                             
                                                otherwise.
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     Third, because for a particular arrival time 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      and arrival queue length 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                     , the representative will leave customer i at time 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                      if she cannot start a meeting with the customer before 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                     , we know that the wait time 
                        
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                        
                      for the representative at the customer cannot exceed 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     .

In Eq. (3), we need to determine 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                     . Define the random variable
                        
                           
                              
                                 
                                    X
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                1
                                                ,
                                             
                                             
                                                if customer
                                                
                                                i
                                                
                                                is not skipped
                                             
                                          
                                          
                                             
                                                0
                                                ,
                                             
                                             
                                                if customer
                                                
                                                i
                                                
                                                is skipped.
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     Because customer i will be skipped if the arrival time at the customer will be 
                        
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      or later, we have 
                        
                           P
                           [
                           
                              
                                 X
                              
                              
                                 i
                              
                           
                           =
                           1
                           ]
                           =
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                           ]
                        
                      and 
                        
                           P
                           [
                           
                              
                                 X
                              
                              
                                 i
                              
                           
                           =
                           0
                           ]
                           =
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           >
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                           ]
                        
                     . We express the arrival time at customer i as:
                        
                           (4)
                           
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       j
                                       =
                                       0
                                    
                                    
                                       i
                                       -
                                       1
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       j
                                       =
                                       0
                                    
                                    
                                       i
                                       -
                                       1
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       j
                                       =
                                       0
                                    
                                    
                                       i
                                       -
                                       2
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ,
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    1
                                 
                              
                              =
                              0
                              ,
                              …
                              ,
                              
                                 
                                    X
                                 
                                 
                                    i
                                    -
                                    1
                                 
                              
                              =
                              0
                              ]
                              ×
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    1
                                 
                              
                              =
                              0
                              ,
                              …
                              ,
                              
                                 
                                    X
                                 
                                 
                                    i
                                    -
                                    1
                                 
                              
                              =
                              0
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ]
                              ×
                              P
                              [
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              +
                              
                                 
                                    
                                       P
                                       [
                                       
                                          
                                             A
                                          
                                          
                                             i
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       |
                                       
                                          
                                             X
                                          
                                          
                                             i
                                             -
                                             1
                                          
                                       
                                       =
                                       1
                                       ,
                                       
                                          
                                             D
                                          
                                          
                                             i
                                             -
                                             1
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             i
                                             -
                                             1
                                             ,
                                             i
                                          
                                       
                                       ]
                                       ×
                                       P
                                       [
                                       
                                          
                                             D
                                          
                                          
                                             i
                                             -
                                             1
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             i
                                             -
                                             1
                                             ,
                                             i
                                          
                                       
                                       |
                                       
                                          
                                             X
                                          
                                          
                                             i
                                             -
                                             1
                                          
                                       
                                       =
                                       1
                                       ]
                                       P
                                       [
                                       
                                          
                                             X
                                          
                                          
                                             i
                                             -
                                             1
                                          
                                       
                                       =
                                       1
                                       ]
                                    
                                 
                              
                              .
                           
                        
                     The first equality holds because the arrival time at customer i depends on the departure time from the customer that is visited before customer i. The second equality follows from the definition of joint probability. The third equality follows from the observation that arc 
                        
                           (
                           j
                           ,
                           i
                           )
                        
                      appears on the tour only if customers 
                        
                           j
                           +
                           1
                           ,
                           j
                           +
                           2
                           ,
                           …
                           ,
                           i
                           -
                           1
                        
                      are skipped.

Notably, 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           ,
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           =
                           0
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                           =
                           0
                           ]
                           =
                           1
                        
                      if 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      as we would not skip customer i and 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           ,
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           =
                           0
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                           =
                           0
                           ]
                           =
                           0
                        
                      if 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           >
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      as we would skip customer i. By defining the indicator function
                        
                           
                              Ψ
                              (
                              i
                              ,
                              t
                              )
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                0
                                                ,
                                             
                                             
                                                if
                                                
                                                t
                                                >
                                                
                                                   
                                                      τ
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                          
                                          
                                             
                                                1
                                                ,
                                             
                                             
                                                otherwise,
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     we express 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           ,
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           =
                           0
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                           =
                           0
                           ]
                           =
                           Ψ
                           (
                           i
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                     . Hence, to determine 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                      via Eq. (4) it remains to compute 
                        
                           P
                           [
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           =
                           0
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                           =
                           0
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           ]
                        
                     , 
                        
                           P
                           [
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ]
                        
                     , and 
                        
                           P
                           [
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ]
                        
                      for 
                        
                           j
                           =
                           0
                           ,
                           …
                           i
                           -
                           1
                        
                     .

For notational convenience, let 
                        
                           R
                           (
                           j
                           ,
                           i
                           -
                           1
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           )
                           =
                           P
                           [
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           =
                           0
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                           =
                           0
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           ]
                        
                      for 
                        
                           j
                           =
                           0
                           ,
                           …
                           i
                           -
                           2
                        
                     . By consecutively conditioning on 
                        
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 1
                              
                           
                           ,
                           
                              
                                 X
                              
                              
                                 j
                                 +
                                 2
                              
                           
                           ,
                           …
                           ,
                           
                              
                                 X
                              
                              
                                 i
                                 -
                                 1
                              
                           
                        
                     , we obtain
                        
                           (5)
                           
                              R
                              (
                              j
                              ,
                              i
                              -
                              1
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              )
                              =
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    2
                                 
                              
                              =
                              0
                              ,
                              …
                              ,
                              
                                 
                                    X
                                 
                                 
                                    i
                                    -
                                    1
                                 
                              
                              =
                              0
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ,
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    1
                                 
                              
                              =
                              0
                              ]
                              ×
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    1
                                 
                              
                              =
                              0
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ]
                              =
                              P
                              [
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    2
                                 
                              
                              =
                              0
                              ,
                              …
                              ,
                              
                                 
                                    X
                                 
                                 
                                    i
                                    -
                                    1
                                 
                              
                              =
                              0
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              ,
                              
                                 
                                    X
                                 
                                 
                                    j
                                    +
                                    1
                                 
                              
                              =
                              0
                              ]
                              ×
                              [
                              1
                              -
                              Ψ
                              (
                              j
                              +
                              1
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              +
                              
                                 
                                    c
                                 
                                 
                                    j
                                    ,
                                    j
                                    +
                                    1
                                 
                              
                              )
                              ]
                              =
                              …
                              =
                              
                                 
                                    
                                       ∏
                                    
                                    
                                       k
                                       =
                                       j
                                       +
                                       1
                                    
                                    
                                       i
                                       -
                                       1
                                    
                                 
                              
                              (
                              1
                              -
                              Ψ
                              (
                              k
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              +
                              
                                 
                                    c
                                 
                                 
                                    jk
                                 
                              
                              )
                              )
                              .
                           
                        
                     From Eq. (5), we see that given possible realizations of 
                        
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                        
                     , we can compute 
                        
                           R
                           (
                           j
                           ,
                           i
                           -
                           1
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           )
                        
                      iteratively.

Next, we calculate 
                        
                           P
                           [
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ]
                        
                      via conditioning:
                        
                           (6)
                           
                              P
                              [
                              
                                 
                                    D
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       P
                                       [
                                       
                                          
                                             D
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             ji
                                          
                                       
                                       |
                                       
                                          
                                             X
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       1
                                       ,
                                       
                                          
                                             A
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                       ,
                                       
                                          
                                             Q
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                       ]
                                       ×
                                       P
                                       [
                                       
                                          
                                             Q
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                       |
                                       
                                          
                                             A
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                       ,
                                       
                                          
                                             X
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       1
                                       ]
                                       ×
                                       P
                                       [
                                       
                                          
                                             A
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                       |
                                       
                                          
                                             X
                                          
                                          
                                             j
                                          
                                       
                                       =
                                       1
                                       ]
                                    
                                 
                              
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             j
                                          
                                       
                                       ⩽
                                       
                                          
                                             γ
                                          
                                          
                                             j
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             s
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              +
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              +
                              
                                 
                                    S
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    S
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    s
                                 
                                 
                                    j
                                 
                              
                              ]
                              ×
                              P
                              [
                              
                                 
                                    S
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    s
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              ×
                              P
                              [
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              +
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             j
                                          
                                       
                                       >
                                       
                                          
                                             γ
                                          
                                          
                                             j
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    Γ
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              ]
                              ×
                              P
                              [
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    Q
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ,
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              .
                           
                        
                     The first inequality follows from conditioning on the arrival time and queue length. To achieve the second equality results, we condition on the wait time 
                        
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                        
                      and service time 
                        
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                        
                      for 
                        
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           ⩽
                           
                              
                                 γ
                              
                              
                                 j
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                        
                      (representative meets with the customer), and we condition on just the wait time 
                        
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                        
                      for 
                        
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           >
                           
                              
                                 γ
                              
                              
                                 j
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                        
                      (representative departs the customer without meeting).

In Eq. (6), 
                        
                           P
                           [
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 Q
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                           ]
                        
                      is either 0 or 1. We assume random variable 
                        
                           
                              
                                 S
                              
                              
                                 i
                              
                           
                        
                      is independent of random variables 
                        
                           
                              
                                 A
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                     , and 
                        
                           
                              
                                 X
                              
                              
                                 i
                              
                           
                        
                     , and thus 
                        
                           P
                           [
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 Q
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           ]
                           =
                           P
                           [
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                           ]
                        
                     ; this quantity is specified by the known distribution of 
                        
                           
                              
                                 S
                              
                              
                                 j
                              
                           
                        
                     . The known distributions 
                        
                           f
                           (
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      and 
                        
                           g
                           (
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           )
                        
                      specify the probabilities 
                        
                           P
                           [
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 Q
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           ]
                        
                      and 
                        
                           P
                           [
                           
                              
                                 Q
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           ]
                        
                     , respectively. Because the value of 
                        
                           
                              
                                 Γ
                              
                              
                                 j
                              
                           
                        
                      is known given realizations of arrival time and queue length, the probabilities 
                        
                           P
                           [
                           
                              
                                 Γ
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ,
                           
                              
                                 A
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 Q
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 q
                              
                              
                                 j
                              
                           
                           ,
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           ]
                        
                      are 0 or 1. Finally,
                        
                           (7)
                           
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    X
                                 
                                 
                                    j
                                 
                              
                              =
                              1
                              ]
                              =
                              
                                 
                                    P
                                    [
                                    
                                       
                                          X
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    1
                                    |
                                    
                                       
                                          A
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    
                                       
                                          a
                                       
                                       
                                          j
                                       
                                    
                                    ]
                                    P
                                    [
                                    
                                       
                                          A
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    
                                       
                                          a
                                       
                                       
                                          j
                                       
                                    
                                    ]
                                 
                                 
                                    P
                                    [
                                    
                                       
                                          X
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    1
                                    ]
                                 
                              
                              =
                              
                                 
                                    Ψ
                                    (
                                    j
                                    ,
                                    
                                       
                                          a
                                       
                                       
                                          j
                                       
                                    
                                    )
                                    P
                                    [
                                    
                                       
                                          A
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    
                                       
                                          a
                                       
                                       
                                          j
                                       
                                    
                                    ]
                                 
                                 
                                    P
                                    [
                                    
                                       
                                          X
                                       
                                       
                                          j
                                       
                                    
                                    =
                                    1
                                    ]
                                 
                              
                              .
                           
                        
                     
                  

Let 
                        
                           Θ
                           (
                           j
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           )
                           =
                           P
                           [
                           
                              
                                 D
                              
                              
                                 j
                              
                           
                           =
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           |
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ]
                           P
                           [
                           
                              
                                 X
                              
                              
                                 j
                              
                           
                           =
                           1
                           ]
                        
                     . Eqs. (6) and (7) imply
                        
                           (8)
                           
                              Θ
                              (
                              j
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              -
                              
                                 
                                    c
                                 
                                 
                                    ji
                                 
                              
                              )
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             j
                                          
                                       
                                       ⩽
                                       
                                          
                                             γ
                                          
                                          
                                             j
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             s
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    I
                                 
                                 
                                    
                                       
                                          
                                             
                                                a
                                             
                                             
                                                j
                                             
                                          
                                          +
                                          
                                             
                                                w
                                             
                                             
                                                j
                                             
                                          
                                          +
                                          
                                             
                                                s
                                             
                                             
                                                j
                                             
                                          
                                          =
                                          
                                             
                                                a
                                             
                                             
                                                i
                                             
                                          
                                          -
                                          
                                             
                                                c
                                             
                                             
                                                ji
                                             
                                          
                                       
                                    
                                 
                              
                              P
                              [
                              
                                 
                                    S
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    s
                                 
                                 
                                    j
                                 
                              
                              ]
                              f
                              (
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              g
                              (
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              Ψ
                              (
                              j
                              ,
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              ×
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              +
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             j
                                          
                                       
                                       >
                                       
                                          
                                             γ
                                          
                                          
                                             j
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             j
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    I
                                 
                                 
                                    
                                       
                                          
                                             
                                                γ
                                             
                                             
                                                j
                                             
                                          
                                          =
                                          
                                             
                                                a
                                             
                                             
                                                i
                                             
                                          
                                          -
                                          
                                             
                                                c
                                             
                                             
                                                ji
                                             
                                          
                                       
                                    
                                 
                              
                              f
                              (
                              
                                 
                                    w
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              ,
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              g
                              (
                              
                                 
                                    q
                                 
                                 
                                    j
                                 
                              
                              |
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              Ψ
                              (
                              j
                              ,
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              )
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    j
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    j
                                 
                              
                              ]
                              ,
                           
                        
                     where 
                        
                           
                              
                                 I
                              
                              
                                 
                                    
                                       x
                                    
                                 
                              
                           
                           =
                           1
                        
                      if condition x is true and 0 otherwise.

Using Eqs. (5), (6) and (8), we restate Eq. (4) as
                        
                           (9)
                           
                              P
                              [
                              
                                 
                                    A
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              Ψ
                              (
                              i
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              
                                 
                                    
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                j
                                                =
                                                0
                                             
                                             
                                                i
                                                -
                                                2
                                             
                                          
                                       
                                       R
                                       (
                                       j
                                       ,
                                       i
                                       -
                                       1
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             ji
                                          
                                       
                                       )
                                       Θ
                                       (
                                       j
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             ji
                                          
                                       
                                       )
                                       +
                                       Θ
                                       (
                                       i
                                       -
                                       1
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             i
                                             -
                                             1
                                             ,
                                             i
                                          
                                       
                                       )
                                    
                                 
                              
                              .
                           
                        
                     Using Eqs. (3) and (9), we express the expected revenue of an priori tour with n customers as
                        
                           (10)
                           
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       n
                                    
                                 
                              
                              
                                 
                                    r
                                 
                                 
                                    i
                                 
                              
                              P
                              [
                              
                                 
                                    B
                                 
                                 
                                    i
                                 
                              
                              ⩽
                              
                                 
                                    Γ
                                 
                                 
                                    i
                                 
                              
                              ]
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       n
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             q
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             i
                                          
                                       
                                    
                                    
                                       
                                          
                                             γ
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                              
                                 
                                    r
                                 
                                 
                                    i
                                 
                              
                              Λ
                              (
                              i
                              ,
                              
                                 
                                    γ
                                 
                                 
                                    i
                                 
                              
                              )
                              f
                              (
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              g
                              (
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              Ψ
                              (
                              i
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                              ×
                              
                                 
                                    
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                j
                                                =
                                                0
                                             
                                             
                                                i
                                                -
                                                2
                                             
                                          
                                       
                                       R
                                       (
                                       j
                                       ,
                                       i
                                       -
                                       1
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             ji
                                          
                                       
                                       )
                                       Θ
                                       (
                                       j
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             ji
                                          
                                       
                                       )
                                       +
                                       Θ
                                       (
                                       i
                                       -
                                       1
                                       ,
                                       
                                          
                                             a
                                          
                                          
                                             i
                                          
                                       
                                       -
                                       
                                          
                                             c
                                          
                                          
                                             i
                                             -
                                             1
                                             ,
                                             i
                                          
                                       
                                       )
                                    
                                 
                              
                              .
                           
                        
                     
                  

To determine the computational complexity of Eq. (10), we first define the cardinality of the sets involved. Because customer i is skipped if 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           >
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                     , there are at most 
                        
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                        
                      possible arrival time realizations and we define 
                        
                           
                              
                                 n
                              
                              
                                 a
                              
                           
                           =
                           
                              
                                 max
                              
                              
                                 i
                              
                           
                           {
                           
                              
                                 τ
                              
                              
                                 i
                              
                           
                           }
                        
                     . Let 
                        
                           
                              
                                 n
                              
                              
                                 
                                    
                                       s
                                    
                                    
                                       i
                                    
                                 
                              
                           
                        
                      be the number of possible service time realizations at customer i based on 
                        
                           
                              
                                 s
                              
                              
                                 i
                              
                           
                        
                     ’s distribution, and define 
                        
                           
                              
                                 n
                              
                              
                                 s
                              
                           
                           =
                           
                              
                                 max
                              
                              
                                 i
                              
                           
                           {
                           
                              
                                 n
                              
                              
                                 
                                    
                                       s
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           }
                        
                     . Let 
                        
                           
                              
                                 n
                              
                              
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                              
                           
                        
                      be the number of possible queue length realizations given the arrival time 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      at customer i based on 
                        
                           g
                           (
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           )
                        
                      and define 
                        
                           
                              
                                 n
                              
                              
                                 q
                              
                           
                           =
                           
                              
                                 max
                              
                              
                                 i
                              
                           
                           {
                           
                              
                                 max
                              
                              
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           {
                           
                              
                                 n
                              
                              
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           }
                           }
                        
                     . As the value 
                        
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                        
                      is known given 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      and 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                     , we let 
                        
                           
                              
                                 n
                              
                              
                                 
                                    
                                       w
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                              
                           
                        
                      be the number of possible wait time realizations satisfying 
                        
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     , given the arrival time 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      and queue length 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                     . Then, we define 
                        
                           
                              
                                 n
                              
                              
                                 w
                              
                           
                           =
                           
                              
                                 max
                              
                              
                                 i
                              
                           
                           {
                           
                              
                                 max
                              
                              
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           {
                           
                              
                                 n
                              
                              
                                 
                                    
                                       w
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           }
                           }
                        
                     . Similarly, we let 
                        
                           
                              
                                 n
                              
                              
                                 
                                    
                                       w
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                              
                              
                                 ′
                              
                           
                        
                      be the number of possible wait time realizations satisfying 
                        
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                           >
                           
                              
                                 γ
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                     , given the arrival time 
                        
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                        
                      and queue length 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                     . Then, we define 
                        
                           
                              
                                 n
                              
                              
                                 w
                              
                              
                                 ′
                              
                           
                           =
                           
                              
                                 max
                              
                              
                                 i
                              
                           
                           {
                           
                              
                                 max
                              
                              
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                              
                           
                           {
                           
                              
                                 n
                              
                              
                                 
                                    
                                       w
                                    
                                    
                                       i
                                    
                                 
                                 |
                                 
                                    
                                       a
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       q
                                    
                                    
                                       i
                                    
                                 
                              
                              
                                 ′
                              
                           
                           }
                           }
                        
                      and 
                        
                           
                              
                                 n
                              
                              
                                 ws
                              
                           
                           =
                           max
                           {
                           
                              
                                 n
                              
                              
                                 w
                              
                           
                           
                              
                                 n
                              
                              
                                 s
                              
                           
                           ,
                           
                              
                                 n
                              
                              
                                 w
                              
                              
                                 ′
                              
                           
                           }
                        
                     .

The complexity of computing 
                        
                           Θ
                           (
                           j
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           )
                        
                      with Eq. (8) is 
                        
                           O
                           (
                           
                              
                                 n
                              
                              
                                 a
                              
                           
                           
                              
                                 n
                              
                              
                                 q
                              
                           
                           
                              
                                 n
                              
                              
                                 ws
                              
                           
                           )
                        
                     . The complexity of computing 
                        
                           R
                           (
                           j
                           ,
                           i
                           -
                           1
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           -
                           
                              
                                 c
                              
                              
                                 ji
                              
                           
                           )
                        
                      with Eq. (5) is 
                        
                           O
                           (
                           n
                           )
                        
                     . Therefore, the complexity of computing the expected revenue of an a priori tour by Eq. (10) is 
                        
                           O
                           (
                           
                              
                                 n
                              
                              
                                 2
                              
                           
                           
                              
                                 n
                              
                              
                                 a
                              
                              
                                 2
                              
                           
                           
                              
                                 n
                              
                              
                                 q
                              
                              
                                 2
                              
                           
                           
                              
                                 n
                              
                              
                                 w
                              
                           
                           
                              
                                 n
                              
                              
                                 ws
                              
                           
                           )
                        
                     , assuming 
                        
                           n
                           <
                           
                              
                                 n
                              
                              
                                 a
                              
                           
                           
                              
                                 n
                              
                              
                                 q
                              
                           
                           
                              
                                 n
                              
                              
                                 ws
                              
                           
                        
                      (which would be typical in a stochastic problem). In our computational study, we demonstrate the computational cost of exact evaluation of a an priori tour via Eq. (10). Further, we show that we can reduce the computational burden of repeatedly evaluating the objective function in our search algorithm by utilizing sampled wait time and queue lengths to estimated the expected revenue of an a priori tour (with little loss of accuracy versus the exact evaluation).

We apply a variable neighborhood search (VNS) heuristic to solve the SOPTW. For an overview of the VNS, see Hansen and Mladenovic (2003). Algorithm 1 outlines our VNS implementation, which is a variant of the algorithm used by Campbell et al. (2011) to solve an orienteering problem with stochastic travel and service times. Though having a different problem in terms of constraints and recourse actions, we are seeking a permutation of customers as is done in Campbell et al. (2011). The feasibility of tours in our problem is maintained by not allowing the salesperson to visit a customer outside the customer’s time window. VNS has been proven to be effective in finding near-optimal a priori tours in other routing problems Campbell et al. (2011) and Voccia et al. (2013).
                        Algorithm 1
                        Variable Neighborhood Search (VNS) 
                              
                                 
                                    
                                    
                                       
                                          
                                             1: Input: Data for an SOPTW instance, an ordered set of neighborhoods N
                                          
                                       
                                       
                                          
                                             2: Output: A SOPTW solution v
                                          
                                       
                                       
                                          
                                             3: 
                                                
                                                   v
                                                   ←
                                                   initialize
                                                   (
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             4: 
                                                
                                                   i
                                                   ←
                                                   0
                                                   ,
                                                   k
                                                   ←
                                                   1
                                                   ,
                                                   level
                                                   ←
                                                   0
                                                
                                             
                                          
                                       
                                       
                                          
                                             5: while 
                                             i
                                             <
                                             iterationMax or level
                                             <
                                             levelMax 
                                             do
                                          
                                       
                                       
                                          
                                             6:  
                                             
                                                
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   ←
                                                   Shake
                                                   (
                                                   v
                                                   ,
                                                   k
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             7:  
                                             
                                                
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ″
                                                      
                                                   
                                                   ←
                                                   VND
                                                   (
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             8:  
                                             if 
                                             
                                                
                                                   f
                                                   (
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ″
                                                      
                                                   
                                                   )
                                                   >
                                                   f
                                                   (
                                                   v
                                                   )
                                                
                                              
                                             then
                                          
                                       
                                       
                                          
                                             9:  
                                             
                                                
                                                   v
                                                   ←
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ″
                                                      
                                                   
                                                   ,
                                                   level
                                                   ←
                                                   0
                                                
                                             
                                          
                                       
                                       
                                          10: 
                                             else if 
                                             
                                                
                                                   k
                                                   =
                                                   |
                                                   N
                                                   |
                                                
                                              
                                             then
                                          
                                       
                                       
                                          11:  
                                             
                                                
                                                   k
                                                   ←
                                                   1
                                                   ,
                                                   level
                                                   ←
                                                   level
                                                   +
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          12: 
                                             else
                                          
                                       
                                       
                                          13:  
                                             
                                                
                                                   k
                                                   ←
                                                   k
                                                   +
                                                   1
                                                   ,
                                                   level
                                                   ←
                                                   level
                                                   +
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          14: 
                                             end if
                                          
                                       
                                       
                                          15: 
                                             
                                                
                                                   i
                                                   ←
                                                   i
                                                   +
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          16: end while
                                          
                                       
                                    
                                 
                              
                           
                        

Line 3 of Algorithm 1 initializes the search with a randomly-generated SOPTW solution. Line 5 states the termination criteria for the VNS. In addition to an iteration limit, the variable level is used to ensure that the algorithm performs at least levelMax iterations after finding an improved solution. We determine that setting 
                        
                           iterationMax
                           =
                           200
                        
                      and 
                        
                           levelMax
                           =
                           20
                        
                      results in robust performance. The Shake procedure in Line 6 returns 
                        
                           
                              
                                 v
                              
                              
                                 ′
                              
                           
                        
                     , a randomly selected neighbor of solution v from a neighborhood 
                        
                           k
                           ∈
                           N
                        
                     . Line 7 then applies a variable neighborhood descent (VND) procedure to this “shaken” solution 
                        
                           
                              
                                 v
                              
                              
                                 ′
                              
                           
                        
                      to obtain a locally-optimal solution 
                        
                           
                              
                                 v
                              
                              
                                 ″
                              
                           
                        
                     . Line 8 compares the newly-found local optimal solution to the incumbent solution using the function f, which evaluates a solution using Eq. (10) in Section 4 to determine the expected reward of a SOPTW solution. Lines 9–15 manage the updating of the current solution, the active neighborhood, and the iteration counters.

For the Shake procedure, we consider a set N that consists of three neighborhoods. The first and the second are 1-shift and 2-opt neighborhoods, respectively. The third neighborhood is based on the ruin-and-recreate principle (Schrimpf, Schneider, Stamm-Wilbrandt, & Dueck, 2000). As Campbell et al. (2011), we implement ruin and recreate by removing 
                        
                           min
                           {
                           n
                           ,
                           ⌊
                           ni
                           /
                           10
                           ⌋
                           }
                        
                      customers from a tour and randomly inserting them back into the tour, where n is the number of customers in the tour and i is the current iteration in the VNS algorithm.


                     Algorithm 2 describes the VND procedure we apply in Line 7 of Algorithm 1. The VND finds a locally-optimal solution relative to a set of specified neighborhoods 
                        
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                        
                     . The 1-shift and 2-opt neighborhoods compose 
                        
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                        
                      in our study. The BestNeighbor procedure in Line 5 returns the best solution in the neighborhood j of the current solution v. For computational efficiency, instead of evaluating solutions using Eq. (10) in Section 4 (as function f does in the Algorithm 1), Line 6 of Algorithm 2 evaluates solutions by sampling queue lengths and wait times to estimate the economic value collected from a tour Papapanagiotou et al. (2013), Evers et al. (2014). Lines 7–13 manage the updating of the locally optimal solution, the active neighborhood, and the variable count which ensures that all neighborhoods are explored from the current local optimum before terminating.
                        Algorithm 2
                        Variable Neighborhood Descent (VND) 
                              
                                 
                                    
                                    
                                       
                                          
                                             1: Input: A SOPTW solution v, an ordered set of neighborhoods 
                                                
                                                   
                                                      
                                                         N
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             2: Output: A locally optimal solution SOPTW v
                                          
                                       
                                       
                                          
                                             3: 
                                                
                                                   j
                                                   ←
                                                   1
                                                   ,
                                                   count
                                                   ←
                                                   1
                                                   ,
                                                   improving
                                                   ←
                                                   true
                                                
                                             
                                          
                                       
                                       
                                          
                                             4: while 
                                             improving 
                                             do
                                          
                                       
                                       
                                          
                                             5: 
                                             
                                                
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   ←
                                                   BestNeighbor
                                                   (
                                                   v
                                                   ,
                                                   j
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             6: 
                                             if 
                                             
                                                
                                                   g
                                                   (
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   )
                                                   >
                                                   g
                                                   (
                                                   v
                                                   )
                                                
                                             
                                          
                                       
                                       
                                          
                                             7: 
                                             
                                                
                                                   v
                                                   ←
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   ,
                                                   count
                                                   ←
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          
                                             8: 
                                             else if 
                                             
                                                
                                                   j
                                                   =
                                                   |
                                                   
                                                      
                                                         N
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   |
                                                
                                              and 
                                                
                                                   count
                                                   <
                                                   |
                                                   
                                                      
                                                         N
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   |
                                                
                                              
                                             then
                                          
                                       
                                       
                                          
                                             9: 
                                             
                                                
                                                   j
                                                   ←
                                                   1
                                                   ,
                                                   count
                                                   ←
                                                   count
                                                   +
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          10: 
                                             else if 
                                             
                                                
                                                   j
                                                   <
                                                   |
                                                   
                                                      
                                                         N
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   |
                                                
                                              and 
                                                
                                                   count
                                                   <
                                                   |
                                                   
                                                      
                                                         N
                                                      
                                                      
                                                         ′
                                                      
                                                   
                                                   |
                                                
                                              
                                             then
                                          
                                       
                                       
                                          11: 
                                             
                                                
                                                   j
                                                   ←
                                                   j
                                                   +
                                                   1
                                                   ,
                                                   count
                                                   ←
                                                   count
                                                   +
                                                   1
                                                
                                             
                                          
                                       
                                       
                                          12: 
                                             else
                                          
                                       
                                       
                                          13: 
                                             
                                                
                                                   improving
                                                   ←
                                                   false
                                                
                                             
                                          
                                       
                                       
                                          14: 
                                             end if
                                          
                                       
                                       
                                          15: end while
                                          
                                       
                                    
                                 
                              
                           
                        

In this section, we discuss the generation of our data sets. In the absence of detailed industry data, we use a discrete-event simulation to generate queue length and wait time distributions. We also describe how we modify existing benchmark problems to suit our SOPTW.

We develop a discrete-event simulation using the Arena 14.00.00 software package to generate data to construct the transient queue length and wait time distributions. Because of the relatively short interval of time in which representatives work, steady-state distributions are not applicable. While we were unable to identify an industry partner who collected the detailed data required by our model, interviews with an anonymous industry expert guided our choice of parameters.

In the simulation, salespeople arrive at a doctor with exponentially distributed inter-arrival times with a mean of 15minutes. Sales representatives are aware that the effectiveness of their visit may degrade if it occurs at the end of a long sequence of sales calls as the doctor experiences “representative fatigue”. Consequently, in our data generation we assume that a competing salesperson will balk after arriving if there are five or more other salespeople already waiting in the queue. Otherwise, the competing salesperson will join the queue. As is mentioned by our industry partner, a representative usually considers reneging after she has been waiting for 30minutes but meet the doctor. To capture this behavior, we assume that a competing salesperson j will renege if she has waited 
                           
                              
                                 
                                    u
                                 
                                 
                                    j
                                 
                              
                           
                         minutes and is not first in the queue, where 
                           
                              
                                 
                                    u
                                 
                                 
                                    j
                                 
                              
                           
                         is a uniformly distributed random variable between 30 and 40. Our sales representative, the decision-maker in our model, does not follow these industry-based rules-of-thumb, but rather implements the recourse actions discussed in Section 3 to improve performance. We set the service time to a constant of 10minutes as salespeople tend to have brief, rehearsed sales pitches. Based on our interviews with an industry expert, we set the amount of time between a doctor finishing a meeting with one representative and starting with another salesperson as uniformly distributed between 0 and 60minutes. This period accounts for the time that the doctor spends with other job-related tasks in between meetings with sales representatives.

We execute the discrete-event simulation over five hours of simulated time. Salespeople arrive throughout the five-hour run, but the doctor does not begin processing arrivals until after the first hour. This structure mimics the situation in which salespeople arrive early (often waiting in the clinic parking lot or lobby). The four-hour block during which the doctor meets with salespeople corresponds to the widest time window we consider in our data sets and is based on the observation that doctors often allow sales visits in either a four-hour block in the morning or afternoon.

For each arrival, we record the arrival time and the queue length observed upon arrival. For each salesperson meets with the doctor, we record the wait time that preceded the meeting. To generate the distribution of queue length, we compute the relative frequencies of queue lengths corresponding to each five-minute arrival time interval over the simulation run. The queue length distribution is used together with each doctor’s time window information to construct empirical queue length distributions given arrival time, 
                           
                              g
                              (
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                           
                        .

Similarly, we compute the relative frequency of wait times (expressed in five-minute intervals) corresponding to each possible queue length to generate the distribution of wait times. We use the wait time distribution with customers’ time window information to construct the empirical wait time distributions given queue length and arrival time, 
                           
                              f
                              (
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    q
                                 
                                 
                                    i
                                 
                              
                              ,
                              
                                 
                                    a
                                 
                                 
                                    i
                                 
                              
                              )
                           
                         for each doctor.

The data for these queue length and wait time distributions are available via the University of Iowa’s digital repository at http://ir.uiowa.edu/tippie_pubs/61/.

We derive our SOPTW data sets from Solomon’s VRPTW instances (Solomon, 1987). We modify Solomon’s R, C and RC benchmark instances, which correspond to randomly located customers, clustered customers, and a mix of random and clustered customers, respectively. According to the interviews with pharmaceutical sales representatives, in an urban area, a representative could spend a whole morning meeting five to six physicians at a hospital, while in rural area, the representative on average visits five doctors/physicians during a day. We select the first 20 customers from Solomon’s instances as this corresponds to the largest number of doctors that a sales representative would consider when devising her daily schedule. We maintain each customer’s location and demand information while modifying each customer’s time window. Our first step in modifying the time windows was to scale time from the 1000 time-unit day to a 540-minute day, [0,540], which corresponds to an 8A.M. to 5P.M. work day. If the resulting time window is less than 240minutes wide, then it is complete. If the resulting time window exceeded 240minutes, it was truncated to 240minutes and re-positioned to either [0,240] or [300,540] (choice made randomly). Thus, the maximum time window width is 240minutes, and 240-minute time windows correspond to cases in which doctors have set aside a morning or afternoon during which they may meet with representatives in between handling other work obligations (seeing patients, paperwork, and other tasks). Our SOPTW data sets are as well available at http://ir.uiowa.edu/tippie_pubs/61/.

In this section we describe a deterministic orienteering problem with time windows which we use to help determine the value of explicitly modeling stochasticity in the SOPTW. We describe a dynamic programming approach to solve this deterministic problem. By solving the deterministic problem with appropriate sets of input data, we obtain lower and upper bounds for the SOPTW.

In a deterministic instance of an orienteering problem with time windows, we assume that given the arrival time at customer i, a queue length 
                        
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                        
                     , wait time 
                        
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                        
                     , and service time 
                        
                           
                              
                                 s
                              
                              
                                 i
                              
                           
                        
                      are known with certainty. Let 
                        
                           
                              
                                 N
                              
                              
                                 v
                              
                           
                        
                      denote the set of customers visited in a tour. The objective of the problem can be represented as 
                        
                           
                              
                                 ∑
                              
                              
                                 i
                                 ∈
                                 
                                    
                                       N
                                    
                                    
                                       v
                                    
                                 
                              
                           
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                           I
                           (
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           )
                        
                     , where 
                        
                           I
                           (
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           )
                        
                      equals 1 if 
                        
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                           ⩽
                           
                              
                                 l
                              
                              
                                 i
                              
                           
                        
                      and 0 otherwise.

We modify the dynamic programming solution approach proposed by Feillet, Dejax, Gendreau, and Gueguen (2004) to solve this deterministic problem as an elementary longest path problem with resource constraints. The dynamic program is formulated as follows. Let N represent the set of vertices visited prior to node i and including node i. Let R be the sum of the rewards collected from all nodes 
                        
                           k
                           ∈
                           N
                        
                     . Use L to denote the departure time from node i. We represent a state as (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ). For a state (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ), we can either travel from node i to a node j (
                        
                           j
                           ∈
                           {
                           V
                           ⧹
                           N
                           }
                        
                     ) or end the tour. Traveling from node i to node j results in a transition from a state (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ) to a state (
                        
                           j
                           ,
                           N
                           ∪
                           j
                           ,
                           R
                           +
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           ,
                           L
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                           +
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                        
                     ). The reward 
                        
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                        
                      collected from customer j equals 0 if the representative cannot start a meeting with customer j before his/her time window ends (i.e. 
                        
                           
                              
                                 a
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           >
                           
                              
                                 l
                              
                              
                                 j
                              
                           
                        
                     ). Therefore, in our problem, we do not update a state (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ) to a state (
                        
                           j
                           ,
                           N
                           ∪
                           j
                           ,
                           R
                           +
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           ,
                           L
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                           +
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                        
                     ) if 
                        
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           =
                           0
                        
                     .

Let 
                        
                           
                              
                                 Ξ
                              
                              
                                 i
                              
                           
                        
                      denote the set of states associated with node i, where each state corresponds to a path from the depot to node i. For each state 
                        
                           (
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                           )
                           ∈
                           
                              
                                 Ξ
                              
                              
                                 i
                              
                           
                        
                     , consider each of its successors (
                        
                           j
                           ,
                           N
                           ∪
                           j
                           ,
                           R
                           +
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           ,
                           L
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                           +
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                        
                     ). If 
                        
                           j
                           ∈
                           {
                           V
                           ⧹
                           N
                           }
                        
                      and 
                        
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           >
                           0
                        
                     , the path from the depot to node i can be extended to node j, thus the state (
                        
                           j
                           ,
                           N
                           ∪
                           j
                           ,
                           R
                           +
                           
                              
                                 r
                              
                              
                                 j
                              
                           
                           ,
                           L
                           +
                           
                              
                                 c
                              
                              
                                 ij
                              
                           
                           +
                           
                              
                                 w
                              
                              
                                 j
                              
                           
                           +
                           
                              
                                 s
                              
                              
                                 j
                              
                           
                        
                     ) is added to the states set 
                        
                           
                              
                                 Ξ
                              
                              
                                 j
                              
                           
                        
                     . The dynamic program begins with the state (
                        
                           0
                           ,
                           0
                           ,
                           0
                           ,
                           0
                        
                     ), where node 0 is the depot, and ends when all states in each set 
                        
                           
                              
                                 Ξ
                              
                              
                                 i
                              
                           
                        
                      have been examined.

A dominance relation can be defined for two states if they differ in only departure time and the sum of rewards. Consider two states (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ) and (
                        
                           i
                           ,
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 R
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 L
                              
                              
                                 ′
                              
                           
                        
                     ) associated with node i. The state (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ) dominates the state (
                        
                           i
                           ,
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 R
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 L
                              
                              
                                 ′
                              
                           
                        
                     ) if 
                        
                           L
                           ⩽
                           
                              
                                 L
                              
                              
                                 ′
                              
                           
                        
                      while 
                        
                           N
                           =
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                        
                      and 
                        
                           R
                           =
                           
                              
                                 R
                              
                              
                                 ′
                              
                           
                        
                     . The state (
                        
                           i
                           ,
                           N
                           ,
                           R
                           ,
                           L
                        
                     ) dominates the state (
                        
                           i
                           ,
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 R
                              
                              
                                 ′
                              
                           
                           ,
                           
                              
                                 L
                              
                              
                                 ′
                              
                           
                        
                     ) if 
                        
                           R
                           >
                           
                              
                                 R
                              
                              
                                 ′
                              
                           
                        
                      when 
                        
                           N
                           =
                           
                              
                                 N
                              
                              
                                 ′
                              
                           
                        
                      and 
                        
                           L
                           =
                           
                              
                                 L
                              
                              
                                 ′
                              
                           
                        
                     . For each state set 
                        
                           
                              
                                 Ξ
                              
                              
                                 i
                              
                           
                        
                     , we consider only non-dominated states. The dominance relation improves the computational efficiency of the dynamic program by discarding dominated states. Also, as discussed earlier, our dynamic program never extends a path to a node if no reward can be collected from that node.

To establish a lower bound on an instance of the SOPTW with random variables 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                      and 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                     , we consider a corresponding deterministic instance in which, given the arrival time at customer i, the queue length and wait time are set equal to the expectations, 
                        
                           E
                           [
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                      and 
                        
                           E
                           [
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 q
                              
                              
                                 i
                              
                           
                           ,
                           
                              
                                 a
                              
                              
                                 i
                              
                           
                           ]
                        
                     , respectively. As was discussed in the distribution generation, the service time is set to be 10minutes. The deterministic dynamic program generates a sequence of customers which, based on the expected wait times, can be visited within the respective time windows. We refer to this sequence as the original tour. We append the original tour with the set of unvisited customers in order of ascending time window closures and refer to the resulting tour as the deterministic tour. Evaluating the deterministic tour using Eq. (10) provides a lower bound for the SOPTW instance under consideration.

We establish an empirical upper bound on an instance of the SOPTW with random variables 
                        
                           
                              
                                 Q
                              
                              
                                 i
                              
                           
                        
                      and 
                        
                           
                              
                                 W
                              
                              
                                 i
                              
                           
                        
                      by treating each of the 1000 samples used by the VND (Algorithm 2) as deterministic input to the dynamic programming algorithm of Section 7. The reported upper bound is the average of the perfect information solutions over 1000 samples.

We discuss the implementation of computational experiments in Section 8.1 and present corresponding results in Section 8.2. We describe setting values of 
                        
                           
                              
                                 r
                              
                              
                                 ̃
                              
                           
                        
                      and 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                        
                      to execute the recourse actions. As discussed in Section 3, 
                        
                           
                              
                                 r
                              
                              
                                 ̃
                              
                           
                        
                      and 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                        
                      indicate the minimum expected reward for which the representative is willing to travel to a customer and to wait at a customer, respectively. We then test the quality of VNS by comparing heuristic solutions to optimal solutions of instances with 10 customers, which are the largest instances for which we could obtain optimal solutions (via enumeration). We also use these 10-customer instances to evaluate the quality of the lower bounds and empirical upper bounds described in Section 7. We examine the effectiveness of using sampling in approximating the objective evaluation versus analytical evaluation via Eq. (10). Finally we compare the SOPTW solutions to the lower and upper bounds described in Section 7.

@&#IMPLEMENTATION@&#

The VNS and the deterministic dynamic programming approach from Section 7 are programmed in C++ and implemented on a Intel Core i7 processor with 3.4GHz and 16GB of RAM. We execute the VNS 10 times for each instance and evaluate the expected objective using Eq. (10) derived in Section 4. For each SOPTW solution, we report the average expected objective of the 10 runs. In the execution of an a priori tour, we assume that the sales representative can arrive at the first customer as early as she wants. That is, the tour effectively starts at the first customer rather than at a depot. In our data sets, this implies the representative arrives at the first customer one hour before the customer’s time window opens.

To investigate the setting of 
                           
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                           
                         and 
                           
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                           
                        , we first run the VNS with different pairs of 
                           
                              (
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                              ,
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                              )
                           
                         on the R, C and RC instances described in Section 6.2. We test with both 
                           
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                           
                         and 
                           
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                           
                         values ranging from 0 to 
                           
                              
                                 
                                    min
                                 
                                 
                                    i
                                 
                              
                              {
                              
                                 
                                    r
                                 
                                 
                                    i
                                 
                              
                              }
                           
                         and consider an increment in each parameter as small as 0.25 (i.e., we consider the values of 0, 0.25, 0.5, …, 
                           
                              
                                 
                                    min
                                 
                                 
                                    i
                                 
                              
                              {
                              
                                 
                                    r
                                 
                                 
                                    i
                                 
                              
                              }
                           
                         for 
                           
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                           
                         and 
                           
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                           
                        , respectively). For various values of 
                           
                              (
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                              ,
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                              )
                           
                        , we compare the expected reward collected by the best-found tour (averaged over 10 VNS runs per instance). The results in the Online Supplement demonstrate that it is challenging to find a universal value of the 
                           
                              (
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                              ,
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                              )
                           
                         pair. There is no single pair of 
                           
                              (
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                              ,
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                              )
                           
                         that dominates all others for each instance. However, (0.25,1), (2,6) and (0.5,0.5) give the best average over all R, C and RC instances, respectively. Therefore, we use them in the following experiments for SOPTW solutions. For the lower bound, the deterministic solutions are evaluated using the same value of 
                           
                              (
                              
                                 
                                    r
                                 
                                 
                                    ̃
                                 
                              
                              ,
                              
                                 
                                    r
                                 
                                 
                                    ˇ
                                 
                              
                              )
                           
                         as are used in obtaining the corresponding SOPTW solutions.

As a preliminary test of the quality of the VNS heuristic, we execute it on 10-customer R, C and RC instances, which are the largest instances we could solve optimally via enumeration. The VNS heuristic (using sampling) obtains the optimal solution in 42 of the 56 instances, with average optimality gaps for R, C and RC instances of 0.2%, 0.01% and 0.02%, respectively. We note that these small gaps are typically due to the sampling and executing the VNS heuristic with the analytical objective evaluation in Eq. (10) eliminates the gap. We also use these 10-customer instances to compare the lower bounds and empirical upper bounds to the optimal solutions. We observe that the lower bounds are on average 5.6%, 8.0%, and 7.2% less than the optimal solutions and the upper bounds are on average 11.8%, 13.2%, and 11.6% greater than the optimal solutions for R, C and RC instances, respectively. We provide more detailed results in Online Supplement to the paper.

To demonstrate the effectiveness of approximating objective function via sampling, we compare the performance of sample-based VNS to VNS using Eq. (10) in evaluating objective. For the 20-customer R, C, and RC instances, the optimal solutions obtained with Eq. (10) are on average 0.05%, 0.06%, and 0.14% better than those obtained with sampling, respectively. However, the computational time increases dramatically from an average of around 12minutes for using sampling to an average of around 6hours for using exact objective function. Thus, we focus the rest of our presentation on the results from runs using sampling and provide the detailed results for the exact objective evaluations in the Online Supplement.

@&#RESULTS@&#


                        Tables 1–3
                        
                        
                         compare the expected reward collected by the a priori tours obtained by the VNS heuristic to the bounds. The upper and lower bounds are obtained in the manner discussed in Section 7. In each of the three tables, the second, third and fourth columns report the lower bounds, the averaged expected objectives of SOPTW over parameter sets discussed above, and the upper bounds, respectively. The fifth column shows the gap between the lower bound and the SOPTW (
                           
                              Gap
                              
                              L
                              =
                              
                                 
                                    SOPTW
                                    -
                                    LB
                                 
                                 
                                    LB
                                 
                              
                              ×
                              100
                              %
                           
                        ) and the sixth column shows the gap between the upper bound and the SOPTW (
                           
                              Gap
                              
                              U
                              =
                              
                                 
                                    UB
                                    -
                                    SOPTW
                                 
                                 
                                    UB
                                 
                              
                              ×
                              100
                              %
                           
                        ). The runtime for solving a deterministic version of the problem is trivial, less than one second in most cases. The average runtime over the 10 VNS runs for each instance is reported in the last column of the tables, where parameters in the VNS are set as discussed in Section 5.

On average, the stochastic solutions are around 9.2% better than the lower bound for all datasets. Specifically, the average gap between the stochastic solutions and the lower bounds of Solomon’s C instances is 10.2%, which is slightly larger than that of the RC (8.9%) and R instances (8.4%). In some cases, the improvement is significant, with the largest improvement in R-instances being 22.7%, 20.8% for the C-instances, and 21.5% for the RC-instances.

For instances R105, R209, C105, C108 and C205 the gaps between SOPTW solutions and lower bounds are quite small. There does not seem to be a clear factor underlying the differences. For example, we find that instances R105, C105, C108 and C205 have narrow time windows, while this is not the case for R209. Admittedly, factors such as a customer’s location, expected economic value, and traveling distances between customers also has impact on the structure of a solution.

The advantage of a SOPTW solution over the deterministic solution using expected values is that a SOPTW solution inserts customers early in the sequence that, while unlikely to be visited, can be considered with a favorable realization of queue lengths and waiting times at preceding customers. In contrast, the deterministic solution using expected values will only sequence the customers guaranteed to be visited using the expected wait times (the remaining customers are appended in increasing order of 
                           
                              
                                 
                                    l
                                 
                                 
                                    i
                                 
                              
                           
                        ).

To see this, we examine the structure of both the deterministic (lower bound) and the stochastic solutions for instances R202 and R209 in Tables 4 and 5
                        
                        . The first column in both tables presents the deterministic solution, the second column is the time window for each customer and the third column shows the probability of collecting a reward from a customer, which is computed via Eq. (10) in Section 4. Similarly, the fourth, fifth and sixth columns in both tables present the SOPTW solution, the time window and the probability of collecting a reward from a customer, respectively.

For instance R202, the original deterministic tour is 
                           
                              (
                              0
                              ,
                              5
                              ,
                              14
                              ,
                              18
                              ,
                              10
                              ,
                              13
                              ,
                              12
                              )
                           
                        . The deterministic solution presented in the table consists of both the original tour and the appended customers. We can see that, in the deterministic solution, a reward is more likely to be collected from customers 5, 14, 18, 10, 13, and 12 than from others. Using the average queue lengths and wait times, these customers will be visited with certainty. In the stochastic solution, customers 5 and 14 are still visited early in the sequence (although in reversed order), but customer 10 is moved to the end of the sequence. Furthermore, customers 13 and 12 have been moved later in the sequence as well, but actually have a larger probability of being visited than they do in the sequence from the deterministic solution. This occurs because customers 3, 9, 8, 1, and 6 have been inserted earlier in the tour (and each of these customers has a relatively low probability of being visited implying that they will often be skipped or balked at, but having the option to visit them is beneficial if there is a favorable realization of queue length and wait time).

For instance R209, the situation is similar. The original deterministic tour is 
                           
                              (
                              0
                              ,
                              5
                              ,
                              13
                              ,
                              14
                              ,
                              10
                              ,
                              1
                              ,
                              4
                              )
                           
                        . As demonstrated in Table 5, for both the deterministic and stochastic solutions, customers 5, 13, 14, 10, 1 and 4 have greater chances to provide a reward than other customers. In the stochastic tour, however, customers 16, 19, 12, 17 and 11, which are less likely to provide a reward, are inserted earlier in the tour to take advantage of favorable realizations in which they can be visited.

The average gaps between the SOPTW solutions and the upper bounds for the R, C and RC instances are 25.6%, 25.5% and 27.8%, respectively. The upper bound gaps are large in general, which suggests the looseness of the perfect information bounds. There does not exist a discernible cause for the magnitude of any particular gap. Among the R instances, the largest upper bound gap is 29.6% from instance R107 and the smallest is 17.4% from instance R101. R101 has the smallest average time window width over all R instances while R107’s is neither the smallest or the largest. Among the C instances, the largest upper bound gap is 31% from instance C102 and the smallest is 14.8% from instance C101. Instance C101 has the second smallest average time window width over all C instances while C102 has neither the smallest or the largest. For the RC instances, the largest upper bound gap is 32.6% from RC208, the instance with the largest average time window width. The smallest upper bound gap is 23.2% from RC103, whose average time window width is neither the largest nor the smallest.

Recall that we motivate consideration of 20-customer data sets as this size of problem corresponds to an upper bound on the number of doctors that a sales representative would be able to visit in a day. That is, we assume that the sales representative identifies a set of 20 customers on which to base her a priori itinerary. For sake of comparison, we also consider 40-customer R, C, and RC instances and present the detailed results in the Online Supplement. On average, the numbers of customers having at least 0.01 visit probability are 10, 12 and 9 for the 40-customer R, C and RC instances, respectively. In the 20-customer R, C, and R instances, the average numbers of customers with at least 0.01 visit probability are 9, 11 and 10, respectively. This demonstrates that considering larger data sets only potentially impacts which customers are visited and not the number of customers visited.

Motivated by the daily routing problem faced by a pharmaceutical representative, we introduce a stochastic orienteering problem with time windows (SOPTW) characterized by stochastic wait times as well as a time window for each customer. Specifically, the wait time a representative encounters depends on the queue lengths observed when the representative arrives at a doctor’s office. In the development of a priori tours, we consider two types of recourse actions. The first recourse action determines whether or not to skip a customer on an a priori tour based on the arrival time at that customer. The second recourse action determines how long a representative should wait at a customer after arriving and observing a queue. These recourse actions are addressed in the analytical formula that we derive to compute the expected reward for an a priori tour.

We solve the SOPTW via a VNS heuristic and compute lower and upper bounds on the solution. We obtain the lower bound by solving a deterministic version in which wait times and queue lengths are set to their expectations. We also obtain an upper bound for an a priori tour expected rewards by solving the deterministic problem with perfect information. From our computational results, we find that the SOPTW solutions perform about 9.2% better than the lower bound and about 26.3% worse than the upper bound. The SOPTW solution’s 9.2% average improvement over the deterministic approach using expected queue lengths and wait times as well as the difference in the tour sequences suggest the merit in considering uncertainty in this problem.

One future research direction is to investigate dynamic policies for the SOPTW. For the first recourse action proposed in the paper, we allow skipping of a customer, but never allow resequencing of customers. A dynamic routing policy would allow resequencing based on realized events. For the second recourse action, we employ an action that determines the longest amount of time a representative will wait based on the queue length upon arrival. A dynamic policy would allow the sales representative to consider the “stay in queue or depart for next customer” decision at each time epoch based on the current queue length. Our results motivate the investigation of dynamic policies in two ways. First, the gaps between our a priori results and the upper bounds suggest that there may be potential to improve the rewards by taking explicit advantage of realizations. Second, there does not seem to be universal settings of 
                        
                           
                              
                                 r
                              
                              
                                 ̃
                              
                           
                        
                      and 
                        
                           
                              
                                 r
                              
                              
                                 ˇ
                              
                           
                        
                      for the recourse actions that result in effective static rules. Thus, dynamically determining when to leave a customer and adapting the tour based on the observed realizations may result in improved performance.

Secondly, this study is limited to a one-day planning horizon. A routing strategy of a longer planning horizon is applicable in real-world situations where the pharmaceutical sales representative needs to develop a weekly or monthly schedule of doctor visits. Finally, in this paper, we focus on application to the pharmaceutical industry. We leave as future work the consideration of other domains in which the logistics of managing customer relationships is important. For example, in the textbook industry, representatives can leave and return to a customer depending on the observed line length, adding further complexity to the routing problem.

Supplementary data associated with this article can be found, in the online version, at http://dx.doi.org/10.1016/j.ejor.2014.04.040.


                     
                        
                           
                        
                     
                  

@&#REFERENCES@&#

