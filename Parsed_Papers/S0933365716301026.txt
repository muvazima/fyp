@&#MAIN-TITLE@&#Defocus-aware Dirichlet particle filter for stable endoscopic video frame recognition

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           We propose a method for smoothing recognition results of NBI endoscopic video frames.


                        
                        
                           
                           It is robust to defocused frames by using defocus information extracted from frames.


                        
                        
                           
                           We develop a particle filter with the Dirichlet distribution.


                        
                        
                           
                           The Rayleigh distribution is used for the defocus information and the likelihood.


                        
                        
                           
                           Experimental results are shown with synthetic and real NBI endoscopic videos.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Particle filter

Dirichlet distribution

Defocus information

Endoscopy

Colorectal cancer

@&#ABSTRACT@&#


               
               
                  Background and objective
                  A computer-aided system for colorectal endoscopy could provide endoscopists with important helpful diagnostic support during examinations. A straightforward means of providing an objective diagnosis in real time might be for using classifiers to identify individual parts of every endoscopic video frame, but the results could be highly unstable due to out-of-focus frames. To address this problem, we propose a defocus-aware Dirichlet particle filter (D-DPF) that combines a particle filter with a Dirichlet distribution and defocus information.
               
               
                  Methods
                  We develop a particle filter with a Dirichlet distribution that represents the state transition and likelihood of each video frame. We also incorporate additional defocus information by using isolated pixel ratios to sample from a Rayleigh distribution.
               
               
                  Results
                  We tested the performance of the proposed method using synthetic and real endoscopic videos with a frame-wise classifier trained on 1671 images of colorectal endoscopy. Two synthetic videos comprising 600 frames were used for comparisons with a Kalman filter and D-DPF without defocus information, and D-DPF was shown to be more robust against the instability of frame-wise classification results. Computation time was approximately 88ms/frame, which is sufficient for real-time applications. We applied our method to 33 endoscopic videos and showed that the proposed method can effectively smoothen highly unstable probability curves under actual defocus of the endoscopic videos.
               
               
                  Conclusion
                  The proposed D-DPF is a useful tool for smoothing unstable results of frame-wise classification of endoscopic videos to support real-time diagnosis during endoscopic examinations.
               
            

@&#INTRODUCTION@&#

Colorectal endoscopy (or colonoscopy), i.e. endoscopic examination using a narrow-band imaging (NBI) system, is widely used to diagnose colorectal cancer [1]. A computer-aided diagnosis system for colonoscopy would be an extremely helpful tool for supporting diagnosis during examinations. Processing a video stream plays an important role in providing such support because endoscopists typically specify the region of a tumor and capture a video frame to diagnose the tumor's condition. However, intra/inter-observer variability [2–4] shows that diagnosis can be subjective and depends on the endoscopist's experience. Hence, a computer-aided system that provides an objective measure for diagnosis on a screen would be of great assistance [5]. One straightforward means of providing an objective real-time diagnosis might be frame-wise classification, i.e., using a machine-learning-based classifier trained off-line with training image patches to recognize a part of every endoscopic video frame and showing classification results (labels or probabilities) on a screen. However, the problem then arises that we do not see when we independently classify training image patches. Fig. 1
                      shows a typical result obtained from a frame-wise classification with three classes. The three curves of posterior probabilities represent the classification results of every frame and are shown to visualize the confidence of the classifier. Although this video sequence continues to capture the same tumor, the classification results are highly unstable, and it would be difficult for endoscopists to understand the output during an examination.

One of the principal causes for this instability is scene blur, or defocus, due to the narrow depth of field (see Fig. 2
                     ). Since operating an endoscope requires expert skill, and the intestinal wall continues moving, it is difficult to maintain focus on a tumor for a long time. Features extracted from defocused frames cause unstable results because the classifier has not been trained with such features. Our preliminary experiments also demonstrate that classifying defocused image patches performs worse than classifying well-focused ones (see Section 5.2). Removing defocused frames from a video stream [7] would not be helpful in such an application because results on the screen would frequently stop or disappear.

To overcome this problem, we propose a method for smoothing probability curves, or sequences of posterior probabilities, such as those shown in Fig. 1, by incorporating information representing the degree of defocus from each frame in the framework of particle filtering with a Dirichlet distribution [8]. We call the proposed method the defocus-aware Dirichlet particle filter (D-DPF). There are two reasons why we need to develop our own method for smoothing probability curves.

First, smoothing techniques use only given signals; therefore, it is difficult to recover from failures in frame-wise classification owing to the defocus of frames. In such a case, it is reasonable to use additional information which represents defocus of each frame; smoothing results tend to follow the observation of the current frame if the frame is in focus, and to keep the results from the previous frames otherwise. Our proposed method uses isolated pixel ratio (IPR) (see Section 4.2.1) as defocus information in the likelihood of the particle filter so as to show the confidence of the classification result at each frame.

Second, smoothed results obtained by existing smoothing methods must typically be renormalized at each frame to sum to one, leading to inconsistency between frames as this has no probabilistic significance. Our system outputs confidence values at each frame, i.e., posterior probabilities for the results when classifying a patch in each frame into three classes (type A, B, and C3), on the basis of NBI magnification findings 
                     [9,4] (see Section 2.1). Therefore, we developed a probabilistic framework with a particle filter to perform “smoothing of probabilities” using the Dirichlet distribution (see Section 3.2) in such a way that defocus information is incorporated.

The remainder of this paper is organized as follows. Section 2 reviews the relevant medical background regarding colorectal cancer, NBI magnification findings, and related work. We formulate the problem as a particle filter with a Dirichlet distribution in Section 3. Section 4 introduces additional defocus information into the likelihood of the particle filter. Section 5 shows several experimental results using real and synthetic data. We conclude the paper in Section 6.

Colorectal cancer is one of the major causes of cancer related deaths worldwide [10]. Colonoscopy is the most popular and widely used inspection method for such cancer. During colonoscopy, endoscopists observe a tumor displayed on a monitor to determine whether treatment and resection are necessary. Recently, the development of NBI [11–13] has enabled endoscopists to perform examinations in less time. NBI enables the enhancement of microvessel structures by using two light sources of specific wavelengths that are absorbed by hemoglobin in the blood vessels. NBI magnification findings have been proposed as a diagnostic criterion by the Hiroshima University Hospital [9,4], which categorizes appearances of tumors into types A, B, and C, with type C further subclassified into C1, C2, and C3 on the basis of microvessel structures (see Fig. 3
                        ). Based on the NBI magnification findings, Tamaki et al. [6] proposed a recognition method that classifies NBI images into three types, A, B, and C3.
                           1
                        
                        
                           1
                           The reason to exclude types C1 and C2 is the inherent difficulty to distinguish between subtypes C1, C2, and C3 due to large inter/intra-observer variability [4]. Therefore a poor classification performance is obtained for a five-class classification problem (see [6] for details).
                        
                     

Tamaki et al. [6] proposed a prototype computer-aided diagnosis system for NBI endoscopy image patches. They used the bag-of-visual words (BoW) framework with a scale invariant feature transform (SIFT), followed by support vector machine (SVM) classifiers. In their experiments, they achieved a recognition rate of 96% on 908 NBI image patches with 10-fold cross validation. Through the use of this method, a frame-wise classification for NBI videoendoscopy, which classifies a part of each endoscopic video frame in a frame-by-frame manner, could be developed. One instance of such frame-wise classification is shown in Fig. 1, which is unstable as mentioned above. In order to make the classification results stable over time, in this paper we propose a method for smoothing sequences of the frame-wise classification results.

@&#RELATED WORK@&#

Polyp detection has been the most widely performed and studied task in colorectal videoendoscopy in the past two decades. Maroulis et al. [14] proposed a detection system of colorectal lesions in endoscopic videos using neural networks, and Karkanis et al. [15] used color wavelet features. There have also been various other efforts [16–19].

Surprisingly, classification of endoscopic videos has been scarcely investigated. One possible reason might be that a frame-wise classification could be developed by simply applying patch-based classification to video streams frame by frame. In fact, many patch-based classification methods for endoscopic images have been proposed for pit-pattern [20–32] and NBI-endoscopic images [33–35,6]. Such a simple application of frame-wise classification to video frames was proposed by Manivannan et al. [36]. They classified video frames into normal and abnormal using patch statistics and Gaussian scale-space.

Later, they proposed a video-specific SVM (V-SVM), training with video frames to independently classify images or frames [37]. This approach involves the following problems. First, each video frame must have a label assigned by endoscopists, which is a very expensive task. Second, an endoscopic video frame contains many unnecessary parts such as dark background, defocused parts, and highlights. Therefore, using entire frames for learning would lead to a deterioration of classification performance. Third, training a classifier with an entire video is more expensive than training with image patches. Selecting representative image patches is much more efficient when training a classifier or constructing a training dataset. Hence, we employ a more practical strategy–smoothing as post-processing of a frame-wise classification.

Several methods have been proposed to detect and exclude defocused frames from endoscopic videos. Oh et al. [7] attempted to classify video frames into informative and non-informative ones. They proposed two methods, i.e., edge- and clustering-based methods. As an edge-based method, they apply a Canny edge detector to each frame and calculate the IPR, the ratio of isolated edge pixels to all edge pixels. They then classify each frame by thresholding the IPR. As a clustering-based method, they extract seven texture features from gray-level co-occurrence matrices of discrete Fourier transform magnitude images and then classify each frame by k-means clustering. To detect indistinct frames, Arnold et al. [38] used the L
                        2-norm of the detail coefficients of a wavelet conversion. Liu et al. [39] proposed robust tracking by detecting and discarding endoscopic video frames that lack features useful to track by using the blurry image detection algorithm proposed by Liu et al. [40].

In our method, we use Oh's IPR because it is inexpensive to compute and incorporate into a particle filter.

In this section, we develop DPF, which is a particle filter with a Dirichlet distribution [8].

Particle filtering [41–44] is a method for estimating the internal states of a state-space model sequentially. In particle filters, a probability distribution is represented by Monte Carlo approximation, i.e., by a set of K random samples, or particles, to handle non-linear and non-Gaussian problems. A particle filter estimates posterior probabilities of the internal states conditioned on observations through the following two steps. A prediction step estimates the prior probabilities at time t from observations before time t
                        −1 and a state transition. An update step estimates the posterior probabilities at time t from the prior probabilities and a likelihood. To avoid confusion of terms, we hereafter refer to classification probability as the discrete (posterior) probability obtained from a frame-wise classification, and to posterior probability as the smoothed probability obtained by the particle filter.

Observation 
                           y
                        
                        
                           t
                         is the classification probability obtained at time (or frame) t and has a unit L
                        1 norm: ∥
                           y
                        
                        
                           t
                        ∥1
                        =1. Let 
                           y
                        
                        1:t
                        
                        ={
                           y
                        
                        1, …, 
                           y
                        
                        
                           t
                        } be a series of observations obtained prior to time t. The internal state 
                           x
                        
                        
                           t
                         is the posterior probability that should be estimated at time t by smoothing. Hence ∥
                           x
                        
                        
                           t
                        ∥1
                        =1, and we use the notation 
                           x
                        
                        1:t
                        
                        ={
                           x
                        
                        1, …, 
                           x
                        
                        
                           t
                        } in the same manner as that for 
                           y
                        
                        1:t
                        .

A prediction step estimates the prior probability p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           y
                        
                        1:t−1) using the following integral:
                           
                              (1)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 ∫
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 d
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                              
                           
                        where p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           x
                        
                        
                           t−1) is the state transition probability between states at times t
                        −1 and t. Once p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           y
                        
                        1:t−1) is computed, an update step computes the posterior probability p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           y
                        
                        1:t
                        ) as follows:
                           
                              (2)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                    
                                 
                                 )
                                 ∝
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 ,
                              
                           
                        where p(
                           y
                        
                        
                           t
                        
                        ∣
                        
                           x
                        
                        
                           t
                        ) is the likelihood. Repeating the prediction and update steps from time zero yields a sequence of estimates of 
                           x
                        
                        
                           t
                        .

To represent probability distributions of 
                           x
                        
                        
                           t
                        , we propose to use the N-dimensional Dirichlet distribution [45] with parameter 
                           α
                        
                        =(α
                        1, …, α
                        
                           N
                        ), α
                        
                           i
                        
                        >0 defined by
                           
                              (3)
                              
                                 
                                    Dir
                                    
                                       
                                          
                                             x
                                          
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 ]
                                 =
                                 
                                    
                                       Γ
                                       
                                          
                                             
                                                
                                                   ∑
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   N
                                                
                                                
                                                   α
                                                   i
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          ∏
                                          
                                             i
                                             =
                                             1
                                          
                                          N
                                       
                                       Γ
                                       (
                                       
                                          α
                                          i
                                       
                                       )
                                    
                                 
                                 
                                    ∏
                                    
                                       i
                                       =
                                       1
                                    
                                    N
                                 
                                 
                                    x
                                    i
                                    
                                       
                                          α
                                          i
                                       
                                       −
                                       1
                                    
                                 
                                 ,
                              
                           
                        where Γ is the gamma function, and 
                           x
                        
                        =(x
                        1, …, x
                        
                           N
                        ) is a random variable with ∥
                           x
                        ∥1
                        =1. The parameter 
                           α
                         controls the shape of the distribution. Fig. 4
                         shows examples of three-dimensional (3D) Dirichlet distributions. When α
                        
                           i
                        
                        <1 for all i, the density has greater probabilities around the vertices, as shown in Fig. 4(c). When α
                        
                           i
                        
                        =1 for all i, the density flattens. Otherwise, the density has a peak at the mode (
                           α
                        
                        −
                        1)/(∥
                           α
                        
                        ∥
                        1
                        −
                        N), where 1 is a vector of ones, as shown in Fig. 4(e). Additionally, the larger the parameter values are, the steeper the peak becomes. In our three-class classification problem (N
                        =3), the support of the probability density is a two-dimensional triangle in a 3D space. Using the Dirichlet distribution enables us to formulate the state transition and the likelihood of the model.

A prediction step models the relationship between internal states at times t
                        −1 and t. To define a state transition probability, we remember that the internal state of our problem is a posterior probability 
                           x
                         that satisfies ∥
                           x
                        ∥1
                        =1. The support of 
                           x
                         is exactly the same as that of the Dirichlet distribution; thus, it can be used to define the state transition. Intuitively, internal state 
                           x
                        
                        
                           t
                         has a large probability if it is similar to 
                           x
                        
                        
                           t−1. Therefore, it is natural to use the probability density p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           x
                        
                        
                           t−1) having a peak around 
                           x
                        
                        
                           t−1. We propose to define the state transition probability with a Dirichlet distribution as follows:
                           
                              (4)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 ]
                                 ,
                              
                           
                        where parameter 
                           α
                         is now a function of 
                           x
                        
                        
                           t−1. To constrain the density (4) to have a peak around 
                           x
                        
                        
                           t−1, we assume linearity between 
                           α
                         and 
                           x
                        
                        
                           t−1:
                           
                              (5)
                              
                                 
                                    
                                       α
                                    
                                 
                                 =
                                 A
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 +
                                 
                                    
                                       b
                                    
                                 
                                 ,
                              
                           
                        where A is an N
                        ×
                        N matrix and 
                           b
                         is an N-vector. Throughout the remainder of this paper, we further simplify the linear function as A
                        =
                        aI and 
                           b
                        
                        =
                        b
                        1, and use the following simplified notation:
                           
                              (6)
                              
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 a
                                 ,
                                 b
                                 )
                                 =
                                 a
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 +
                                 b
                                 
                                    
                                       1
                                    
                                 
                                 .
                              
                           
                        Now, we reformulate Eq. (4) as follows:
                           
                              (7)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 θ
                                 )
                                 =
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 θ
                                 ,
                                 0
                                 )
                                 ]
                                 .
                              
                           
                        Here, we set b
                        =0 to make the mean of the density coincide with 
                           x
                        
                        
                           t−1:
                           
                              (8)
                              
                                 E
                                 [
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ]
                                 =
                                 
                                    
                                       
                                          
                                             α
                                          
                                       
                                    
                                    
                                       ∥
                                       
                                          
                                             
                                                α
                                             
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                    
                                 
                                 =
                                 
                                    
                                       a
                                       
                                          
                                             
                                                x
                                             
                                          
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                    
                                    
                                       ∥
                                       a
                                       
                                          
                                             
                                                x
                                             
                                          
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                    
                                 
                                 =
                                 
                                    
                                       a
                                       
                                          
                                             
                                                x
                                             
                                          
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                    
                                    
                                       a
                                       ∥
                                       
                                          
                                             
                                                x
                                             
                                          
                                          
                                             t
                                             −
                                             1
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                    
                                 
                                 =
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                              
                           
                        where we use the scale-invariant property of the L1-norm for the third equation and ∥
                           x
                        
                        
                           t−1∥1
                        =1 for the last equation. Fig. 5
                         shows examples of the state transition probability density function of a 3D Dirichlet distribution. According to our observations when changing the range of the parameter θ, 100 or greater is a typical choice for the value of θ.

In an update step, particles representing prior distribution p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           y
                        
                        1:t−1) are weighted by a likelihood, and the posterior probability p(
                           x
                        
                        
                           t
                        
                        ∣
                        
                           y
                        
                        1:t
                        ) is then estimated on the basis of the weighted particles. In our problem, we assume that the likelihood has a peak at 
                           y
                        
                        
                           t
                         and propose to define the likelihood by using a Dirichlet distribution as follows:
                           
                              (9)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ,
                                 γ
                                 )
                                 =
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 γ
                                 ,
                                 b
                                 )
                                 ]
                                 .
                              
                           
                        Here, we use the probability distribution of 
                           x
                        
                        
                           t
                         as the likelihood of 
                           y
                        
                        
                           t
                        . We wish to make the likelihood have a broad peak at 
                           y
                        
                        
                           t
                         because the smoothing effect might decrease if the peak is sufficiently steep such that only particles near 
                           y
                        
                        
                           t
                         have extremely large weights. To this end, we set b
                        =1 instead of b
                        =0, because the zero bias leads to a steep peak when the value of 
                           y
                        
                        
                           t
                         is extremely close to zero. Fig. 6
                         shows examples with and without the bias term (i.e., b
                        =0 or 1). When some values in 
                           y
                        
                        
                           t
                         are negligible as in Fig. 6(b) and (c), the likelihood with b
                        =0 has a steep peak at the edge of the triangular support. In contrast, the likelihood with b
                        =1 has a reasonably broad peak inside the triangle. Based on our observations, typical values of γ and b should be 10 (or less) and on 1 (or greater), respectively. Particularly, setting b
                        =1 makes the likelihood have a peak at exactly 
                           y
                        
                        
                           t
                         because:
                           
                              (10)
                              
                                 mode
                                 [
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ]
                                 =
                                 
                                    
                                       
                                          
                                             α
                                          
                                       
                                       −
                                       
                                          
                                             1
                                          
                                       
                                    
                                    
                                       ∥
                                       
                                          
                                             α
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                       −
                                       N
                                    
                                 
                                 =
                                 
                                    
                                       (
                                       γ
                                       
                                          
                                             
                                                y
                                             
                                          
                                          t
                                       
                                       +
                                       
                                          
                                             1
                                          
                                       
                                       )
                                       −
                                       
                                          
                                             1
                                          
                                       
                                    
                                    
                                       ∥
                                       γ
                                       
                                          
                                             
                                                y
                                             
                                          
                                          t
                                       
                                       +
                                       
                                          
                                             1
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                       −
                                       N
                                    
                                 
                                 =
                                 
                                    
                                       γ
                                       
                                          
                                             
                                                y
                                             
                                          
                                          t
                                       
                                    
                                    
                                       γ
                                       ∥
                                       
                                          
                                             
                                                y
                                             
                                          
                                          t
                                       
                                       
                                          ∥
                                          1
                                       
                                       +
                                       ∥
                                       
                                          
                                             1
                                          
                                       
                                       
                                          ∥
                                          1
                                       
                                       −
                                       N
                                    
                                 
                                 =
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                              
                           
                        where ∥
                           y
                        
                        
                           t
                        ∥1
                        =1 and ∥1∥1
                        =
                        N.

Here, we incorporate additional defocus information at each frame to develop D-DPF. The DPF discussed in the previous section assumes that each observation 
                        y
                     
                     
                        t
                      is generated by the true state 
                        x
                     
                     
                        t
                      with a Dirichlet distribution with parameter γ. The graphical model of DPF is shown in Fig. 7
                     (a), with factor nodes (black squares) representing potential functions of 
                        y
                     
                     
                        t
                     , 
                        x
                     
                     
                        t
                     , and the deterministic parameter γ.

We assume that observation 
                        y
                     
                     
                        t
                      is influenced by the true state 
                        x
                     
                     
                        t
                      as well as a temporal hidden variable γ
                     
                        t
                     , which is inferred from the additional defocus information. The graphical model of D-DPF in this section is shown in Fig. 7(b). The factor nodes now represent 
                        y
                     
                     
                        t
                     , 
                        x
                     
                     
                        t
                     , and γ
                     
                        t
                     . We further assume that the hidden variable is generated by the defocus information z
                     
                        t
                     .

We begin with a modified definition of the update step as follows:
                           
                              (11)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                    
                                 
                                 ,
                                 
                                    γ
                                    
                                       1
                                       :
                                       t
                                    
                                 
                                 ,
                                 
                                    z
                                    
                                       1
                                       :
                                       t
                                    
                                 
                                 )
                                 ∝
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ,
                                 
                                    z
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    γ
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    z
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 ,
                              
                           
                        where z
                        
                           t
                         is a scalar value representing the defocus information at time t.

We model the likelihood p(
                           y
                        
                        
                           t
                        , γ
                        
                           t
                        , z
                        
                           t
                        
                        ∣
                        
                           x
                        
                        
                           t
                        ) with a Dirichlet distribution with a peak at 
                           y
                        
                        
                           t
                        , whose broadness depends on z
                        
                           t
                        . According to the graphical model in Fig. 7(b), we propose to redefine the likelihood as follows:
                           
                              (12)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ,
                                 
                                    z
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 =
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 p
                                 (
                                 
                                    z
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 )
                                 =
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 p
                                 (
                                 
                                    z
                                    t
                                 
                                 ∣
                                 
                                    γ
                                    t
                                 
                                 )
                                 .
                              
                           
                        Here, we use the fact that z
                        
                           t
                         is conditionally independent of 
                           y
                        
                        
                           t
                         and 
                           x
                        
                        
                           t
                        , given γ
                        
                           t
                         based on the graphical model. The potential function p(
                           y
                        
                        
                           t
                        , γ
                        
                           t
                        
                        ∣
                        
                           x
                        
                        
                           t
                        ), corresponding to the factor node in the graphical model, has a form similar to Eq. (9); hence, we define it as follows:
                           
                              (13)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 )
                                 =
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          y
                                       
                                    
                                    t
                                 
                                 ,
                                 
                                    γ
                                    t
                                 
                                 ,
                                 1
                                 )
                                 ]
                                 .
                              
                           
                        
                     

We model p(z
                        
                           t
                        
                        ∣
                        γ
                        
                           t
                        ), the relation between the hidden variable γ
                        
                           t
                        , and the defocus information z
                        
                           t
                        . We wish to reduce the effect of classification failures using a frame-wise classifier at defocused frames. In that case, observation 
                           y
                        
                        
                           t
                         is less reliable, and the likelihood is expected to have a broad peak with the result that particles far from the peak at 
                           y
                        
                        
                           t
                         are assigned larger weights. Therefore, we control γ
                        
                           t
                         to be smaller at defocused frames to have a broad likelihood. Herein, we use IPR as z
                        
                           t
                        , and model p(z
                        
                           t
                        
                        ∣
                        γ
                        
                           t
                        ) with the Rayleigh distribution.


                           Isolated pixels are edge pixels extracted by a Canny edge detector, whose eight-neighbors are not edge pixels, as shown in Fig. 8
                           . IPR is the ratio of the isolated pixels to all edge pixels and takes values in the range between 0 and 1. We observe connected edge pixels in a sharp and focused image, whereas many isolated pixels are observed in defocused frames. In other words, a focused frame has a lower IPR value, and a defocused frame has a higher IPR value. IPR can be used to classify frames as informative or non-informative.

In Oh et al.'s paper, IPR values are distributed in the range between 0 and 0.1. However, observations can differ in different endoscopic videos due to frame size, zooming, and optical magnification, or when different types of endoscopes are used. To estimate the distribution of IPR in our endoscopic videos, we computed a histogram of IPR extracted from 33 videos (see Section 5.1 for details), as shown in Fig. 9
                           . We can see that IPR is distributed between 0 and 0.01. Using the IPR as z
                           
                              t
                           , we propose the model described in the next section.

We use the Rayleigh distribution [46] to represent the relationship between the hidden variable γ
                           
                              t
                            and defocus information z
                           
                              t
                           . The Rayleigh distribution is defined by
                              
                                 (14)
                                 
                                    
                                       Ray
                                       γ
                                    
                                    [
                                    σ
                                    ]
                                    =
                                    
                                       γ
                                       
                                          
                                             σ
                                             2
                                          
                                       
                                    
                                    exp
                                    
                                       
                                          
                                             −
                                             
                                                
                                                   
                                                      γ
                                                      2
                                                   
                                                
                                                
                                                   2
                                                   
                                                      σ
                                                      2
                                                   
                                                
                                             
                                          
                                       
                                    
                                    ,
                                 
                              
                           where σ
                           >0 is a parameter. The top row of Fig. 10
                            shows a few examples of the probability density function of the Rayleigh distribution. Smaller values of σ cause the distribution to peak toward zero, whereas larger values of σ broaden it.

As discussed above, we wish to have a broad peak of the Dirichlet distribution as a likelihood when the frame is defocused, and a lower value of γ
                           
                              t
                            is preferred in that case. In terms of IPR, a defocused frame contains many isolated pixels, resulting in larger IPR values. In summary, at a defocused frame, IPR or z
                           
                              t
                            is larger, and smaller values of γ
                           
                              t
                            must be sampled during the sampling procedure of the particle filter, resulting in a broad peak of the likelihood. Consequently, we propose to use z
                           
                              t
                            for controlling the parameter σ of the Rayleigh distribution as follows:
                              
                                 (15)
                                 
                                    p
                                    (
                                    
                                       z
                                       t
                                    
                                    ∣
                                    
                                       γ
                                       t
                                    
                                    )
                                    =
                                    
                                       Ray
                                       
                                          
                                             γ
                                             t
                                          
                                       
                                    
                                    [
                                    σ
                                    (
                                    
                                       z
                                       t
                                    
                                    )
                                    ]
                                    ,
                                 
                              
                           where σ(z
                           
                              t
                           ) is now a function of z
                           
                              t
                           . To achieve the desired behavior, we use a function of the form
                              
                                 (16)
                                 
                                    σ
                                    (
                                    
                                       z
                                       t
                                    
                                    )
                                    =
                                    a
                                    exp
                                    
                                       (
                                       
                                          bz
                                          t
                                       
                                       )
                                    
                                    ,
                                 
                              
                           where a and b are parameters to be tuned. A plot of this function is shown in Fig. 11
                           . The reason for using exponential decay is the range of z
                           
                              t
                           . If a frame is in focus, then the IPR might be zero or some small positive value. However, it can be extremely large (as much as one) for a defocused frame. Therefore, we assume that the range of z
                           
                              t
                            is [0, 0.01], as mentioned above, but also allow larger values if they have little effect. The use of exponential decay allows larger values beyond the range above, but they would be effectively squeezed into an extremely narrow range on the vertical axis, as shown in Fig. 11.

As a reasonable range for the vertical axis, σ, we choose from 1 to 4 for σ, which is in accordance with observations of typical values of γ
                           
                              t
                           . At the end of the previous section, we mentioned that we prefer γ
                           
                              t
                            to take values of 10 or less. When we observe the horizontal axis γ of Fig. 10, the Rayleigh distribution with σ
                           =4 has support that almost covers the range [0, 10]. Therefore, in the current work we use the fixed (but flexible) range [0, 0.01] for z
                           
                              t
                           , [1, 4] for σ, and [0, 10] for γ
                           
                              t
                           . To this end, we solved the following system of equations
                              
                                 (17)
                                 
                                    
                                       
                                          
                                             
                                                
                                                   4
                                                   =
                                                   a
                                                   exp
                                                   
                                                      (
                                                      b
                                                      ·
                                                      0
                                                      )
                                                   
                                                
                                                
                                             
                                             
                                                
                                                   1
                                                   =
                                                   a
                                                   exp
                                                   
                                                      (
                                                      b
                                                      ·
                                                      0.01
                                                      )
                                                   
                                                   ,
                                                
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           to obtain a
                           =4 and b
                           =(1/0.01)ln(1/4)=−ln4/0.01.

We use the same state transition as that discussed in Section 3 and define the prediction step as
                           
                              (18)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    y
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    γ
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    z
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 ∫
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ∣
                                 
                                    
                                       
                                          y
                                       
                                    
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    γ
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    z
                                    
                                       1
                                       :
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 d
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                              
                           
                        where
                           
                              (19)
                              
                                 p
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    t
                                 
                                 ∣
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          x
                                       
                                    
                                    
                                       t
                                       −
                                       1
                                    
                                 
                                 ,
                                 θ
                                 ,
                                 0
                                 )
                                 ]
                                 .
                              
                           
                        
                     


                        Algorithm 1 details the proposed D-DPF. At each time step t, the mode 
                           
                              
                                 
                                    
                                       
                                          
                                             x
                                          
                                       
                                    
                                    ˆ
                                 
                              
                              t
                           
                         of the Dirichlet distribution is obtained to visualize a plot along with the input observation 
                           y
                        
                        
                           t
                         in the experiments:


                        
                           Algorithm 1
                           Defocus-aware Dirichlet particle filter (D-DPF).


                              
                                 
                                    
                                       
                                       
                                       
                                          
                                             1:
                                             Sample K particles 
                                                   
                                                      
                                                         {
                                                         
                                                            
                                                               
                                                                  s
                                                               
                                                            
                                                            
                                                               0
                                                               |
                                                               0
                                                            
                                                            
                                                               (
                                                               i
                                                               )
                                                            
                                                         
                                                         }
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      K
                                                   
                                                 from p(
                                                   x
                                                
                                                0).
                                          
                                          
                                             2:
                                             
                                                for time t
                                                =1…
                                                T 
                                                do
                                             
                                          
                                          
                                             3:
                                             
                                                
                                                for 
                                                i
                                                =1…
                                                K 
                                                do
                                             
                                          
                                          
                                             4:
                                             
                                                Draw a sample 
                                                   
                                                      
                                                         
                                                            s
                                                         
                                                      
                                                      
                                                         t
                                                         |
                                                         t
                                                         −
                                                         1
                                                      
                                                      
                                                         (
                                                         i
                                                         )
                                                      
                                                   
                                                   ∼
                                                   
                                                      Dir
                                                      
                                                         
                                                            
                                                               
                                                                  x
                                                               
                                                            
                                                            t
                                                         
                                                      
                                                   
                                                   [
                                                   
                                                      
                                                         
                                                            α
                                                         
                                                      
                                                      
                                                   
                                                   (
                                                   
                                                      
                                                         
                                                            s
                                                         
                                                      
                                                      
                                                         t
                                                         −
                                                         1
                                                         |
                                                         t
                                                         −
                                                         1
                                                      
                                                      
                                                         (
                                                         i
                                                         )
                                                      
                                                   
                                                   ,
                                                   θ
                                                   ,
                                                   0
                                                   )
                                                   ]
                                                .
                                          
                                          
                                             5:
                                             
                                                
                                                end for
                                             
                                          
                                          
                                             6:
                                             
                                                Compute z
                                                
                                                   t
                                                 from video frame at time t.
                                          
                                          
                                             7:
                                             
                                                Compute 
                                                   
                                                      γ
                                                      t
                                                   
                                                   ∼
                                                   
                                                      Ray
                                                      
                                                         
                                                            γ
                                                            t
                                                         
                                                      
                                                   
                                                   [
                                                   
                                                      z
                                                      t
                                                   
                                                   ]
                                                .
                                          
                                          
                                             8:
                                             
                                                
                                                for 
                                                i
                                                =1…
                                                K 
                                                do
                                             
                                          
                                          
                                             9:
                                             
                                                Compute a weight 
                                                   
                                                      π
                                                      t
                                                      
                                                         (
                                                         i
                                                         )
                                                      
                                                   
                                                   =
                                                   
                                                      Dir
                                                      
                                                         
                                                            x
                                                            t
                                                         
                                                         =
                                                         
                                                            s
                                                            
                                                               t
                                                               |
                                                               t
                                                               −
                                                               1
                                                            
                                                            
                                                               (
                                                               i
                                                               )
                                                            
                                                         
                                                      
                                                   
                                                   [
                                                   
                                                      
                                                         α
                                                      
                                                   
                                                   (
                                                   
                                                      
                                                         
                                                            y
                                                         
                                                      
                                                      t
                                                   
                                                   ,
                                                   
                                                      γ
                                                      t
                                                   
                                                   ,
                                                   1
                                                   )
                                                   ]
                                                .
                                          
                                          
                                             10:
                                             
                                                
                                                end for
                                             
                                          
                                          
                                             11:
                                             
                                                Sample K times as 
                                                   
                                                      
                                                         {
                                                         
                                                            
                                                               
                                                                  s
                                                               
                                                            
                                                            
                                                               t
                                                               |
                                                               t
                                                            
                                                            
                                                               (
                                                               i
                                                               )
                                                            
                                                         
                                                         }
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      K
                                                   
                                                 from 
                                                   
                                                      
                                                         {
                                                         
                                                            
                                                               
                                                                  s
                                                               
                                                            
                                                            
                                                               t
                                                               |
                                                               t
                                                               −
                                                               1
                                                            
                                                            
                                                               (
                                                               i
                                                               )
                                                            
                                                         
                                                         }
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      K
                                                   
                                                 with replacement according to the weights 
                                                   
                                                      π
                                                      t
                                                      
                                                         (
                                                         i
                                                         )
                                                      
                                                   
                                                .
                                          
                                          
                                             12:
                                             
                                                Estimate 
                                                   α
                                                 from 
                                                   
                                                      
                                                         {
                                                         
                                                            
                                                               
                                                                  s
                                                               
                                                            
                                                            
                                                               t
                                                               |
                                                               t
                                                            
                                                            
                                                               (
                                                               i
                                                               )
                                                            
                                                         
                                                         }
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      K
                                                   
                                                .
                                          
                                          
                                             13:
                                             
                                                Compute the mode 
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  
                                                                     x
                                                                  
                                                               
                                                            
                                                            ˆ
                                                         
                                                      
                                                      t
                                                   
                                                 of the Dirichlet distribution from 
                                                   α
                                                .
                                          
                                          
                                             14:
                                             
                                                end for
                                             
                                          
                                       
                                    
                                 
                              
                           

Sample K particles according to an initial Dirichlet distribution p(
                                    x
                                 
                                 0) with 
                                    α
                                 
                                 =(0.4, 0.3, 0.3) (line 1).

Sample prediction particles by performing a transition of particles at time t
                                 −1 according to the state transition probability (lines 2 to 5).

Compute the defocus information z
                                 
                                    t
                                  and sample γ
                                 
                                    t
                                  according to z
                                 
                                    t
                                  (lines 6 and 7).

Estimate weights 
                                    
                                       π
                                       t
                                       
                                          (
                                          i
                                          )
                                       
                                    
                                  for prediction of particles (lines 8 to 10).

Sample with replacement for 
                                    
                                       
                                          
                                             s
                                          
                                       
                                       
                                          t
                                          ∣
                                          t
                                       
                                       
                                          (
                                          n
                                          )
                                       
                                    
                                  to be proportional to weight 
                                    
                                       π
                                       t
                                       
                                          (
                                          i
                                          )
                                       
                                    
                                  (line 11). Subsequently, compute the maximum likelihood estimate of 
                                    α
                                  of the Dirichlet distribution [47] from particles 
                                    
                                       
                                          
                                             s
                                          
                                       
                                       
                                          t
                                          ∣
                                          t
                                       
                                       
                                          (
                                          n
                                          )
                                       
                                    
                                  (line 12). Then, each component of the mode 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      x
                                                   
                                                
                                             
                                             ˆ
                                          
                                       
                                       t
                                    
                                  of the Dirichlet distribution is separately computed using
                                    
                                       (20)
                                       
                                          
                                             x
                                             i
                                          
                                          =
                                          
                                             
                                                
                                                   α
                                                   i
                                                
                                                −
                                                1
                                             
                                             
                                                
                                                   ∑
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   N
                                                
                                                
                                                   α
                                                   i
                                                
                                                −
                                                N
                                             
                                          
                                          ,
                                          
                                             α
                                             i
                                          
                                          >
                                          1
                                          .
                                       
                                    
                                 In the event that α
                                 
                                    i
                                  is less than one, we set α
                                 
                                    i
                                 
                                 =0 (line 13).

Return to step 2.

@&#EXPERIMENTAL RESULTS@&#

This section demonstrates the effectiveness of the proposed D-DPF smoothing. The following subsections describe the dataset of image patches and videos, and the classification results for blurred image patches and endoscopic video sequences.

We used a dataset of 1671 NBI image patches of different sizes (type A: 504, type B: 847, type C3: 320) to train an SVM classifier for frame-wise classification. Each of the image patches was trimmed from an endoscopic video frame and labeled by endoscopists. These endoscopic video frames were captured and collected during endoscopic examinations, and each frame has the same label as the corresponding image patch. Details about the dataset, features used, and classification can be found in [6].

For evaluation, we have 33 NBI-endoscopic videos (type A: 5, type B: 27, type C3: 1) whose frame rate is 30fps and size is full HD (1980×1080 pixels), wherein the window size displaying the endoscopic video is 1000×870 pixels. Each endoscopic video shows a single tumor, but there are many defocused frames. For each video frame, a 200×200 patch at the center of the window is classified by a pre-trained frame-wise classifier to obtain classification probabilities 
                           y
                        
                        
                           t
                        . Frame lengths of the videos range between 200 and 2500, with more than 20,000 frames in total.

Labeling each video frame of these videos is, therefore, very expensive, as stated previously. Labeling still images in the aforementioned datasets of 1671 images was possible because it took several years to collect that number of NBI images for various patients. In Section 5.3, we instead use synthetic endoscopic video sequences, wherein frame labels are known, for analysis and evaluation of the proposed method. In Section 5.4, we show some of the results for real videos to demonstrate the behavior of the proposed method.

The training NBI images have been used for clinical reports, while the endoscopic videos were collected for our experiments. All of these endoscopic images and videos were collected at the Hiroshima University Hospital, following the guidelines of the Hiroshima University ethics committee, and informed consent has been obtained from the patients and their families.

Before showing the results for the D-DPF, we demonstrate the performance deterioration of blurred image patch classification when using the classification method proposed by Tamaki et al. [6]. For training, 160 NBI image patches for each class, 480 NBI image patches in total, were randomly selected from the 1671 image patch dataset. The remainder of the dataset was used for evaluation by adding Gaussian blur with standard deviation σ
                        
                           blur
                        
                        =0.5, 1, 2, 3, 5, 7, 9, 11. The classification results are shown in Fig. 12
                         for different dimensions of the feature vectors, as this is an important parameter for obtaining better classification performance. The performance on image patches without Gaussian blur is better than that with blur. When σ
                        
                           blur
                        
                        >3, the performance drops to approximately 50%. As shown in Fig. 12, even small blur of σ
                        
                           blur
                        
                        =2 or 3 affects classification performance.

Hereafter, we evaluate the performance of the proposed smoothing method. Therefore, in this subsection, we assess the performance on synthetic endoscopic video sequences.

We created the synthetic videos as follows. First, we selected three images from the dataset of 1671 NBI images. These were not trimmed patches, but original video frames from which the patches were trimmed. Next, each of these images was repeated 200 times to create a 200-frame static video, resulting in a synthetic video of 800 frames corresponding to four different static scenes. Gaussian blur with σ
                        
                           blur
                        
                        =5 was then added into some parts of the videos. Next, we added noise in either of two ways. One was to add Gaussian noise with standard deviation σ
                        
                           noise
                         to every frame, with classification probabilities then obtained using frame-wise classification. The other was to sample Dirichlet noise according to classification probabilities using
                           
                              (21)
                              
                                 
                                    Dir
                                    
                                       
                                          
                                             
                                                x
                                             
                                          
                                          t
                                       
                                    
                                 
                                 [
                                 
                                    
                                       α
                                    
                                 
                                 (
                                 
                                    
                                       
                                          
                                             
                                                
                                                   y
                                                
                                             
                                          
                                          ˆ
                                       
                                    
                                    t
                                 
                                 ,
                                 s
                                 ,
                                 1
                                 )
                                 ]
                                 ,
                              
                           
                        where 
                           
                              
                                 
                                    
                                       
                                          
                                             y
                                          
                                       
                                    
                                    ˆ
                                 
                              
                              t
                           
                         is an observation at an individual video frame and s is a scale parameter. The sampled Dirichlet noise was used as an observation vector for each frame.

For training, we randomly selected 300 NBI image patches for each class, 900 NBI image patches in total, from the 1671 NBI image patch dataset. Note that image patches corresponding to images used to create the synthetic video sequences were not used for training.

We should note that the conclusions obtained from the experimental results in this section are limited to observing how fast our method responds to the transitions between blurring and non-blurring frames. This is because the synthetic static videos with blur do not contain any other problematic issues such as abrupt motion or light condition changes. Results for real endoscopic videos are shown in the next section.

First, we evaluate the difference between DPF from Section 3 and D-DPF from Section 4.


                           Fig. 13
                            shows results for a synthetic video to which Gaussian noise has been added. Fig. 13(a) shows the classification probabilities for each original (noise-free) frame. For this synthetic video, four NBI images were used, each of which lasts 200 frames. We can see three discontinuities at frames 200, 400, and 600. Gaussian blur of σ
                           
                              blur
                           
                           =5 is applied to 10 frames before and after the 100, 300, 500, and 700th frame (that is, between frames 90 and 110, and so on) as indicated by shading in Fig. 13(b)–(e). Then, Gaussian noise with σ
                           
                              noise
                           
                           =1 was added to all frames to create a final synthetic video for processing. Classification probabilities for this video are shown in Fig. 13(b).

As observed in Fig. 13(b), between frames 200 and 400, the classification probabilities are highly unstable, and for the shaded frames (where blur is applied), the classification probability curves abruptly change. Fig. 13(c) shows the IPR of each frame, and the values of IPR for the shaded (blurred) frames increase as expected. Results for DPF and D-DPF are shown in Fig. 13(d) and (e), respectively. At approximately frames 100 and 500, where blur is applied, DPF is affected by a sudden change in classification results. In contrast, D-DPF is rather robust to the change due to the defocus information extracted from each frame.


                           Fig. 13(f) shows the smoothing result obtained by a Kalman filter. Parameters were manually tuned; hence, the results for the Kalman filter look similar to those for DPF and D-DPF because an optimization with an EM algorithm could not find suitable parameters that would produce satisfactory smoothing results in this case. The Kalman filter was also affected by the sudden change of classification results at frames where blur was applied. Another defect of the Kalman filter was overshooting. Around frames 150, 450, and 650, results exceed the range between 0 and 1. Normalizing or clipping the results in the range of zero to one at each frame would lead to inconsistency with the results for the successive frames, and the probabilistic framework would be lost.


                           Fig. 14
                            shows the results obtained when Dirichlet noise with s
                           =20 has been added to the classification probabilities instead of adding Gaussian noise to the image frames. The procedure for creating the synthetic video was the same. In this experiment, the IPR values computed for the shaded (blurred) frames in Fig. 14(c) are relatively small compared to those for Fig. 13(c). Consequently, D-DPF in Fig. 14(e) is affected much more by the observation. This experiment suggests that a carefully selected model is necessary for the relation between z
                           
                              t
                            and γ
                           
                              t
                           .

To obtain a quantitative evaluation, we compute the root-mean-square error (RMSE) between ground truth (Figs. 13(a) and 14(a)) and the smoothing results (Figs. 13(d)–(f) and 14(d)–(f)) over different amounts of Gaussian or Dirichlet noise. Fig. 15
                           (a) shows the RMSE for DPF, D-DPF, and the Kalman filter applied to synthetic videos with Gaussian noise for different values of σ
                           
                              noise
                           . Both DPF and D-DPF maintain low values of the RMSE. The RMSE is higher for the Kalman filter than for DPF and D-DPF for an entire range of σ
                           
                              noise
                            values. Fig. 15(b) shows the RMSE for synthetic videos with Dirichlet noise for different values of s. Note that larger values of s generate smaller amounts of noise. Here again, D-DPF performs better than DPF and the Kalman filter.

We compare the performance for different values of θ in the state transition. Fig. 16
                            shows results for a synthetic video, which was created by the same procedure described above, except that two original images were used to create 200 frames. Then, Dirichlet noise with s
                           =50 was added to the classification probabilities. Fig. 16(a) shows the classification probabilities for each original (noise-free) frame. For this synthetic video, two NBI images were used, each of which lasts 100 frames. Shading in Fig. 16(b) through (e) indicates frames blurred with Gaussian with σ
                           
                              blur
                           
                           =5. We used K
                           =1000 particles to generate the results in Fig. 16(d) and (e).

At the discontinuities of frames 50, 100, and 150, smoothed probabilities are pulled to observations, and θ adjusts the speed of the convergence. When θ is small (e.g., 100), the state transition probability has a broad peak (the middle column of Fig. 5), and successive states 
                              x
                           
                           
                              t−1 and 
                              x
                           
                           
                              t
                            are thus weakly linked; hence, the result rapidly converges to the observation, as in Fig. 16(c). In contrast, when θ is relatively larger (500), the narrow peak of p(
                              x
                           
                           
                              t
                           
                           ∣
                           
                              x
                           
                           
                              t−1) restricts 
                              x
                           
                           
                              t
                            to be close to 
                              x
                           
                           
                              t−1, resulting in a slow convergence such as that in Fig. 16(e).

As a simple extension, one might think of θ as another hidden variable that relates the defocus information and the state transition, as we did with γ for the likelihood. However, we chose not to follow such a direction. If we loosely connected 
                              x
                           
                           
                              t
                            to 
                              x
                           
                           
                              t−1 as well as 
                              y
                           
                           
                              t
                            when the frame is defocused, then 
                              x
                           
                           
                              t
                            would not be under the control of either 
                              x
                           
                           
                              t−1 or 
                              y
                           
                           
                              t
                           , and the result might be unpredictable. More sophisticated modeling of the relation between the defocus information and the state transition is left as future work.

We evaluate the results in terms of the number of particles with the same dataset used in the last subsection because the optimal number of particles depends on each problem. Using a large number of particles generally provides good results, but there is a tradeoff due to increasing computational cost. We fix the parameter to θ
                           =100 and change the number of particles to K
                           =10, 100, 1000, and 10,000. As shown in Fig. 17
                           , the smoothing effect is insufficient when using as few as K
                           =10 particles. In contrast, using many particles improves the accuracy of the smoothing results. Evidently, K
                           =100 appears to be sufficient to achieve results comparable to the case wherein many more particles are used, e.g., K
                           =1000 and 10,000.


                           Fig. 18
                            shows the computational cost per frame, which includes lines 3 to 13 in Algorithm 1. Even when we use K
                           =10,000 particles, it requires only 33ms/frame, of which computing IPR takes 22ms on average. Furthermore, frame-wise classification requires 50ms. In total, it requires 88ms≅12fps; this is a sufficient computation speed for a prototype system to be used in diagnosis support during actual endoscopic examinations. Further increase in speed can be achieved by additional fine-tuning of the system. Currently, our unoptimized implementation written in C++ uses a single thread on an Intel Core i5 (2.4GHz) processor with 16GB memory.

In this subsection, we demonstrate smoothing results for real endoscopic videos taken during actual endoscopic examinations. Demonstration videos of smoothed results are available as Supplemental material.

In this subsection, we demonstrate smoothing results for real endoscopic videos taken during actual endoscopic examinations. Demonstration videos of smoothed results are available as Supplemental material.

For training, all of the 1671 NBI image patches in the dataset were used. This dataset is unbalanced, but a preliminary experiment (not shown here) with a balanced dataset of 320 NBI image patches for each class showed results similar to those shown here.


                        Fig. 19
                         shows observation and smoothing results for a video that captures a tumor labeled as type B. During the frames around frame numbers 150, 250, and 450, where observation and IPR values look nearly constant, endoscopists capture the screen to save images of the tumor, and the screen freezes. Due to defocus, type A is dominant between frames 30 and 120, and the observations are unstable particularly around frames 180, 290, 370, and 490. It is evident that the observations (classification probabilities) are highly unstable throughout the video, whereas the results from D-DPF are much smoother. The results obtained from DPF, shown in Fig. 19(f), are also smooth, but slow to follow the observations. The result from D-DPF with the same parameter shown in Fig. 19(e) shows a quick follow; particularly, frames between 400 and 500 when observations are close to zero and one. Fig. 19(g) shows the smoothing result obtained by a Kalman filter with the same parameters as those used for the results in Figs. 13(f) and 14(f). We can see that the results are as slow to follow the observations as DPF. There is also overshooting as we have seen in the last section with the synthetic videos where observations suddenly change such as around frames 150, 250, 450, and 550.


                        Fig. 20
                        (a)–(c) shows smoothing results for another video labeled as type A, wherein the frames around frame 200 are blurred and the observations are unstable. The results shown in Fig. 20(c) are smooth and the probabilities for type A have the largest values for all frames as IPR values keep lower values. Fig. 20(d)–(f) shows smoothing results for yet another video labeled as type C3. The results shown in Fig. 20(f) are smoother than the observations in Fig. 20(d) as all frames are defocused slightly and IPR values are relatively high.

However, the results in Fig. 20(f) are type C3 only in frames between 120 and 190 because of the severe instability of the frame-wise classification results. In particular, the results for frames between 60 and 90, and between 190 and 270, are type B because it is dominant in the observations during these frames. This may be caused by defocus of frames, as well as other problematic issues that occur in real endoscopic videos such as illumination change, color bleeding, and abrupt camera motion.

@&#CONCLUSION@&#

We have proposed a novel method–D-DPF–to smooth the classification probabilities obtained from frame-wise endoscopic image classification by incorporating defocus information into a particle filter with a Dirichlet distribution. We assumed that the defocus information extracted from each frame influences classification probabilities, and we proposed linking the Dirichlet likelihood to the defocus information and the IPR proposed by Oh et al. [7], which is a ratio of the number of edge pixels isolated from neighbor edge pixels. Then we sampled parameter γ
                     
                        t
                      in the likelihood from a Rayleigh distribution.

For endoscopists, unstable recognition results such as those in Fig. 1 are difficult to use for diagnosis. The proposed smoothing method improves the visibility and understandability of the recognition results and facilitates the use of the results for diagnosis. Moreover, the proposed method has the potential to be used for training endoscopists who have less experience of endoscopic examinations.

D-DPF can be extended in several ways. One possible extension is to address other causes of instability. We have focused on defocus information herein, but other causes also exist. One example is color bleeding due to the following property of NBI endoscopes: different wavelengths of light are used to create a single frame by rotating a filter in front of the light sources. Thus, color bleeding (i.e., different color illuminations appear at the same time) occurs when the assumption that the scene is temporally static is violated owing to the large motion of the endoscope. Rapid movement of the endoscope also results in motion blur, another cause of instability. The proposed D-DPF might still be applicable in such situations if we could introduce metrics representing color bleeding or motion blur instead of defocus information. For other frame-wise classification results with four or five-classes, we can apply D-DPF by simply changing the dimension N of the Dirichlet distribution. Gastrointestinal endoscopic videos are also in the application range of D-DPF. Given additional information along with the signals to be smoothed, effective smoothing results can be obtained.

How to visualize the results more effectively is another issue that deserves further attention. For every frame, we compute the mode of the Dirichlet distribution estimated in the update step as the smoothed classification probabilities. These probability values are displayed as in the videos in the Supplementary material. Furthermore, the estimated label (the class having the largest probability from the estimated mode) is displayed as a colored rectangle shown at the patch used by the frame-wise recognition. Other possible means of visualization include displaying classification probability curves that are similar to an electrocardiogram or visualizing the estimated Dirichlet distribution shapes instead of probabilities and labels. In any case, further consideration is needed in terms of human–computer interaction.

How to visualize the results more effectively is another issue that deserves further attention. For every frame, we compute the mode of the Dirichlet distribution estimated in the update step as the smoothed classification probabilities. These probability values are displayed as in the videos in the Supplementary material. Furthermore, the estimated label (the class having the largest probability from the estimated mode) is displayed as a colored rectangle shown at the patch used by the frame-wise recognition. Other possible means of visualization include displaying classification probability curves that are similar to an electrocardiogram or visualizing the estimated Dirichlet distribution shapes instead of probabilities and labels. In any case, further consideration is needed in terms of human–computer interaction.

In addition to the visualization issue, our future work includes embedding the proposed method into an actual working system for clinical evaluations. We also must explore alternative ways to represent defocus information (other than IPR) and other sampling strategies (apart from the Rayleigh distribution) for the likelihood parameter.

@&#ACKNOWLEDGEMENTS@&#

This work was supported in part by JSPS KAKENHI grants numbers 14J00223, 30243596, and 00335689 as well as the Mazda Foundation grant number 13KK-210, and the Semiconductor Technology Academic Research Center (STARC).

Supplementary data associated with this article can be found, in the online version, at http://dx.doi.org/10.1016/j.artmed.2016.03.002.

The following are the supplementary data to this article: 
                        
                           Video_Fig. 19e
                           
                        
                      
                     
                        
                           Video_Fig. 20c
                           
                        
                      
                     
                        
                           Video_Fig. 20f
                           
                        
                     
                  

@&#REFERENCES@&#

