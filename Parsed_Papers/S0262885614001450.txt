@&#MAIN-TITLE@&#Single frame correction of motion artifacts in PMD-based time of flight cameras

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           Motion Artifacts (MoArt) are a non-systematic error in Time of Flight (ToF) imaging.


                        
                        
                           
                           MoArt emerge when motion appears during the integration time.


                        
                        
                           
                           MoArt cause distorted ToF measurements (depth and amplitude).


                        
                        
                           
                           We propose a single frame correction of ToF measurements with motion flow estimation.


                        
                        
                           
                           We present quantitative and qualitative results in challenging scenarios.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Time of flight (ToF)

Motion artifacts (MoArt)

Photonic mixer devices (PMD)

Motion flow

Phase-shift algorithm

@&#ABSTRACT@&#


               Graphical abstract
               
                  
                     
                        
                           
                        
                     
                  
               
            

@&#INTRODUCTION@&#

Time of flight cameras provide “per-pixel” distance between the camera and the target scene. ToF cameras obtain depth from the phase shift between two signals: i) square periodic signal used for infrared light modulation and ii) light reflected from the scene, that camera pixels convert into an electrical signal (see [1]). Current ToF technologies can be classified into three categories: i) pulsed modulation, ii) continuous wave modulation and iii) pseudo-noise modulation. The most established architecture is based on continuous wave modulation and Photonic Mixer Device (PMD) technology. PMD ToF cameras are based on the so-called “4 phase-shift” system where each pixel of the ToF sensor includes a 2-well CMOS architecture. Each well integrates samples of the correlation function between the incoming reflected infrared signal and the reference signal used for light modulation. Current PMD ToF cameras sample the correlation function at 4 different phase shifts. With these 4 samples one can obtain depth while removing gain and offset variations in the captured signal.

Each ToF “smart pixel” integrates charge during hundreds of nanoseconds on each stage, which provides sub-centimeter accuracy at a high frame rate. PMD ToF technology has thus become a competitive alternative to other depth sensing technologies, such as stereo vision, laser or structure light projection (see [2] for an overview).

However, PMD ToF technology suffers from error sources that still limit its accuracy (see [1]). These errors can be classified into systematic and non-systematic errors.

Among the systematic errors we highlight the following: i) wiggling error due to the use of non-ideal sinusoidal signals, ii) pixel-related error arising from a Fixed Pattern Noise (FPN), iii) amplitude-related errors due to the non-uniformity of the infrared (IR) illumination and reflectivity variations, iv) photon shot noise that influences the number of collected electrons during the integration time and v) temperature-related error due to its influence in the semiconductor properties. These error sources have been discussed widely in the literature (see [3] for a comprehensive survey). Most of commercial cameras include nowadays hardware compensation for many of these errors.

Correction of non-systematic errors is more challenging as their influence depends on the target scene and cannot be calibrated (see [4]). We highlight: i) flying pixels, ii) depth ambiguity, when depth range involves more than one period of the modulation signal, iii) light scattering within the lens and the sensor, iv) multipath interference and v) motion artifacts. In this paper we study motion artifacts (MoArt) phenomena (see [5]) and we propose a solution to compensate them in PMD based cameras.

High motion dynamics in the scene causes significant distortion in depth estimation, specially in the vicinity of depth discontinuities and points with strong texture changes. If motion happens during the integration time Tint
                      (30–2000μs in commercial cameras), a pixel integrates incoherent signals, which leads to remarkable artifacts in the depth image. To illustrate the problem, we show in Fig. 1
                      an example of both the effect of motion artifacts and our correction. Left column of Fig. 1 shows depth and amplitude images of a moving planar object, registered with a commercial ToF camera. Right column of Fig. 1 shows the result of our algorithm, where the correct shape is recovered.

This paper proposes a method that removes motion artifacts from a single frame captured by a PMD ToF camera without altering current hardware. Our method exploits spatial and temporal redundancy present in current PMD pixel pipeline to correct depth measurements caused by the motion. We show in the paper that as a result of the proposed correction method, a single PMD ToF image can be used to measure motion vectors along occluding contours of the scene in the image. Our method is very accurate, recovering depth in very challenging scenarios under high dynamics. It outperforms the state of art based on using several frames for correction. In addition, our method runs in real time in a single core CPU processor, does not require high amount of memory and can be integrated in camera hardware.

This article is structured as follows: previous works are reviewed in Section 2. A description of time of flight fundamentals and motion artifacts phenomena is detailed in Sections 3 and 4, respectively. Our single frame approach and the motion estimation algorithm are explained in Sections 5 and 6, respectively. Quantitative and qualitative results obtained using a commercially available PMD-based ToF camera are shown in Section 7. Finally, conclusions are discussed in Section 8.

Several studies show the impact of motion artifacts in ToF imaging [5–7]. Some of them propose methods to remove the artifacts. Lottner et al. [5] combine a ToF camera and a color camera to accurately detect the edges of the scene, removing motion artifacts. Schmidt [6] analyzes the origin and effects of motion artifacts in PMD-based ToF cameras and proposes a method to detect pixels affected by motion. He also proposes a new hardware architecture to reduce motion artifacts that consist of a 4-well CMOS sensor that gets simultaneously 4 correlation samples. In that manner, the total integration time is reduced as it uses a single stage. Schmidt's [6] architecture is nowadays prohibitive and sensor manufacturers mainly produce 2-well sensors. More recently, Lee et al. [8,9] study the physical phenomena that generates motion artifacts and propose some methods to detect them. Furthermore, they propose a simple method to correct the artifacts that require user interaction.

Recent works [10,7,11,8,9,12] detect and remove automatically motion artifacts by exploiting consistency between phase images in PMD-based architectures. These works can be separated into single frame and multi frame approaches.

Single frame approaches exploit the fact that in existing PMD cameras phase images are sequentially obtained, revealing motion. Hussmann et al. [7] detect motion artifacts from discrepancies between phase images. Motion compensation is proposed only for lateral movements in a conveyor belt. This method requires photometric calibration of the camera, is restricted to a very close range (distances below 100cm) and is vulnerable to intensity changes by different pixels. Lindner et al. [10] distinguish between lateral and axial motion. In the former, artifacts are compensated by computing dense optical flow between consecutive “intensity phase images”. Intensity phase images are obtained from raw CMOS measurements of each pixel that need to be accessible from the camera (e.g. phase images are computed from the differences of raw images). Optical flow is then used to correct phase images, removing motion artifacts. To correct axial motion, Lindner et al. [10] need two consecutive frames that are individually corrected from lateral motion artifacts. This proposal is time demanding and it has to deal with the inherent problems in optical flow estimation (normalization of phase images, aperture problem…). Lefloch et al.'s proposal [13] is an improvement of Lindner et al.'s [10] proposal that reduces the number of flow calculations. As it is stated by the authors, optical flow computation is a very time demanding process that requires GPU hardware to be real-time. Very recently Hoegg et al. [12] present a flow like algorithm which uses particular parts of Lindner et al. [10] (flow field) and Lefloch et al. [13] (binarization of the motion area with an experimental threshold). The proposal simultaneously estimates the motion field in motion areas and corrects the artifacts by applying the computed flow field directly to the raw phase values of each individual CMOS channel. As in Lindner et al. [10] the approach does require a phase normalization step in order to apply the algorithm. The motion direction estimation is based in local consistency and it has a time complexity of 
                        O
                        
                           
                              n
                              2
                           
                        
                      that restricts the local neighborhood radius search to achieve real time. To overcome this problem, they propose to use a previous frame to initialize the search direction assuming linear motion. A median filter is applied optionally to remove outliers in the flow field optimization. All existing single frame methods have in common that they require to have access to each individual channel of the ToF CMOS sensor.

In multiple frame methods, temporal consistency between frames is exploited to correct motion artifacts. Schmidt [11] detects inconsistent motion events between the different stages of the “4 phase-shift” pipeline using two consecutive frames. The main assumption is that only one motion event can occur within 2 consecutive frames. This assumption is violated easily in many cases considering fast movements in the scene. In practice this method has some limitations and raises important issues about reading gaps between consecutive frames, that in many cases can be much larger than the integration time. Methods considered as single frame propose also to use previous frames to improve efficiency [12] or to correct axial motion artifacts [10].

To conclude, the literature counts with several solutions to detect and to correct motion artifacts. Some of them require hardware modifications or special setups. Single frame methods are the most promising approaches, as they can correct motion artifacts under fast and uncontrolled motion. However, despite existing single frame methods provide accurate results (specially [12]) they are computationally expensive and they all require access to raw CMOS channels in the sensor. Following manufacturers trend, existing low-cost PMD ToF cameras (e.g. PMD CamBoard nano) only give access to 4 phase images (differences of raw CMOS channels), which makes existing single frame methods not applicable on those cameras. We propose a single frame method that reduces motion artifacts and estimates motion of occluding contours in real time using a single PMD frame as an input, where only phase images are available. Our proposal works for general motions, it does not require user interaction nor hardware improvements and it has been validated for low cost commercial PMD ToF cameras and very high motion dynamics.

ToF technology obtains depth from the phase difference between the emitted and the received signal after colliding with the scene. We define um
                     (t) as the T periodic square signal used to modulate light:
                        
                           (1)
                           
                              
                                 
                                    
                                       
                                          u
                                          m
                                       
                                       
                                          t
                                       
                                       =
                                       
                                          
                                             
                                                
                                                   1
                                                   ,
                                                
                                                
                                                   if
                                                   
                                                   0
                                                   
                                                   ≤
                                                   t
                                                   −
                                                   n
                                                   ⋅
                                                   T
                                                   ≤
                                                   
                                                   T
                                                   /
                                                   2
                                                
                                             
                                             
                                                
                                                   0
                                                   ,
                                                
                                                
                                                   if
                                                   
                                                   T
                                                   /
                                                   2
                                                   
                                                   ≤
                                                   t
                                                   −
                                                   n
                                                   ⋅
                                                   T
                                                   ≤
                                                   
                                                   T
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                       ⋅
                                    
                                 
                                 
                                    
                                       n
                                       =
                                       0
                                       ,
                                       1
                                       ,
                                       2
                                       ,
                                       …
                                    
                                 
                              
                           
                        
                     
                  

The received signal r(t), reflected from the scene, is represented with the following continuous wave function:
                        
                           (2)
                           
                              r
                              
                                 t
                              
                              =
                              
                                 a
                                 0
                              
                              ⋅
                              sin
                              ⁡
                              
                                 
                                    ω
                                    t
                                    +
                                    β
                                 
                              
                              +
                              O
                              ,
                           
                        
                     where ao
                      is the signal amplitude, ω
                     =2π/T and β
                     =
                     ω
                     ⋅
                     T
                     
                        L
                      is the phase shift caused by the time of flight TL
                     . Depth is then computed as 
                        d
                        =
                        
                           
                              c
                              ⋅
                              
                                 T
                                 L
                              
                           
                           2
                        
                     , with c the speed of light in the medium (i.e. vacuum). The offset O is composed of two additive terms:
                        
                           (3)
                           
                              O
                              =
                              
                                 O
                                 
                                    b
                                    g
                                 
                              
                              +
                              
                                 O
                                 dc
                              
                              ,
                           
                        
                     where Obg
                      is due to background illumination and Odc
                      appears as the DC component of the modulated infrared light source.

PMD technology is based on sampling the correlation function between r(t) and um
                     (t) to obtain depth:
                        
                           (4)
                           
                              
                                 ρ
                                 τ
                              
                              =
                              
                                 K
                                 
                                    i
                                    n
                                    t
                                 
                              
                              ⋅
                              
                                 1
                                 T
                              
                              
                                 
                                    ∫
                                    0
                                    T
                                 
                                 
                                    
                                       u
                                       m
                                    
                                    
                                       
                                          t
                                          +
                                          τ
                                       
                                    
                                    ⋅
                                    r
                                    
                                       t
                                    
                                    
                                    d
                                    ⁡
                                    t
                                    =
                                    
                                       K
                                       
                                          i
                                          n
                                          t
                                       
                                    
                                    ⋅
                                    
                                       
                                          
                                             
                                                a
                                                0
                                             
                                             π
                                          
                                          ⋅
                                          cos
                                          ⁡
                                          
                                          
                                             
                                                β
                                                +
                                                τ
                                             
                                          
                                          +
                                          
                                             O
                                             2
                                          
                                       
                                    
                                 
                              
                              ,
                           
                        
                     where a
                     0, β and O are the unknown. Kint
                      takes into account the total number of periods T integrated over the integration time of the sensor Tint
                     , which is thousand times bigger than T.

Each PMD “smart pixel” contains 2 CMOS wells that accumulate voltage that corresponds to samples of the correlation function ρτ
                      and ρ
                     
                        τ
                        +
                        π
                      (see [14] for further details). We refer to the voltage accumulated on each well as U
                     
                        τ
                     
                     
                        A
                      and U
                     
                        τ
                     
                     
                        B
                     . Their relationship with ρτ
                      can be approximated by the following linear function:
                        
                           (5)
                           
                              
                                 U
                                 τ
                                 A
                              
                              =
                              
                                 G
                                 A
                              
                              ⋅
                              
                                 ρ
                                 τ
                              
                              +
                              
                                 O
                                 A
                              
                              
                              
                                 U
                                 τ
                                 B
                              
                              =
                              
                                 G
                                 B
                              
                              ⋅
                              
                                 ρ
                                 
                                    τ
                                    +
                                    π
                                 
                              
                              +
                              
                                 O
                                 B
                              
                              ,
                           
                        
                     where GA
                      and GB
                      are the conversion gains that translate optical energy into voltage and OA
                      and OB
                      are the offsets. In general GA
                     
                     ≠
                     GB
                      and OA
                     
                     ≠
                     OB
                      due to non-isotropic material properties that appear during sensor manufacturing. Lindner [15] gives a detailed description of these variations called Fixed Pattern Noise (FPN). Despite being considered as noise, it is a systematic error that can be calibrated.

Taking the difference U
                     
                        τ
                     
                     
                        A
                     
                     −
                     U
                     
                        τ
                     
                     
                        B
                      we get:
                        
                           (6)
                           
                              
                                 
                                    
                                       
                                          φ
                                          τ
                                       
                                       =
                                       
                                          U
                                          τ
                                          A
                                       
                                       −
                                       
                                          U
                                          τ
                                          B
                                       
                                       =
                                       
                                          G
                                          
                                             F
                                             P
                                             N
                                          
                                       
                                       ⋅
                                       
                                          
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                
                                                   2
                                                   ⋅
                                                   
                                                      a
                                                      0
                                                   
                                                
                                                π
                                             
                                             ⋅
                                             cos
                                             ⁡
                                             
                                             
                                                
                                                   β
                                                   +
                                                   τ
                                                
                                             
                                          
                                       
                                       +
                                       
                                          O
                                          cal
                                       
                                    
                                 
                                 
                                    
                                       
                                       =
                                       a
                                       ⋅
                                       cos
                                       ⁡
                                       
                                          
                                             β
                                             +
                                             τ
                                          
                                       
                                       +
                                       
                                          O
                                          cal
                                       
                                    
                                 
                              
                           
                        
                     where G
                     FPN is the FPN gain and Ocal
                      is the offset term which depends on the background illumination O and can be calibrated:
                        
                           (7a)
                           
                              
                                 G
                                 
                                    F
                                    P
                                    N
                                 
                              
                              =
                              
                                 
                                    
                                       G
                                       A
                                    
                                    +
                                    
                                       G
                                       B
                                    
                                 
                                 2
                              
                           
                        
                     
                     
                        
                           (7b)
                           
                              
                                 O
                                 cal
                              
                              =
                              
                                 O
                                 2
                              
                              ⋅
                              
                                 K
                                 
                                    i
                                    n
                                    t
                                 
                              
                              ⋅
                              
                                 
                                    
                                       G
                                       A
                                    
                                    −
                                    
                                       G
                                       B
                                    
                                 
                              
                              +
                              
                                 
                                    
                                       O
                                       A
                                    
                                    −
                                    
                                       O
                                       B
                                    
                                 
                              
                              .
                           
                        
                     
                  

There are thus a, β, G
                     FPN and Ocal
                      as unknowns, whereas only β contains depth information.

Current PMD devices implement the “4 phase-shift” architecture, which consists on a 4-stage pipeline where φτ
                      is computed at τ
                     ={0,
                     π/2,
                     π,3π/2} in 4 sequential stages. In Fig. 2
                      we show a summarized cross-section of a PMD-based “smart pixel” with the acquisition pipeline (notice that the capture of every phase image is followed by a readout gap). QA
                      and QB
                      are the accumulated charges in each of the two well.

From Eq. (6) we can observe that the following relationships are satisfied:
                        
                           (8)
                           
                              
                                 
                                    
                                       
                                          φ
                                          0
                                       
                                       
                                       =
                                       
                                       −
                                       
                                          φ
                                          π
                                       
                                    
                                 
                                 
                                    
                                       
                                          φ
                                          
                                             π
                                             /
                                             2
                                          
                                       
                                       
                                       =
                                       
                                       −
                                       
                                          φ
                                          
                                             3
                                             π
                                             /
                                             2
                                          
                                       
                                       .
                                    
                                 
                              
                           
                        
                     
                  

This temporal redundancy between φ
                     0
                     −
                     φπ
                      and φ
                     
                        π/2
                     −
                     φ
                     3π/2 is used in the “4 phase-shift algorithm” to cancel the effect of FPN. Usually the value of φτ
                      is accessible from the sensor instead of U
                     
                        τ
                     
                     
                        A
                      and U
                     
                        τ
                     
                     
                        B
                     .

Depth d and amplitude a are then obtained irrespective of FPN gain and offset variations:
                        
                           (9a)
                           
                              d
                              =
                              
                                 c
                                 
                                    2
                                    ⋅
                                    ω
                                 
                              
                              ⋅
                              arctan
                              ⁡
                              
                                 
                                    
                                       
                                          φ
                                          
                                             3
                                             π
                                             /
                                             2
                                          
                                       
                                       −
                                       
                                          φ
                                          
                                             π
                                             /
                                             2
                                          
                                       
                                    
                                    
                                       
                                          φ
                                          0
                                       
                                       −
                                       
                                          φ
                                          π
                                       
                                    
                                 
                              
                           
                        
                     
                     
                        
                           (9b)
                           
                              a
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   φ
                                                   
                                                      3
                                                      π
                                                      /
                                                      2
                                                   
                                                
                                                −
                                                
                                                   φ
                                                   
                                                      π
                                                      /
                                                      2
                                                   
                                                
                                             
                                          
                                          2
                                       
                                       +
                                       
                                          
                                             
                                                
                                                   φ
                                                   0
                                                
                                                −
                                                
                                                   φ
                                                   π
                                                
                                             
                                          
                                          2
                                       
                                    
                                 
                                 2
                              
                              .
                           
                        
                     
                  

State of the art methods propose calibration techniques of the terms GA
                     , GB
                     , OA
                     , OB
                      which can reduce the number of phase images (φτ
                     ) from the initial 4 samples to 2 or even 1 sample (see [16] and [17], respectively). Calibration of FPN usually requires special lighting conditions (see [16]) or patterns. We show next that only calibration of Ocal
                      is needed to get depth from only two phase images. We present a calibration method without patterns or special lighting conditions, just by taking a short sequence of images from a static scene in complete darkness.

Based on [16], if the offset Ocal
                         is known, the depth and amplitude values can be obtained with only two samples of φτ
                        :
                           
                              (10a)
                              
                                 d
                                 =
                                 
                                    c
                                    
                                       2
                                       ⋅
                                       ω
                                    
                                 
                                 ⋅
                                 
                                    arctan
                                    ⁡
                                 
                                 
                                    
                                       
                                          
                                             φ
                                             
                                                τ
                                                2
                                             
                                          
                                          −
                                          
                                             O
                                             cal
                                          
                                       
                                       
                                          
                                             φ
                                             
                                                τ
                                                1
                                             
                                          
                                          −
                                          
                                             O
                                             cal
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (10b)
                              
                                 a
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   φ
                                                   
                                                      τ
                                                      1
                                                   
                                                
                                                −
                                                
                                                   O
                                                   cal
                                                
                                             
                                          
                                          2
                                       
                                       +
                                       
                                          
                                             
                                                
                                                   φ
                                                   
                                                      τ
                                                      2
                                                   
                                                
                                                −
                                                
                                                   O
                                                   cal
                                                
                                             
                                          
                                          2
                                       
                                    
                                 
                                 ,
                              
                           
                        where τ
                        2
                        =
                        τ
                        1
                        +
                        π/2 with τ
                        1
                        ∈{0,
                        π} (note that in Eq. (10a) the sign of 
                           
                              φ
                              
                                 τ
                                 
                                    1
                                    2
                                 
                              
                           
                         changes accordingly to the sign of the corresponding correlation sample). Eq. (10a) shows that we can use only two consecutive steps (
                           
                              φ
                              
                                 τ
                                 1
                              
                           
                         and 
                           
                              φ
                              
                                 
                                    τ
                                    1
                                 
                                 +
                                 π
                                 /
                                 2
                              
                           
                        ) of the “4 phase-shift” pipeline to get depth.

We propose a calibration method that requires a number NF
                         of views from a static scene (i.e. camera is still with respect to the scene and objects in the scene are not moving). For every frame in the sequence we get 4 raw channel measurements of a single pixel:
                           
                              (11)
                              
                                 
                                    
                                       
                                          
                                             φ
                                             0
                                             i
                                          
                                          ,
                                          
                                          
                                             φ
                                             
                                                π
                                                /
                                                2
                                             
                                             i
                                          
                                          ,
                                          
                                          
                                             φ
                                             π
                                             i
                                          
                                          ,
                                          
                                          
                                             φ
                                             
                                                
                                                   3
                                                   π
                                                
                                                2
                                             
                                             i
                                          
                                       
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       N
                                       F
                                    
                                 
                                 .
                              
                           
                        
                     

We sample Ocal
                         from every two channels separated by π:
                           
                              (12)
                              
                                 
                                    O
                                    i
                                    cal
                                 
                                 =
                                 
                                    1
                                    2
                                 
                                 ⋅
                                 
                                    
                                       
                                          φ
                                          τ
                                          i
                                       
                                       +
                                       
                                          φ
                                          
                                             τ
                                             +
                                             π
                                          
                                          i
                                       
                                    
                                 
                                 .
                              
                           
                        
                     

Based on Mufti et al. [18] and the recent work of Hussmann et al. [19], we can assume that, if enough photons are collected, Ocal
                         follows a Gaussian distribution 
                           N
                           
                              
                                 
                                    O
                                    ^
                                 
                                 cal
                              
                              
                                 σ
                                 O
                              
                           
                        , that we estimate from the samples obtained with Eq. (12).

We show in Fig. 3
                         the computed normal distribution of Ocal
                         for two random pixels in an image taken by a commercial ToF camera.

From Eq. (7b), Ocal
                         is composed of two terms. We assume in practice that (GA
                        
                        −
                        GB
                        )≈0, being the second term (OA
                        
                        −
                        OB
                        ) the leading factor in Ocal
                        . Unlike the first term, that depends on O and Kint
                        , the offset term (OA
                        
                        −
                        OB
                        ) does not vary with depth, integration time, background illumination or light source offset. Calibration of Ocal
                         can thus be performed offline and stored. We validate this assumption experimentally in Section 7.

When the scene moves with respect to the camera, each stage of the “4 phase-shift” pipeline captures different depths, producing errors when they are combined to get depth. We exploit the fact that in PMD cameras the 4 stages of the pipeline are run sequentially to detect motion inconsistency at every pixel. As each stage is run at a fraction of Tint
                     , we consider in the paper that the motion inside each stage is very small.

In Fig. 4
                      we represent the sampled phase images in a pixel that belongs to the left occluding contour of the object. On that pixel we show that while φ
                     0 and φ
                     
                        π/2 are properly obtained from the foreground, at φπ
                      there is a sudden change of depth from foreground to background. In last stage (φ
                     3π/2), only background depth is detected.

If we use Eqs. (9a) and (9b), the resulting depth appears distorted due to the inconsistency of the different samples (distorted image in Fig. 1). We propose to detect motion artifacts in a single pixel with the following criterion:


                     A pixel is said to be affected by motion artifacts if:
                        
                           (13)
                           
                              
                                 
                                    
                                       
                                          
                                             φ
                                             0
                                          
                                          +
                                          
                                             φ
                                             π
                                          
                                       
                                    
                                    −
                                    
                                       
                                          
                                             φ
                                             
                                                π
                                                /
                                                2
                                             
                                          
                                          +
                                          
                                             φ
                                             
                                                3
                                                π
                                                /
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                              >
                              γ
                              ,
                           
                        
                     where γ is a fixed threshold obtained by the following calibration process.

To establish a threshold γ we model statistically the distribution of:
                           
                              (14)
                              
                                 η
                                 =
                                 
                                    
                                       
                                          φ
                                          0
                                       
                                       +
                                       
                                          φ
                                          π
                                       
                                    
                                 
                                 −
                                 
                                    
                                       
                                          φ
                                          
                                             π
                                             /
                                             2
                                          
                                       
                                       +
                                       
                                          φ
                                          
                                             3
                                             π
                                             /
                                             2
                                          
                                       
                                    
                                 
                              
                           
                        in the case of images where the scene is static with respect to the camera. We assume that η follows a Gaussian distribution 
                           N
                           
                              
                                 η
                                 ¯
                              
                              
                                 σ
                                 η
                              
                           
                         that can be estimated by sampling. We then propose γ
                        =3.326⋅
                        σ
                        
                           η
                        , that contains the 99.97% of the distribution when no motion artifacts are present. In Section 7.1 we show the estimation of the inconsistency threshold for several values of Tint
                         in a commercial PMD camera.

We propose a method that removes motion artifacts from a single frame (i.e. 4 phase images). Our method is based on two basic assumptions: i) after calibration of the offset, depth can reliably be obtained from two consecutive phase images and ii) neighboring pixels are a strong cue to complete information that is lost due to motion artifacts.

We can distinguish 3 main steps in our proposal:
                        
                           1.
                           
                              Calibration: is the responsible for performing the offset calibration (see Section 3.1) and determining the inconsistency threshold (see Section 4.1) automatically with no user interaction. After these two steps we can detect pixels affected with motion artifacts and we can obtain depth using the pseudo 4 phase-shift algorithm.


                              Event detection: in this step we characterize the event in terms of: i) the phase image where the event appears and ii) the direction of the event (rising or falling edge). Hence, we have a discrete label for each pixel affected by motion that includes both temporal and depth change information.


                              Depth correction: in this stage we correct the depth value of every pixel affected by motion artifacts. We combine the information available in the phase images with neighbor pixels.

As explained in Section 3 we remove the influence of Fixed Pattern Noise in order to compute depth measurements using only two of the four phase images provided by the sensor (the so called “pseudo 4 phase-shift algorithm” explained in [16]). In addition, we apply a statistical method to find threshold γ, explained in Section 4.1. Both processes are done only once at the beginning. Calibration requires to show the camera a static scene during several seconds. During calibration we avoid regions of the image with strong depth discontinuities, saturation and low reflective surfaces.

When a pixel is affected by motion it receives light from multiple depths during Tint
                        . In occluding contours, motion produces abrupt depth transitions, mainly affecting a single phase of the pixel. We detect events by monitoring sudden changes between the 4 phase images labeling them accordingly.

We use a discrete labeling cel (coarse event location) that represents the phase image containing the event and the direction (i.e. rising edge or falling edge) of the depth change caused by the motion. We use the following set of 9 labels:
                           
                              (15)
                              
                                 c
                                 e
                                 l
                                 ∈
                                 
                                    
                                       −
                                       4
                                       ,
                                       −
                                       3
                                       ,
                                       −
                                       2
                                       ,
                                       −
                                       1
                                       ,
                                       0
                                       ,
                                       +
                                       1
                                       ,
                                       +
                                       2
                                       ,
                                       +
                                       3
                                       ,
                                       +
                                       4
                                    
                                 
                                 ,
                              
                           
                        
                     

where |cel| represents the phase image affected by a depth transition and its sign characterizes the depth gradient. (e.g. cel
                        =+1 means a rising edge event in φ
                        0 and cel
                        =−2 means a falling edge event in φ
                        
                           π/2). The absence of events is represented by cel
                        =0.

Event labeling is divided into two steps:
                           
                              1
                              
                                 Detection of the event location: in this step we localize the phase image that is distorted due to motion, i.e. |cel|.


                                 Detection of the event direction: we characterize depth transitions with two classes: {rising, falling} events, i.e. sign of cel.

Our method for detecting the phase affected by a motion event is based on the following two main assumptions:
                              
                                 •
                                 An event is generated by the transition of two depths ({β
                                    1, β
                                    2}).

There is only one depth transition affecting a single phase image during integration time.

From Eq. (13), if there is no event in the current pixel (|cel|=0) the following inequalities hold: i) |φ
                           0
                           +
                           φ
                           
                              π
                           |<
                           γ and ii) |φ
                           
                              π/2
                           +
                           φ
                           3π/2|<
                           γ, where γ is a small threshold that has been previously calibrated. Otherwise, we detect the position of the events by checking the following tests in sequential order:
                              
                                 (16)
                                 
                                    
                                       
                                          
                                             a
                                             )
                                          
                                          
                                             |
                                             c
                                             e
                                             l
                                             |
                                             =
                                             1
                                          
                                          
                                             ⇔
                                          
                                          
                                             |
                                             
                                                φ
                                                0
                                             
                                             +
                                             
                                                φ
                                                π
                                             
                                             |
                                             >
                                             γ
                                          
                                          
                                             and
                                          
                                          
                                             |
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             +
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             |
                                             <
                                             γ
                                          
                                       
                                       
                                          
                                             b
                                             )
                                          
                                          
                                             |
                                             c
                                             e
                                             l
                                             |
                                             =
                                             4
                                          
                                          
                                             ⇔
                                          
                                          
                                             |
                                             
                                                φ
                                                0
                                             
                                             +
                                             
                                                φ
                                                π
                                             
                                             |
                                             <
                                             γ
                                          
                                          
                                             and
                                          
                                          
                                             |
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             +
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             |
                                             >
                                             γ
                                          
                                       
                                       
                                          
                                             c
                                             )
                                          
                                          
                                             |
                                             c
                                             e
                                             l
                                             |
                                             =
                                             2
                                             
                                             or
                                             |
                                             c
                                             e
                                             l
                                             |
                                             =
                                             3
                                          
                                          
                                             ⇔
                                          
                                          
                                             |
                                             
                                                φ
                                                0
                                             
                                             +
                                             
                                                φ
                                                π
                                             
                                             |
                                             >
                                             γ
                                          
                                          
                                             and
                                          
                                          
                                             |
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             +
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             |
                                             >
                                             γ
                                          
                                       
                                    
                                    .
                                 
                              
                           
                        

To distinguish between events in |cel|=2 or |cel|=3, we first write the equations of all phases from Eq. (6), once we have calibrated the offset term Ocal
                            (see Section 3.1):
                              
                                 (17)
                                 
                                    
                                       
                                          
                                             
                                                φ
                                                0
                                             
                                             
                                             =
                                             
                                             +
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                ′
                                             
                                             ⋅
                                             
                                                cos
                                                ⁡
                                             
                                             β
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             
                                             =
                                             
                                             −
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                ′
                                             
                                             ⋅
                                             
                                                sin
                                                ⁡
                                             
                                             β
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                π
                                             
                                             
                                             =
                                             
                                             −
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                ′
                                             
                                             ⋅
                                             
                                                cos
                                                ⁡
                                             
                                             β
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             
                                             =
                                             
                                             +
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                ′
                                             
                                             ⋅
                                             sin
                                             ⁡
                                             β
                                          
                                       
                                    
                                 
                              
                           where 
                              
                                 a
                                 ′
                              
                              =
                              
                                 G
                                 
                                    F
                                    P
                                    N
                                 
                              
                              ⋅
                              
                                 
                                    2
                                    ⋅
                                    
                                       a
                                       0
                                    
                                 
                                 π
                              
                           .

If an event appears in |cel|=2, φ
                           
                              π/2 contains the mixture of two phase shifts {β
                           1, β
                           2}. Hence, we can express Eq. (17) considering the phase mixture as:
                              
                                 (18)
                                 
                                    
                                       
                                          
                                             
                                                φ
                                                0
                                             
                                             
                                             =
                                             
                                             +
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                1
                                                ′
                                             
                                             ⋅
                                             cos
                                             ⁡
                                             
                                                β
                                                1
                                             
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             
                                             =
                                             
                                             −
                                             
                                                K
                                                1
                                             
                                             ⋅
                                             
                                                a
                                                1
                                                ′
                                             
                                             ⋅
                                             sin
                                             ⁡
                                             
                                             
                                                β
                                                1
                                             
                                             −
                                             
                                                K
                                                2
                                             
                                             ⋅
                                             
                                                a
                                                2
                                                ′
                                             
                                             ⋅
                                             sin
                                             ⁡
                                             
                                                β
                                                2
                                             
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                π
                                             
                                             
                                             =
                                             
                                             −
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                2
                                                ′
                                             
                                             ⋅
                                             cos
                                             ⁡
                                             
                                                β
                                                2
                                             
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             
                                             =
                                             
                                             +
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                a
                                                2
                                                ′
                                             
                                             ⋅
                                             sin
                                             ⁡
                                             
                                                β
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                           where a
                           1′, a
                           2′ are the corresponding amplitude values of the two depths involved in the generation of the artifact and Kint
                           
                           =
                           K
                           1
                           +
                           K
                           2.

We use Eq. (18) to express φ
                           0
                           +
                           φπ
                            and φ
                           
                              π/2
                           +
                           φ
                           3π/2 as follows:
                              
                                 (19)
                                 
                                    
                                       
                                          
                                             
                                                φ
                                                0
                                             
                                             +
                                             
                                                φ
                                                π
                                             
                                             
                                             =
                                             
                                             
                                                K
                                                
                                                   i
                                                   n
                                                   t
                                                
                                             
                                             ⋅
                                             
                                                
                                                   
                                                      a
                                                      1
                                                      ′
                                                   
                                                   ⋅
                                                   cos
                                                   ⁡
                                                   
                                                      β
                                                      1
                                                   
                                                   −
                                                   
                                                      a
                                                      2
                                                      ′
                                                   
                                                   ⋅
                                                   cos
                                                   ⁡
                                                   
                                                      β
                                                      2
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             
                                                φ
                                                
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             +
                                             
                                                φ
                                                
                                                   3
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             
                                             =
                                             
                                             
                                                K
                                                1
                                             
                                             ⋅
                                             
                                                
                                                   
                                                      a
                                                      2
                                                      ′
                                                   
                                                   ⋅
                                                   sin
                                                   ⁡
                                                   
                                                      β
                                                      2
                                                   
                                                   −
                                                   
                                                      a
                                                      1
                                                      ′
                                                   
                                                   ⋅
                                                   sin
                                                   ⁡
                                                   
                                                      β
                                                      1
                                                   
                                                
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        

We propose to detect events in the second interval (|cel|=2) by checking the following condition:
                              
                                 (20)
                                 
                                    
                                       
                                          
                                             φ
                                             0
                                          
                                          +
                                          
                                             φ
                                             π
                                          
                                       
                                    
                                    >
                                    
                                       
                                          
                                             φ
                                             
                                                π
                                                /
                                                2
                                             
                                          
                                          +
                                          
                                             φ
                                             
                                                3
                                                π
                                                /
                                                2
                                             
                                          
                                       
                                    
                                    .
                                 
                              
                           
                        

Finally, the identification of an event in φπ
                            (|cel|=3) is defined as the event that does not satisfy the statements of |cel|={1,4,2}, in that order. As a consequence of following the sequential pipeline described in Eq. (16) to detect the event location, the labeling error is determined by the detection of |cel|=2. To test when inequality (20) holds, in Fig. 5a we plot the number of incorrectly labeled events depending on the value of K
                           1 for every possible combination of {β
                           1, β
                           2} (sweeping both terms over the (0, 2π) interval) in the depth range 0–5m. In Fig. 5b we fix β
                           1 to be in a specific depth quadrant Qi
                            (see Eq. (21)), sweeping β
                           2 over all possible values. To create Fig. 5 we use Eq. (18), assuming that amplitudes a
                           1′ and a
                           2′ are inversely proportional to the square of the corresponding depth.

We observe in Fig. 5 that the percentage of erroneous event classification increases with the factor K
                           1. However, when K
                           1
                           ≈
                           Kint
                           , the event is closer to be happening in the transition between |cel|=2 and |cel|=3. Those mistakes are thus not very relevant as there is no practical difference between considering the event to be classified as |cel|=2 or |cel|=3. As shown in Fig. 5, if we only consider those classification errors committed when K
                           1/K
                           
                              int
                           
                           <0.66, the detection of events in |cel|=2 remains in average below 35% of error. This corresponds with the results we obtain in real sequences (see Section 7), where despite these classification errors, the event detection allows us to effectively detect and compensate motion artifacts. The complete event detection pipeline is resumed in Algorithm 1 (Appendix A).

Given that we know the phase image affected by a motion artifact, we identify the direction of the event as follows:
                              
                                 •
                                 
                                    Falling edge: when there's a transition from foreground to background (β
                                    2
                                    >
                                    β
                                    1).


                                    Rising edge: when there's a transition from background to foreground (β
                                    2
                                    <
                                    β
                                    1).

So that we can make a proper substitution (using local neighborhood) of the erroneous measurements and correct the artifacts.

Let's divide the maximum depth range of the camera into its corresponding depth quadrants Qi
                            s.t.
                              
                                 (21)
                                 
                                    
                                       Q
                                       i
                                    
                                    =
                                    i
                                    ⇔
                                    β
                                    ∈
                                    
                                       
                                          
                                             
                                                i
                                                −
                                                1
                                             
                                          
                                          ⋅
                                          
                                             π
                                             2
                                          
                                          ,
                                          i
                                          ⋅
                                          
                                             π
                                             2
                                          
                                       
                                    
                                    ,
                                    i
                                    ∈
                                    
                                       1
                                       2
                                       3
                                       4
                                    
                                    .
                                 
                              
                           
                        

Then, for each pixel affected by motion we can easily obtain the involved depth quadrants (Qbg
                           , Qfg
                           ) by clustering the depths of each pixel in a local neighborhood (we use the 2 depths per pixel using the pseudo four-phase shift algorithm).

The direction of an event is detected by simply checking the sign of the phase image difference shifted by π, according to the involved phase quadrants. The whole labeling method is detailed in Appendix A and Appendix B. In Fig. 6
                            we show the detection of the event direction in several cases where multiple depth quadrants are involved. In the experiments of Fig. 6 the background depth varies along the whole range while the foreground varies from motion in Q
                           1 (first two columns) to motion in Q
                           2 (last two columns). Note that, due to the weak illumination power, uncertainty is high for depths above 1.5m approximately (Q
                           2 and higher), generating undesirable effects.

Finally, in Fig. 7
                            we show the events detected in the example shown in Fig. 1, using a color palette that represents the value of cel. We codify every pixel of the object with a color (i.e. from dark blue to light pink) that represents the stage {φ
                           0,
                           φ
                           
                              π/2,
                           φ
                           
                              π
                           ,
                           φ
                           3π/2} in the “4 phase shift” pipeline which is affected by the transition from foreground to background (i.e. blue colors) and from background to foreground (i.e. red colors). Fig. 8
                            illustrates the detection of a rising edge event in φ
                           
                              π/2. We define {φbg
                           , φfg
                           } as the phase images associated with background (low charge) and foreground (high charge) depths respectively.

Our depth correction algorithm is based on two basic rules: i) we reconstruct the depth detected at the beginning of the integration time and ii) we reconstruct depth using two previous consecutive phases to the phase affected by the motion event. If less than two consecutive phase images are available we search in neighboring pixels to complete data.

According to rule i), we obtain local foreground depth on falling edge events (from foreground to background) and the local background depth on rising edge events (from background to foreground).

From rule ii), events in φπ
                         or φ
                        3π/2 allow us to recover depth directly from the phases φ
                        0 or φ
                        
                           π/2 using Eq. (10a). If the event is detected in any of the first two phases, we search in the local neighborhood to recover depth. We show in Table 1
                         the case studies depending the position of the detected event. We also point out the required phase images needed to recover the corresponding depth and the cel labeling we look for in the neighbors to get a replacement. As depicted from Table 1, we need to search for neighbors in half of the cases.

The strategy to find neighbors involves two methodologies: i) to look for the closest pixels that have the same event type (rising or falling edge) but complementary stable phase images and ii) to look for the nearest points that have no motion artifact and compatible stable phase images. In Fig. 9
                         we show an example of our proposal to replace missing data with spatial information of a pixel affected by motion characterized with a falling edge in the second phase image (φ
                        
                           π/2).

Once we have found the most suitable neighbors, we sort them, identifying the median phase value. It's well known in the literature that the median filter is a robust and effective method for outlier removal. In a compromise between robustness and computational efficiency, we replace the corresponding phase images with the mean of the 3 closest candidates around the median. ToF measurements are then recovered using only 2 phase images. In the example shown in Fig. 9, where only one phase image is needed for substitution, the replacement would be computed in the following 2-step procedure:
                           
                              1.
                              Find the most suitable neighbors within the neighbor set ℛ
                                    i
                                  as the closest points to the pixel of interest with stable phase images in the required intervals. We search neighbors in a spiral loop until enough pixels are found (i.e. a minimum of Nn
                                 
                                 =7 is required to increase accuracy) or we exceed a reasonable distance (we fix this internal parameter with a radius distance of 20pixels). In practice a 20pixel radius distance can be in fact very conservative. We found that a radius distance between {2.5 and 4.9} pixel is enough in our camera after averaging the radius needed over several frames in a wide variety of dynamic scenarios.

Sort the previous data set and identify the median value. Finally, we compute the mean of the 3 closest points to the median:
                                    
                                       (22)
                                       
                                          
                                             φ
                                             
                                                
                                                   i
                                                   ,
                                                   π
                                                   /
                                                   2
                                                
                                             
                                             fg
                                          
                                          =
                                          
                                             1
                                             3
                                          
                                          
                                             
                                                ∑
                                                
                                                   j
                                                   =
                                                   
                                                      
                                                         me
                                                         
                                                            d
                                                            i
                                                         
                                                         −
                                                         1
                                                      
                                                   
                                                
                                                
                                                   me
                                                   
                                                      d
                                                      i
                                                   
                                                   +
                                                   1
                                                
                                             
                                             
                                                
                                                   
                                                      φ
                                                      ^
                                                   
                                                   
                                                      
                                                         j
                                                         ,
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   fg
                                                
                                                ,
                                             
                                          
                                       
                                    
                                 where φ
                                 (i,τ)
                                 
                                    z
                                  refers to the phase image φτ
                                  at pixel i, identified as background or foreground (i.e. z
                                 ={bg, fg}) and medi
                                  is the median value index for the neighbors dataset of pixel i ordered in the previous step 
                                    
                                       
                                          
                                             φ
                                             ^
                                          
                                          
                                             
                                                j
                                                ,
                                                π
                                                /
                                                2
                                             
                                          
                                          fg
                                       
                                    
                                 .

Additional post-processing of depth and amplitude measurements (like outliers removal, bilateral filtering…), as it is done in [10] and [12], could improve the results.

We show that, as a consequence of our depth correction algorithm, we can actually measure motion flow near occluding contours of the scene using a single ToF frame. We first define a method to accurately obtain the instant where a motion event is detected on each pixel, that we call pel (precise event location). We then use the gradient of pel image to obtain motion flow.

Let assume that we find an event in phase τ of current pixel using the proposed coarse event detection. We define φ
                        
                           τ
                        
                        
                           err
                         as the erroneous value of the phase image in phase τ. We model the event as a change between two depth values (e.g. background and foreground). We define φ
                        
                           τ
                        
                        
                           fg
                         and φ
                        
                           τ
                        
                        
                           bg
                         as the foreground and background phase images corresponding to τ. We assume that photon generation in the CMOS photo gates is proportional to exposure time and we define that φ
                        
                           τ
                        
                        
                           err
                         as a linear combination of φ
                        
                           τ
                        
                        
                           fg
                         and φ
                        
                           τ
                        
                        
                           bg
                        . Depending the direction of the event we define:
                           
                              (23)
                              
                                 
                                    φ
                                    τ
                                    err
                                 
                                 =
                                 
                                    
                                       
                                          
                                             α
                                             ⋅
                                             
                                                φ
                                                τ
                                                fg
                                             
                                             +
                                             
                                                
                                                   1
                                                   −
                                                   α
                                                
                                             
                                             ⋅
                                             
                                                φ
                                                τ
                                                
                                                   b
                                                   g
                                                
                                             
                                          
                                          
                                             ,
                                             if
                                             
                                             c
                                             e
                                             l
                                             <
                                             0
                                          
                                       
                                       
                                          
                                             α
                                             ⋅
                                             
                                                φ
                                                τ
                                                
                                                   b
                                                   g
                                                
                                             
                                             +
                                             
                                                
                                                   1
                                                   −
                                                   α
                                                
                                             
                                             ⋅
                                             
                                                φ
                                                τ
                                                fg
                                             
                                          
                                          
                                             ,
                                             if
                                             
                                             c
                                             e
                                             l
                                             >
                                             0
                                          
                                       
                                    
                                 
                                 ,
                              
                           
                        where α is the fraction of the integration time in phase τ before the event appears (see Fig. 10
                        ). Using the algorithm from Section 5.3, we can obtain φ
                        
                           τ
                        
                        
                           fg
                         and i
                        
                           τ
                        
                        
                           bg
                         from neighbor pixels and from phase images not affected by the event in the pixel. In Table 2
                         we show all possible cases to get φ
                        
                           τ
                        
                        
                           fg
                         and φ
                        
                           τ
                        
                        
                           bg
                        .

Using Eq. (23) we obtain α:
                           
                              (24)
                              
                                 α
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      τ
                                                      err
                                                   
                                                   −
                                                   
                                                      φ
                                                      τ
                                                      
                                                         b
                                                         g
                                                      
                                                   
                                                
                                                
                                                   
                                                      φ
                                                      τ
                                                      fg
                                                   
                                                   −
                                                   
                                                      φ
                                                      τ
                                                      
                                                         b
                                                         g
                                                      
                                                   
                                                
                                             
                                          
                                          
                                             ,
                                             if
                                             
                                             c
                                             e
                                             l
                                             <
                                             0
                                          
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      τ
                                                      err
                                                   
                                                   −
                                                   
                                                      φ
                                                      τ
                                                      fg
                                                   
                                                
                                                
                                                   
                                                      φ
                                                      τ
                                                      
                                                         b
                                                         g
                                                      
                                                   
                                                   −
                                                   
                                                      φ
                                                      τ
                                                      fg
                                                   
                                                
                                             
                                          
                                          
                                             ,
                                             if
                                             
                                             c
                                             e
                                             l
                                             >
                                             0
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        
                     

We define pel as the fraction of Tint
                         where the motion event takes place:
                           
                              (25)
                              
                                 p
                                 e
                                 l
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   c
                                                   e
                                                   l
                                                
                                             
                                             −
                                             1
                                          
                                       
                                       +
                                       α
                                    
                                    4
                                 
                                 ,
                              
                           
                        where we assume that the integration time of each phase image is T
                        
                           int
                        /4.

We show in Fig. 11
                         
                        pel computation for the running example used in Fig. 1.

During motion, neighboring pixels near occluding contours are affected by the motion event at different pel values. The spatial (i.e. image coordinates) distribution of pel values depends on magnitude and direction of motion. We denote as I
                        
                           pel
                         the image arrangement of pel values (see right part of Fig. 11). The image gradient of ∇I
                        
                           pel
                         gives the distribution of time differences between pixels. The magnitude of ∇I
                        
                           pel
                         is proportional to the inverse of motion flow:
                           
                              (26)
                              
                                 
                                    
                                       ∇
                                       
                                          I
                                          
                                             p
                                             e
                                             l
                                          
                                       
                                    
                                 
                                 ∝
                                 
                                    1
                                    v
                                 
                                 ,
                              
                           
                        where v is the speed magnitude. The direction of ∇I
                        
                           pel
                         gives the direction of speed in the image. Fig. 12
                         shows I
                        
                           pel
                         and its gradient for an object following horizontal motion in the image.

Eq. (26) is only valid when either we detect an event in the pixel (pel
                        ≠0) or the speed of the object produces events in neighboring pixels that are separated by less than the integration time.

Axial motion is corrected properly as movements along the viewing direction also generate phase image displacement in occluding contours. However, our motion field estimator doesn't provide information about this kind of movement.

@&#RESULTS@&#

Our proposal has been implemented into C++ using a commercial PC (Intel(R) Core(™)2 Quad CPU Q9550@2.83GHz). We must highlight that we don't require any GPU implementation to achieve real time processing. In fact, we believe that our algorithm can be easily implemented in camera's hardware as it only requires basic arithmetic operations and limited memory.

We use a low cost commercial ToF camera (PMDTec CamBoard Nano) for our experiments. This device only has 1 LED emitter located next to the image sensor (see Fig. 13
                     ), specially design for short range applications.

The CamBoard Nano has some specific limitations: i) non-visible areas when objects are close to the ToF camera due to the baseline between the sensor and the LED emitter (see green ellipses in Fig. 13), ii) low power emission/SNR (see red ellipses in Fig. 13).

Our method has been validated in real scenarios providing quantitative and qualitative results. In all experiments we use the following challenging scenario: i) maximum integration time (2000μs),
                        1
                     
                     
                        1
                        The frame-rate of the CamBoard considering the maximum integration time (2000μs) is 60fps, approximately.
                      
                     ii) high motion dynamics, iii) objects moving close to the camera and iv) low power emission (only one LED is emitting the signal). Depth images have been converted to a color-map to appreciate subtle depth changes.

In Fig. 14
                         we show the values of the inconsistency threshold after applying the on-line calibration proposed in Section 4.1 for several values of the integration time. Probabilistic distributions are shown to validate our assumption.

To measure accuracy of our method we use a scene of known geometry moving at a controlled speed. We use a planar target at a fixed distance of the camera that is rotating using a motor. We place the target perpendicularly to the line of sight of the camera and we manually label the region of interest in the image where the target appears when no motion is applied. We compute the mean and the standard deviation of depth measurements in the labeled area. Depth mean and standard deviation (μ(d
                        GT) and σ(d
                        GT), respectively) obtained by hand-labeling the scene are used as ground-truth measurements.

In Table 3
                         we show the region we have used to compute the ground truth (notice that no motion should be applied).

In Table 4
                         we show quantitative results for several angular velocities of the rotating target, including depth deviation, inliers/outliers deviation and processing time. The associated depth and motion field
                           2
                        
                        
                           2
                           We use HSV color-map to represent motion direction (best viewed in the lower right corner of motion field images).
                         images are presented in Figs. 15 and 16
                        
                        . We compare our results with one of the state of the art methods proposed in [11], where multiple frames are considered.

Depth deviation is computed with respect to the mean depth in the ground truth (d
                        GT) such that:
                           
                              (27)
                              
                                 σ
                                 
                                    
                                       d
                                       *
                                    
                                 
                                 =
                                 
                                    1
                                    
                                       N
                                       l
                                    
                                 
                                 
                                    
                                       ∑
                                       
                                          ∀
                                          i
                                          ∈
                                          
                                             A
                                             l
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                d
                                                i
                                                *
                                             
                                             −
                                             μ
                                             
                                                
                                                   d
                                                   
                                                      G
                                                      T
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where Nl
                         is the number of pixels inside the hand labeled area 
                           
                              A
                              l
                           
                        , di
                         is the measured depth at pixel i, d
                        ⁎ is the corrected depth after applying any of the correction algorithms and μ(d
                        GT) is the depth mean we use as ground truth.

The inlier percentage is computed with respect to the hand-labeled area 
                           
                              
                                 A
                                 l
                              
                           
                         for each scene as
                           
                              (28)
                              
                                 %
                                 Inliers
                                 =
                                 
                                    
                                       A
                                       *
                                    
                                    
                                       A
                                       l
                                    
                                 
                                 ∗
                                 100
                              
                           
                        where
                           
                              (29)
                              
                                 
                                    
                                       
                                          
                                             A
                                             *
                                          
                                          =
                                          
                                             
                                                ∑
                                                
                                                   ∀
                                                   i
                                                   ∈
                                                   
                                                      A
                                                      l
                                                   
                                                
                                             
                                             
                                                
                                                   Γ
                                                   i
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             Γ
                                             i
                                          
                                          =
                                          
                                             
                                                
                                                   
                                                      1
                                                      ,
                                                   
                                                   
                                                      if
                                                      
                                                         
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            −
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                      <
                                                      
                                                         d
                                                         i
                                                         *
                                                      
                                                      <
                                                      
                                                         
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            +
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      0
                                                      ,
                                                   
                                                   
                                                      others
                                                   
                                                
                                             
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     

The percentage of outliers is computed such that:
                           
                              (30)
                              
                                 %
                                 Outliers
                                 =
                                 
                                    
                                       
                                          A
                                          *
                                       
                                       ¯
                                    
                                    
                                       A
                                       l
                                    
                                 
                                 ∗
                                 100
                              
                           
                        where
                           
                              (31)
                              
                                 
                                    
                                       
                                          
                                             
                                                A
                                                ∗
                                             
                                             ¯
                                          
                                          =
                                          
                                             
                                                ∑
                                                
                                                   ∀
                                                   i
                                                   ∈
                                                   
                                                      d
                                                      ∗
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      Γ
                                                      i
                                                   
                                                   ¯
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                Γ
                                                i
                                             
                                             ¯
                                          
                                          =
                                          
                                             
                                                
                                                   
                                                      1
                                                      ,
                                                      
                                                      if
                                                      
                                                      i
                                                      ∈
                                                      
                                                         A
                                                         l
                                                      
                                                      
                                                      and
                                                   
                                                
                                                
                                                   
                                                      
                                                      
                                                         
                                                            
                                                               d
                                                               i
                                                               ∗
                                                            
                                                            >
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            +
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                      or
                                                      
                                                         d
                                                         i
                                                         ∗
                                                      
                                                      <
                                                      
                                                         
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            −
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      1
                                                      ,
                                                      
                                                      if
                                                      
                                                      i
                                                      ∉
                                                      
                                                         A
                                                         l
                                                      
                                                      
                                                      and
                                                   
                                                
                                                
                                                   
                                                      
                                                      
                                                         
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            −
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                      <
                                                      
                                                         d
                                                         i
                                                         ∗
                                                      
                                                      <
                                                      
                                                         
                                                            μ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                            +
                                                            σ
                                                            
                                                               
                                                                  d
                                                                  
                                                                     G
                                                                     T
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      0
                                                      ,
                                                      
                                                      others
                                                   
                                                
                                             
                                          
                                          .
                                       
                                    
                                 
                              
                           
                        
                     

Processing time is shown in the last column. (Table 4)

From left to right, we show in Figs. 15 and 16 the corresponding results for different angular velocities. From top to bottom, we show i) ToF measurements, ii) Schmidt et al. [11] standard depth correction, iii) our proposed depth correction with the hand labeled area and iv) our motion field estimation, respectively.


                        Figs. 15,16 and Table 4 show that our method clearly improves with respect to Schmidt et al. [11]. The correction we achieved is remarkable, recovering most of the object boundaries, even at high rotation speed. Motion flow estimation is stable in all cases. Processing time reveals that we achieve more than 55fps with a low-end computer.

In Figs. 17 and 18
                        
                         we show qualitative results for several scenes. Each column shows the results for a particular scene under the challenging conditions we defined at the beginning of the section. In rows 1 and 3 we show depth and amplitude measurements and the proposed correction in rows 2 and 4. We show in rows 5 and 6 the coarse
                           3
                        
                        
                           3
                           Coarse events color-map can be seen in Fig. 12.
                         and the precise event location images. Finally, we show in the last row the estimated motion flow. We use the color-map displayed in the lower right corner to codify motion magnitude and direction.

The first three columns of Fig. 17 show a stick moving very fast close to the camera in three different movements: vertical, horizontal and diagonal, respectively. The fourth column shows the behavior of the algorithm using very thin objects. Finally, in the fifth column we consider an object moving towards the camera and rotating at the same time, showing the results when different kinds of motion are applied to the same object.

In the first two columns of Fig. 18 we show high motion dynamics where phase images overlap each other. In the next two experiments we show the results when motion artifacts of multiple objects occlude each other. In the last column we show the results when the camera moves.

@&#CONCLUSION@&#

This paper presents a method to correct motion artifacts in ToF cameras using a single frame with very low processing time (13ms in a low-end computer without GPU). Motion artifacts in PMD ToF cameras appear when the received optical energy change significantly during the integration time (i.e. multiple depths are considered for a single pixel) and the accumulated charges within a certain “smart pixel” reveal inconsistencies within the 4 stage pipeline. The solution we propose to correct motion artifacts is based on exploiting redundancy of the PMD “4-phase” shift architecture in line with the pseudo 4 phase-shift algorithm. We exploit the fact that the 4 sequential stages must be coherent if the pixel captures the same depth during the integration time. We show that we can recover depth of a pixel affected by motion with minimum calibration and information found in neighbors.

Even though the assumption that phases are linear mixtures is not exact for real ToF cameras, we demonstrate in our experiments that this assumption provides good results in terms of correction and motion estimation. We consider that more precise models could improve the interpolation of the event location and thus the motion field estimation, providing an interesting research line in the future.

We show in the Results section that the method clearly corrects complex scenes captured with a low cost commercial ToF camera. The camera we use has some specific limitations due to its small fill factor. Using better cameras will only improve the results of our proposal. In all experiments we also show that our approach obtains better results when compared to multiple frame state of the art techniques, specially with high dynamics.

The proposal is implemented in C++ without the need of any hardware implementations to achieve real time processing (around 55fps). Nevertheless, the algorithm could be implemented easily in a GPU if needed.

@&#ACKNOWLEDGMENT@&#

This work has been supported by the Spanish Ministry of Economy and Competitiveness under project SPACES-UAH (TIN2013-47630-C2-1-R). The authors would like to thank Professor Adrien Bartoli, from the Advanced Laparoscopy and Computer Vision group.


                     
                        
                           
                        
                     
                  

Condition summary:
                        
                           
                              
                                 
                                    
                                       If
                                       |
                                       c
                                       e
                                       l
                                       |
                                       =
                                       1
                                       then
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      0
                                                   
                                                   +
                                                   
                                                      φ
                                                      π
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      1
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            a
                                                            1
                                                            ′
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      φ
                                                      
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   +
                                                   
                                                      φ
                                                      
                                                         3
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   
                                                   =
                                                   
                                                   0
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       If
                                       |
                                       c
                                       e
                                       l
                                       |
                                       =
                                       2
                                       
                                       then
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      0
                                                   
                                                   +
                                                   
                                                      φ
                                                      π
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      
                                                         i
                                                         n
                                                         t
                                                      
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            1
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      φ
                                                      
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   +
                                                   
                                                      φ
                                                      
                                                         3
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      1
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            1
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       If
                                       |
                                       c
                                       e
                                       l
                                       |
                                       =
                                       3
                                       
                                       then
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      0
                                                   
                                                   +
                                                   
                                                      φ
                                                      π
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      2
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            1
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         cos
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      φ
                                                      
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   +
                                                   
                                                      φ
                                                      
                                                         3
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      
                                                         i
                                                         n
                                                         t
                                                      
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            1
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       If
                                       |
                                       c
                                       e
                                       l
                                       |
                                       =
                                       4
                                       
                                       then
                                       
                                          
                                             
                                                
                                                   
                                                      φ
                                                      0
                                                   
                                                   +
                                                   
                                                      φ
                                                      π
                                                   
                                                   
                                                   =
                                                   
                                                   0
                                                
                                             
                                             
                                                
                                                   
                                                      φ
                                                      
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   +
                                                   
                                                      φ
                                                      
                                                         3
                                                         π
                                                         /
                                                         2
                                                      
                                                   
                                                   
                                                   =
                                                   
                                                   
                                                      K
                                                      2
                                                   
                                                   ⋅
                                                   
                                                      
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            2
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            2
                                                         
                                                         −
                                                         
                                                            
                                                               a
                                                               '
                                                            
                                                            1
                                                         
                                                         ⋅
                                                         sin
                                                         ⁡
                                                         
                                                            β
                                                            1
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       .
                                    
                                 
                              
                           
                        
                     
                  

Initially, if we observe Tables B.5 and B.6 it seems that in (*)
                        i{a,b},
                     i
                     ∈{1,2,3,4} cases we don't have enough information to detect the event direction. Nevertheless, as the amplitude decay is inversely proportional to the squared distance (
                        
                           a
                           '
                        
                        ∝
                        
                           1
                           
                              d
                              2
                           
                        
                      and thus, 
                        
                           a
                           '
                        
                        ∝
                        
                           1
                           
                              β
                              2
                           
                        
                     ), we can detect the event direction from the complementary trigonometric function. That is, if we analyze the case (*)1a
                      where there is an event in |cel|=4 with β
                     1
                     ∈
                     Q
                     1 and β
                     2
                     ∈
                     Q
                     2. In this situation, only cosine function seems to provide us relevant information about the sign. However, if we look at the equation below:
                        
                           (B.1)
                           
                              
                                 φ
                                 
                                    π
                                    /
                                    2
                                 
                              
                              +
                              
                                 φ
                                 
                                    3
                                    π
                                    /
                                    2
                                 
                              
                              =
                              
                                 K
                                 2
                              
                              ⋅
                              
                                 
                                    
                                       
                                          a
                                          '
                                       
                                       2
                                    
                                    ⋅
                                    sin
                                    ⁡
                                    
                                       β
                                       2
                                    
                                    −
                                    
                                       
                                          a
                                          '
                                       
                                       1
                                    
                                    ⋅
                                    sin
                                    ⁡
                                    
                                       β
                                       1
                                    
                                 
                              
                           
                        
                     if β
                     2
                     ∈
                     Q
                     2 and β
                     1
                     ∈
                     Q
                     1 (β
                     2
                     >
                     β
                     1) we can identify the event direction using the “sine” function relationship given by the sum φ
                     
                        π/2
                     +
                     φ
                     3π/2:
                        
                           (B.2)
                           
                              
                                 φ
                                 
                                    π
                                    /
                                    2
                                 
                              
                              +
                              
                                 φ
                                 
                                    3
                                    π
                                    /
                                    2
                                 
                              
                              <
                              0
                              .
                           
                        
                     
                  

The remaining (*)
                        i{a,b} cases have been solved in the same way.


                     
                  


                     
                  

@&#REFERENCES@&#

