@&#MAIN-TITLE@&#Automatic detection of calibration grids in time-of-flight images

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           Standard corner-detection methods are susceptible to sampling artifacts.


                        
                        
                           
                           A Hough-based method fits a global model to the chequerboard line pattern.


                        
                        
                           
                           This process less sensitive to low-resolution: each vertex is defined by the intersection of 2 lines.


                        
                        
                           
                           Double-mapping segments the gradient vectors; detection is split into 2 Hough transforms.


                        
                        
                           
                           The method is evaluated over 700 detections and performs better than OpenCV method.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Range imaging

Time-of-flight sensors

Camera calibration

Hough transform

@&#ABSTRACT@&#


               
               
                  It is convenient to calibrate time-of-flight cameras by established methods, using images of a chequerboard pattern. The low resolution of the amplitude image, however, makes it difficult to detect the board reliably. Heuristic detection methods, based on connected image-components, perform very poorly on this data. An alternative, geometrically-principled method is introduced here, based on the Hough transform. The projection of a chequerboard is represented by two pencils of lines, which are identified as oriented clusters in the gradient-data of the image. A projective Hough transform is applied to each of the two clusters, in axis-aligned coordinates. The range of each transform is properly bounded, because the corresponding gradient vectors are approximately parallel. Each of the two transforms contains a series of collinear peaks; one for every line in the given pencil. This pattern is easily detected, by sweeping a dual line through the transform. The proposed Hough-based method is compared to the standard OpenCV detection routine, by application to several hundred time-of-flight images. It is shown that the new method detects significantly more calibration boards, over a greater variety of poses, without any overall loss of accuracy. This conclusion is based on an analysis of both geometric and photometric error.
               
            

@&#INTRODUCTION@&#

Time-of-flight (TOF) cameras produce a depth image, each pixel of which encodes the distance to the corresponding point in the scene. These devices emit pulsed infrared illumination, and infer distances from the time taken for light to reflect back to the camera. The TOF sensor can therefore be modelled, geometrically, as a pinhole device. Furthermore, knowledge of the TOF camera-parameters can be used to map raw depth-readings (i.e. distances along lines of sight) into Euclidean scene-coordinates. The calibration thereby enables these devices to be used as stand-alone 3-d
                     sensors, or to be combined with ordinary colour cameras, for complete 3-d
                     modelling and rendering [1–7].

TOF cameras can, in principle, be calibrated with any existing camera calibration method. For example, if a known chequerboard pattern is detected in a sufficient variety of poses, then the internal and external camera parameters can be estimated by standard routines [8–10]. It is possible to find the chequerboard vertices, in ordinary images, by first detecting image-corners [11], and subsequently imposing global constraints on their arrangement [12–14]. This approach, however, is not reliable for low-resolution images (e.g. in the range 100–
                        
                           500
                           
                           
                              
                                 px
                              
                              
                                 2
                              
                           
                        
                     ) because the local image-structure is disrupted by sampling artefacts, as shown in Fig. 2. Furthermore, these artefacts become worse as the board is viewed in distant and slanted positions, which are essential for high quality calibration [15,16]. The central motivation of this work is to detect a greater number and variety of calibration board-poses, in TOF images, without increasing the geometric error of the vertices. The geometric error can be conveniently defined with respect to the known geometry of the board, as will be shown in Section 3.

TOF sensors provide low-resolution depth and amplitude images. This is because relatively large detector-elements are required in order to allow accumulation of electrons, which increases the signal-to-noise ratio and yields accurate depth-estimates [17] but, in turn, limits the spatial resolution of the devices. This explains the poor performance of heuristic detection-methods, when applied to TOF camera calibration. For example, the amplitude signal from a typical TOF camera [18,19] resembles an ordinary greyscale image, but is of very low spatial resolution (e.g. 
                        
                           176
                           ×
                           144
                        
                      for the SR4000 camera, or 
                        
                           160
                           ×
                           120
                        
                      for the PMD PhotonICs on-chip sensor), as well as being noisy. A 
                        
                           712
                           ×
                           496
                        
                      CMOS colour-depth sensor is currently being developed, but the resolution of the TOF image delivered by this sensor is only 
                        
                           356
                           ×
                           248
                        
                      pixels [20]. A 
                        
                           340
                           ×
                           96
                        
                      pixels TOF camera has also been developed, for driving applications [21].
                        1
                        Neither of these two cameras are commercially available at the time of writing.
                     
                     
                        1
                      Lindner et al. [16] used the calibration module included in the OpenCV library [14] to estimate the parameters of a 
                        
                           200
                           ×
                           200
                        
                      PMD depth-camera and noticed a high dependency between the intrinsic and extrinsic parameters. To overcome these issues, a calibration method that combines a TOF camera with colour cameras was proposed [2,16]. While this method yields very accurate parameters, it requires a multiple-sensor setup composed of both TOF and standard cameras.

Calibration grids are essentially composed of two pencils of lines, therefore chequerboard detection should explicitly take this structure into account. For instance, the method in [22,23] starts by extracting points of interest, followed by eliminating those points that do not have a local chequerboard pattern, and finally by grouping together points lying along lines. This method puts a lot of emphasis on interest points, which are difficult to detect in low-resolution images, and does not take full advantage of the global structure of the calibration grid.

Two families of mutually orthogonal lines may also be detected by finding a dominant pair of vanishing-points. In [24] it is proposed to represent image lines on the Gaussian sphere (a unit sphere around the optical centre of the camera). Under perspective projection, an image line projects onto a great circle on the Gaussian sphere, and a pencil of lines corresponds to a family great circles that intersect at antipodal points (see for example Fig. 1 in [25]). Therefore, a vanishing point may be found by detecting the intersections, provided that the camera’s internal parameters are known. Vanishing point detection was implemented using a quantized Gaussian sphere and a hierarchical (scale-space) Hough method, e.g. [26]. In general, Gaussian sphere-based methods require the detection of edges or of straight lines which are then projected as point sets (circles) on an azimuth-elevation grid, which may also produce spurious vanishing points [25].

More recently, vanishing-point detection was addressed as a clustering problem in the parameter space, using maximum likelihood and the EM algorithm [27], which requires suitable initialization. Alternatively, parameter-space clustering can be implemented using minimal sets [28] and random sampling. A method that combines [28] with an EM algorithm was recently proposed to find the three most orthogonal pencils of lines in indoor and outdoor scenes [29]. We tested this method using the software provided by the author
                        2
                        
                           http://www-etud.iro.umontreal.ca/tardifj/fichiers/VPdetection-05-09-2010.tar.gz.
                     
                     
                        2
                      but found that the algorithm was not able to reliably extract and label edges from the low-resolution TOF amplitude images. We conclude that vanishing point methods, e.g., [29,30] fail to extract pencils of lines because they require accurate edge detection that is difficult to accomplish in low resolution, noisy images.

The method described in this paper is also based on the Hough transform [31], but it effectively fits a specific model to the chequerboard pattern, e.g., Fig. 1
                     
                     . This process is much less sensitive to the resolution of the data, for two reasons. Firstly, information is integrated across the source image, because each vertex is obtained from the intersection of two fitted lines. Secondly, the structure of a straight edge is inherently simpler than that of a corner feature. However, for this approach to be viable, it is assumed that any lens distortion has been pre-calibrated, so that the images of the pattern contain straight lines. This is not a serious restriction, because it is relatively easy to find enough boards (by any heuristic method) from which to obtain adequate estimates of the internal and lens parameters. Indeed there exist lens-calibration methods that require only a single image [32–34]. The harder problems of reconstruction and relative orientation can then be addressed after adding the newly detected boards, ending with a bundle-adjustment that also refines the initial internal parameters. Furthermore, the TOF devices used here have fixed lenses, which are sealed inside the camera body. This means that the internal and lens-distortion parameters from previous calibrations can be re-used.

Another Hough-method for chequerboard detection has been presented by de la Escalera and Armingol [35]. Their algorithm involves a polar Hough transform of all high-gradient points in the image. This results in an array that contains a peak for each line in the pattern. It is not, however, straightforward to extract these peaks, because their location depends strongly on the unknown orientation of the image-lines. Hence all local maxima are detected by morphological operations, and a second Hough transform is applied to the resulting data in [35]. The true peaks will form two collinear sets in the first transform (cf. Section 2.4), and so the final task is to detect two peaks in the second Hough transform. This iteration makes it hard to determine an appropriate sampling scheme, and also increases the computation and storage time of the procedure [36].

The method described in this paper is quite different. It makes use of the gradient orientation as well as magnitude at each point, in order to establish an axis-aligned coordinate system for each image of the pattern. Separate Hough transforms are then performed in the x and y directions of the local coordinate system. By construction, the slope-coordinate of any line is close to zero in the corresponding Cartesian Hough transform. This means that, on average, the peaks occur along a fixed axis of each transform, and can be detected by a simple sweep-line procedure. Furthermore, the known 
                        
                           ℓ
                           ×
                           m
                        
                      structure of the grid makes it easy to identify the optimal sweep-line in each transform. Finally, the two optimal sweep-lines map directly back to pencils of 
                        
                           ℓ
                        
                      and m lines in the original image, owing to the Cartesian nature of the transform. The principle of the method is shown in Fig. 3
                     .

It should be noted that the method presented here was designed specifically for use with TOF cameras. For this reason, the range, as well as intensity data are used to help segment the image in Section 2.1. However, this step could easily be replaced with an appropriate background subtraction procedure [14], in which case the new method could be applied to ordinary rgb images. Camera calibration is typically performed under controlled illumination conditions, and so there would be no need for a dynamic background model.

The new method is described in Section 2; preprocessing and segmentation are explained in Sections 2.1 and 2.2 respectively, while Section 2.3 describes the geometric representation of the data. The necessary Hough transforms are defined in Section 2.4, and analyzed in Sections 2.5 and 2.6. The new method is evaluated on over 700 detections in Section 3, and shown to be substantially better, for TOF images, than the standard OpenCV method. Conclusions are stated in Section 4. Supplementary material can be found at: http://www.eecs.qmul.ac.uk/∼milesh/detect-suppl.pdf.

The main contributions of this paper are the use of a double-angle mapping to segment the gradient vectors (Section 2.2), the splitting of detection process into a pair of Cartesian Hough transforms (Section 2.4), and the sweep-line method of analyzing these transforms (Section 2.5 and 2.6).

Matrices and vectors will be written in bold, e.g. 
                           
                              M
                              ,
                              
                              v
                           
                        , and the Euclidean length of 
                           
                              v
                           
                         will be written 
                           
                              |
                              v
                              |
                           
                        . Equality up to an overall nonzero-scaling will be written 
                           
                              v
                              
                              ≃
                              
                              u
                           
                        . Image-points and lines will be represented in homogeneous coordinates [9], 
                           
                              p
                              
                              ≃
                              
                              
                                 
                                    (
                                    x
                                    ,
                                    y
                                    ,
                                    1
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                         and 
                           
                              λ
                              
                              ≃
                              
                              (
                              α
                              ,
                              β
                              ,
                              γ
                              )
                           
                        , such that 
                           
                              λ
                              p
                              =
                              0
                           
                         if 
                           
                              λ
                           
                         passes through 
                           
                              p
                           
                        . The intersection-point of two homogeneous lines can be obtained from the cross-product 
                           
                              
                                 
                                    (
                                    λ
                                    ×
                                    μ
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                        . An assignment from variable a to variable b will be written 
                           
                              b
                              ←
                              a
                           
                        . It will be convenient, for consistency with the pseudo-code listings, to use the notation 
                           
                              (
                              m
                              :
                              n
                              )
                           
                         for the sequence of integers from m to n inclusive. The ‘null’ symbol 
                           
                              ∅
                           
                         will be used to denote undefined or unused variables in the algorithms.

@&#METHOD@&#

It is convenient to begin with an overview of the complete algorithm, before describing the exact form of the input data. Following this, Sections 2.1–2.6 will describe each step in detail. The individual stages of the algorithm are as follows:
                        
                           
                              
                              
                                 
                                    
                                       
                                          
                                             A.
                                             
                                                Preprocessing: The background of the image is roughly identified, by depth-thresholding or image-differencing, and discarded. The gradient of the remaining image is then computed.
                                          
                                          
                                             B.
                                             
                                                Gradient Clustering: Two gradient clusters, one for each parallel set of edges on the board, are identified. All weak gradients are discarded.
                                          
                                          
                                             C.
                                             
                                                Local Coordinates: A pair of orthogonal axes, centred on the board, are constructed from the two gradient clusters.
                                          
                                          
                                             D.
                                             
                                                Hough Transform: Two Cartesian Hough transforms are performed, one for each gradient cluster. The local coordinate system ensures that all edge directions can be properly represented.
                                          
                                          
                                             E.
                                             
                                                Hough Analysis: A line is swept across both transforms, until a collinear set of peaks is found in each case. The two sets of peaks correspond to two pencils of image-lines, the intersections of which are the estimated vertices of the calibration grid.
                                          
                                          
                                             F.
                                             
                                                Decision Functions: The solution is accepted if two tests are passed: Firstly, the separation of adjacent lines in each pencil must not be too variable. Secondly, there must be black squares on both sides of the outermost lines of each pencil.
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                  

The form of the input data will now be detailed. Suppose that the chequerboard has 
                        
                           (
                           ℓ
                           +
                           1
                           )
                           ×
                           (
                           m
                           +
                           1
                           )
                        
                      squares, with 
                        
                           ℓ
                           <
                           m
                        
                     . It follows that the internal vertices of the pattern are imaged as the 
                        
                           ℓ
                           m
                        
                      line-intersections
                        
                           (1)
                           
                              
                                 
                                    v
                                 
                                 
                                    ij
                                 
                              
                              =
                              
                                 
                                    λ
                                 
                                 
                                    i
                                 
                              
                              ×
                              
                                 
                                    μ
                                 
                                 
                                    j
                                 
                              
                              
                              where
                              
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      λ
                                                   
                                                   
                                                      i
                                                   
                                                
                                                ∈
                                                L
                                             
                                             
                                                for
                                                
                                                i
                                                =
                                                1
                                                :
                                                ℓ
                                                ,
                                                
                                                and
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      μ
                                                   
                                                   
                                                      j
                                                   
                                                
                                                ∈
                                                M
                                             
                                             
                                                for
                                                
                                                j
                                                =
                                                1
                                                :
                                                m
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                  

The sets 
                        
                           L
                        
                      and 
                        
                           M
                        
                      are pencils, meaning that the 
                        
                           
                              
                                 λ
                              
                              
                                 i
                              
                           
                        
                      all intersect at a point 
                        
                           p
                        
                     , while the 
                        
                           
                              
                                 μ
                              
                              
                                 j
                              
                           
                        
                      all intersect at a point 
                        
                           q
                        
                     . Note that 
                        
                           p
                        
                      and 
                        
                           q
                        
                      are the vanishing points of the grid-lines, which may be at infinity in the images (cf. pencil 
                        
                           M
                        
                      in Fig. 3).

It is assumed that the imaging device, such as a TOF camera, provides a range map 
                        
                           
                              
                                 D
                              
                              
                                 xy
                              
                           
                        
                     , containing distances from the optical centre, as well as a luminance-like amplitude map 
                        
                           
                              
                                 A
                              
                              
                                 xy
                              
                           
                        
                     , where 
                        
                           (
                           x
                           ,
                           y
                           )
                        
                      represents a pixel. The images D and A are of size 
                        
                           X
                           ×
                           Y
                        
                     . All images must be undistorted, as described in the introduction.

The amplitude image A is roughly segmented, by discarding all pixels that correspond to very near or far points. This gives a new image B, which typically contains the board, plus the person holding it:
                           
                              (2)
                              
                                 
                                    
                                       B
                                    
                                    
                                       xy
                                    
                                 
                                 ←
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         A
                                                      
                                                      
                                                         xy
                                                      
                                                   
                                                
                                                
                                                   if
                                                   
                                                   
                                                      
                                                         d
                                                      
                                                      
                                                         0
                                                      
                                                   
                                                   <
                                                   
                                                      
                                                         D
                                                      
                                                      
                                                         xy
                                                      
                                                   
                                                   <
                                                   
                                                      
                                                         d
                                                      
                                                      
                                                         1
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   ∅
                                                
                                                
                                                   otherwise
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The near-limit 
                           
                              
                                 
                                    d
                                 
                                 
                                    0
                                 
                              
                           
                         is determined by the closest position for which the board remains fully inside the field-of-view of the camera. The far-limit 
                           
                              
                                 
                                    d
                                 
                                 
                                    1
                                 
                              
                           
                         is typically set to a value just closer than the far wall of the scene. These parameters need only be set approximately, provided that the interval 
                           
                              [
                              
                                 
                                    d
                                 
                                 
                                    1
                                 
                              
                              ,
                              
                                 
                                    d
                                 
                                 
                                    0
                                 
                              
                              ]
                           
                         covers the possible positions of the calibration board.

It is useful to perform a morphological erosion operation at this stage, in order to partially remove the perimeter of the board. In particular, if the physical edge of the board is not white, then it will give rise to irrelevant image-gradients. The erosion radius need only be set approximately (a value of 2px was used here), assuming that there is a reasonable amount of white-space around the chessboard pattern.

The gradient of the remaining amplitude image is now computed, using the simple kernel 
                           
                              Δ
                              =
                              (
                              -
                              1
                              /
                              2
                              ,
                              0
                              ,
                              1
                              /
                              2
                              )
                           
                        . The horizontal and vertical components are
                           
                              (3)
                              
                                 
                                    
                                       
                                          
                                             
                                                ξ
                                             
                                             
                                                xy
                                             
                                          
                                          ←
                                          
                                             
                                                (
                                                Δ
                                                
                                                ★
                                                
                                                B
                                                )
                                             
                                             
                                                xy
                                             
                                          
                                          =
                                          ρ
                                          cos
                                          θ
                                       
                                       
                                          and
                                       
                                       
                                          
                                             
                                                η
                                             
                                             
                                                xy
                                             
                                          
                                          ←
                                          
                                             
                                                (
                                                
                                                   
                                                      Δ
                                                   
                                                   
                                                      ⊤
                                                   
                                                
                                                ★
                                                B
                                                )
                                             
                                             
                                                xy
                                             
                                          
                                          =
                                          ρ
                                          sin
                                          θ
                                       
                                    
                                 
                              
                           
                        where 
                           
                              ★
                           
                         indicates convolution, and 
                           
                              (
                              ρ
                              ,
                              θ
                              )
                           
                         is the polar representation of the gradient. No pre-smoothing of the image is performed, owing to the low spatial resolution of the data.

The objective of this section is to assign each gradient vector 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                         to one of three classes, with labels 
                           
                              
                                 
                                    κ
                                 
                                 
                                    xy
                                 
                              
                              ∈
                              {
                              λ
                              ,
                              μ
                              ,
                              ∅
                           
                        }. If 
                           
                              
                                 
                                    κ
                                 
                                 
                                    xy
                                 
                              
                              =
                              λ
                           
                         then pixel 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                         is on one of the lines in 
                           
                              L
                           
                        , and 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                         is perpendicular to that line. If 
                           
                              
                                 
                                    κ
                                 
                                 
                                    xy
                                 
                              
                              =
                              μ
                           
                        , then the analogous relations hold with respect to 
                           
                              M
                           
                        . If 
                           
                              
                                 
                                    κ
                                 
                                 
                                    xy
                                 
                              
                              =
                              ∅
                           
                         then pixel 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                         does not lie on any of the lines.

The gradient distribution, after the initial segmentation, will contain two elongated clusters through the origin, which will be approximately orthogonal. Each cluster corresponds to a gradient orientation (mod 
                           
                              π
                           
                        ), while each end of a cluster corresponds to a gradient polarity (black/white vs.white/black). Two methods of identifying these clusters are described below; a principal component method, and a RANSAC method.

The principal component method begins with a double-angle mapping of the data [37], which will be expressed as 
                           
                              (
                              ξ
                              ,
                              η
                              )
                              
                              ↦
                              
                              (
                              σ
                              ,
                              τ
                              )
                           
                        . This mapping results in a single elongated cluster, each end of which corresponds to a gradient orientation (mod 
                           
                              π
                           
                        ). A real example of this mapping is shown in Fig. 4
                        .

The double-angle coordinates are obtained by applying the trigonometric identities 
                           
                              cos
                              (
                              2
                              θ
                              )
                              =
                              
                                 
                                    cos
                                 
                                 
                                    2
                                 
                              
                              θ
                              -
                              
                                 
                                    sin
                                 
                                 
                                    2
                                 
                              
                              θ
                           
                         and 
                           
                              sin
                              (
                              2
                              θ
                              )
                              =
                              2
                              sin
                              θ
                              cos
                              θ
                           
                         to the gradients (3), so that
                           
                              (4)
                              
                                 
                                    
                                       σ
                                    
                                    
                                       xy
                                    
                                 
                                 ←
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             ρ
                                          
                                          
                                             xy
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                ξ
                                             
                                             
                                                xy
                                             
                                             
                                                2
                                             
                                          
                                          -
                                          
                                             
                                                η
                                             
                                             
                                                xy
                                             
                                             
                                                2
                                             
                                          
                                       
                                    
                                 
                                 
                                 and
                                 
                                 
                                    
                                       τ
                                    
                                    
                                       xy
                                    
                                 
                                 ←
                                 
                                    
                                       2
                                    
                                    
                                       
                                          
                                             ρ
                                          
                                          
                                             xy
                                          
                                       
                                    
                                 
                                 
                                    
                                       ξ
                                    
                                    
                                       xy
                                    
                                 
                                 
                                    
                                       η
                                    
                                    
                                       xy
                                    
                                 
                              
                           
                        
                        
                           
                              
                                 where
                                 
                                 
                                    
                                       ρ
                                    
                                    
                                       xy
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             ξ
                                          
                                          
                                             xy
                                          
                                          
                                             2
                                          
                                       
                                       +
                                       
                                          
                                             η
                                          
                                          
                                             xy
                                          
                                          
                                             2
                                          
                                       
                                    
                                 
                              
                           
                        for all points at which the magnitude 
                           
                              
                                 
                                    ρ
                                 
                                 
                                    xy
                                 
                              
                           
                         is above machine precision. Let the first unit-eigenvector of the 
                           
                              (
                              σ
                              ,
                              τ
                              )
                           
                         covariance matrix be 
                           
                              (
                              cos
                              (
                              2
                              ϕ
                              )
                              ,
                              sin
                              (
                              2
                              ϕ
                              )
                              )
                           
                        , which is written in this way so that the angle 
                           
                              ϕ
                           
                         can be interpreted in the original image. The cluster-membership is now defined by the orthogonal projection
                           
                              (5)
                              
                                 
                                    
                                       π
                                    
                                    
                                       xy
                                    
                                 
                                 =
                                 (
                                 
                                    
                                       σ
                                    
                                    
                                       xy
                                    
                                 
                                 ,
                                 
                                    
                                       τ
                                    
                                    
                                       xy
                                    
                                 
                                 )
                                 ·
                                 (
                                 cos
                                 (
                                 2
                                 ϕ
                                 )
                                 ,
                                 sin
                                 (
                                 2
                                 ϕ
                                 )
                                 )
                              
                           
                        of the data onto this axis. It is now straightforward to classify the gradient-vectors 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                        , as shown in Fig. 4, according to a threshold 
                           
                              
                                 
                                    π
                                 
                                 
                                    min
                                 
                              
                           
                        ;
                           
                              (6)
                              
                                 
                                    
                                       κ
                                    
                                    
                                       xy
                                    
                                 
                                 ←
                                 
                                    
                                       
                                          
                                             
                                                
                                                   λ
                                                
                                                
                                                   if
                                                   
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                   
                                                   ⩾
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   μ
                                                
                                                
                                                   if
                                                   
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                   
                                                   ⩽
                                                   -
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   ∅
                                                
                                                
                                                   otherwise
                                                   .
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        Hence the symbol 
                           
                              ∅
                           
                         is assigned to all strong gradients that are not aligned with either axis of the board, as well as to all weak gradients.

The above method is robust to moderate perspective effects, because only the first principal component is needed, and this is well-defined for any elongated distribution. However, in order to include boards with extreme perspective distortion, an even more robust RANSAC method can be used, as described below.

The RANSAC method is based on the fact that two lines through the origin can be defined by two points; one on each line. These two points are randomly sampled in the 
                           
                              (
                              ξ
                              ,
                              η
                              )
                           
                         gradient space, and used to define two normal vectors 
                           
                              (
                              -
                              
                                 
                                    η
                                 
                                 
                                    λ
                                 
                              
                              ,
                              
                                 
                                    ξ
                                 
                                 
                                    λ
                                 
                              
                              )
                           
                         and 
                           
                              (
                              -
                              
                                 
                                    η
                                 
                                 
                                    μ
                                 
                              
                              ,
                              
                                 
                                    ξ
                                 
                                 
                                    μ
                                 
                              
                              )
                           
                        . The projections of the all 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                         gradient points, onto each unit vector, are defined as
                           
                              (7)
                              
                                 
                                    
                                       π
                                    
                                    
                                       xy
                                    
                                    
                                       λ
                                    
                                 
                                 =
                                 
                                    
                                       (
                                       -
                                       
                                          
                                             η
                                          
                                          
                                             λ
                                          
                                       
                                       ,
                                       
                                          
                                             ξ
                                          
                                          
                                             λ
                                          
                                       
                                       )
                                       ·
                                       (
                                       
                                          
                                             ξ
                                          
                                          
                                             xy
                                          
                                       
                                       ,
                                       
                                          
                                             η
                                          
                                          
                                             xy
                                          
                                       
                                       )
                                    
                                    
                                       
                                          
                                             
                                                
                                                   ξ
                                                
                                                
                                                   λ
                                                
                                                
                                                   2
                                                
                                             
                                             +
                                             
                                                
                                                   η
                                                
                                                
                                                   λ
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (8)
                              
                                 
                                    
                                       π
                                    
                                    
                                       xy
                                    
                                    
                                       μ
                                    
                                 
                                 =
                                 
                                    
                                       (
                                       -
                                       
                                          
                                             η
                                          
                                          
                                             μ
                                          
                                       
                                       ,
                                       
                                          
                                             ξ
                                          
                                          
                                             μ
                                          
                                       
                                       )
                                       ·
                                       (
                                       
                                          
                                             ξ
                                          
                                          
                                             xy
                                          
                                       
                                       ,
                                       
                                          
                                             η
                                          
                                          
                                             xy
                                          
                                       
                                       )
                                    
                                    
                                       
                                          
                                             
                                                
                                                   ξ
                                                
                                                
                                                   μ
                                                
                                                
                                                   2
                                                
                                             
                                             +
                                             
                                                
                                                   η
                                                
                                                
                                                   μ
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The gradients are now classified, in relation to a slab of thickness 
                           
                              2
                              ×
                              
                                 
                                    π
                                 
                                 
                                    min
                                 
                              
                           
                         around each line:
                           
                              (9)
                              
                                 
                                    
                                       κ
                                    
                                    
                                       xy
                                    
                                 
                                 ←
                                 
                                    
                                       
                                          
                                             
                                                
                                                   λ
                                                
                                                
                                                   if
                                                   
                                                   |
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                      
                                                         λ
                                                      
                                                   
                                                   |
                                                   ⩽
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                   
                                                   and
                                                   
                                                   |
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                      
                                                         μ
                                                      
                                                   
                                                   |
                                                   >
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   μ
                                                
                                                
                                                   if
                                                   
                                                   |
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                      
                                                         μ
                                                      
                                                   
                                                   |
                                                   ⩽
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                   
                                                   and
                                                   
                                                   |
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         xy
                                                      
                                                      
                                                         λ
                                                      
                                                   
                                                   |
                                                   >
                                                   
                                                      
                                                         π
                                                      
                                                      
                                                         min
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   ∅
                                                
                                                
                                                   otherwise
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

Points that are in both slabs (i.e. around the intersection) are given the null label, which means that more points are excluded as the two lines become more parallel. This has desirable effect of automatically excluding more weak gradients as the perspective distortion increases. The quality of the classification is defined as the number of non-null labels, and the best solution is chosen, as usual, from the ensemble of samples.

In general, the RANSAC method is more robust that the principal component method; it does, however, have two drawbacks. Firstly, it is necessary to set the number of random samples to be drawn, which introduces an additional parameter. Secondly, the final result of the calibration will not be exactly repeatable, unless the same random-number generator and seed are employed each time.

Suppose that the gradients have now been classified, using either the principal component method or the RANSAC method, as described above. The next task is to resolve the respective identities of the clusters, with respect to labels 
                           
                              λ
                           
                         and 
                           
                              μ
                           
                        . In principle, the class that contains the greater number of gradients should correspond to 
                           
                              L
                           
                        , which was defined as the pencil containing fewer lines. This is because, for a fronto-parallel board, the total lengths of the edges in 
                           
                              L
                           
                         and 
                           
                              M
                           
                         are proportional to 
                           
                              ℓ
                              (
                              m
                              -
                              1
                              )
                           
                         and 
                           
                              m
                              (
                              ℓ
                              -
                              1
                              )
                           
                         respectively, with 
                           
                              ℓ
                              <
                              m
                           
                        . This prediction is unreliable, in practice, owing to foreshortening and other image-effects. For this reason, the correspondence 
                           
                              {
                              λ
                              ,
                              μ
                              }
                              
                              ⇔
                              
                              {
                              L
                              ,
                              M
                              }
                           
                         between labels and pencils will be resolved more robustly, in Section 2.5.

A coordinate system will now be constructed for each image of the board. Recall from (2) that amplitude-image B typically contains the board, as well as the person holding it. The very low amplitudes 
                           
                              
                                 
                                    B
                                 
                                 
                                    xy
                                 
                              
                              ≈
                              0
                           
                         of the black squares tend to be characteristic of the board itself (i.e. 
                           
                              
                                 
                                    B
                                 
                                 
                                    xy
                                 
                              
                              ≫
                              0
                           
                         for both the white squares and for the rest of B). Hence a good estimate of the board-centre can be obtained by normalizing B to the range 
                           
                              [
                              0
                              ,
                              1
                              ]
                           
                         and then computing a centroid using weights 
                           
                              (
                              1
                              -
                              
                                 
                                    B
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                        . The centroid, together with the angle 
                           
                              ϕ
                           
                         from (5) defines the Euclidean transformation 
                           
                              E
                           
                         into local coordinates, centred on and aligned with the board. From now on, unless otherwise stated, it will be assumed that this simple transformation has been performed.

Let 
                           
                              
                                 
                                    (
                                    
                                       
                                          x
                                       
                                       
                                          κ
                                       
                                    
                                    ,
                                    
                                       
                                          y
                                       
                                       
                                          κ
                                       
                                    
                                    ,
                                    1
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                         be the local coordinates of given point, after transformation by 
                           
                              E
                           
                        , with the label 
                           
                              κ
                           
                         inherited from 
                           
                              
                                 
                                    κ
                                 
                                 
                                    xy
                                 
                              
                           
                        . Now, by construction, any labelled point is hypothesized to be part of 
                           
                              L
                           
                         or 
                           
                              M
                           
                        , such that 
                           
                              λ
                              
                                 
                                    (
                                    
                                       
                                          x
                                       
                                       
                                          λ
                                       
                                    
                                    ,
                                    
                                       
                                          y
                                       
                                       
                                          λ
                                       
                                    
                                    ,
                                    1
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                              =
                              0
                           
                         or 
                           
                              μ
                              
                                 
                                    (
                                    
                                       
                                          x
                                       
                                       
                                          μ
                                       
                                    
                                    ,
                                    
                                       
                                          y
                                       
                                       
                                          μ
                                       
                                    
                                    ,
                                    1
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                              =
                              0
                           
                        , where 
                           
                              λ
                           
                         and 
                           
                              μ
                           
                         are the local coordinates of the relevant lines. These lines can be expressed as
                           
                              (10)
                              
                                 λ
                                 
                                 ≃
                                 
                                 (
                                 -
                                 1
                                 ,
                                 
                                    
                                       β
                                    
                                    
                                       λ
                                    
                                 
                                 ,
                                 
                                    
                                       α
                                    
                                    
                                       λ
                                    
                                 
                                 )
                                 
                                 and
                                 
                                 μ
                                 
                                 ≃
                                 
                                 (
                                 
                                    
                                       β
                                    
                                    
                                       μ
                                    
                                 
                                 ,
                                 -
                                 1
                                 ,
                                 
                                    
                                       α
                                    
                                    
                                       μ
                                    
                                 
                                 )
                              
                           
                        with inhomogeneous forms 
                           
                              
                                 
                                    x
                                 
                                 
                                    λ
                                 
                              
                              =
                              
                                 
                                    α
                                 
                                 
                                    λ
                                 
                              
                              +
                              
                                 
                                    β
                                 
                                 
                                    λ
                                 
                              
                              
                                 
                                    y
                                 
                                 
                                    λ
                                 
                              
                           
                         and 
                           
                              
                                 
                                    y
                                 
                                 
                                    μ
                                 
                              
                              =
                              
                                 
                                    α
                                 
                                 
                                    μ
                                 
                              
                              +
                              
                                 
                                    β
                                 
                                 
                                    μ
                                 
                              
                              
                                 
                                    x
                                 
                                 
                                    μ
                                 
                              
                           
                        , such that the slopes 
                           
                              |
                              
                                 
                                    β
                                 
                                 
                                    κ
                                 
                              
                              |
                              ≪
                              1
                           
                         are bounded. In other words, the board is axis-aligned in local coordinates, and the perspective-induced deviation of any line is less than 
                           
                              
                                 
                                    45
                                 
                                 
                                    °
                                 
                              
                           
                        . Furthermore, if the board is visible, then the intercepts 
                           
                              |
                              
                                 
                                    α
                                 
                                 
                                    κ
                                 
                              
                              |
                              ≪
                              
                                 
                                    1
                                 
                                 
                                    2
                                 
                              
                              (
                              X
                              +
                              Y
                              )
                           
                         are bounded in relation to the image size.

Recall from (1) that the vertices 
                           
                              
                                 
                                    v
                                 
                                 
                                    ij
                                 
                              
                           
                         of the board are computed as the intersections of 
                           
                              L
                           
                         with 
                           
                              M
                           
                        . The resulting points can be expressed in the original image coordinates as 
                           
                              
                                 
                                    v
                                 
                                 
                                    ij
                                 
                              
                              
                              ≃
                              
                              
                                 
                                    E
                                 
                                 
                                    -
                                    1
                                 
                              
                              
                                 
                                    
                                       
                                          
                                             
                                                λ
                                             
                                             
                                                i
                                             
                                          
                                          ×
                                          
                                             
                                                μ
                                             
                                             
                                                j
                                             
                                          
                                       
                                    
                                 
                                 
                                    ⊤
                                 
                              
                           
                        , via the inverse transformation.

The Hough transform, as used here, maps points from the image to lines in the transform. In particular, points along a line are mapped to lines through a point. This duality between collinearity and concurrency suggests that a pencil of n image-lines will be mapped to a line of n transform points, as in Fig. 3.

The transform is implemented as a 2-d
                        histogram 
                           
                              H
                              (
                              u
                              ,
                              v
                              )
                           
                        , with horizontal and vertical coordinates 
                           
                              u
                              ∈
                              [
                              0
                              ,
                              
                                 
                                    u
                                 
                                 
                                    1
                                 
                              
                              ]
                           
                         and 
                           
                              v
                              ∈
                              [
                              0
                              ,
                              
                                 
                                    v
                                 
                                 
                                    1
                                 
                              
                              ]
                           
                        . The point 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    0
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    0
                                 
                              
                              )
                              =
                              
                                 
                                    1
                                 
                                 
                                    2
                                 
                              
                              (
                              
                                 
                                    u
                                 
                                 
                                    1
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    1
                                 
                              
                              )
                           
                         is the centre of the transform array. Two transforms, 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                         and 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        , will be performed, for points labelled 
                           
                              λ
                           
                         and 
                           
                              μ
                           
                        , respectively. The Hough variables are related to the image coordinates in the following way; let
                           
                              
                                 u
                                 (
                                 x
                                 ,
                                 y
                                 ,
                                 v
                                 )
                                 =
                                 
                                    
                                       u
                                    
                                    
                                       0
                                    
                                 
                                 +
                                 x
                                 -
                                 y
                                 (
                                 v
                                 -
                                 
                                    
                                       v
                                    
                                    
                                       0
                                    
                                 
                                 )
                                 ,
                                 
                                 and
                              
                           
                        
                        
                           
                              (11)
                              
                                 
                                    
                                       u
                                    
                                    
                                       κ
                                    
                                 
                                 (
                                 x
                                 ,
                                 y
                                 ,
                                 v
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   u
                                                   (
                                                   x
                                                   ,
                                                   y
                                                   ,
                                                   v
                                                   )
                                                
                                                
                                                   if
                                                   
                                                   κ
                                                   =
                                                   λ
                                                
                                             
                                             
                                                
                                                   u
                                                   (
                                                   y
                                                   ,
                                                   x
                                                   ,
                                                   v
                                                   )
                                                
                                                
                                                   if
                                                   
                                                   κ
                                                   =
                                                   μ
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

Here 
                           
                              u
                              (
                              x
                              ,
                              y
                              ,
                              v
                              )
                           
                         is the u-coordinate of a line (parameterized by v), which is the Hough-transform of an image-point 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                        . The Hough intersection point 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              )
                           
                         is found by taking two points 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                         and 
                           
                              (
                              
                                 
                                    x
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    y
                                 
                                 
                                    ′
                                 
                              
                              )
                           
                        , and solving 
                           
                              
                                 
                                    u
                                 
                                 
                                    λ
                                 
                              
                              (
                              x
                              ,
                              y
                              ,
                              v
                              )
                              =
                              
                                 
                                    u
                                 
                                 
                                    λ
                                 
                              
                              (
                              
                                 
                                    x
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    y
                                 
                                 
                                    ′
                                 
                              
                              ,
                              v
                              )
                           
                        , with 
                           
                              
                                 
                                    x
                                 
                                 
                                    λ
                                 
                              
                           
                         and 
                           
                              
                                 
                                    x
                                 
                                 
                                    λ
                                 
                                 
                                    ′
                                 
                              
                           
                         substituted according to (10). The same coordinates are obtained by solving 
                           
                              
                                 
                                    u
                                 
                                 
                                    μ
                                 
                              
                              (
                              x
                              ,
                              y
                              ,
                              v
                              )
                              =
                              
                                 
                                    u
                                 
                                 
                                    μ
                                 
                              
                              (
                              
                                 
                                    x
                                 
                                 
                                    ′
                                 
                              
                              ,
                              
                                 
                                    y
                                 
                                 
                                    ′
                                 
                              
                              ,
                              v
                              )
                           
                        , and so the result can be expressed as
                           
                              (12)
                              
                                 
                                    
                                       u
                                    
                                    
                                       κ
                                    
                                    
                                       ★
                                    
                                 
                                 =
                                 
                                    
                                       u
                                    
                                    
                                       0
                                    
                                 
                                 +
                                 
                                    
                                       α
                                    
                                    
                                       κ
                                    
                                 
                                 
                                 and
                                 
                                 
                                    
                                       v
                                    
                                    
                                       κ
                                    
                                    
                                       ★
                                    
                                 
                                 =
                                 
                                    
                                       v
                                    
                                    
                                       0
                                    
                                 
                                 +
                                 
                                    
                                       β
                                    
                                    
                                       κ
                                    
                                 
                              
                           
                        with labels 
                           
                              κ
                              ∈
                              {
                              λ
                              ,
                              μ
                              }
                           
                         as usual. A peak at 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              )
                           
                         evidently maps to a line of intercept 
                           
                              
                                 
                                    u
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              -
                              
                                 
                                    u
                                 
                                 
                                    0
                                 
                              
                           
                         and slope 
                           
                              
                                 
                                    v
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              -
                              
                                 
                                    v
                                 
                                 
                                    0
                                 
                              
                           
                        . Note that if the perspective distortion in the images is small, then 
                           
                              
                                 
                                    β
                                 
                                 
                                    κ
                                 
                              
                              ≈
                              0
                           
                        , and all intersection points lie along the horizontal midline 
                           
                              (
                              u
                              ,
                              
                                 
                                    v
                                 
                                 
                                    0
                                 
                              
                              )
                           
                         of the corresponding transform. The Hough intersection point 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    κ
                                 
                                 
                                    ★
                                 
                              
                              )
                           
                         can be used to construct an image-line 
                           
                              λ
                           
                         or 
                           
                              μ
                           
                        , by combining (12) with (10), resulting in
                           
                              (13)
                              
                                 
                                    
                                       
                                       
                                          
                                             λ
                                             ←
                                             
                                                
                                                   
                                                      -
                                                      1
                                                      ,
                                                      
                                                      
                                                         
                                                            v
                                                         
                                                         
                                                            λ
                                                         
                                                         
                                                            ★
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            v
                                                         
                                                         
                                                            0
                                                         
                                                      
                                                      ,
                                                      
                                                      
                                                         
                                                            u
                                                         
                                                         
                                                            λ
                                                         
                                                         
                                                            ★
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            u
                                                         
                                                         
                                                            0
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                          
                                             μ
                                             ←
                                             
                                                
                                                   
                                                      
                                                         
                                                            v
                                                         
                                                         
                                                            μ
                                                         
                                                         
                                                            ★
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            v
                                                         
                                                         
                                                            0
                                                         
                                                      
                                                      ,
                                                      
                                                      -
                                                      1
                                                      ,
                                                      
                                                      
                                                         
                                                            u
                                                         
                                                         
                                                            μ
                                                         
                                                         
                                                            ★
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            u
                                                         
                                                         
                                                            0
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

The two Hough transforms are computed by the procedure in Fig. 5
                        . Let 
                           
                              
                                 
                                    H
                                 
                                 
                                    κ
                                 
                              
                           
                         refer to 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                         or 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        , according to the label 
                           
                              κ
                           
                         of the point 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                        . For each accepted point, the corresponding line (11) intersects the top and bottom of the 
                           
                              (
                              u
                              ,
                              v
                              )
                           
                         array at points 
                           
                              (
                              s
                              ,
                              0
                              )
                           
                         and 
                           
                              (
                              t
                              ,
                              
                                 
                                    v
                                 
                                 
                                    1
                                 
                              
                              )
                           
                         respectively. The resulting segment, of length 
                           
                              
                                 
                                    w
                                 
                                 
                                    1
                                 
                              
                           
                        , is evenly sampled, and 
                           
                              
                                 
                                    H
                                 
                                 
                                    κ
                                 
                              
                           
                         is incremented at each of the constituent points.

The procedure in Fig. 5 makes use of the following functions. Firstly, 
                           
                              
                                 
                                    interp
                                 
                                 
                                    α
                                 
                              
                              (
                              p
                              ,
                              q
                              )
                           
                        , with 
                           
                              α
                              ∈
                              [
                              0
                              ,
                              1
                              ]
                           
                        , returns the convex combination 
                           
                              (
                              1
                              -
                              α
                              )
                              p
                              +
                              α
                              q
                           
                        . Secondly, the ‘accumulation’ 
                           
                              H
                              ⊕
                              (
                              u
                              ,
                              v
                              )
                           
                         is equal to 
                           
                              H
                              (
                              u
                              ,
                              v
                              )
                              ←
                              H
                              (
                              u
                              ,
                              v
                              )
                              +
                              1
                           
                         if u and v are integers. In the general case, however, the four pixels closest to 
                           
                              (
                              u
                              ,
                              v
                              )
                           
                         are updated by the corresponding bilinear-interpolation weights (which sum to one). This weighting-scheme, combined with the large number of gradient-vectors that are processed, tends to produce a relatively smooth histogram.

The local coordinates defined in Section 2.3 ensure that the two Hough transforms 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                         and 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                         have the same characteristic structure. Hence the subscripts 
                           
                              λ
                           
                         and 
                           
                              μ
                           
                         will be suppressed for the moment. Recall that each Hough cluster corresponds to a line in the image space, and that a collinear set of Hough clusters corresponds to a pencil of lines in the image space, as in Fig. 3. It follows that all lines in a pencil can be detected simultaneously, by sweeping the Hough space H with a line that cuts a 1-d
                        slice through the histogram.

Recall from Section 2.4 that the Hough peaks are most likely to lie along a horizontal axis (corresponding to a fronto-parallel pose of the board). Hence a suitable parameterization of the sweep-line is to vary one endpoint 
                           
                              (
                              0
                              ,
                              s
                              )
                           
                         along the left edge, while varying the other endpoint 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    1
                                 
                              
                              ,
                              t
                              )
                           
                         along the right edge, as in Fig. 6
                        . This scheme has the desirable property of sampling more densely around the midline 
                           
                              (
                              u
                              ,
                              
                                 
                                    v
                                 
                                 
                                    0
                                 
                              
                              )
                           
                        . It is also useful to note that the sweep-line parameters s and t can be used to represent the apex of the corresponding pencil. The local coordinates 
                           
                              p
                           
                         and 
                           
                              q
                           
                         are 
                           
                              p
                              
                              ≃
                              
                              
                                 
                                    (
                                    
                                       
                                          λ
                                       
                                       
                                          s
                                       
                                    
                                    ×
                                    
                                       
                                          λ
                                       
                                       
                                          t
                                       
                                    
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                         and 
                           
                              q
                              
                              ≃
                              
                              
                                 
                                    (
                                    
                                       
                                          μ
                                       
                                       
                                          s
                                       
                                    
                                    ×
                                    
                                       
                                          μ
                                       
                                       
                                          t
                                       
                                    
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                         where 
                           
                              
                                 
                                    λ
                                 
                                 
                                    s
                                 
                              
                           
                         and 
                           
                              
                                 
                                    λ
                                 
                                 
                                    t
                                 
                              
                           
                         are obtained from (10) by setting 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    λ
                                 
                                 
                                    ★
                                 
                              
                              ,
                              
                                 
                                    v
                                 
                                 
                                    λ
                                 
                                 
                                    ★
                                 
                              
                              )
                           
                         to 
                           
                              (
                              0
                              ,
                              s
                              )
                           
                         and 
                           
                              (
                              
                                 
                                    u
                                 
                                 
                                    1
                                 
                              
                              ,
                              t
                              )
                           
                         respectively, and similarly for 
                           
                              
                                 
                                    μ
                                 
                                 
                                    s
                                 
                              
                           
                         and 
                           
                              
                                 
                                    μ
                                 
                                 
                                    t
                                 
                              
                           
                        .

The procedure shown in Fig. 6 is used to analyze the Hough transform. The sweep-line with parameters s and t has the form of a 1-d
                        histogram 
                           
                              
                                 
                                    h
                                 
                                 
                                    κ
                                 
                                 
                                    st
                                 
                              
                              (
                              w
                              )
                           
                        . The integer index 
                           
                              w
                              ∈
                              (
                              0
                              :
                              
                                 
                                    w
                                 
                                 
                                    1
                                 
                              
                              )
                           
                         is equal to the Euclidean distance 
                           
                              |
                              (
                              u
                              ,
                              v
                              )
                              -
                              (
                              0
                              ,
                              s
                              )
                              |
                           
                         along the sweep-line. The procedure shown in Fig. 6 makes further use of the interpolation operator that was defined in Section 2.4. Each sweep-line 
                           
                              
                                 
                                    h
                                 
                                 
                                    κ
                                 
                                 
                                    st
                                 
                              
                              (
                              w
                              )
                           
                        , constructed by the above process, will contain a number of isolated clusters: 
                           
                              
                                 
                                    
                                       clusters
                                       (
                                       
                                          
                                             h
                                          
                                          
                                             κ
                                          
                                          
                                             st
                                          
                                       
                                       )
                                    
                                 
                              
                              ⩾
                              1
                           
                        . These clusters are simply defined as runs of non-zero values in 
                           
                              
                                 
                                    h
                                 
                                 
                                    κ
                                 
                                 
                                    st
                                 
                              
                              (
                              w
                              )
                           
                        . The existence of separating zeros is, in practice, highly reliable when the sweep-line is close to the true solution. This is simply because the Hough data was thresholded in (6), and strong gradients are not found inside the chessboard squares. The representation of the clusters, and subsequent evaluation of each sweep-line, will now be described.

The label 
                           
                              κ
                           
                         and endpoint parameters s and t will be suppressed, in the following analysis of a single sweep-line, for clarity. Hence let 
                           
                              w
                              ∈
                              (
                              
                                 
                                    a
                                 
                                 
                                    c
                                 
                              
                              :
                              
                                 
                                    b
                                 
                                 
                                    c
                                 
                              
                              )
                           
                         be the interval that contains the cth cluster in 
                           
                              h
                              (
                              w
                              )
                           
                        . The score and location of this cluster are defined as the mean value and centroid, respectively:
                           
                              (14)
                              
                                 score
                                 
                                    
                                       (
                                       h
                                       )
                                    
                                    
                                       c
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             w
                                             =
                                             
                                                
                                                   a
                                                
                                                
                                                   c
                                                
                                             
                                          
                                          
                                             
                                                
                                                   b
                                                
                                                
                                                   c
                                                
                                             
                                          
                                       
                                       h
                                       (
                                       w
                                       )
                                    
                                    
                                       1
                                       +
                                       
                                          
                                             b
                                          
                                          
                                             c
                                          
                                       
                                       -
                                       
                                          
                                             a
                                          
                                          
                                             c
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              (15)
                              
                                 
                                    
                                       w
                                    
                                    
                                       c
                                    
                                 
                                 =
                                 
                                    
                                       a
                                    
                                    
                                       c
                                    
                                 
                                 +
                                 
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             w
                                             =
                                             
                                                
                                                   a
                                                
                                                
                                                   c
                                                
                                             
                                          
                                          
                                             
                                                
                                                   b
                                                
                                                
                                                   c
                                                
                                             
                                          
                                       
                                       h
                                       (
                                       w
                                       )
                                       w
                                    
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             w
                                             =
                                             
                                                
                                                   a
                                                
                                                
                                                   c
                                                
                                             
                                          
                                          
                                             
                                                
                                                   b
                                                
                                                
                                                   c
                                                
                                             
                                          
                                       
                                       h
                                       (
                                       w
                                       )
                                    
                                 
                              
                           
                        
                     

More sophisticated definitions are possible, based on quadratic interpolation around each peak. However, the mean and centroid give similar results in practice. A total score must now be assigned to the sweep-line, based on the scores of the constituent clusters. If n peaks are sought, then the total score is the sum of the highest n cluster-scores. But if there are fewer than n clusters in 
                           
                              h
                              (
                              w
                              )
                           
                        , then this cannot be a solution, and the score is zero:
                           
                              (16)
                              
                                 
                                    
                                       Σ
                                    
                                    
                                       n
                                    
                                 
                                 (
                                 h
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         ∑
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      
                                                         n
                                                      
                                                   
                                                   
                                                      
                                                         
                                                            score(h)
                                                         
                                                         
                                                            c
                                                            (
                                                            i
                                                            )
                                                         
                                                      
                                                   
                                                
                                                
                                                   if
                                                   
                                                   n
                                                   ⩽
                                                   |
                                                   
                                                   clusters
                                                   (
                                                   h
                                                   )
                                                   |
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   otherwise
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where 
                           
                              c
                              (
                              i
                              )
                           
                         is the index of the ith highest-scoring cluster. The optimal clusters are those in the sweep-line that maximizes (16). Now, restoring the full notation, the score of the optimal sweep-line in the transform 
                           
                              
                                 
                                    H
                                 
                                 
                                    κ
                                 
                              
                           
                         is
                           
                              (17)
                              
                                 
                                    
                                       Σ
                                    
                                    
                                       κ
                                    
                                    
                                       n
                                    
                                 
                                 ←
                                 
                                    
                                       
                                          max
                                       
                                       
                                          s
                                          ,
                                          t
                                       
                                    
                                 
                                 
                                 
                                    
                                       
                                          score
                                       
                                       
                                          n
                                       
                                    
                                 
                                 (
                                 
                                    
                                       h
                                    
                                    
                                       κ
                                    
                                    
                                       st
                                    
                                 
                                 )
                              
                           
                        
                     

One problem remains: it is not known in advance whether there should be 
                           
                              ℓ
                           
                         peaks in 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                         and m in 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        , or vice versa. Hence all four combinations, 
                           
                              
                                 
                                    Σ
                                 
                                 
                                    λ
                                 
                                 
                                    ℓ
                                 
                              
                              ,
                              
                              
                                 
                                    Σ
                                 
                                 
                                    μ
                                 
                                 
                                    m
                                 
                              
                              ,
                              
                              
                                 
                                    Σ
                                 
                                 
                                    μ
                                 
                                 
                                    ℓ
                                 
                              
                              ,
                              
                              
                                 
                                    Σ
                                 
                                 
                                    λ
                                 
                                 
                                    m
                                 
                              
                           
                         are computed. The ambiguity between pencils 
                           
                              (
                              L
                              ,
                              M
                              )
                           
                         and labels 
                           
                              (
                              λ
                              ,
                              μ
                              )
                           
                         can then be resolved, by picking the solution with the highest total score:
                           
                              (18)
                              
                                 
                                    
                                       
                                          L
                                          ,
                                          M
                                       
                                    
                                 
                                 
                                 ⇔
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   (
                                                   λ
                                                   ,
                                                   μ
                                                   )
                                                
                                                
                                                   if
                                                   
                                                   
                                                      
                                                         Σ
                                                      
                                                      
                                                         λ
                                                      
                                                      
                                                         ℓ
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         Σ
                                                      
                                                      
                                                         μ
                                                      
                                                      
                                                         m
                                                      
                                                   
                                                   >
                                                   
                                                      
                                                         Σ
                                                      
                                                      
                                                         μ
                                                      
                                                      
                                                         ℓ
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         Σ
                                                      
                                                      
                                                         λ
                                                      
                                                      
                                                         m
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   (
                                                   μ
                                                   ,
                                                   λ
                                                   )
                                                
                                                
                                                   otherwise
                                                   .
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     

Here, for example, 
                           
                              
                                 
                                    
                                       L
                                       ,
                                       M
                                    
                                 
                              
                              
                              ⇔
                              
                              (
                              λ
                              ,
                              μ
                              )
                           
                         means that there is a pencil of 
                           
                              ℓ
                           
                         lines in 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                         and a pencil of m lines in 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        . The procedure in (18) is based on the fact that the complete solution must consist of 
                           
                              ℓ
                              +
                              m
                           
                         clusters. Suppose, for example, that there are 
                           
                              ℓ
                           
                         good clusters in 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                        , and m good clusters in 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        . Of course there are also 
                           
                              ℓ
                           
                         good clusters in 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        , because 
                           
                              ℓ
                              <
                              m
                           
                         by definition. However, if only 
                           
                              ℓ
                           
                         clusters are taken from 
                           
                              
                                 
                                    H
                                 
                                 
                                    μ
                                 
                              
                           
                        , then an additional 
                           
                              m
                              -
                              ℓ
                           
                         weak or non-existent clusters must be found in 
                           
                              
                                 
                                    H
                                 
                                 
                                    λ
                                 
                              
                           
                        , and so the total score 
                           
                              
                                 
                                    Σ
                                 
                                 
                                    μ
                                 
                                 
                                    ℓ
                                 
                              
                              +
                              
                                 
                                    Σ
                                 
                                 
                                    λ
                                 
                                 
                                    m
                                 
                              
                           
                         would not be maximal.

It is straightforward, for each centroid 
                           
                              
                                 
                                    w
                                 
                                 
                                    c
                                 
                              
                           
                         in the optimal sweep-line 
                           
                              
                                 
                                    h
                                 
                                 
                                    κ
                                 
                                 
                                    st
                                 
                              
                           
                        , to compute the 2-d
                        Hough coordinates
                           
                              (19)
                              
                                 (
                                 
                                    
                                       u
                                    
                                    
                                       κ
                                    
                                    
                                       ★
                                    
                                 
                                 ,
                                 
                                    
                                       v
                                    
                                    
                                       κ
                                    
                                    
                                       ★
                                    
                                 
                                 )
                                 ←
                                 
                                    
                                       interp
                                    
                                    
                                       
                                          
                                             w
                                          
                                          
                                             c
                                          
                                       
                                       /
                                       
                                          
                                             w
                                          
                                          
                                             1
                                          
                                       
                                    
                                 
                                 (
                                 (
                                 0
                                 ,
                                 s
                                 )
                                 ,
                                 (
                                 
                                    
                                       u
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 t
                                 )
                                 )
                              
                           
                        where 
                           
                              
                                 
                                    w
                                 
                                 
                                    1
                                 
                              
                           
                         is the length of the sweep-line, as in Fig. 6. Each of the resulting 
                           
                              ℓ
                              m
                           
                         points are mapped to image-lines, according to (13). The vertices 
                           
                              
                                 
                                    v
                                 
                                 
                                    ij
                                 
                              
                           
                         are then computed from (1). The order of intersections along each line is preserved by the Hough transform, and so the ij indexing is automatically consistent.

Finally, in order to minimize any effects of discretization, it would be possible to perform quadratic (or other) interpolation around the maximal sweep-line score, with respect to the end-point parameters. In practice, owing to the high resolution of the sweep-procedure around zero-slope (as described above), this does not prove to be necessary.

The analysis of Section 2.5 returns estimated pencils 
                           
                              (
                              L
                              ,
                              M
                              )
                           
                        , even if the board is not visible in the image. Hence it is necessary to evaluate the quality of the solution. One possibility would be to test a statistic based on the scores in (18). However, a more robust approach is to test whether the solution 
                           
                              (
                              L
                              ,
                              M
                              )
                           
                         satisfies certain geometric constraints that were not used in the estimation process.

There are, in practice, two types of mis-detections. In the first case a minority of the lines are not aligned with the chessboard pattern, and so the solution is corrupted. In the second case the lines include an external edge of the chessboard pattern, and so the entire solution is displaced. These two types of error, which may co-occur, are addressed below.

Recall that vertex 
                           
                              
                                 
                                    v
                                 
                                 
                                    ij
                                 
                              
                           
                         is the intersection between lines 
                           
                              
                                 
                                    λ
                                 
                                 
                                    i
                                 
                              
                           
                         and 
                           
                              
                                 
                                    μ
                                 
                                 
                                    j
                                 
                              
                           
                        , as in (1). Corrupted estimates can be detected by noting that cross ratios of distances between quadruples of vertices should be near unity, given that the observations are projectively related to a regular grid [9,23]. In practice, extremely foreshortened boards cannot be detected (owing to limited resolution), and so it suffices to use an affine test. In particular, for line 
                           
                              
                                 
                                    λ
                                 
                                 
                                    i
                                 
                              
                           
                        , consider the ratio of the vertex-intervals starting at positions j and k:
                           
                              (20)
                              
                                 
                                    
                                       F
                                    
                                    
                                       jk
                                    
                                 
                                 (
                                 
                                    
                                       λ
                                    
                                    
                                       i
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       |
                                       
                                          
                                             v
                                          
                                          
                                             i
                                             (
                                             j
                                             +
                                             1
                                             )
                                          
                                       
                                       -
                                       
                                          
                                             v
                                          
                                          
                                             ij
                                          
                                       
                                       |
                                    
                                    
                                       |
                                       
                                          
                                             v
                                          
                                          
                                             i
                                             (
                                             k
                                             +
                                             1
                                             )
                                          
                                       
                                       -
                                       
                                          
                                             v
                                          
                                          
                                             ik
                                          
                                       
                                       |
                                    
                                 
                              
                           
                        
                     

These ratios are tested along the first and last line in each pencil, and so a suitable set of decision functions is
                           
                              (21)
                              
                                 
                                    
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      1
                                                      -
                                                      
                                                         
                                                            F
                                                         
                                                         
                                                            jk
                                                         
                                                      
                                                      (
                                                      
                                                         
                                                            λ
                                                         
                                                         
                                                            i
                                                         
                                                      
                                                      )
                                                   
                                                
                                             
                                             ⩽
                                             f
                                             
                                             for
                                             
                                             all
                                             
                                             i
                                             ,
                                             j
                                             ,
                                             k
                                          
                                       
                                    
                                    
                                       
                                       
                                          
                                             i
                                             =
                                             {
                                             1
                                             ,
                                             ℓ
                                             }
                                             ,
                                             
                                             j
                                             ,
                                             k
                                             ∈
                                             (
                                             1
                                             :
                                             m
                                             -
                                             1
                                             )
                                             ,
                                             
                                             j
                                             
                                             ≠
                                             
                                             k
                                          
                                       
                                    
                                 
                              
                           
                        for a small positive threshold f. The analogous tests are applied to the other pencil, 
                           
                              M
                           
                        . If any of the tests (21) are failed, then the estimate 
                           
                              (
                              L
                              ,
                              M
                              )
                           
                         is rejected.

Displaced estimates can be determined as follows. Let 
                           
                              w
                              ∈
                              
                                 
                                    λ
                                 
                                 
                                    i
                                 
                              
                           
                         be an image-point on the line segment between vertices 
                           
                              
                                 
                                    v
                                 
                                 
                                    i
                                    1
                                 
                              
                           
                         and 
                           
                              
                                 
                                    v
                                 
                                 
                                    im
                                 
                              
                           
                         that lies ‘inside’ the pencil 
                           
                              M
                           
                        . If this segment is strictly inside the chessboard pattern, then there should be equal numbers of black–white and white–black transitions across it. If, on the other hand, the segment is along the perimeter of the pattern, then the two types of transition will be very imbalanced, as the black squares are ‘missing’ on one side of the perimeter. Let 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    w
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    w
                                 
                              
                              )
                           
                         be the gradient at edge-point 
                           
                              w
                           
                        , and let 
                           
                              
                                 
                                    λ
                                 
                                 
                                    ★
                                 
                              
                              =
                              (
                              α
                              ,
                              β
                              ,
                              γ
                              )
                           
                         be the normalized line coordinates, such that 
                           
                              
                                 
                                    α
                                 
                                 
                                    2
                                 
                              
                              +
                              
                                 
                                    β
                                 
                                 
                                    2
                                 
                              
                              =
                              1
                           
                        . Now the dot-product 
                           
                              
                                 
                                    λ
                                 
                                 
                                    ★
                                 
                              
                              
                                 
                                    (
                                    
                                       
                                          ξ
                                       
                                       
                                          w
                                       
                                    
                                    ,
                                    
                                       
                                          η
                                       
                                       
                                          w
                                       
                                    
                                    ,
                                    0
                                    )
                                 
                                 
                                    ⊤
                                 
                              
                           
                         is the projection of the gradient onto the edge-normal at 
                           
                              w
                           
                        , and so the amount of black–white vs.white–black transitions can be measured by the ratio of the summed positive and negative projections,
                           
                              (22)
                              
                                 G
                                 (
                                 
                                    
                                       λ
                                    
                                    
                                       i
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             k
                                             =
                                             0
                                          
                                          
                                             k
                                             ⩽
                                             d
                                          
                                       
                                       
                                       pos
                                       
                                          
                                             
                                                
                                                   
                                                      λ
                                                   
                                                   
                                                      i
                                                   
                                                   
                                                      ★
                                                   
                                                
                                                
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            ξ
                                                         
                                                         
                                                            w
                                                         
                                                      
                                                      ,
                                                      
                                                         
                                                            η
                                                         
                                                         
                                                            w
                                                         
                                                      
                                                      ,
                                                      0
                                                      )
                                                   
                                                   
                                                      ⊤
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             k
                                             =
                                             0
                                          
                                          
                                             k
                                             ⩽
                                             d
                                          
                                       
                                       
                                       neg
                                       
                                          
                                             
                                                
                                                   
                                                      λ
                                                   
                                                   
                                                      i
                                                   
                                                   
                                                      ★
                                                   
                                                
                                                
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            ξ
                                                         
                                                         
                                                            w
                                                         
                                                      
                                                      ,
                                                      
                                                         
                                                            η
                                                         
                                                         
                                                            w
                                                         
                                                      
                                                      ,
                                                      0
                                                      )
                                                   
                                                   
                                                      ⊤
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                 where
                              
                           
                        
                        
                           
                              (23)
                              
                                 d
                                 =
                                 |
                                 
                                    
                                       v
                                    
                                    
                                       im
                                    
                                 
                                 -
                                 
                                    
                                       v
                                    
                                    
                                       i
                                       1
                                    
                                 
                                 |
                                 
                                 and
                                 
                                 w
                                 =
                                 
                                    
                                       interp
                                    
                                    
                                       k
                                       /
                                       d
                                    
                                 
                                 (
                                 
                                    
                                       v
                                    
                                    
                                       i
                                       1
                                    
                                 
                                 ,
                                 
                                 
                                    
                                       v
                                    
                                    
                                       im
                                    
                                 
                                 )
                              
                           
                        
                     

Here the function 
                           
                              pos
                              (
                              x
                              )
                           
                         returns x if 
                           
                              x
                              >
                              0
                           
                        , or zero otherwise, and 
                           
                              neg
                              (
                              x
                              )
                           
                         returns 
                           
                              |
                              x
                              |
                           
                         if 
                           
                              x
                              <
                              0
                           
                        , or zero otherwise. The ratio 
                           
                              G
                              (
                              λ
                              )
                           
                         should be close to unity for all internal segments, and so an appropriate set of decision functions is
                           
                              (24)
                              
                                 |
                                 1
                                 -
                                 G
                                 (
                                 
                                    
                                       λ
                                    
                                    
                                       i
                                    
                                 
                                 )
                                 |
                                 ⩽
                                 g
                                 
                                 forall
                                 
                                 i
                                 =
                                 1
                                 :
                                 ℓ
                              
                           
                        where g is a small positive threshold. The same test is applied to the 
                           
                              j
                              =
                              (
                              1
                              :
                              m
                              )
                           
                         segments between 
                           
                              
                                 
                                    v
                                 
                                 
                                    1
                                    j
                                 
                              
                           
                         and 
                           
                              
                                 
                                    v
                                 
                                 
                                    ℓ
                                    j
                                 
                              
                           
                        , in pencil 
                           
                              M
                           
                        .

The thresholds f and g in tests (21) and (24) were fixed once and for all in the experiments, such that no false-positive detections (which are unacceptable for calibration purposes) were made, across all data-sets. Furthermore, the same thresholds were used for all cameras.

@&#RESULTS@&#

The new method is evaluated in two ways. Firstly, in Section 3.1, the robustness of the gradient-labelling method to perspective distortion is investigated. Secondly, in Section 3.2 the overall detection performance is compared, over a data-set of several hundred real images, to the most commonly-used (OpenCV) detection method.

It is important, at the outset, to clarify the nature of the evaluation. The ultimate objective of a board-detection algorithm, for calibration purposes, is to detect as many boards as possible, in the greatest variety of poses. In particular, good coverage of the entire 3D scene-volume, by the board vertices, is required for subsequent extrinsic calibration procedures. However, it is also essential that the vertices be accurate, in the sense of geometric error; in particular, there must be no ‘false’ detections or mis-labellings of the vertices. In practice, this means that the parameters of any detection algorithm must be set conservatively. Having done this, then any additional detection is beneficial for subsequent extrinsic calibration, provided that it does not increase the overall geometric error. The evaluation in Section 3.2 is based on large real-world calibration sets, which inevitably contain many problematic images (including those in which the board is not fully visible to one or more cameras). In order to make a real evaluation, there was no attempt to avoid or subsequently remove these images from the data-sets.

This section investigates whether the method can reliably identify two pencils of lines, in the presence of perspective distortion. In particular, it must be shown that the method does not require the midlines of the two pencils to be orthogonal. Ideally, the evaluation would be performed on a controlled image-set, showing a board at all possible orientations. In practice, it is very hard to obtain such an image-set, without using a mechanical mounting for the board. However, it is possible to accurately simulate the geometric effects of foreshortening, by applying a 2D homography to real image-data. This makes it straightforward to construct a uniform distribution of board orientations, including all slants 
                           
                              φ
                           
                        . Furthermore, each classified pixel, labelled 
                           
                              
                                 
                                    κ
                                 
                                 
                                    φ
                                 
                              
                           
                        , is in correspondence with the fronto-parallel ‘best case’, labelled 
                           
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                           
                        . The latter can therefore be used as ground-truth measurements for the evaluation, as explained below. This procedure, importantly, allows us to isolate geometric effects from sampling effects, which leads to a better understanding.

In more detail, a single fronto-parallel (zero slant) image is processed as described in Section 2.1, yielding a gradient vector 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    0
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    0
                                 
                              
                              ,
                              1
                              )
                           
                        , and a label 
                           
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                           
                         at each pixel. A rotation matrix 
                           
                              
                                 
                                    R
                                 
                                 
                                    φ
                                 
                              
                              =
                              R
                              
                                 
                                    
                                       φ
                                       ,
                                       w
                                       (
                                       ϑ
                                       )
                                    
                                 
                              
                              
                              R
                              (
                              
                                 
                                    ω
                                 
                                 
                                    ,
                                 
                              
                              z
                              )
                           
                         is then constructed, using angle-axis factors 
                           
                              R
                              (
                              ·
                              ,
                              ·
                              )
                           
                        . The rotation has the effect of slanting the board by an angle 
                           
                              φ
                           
                        , around an axis 
                           
                              w
                              (
                              ϑ
                              )
                           
                        . This axis is perpendicular to the optical axis 
                           
                              z
                           
                        , with 
                           
                              ϑ
                           
                         being the tilt angle. The second factor, 
                           
                              R
                              (
                              ω
                              ,
                              z
                              )
                           
                        , is a cyclo-rotation around the optical axis 
                           
                              z
                           
                        . The important variable is the slant angle, 
                           
                              φ
                           
                        , which is systematically varied from zero (fronto-parallel) to 
                           
                              
                                 
                                    90
                                 
                                 
                                    °
                                 
                              
                           
                        . At each slant, the tilt and cyclorotation angles 
                           
                              ϑ
                           
                         and 
                           
                              ω
                           
                         are sampled 100 times from the uniform distribution on 
                           
                              [
                              0
                              ,
                              2
                              π
                              ]
                           
                        .

A homography 
                           
                              
                                 
                                    H
                                 
                                 
                                    φ
                                 
                              
                           
                         is now constructed from the rotation matrix 
                           
                              
                                 
                                    R
                                 
                                 
                                    φ
                                 
                              
                           
                        , and applied to the gradient-vectors, so that 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    φ
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    φ
                                 
                              
                              ,
                              1
                              )
                              =
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    0
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    0
                                 
                              
                              ,
                              1
                              )
                              
                                 
                                    H
                                 
                                 
                                    φ
                                 
                                 
                                    -
                                    1
                                 
                              
                           
                        . The transformed gradients are then re-classified, and the ‘slanted’ label 
                           
                              
                                 
                                    κ
                                 
                                 
                                    φ
                                 
                              
                           
                         is compared to the ‘fronto-parallel’ label 
                           
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                           
                        , at each pixel. This can be visualized as a comparison between the two classifications in Fig. 7
                        . Consistency of the slanted classification is defined as the proportion of unchanged labels, over all edges. If 
                           
                              δ
                              (
                              
                                 
                                    κ
                                 
                                 
                                    φ
                                 
                              
                              ,
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                              )
                           
                         is the indicator function that is 1 if 
                           
                              
                                 
                                    κ
                                 
                                 
                                    φ
                                 
                              
                              =
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                           
                        , and 0 otherwise, then
                           
                              
                                 consistency
                                 =
                                 
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             {
                                             
                                                
                                                   κ
                                                
                                                
                                                   0
                                                
                                             
                                             ≠
                                             ∅
                                             }
                                          
                                       
                                       δ
                                       (
                                       
                                          
                                             κ
                                          
                                          
                                             φ
                                          
                                       
                                       ,
                                       
                                          
                                             κ
                                          
                                          
                                             0
                                          
                                       
                                       )
                                    
                                    
                                       
                                          
                                             
                                                {
                                                
                                                   
                                                      κ
                                                   
                                                   
                                                      0
                                                   
                                                
                                                
                                                ≠
                                                
                                                ∅
                                                }
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where 
                           
                              {
                              
                                 
                                    κ
                                 
                                 
                                    0
                                 
                              
                              
                              ≠
                              
                              ∅
                              }
                           
                         is the set of edge-pixels (i.e. large gradients), and 
                           
                              
                                 
                                    
                                       {
                                       
                                          
                                             κ
                                          
                                          
                                             0
                                          
                                       
                                       
                                       ≠
                                       
                                       ∅
                                       }
                                    
                                 
                              
                           
                         is the number of pixels in this set. This statistic is relatively strict, in that it ignores the easy task of classifying the non-edge pixels, for which 
                           
                              κ
                              =
                              ∅
                           
                        .

The results of the experiment are shown in Fig. 8
                        , from which it can be seen that the labelling is robust to slants of more than 
                           
                              
                                 
                                    70
                                 
                                 
                                    °
                                 
                              
                           
                        . This finding validates the basic detection principle, in relation to the geometry of perspective projection. However, in this experiment, the low-level image-processing was performed in the original fronto-parallel images. This was to avoid confounding geometric effects with sampling effects. A complete evaluation, using a real calibration data-set, is performed in the following section.

The method was formally tested on five multi-view data-sets, captured by Mesa Imaging Swiss-Ranger SR-4000 TOF cameras [18]. We used between two and four cameras per data-set (see Table 1
                        ), all performing simultaneous capture. The sizes 
                           
                              
                                 
                                    u
                                 
                                 
                                    1
                                 
                              
                           
                         and 
                           
                              
                                 
                                    v
                                 
                                 
                                    1
                                 
                              
                           
                         of the Hough array were set to 1.5 times the average dimension, 
                           
                              (
                              X
                              +
                              Y
                              )
                              /
                              2
                           
                        , of the input images.

We compare our results to the widely-used OpenCV detector [14]. Both the OpenCV and Hough detections were refined by the OpenCV subpixel routine, which adjusts the given point to minimize the discrepancy with the image-gradient around the chequerboard corner [14,15]. Specifically, if the true vertex has coordinates 
                           
                              (
                              
                                 
                                    x
                                 
                                 
                                    0
                                 
                              
                              ,
                              
                                 
                                    y
                                 
                                 
                                    0
                                 
                              
                              )
                           
                        , and 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                         is the image-gradient at a nearby point 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                        , then
                           
                              (25)
                              
                                 (
                                 
                                    
                                       ξ
                                    
                                    
                                       xy
                                    
                                 
                                 ,
                                 
                                 
                                    
                                       η
                                    
                                    
                                       xy
                                    
                                 
                                 )
                                 ·
                                 (
                                 x
                                 -
                                 
                                    
                                       x
                                    
                                    
                                       0
                                    
                                 
                                 ,
                                 
                                 y
                                 -
                                 
                                    
                                       y
                                    
                                    
                                       0
                                    
                                 
                                 )
                                 ≈
                                 0
                              
                           
                        
                     

This is because if the magnitude of 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                         is not negligible, then 
                           
                              (
                              x
                              ,
                              y
                              )
                           
                         must be on a black–white edge. Hence 
                           
                              (
                              
                                 
                                    ξ
                                 
                                 
                                    xy
                                 
                              
                              ,
                              
                                 
                                    η
                                 
                                 
                                    xy
                                 
                              
                              )
                           
                         must be perpendicular to the edge, while 
                           
                              (
                              x
                              -
                              
                                 
                                    x
                                 
                                 
                                    0
                                 
                              
                              ,
                              y
                              -
                              
                                 
                                    y
                                 
                                 
                                    0
                                 
                              
                              )
                           
                         must be parallel to it.


                        Table 1 shows the number of true-positive detections by each method, as well as the number of detections common to both methods. The geometric error is the discrepancy from the ‘ideal’ board, after fitting the latter by the optimal homography (initialized by the DLT method, and refined by Levenberg–Marquardt optimization [9]). This is by far the most useful measure, as it is directly related to the role of the detected vertices in subsequent calibration algorithms (e.g. bundle-adjustment [9]), and also has a simple interpretation in pixel-units. The photometric error is the RMS gradient residual (25) computed over a 
                           
                              5
                              ×
                              5
                           
                         window. This measure is worth considering, because it is the criterion minimized by the subpixel optimization, but it is much less useful than the geometric error.

The proposed Hough-based method detects 35% more boards than the OpenCV method, on average. There is also a slight reduction in average geometric error, even though the additional boards were more problematic to detect. Even if OpenCV had detected these boards, it is likely that their inclusion would have increased the geometric error even further. It may also be noted that the new method is dramatically better in five cases, in the sense that it detects an additional ten or more boards, while also reducing the geometric error. These results should not be surprising, because the new method uses a very strong model of the global board-geometry.

There were zero false-positive detections (100% precision), as explained in Section 2.5. The number of true-negatives is not useful here, because it depends largely on the configuration of the cameras (i.e.how many images show the back of the board). The false-negatives do not provide a very useful measure either, because the definition of these would depend on an arbitrary judgement about which of the very foreshortened boards ‘ought’ to have been detected (i.e.whether an edge-on board is ‘in’ the image or not). It is emphasized that the test-data are actual calibration sets, containing many problematic images, and so the evaluation is based in a real-world application. Some example detections are shown in Figs. 9–11
                        
                        
                        , including a variety of difficult cases.

@&#DISCUSSION@&#

A new method for the automatic detection of calibration grids in time-of-flight images has been described. The method is based on careful reasoning about the global geometric structure of the board, before and after perspective projection. The method detects many more boards than existing heuristic approaches, which results in a larger and more complete data-set for subsequent calibration algorithms. This is achieved while also reducing the overall geometric error. The increased number and variety of detections is of great benefit to subsequent extrinsic calibration procedures.

@&#FUTURE WORK@&#

The Hough transform was developed, in Section 2.4, as a dense 2-d
                        array. This presentation has the advantage of making the method easy to visualize and implement. However, it also raises issues of resolution and scalability [38,39]. In particular, the implementation in Section 2.4 is inefficient, both in space and time. These issues could be addressed by the use of a randomized Hough transform [40]. This approach avoids building a dense transform array, in favour of a dynamic data structure [41]. Future work will examine the advantages of randomized methods, in relation to the increased complexity of implementation. Another possible direction for future work would be to perform a global refinement of the line-pencils, in the geometric parameterization, but by minimizing a photometric cost-function with respect to the original images.

In a more general view, the present work suggests that it would be useful to have a data-set of calibration images with known 3D poses. These could, for example, be acquired using a robotic mounting of the physical board. This would enable a fine-grained comparison of algorithms, thereby encouraging future work in this area.

@&#REFERENCES@&#

