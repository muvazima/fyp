@&#MAIN-TITLE@&#Feedback control of heart rate during outdoor running: A smartphone implementation

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           A smartphone-based system for heart rate control for running outdoors is proposed.


                        
                        
                           
                           Important for prescription of exercise intensity for fitness training.


                        
                        
                           
                           Highly accurate tracking of target heart rate with RMS error less than 2bpm.


                        
                        
                           
                           Robustness demonstrated despite substantial plant variability.


                        
                        
                           
                           Feedback control of heart rate while running outdoors is deemed feasible.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Cardiorespiratory systems

Physiological control systems

Exercise prescription

Feedback control

@&#ABSTRACT@&#


               
               
                  The aim was to develop and to investigate the technical feasibility of a novel smartphone-based mobile system for feedback control of heart rate during outdoor running. Accurate control is important because heart rate can be used for prescription of exercise intensity for development and maintenance of cardiorespiratory fitness.
                  An Android smartphone was employed together with wearable, wireless sensors for heart rate and running speed. A simple feedback design algorithm appropriate for embedded mobile applications was developed. Controller synthesis uses a low-order, physiologically-validated plant model and requires a single bandwidth-related tuning parameter.
                  Twenty real time controller tests demonstrated highly accurate tracking of target heart rate with a mean root-mean-square tracking error (RMSE) of less than 2 beats per minute (bpm); a sufficient level of robustness was demonstrated within the range of conditions tested. Adjustment of the tuning parameter towards lower closed-loop bandwidth gave markedly lower control signal power (0.0008 vs. 0.0030m2/s2, p
                     <0.0001, low vs. high bandwidth), but at the cost of a significantly lower heart rate tracking accuracy (RMSE 1.99 vs. 1.67bpm, p
                     <0.01).
                  The precision achieved suggests that the system might be applicable for accurate achievement of prescribed exercise intensity for development and maintenance of cardiorespiratory fitness. High-accuracy feedback control of heart rate during outdoor running using smartphone technology is deemed feasible.
               
            

@&#INTRODUCTION@&#

The prescription of exercise intensity for development and maintenance of cardiorespiratory fitness in adults is based on either heart rate (HR) or oxygen uptake [1,2]. With heart rate, intensity can be expressed as a percentage of either maximum heart rate or of heart rate reserve (HRR), the latter being defined as the difference between an individual's maximum and resting heart rates, i.e. HRR≜HRmax
                     −HRrest. For most adults, training is recommended for 20–60min on 3–5d/week at a moderate to vigorous intensity; using heart rate reserve, moderate intensity is defined as 40–59% of HRR and vigorous intensity as 60–89% of HRR [1]. It is therefore of high interest to investigate feedback methods for accurate control of heart rate during exercise.

Because of the convenience of measuring heart rate, automated heart rate control has been implemented in different exercise devices including treadmills [3,4] and cycle ergometers [5], both within commercial devices and in the scientific research literature. Feedback controllers within commercial products seem to be based mainly on conservatively-tuned proportional-integral (PI) controllers and give very poor heart rate tracking performance. Controllers described in the literature tend, on the other hand, to be based on sophisticated non-linear modelling/identification [6] and control design techniques (e.g. [7–10]); to the best of our knowledge, no data have been presented which compare such methods with well-designed robust linear-time-invariant (LTI) controllers.

The primary contribution of this work is the development of a system which enables feedback control of heart rate during free-running outdoor exercise. Hitherto, no system with this capability has been demonstrated, but state-of-the-art smartphone and wearable sensor technologies present the potential to address this lack: smartphones are now available with appropriate open-source programming and operating system environments (e.g. Java, Android) and wireless communication systems (e.g. ANT+); simple, accurate and cost-effective sensors are available for real-time measurement and wireless transmission of heart rate and running speed.

A second contribution of the present work is the employment of analytical feedback design methods which use physiologically-accepted models of the heart rate response to changes in exercise work rate: we assume at the outset that the plant can be modelled by a mono-exponential (first-order) response with operating-point dependent gain and time-constant parameters, which is the usual and physiologically-validated assumption in the exercise sciences [11].

This starting point led to the development of a simple and transparent feedback design algorithm appropriate for embedded mobile applications: controller synthesis based on the low-order, physiologically-validated plant model requires only a single bandwidth-related tuning parameter. It transpires that, despite its simplicity, the algorithm gives high-precision and robust heart-rate tracking performance. A similar approach has previously been employed in the context of rehabilitation robotics [12,13].

The aim of this work was to develop and to investigate the technical feasibility of a novel smartphone-based mobile system for feedback control of heart rate during outdoor running by automatically calculating a target speed for the runner.

@&#METHODS@&#

The method proposed here for feedback control of heart rate is based on the idea of comparing the current, measured heart rate with a target heart rate and on this basis calculating a target speed for the runner. The target speed is displayed by the application on a smartphone display to the runner who then has the task of adjusting actual running speed to meet this target: the actual running speed, obtained from a sensor, is also displayed to the runner (Fig. 1
                        ).

The open-loop structure of the plant has two elements (Fig. 2
                        ): an internal control loop representing the runner's speed control dynamics (
                           
                              v
                              *
                           
                           →
                           v
                        ), and a dynamic block representing the heart rate response to changes in actual speed (
                           v
                           →
                           HR
                        ). The overall plant P is the total dynamic response from target speed 
                           
                              v
                              *
                           
                         to heart rate HR (
                           
                              v
                              *
                           
                           →
                           HR
                        ). This structure is analogous to the plant structure for an automatic heart rate control system for a treadmill; but on a treadmill, the target speed is sent to the motor control electronics which maintain the actual speed close to the target and the runner is thereby forced to follow the speed of the treadmill belt.

The open-loop plant is embedded within a closed-loop feedback system for control of heart rate (Fig. 3
                        ). The target running speed 
                           
                              v
                              *
                           
                         is calculated from a target heart rate profile HR* and a continuous measurement of actual heart rate HR. The controller polynomials R, S and T are calculated to achieve a specified nominal dynamic response from target to actual heart rate, HR*
                        →HR (Section 2.3).

The application has two separate functions:
                           
                              •
                              System identification. During a system identification test, the system operates in open-loop mode (Fig. 2). A target speed profile 
                                    
                                       v
                                       *
                                    
                                  is defined and displayed to the runner along with the actual speed 
                                    v
                                  during the test (Fig. 1(a), with target heart rate set to zero for open-loop identification). The runner has to follow the target speed profile in real time while the heart rate HR is recorded. The input-output data (speed target 
                                    
                                       v
                                       *
                                    
                                  → heart rate HR) are subsequently used off-line to calculate the parameters of a linear transfer function which describes the total heart rate dynamics P, Eq. (1), (Section 2.2).

Feedback control. With this function, the system operates in closed-loop mode (Fig. 3). An arbitrary target heart rate profile HR* is defined based, for example, on a training prescription. The feedback controller attempts to meet this heart rate target by automatically updating the target running speed 
                                    
                                       v
                                       *
                                    
                                  using the current values of the target and actual heart rates, i.e., 
                                    
                                       v
                                       *
                                    
                                  is updated at each sample point using HR* and HR. The target speed 
                                    
                                       v
                                       *
                                    
                                  and actual speed 
                                    v
                                  are displayed (Fig. 1(a)) and the runner attempts to keep the actual speed close to the target.

The plant was modelled as a first-order linear time-invariant transfer function with steady-state gain k and time constant τ:
                           
                              (1)
                              
                                 
                                    v
                                    *
                                 
                                 →
                                 HR
                                 :
                                    
                                 
                                    P
                                    c
                                 
                                 (
                                 s
                                 )
                                 =
                                 
                                    k
                                    
                                       1
                                       +
                                       s
                                       τ
                                    
                                 
                                 
                                    ↔
                                    
                                       
                                          T
                                          s
                                       
                                    
                                 
                                 
                                    P
                                    d
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       
                                          b
                                          0
                                       
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                    
                                    
                                       1
                                       +
                                       
                                          a
                                          1
                                       
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        The double arrow denotes conversion between the continuous and discrete frequency-domain functions P
                        
                           c
                         and P
                        
                           d
                        , with s and z complex variables, using a sample period T
                        
                           s
                        . For a given pair k, τ, the discrete-time parameters b
                        0 and a
                        1 are obtained as
                           
                              (2)
                              
                                 
                                    b
                                    0
                                 
                                 =
                                 k
                                 (
                                 1
                                 −
                                 
                                    e
                                    
                                       (
                                       
                                          −
                                          
                                             T
                                             s
                                          
                                       
                                       /
                                       τ
                                       )
                                    
                                 
                                 )
                                 ,
                                 
                                 
                                    a
                                    1
                                 
                                 =
                                 −
                                 
                                    e
                                    
                                       (
                                       
                                          −
                                          
                                             T
                                             s
                                          
                                       
                                       /
                                       τ
                                       )
                                    
                                 
                                 ,
                              
                           
                        while conversion in the other direction, from discrete to continuous parameters, is given by
                           
                              (3)
                              
                                 k
                                 =
                                 
                                    
                                       
                                          b
                                          0
                                       
                                    
                                    
                                       1
                                       +
                                       
                                          a
                                          1
                                       
                                    
                                 
                                 ,
                                 
                                 τ
                                 =
                                 
                                    
                                       −
                                       
                                          T
                                          s
                                       
                                    
                                    
                                       ln
                                       (
                                       −
                                       
                                          a
                                          1
                                       
                                       )
                                    
                                 
                                 .
                              
                           
                        
                     

Identification data were recorded using a sample interval T
                        
                           s
                        
                        =5s. Parameter estimation was performed using the Matlab System Identification Toolbox (The MathWorks Inc.): following removal of trends and offsets in the raw data, the parameters of P
                        
                           d
                         were obtained directly in the discrete-time domain using least-squares [14]. Goodness-of-fit of estimated models was assessed using a normalised root-mean-square fit value, expressed as a percentage (i.e. the “fit” parameter calculated within the Toolbox for model evaluation).

The sample interval T
                        
                           s
                        
                        =5s was chosen based on the recommendation of having 4–10 samples per rise time [15], and the desire to sample quickly enough to achieve closed-loop rise times of down to 50s. Sampling at T
                        
                           s
                        
                        =5s also gives about 10 samples over a time equal to the identified open-loop time constant (τ
                        =51.4s, see Section 3.1).

The feedback controller was implemented with a two-degrees-of-freedom structure:
                           
                              (4)
                              
                                 
                                    HR
                                    *
                                 
                                 ,
                                 HR
                                 →
                                 
                                    v
                                    *
                                 
                                 :
                                    
                                 
                                    v
                                    *
                                 
                                 (
                                 i
                                 )
                                 =
                                 
                                    1
                                    
                                       R
                                       (
                                       
                                          q
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                 
                                 (
                                 T
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 
                                    HR
                                    *
                                 
                                 (
                                 i
                                 )
                                 −
                                 S
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 HR
                                 (
                                 i
                                 )
                                 )
                                 .
                              
                           
                        In this time-domain representation, R, S and T are polynomials in the delay operator q
                        −1 and i denotes the discrete sample index, i.e. t
                        =
                        iT
                        
                           s
                        .

For a general plant transfer function P
                        
                           d
                        (z
                        −1)=
                        B(z
                        −1)/A(z
                        −1), with A and B polynomials, the closed-loop transfer function is
                           
                              (5)
                              
                                 
                                    HR
                                    *
                                 
                                 →
                                 HR
                                 :
                                    
                                 
                                    G
                                    d
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       B
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                       T
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                    
                                       A
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                       R
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                       +
                                       B
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                       S
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                 
                                 .
                              
                           
                        
                     

The pole assignment design method sets the characteristic polynomial AR
                        +
                        BS to a desired, pre-specified polynomial Φ. Integral action is included in the controller by constraining R as
                           
                              (6)
                              
                                 R
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 (
                                 1
                                 −
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 
                                    R
                                    ′
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 .
                              
                           
                        Thus, the unique solution R′, S is sought for the equation
                           
                              (7)
                              
                                 A
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 (
                                 1
                                 −
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 
                                    R
                                    ′
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 +
                                 B
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 S
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 Φ
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                              
                           
                        with the constraint that the transfer function S/R is causal. For the first order discrete-time plant P
                        
                           d
                         in Eq. (1), straightforward algebraic considerations, [15,16], give the appropriate degrees of R′, S and Φ as n
                        
                           r′
                        =0, n
                        
                           s
                        
                        =1 and n
                        
                           ϕ
                        
                        =2.

This can be seen by considering that the number of unknown controller coefficients is n
                        
                           r′
                        +
                        n
                        
                           s
                        
                        +1 (R is by convention normalised). For existence of a unique solution to (7), this must be equal to the degree of Φ, which in turn is equal to n
                        
                           a
                        
                        +1+
                        n
                        
                           r′ since by assumption S/R is causal and B/A strictly causal. Thus, for n
                        
                           a
                        
                        =1, we have n
                        
                           r′
                        +
                        n
                        
                           s
                        
                        +1=1+1+
                        n
                        
                           r′, giving n
                        
                           s
                        
                        =1. With causal S/R we get n
                        
                           r
                        
                        =
                        n
                        
                           s
                        
                        ⇔
                        n
                        
                           r′
                        =
                        n
                        
                           r
                        
                        −1=
                        n
                        
                           s
                        
                        −1; with n
                        
                           s
                        
                        =1, n
                        
                           r′
                        =0. Finally, from (7) and taking n
                        
                           a
                        
                        =1, n
                        
                           ϕ
                        
                        =
                        n
                        
                           r′
                        +2=2. QED. Thus,
                           
                              (8)
                              
                                 R
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 1
                                 −
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                 S
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    s
                                    0
                                 
                                 +
                                 
                                    s
                                    1
                                 
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                              
                           
                        and
                           
                              (9)
                              
                                 Φ
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 1
                                 +
                                 
                                    ϕ
                                    1
                                 
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 +
                                 
                                    ϕ
                                    2
                                 
                                 
                                    z
                                    
                                       −
                                       2
                                    
                                 
                                 .
                              
                           
                        The controller coefficients s
                        0 and s
                        1 are readily obtained from the solution of Eq. (7) in the explicit form
                           
                              (10)
                              
                                 
                                    s
                                    0
                                 
                                 =
                                 
                                    
                                       (
                                       
                                          ϕ
                                          1
                                       
                                       −
                                       
                                          a
                                          1
                                       
                                       +
                                       1
                                       )
                                    
                                    
                                       
                                          b
                                          0
                                       
                                    
                                 
                                 ,
                                 
                                 
                                    s
                                    1
                                 
                                 =
                                 
                                    
                                       (
                                       
                                          ϕ
                                          2
                                       
                                       +
                                       
                                          a
                                          1
                                       
                                       )
                                    
                                    
                                       
                                          b
                                          0
                                       
                                    
                                 
                                 .
                              
                           
                        The controller polynomial T is selected to achieve unity steady-state gain in the closed-loop transfer function G
                        
                           d
                        . From Eq. (5), and using the first-order plant (1) and Φ polynomial of degree 2 as in (9), T is obtained in this case as the scalar t
                        0:
                           
                              (11)
                              
                                 T
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    t
                                    0
                                 
                                 =
                                 
                                    
                                       Φ
                                       (
                                       1
                                       )
                                    
                                    
                                       B
                                       (
                                       1
                                       )
                                    
                                 
                                 =
                                 
                                    
                                       (
                                       1
                                       +
                                       
                                          ϕ
                                          1
                                       
                                       +
                                       
                                          ϕ
                                          2
                                       
                                       )
                                    
                                    
                                       
                                          b
                                          0
                                       
                                    
                                 
                                 .
                              
                           
                        
                     

The two closed-loop poles were calculated by time-domain selection of a desired 10–90% closed-loop rise time t
                        
                           r
                         and relative damping ζ for a closed-loop transfer function G
                        
                           c
                         in standard second-order format
                           
                              (12)
                              
                                 
                                    G
                                    c
                                 
                                 (
                                 s
                                 )
                                 =
                                 
                                    
                                       
                                          ω
                                          n
                                          2
                                       
                                    
                                    
                                       
                                          s
                                          2
                                       
                                       +
                                       2
                                       ζ
                                       
                                          ω
                                          n
                                       
                                       s
                                       +
                                       
                                          ω
                                          n
                                          2
                                       
                                    
                                 
                                 ,
                              
                           
                        where the natural frequency ω
                        
                           n
                         is related to rise time as ω
                        
                           n
                        
                        =3.35/t
                        
                           r
                         when ζ is close to 1 [17]; in the sequel, critical damping with ζ
                        =1 is employed because overshoot of the heart rate into a higher-than-desired exercise intensity range is physiologically undesirable.

The discrete characteristic polynomial Φ(z
                        −1), Eqs. (7, 9), is obtained as the denominator of G
                        
                           c
                         discretised with sample time T
                        
                           s
                        , i.e. the denominator of G
                        
                           d
                         in Eq. (5) where 
                           
                              G
                              d
                           
                           (
                           
                              z
                              
                                 −
                                 1
                              
                           
                           )
                           
                              ↔
                              
                                 
                                    T
                                    s
                                 
                              
                           
                           
                              G
                              c
                           
                           (
                           s
                           )
                        :
                           
                              (13)
                              
                                 
                                    HR
                                    *
                                 
                                 →
                                 HR
                                 :
                                    
                                 
                                    G
                                    c
                                 
                                 (
                                 s
                                 )
                                 =
                                 
                                    
                                       
                                          ω
                                          n
                                          2
                                       
                                    
                                    
                                       
                                          
                                             (
                                             s
                                             +
                                             
                                                ω
                                                n
                                             
                                             )
                                          
                                          2
                                       
                                    
                                 
                                 
                                    ↔
                                    
                                       
                                          T
                                          s
                                       
                                    
                                 
                                 
                                    G
                                    d
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       N
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                    
                                       1
                                       −
                                       2
                                       
                                          e
                                          
                                             −
                                             
                                                ω
                                                n
                                             
                                             
                                                T
                                                s
                                             
                                          
                                       
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       +
                                       
                                          e
                                          
                                             −
                                             2
                                             
                                                ω
                                                n
                                             
                                             
                                                T
                                                s
                                             
                                          
                                       
                                       
                                          z
                                          
                                             −
                                             2
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       N
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                    
                                       Φ
                                       (
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                       )
                                    
                                 
                                 ,
                              
                           
                        where N is the numerator polynomial of G
                        
                           d
                        , and plays no further role in the pole-assignment-based controller development. The coefficients of Φ can be identified from Eq. (13) as
                           
                              (14)
                              
                                 
                                    ϕ
                                    1
                                 
                                 =
                                 −
                                 2
                                 
                                    e
                                    
                                       −
                                       
                                          ω
                                          n
                                       
                                       
                                          T
                                          s
                                       
                                    
                                 
                                 ,
                                 
                                 
                                    ϕ
                                    2
                                 
                                 =
                                 
                                    e
                                    
                                       −
                                       2
                                       
                                          ω
                                          n
                                       
                                       
                                          T
                                          s
                                       
                                    
                                 
                                 .
                              
                           
                        
                     


                        Algorithm: Specification of the desired closed-loop response and calculation of the controller polynomials R, S and T can be summarised as follows:
                           
                              1.
                              Given: nominal plant transfer function P
                                 
                                    d
                                 (z
                                 −1)=
                                 b
                                 0
                                 z
                                 −1/(1+
                                 a
                                 1
                                 z
                                 −1) and sample interval T
                                 
                                    s
                                 .

Choose desired closed-loop rise time t
                                 
                                    r
                                 , compute ω
                                 
                                    n
                                 
                                 =3.35/t
                                 
                                    r
                                 .

Calculate Φ: ϕ
                                 1
                                 =−2e
                                 −ω
                                    
                                       n
                                    
                                    T
                                    
                                       s
                                    
                                 , ϕ
                                 2
                                 =
                                 e
                                 −2ω
                                    
                                       n
                                    
                                    T
                                    
                                       s
                                    
                                 .

Calculate S, T: s
                                 0
                                 =(ϕ
                                 1
                                 −
                                 a
                                 1
                                 +1)/b
                                 0, s
                                 1
                                 =(ϕ
                                 2
                                 +
                                 a
                                 1)/b
                                 0, t
                                 0
                                 =(1+
                                 ϕ
                                 1
                                 +
                                 ϕ
                                 2)/b
                                 0.

The controller polynomials are then R(q
                                 −1)=1−
                                 q
                                 −1, S(q
                                 −1)=
                                 s
                                 0
                                 +
                                 s
                                 1
                                 q
                                 −1, T(q
                                 −1)=
                                 t
                                 0 and the controller is implemented according to Eq. (4) using sample interval T
                                 
                                    s
                                 .

Steps 1–4 were implemented explicitly in Matlab, and step 5 in the application for real time control. A sample interval of T
                        
                           s
                        
                        =5s was used as in system identification and two controllers, with rise times t
                        
                           r
                        
                        =120s and t
                        
                           r
                        
                        =180s, were tested.

Choice of these two values for t
                        
                           r
                         was based on two considerations. First, in general control theory terms, a relatively “neutral” feedback system can be obtained by placing closed-loop poles at or close to the open-loop poles. For a first-order plant with time constant τ, and using the algorithm derived above, this is achieved by setting ω
                        
                           n
                        
                        =1/τ (the above algorithm has two real closed-loop poles at position ω
                        
                           n
                        ). Since ω
                        
                           n
                        
                        =3.35/t
                        
                           r
                        , this is equivalent to t
                        
                           r
                        
                        =3.35τ. With τ
                        =51.4s, as in the identified plant model in the sequel (Section 3.1), a “neutral” closed-loop rise time would be t
                        
                           r
                        
                        =3.35×51.4=172s. These considerations guided the choices t
                        
                           r
                        
                        =180s as likely to give a “neutral” or subjectively comfortable controller, while t
                        
                           r
                        
                        =120s was anticipated to give a much faster, more dynamic response.

The second consideration leading to these choices for t
                        
                           r
                         was that extensive testing of these values for feedback control of HR on a treadmill showed that the expected neutral or dynamic behaviour was observed (unpublished data).

The controller equation, (4), was coded as an application in Java and implemented on a smartphone (Xperia Arc S LT18i, Sony Ericsson) running Android operating system version 2.3.4. This device implements the Ant+ communication protocol (Dynastream Innovations Inc.), an open-access multicast wireless sensor network technology.

Running speed 
                           v
                         was measured with a shoe-mounted sensor (SDM4 Foot Pod, Garmin; Fig. 1(b)) and heart rate HR by a chest belt (HRM1G Heart Rate Monitor, Garmin). Both sensors transmit data asynchronously using ANT+ for reception by the smartphone, but the overall processing then becomes synchronous as the heart rate control application is activated with a regular time interval as described below.

The controller program was timed to trigger every T
                        
                           s
                        
                        s in order to calculate the new target speed 
                           
                              v
                              *
                           
                         based on the most recent value of heart rate HR and the current target HR*, Eq. (4). The visual display of 
                           
                              v
                              *
                           
                         was updated immediately and the current values of HR*, HR, 
                           
                              v
                              *
                           
                        , 
                           v
                         and time saved to a file. The control loop then waited for the next trigger time. Measured heart rate HR and actual speed 
                           v
                         were obtained asynchronously from the sensors and updated on the display independently of the control loop.

In order to facilitate timing analysis, the system clock was called during every iteration of the control loop and the time value saved as described above for later analysis: the difference between each time value was averaged for each test evaluation period and compared with the nominal sample period T
                        
                           s
                        .

The graphical user interface provides a numerical display of HR*, HR, 
                           
                              v
                              *
                           
                        , 
                           v
                         and time t (Fig. 1(a)). The two large bars show the target speed 
                           
                              v
                              *
                           
                         (left bar) and actual speed 
                           v
                         (right bar). The user is instructed to focus on the speed bars while running and to keep the actual speed as close as possible to the target speed. The same user interface is used for both system identification and feedback control. For system identification, there is no target heart rate (set to zero in the display) and the target speed is set according to a pre-specified profile.

Twenty controller tests (10 with t
                        
                           r
                        
                        =120s and 10 with t
                        
                           r
                        
                        =180s) were carried out by the same test person (denoted TP1) on separate days at approximately the same time of day within the period June to August 2014. Both controllers were calculated using a nominal model obtained from a single identification test with TP1 (Section 3.1). TP1 had the following characteristics: male, age 50years, body mass 78kg, height 1.85m. Two further controller tests (one with t
                        
                           r
                        
                        =120s and one with t
                        
                           r
                        
                        =180s) were carried out by a second test person (denoted TP2) on separate days at approximately the same time of day in May 2015. In order to provide a basis for initial evaluation of controller robustness, the controller parameters in the tests with TP2 were the same as those used for TP1, i.e. the two controllers were not re-tuned for TP2. TP2 had the following characteristics: male, age 24years, body mass 68kg, height 1.71m.

Testing was done outdoors on a slightly undulating forest track (Fig. 1(c)) and exactly the same course was followed during each test. Target heart rate HR* was a square wave signal with levels 140 and 150bpm, period 10min and duration 25min (cf. Figs. 5(a) and 6(a)
                        
                        ). A square-wave target signal was selected as this reflects the overall format of modern interval-training exercise protocols both in healthy adults [18] and in patient populations [19].

The quality of closed-loop tracking for heart rate HR and running speed 
                           v
                         (Fig. 3) was calculated as the root-mean-square tracking error (RMSE) on an evaluation interval [i
                        1, i
                        2], where i denote the discrete sample indices:
                           
                              (15)
                              
                                 
                                    RMSE
                                    HR
                                 
                                 =
                                 
                                    
                                       
                                          1
                                          N
                                       
                                       
                                          ∑
                                          
                                             i
                                             =
                                             
                                                i
                                                1
                                             
                                          
                                          
                                             
                                                i
                                                2
                                             
                                          
                                       
                                       
                                          
                                             (
                                             
                                                HR
                                                sim
                                             
                                             (
                                             i
                                             )
                                             −
                                             HR
                                             (
                                             i
                                             )
                                             )
                                          
                                          2
                                       
                                    
                                 
                                 ,
                                 
                                 
                                    RMSE
                                    v
                                 
                                 =
                                 
                                    
                                       
                                          1
                                          N
                                       
                                       
                                          ∑
                                          
                                             i
                                             =
                                             
                                                i
                                                1
                                             
                                          
                                          
                                             
                                                i
                                                2
                                             
                                          
                                       
                                       
                                          
                                             (
                                             
                                                v
                                                *
                                             
                                             (
                                             i
                                             )
                                             −
                                             v
                                             (
                                             i
                                             )
                                             )
                                          
                                          2
                                       
                                    
                                 
                              
                           
                        with N
                        =
                        i
                        2
                        −
                        i
                        1
                        +1. HRsim is the simulated nominal heart rate response, i.e. HRsim(i)=
                        G
                        
                           d
                        (q
                        −1)HR*(i) (see Eq. (5)).

The intensity of the control signal was obtained as the mean power of changes in 
                           
                              v
                              *
                           
                         over the same interval:
                           
                              (16)
                              
                                 
                                    P
                                    
                                       
                                          v
                                          *
                                       
                                    
                                 
                                 =
                                 
                                    1
                                    N
                                 
                                 
                                    ∑
                                    
                                       i
                                       =
                                       
                                          i
                                          1
                                       
                                       +
                                       1
                                    
                                    
                                       
                                          i
                                          2
                                       
                                    
                                 
                                 
                                    
                                       (
                                       
                                          v
                                          *
                                       
                                       (
                                       i
                                       )
                                       −
                                       
                                          v
                                          *
                                       
                                       (
                                       i
                                       −
                                       1
                                       )
                                       )
                                    
                                    2
                                 
                              
                           
                        with N
                        =
                        i
                        2
                        −
                        i
                        1.

The three primary outcome measures, RMSEHR, 
                           
                              RMSE
                              v
                           
                         and 
                           
                              P
                              
                                 
                                    v
                                    *
                                 
                              
                           
                        , were compared between the 10 tests with TP1 of each of the two controllers evaluated (t
                        
                           r
                        
                        =120s and t
                        
                           r
                        
                        =180s). Differences were analysed statistically using a paired one-sided t-test to check the hypotheses that the controller with t
                        
                           r
                        
                        =120, having a higher bandwidth, would give:
                           
                              1.
                              lower heart-rate tracking error RMSEHR,

higher speed tracking error 
                                    
                                       RMSE
                                       v
                                    
                                  and

higher mean power 
                                    
                                       P
                                       
                                          
                                             v
                                             *
                                          
                                       
                                    
                                  in the control signal.

@&#RESULTS@&#

All controllers tested in the sequel were calculated using a nominal plant model estimated using data from a single identification test carried out in July 2012 with test person TP1. The target speed 
                           
                              v
                              *
                           
                         was a square wave signal with levels 2.2 and 2.7m/s and a period of 6min (Fig. 4
                        (a)). A section of data was selected following the initial transient, in the time interval 120≤
                        t
                        ≤890s, and the heart rate trend and mean levels removed as described above (Fig. 4(b)).

The estimated discrete-time parameters were b
                        0
                        =2.9688 and a
                        1
                        =−0.9073, Eq. (1). Using Eq. (3) gives a steady-state gain k
                        =32.0 and time constant τ
                        =51.4:
                           
                              (17)
                              
                                 
                                    v
                                    *
                                 
                                 →
                                 HR
                                 :
                                    
                                 
                                    P
                                    d
                                 
                                 (
                                 
                                    z
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 
                                    
                                       2.9688
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                    
                                    
                                       1
                                       −
                                       0.9073
                                       
                                          z
                                          
                                             −
                                             1
                                          
                                       
                                    
                                 
                                 
                                    ↔
                                    
                                       
                                          T
                                          s
                                       
                                       =
                                       5
                                       s
                                    
                                 
                                 
                                    P
                                    c
                                 
                                 (
                                 s
                                 )
                                 =
                                 
                                    32.0
                                    
                                       1
                                       +
                                       51.4
                                       s
                                    
                                 
                                 .
                              
                           
                        Comparison of simulated and model outputs gave a model fit of 76.0% (Fig. 4(c)). Both visual inspection and the high value of quantitative model fit (i.e. the normalised RMS model error, describing the percentage of the output variation that is explained by the model) show that this degree of model fidelity is very good.

The estimated gain k
                        =32.0 and time constant τ
                        =51.4 are consistent with and lie within the ranges estimated for the same test person in a series of 26 identification tests carried out on a treadmill between November 2013 and May 2014. For all of these tests, the target speed profile had the same period and amplitude as used here and speed lay within the range [1.5, 3.0]m/s. The estimated gains and time constants were on the ranges: k
                        ∈[19, 34], τ
                        ∈[25, 64] (unpublished data). Similarly, these estimates are consistent with ranges for k and τ obtained in a treadmill study with 24 subjects [20].

The two controllers tested (t
                        
                           r
                        
                        =120s, t
                        
                           r
                        
                        =180s) were calculated using the same identified model, P
                        
                           d
                        (q
                        −1)=2.9688q
                        −1/(1−0.9073q
                        −1), Eq. (17), giving the following controller parameters (‘Algorithm,’ Section 2.3):


                        
                           
                              (18)
                              
                                 
                                    t
                                    r
                                 
                                 =
                                 120
                                 :
                                 R
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 1
                                 −
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                 S
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 0.056539
                                 −
                                 0.050822
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                 T
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 0.005717
                                 ,
                              
                           
                        
                        
                           
                              (19)
                              
                                 
                                    t
                                    r
                                 
                                 =
                                 180
                                 :
                                 R
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 1
                                 −
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                 S
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 0.028634
                                 −
                                 0.025974
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                 T
                                 (
                                 
                                    q
                                    
                                       −
                                       1
                                    
                                 
                                 )
                                 =
                                 0.002660
                                 .
                              
                           
                        The controllers were implemented with the precision indicated here. The controller with t
                        
                           r
                        
                        =120 had a gain margin of 21.6dB and phase margin of 82.8°; for t
                        
                           r
                        
                        =180, the margins were 27.4dB and 87.5°.

Performance outcomes RMSEHR, 
                           
                              RMSE
                              v
                           
                         and 
                           
                              P
                              
                                 
                                    v
                                    *
                                 
                              
                           
                         (Eqs. (15) and (16)) were calculated for each test over the interval 250≤
                        t
                        ≤1450s (cf. Figs. 5 and 6). Comparing the TP1-outcomes for the controllers with t
                        
                           r
                        
                        =120s and t
                        
                           r
                        
                        =180s (Table 1
                        ), mean heart-rate tracking error RMSEHR was lower for t
                        
                           r
                        
                        =120 (1.67 vs. 1.99bpm, p
                        <0.01), mean speed tracking error 
                           
                              RMSE
                              v
                           
                         was higher (0.099 vs. 0.060 m/s, p
                        <0.0001) and mean control signal power 
                           
                              P
                              
                                 
                                    v
                                    *
                                 
                              
                           
                         was higher (0.0030 vs. 0.0008 m2/s2, p
                        <0.0001).

Visual inspection of typical heart rate control results allows these differences in the performance outcomes to be gauged (Fig. 5(a, b) vs. Fig. 6(a, b)). The difference in overall heart rate tracking error RMSEHR can be visualised using the bounds HRsim± mean RMSEHR (shaded areas in Figs. 5(a) and 6(a)). Since RMS tracking error is equivalent to the standard deviation for stationary signals, these bounds show the area within which approximately 68.3% of the measured heart rate data points would be expected to lie for a given test, under the assumption that the test data are normally distributed.

The measured sample period for all 20 TP1-tests was 5.0157 ± 0.0007s (mean ± SD), giving a coefficient of variation (CoV = SD/mean) of 1.3% and a mean error relative to the nominal sample period T
                        
                           s
                        
                        =5s of +0.3%. The sample period error of +15.7ms (+0.3%) appears stable (low CoV) and probably results from the time required for calculation of the control signal and saving of the current data to a file. The low magnitude of the timing error is deemed negligible in relation to the absolute nominal sample period of 5s.

The two controller tests with TP2, which used the same controller parameters as for TP1, gave highly accurate HR control performance with RMSEHR and 
                           
                              P
                              
                                 
                                    v
                                    *
                                 
                              
                           
                         values within the ranges measured in the multiple tests with TP1 (Table 2
                        ).

@&#DISCUSSION@&#

The aim of this work was to develop and to investigate the technical feasibility of a novel smartphone-based mobile system for feedback control of heart rate during outdoor running by automatically calculating a target speed for the runner.

The results show highly accurate tracking of target heart rate within a range which is regarded as ‘vigorous’ exercise for TP1 according to HRR-based training recommendations [1]. Test person TP1 had maximum and resting heart rates of 183bpm and 51bpm, respectively, thus the target heart rates reported here, 140bpm and 150bpm, were 67% and 75% of HRR for this person. Both controllers tested with TP1 achieved very tight HR tracking with mean RMSEHR
                     <2bpm. This level of precision suggests that the system might be applicable for accurate achievement of prescribed exercise intensity for development and maintenance of cardiorespiratory fitness.

A controller synthesis algorithm was developed based on a low-order LTI plant model. Explicit solution of the pole assignment problem resulted in a simple and transparent design algorithm with a single tuning parameter, viz. the desired closed-loop rise time t
                     
                        r
                     . This level of simplicity is regarded as important for an embedded mobile application where the user can easily modify the tuning parameter to achieve a desired response.

Both values of t
                     
                        r
                      tested (180 vs. 120s) gave highly accurate tracking (mean RMSEHR for TP1 1.99 vs. 1.67bpm), but the lower-bandwidth design with t
                     
                        r
                     
                     =180s showed a markedly lower control signal power 
                        
                           P
                           
                              
                                 v
                                 *
                              
                           
                        
                      than did t
                     
                        r
                     
                     =120s (0.0008 vs. 0.0030m2/s2); this is the primary difference which was subjectively noted by TP1 while running, a difference which is further seen in the more accurate speed tracking that could be achieved with this controller (mean RMSE
                        
                           
                           v
                        
                      0.060 vs. 0.099m/s). The smoother control signal with t
                     
                        r
                     
                     =180s was regarded as substantially more comfortable to use. Given the single tuning parameter, the user can readily modify the control performance as desired.

The controller design method also displayed a sufficient level of robustness within the range of conditions tested: the two controllers were based upon a single, historical LTI plant model for TP1, yet they performed in a stable and accurate fashion in all tests, even though the gain and time constant parameters for TP1 will have varied across the range quantified above (i.e. k
                     ∈[19, 34], τ
                     ∈[25, 64]), and further elaborated in [20]. The two tests with TP2 underline the robustness of the controllers: the controller parameters used were those calculated using the nominal TP1 model (i.e. no re-tuning was done), yet the quantitative HR control performance measures were highly accurate and on the same range as those seen for the multiple tests with TP1.

The outcomes discussed above give initial indications of robustness, but the control method and application now require further testing using a much larger pool of test persons and controller tests in order to address the variability that would be expected to arise from various sources.

Further research is warranted in relation to the user interface. Observation of the target and actual speed bars provided a method appropriate to this technical feasibility study, but this may not be the most convenient approach for day-to-day application. A promising approach might be to replace the visual user interface with audio signals. These issues need to be addressed in formal usability studies.

Furthermore, the efficacy of the proposed control method should be further investigated by comparison with a simple controller where the runner manually attempts to control heart rate using only a HR monitor. The accuracy of heart rate tracking using these two approaches should be compared over a range of subjects.

@&#CONCLUSION@&#

The empirical results presented above demonstrate that high-accuracy feedback control of heart rate during outdoor running using smartphone technology is feasible. The method could be applicable for implementation of fitness programmes in both healthy individuals and in various patient populations. Current ACSM guidelines give exercise prescription for cardiac rehabilitation patients in terms of heart rate reserve [2]; for this patient group, exercise intensity is recommended to be 40–80% of heart rate reserve. During interval training protocols, values as high as 85–95% of HRmax for repeated 4-min durations are currently recommended [19]. Smartphone and wearable sensor technology might be especially useful in this patient group because of the convenience of implementation; a recent survey highlighted the potential benefits of smartphone technology in healthcare applications [21].

@&#ACKNOWLEDGEMENTS@&#

We thank Simon Fankhauser (Institute for Rehabilitation and Performance Technology, Bern University of Applied Sciences) for assistance with technical validation of the control algorithm.

@&#REFERENCES@&#

