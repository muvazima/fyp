@&#MAIN-TITLE@&#Implementing QR factorization updating algorithms on GPUs

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           The first implementation of QR factorization updating algorithms on GPUs.


                        
                        
                           
                           We achieved speed-ups over full QR factorization of over 13× in some cases.


                        
                        
                           
                           The accuracies of our results were comparable with serial-computed solutions.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

QR factorization

QR updating

GPGPU computing

@&#ABSTRACT@&#


               
               
                  Linear least squares problems are commonly solved by QR factorization. When multiple solutions need to be computed with only minor changes in the underlying data, knowledge of the difference between the old data set and the new can be used to update an existing factorization at reduced computational cost. We investigate the viability of implementing QR updating algorithms on GPUs and demonstrate that GPU-based updating for removing columns achieves speed-ups of up to 13.5× compared with full GPU QR factorization. We characterize the conditions under which other types of updates also achieve speed-ups.
               
            

@&#INTRODUCTION@&#

In a least squares problem we wish to find a vector x such that:
                        
                           
                              
                                 
                                    min
                                 
                                 
                                    x
                                 
                              
                              |
                              |
                              Ax
                              -
                              b
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                              
                           
                        
                     where A is an 
                        
                           m
                           ×
                           n
                        
                      matrix of input coefficients with 
                        
                           m
                           ⩾
                           n
                        
                      and b is a length m vector of observations. To do this we can use the QR factorization of A:
                        
                           
                              |
                              |
                              Ax
                              -
                              b
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                              
                              =
                              |
                              |
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                              Ax
                              -
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                              b
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                                 
                                    2
                                 
                              
                              =
                              |
                              |
                              Rx
                              -
                              d
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                                 
                                    2
                                 
                              
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  
                                                                     
                                                                        
                                                                           R
                                                                        
                                                                        
                                                                           1
                                                                        
                                                                     
                                                                  
                                                               
                                                               
                                                                  
                                                                     0
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                   x
                                                   -
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  
                                                                     f
                                                                  
                                                               
                                                               
                                                                  
                                                                     g
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    2
                                 
                                 
                                    2
                                 
                              
                              =
                              |
                              |
                              
                                 
                                    R
                                 
                                 
                                    1
                                 
                              
                              x
                              -
                              f
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                                 
                                    2
                                 
                              
                              +
                              |
                              |
                              g
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                                 
                                    2
                                 
                              
                              .
                           
                        
                     
                     
                        
                           
                              
                                 R
                              
                              
                                 1
                              
                           
                        
                      is upper triangular and thus 
                        
                           |
                           |
                           
                              
                                 R
                              
                              
                                 1
                              
                           
                           x
                           -
                           f
                           |
                           
                              
                                 |
                              
                              
                                 2
                              
                              
                                 2
                              
                           
                           =
                           0
                        
                      can be solved by back substitution, leaving 
                        
                           |
                           |
                           g
                           |
                           
                              
                                 |
                              
                              
                                 2
                              
                              
                                 2
                              
                           
                        
                      as the minimum residual.

This approach fits a linear model to observed data. For example, we can use it to model the relationship between an individual’s wage and variables such as their age, education and length of employment. Each row of A will contain the values of these variables for one person, with the corresponding entry in b being the observed value of their pay. In order to incorporate extra observations (in this example, people) we add rows to A, while if we wish to remove observations we must delete rows. Similarly, we can add variables to the problem by adding columns to A and remove them by deleting columns.

QR factorizations are computationally expensive, but when elements are added to or removed from A it is not always necessary to recompute Q and R from scratch. Instead, it can be cheaper to update the existing factorization to incorporate the changes to A. We aim to accelerate the updating algorithms originally presented in [1] by implementing them on a GPU using CUDA. These algorithms have been shown to outperform full QR factorization in a serial environment [1], and we have previously demonstrated that their implementation on a GPU can outperform a serial implementation by a wide margin [2]. Other papers have investigated implementing full QR factorization on GPUs, for example by using blocked Householder transformations [3] or a tile-based approach across multicore CPUs and multiple GPUs [4,5]. Another study achieved speed-ups of 13x over the CULA library [6,7] for tall-and-skinny matrices by applying communication-avoiding QR [8]. Updating and downdating algorithms [9] have been implemented in shared- and distributed-memory parallel environments, including parallel out-of-core updating for adding rows[10], block-based downdating [11] and MPI-based parallel downdating [12]. To the best of our knowledge there is no prior work on implementing all four updating algorithms on GPUs.

QR factorization decomposes the 
                        
                           m
                           ×
                           n
                        
                      matrix A into the 
                        
                           m
                           ×
                           m
                        
                      orthogonal matrix Q and the 
                        
                           m
                           ×
                           n
                        
                      upper trapezoidal matrix R. Matrix updates entail the addition or removal of contiguous blocks of p columns or p rows. When a block of columns or rows is added during an update, this block is denoted U. The location of an update within A is given as an offset, k, in columns or rows from the top left corner. The updated matrix is denoted 
                        
                           
                              
                                 A
                              
                              
                                 ̃
                              
                           
                        
                      and has the corresponding updated factorization 
                        
                           
                              
                                 Q
                              
                              
                                 ̃
                              
                           
                           
                              
                                 R
                              
                              
                                 ̃
                              
                           
                        
                     .

Section 2 details the implementation of Givens and Householder transformations on the GPU. Section 3 summarizes the updating algorithms and describes how we implemented them, before Section 4 presents performance results. We show the speed-ups achieved by our implementation over the full QR factorization routine used by CULA. We also investigate the accuracy and stability of the updating algorithms. Section 5 concludes and discusses future work.

Householder and Givens transformations are standard tools for computing the QR factorization [13,14] and they are also key components of the factorization updating algorithms. Householder transformations can be readily implemented on GPUs using CUBLAS [15]. To better exploit the instruction bandwidth of GPUs we use a blocked Householder approach [3,14] built on BLAS level 3 operations that combines 
                        
                           
                              
                                 n
                              
                              
                                 b
                              
                           
                        
                      Householder transformations into a single matrix:
                        
                           
                              P
                              =
                              
                                 
                                    P
                                 
                                 
                                    1
                                 
                              
                              
                                 
                                    P
                                 
                                 
                                    2
                                 
                              
                              …
                              
                                 
                                    P
                                 
                                 
                                    
                                       
                                          n
                                       
                                       
                                          b
                                       
                                    
                                 
                              
                              =
                              I
                              +
                              
                                 
                                    WY
                                 
                                 
                                    T
                                 
                              
                           
                        
                     where W and Y are matrices with the number of rows equal to the length of the longest Householder vector and number of columns equal to the number of transformations.

Efficient GPU parallelization of Givens rotations is more challenging. A Givens rotation alters entries in two rows of the matrix and therefore multiple rotations can only be conducted in parallel if they affect distinct rows. This leads to the following scheme, illustrated in Fig. 1
                     , which has been applied on both distributed and shared memory systems [16]:
                        
                           1.
                           Each processor 
                                 
                                    
                                       
                                          p
                                       
                                       
                                          1
                                       
                                    
                                    ,
                                    …
                                    ,
                                    
                                       
                                          p
                                       
                                       
                                          k
                                       
                                    
                                 
                               is assigned a strip of rows (Stage 1).

Starting at the lower left corner of the matrix, 
                                 
                                    
                                       
                                          p
                                       
                                       
                                          1
                                       
                                    
                                 
                               zeroes the entries in the first column of its strip using Givens rotations (Stage 2).

When 
                                 
                                    
                                       
                                          p
                                       
                                       
                                          1
                                       
                                    
                                 
                               reaches the top of the first column of its strip, 
                                 
                                    
                                       
                                          p
                                       
                                       
                                          2
                                       
                                    
                                 
                               takes over zeroing entries in the first column. In parallel 
                                 
                                    
                                       
                                          p
                                       
                                       
                                          1
                                       
                                    
                                 
                               begins zeroing entries in the second column (Stage 3).

The algorithm continues in this way until the matrix is upper trapezoidal.

We now summarize the QR updating algorithms originally presented in [1] and describe how we implemented them for GPUs.

Adding a block of p columns, denoted U, to A before column k gives:
                           
                              
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   n
                                                   ,
                                                   
                                                   1
                                                   :
                                                   k
                                                   -
                                                   1
                                                   )
                                                
                                                
                                                   U
                                                
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   n
                                                   ,
                                                   
                                                   k
                                                   :
                                                   m
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        Multiplying through by 
                           
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                           
                         yields:
                           
                              
                                 
                                    
                                       Q
                                    
                                    
                                       T
                                    
                                 
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   1
                                                   :
                                                   k
                                                   -
                                                   1
                                                   )
                                                
                                                
                                                   
                                                      
                                                         Q
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   U
                                                
                                                
                                                   R
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   k
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        Since 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                              (
                              1
                              :
                              m
                              ,
                              
                              1
                              :
                              k
                              -
                              1
                              )
                              =
                              R
                              (
                              1
                              :
                              m
                              ,
                              
                              1
                              :
                              k
                              -
                              1
                              )
                           
                         we need only perform a QR factorization of 
                           
                              
                                 
                                    
                                       
                                          
                                             Q
                                          
                                          
                                             T
                                          
                                       
                                       UR
                                       (
                                       1
                                       :
                                       m
                                       ,
                                       
                                       k
                                       :
                                       n
                                       )
                                    
                                 
                              
                           
                         to form the remainder of 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                        . To do this efficiently we use Householder transformations to make 
                           
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                              U
                              (
                              n
                              +
                              1
                              :
                              m
                              ,
                              
                              1
                              :
                              p
                              )
                           
                         upper trapezoidal, and then selectively apply Givens rotations to make 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                         upper trapezoidal. We cannot use Householder transformations for the second stage as they would make 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                         full.

Note that the use of 
                           
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                              U
                           
                         to update R means that 
                           
                              
                                 
                                    Q
                                 
                                 
                                    ̃
                                 
                              
                           
                         must also be formed if further updates are required. This can by accomplished by post-multiplying Q with the same Householder and Givens transformations used to form 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                        .


                        Fig. 2
                         illustrates the algorithm for an example where 
                           
                              m
                              =
                              10
                              ,
                              
                              n
                              =
                              5
                              ,
                              
                              p
                              =
                              3
                           
                         and 
                           
                              k
                              =
                              3
                           
                        . Taking 
                           
                              Q
                              ,
                              R
                           
                        , an 
                           
                              m
                              ×
                              p
                           
                         block of columns U and an index 
                           
                              k
                              ,
                              
                              0
                              ⩽
                              k
                              ⩽
                              n
                              +
                              1
                           
                         as input, the implementation proceeds as follows:
                           
                              1.
                              QR factorize the lower 
                                    
                                       (
                                       m
                                       -
                                       n
                                       )
                                       ×
                                       p
                                    
                                  block of 
                                    
                                       
                                          
                                             Q
                                          
                                          
                                             T
                                          
                                       
                                       U
                                    
                                  using Householder transformations. This is the area shaded in red in Stage 1 of Fig. 2.

If 
                                    
                                       k
                                       =
                                       n
                                       +
                                       1
                                    
                                  then the update is complete.

If not, transpose the section shown in red in Stage 2 of Fig. 2.

Apply Givens rotations to make the transposed section upper triangular and also to update Q and d. These three updates are independent so separate CUDA streams can be used simultaneously for each.

Transpose back the (now reduced) red section in Stage 2 of Fig. 2.

When a block of p columns is deleted from A starting at column k, the modified data matrix becomes:
                           
                              
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   1
                                                   :
                                                   k
                                                   -
                                                   1
                                                   )
                                                
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   k
                                                   +
                                                   p
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        Multiplying through by 
                           
                              
                                 
                                    Q
                                 
                                 
                                    T
                                 
                              
                           
                        :
                           
                              
                                 
                                    
                                       Q
                                    
                                    
                                       T
                                    
                                 
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   1
                                                   :
                                                   k
                                                   -
                                                   1
                                                   )
                                                
                                                
                                                   R
                                                   (
                                                   1
                                                   :
                                                   m
                                                   ,
                                                   
                                                   k
                                                   +
                                                   p
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        Again 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                              (
                              1
                              :
                              m
                              ,
                              
                              1
                              :
                              k
                              -
                              1
                              )
                              =
                              R
                              (
                              1
                              :
                              m
                              ,
                              
                              1
                              :
                              k
                              -
                              1
                              )
                           
                         and we can form 
                           
                              n
                              -
                              (
                              k
                              -
                              1
                              )
                              -
                              p
                           
                         Householder transformations to reduce just the right-hand portion of R:
                           
                              
                                 
                                    
                                       H
                                    
                                    
                                       n
                                       -
                                       p
                                    
                                 
                                 …
                                 
                                    
                                       H
                                    
                                    
                                       k
                                    
                                 
                                 R
                                 (
                                 1
                                 :
                                 m
                                 ,
                                 
                                 k
                                 +
                                 p
                                 :
                                 n
                                 )
                                 =
                                 
                                    
                                       R
                                    
                                    
                                       ̃
                                    
                                 
                                 (
                                 1
                                 :
                                 m
                                 ,
                                 
                                 k
                                 +
                                 p
                                 :
                                 n
                                 )
                                 .
                              
                           
                        This QR factorization of a submatrix of R can be performed efficiently using blocked Householder transformations.


                        Fig. 3
                         shows the stages in the reduction process for an example where 
                           
                              m
                              =
                              10
                              ,
                              
                              n
                              =
                              8
                              ,
                              
                              p
                              =
                              3
                           
                         and 
                           
                              k
                              =
                              3
                           
                        . Unlike adding columns, Q is not required for the update but R, an index 
                           
                              k
                              ,
                              
                              0
                              ⩽
                              k
                              ⩽
                              n
                              -
                              p
                              +
                              1
                           
                        , and a block width 
                           
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         are. The implementation proceeds as follows:
                           
                              1.
                              If the right-most p columns of A were deleted, the update is complete.

Blocked Householder QR factorization is applied to the 
                                    
                                       (
                                       p
                                       +
                                       
                                          
                                             n
                                          
                                          
                                             b
                                          
                                       
                                       +
                                       1
                                       )
                                       ×
                                       
                                          
                                             n
                                          
                                          
                                             b
                                          
                                       
                                    
                                  submatrix to the right of the removed columns (Stage 1). This is repeated across submatrices to the right until R is upper trapezoidal (Stage 2).

When a block of p rows, U, are added to A, the updated data matrix is:
                           
                              
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   (
                                                   k
                                                   -
                                                   1
                                                   )
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                             
                                                
                                                   A
                                                   (
                                                   k
                                                   :
                                                   m
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        We can permute U to the bottom of 
                           
                              
                                 
                                    A
                                 
                                 
                                    ̃
                                 
                              
                           
                        :
                           
                              
                                 P
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        and thus:
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         Q
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   
                                                      
                                                         I
                                                      
                                                      
                                                         p
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 P
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        With n Householder transformations we can eliminate U and form 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                        :
                           
                              
                                 
                                    
                                       H
                                    
                                    
                                       n
                                    
                                 
                                 …
                                 
                                    
                                       H
                                    
                                    
                                       2
                                    
                                 
                                 
                                    
                                       H
                                    
                                    
                                       1
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       R
                                    
                                    
                                       ̃
                                    
                                 
                              
                           
                        and because 
                           
                              A
                              =
                              QR
                           
                        :
                           
                              
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                P
                                             
                                             
                                                T
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            Q
                                                         
                                                         
                                                            0
                                                         
                                                      
                                                      
                                                         
                                                            0
                                                         
                                                         
                                                            
                                                               
                                                                  I
                                                               
                                                               
                                                                  p
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                          
                                             
                                                H
                                             
                                             
                                                1
                                             
                                          
                                          …
                                          
                                             
                                                H
                                             
                                             
                                                n
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       H
                                    
                                    
                                       n
                                    
                                 
                                 …
                                 
                                    
                                       H
                                    
                                    
                                       1
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       Q
                                    
                                    
                                       ̃
                                    
                                 
                                 
                                    
                                       R
                                    
                                    
                                       ̃
                                    
                                 
                                 .
                              
                           
                        
                     

As with the removing columns update we are performing a QR factorization on R to give an upper trapezoidal 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                        . This can be done efficiently with blocked Householder transformations, and we can further reduce the operation count by exploiting the fact that R already has many zero entries. Instead of applying the full W and Y matrices to all of U and R, we instead apply the transformations separately to U and the non-zero part of R using a matrix 
                           
                              V
                              =
                              [
                              
                                 
                                    v
                                 
                                 
                                    1
                                 
                              
                              
                                 
                                    v
                                 
                                 
                                    2
                                 
                              
                              …
                              
                                 
                                    v
                                 
                                 
                                    
                                       
                                          n
                                       
                                       
                                          b
                                       
                                    
                                 
                              
                              ]
                           
                         with Householder vectors as its columns [1] and an upper triangular matrix T. The product of 
                           
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         Householder matrices can be defined as:
                           
                              
                                 
                                    
                                       H
                                    
                                    
                                       1
                                    
                                 
                                 
                                    
                                       H
                                    
                                    
                                       2
                                    
                                 
                                 …
                                 
                                    
                                       H
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             b
                                          
                                       
                                    
                                 
                                 =
                                 I
                                 -
                                 
                                    
                                       VTV
                                    
                                    
                                       T
                                    
                                 
                                 ,
                              
                           
                        with:
                           
                              
                                 V
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         I
                                                      
                                                      
                                                         
                                                            
                                                               n
                                                            
                                                            
                                                               b
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         m
                                                         +
                                                         1
                                                         :
                                                         m
                                                         +
                                                         p
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        and:
                           
                              
                                 
                                    
                                       T
                                    
                                    
                                       1
                                    
                                 
                                 =
                                 
                                    
                                       τ
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 
                                 
                                    
                                       T
                                    
                                    
                                       i
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         i
                                                         -
                                                         1
                                                      
                                                   
                                                
                                                
                                                   -
                                                   
                                                      
                                                         τ
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         i
                                                         -
                                                         1
                                                      
                                                   
                                                   V
                                                   
                                                      
                                                         (
                                                         1
                                                         :
                                                         p
                                                         ,
                                                         1
                                                         :
                                                         i
                                                         -
                                                         1
                                                         )
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   
                                                      
                                                         v
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   
                                                      
                                                         τ
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 ,
                                 
                                 i
                                 =
                                 2
                                 :
                                 
                                    
                                       n
                                    
                                    
                                       b
                                    
                                 
                                 ,
                              
                           
                        where 
                           
                              
                                 
                                    τ
                                 
                                 
                                    i
                                 
                              
                           
                         is the Householder coefficient corresponding to the Householder vector contained in the 
                           
                              i
                           
                        th column of V. As the assignment of individual 
                           
                              
                                 
                                    τ
                                 
                                 
                                    i
                                 
                              
                           
                         elements along the diagonal of T is independent of the calculation of the other elements of T, the entire diagonal can be assigned in parallel within a single kernel before repeated calls of CUBLAS gemv are used to form the rest of T.


                        V and T are applied to the trailing submatrix of 
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                R
                                             
                                          
                                          
                                             
                                                U
                                             
                                          
                                       
                                    
                                 
                              
                           
                         by:
                           
                              
                                 
                                    
                                       
                                          
                                             I
                                             -
                                             
                                                
                                                   VT
                                                
                                                
                                                   T
                                                
                                             
                                             
                                                
                                                   V
                                                
                                                
                                                   T
                                                
                                             
                                          
                                       
                                    
                                    
                                       T
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                
                                             
                                             
                                                
                                                   U
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                I
                                             
                                             
                                                m
                                                +
                                                p
                                                -
                                                
                                                   
                                                      k
                                                   
                                                   
                                                      b
                                                   
                                                
                                             
                                          
                                          -
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  I
                                                               
                                                               
                                                                  
                                                                     
                                                                        n
                                                                     
                                                                     
                                                                        b
                                                                     
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            0
                                                         
                                                      
                                                      
                                                         
                                                            V
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                          
                                             
                                                T
                                             
                                             
                                                T
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               
                                                                  I
                                                               
                                                               
                                                                  
                                                                     
                                                                        n
                                                                     
                                                                     
                                                                        b
                                                                     
                                                                  
                                                               
                                                            
                                                         
                                                         
                                                            0
                                                         
                                                         
                                                            
                                                               
                                                                  V
                                                               
                                                               
                                                                  T
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   R
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   R
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   m
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   U
                                                   (
                                                   1
                                                   :
                                                   p
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   (
                                                   
                                                      
                                                         I
                                                      
                                                      
                                                         
                                                            
                                                               n
                                                            
                                                            
                                                               b
                                                            
                                                         
                                                      
                                                   
                                                   -
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   )
                                                   R
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                   -
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   
                                                      
                                                         V
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   U
                                                   (
                                                   1
                                                   :
                                                   p
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   R
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   m
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   -
                                                   
                                                      
                                                         VT
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   R
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                   +
                                                   (
                                                   I
                                                   -
                                                   
                                                      
                                                         VT
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   
                                                      
                                                         V
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   )
                                                   U
                                                   (
                                                   1
                                                   :
                                                   p
                                                   ,
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        and also used to update the right-hand side of the original problem:
                           
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   d
                                                
                                             
                                             
                                                
                                                   e
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   d
                                                   (
                                                   1
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   )
                                                
                                             
                                             
                                                
                                                   (
                                                   
                                                      
                                                         I
                                                      
                                                      
                                                         
                                                            
                                                               n
                                                            
                                                            
                                                               b
                                                            
                                                         
                                                      
                                                   
                                                   -
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   )
                                                   d
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   )
                                                   -
                                                   
                                                      
                                                         T
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   
                                                      
                                                         V
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   e
                                                
                                             
                                             
                                                
                                                   d
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   m
                                                   )
                                                
                                             
                                             
                                                
                                                   -
                                                   
                                                      
                                                         VT
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   d
                                                   (
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   :
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         n
                                                      
                                                      
                                                         b
                                                      
                                                   
                                                   -
                                                   1
                                                   )
                                                   +
                                                   (
                                                   I
                                                   -
                                                   
                                                      
                                                         VT
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   
                                                      
                                                         V
                                                      
                                                      
                                                         T
                                                      
                                                   
                                                   )
                                                   e
                                                
                                             
                                          
                                       
                                    
                                 
                                 ,
                              
                           
                        where 
                           
                              
                                 
                                    k
                                 
                                 
                                    b
                                 
                              
                           
                         is the column index in the blocked update where the recently reduced block began, and e contains values added to b corresponding to the rows added to A 
                        [1].

We calculate this update using R, an index 
                           
                              k
                              ,
                              
                              0
                              ⩽
                              k
                              ⩽
                              m
                              +
                              1
                           
                        , and a 
                           
                              p
                              ×
                              n
                           
                         block of rows U. Note that the value of k does not affect the algorithm as the added rows can be permuted to the bottom of A. Fig. 4
                         shows an example where 
                           
                              m
                              =
                              8
                              ,
                              
                              n
                              =
                              6
                              ,
                              
                              p
                              =
                              4
                           
                        . We proceed as follows for each 
                           
                              p
                              ×
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         block in U:
                           
                              1.
                              Stage 1 in Fig. 4: use Householder transformations to reduce the block’s entries to zeros and to modify R’s corresponding nonzero entries.

Construct T as described above.

Stage 2 in Fig. 4: update R and b by multiplying with T and V.

Removing a block of p rows from A from row k onwards gives:
                           
                              
                                 
                                    
                                       A
                                    
                                    
                                       ̃
                                    
                                 
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   1
                                                   :
                                                   (
                                                   k
                                                   -
                                                   1
                                                   )
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   A
                                                   (
                                                   (
                                                   k
                                                   +
                                                   p
                                                   )
                                                   :
                                                   m
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                          
                                       
                                    
                                 
                                 .
                              
                           
                        We first permute the deleted rows to the top of A:
                           
                              
                                 PA
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   k
                                                   :
                                                   k
                                                   +
                                                   p
                                                   -
                                                   1
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         A
                                                      
                                                      
                                                         ̃
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 PQR
                              
                           
                        and then construct a series of Givens matrices, G, to introduce zeros to the right of the diagonal in the first p rows of PQ, thus removing the rows of Q that correspond to the rows deleted from A. These transformations are also applied to R, which yields:
                           
                              
                                 PA
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   A
                                                   (
                                                   k
                                                   :
                                                   k
                                                   +
                                                   p
                                                   -
                                                   1
                                                   ,
                                                   1
                                                   :
                                                   n
                                                   )
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         A
                                                      
                                                      
                                                         ̃
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 =
                                 P
                                 (
                                 QG
                                 )
                                 (
                                 
                                    
                                       G
                                    
                                    
                                       T
                                    
                                 
                                 R
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   I
                                                
                                                
                                                   0
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   
                                                      
                                                         Q
                                                      
                                                      
                                                         ̃
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             
                                                
                                                   S
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         R
                                                      
                                                      
                                                         ̃
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        giving 
                           
                              
                                 
                                    A
                                 
                                 
                                    ̃
                                 
                              
                              =
                              
                                 
                                    Q
                                 
                                 
                                    ̃
                                 
                              
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                        . Note that Householder transformations cannot be used because H would be full and constructed so as to eliminate elements of PQ, which would cause 
                           
                              
                                 
                                    R
                                 
                                 
                                    ̃
                                 
                              
                           
                         to be full.

We calculate this update using 
                           
                              Q
                              ,
                              R
                           
                        , an index 
                           
                              k
                              ,
                              
                              0
                              ⩽
                              k
                              ⩽
                              m
                              -
                              p
                              +
                              1
                           
                        , and a block height p. Fig. 5
                         shows an example of the reduction process where 
                           
                              m
                              =
                              12
                              ,
                              
                              n
                              =
                              5
                              ,
                              
                              p
                              =
                              4
                           
                         and 
                           
                              k
                              =
                              5
                           
                        . A strip of rows Z is identified within Q corresponding to the removed rows from 
                           
                              A
                              ,
                              
                              Z
                              ≔
                              Q
                              (
                              k
                              :
                              k
                              +
                              p
                              -
                              1
                              ,
                              
                              1
                              :
                              n
                              )
                           
                        .

The implementation proceeds as follows:
                           
                              1.
                              Assign the variable Z to the strip to be reduced by Givens transformations.

Apply Givens transformations to reduce Q to the form shown in the centre of the top of Fig. 5, with zeros in the first p columns and in Z, and with the identity matrix embedded in the first p columns of Z.

Apply the same Givens transformations to R as well.

Form 
                                    
                                       
                                          
                                             Q
                                          
                                          
                                             ̃
                                          
                                       
                                    
                                  and 
                                    
                                       
                                          
                                             R
                                          
                                          
                                             ̃
                                          
                                       
                                    
                                  from the elements shaded red in Fig. 5.

@&#RESULTS@&#

We evaluate the performance of our updating algorithms on an Nvidia Tesla M2050 (Fermi) GPU attached to a 12-core Intel Xeon E5649 2.53GHz host. All experiments are conducted in IEEE single precision arithmetic with ECC enabled. We start measuring the run-time of our implementations, 
                        
                           
                              
                                 t
                              
                              
                                 update
                              
                           
                        
                     , from when they initiate transfer of Q (for those updating algorithms that require it), R and d from host memory to the GPU. We then execute our updating algorithm and use 
                        
                           
                              
                                 R
                              
                              
                                 ̃
                              
                           
                        
                      and 
                        
                           
                              
                                 d
                              
                              
                                 ̃
                              
                           
                        
                      to solve the least squares problem via the CUBLAS back-substitution routine cublasStrsm. Timing stops when this CUBLAS routine returns. Q and R have been computed by a previous full QR factorization and we do not include the time to do this.

We compare our implementation against the run-time, 
                        
                           
                              
                                 t
                              
                              
                                 full
                              
                           
                        
                     , of QR-based least squares solve from the CULA library (version R14). Note that CULA is closed-source and we do not know the details of its implementation. We time the execution of the culaDeviceSgels routine, including the time taken to transfer 
                        
                           
                              
                                 A
                              
                              
                                 ̃
                              
                           
                        
                      and 
                        
                           
                              
                                 b
                              
                              
                                 ̃
                              
                           
                        
                      from host to GPU. The speed-up is 
                        
                           
                              
                                 
                                    
                                       t
                                    
                                    
                                       full
                                    
                                 
                              
                              
                                 
                                    
                                       t
                                    
                                    
                                       update
                                    
                                 
                              
                           
                        
                     .

The entries of 
                        
                           
                              
                                 A
                              
                              
                                 ̃
                              
                           
                        
                      are uniformly-distributed random numbers in the interval 
                        
                           (
                           -
                           1
                           ,
                           1
                           )
                        
                      and all matrices fit in GPU memory. All run-times are measured in seconds and all values presented are averages over 5 executions.

The optimum value of 
                           
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         in the blocked Householder algorithm is problem-dependent. It was not possible to determine this value for each problem size, and we instead choose 
                           
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         based on the performance of a test case. Table 1
                         shows run-times for each of the three algorithms that feature blocked Householder transformations when applying 1000 Householder vectors to 1000 columns. We observe that the optimum block size lies between 50 and 100 columns per block and so in all further tests we pick an 
                           
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                           
                         that gives ten blocks per factorization.

The speed-ups of the adding columns update relative to CULA full factorization for varying k and two different n values are shown in Figs. 6 and 7
                        
                        . As k gets smaller the cost of updating approaches that of computing a whole new factorization, and consequently only the highest values of k show any speed-up.

The updating algorithm performs better relative to CULA for large k and n (adding columns to the end of a matrix that has a large number of columns) because this reduces the size of the submatrix to which Givens rotations must be applied (the red area in Stage 2 of Fig. 2). As shown in Table 2
                        , when k is much smaller than n (corresponding to adding columns near the beginning of the matrix), the run-time of the updating algorithm is dominated by the time required to execute the 
                           
                              O
                              (
                              n
                              -
                              k
                              )
                           
                         Givens rotations kernels.


                        Fig. 8
                         shows that the updating algorithm only runs faster than full factorization for smaller values of p (adding fewer columns). This is because the number of Givens rotations in Stage 2 increases with p and must also be applied to Q as well as R in order to enable subsequent updates.

The cost of the removing columns updating algorithm is independent of m because we only apply Householder transformations to a 
                           
                              (
                              p
                              +
                              
                                 
                                    n
                                 
                                 
                                    b
                                 
                              
                              +
                              1
                              )
                              ×
                              (
                              n
                              -
                              (
                              k
                              -
                              1
                              )
                              -
                              p
                              )
                           
                         submatrix of R. This is not the case for full factorization, and as shown in Fig. 9
                         the speed-up of updating over CULA accordingly increases as m increases.

Removing more columns (larger values of p) decreases the number of Householder transformations required to update the factorization as well as decreasing the amount of work required for a full QR factorization. As reducing the number of Householder transformations reduces the number of kernel invocations on the GPU, our updating implementation performs better as p increases. We consequently observe speed-ups over CULA shown in Fig. 10
                         that reach over 13x for large p and k.

We set 
                           
                              k
                              =
                              0
                           
                         for all tests in this section because the block of added rows can be permuted to the bottom of the matrix without altering the algorithm.The cost of the updating algorithm does not depend on m because the Householder transformations are not applied to the zero elements of R. The run-time of the updating algorithm therefore remains essentially constant with increasing m while the run-time of the full QR factorization increases, giving rise to the speed-ups shown in Fig. 11
                        .

As shown in Fig. 12
                        , however, the speed-up decreases as n and p increase. We might expect that the updating algorithm would never run slower than full QR factorization because it essentially performs a full QR reduction that skips over the zeros in R. To do this, however, requires twice as many CUBLAS calls as an efficient full QR factorization and so is only worthwhile for low values of n and p. Given the processing power of GPUs, it might be beneficial to do the unnecessary arithmetic and avoid the expense of additional function calls.

This is the most computationally demanding update because it applies multiple Givens rotation kernels to both Q and R. Figs. 13 and 14
                        
                         illustrate the speed-up of removing rows updating over full QR factorization with varying 
                           
                              m
                              ,
                              n
                           
                         and p. Updating becomes progressively slower than full QR factorization as 
                           
                              m
                              ,
                              n
                           
                         and p increase because of the 
                           
                              O
                              (
                              m
                              +
                              p
                              )
                           
                         kernel invocations required to implement the Givens rotations. Updating is only faster than full factorization when p is small and m approaches n (see Fig. 13).

We compute the normwise relative error 
                           
                              
                                 
                                    |
                                    |
                                    x
                                    -
                                    
                                       
                                          x
                                       
                                       
                                          ˆ
                                       
                                    
                                    |
                                    
                                       
                                          |
                                       
                                       
                                          2
                                       
                                    
                                 
                                 
                                    |
                                    |
                                    x
                                    |
                                    
                                       
                                          |
                                       
                                       
                                          2
                                       
                                    
                                 
                              
                           
                         of the least squares solution from an updated factorization, 
                           
                              
                                 
                                    x
                                 
                                 
                                    ˆ
                                 
                              
                           
                        , against that of a solution from a full factorization calculated by CULA, x. We compare both GPU-based updating and a serial implementation of the updating algorithms. Table 3
                         shows that the errors are comparable between the GPU and CPU updated factorizations.

For the two updating algorithms that form 
                           
                              
                                 
                                    Q
                                 
                                 
                                    ̃
                                 
                              
                           
                         (removing rows and adding columns) we assess the orthogonality of 
                           
                              
                                 
                                    Q
                                 
                                 
                                    ̃
                                 
                              
                           
                         by computing 
                           
                              |
                              |
                              
                                 
                                    
                                       
                                          Q
                                       
                                       
                                          ̃
                                       
                                    
                                 
                                 
                                    T
                                 
                              
                              
                                 
                                    Q
                                 
                                 
                                    ̃
                                 
                              
                              -
                              I
                              |
                              
                                 
                                    |
                                 
                                 
                                    2
                                 
                              
                           
                        . Table 4
                         shows that the errors from the GPU computations are again of the same order as those from the serial implementation. We also compute the normwise relative backward error 
                           
                              
                                 
                                    |
                                    |
                                    
                                       
                                          Q
                                       
                                       
                                          ̃
                                       
                                    
                                    
                                       
                                          R
                                       
                                       
                                          ̃
                                       
                                    
                                    -
                                    
                                       
                                          A
                                       
                                       
                                          ̃
                                       
                                    
                                    |
                                    
                                       
                                          |
                                       
                                       
                                          2
                                       
                                    
                                 
                                 
                                    |
                                    |
                                    A
                                    |
                                    
                                       
                                          |
                                       
                                       
                                          2
                                       
                                    
                                 
                              
                           
                         for these two algorithms, and the results are given in Table 5
                        . The errors are again comparable between serial and GPU implementations.

@&#CONCLUSION@&#

We have implemented four GPU updating algorithms using CUDA and have shown that they outperform full GPU QR factorization for certain values of 
                        
                           m
                           ,
                           n
                           ,
                           p
                        
                      and k. We observed the best performance when removing large numbers of columns for large values of k (corresponding to removing columns from the right-hand portion of A), with speed-ups of up to 13.5× over full factorization. Adding smaller numbers of columns for large values of k, with speed-ups of up to 3.5x, and adding rows to a tall-and-skinny A, which gave speed-ups approaching 2x, also performed well. Removing rows, which required the application of Givens rotations to both Q and R, performed worse than CULA for all cases except for removing a small number of rows from an almost-square A.

Many of the encountered performance issues were linked to high frequencies of kernel invocations. We could reduce the number of kernels needed to apply Givens rotations by increasing the number of rows in a strip and applying multiple dependent rotations per thread block by looping and synchronization statements within the kernel. Alternatively, we could reduce kernel invocation overheads by using the Nvidia Kepler architecture’s dynamic parallelism [18] to spawn kernels directly on the GPU.

Another approach would be to use Householder transformations instead of Givens rotations where possible. For example, in the adding columns update Householder transformations could be used even though they generate intermediate fill-in because the resulting extra floating point operations are likely to be cheaper on the GPU than invoking multiple kernels.

We have identified some situations in which updating is faster than full factorization, and others where it is not. Ideally, we would like to be able to identify in advance whether or not updating will save time by considering the size of the problem, the type of update and the number of rows/columns to be added/removed. The original presentation of the algorithms includes operation counts in terms of 
                        
                           m
                           ,
                           n
                           ,
                           p
                        
                      and k that we could use as the basis for closed-form expressions to approximate the run-times of our GPU implementations.

Finally, it would be instructive to compare our implementations with the QR routines from other GPU linear algebra libraries such as MAGMA [19].

@&#ACKNOWLEDGMENTS@&#

The authors would like to thank IT Services for Research (formerly Research Computing Services) at the University of Manchester for providing access to the GPU nodes on the Computational Shared Facility (CSF). The authors would also like to thank the anonymous referees for their extremely helpful comments. The second author was supported by EPSRC Grant EP/I006702/1 “Novel Asynchronous Algorithms and Software for Large Sparse Systems”.

@&#REFERENCES@&#

