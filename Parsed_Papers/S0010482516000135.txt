@&#MAIN-TITLE@&#Locally adaptive 2D–3D registration using vascular structure model for liver catheterization

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           A registration algorithm between 2D DSA image and 3D CTA scans is proposed.


                        
                        
                           
                           A vascular structure model is constructed using the augmented fast marching method.


                        
                        
                           
                           The tree model is divided into subtrees based on the connectivity and the length.


                        
                        
                           
                           Our method performs the registration focusing on the selected subtree.


                        
                        
                           
                           Our method performs the registration very accurately.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

2D–3D Registration

Vascular structure model

Subtree

Skeletonization

Catheterization

@&#ABSTRACT@&#


               
               
                  Two-dimensional–three-dimensional (2D–3D) registration between intra-operative 2D digital subtraction angiography (DSA) and pre-operative 3D computed tomography angiography (CTA) can be used for roadmapping purposes. However, through the projection of 3D vessels, incorrect intersections and overlaps between vessels are produced because of the complex vascular structure, which makes it difficult to obtain the correct solution of 2D–3D registration. To overcome these problems, we propose a registration method that selects a suitable part of a 3D vascular structure for a given DSA image and finds the optimized solution to the partial 3D structure. The proposed algorithm can reduce the registration errors because it restricts the range of the 3D vascular structure for the registration by using only the relevant 3D vessels with the given DSA. To search for the appropriate 3D partial structure, we first construct a tree model of the 3D vascular structure and divide it into several subtrees in accordance with the connectivity. Then, the best matched subtree with the given DSA image is selected using the results from the coarse registration between each subtree and the vessels in the DSA image. Finally, a fine registration is conducted to minimize the difference between the selected subtree and the vessels of the DSA image. In experimental results obtained using 10 clinical datasets, the average distance errors in the case of the proposed method were 2.34±1.94mm. The proposed algorithm converges faster and produces more correct results than the conventional method in evaluations on patient datasets.
               
            

@&#INTRODUCTION@&#

Pre-operative three-dimensional (3D) computed tomography (CT) angiographic images can aid in planning intravascular interventions and guiding catheter-directed procedures. Since intra-operative two-dimensional (2D) angiography images scan the limited areas near the catheter, it is difficult to figure out the overall structure of the vasculature and the location of the catheter. Moreover, geometric information is lost through projection, which makes it difficult to recognize the connectivity between vessels. Pre-operative computed tomography angiography (CTA) data can compensate for these limitations of 2D angiography because they provide the overall 3D vascular structure. Hence, it can be used for planning the path for the catheter to be moved before the intervention, and for making a roadmap that shows the currently traversed vessels and the distal vessel tree.

To utilize the 3D CTA data effectively, an accurate registration between 2D digital subtraction angiography (DSA) and 3D CTA images is needed. Therefore, many approaches have been proposed for 2D–3D registration in abdominal [1–4], cardiac [5–9], and neurological [10–12] interventions, and Markelj et al. [13] has provided a review of the existing 2D–3D registration methods.

Many algorithms follow the strategy of minimizing the difference between the vessels of a 2D image and the projection of 3D vessels. Groher et al. [1] optimizes the transformation parameters by using the difference between centerlines and the projection of 3D vessels. Further, they use topological information such as the degree of bifurcation points in order to enhance the accuracy of the registration algorithm. However, accurate 2D–3D branching point matching might be difficult when enhanced 2D vessel regions are considerably smaller than the whole 3D vessel regions. Further, this method detects the branching points of the thickest 2D and 3D vessels as root nodes and finds the x–y translation in the initialization step. The correspondence of the root nodes of the 2D and 3D vessels might be incorrectly generated and accordingly degrade the registration accuracy when the enhanced range of 2D vessels is different from that of 3D vessels. Jomier et al. [3] proposed the sum of the Gaussian-blurred intensity values in the 2D image at the projected model points as a registration metric. This method improves the registration accuracy by using bi-plane images. In clinical practice, bi-plane images are not acquired for all clinical applications. Rivest-Hénault et al. [6] proposed a non-rigid registration algorithm with a distance measure and regularization constraints that maintain the smoothness and a certain degree of rigidity of the vessels. Although these algorithms show a high accuracy and a robust convergence, they assume that the contrasted vessels in DSA have a similar range to that of the 3D vessels from CTA scans. However, in the liver catheterization, a contrast medium is injected, and only the limited areas near the catheter are displayed in the angiography images while the catheter is moved through the vascular structure. Ambrosini et al. [24] overcame this problem by selecting an appropriate leaf vessel centerline from the 3D vascular structure according to the shape similarity with the catheter centerline. This method selects the appropriate vessel centerline in most cases and shows a high accuracy in the registration results. However, it fails to find a correct solution when a small part of the catheter is visible on the image or the shape of the catheter does not have a predominant feature.

In this paper, we propose a method that finds a currently traversed area in a 3D vascular structure for a given DSA image and registers the 3D vessels to the 2D vessels on the DSA by using the subtree structure of the 3D vessels. We improve the accuracy of the registration by dividing a 3D vascular tree model into several subtrees and using only one of the subtrees in the registration process. The 3D vascular structure is very complex, and therefore, the projection of the entire structure causes a considerable number of overlapped vessels and incorrect intersection points. This leads to a false local minima in the registration process, particularly when a DSA image shows only a part of the vascular structure. We overcome these problems by dividing the 3D structure into several subtrees and using only the relevant part of the given DSA image. To search for the appropriate part of the DSA image, we first construct a tree model of the 3D vascular structure considering their connectivity and divide it into several subtrees. Subsequently, the best matched subtree for the given DSA image is selected according to the dissimilarity measure from the coarse registration between each subtree and the DSA image. Finally, fine registration is conducted for the selected subtree by using a distance metric. Then, by restricting the range for the registration process, we obtain better convergence and higher accuracy than the registration using all the 3D vessels.

The remainder of this paper is organized as follows: the next section describes a method of constructing the 3D vascular structure model. Section 3 explains the locally adaptive registration algorithm using the 3D model. Section 4 discusses the experimental results and is followed by Section 5 that presents the conclusion and future work.

The proposed method consists of four main steps, as shown in 
                     Fig. 1. First, we analyze the pre-operative 3D CTA and the intra-operative 2D DSA. From the 3D CTA, a 3D vascular structural model is constructed and divided into several subtrees. During intervention, a 2D vessel centerline and its distance transform are computed from the 2D DSA. Next, the best matched subtree for a 2D vessel centerline is selected by comparing the dissimilarity among the subtrees. Finally, fine registration is conducted for the selected subtree. The fine registration follows the strategy of minimizing the difference between the vessels of a 2D image and the projection of 3D vessels as described in [5]. However, the vessels used for the fine registration is restricted to the subtree which is selected in the third step. It leads to the high accuracy of the fine registration results.

In this section, we describe the construction and separation process for the 3D vascular model. Since a CTA scan is pre-operative data, the process can be conducted before the interventions. The registration process during an intervention will be explained in the next section.

We construct a tree model that represents the connectivity of vessels from the pre-operative CTA scans. The vessels are segmented from CTA scans by using a 3D connected component analysis method based on the vesselness measure. Subsequently, the skeletons are computed from the segmented vessels and converted into a tree model.

To segment vessels from CTA, the vesselness filter [14] is calculated for each voxel. The vesselness measure is frequently used in searching for a tubular shape such as that of vessels. It is obtained with eigenvalues of the Hessian matrix. If 
                           
                              
                                 λ
                              
                              
                                 k
                              
                           
                         denotes the eigenvalue with the 
                           
                              k
                           
                        -th smallest magnitude (
                           
                              |
                              
                                 
                                    
                                       λ
                                    
                                    
                                       1
                                    
                                 
                              
                              |
                           
                           
                              ≤
                           
                           
                              |
                              
                                 
                                    
                                       λ
                                    
                                    
                                       2
                                    
                                 
                              
                              |
                           
                           
                              ≤
                           
                           
                              |
                              
                                 
                                    
                                       λ
                                    
                                    
                                       3
                                    
                                 
                              
                              |
                           
                        ), the vesselness filter for scale 
                           
                              s
                           
                         can be defined as follows:
                           
                              (1)
                              
                                 
                                    
                                       V
                                    
                                    
                                       (
                                       
                                          s
                                       
                                       )
                                    
                                    
                                       =
                                    
                                    
                                       {
                                       
                                          
                                             
                                                
                                                   
                                                      0
                                                      ,
                                                      
                                                   
                                                   
                                                      if
                                                   
                                                   
                                                      
                                                         λ
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                   
                                                      >
                                                      0
                                                   
                                                   
                                                      or
                                                   
                                                   
                                                      
                                                         
                                                            λ
                                                         
                                                      
                                                      
                                                         3
                                                      
                                                   
                                                   
                                                      >
                                                      0
                                                      ,
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            1
                                                            −
                                                         
                                                         
                                                            exp
                                                         
                                                         
                                                            (
                                                            
                                                               
                                                                  −
                                                               
                                                               
                                                                  
                                                                     
                                                                        
                                                                           
                                                                              
                                                                                 R
                                                                              
                                                                              
                                                                                 A
                                                                              
                                                                           
                                                                        
                                                                        
                                                                           2
                                                                        
                                                                     
                                                                  
                                                                  
                                                                     
                                                                        2
                                                                     
                                                                     
                                                                        
                                                                           α
                                                                        
                                                                        
                                                                           2
                                                                        
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                      
                                                      )
                                                   
                                                   
                                                      exp
                                                   
                                                   
                                                      (
                                                      
                                                         
                                                            −
                                                         
                                                         
                                                            
                                                               
                                                                  
                                                                     
                                                                        
                                                                           R
                                                                        
                                                                        
                                                                           B
                                                                        
                                                                     
                                                                  
                                                                  
                                                                     2
                                                                  
                                                               
                                                            
                                                            
                                                               
                                                                  2
                                                               
                                                               
                                                                  
                                                                     β
                                                                  
                                                                  
                                                                     2
                                                                  
                                                               
                                                            
                                                         
                                                      
                                                      )
                                                   
                                                   
                                                      (
                                                      
                                                         
                                                            1
                                                            −
                                                         
                                                         
                                                            exp
                                                         
                                                         
                                                            (
                                                            
                                                               
                                                                  −
                                                               
                                                               
                                                                  
                                                                     
                                                                        
                                                                           S
                                                                        
                                                                        
                                                                           2
                                                                        
                                                                     
                                                                  
                                                                  
                                                                     
                                                                        2
                                                                     
                                                                     
                                                                        
                                                                           c
                                                                        
                                                                        
                                                                           2
                                                                        
                                                                     
                                                                  
                                                               
                                                            
                                                            )
                                                         
                                                      
                                                      )
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       ,
                                       otherwise
                                    
                                 
                              
                           
                        where 
                           
                              
                                 
                                    R
                                 
                                 
                                    A
                                 
                              
                              
                                 =
                              
                              
                                 
                                    
                                       |
                                    
                                    
                                       
                                          λ
                                       
                                       
                                          2
                                       
                                    
                                    
                                       |
                                    
                                 
                                 
                                    
                                       |
                                    
                                    
                                       
                                          λ
                                       
                                       
                                          3
                                       
                                    
                                    
                                       |
                                    
                                 
                              
                           
                        , 
                           
                              
                                 
                                    R
                                 
                                 
                                    B
                                 
                              
                              
                                 =
                              
                              
                                 
                                    
                                       |
                                    
                                    
                                       
                                          λ
                                       
                                       
                                          1
                                       
                                    
                                    
                                       |
                                    
                                 
                                 
                                    
                                       
                                          
                                             |
                                          
                                          
                                             
                                                λ
                                             
                                             
                                                2
                                             
                                          
                                          
                                             
                                                λ
                                             
                                             
                                                3
                                             
                                          
                                          
                                             |
                                          
                                       
                                    
                                 
                              
                           
                         and 
                           
                              S
                              =
                           
                           
                              
                                 
                                    ∑
                                    
                                       j
                                       ≤
                                       3
                                    
                                 
                                 
                                    
                                       
                                          λ
                                       
                                       
                                          j
                                       
                                       
                                          2
                                       
                                    
                                 
                              
                           
                        . Further, 
                           
                              α
                           
                        , 
                           
                              β
                           
                        , and 
                           
                              c
                           
                         denote the thresholds to control the sensitivity of the filter to the measures 
                           
                              
                                 R
                              
                              
                                 A
                              
                           
                        , 
                           
                              
                                 R
                              
                              
                                 B
                              
                           
                        , and 
                           
                              S
                           
                        , respectively. The vesselness measure is calculated at different scales, and the final estimate of vesselness is obtained as follows:
                           
                              (2)
                              
                                 
                                    V
                                 
                                 
                                    (
                                    
                                       x
                                    
                                    )
                                 
                                 
                                    =
                                 
                                 
                                    
                                       max
                                    
                                    
                                       
                                          
                                             s
                                          
                                          
                                             min
                                          
                                       
                                       
                                          ≤
                                       
                                       
                                          s
                                       
                                       
                                          ≤
                                       
                                       
                                          
                                             s
                                          
                                          
                                             max
                                          
                                       
                                    
                                 
                                 
                                    
                                       V
                                    
                                    
                                       (
                                    
                                    
                                       s
                                    
                                    
                                       ,
                                    
                                    
                                       x
                                    
                                    
                                       )
                                    
                                 
                              
                           
                        
                     

After computing the vesselness measure for each voxel in the CTA scan, we binarize the volume data using a threshold for the vesselness measure. Then, we perform a 3D connected component analysis and detect the largest connected component as a 3D vessel. The threshold for the vesselness measure is set to 0.05.

The skeleton is extracted from the segmented vessels by an automatic skeletonization algorithm based on fast marching method [15]. Although there are many algorithms for computing the skeletons [16–18], we apply the method proposed in [15] because it is suitable for constructing a graph model. The skeleton computed by this method consists of several branches, each of which can be defined as a node of a graph where a branch is a set of connected voxels on the skeleton. Further, the connectivity between branches is decided during the skeletonization, and therefore, it is easy to construct the tree model hierarchically.

The main steps of the skeletonization algorithm are as follows: the point with the largest distance from the object׳s boundary is computed using the Euclidean distance field, which is used as an input for the fast marching propagation. The geodesic distance inside the object starting at the maximum point is computed using augmented fast marching propagation. A fast marching level-set curve is the solution of the following Eikonal equation:
                           
                              (3)
                              
                                 
                                    
                                       |
                                       
                                          
                                             ∇
                                          
                                          
                                             T
                                          
                                       
                                       |
                                    
                                    
                                       F
                                       =
                                       1
                                       ,
                                       
                                          T
                                       
                                       =
                                       0
                                    
                                    
                                    
                                       on
                                    
                                    
                                    
                                       
                                          Γ
                                       
                                       ,
                                    
                                 
                              
                           
                        where 
                           
                              T
                           
                         denotes the arrival time function, 
                           
                              F
                           
                         represents the speed of the evolution function, and 
                           
                              Γ
                           
                         stands for the initial isosurface at time zero. If 
                           
                              d
                           
                         denotes the distance value of the Euclidean distance field and 
                           
                              D
                           
                         represents the maximum value of the field dataset, then the speed is given by
                           
                              (4)
                              
                                 
                                    speed
                                 
                                 
                                    =
                                 
                                 
                                    
                                       (
                                       
                                          
                                             
                                                d
                                             
                                             
                                                D
                                             
                                          
                                       
                                       )
                                    
                                    
                                       2
                                    
                                 
                                 
                                    .
                                 
                              
                           
                        
                     

Using the speed image, the augmented fast marching algorithm computes the geodesic distance from the start point to each voxel. Then, the furthest point from the global maximum distance point is used as the start point of the branches, and the remaining points of the branch are determined by performing a gradient descent back-tracking procedure satisfying the following equation on the fast marching time-crossing map:
                           
                              (5)
                              
                                 
                                    
                                       
                                          
                                             d
                                          
                                          
                                             C
                                          
                                       
                                       
                                          
                                             dt
                                          
                                       
                                    
                                    
                                       =
                                       −
                                    
                                    
                                       
                                          
                                             ∇
                                          
                                          
                                             T
                                          
                                       
                                       
                                          
                                             |
                                             
                                                
                                                   ∇
                                                
                                                
                                                   T
                                                
                                             
                                             |
                                          
                                       
                                    
                                    
                                       ,
                                    
                                    
                                       C
                                    
                                    
                                       (
                                       
                                          0
                                       
                                       )
                                    
                                    
                                       =
                                    
                                    
                                       
                                          p
                                       
                                       
                                          f
                                       
                                    
                                    
                                       ,
                                    
                                 
                              
                           
                        where 
                           
                              C
                           
                           
                              (
                              
                                 t
                              
                              )
                           
                         denotes the centerline and 
                           
                              
                                 p
                              
                              
                                 f
                              
                           
                         represents the furthest geodesic distance point. This process is repeated for each branch of the skeleton.

The constructed skeleton is represented as a graph 
                           
                              G
                              =
                              (
                              V
                              ,
                              E
                              )
                           
                         in 
                        Fig. 2. Each branch 
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                         (a white node in Fig. 2) becomes a node of 
                           
                              G
                           
                        , and then, 
                           
                              V
                           
                         is defined as 
                           
                              ρ
                           
                           
                              ∪
                              {
                           
                           
                              
                                 B
                              
                              
                                 1
                              
                           
                           
                              ,
                           
                           
                              
                                 B
                              
                              
                                 2
                              
                           
                           
                              ,
                           
                           
                              …
                              ,
                           
                           
                              
                                 B
                              
                              
                                 n
                              
                           
                           
                              }
                           
                        , where 
                           
                              n
                           
                         denotes the number of branches and 
                           
                              ρ
                           
                         represents an empty node for the root of G (a black node in Fig. 2). 
                           
                              E
                           
                         denotes a set of edges, which are contact points between branches. The skeletonization procedure finds the shortest path from the point with the furthest geodesic distance to the previously constructed branches, and the path becomes a new branch 
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                        . Therefore, the contact point between 
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                         and one of the previously constructed branches, 
                           
                              
                                 B
                              
                              
                                 j
                              
                           
                        , is detected without additional computation. 
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                         becomes a child node of 
                           
                              
                                 B
                              
                              
                                 j
                              
                           
                        , and the contact point between 
                           
                              
                                 B
                              
                              
                                 i
                              
                           
                         and 
                           
                              
                                 B
                              
                              
                                 j
                              
                           
                         becomes an edge connecting two nodes. Thus, the graph 
                           
                              G
                           
                         is constructed simultaneously while extracting skeletons.

After the tree construction, we divide the tree model into several subtrees on the basis of the following rules:
                           
                              •
                              A subtree is connected.


                                 
                                    
                                       
                                          
                                             ⋃
                                          
                                          
                                             i
                                          
                                          
                                             m
                                          
                                       
                                       
                                          
                                             S
                                          
                                          
                                             
                                                T
                                             
                                             
                                                i
                                             
                                          
                                          
                                             =
                                             G
                                          
                                       
                                       
                                          ,
                                       
                                       
                                          where
                                       
                                       
                                          
                                             
                                             m
                                          
                                       
                                       
                                          
                                          denotes
                                          
                                          the
                                          
                                          number
                                          
                                          of
                                          
                                          subtrees
                                          
                                          and
                                       
                                       
                                          
                                          S
                                       
                                       
                                          
                                             T
                                          
                                          
                                             i
                                          
                                       
                                       
                                          
                                          represents
                                          
                                          a
                                          
                                          subtree.
                                       
                                    
                                 
                              


                                 
                                    
                                       
                                          S
                                       
                                       
                                          
                                             T
                                          
                                          
                                             i
                                          
                                       
                                       
                                          ∩
                                          S
                                       
                                       
                                          
                                             T
                                          
                                          
                                             j
                                          
                                       
                                       
                                          =
                                          ∅
                                       
                                       
                                          
                                          or
                                       
                                       
                                          
                                             
                                             e
                                          
                                          
                                             k
                                          
                                       
                                       
                                          , where
                                       
                                       
                                          
                                             
                                             e
                                          
                                          
                                             k
                                          
                                       
                                       
                                          ∈
                                          E
                                       
                                    
                                 .

The trees are divided according to the length of vessels and the connectivity. Hence, a weight for each node is computed on the basis of the length before the subtree separation. The weight of a node is defined as the number of skeleton voxels in the node and its descendants. The weight for a node is initialized as the number of voxels included in the node. Next, the weight is updated by adding the weight of a child node to the weight of its parent node while going up from each leaf node to the root node 
                           
                              ρ
                           
                        . Through this process, the weight of a node 
                           
                              N
                           
                         is updated as the number of voxels of a subtree whose root node is 
                           
                              N
                           
                        , and the weight of the root node 
                           
                              ρ
                           
                         becomes the number of all voxels on the skeleton. After updating the weights of all nodes in G, the nodes are sorted in the descending order of the weights. The pseudocode for a tree update is given in Algorithm 1 of Appendix.

To divide a tree into subtrees, all nodes of G are initially set as 
                           
                              
                                 ST
                              
                              
                                 0
                              
                           
                        , and the child nodes of the root node 
                           
                              ρ
                           
                         are inserted into a priority queue. Subsequently, the node with the largest weight in the priority queue is selected as the root node of a new subtree. Then, all descendants of the selected node are updated as 
                           
                              
                                 ST
                              
                              
                                 1
                              
                           
                        , and the child nodes of the selected node are inserted into the priority queue. This process is repeated while the number of subtrees is smaller than a given number, which is set to 6 in our implementation. The parameter study about the number of subtrees is explained in Section 4.4. The pseudocode of this separation step is given in Algorithm 2 of Appendix.


                        
                        Fig. 3 shows the 3D vessels and their skeleton, which is separated by the proposed method. In Fig. 3(b), each color represents a subtree. The tree is divided exactly on a junction point, and each subtree is connected. Then, one of the subtrees can have a similar range with the given DSA image since the injection medium is inserted near the junction point and flows into the closely connected vessels. 
                        Fig. 4 shows that the DSA image and the projection of the subtree can display a similar range.

To use 3D CTA data as a roadmap during an intervention procedure, an accurate registration between the CTA and the DSA images is necessary. During an intervention, a catheter moves through an artery and contrast medium is injected near the catheter. Then, the injected area is projected to produce new DSA images. Through this process, very limited areas of the vascular structure are displayed in the DSA. Therefore, it is difficult to match the DSA with the entire 3D vessel structure. In this study, we overcome this problem by comparing the DSA with the 3D subtrees constructed as discussed in the previous section, not with the entire structure. By running the registration process with only a part of the structure, we can find the correct transformation parameters for the given DSA image.

The method consists of two steps. First, we find the best matched subtree with vessel centerlines that are extracted from the DSA (Section 3.1). Next, a rigid registration between the 2D centerlines and the selected subtree is conducted (Section 3.2).

To find the best matched subtree with DSA, the centerlines are extracted from DSA, and the dissimilarity between the centerlines and each subtree is computed. The subtree with the smallest dissimilarity is selected as the matched subtree with the current DSA.

The centerlines of the 2D DSA are extracted in a way similar to that used for the 3D skeleton. The 2D vesselness measure is calculated for each pixel, and we binarize the image data with a threshold for the vesselness measure. Then, we perform a 2D connected component analysis and detect the largest connected component as a 2D vessel. The threshold for the 2D vesselness measure is set to 0.7. Further, the centerline is extracted by the augmented fast marching method. 
                        Fig. 5 shows an example of the centerline extraction process.

The dissimilarity is defined as the difference between a projected subtree and the 2D centerlines. To be accurate, the dissimilarity of 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                         is the mean of the distance differences between points on the projected subtree and the corresponding points on the 2D centerlines. In Section 2, 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                         is defined as a set of branches labeled k, and each branch consists of voxels on a part of the 3D skeleton. Hence, 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                         can be re-defined as a set of voxels on the skeleton with the label k. Thus, we can define the dissimilarity of 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                         as follows:
                           
                              (6)
                              
                                 
                                    f
                                 
                                 
                                    (
                                    
                                       k
                                    
                                    )
                                 
                                 
                                    =
                                 
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             k
                                          
                                       
                                    
                                 
                                 
                                    ∑
                                    
                                       
                                          
                                             x
                                          
                                          
                                             i
                                          
                                       
                                       
                                          ∈
                                       
                                       
                                          
                                             ST
                                          
                                          
                                             k
                                          
                                       
                                    
                                 
                                 
                                    
                                       ‖
                                       
                                          
                                             Φ
                                          
                                          
                                             (
                                             
                                                
                                                   T
                                                
                                                
                                                   
                                                      x
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                             )
                                          
                                          
                                             −
                                          
                                          
                                             
                                                y
                                             
                                             
                                                i
                                             
                                          
                                       
                                       ‖
                                    
                                    
                                       ,
                                    
                                 
                              
                           
                        where 
                           
                              
                                 n
                              
                              
                                 k
                              
                           
                         denotes the size of 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                        , Φ represents a projection function, T indicates a 
                           
                              4
                              ×
                              4
                           
                         transformation matrix, and 
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                         denotes the closest point on the 2D centerlines to 
                           
                              Φ
                           
                           
                              (
                              
                                 
                                    T
                                 
                                 
                                    
                                       x
                                    
                                    
                                       i
                                    
                                 
                              
                              )
                           
                        . The dissimilarity is used as the cost function for a coarse registration between the 2D centerlines and a subtree. By the coarse registration, the dissimilarity of each subtree is minimized, and then, the subtree with the smallest dissimilarity is selected as the best matched subtree.

The registration in the selection step is only concerned with the translation transformations for the fast computation, and a rigid registration is conducted in the subsequent step. Therefore, when a parameter set for 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                         to be optimized is given as 
                           
                              
                                 
                                    P
                                 
                                 
                                    
                                       T
                                       ,
                                    
                                    
                                       k
                                    
                                 
                              
                              
                                 =
                              
                              
                                 [
                                 
                                    
                                       
                                          t
                                       
                                       
                                          x
                                       
                                    
                                    
                                       ,
                                    
                                    
                                       
                                          t
                                       
                                       
                                          y
                                       
                                    
                                    
                                       ,
                                    
                                    
                                       
                                          t
                                       
                                       
                                          z
                                       
                                    
                                 
                                 ]
                              
                              
                                 ∈
                              
                              
                                 
                                    R
                                 
                                 
                                    3
                                 
                              
                           
                        , 
                           
                              T
                           
                         in Eq. (6) is defined as 
                           
                              T
                              =
                           
                           
                              [
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      1
                                                   
                                                
                                                
                                                   
                                                      0
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      1
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      
                                                         t
                                                      
                                                      
                                                         x
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      
                                                         t
                                                      
                                                      
                                                         y
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      0
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      0
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             
                                                
                                                   
                                                      1
                                                   
                                                
                                                
                                                   
                                                      
                                                         t
                                                      
                                                      
                                                         z
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      0
                                                   
                                                
                                                
                                                   
                                                      1
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                              ]
                           
                        .

The function 
                           
                              Φ
                           
                           
                              :
                           
                           
                              
                                 R
                              
                              
                                 3
                              
                           
                           
                              →
                           
                           
                              
                                 R
                              
                              
                                 2
                              
                           
                         projects a 3D point onto a detector plane and is determined by using the information in the DICOM header [24]. Then, we draw a ray from a source to each voxel 
                           
                              
                                 
                                    x
                                 
                                 
                                    i
                                 
                              
                              
                                 ∈
                              
                              
                                 
                                    ST
                                 
                                 
                                    k
                                 
                              
                           
                         and directly compute a location to be projected on the 2D plane [20]. It is considerably more efficient to project the skeleton directly than to use a ray-casting algorithm [19] because the skeleton is only a small portion of the entire 3D volume.

We need to find the closest point of the 2D centerlines for each projected point in order to calculate Eq. (6) whenever the transformation of a subtree is changed. This can be considerably faster by using a distance transform [22]. We compute a distance transform for the 2D centerlines by using the algorithm in [21], and the computation is requested only once because the 2D centerline is reference data and therefore, not changed. The distance transform for the 2D centerlines is denoted as 
                           
                              
                                 DT
                              
                              
                                 cls
                              
                           
                        . Then, Eq. (6) is defined as follows:
                           
                              (7)
                              
                                 
                                    f
                                 
                                 
                                    (
                                    
                                       k
                                    
                                    )
                                 
                                 
                                    =
                                 
                                 
                                    
                                       1
                                    
                                    
                                       
                                          
                                             n
                                          
                                          
                                             k
                                          
                                       
                                    
                                 
                                 
                                    ∑
                                    
                                       
                                          
                                             x
                                          
                                          
                                             i
                                          
                                       
                                       
                                          ∈
                                       
                                       
                                          
                                             ST
                                          
                                          
                                             k
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          DT
                                       
                                       
                                          cls
                                       
                                    
                                    
                                       (
                                       
                                          
                                             Φ
                                          
                                          
                                             (
                                             
                                                
                                                   T
                                                
                                                
                                                   
                                                      x
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                             )
                                          
                                       
                                       )
                                    
                                 
                              
                           
                        
                     

For each subtree, we optimize 
                           
                              
                                 P
                              
                              
                                 
                                    T
                                    ,
                                 
                                 
                                    k
                                 
                              
                           
                         by using the cost function, Eq. (7). The parameters are initialized to zero. We use the Nelder–Mead optimizer as the optimization algorithm, which shows a good performance for the 2D–3D registration among the local optimization algorithms [6]. The final value of the cost function through the optimization becomes the dissimilarity for each subtree, and then, the subtree with the smallest dissimilarity is chosen as the best matched subtree to the DSA data. The parameter for the selected subtree 
                           
                              
                                 ST
                              
                              
                                 k
                              
                           
                        , 
                           
                              
                                 
                                    P
                                 
                                 
                                    
                                       T
                                       .
                                    
                                    
                                       k
                                    
                                 
                                 
                                    ′
                                 
                              
                              
                                 =
                                 [
                              
                              
                                 
                                    t
                                 
                                 
                                    x
                                 
                                 
                                    ′
                                 
                              
                              
                                 ,
                              
                              
                                 
                                    t
                                 
                                 
                                    y
                                 
                                 
                                    ′
                                 
                              
                              
                                 ,
                              
                              
                                 
                                    t
                                 
                                 
                                    z
                                 
                                 
                                    ′
                                 
                              
                              
                                 ]
                              
                           
                         is used as the initial parameter value in the next step.

In Section 3.1, we concerned ourselves only with the translation transformation for the fast computation, and in order to obtain more correct results, we now conduct a rigid registration for the selected subtree. Eq. (7) is used as the cost function, but the transformation matrix 
                           
                              T
                           
                         in Eq. (7) is re-defined as 
                           
                              T
                              =
                           
                           
                              
                                 T
                              
                              
                                 T
                              
                           
                           
                              ∙
                           
                           
                              
                                 T
                              
                              
                                 R
                              
                           
                        , where 
                           
                              
                                 T
                              
                              
                                 T
                              
                           
                         denotes a translation matrix and 
                           
                              
                                 T
                              
                              
                                 R
                              
                           
                         represents a rotation matrix. Given a parameter set 
                           
                              P
                              =
                           
                           
                              [
                              
                                 
                                    
                                       t
                                    
                                    
                                       x
                                    
                                 
                                 
                                    ,
                                 
                                 
                                    
                                       t
                                    
                                    
                                       y
                                    
                                 
                                 
                                    ,
                                 
                                 
                                    
                                       t
                                    
                                    
                                       z
                                    
                                 
                                 
                                    ,
                                 
                                 
                                    
                                       r
                                    
                                    
                                       x
                                    
                                 
                                 
                                    ,
                                 
                                 
                                    
                                       r
                                    
                                    
                                       y
                                    
                                 
                                 
                                    ,
                                 
                                 
                                    
                                       r
                                    
                                    
                                       z
                                    
                                 
                              
                              ]
                           
                           
                              ∈
                           
                           
                              
                                 R
                              
                              
                                 6
                              
                           
                        , the matrices are defined as follows:
                           
                              
                                 
                                    
                                       
                                          T
                                       
                                       
                                          T
                                       
                                    
                                    
                                       =
                                    
                                    
                                       [
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               
                                                                  t
                                                               
                                                               
                                                                  x
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               
                                                                  t
                                                               
                                                               
                                                                  y
                                                               
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                         
                                                            
                                                               
                                                                  t
                                                               
                                                               
                                                                  z
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       ]
                                    
                                    
                                    
                                    
                                        and
                                    
                                 
                              
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                          T
                                       
                                       
                                          R
                                       
                                    
                                    
                                       =
                                    
                                    
                                       [
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  z
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  z
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               −
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  z
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  z
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       ]
                                    
                                    
                                       ×
                                       [
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  y
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               −
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  y
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  y
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  y
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       ]
                                    
                                    
                                       ×
                                       [
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  x
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  x
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               −
                                                               sin
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  x
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               cos
                                                               (
                                                            
                                                            
                                                               
                                                                  r
                                                               
                                                               
                                                                  x
                                                               
                                                            
                                                            
                                                               )
                                                            
                                                         
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            
                                                               0
                                                            
                                                         
                                                         
                                                            
                                                               1
                                                            
                                                         
                                                      
                                                   
                                                
                                             
                                          
                                       
                                       ]
                                    
                                 
                              
                           
                        
                     

The initial value of 
                           
                              P
                           
                         is set as 
                           
                              [
                           
                           
                              
                                 t
                              
                              
                                 x
                              
                              
                                 ′
                              
                           
                           
                              ,
                           
                           
                              
                                 t
                              
                              
                                 y
                              
                              
                                 ′
                              
                           
                           
                              ,
                           
                           
                              
                                 t
                              
                              
                                 z
                              
                              
                                 ′
                              
                           
                           
                              ,
                              0,0,0
                              ]
                           
                         when 
                           
                              
                                 
                                    P
                                 
                                 
                                    
                                       T
                                       .
                                    
                                    
                                       k
                                    
                                 
                                 
                                    ′
                                 
                              
                              
                                 =
                                 [
                              
                              
                                 
                                    t
                                 
                                 
                                    x
                                 
                                 
                                    ′
                                 
                              
                              
                                 ,
                              
                              
                                 
                                    t
                                 
                                 
                                    y
                                 
                                 
                                    ′
                                 
                              
                              
                                 ,
                              
                              
                                 
                                    t
                                 
                                 
                                    z
                                 
                                 
                                    ′
                                 
                              
                              
                                 ]
                              
                           
                         is obtained in the previous section and the Nelder–Mead optimizer is used.


                        
                        Fig. 6 shows how the proposed registration algorithm works. The green lines represent the projected subtree, which is selected as the best match by the proposed method. The first image is a projection after the initial placement, the second after the selection step, and the third after the rigid registration.

@&#EXPERIMENTAL RESULTS@&#

Ten breath-hold DSA datasets were tested to verify that the proposed algorithm found the appropriate subtree and computed the correct transformation parameters. Each DSA dataset had the corresponding CTA scans, and we used four CTA scans obtained from different patients (
                     Table 1). All datasets were obtained using a C-arm CT scanner of Siemens. The number of slices per CTA scan ranged from 343 to 441, and each slice had a size of 512×512. The pixel spacing and the slice interval were all 0.4mm. DSA datasets had a pixel spacing of 0.216–0.308mm and primary and secondary angles of 0–30°. The resolution of all DSA datasets was 1024×1024. The proposed method was implemented in MATLAB and tested on an Intel i7 desktop system with a 3.40-GHz processor and 8-GB memory.

We validate the correctness of the algorithm with the simulated DSA images. The images are obtained by projecting CTA scans with changing transformation parameters. To generate a simulated DSA image, we project CTA scans onto a 2D plane twice by using the DRR computation in [19]. First, we project the data without preprocessing and then, obtain the simulated X-ray image with all vessels of the CTA data projected (
                        Fig. 7(a)). Next, we set the value of vessels that we want to display on the DSA as zero. To find the region to be simulated, we choose the seed randomly on the subtree to be projected and run the region growing algorithm from the seed. Since we assign the minimum value on the intersection point between subtrees, the region growing does not flow into other subtrees. After changing the value of CTA data, we project it with the same parameter as in the first projection (Fig. 7(b)). Lastly, we subtract the second projection image from the first projection image. Thus, we obtain the simulated DSA image with vessels contrasted only in a limited scope. Fig. 7(c) shows the DSA image obtained by using the above procedure. Following the procedure, six simulated datasets are obtained. We construct two pairs of simulated X-rays and CT images, and for each pair, we obtain three datasets by changing the translational and rotational parameters.

The proposed method finds the appropriate subtree and computes the transformation parameters for a simulated DSA image. Then, the result image is obtained by projecting the selected subtree according to the transformation parameters. To measure the accuracy of the results, we define the junction points of the vascular centerlines as the anatomical feature points. For each simulated DSA image, 5–10 junction points are selected manually as the feature points. We limit the number of feature points to less than 10 because the DSA image shows only a small part of the vasculature, and it is difficult to find more than 10 feature points in one image. Subsequently, in the registered result image, the corresponding points to the feature points of the DSA image are found, and then, the error measure of the validation of the proposed algorithm can be defined by the distance between the feature points and the corresponding points as follows:
                           
                              (8)
                              
                                 
                                    
                                       
                                          E
                                       
                                       
                                          feat
                                       
                                    
                                    
                                       =
                                    
                                    
                                       
                                          1
                                       
                                       
                                          
                                             n
                                          
                                       
                                    
                                    
                                       ∑
                                       
                                          
                                             
                                                r
                                             
                                             
                                                i
                                             
                                          
                                          
                                             ∈
                                          
                                          
                                             Ω
                                          
                                       
                                    
                                    
                                       
                                          ‖
                                          
                                             
                                                
                                                   r
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                −
                                             
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                          
                                          ‖
                                       
                                       
                                          ,
                                       
                                    
                                 
                              
                           
                        where Ω denotes the set of the feature points in the reference image, 
                           
                              n
                           
                         represents the number of feature points, and 
                           
                              
                                 p
                              
                              
                                 i
                              
                           
                         indicates the corresponding points of 
                           
                              
                                 r
                              
                              
                                 i
                              
                           
                         in the 2D projection image. 
                        Table 2 shows 
                           
                              
                                 E
                              
                              
                                 feat
                              
                           
                         for each simulated DSA image.

In another method of the validation of the proposed method, since the simulated DSA is constructed with the predefined transformation parameters, we can verify the capture range of the proposed method. The capture range is defined as the portion of parameter space within which the registration algorithm can be expected to converge to the correct solution [23]. We execute the proposed algorithm from a large number of starting positions with respect to the predefined transformation parameters and determine the registration converged to the correct solution when the error 
                           
                              
                                 E
                              
                              
                                 feat
                              
                           
                         is smaller than 3mm. The capture range for each dataset is determined as the largest successful translational and rotational parameters through approximately 100 registrations. 
                        Table 3 shows the average of the capture range for each pair.

@&#PERFORMANCE EVALUATION@&#

We tested the proposed method for 10 clinical datasets. We evaluated the correctness of the proposed method by dividing it into two steps: subtree selection and fine registration.

In the subtree selection step, the dissimilarity of each subtree is computed and the subtree with the smallest one is chosen as the appropriate subtree for the DSA image. 
                        Table 4 shows the dissimilarity of all subtrees for each dataset, and the selected subtree is written in bold type.

In the case of dataset 2, subtree 5 is selected because the dissimilarity of subtree 5 is the smallest among the six subtrees. 
                        Fig. 8 shows the DSA and all subtrees for dataset 2, and we can confirm that the subtree selected in the selection step of the proposed method correctly corresponds to the DSA.


                        
                        Fig. 9 describes the convergence of the subtrees for dataset 2. Each subtree converges through the optimization process. The dissimilarity of subtree 5 starts from 84.76 and finally stops at 6.09, which is the smallest value among the six subtrees. Hence, subtree 5 is selected as the best matched subtree.

Next, we verify the accuracy of the fine registration step by considering the distance errors between the centerline of the DSA and the projected centerline of the registered subtree. The distance error is measured in the same way as in the phantom study. The junction points on the centerlines of the DSA image are defined as the anatomical feature points, and Eq. (8) is applied. 
                        Table 5 summarizes the distance errors of the 10 datasets. For all the datasets, the errors before the registration process range from 16.6883 to 55.7696mm, and the average value is 40.1137±12.6937mm. After the registration process, the average value of the errors becomes 2.3368±1.94mm, ranging from 0.0866 to 6.1686mm. Further, 
                        Fig. 10 shows the DSA overlaid with vascular tree structures. Fig. 10(c) shows that the entire vascular tree was accurately overlaid on the DSA after fine registration by using only the subtree structures shown in Fig. 10(b). In contrast, Fig. 10(f) shows the overlaid image with a relatively large difference between the DSA and the whole tree. The 2D centerlines are too short to find a correct transformation, and this leads to errors in the registration process.


                        
                        Fig. 11 shows the convergence graph for datasets 2 and 8, including the selection step and the fine registration step. For dataset 8, the final dissimilarity in the selection step is 10.0021. Subsequently, in the fine registration step, the optimization process starts with the addition of the translation parameters computed in the selection step to the rotation parameters. Then, the final dissimilarity reaches 3.4185 through fine registration.

For the evaluation of the computational performance of the proposed method, we measured the total processing time. The total processing time, averaged over multiple tests for all the datasets, was 95.3±15.6s. It took 76.0±12.4s for the subtree selection and 19.3±4.4s for the fine registration.

We compared the accuracy of the proposed method with two 2D–3D registration methods. The first is the registration algorithm based on the distance transform using an entire tree [5], and the second is the state-of-the-art registration algorithm for liver catheterization [24]. Ruijters defines the cost function as the multiplication of the vesselness measure and the distance transform. Since Ruijters׳ method [5] uses the whole skeletons of the 3D vessels in the optimization process, it is difficult to find the exact transformation for the current input DSA image, which has a very small part of the vessel structures. In contrast, the proposed method and Ambrosini׳s method [24] find the best matched part from the entire structure and then, compute the transformation parameters with the partial structure. They remove irrelevant vessels from the projection image of the 3D vessels, and thus, the corresponding points between the 2D and the 3D vessels are defined correctly, which enables the optimization process to find the correct solution.

However, Ambrosini׳s method [24] finds the best matched leaf vessel centerline in a 3D tree corresponding to the catheter in the 2D fluoroscopic image. When the catheter does not have a predominant feature or is too short, the method fails to find the correct leaf centerline. Moreover, since the cost function for the registration uses only the catheter and its corresponding leaf vessel centerline, the accuracy of matching vessels is relatively lower than that of the proposed method.


                        
                        Table 6 shows the distance errors obtained using Eq. (8) of the proposed method, Ruijters׳ method, and Ambrosini׳s method for the same datasets. The average error in the case of Ruijters׳ method is 53.2895±37.3777mm, which indicates that it is difficult to find the correct solution with a whole 3D tree in liver catheterization. The proposed method and Ambrosini׳s method [24] show considerably lower average errors, 2.3368±1.94mm and 12.5051±12.4414mm, respectively. However, Ambrosini׳s method [24] failed to find the appropriate centerline for dataset 5 because the catheter is too short; this causes a large error. Further, for datasets other than dataset 10, the proposed method shows lower errors than Ambrosini׳s method. The proposed algorithm had errors of less than 7mm for all datasets. This comparison demonstrated that the proposed method is successfully devised to find a suitable part for a given DSA image and to accurately register 3D vessels to the DSA image.

The performance of the proposed method is decided by the number of subtrees. It is possible to select a suitable subtree for a given DSA image only when the subtrees are constructed with an appropriate range. The tree should be divided into subtrees that are sufficiently small to be a subset of the centerlines of the DSA or to have a similar range. In contrast, the computational time for the selection step is increased as the number of subtrees increases although the computational time for each subtree is decreased. To decide the optimal number of subtrees, we tested five datasets by changing the number of subtrees from 3 to 7 and evaluating the results of the proposed registration methods by using Eq. (8).

First, we checked the success rate, which is the percentage of the dataset matched with the correct subtree in the selection step. The success rates were 60, 20, 60, 100, and 100(%) for three, four, five, six, and seven subtrees, respectively. In the cases of six and seven subtrees, the correct subtrees were found for all datasets in the selection step. This leads to the high accuracy of the results after the registration process. 
                        Fig. 12 shows the accuracy of the proposed method with respect to the number of subtrees. As the number of subtrees increases, the error 
                           
                              
                                 E
                              
                              
                                 feat
                              
                           
                         calculated using Eq. (8) decreases because the appropriate subtree for a given dataset is selected, and the registration process optimizes the parameters with the selected subtree.

@&#CONCLUSION@&#

In this paper, we presented a 2D–3D registration algorithm between pre-operative 3D CTA scans and intra-operative 2D DSA images for liver catheterization. The proposed approach improves the accuracy of the registration by detecting the areas of interest in the 3D vascular structure used for the registration process. The structure constructed from the 3D CTA scans is divided into several subtrees with respect to their connectivity. In the registration process, the dissimilarity of each subtree with a given 2D DSA is computed on the basis of the distance difference between the centerlines from the DSA and a projection of the 3D subtree. Then, the subtree with the smallest dissimilarity is selected as the best matched subtree. Subsequently, a fine registration between the selected subtree and the 2D centerlines is conducted.

The overall vascular structure is very complex, which induces a large number of overlaps and false crossings in the projection onto a 2D detector plane. Thus, it is difficult to match the 3D vascular structure with the projected vessels. Moreover, a DSA displays only a part of the vascular structure where a catheter currently moves. Therefore, the ranges to be displayed in the CTA and DSA images are very different. The cost function should be designed with this condition. However, the complex structure of vessels leads to a false local minima in the optimization. From this viewpoint, the proposed algorithm has novel features. By separating a structure into several parts, the range of a 3D subtree becomes similar to that of a DSA image. The projection of one subtree preserves its shape without any overlaps between other subtrees and reduces false junctions. Therefore, the proposed method finds the correct subtree to be matched with a given DSA image. Subsequently, the fine registration is conducted with only the relevant vessels with the DSA image, and thus, the registration accuracy is improved considerably.

The experimental results of this study demonstrate that the proposed algorithm can accurately identify an appropriate subtree and find the correct transformation parameters. The proposed method shows good accuracy and convergence with a simple cost function because it focuses only on the interested part of vessels.

The proposed approach has several limitations. The proposed algorithm considers only a rigid transformation. Since the vasculature is a flexible structure, it can be non-rigidly deformed. Although the proposed method exhibits good accuracy only with a rigid transformation in comparison with the state-of-the-art method [24], it cannot recover the local deformation completely. To get more accurate results, we are planning to devise a non-rigid registration in the fine registration step. In the first search step, we already align the 2D–3D vasculature closely. Hence, with the matching information from the first step, the corresponding points between the 2D and the 3D vessels are found, and the non-rigid registration can be conducted by minimizing the distance difference between the corresponding points.

Further, we use a fixed number of subtrees for all datasets. Depending on the range of vessels in the CTA scans, the appropriate number of subtrees can be different. In the parameter study, some datasets showed the same results with five and six subtrees. In this case, dividing a 3D tree into five subtrees is better for achieving a short computation time. Additionally, several subtrees can have similar dissimilarity such as dataset 1 in Table 4. Although the proposed method succeeded in finding the correct subtree for 10 clinical datasets by selecting the subtree with the smallest dissimilarity, the subtree with the second smallest dissimilarity may be a proper subtree. To solve the problem, the fine registration for all subtrees with a dissimilarity close to the smallest one is performed and then the best matched subtree can be selected. We plan to improve this approach after securing more datasets. Moreover, a part of the subtree or two combined subtrees can yield more accurate results in the fine registration step by adjusting the range adequately for the DSA image. Therefore, a flexible organization of subtrees can be efficient and produce higher accuracy in the registration process. With the hierarchical structure of the tree model, the level of separation can be flexibly controlled according to the dataset in a future study.

None declared.

@&#ACKNOWLEDGMENTS@&#

This research was supported by Basic Science Research Program through the National Research Foundation of Korea (NRF) funded by the Ministry of Science, ICT and future Planning (No. 2014R1A2A2A03002574).

In this Appendix, we present the pseudocode for constructing the 3D vascular structure model. Algorithm 1 is the pseudocode, which inserts a new node corresponding to a new branch with a weight and updates the weights of its ancestor nodes. All points in the previously constructed branches have indexes stored in the index list L, and the intersection point index idx between a new branch and one of the previously constructed branches is computed during the construction of a new branch.
                        Algorithm 1
                        Pseudocode for a tree update.


                     Algorithm 2 shows the pseudocode for separating a tree G into a given number, max_num, of subtrees after the tree construction.
                        Algorithm 2
                        Pseudocode for subtree separation.

@&#REFERENCES@&#

