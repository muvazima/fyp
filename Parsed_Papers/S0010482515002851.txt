@&#MAIN-TITLE@&#Automated lesion detectors in retinal fundus images

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           A novel computer-aided decision support system for diabetic retinopathy using retinal fundus images is proposed.


                        
                        
                           
                           Microaneurysm, hemorrhage and bright lesion binary classifier detectors are devised.


                        
                        
                           
                           Validation of the system on large datasets using standard measures is performed.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Microaneurysm detector

Hemorrhage detector

Bright lesion detector

Retinal fundus image

Computer-aided diagnosis

Wavelets

Multiscale analysis

Variational segmentation

Cartoon+texture decomposition

@&#ABSTRACT@&#


               
               
                  Diabetic retinopathy (DR) is a sight-threatening condition occurring in persons with diabetes, which causes progressive damage to the retina. The early detection and diagnosis of DR is vital for saving the vision of diabetic persons. The early signs of DR which appear on the surface of the retina are the dark lesions such as microaneurysms (MAs) and hemorrhages (HEMs), and bright lesions (BLs) such as exudates. In this paper, we propose a novel automated system for the detection and diagnosis of these retinal lesions by processing retinal fundus images. We devise appropriate binary classifiers for these three different types of lesions. Some novel contextual/numerical features are derived, for each lesion type, depending on its inherent properties. This is performed by analysing several wavelet bands (resulting from the isotropic undecimated wavelet transform decomposition of the retinal image green channel) and by using an appropriate combination of Hessian multiscale analysis, variational segmentation and cartoon+texture decomposition. The proposed methodology has been validated on several medical datasets, with a total of 45,770 images, using standard performance measures such as sensitivity and specificity. The individual performance, per frame, of the MA detector is 93% sensitivity and 89% specificity, of the HEM detector is 86% sensitivity and 90% specificity, and of the BL detector is 90% sensitivity and 97% specificity. Regarding the collective performance of these binary detectors, as an automated screening system for DR (meaning that a patient is considered to have DR if it is a positive patient for at least one of the detectors) it achieves an average 95–100% of sensitivity and 70% of specificity at a per patient basis. Furthermore, evaluation conducted on publicly available datasets, for comparison with other existing techniques, shows the promising potential of the proposed detectors.
               
            

@&#INTRODUCTION@&#

Diabetic retinopathy (DR) is a sight-threatening consequence of Diabetes mellitus which affects the small blood vessels in the retina, the nerve layer that lines the back of your eye. Often there are no visual symptoms in the early stages of diabetic retinopathy. Early diagnosis and treatment are essential to prevent significant vision loss from DR. So, it is vital for a diabetic patient to have regular eye examinations. One of the easiest ways to diagnose DR is by analyzing fundus images. They are the visual records which document the current ophthalmoscopic appearance of a patient׳s retina, the retinal vasculature, and the optic nerve head (optic disc) from which the retinal vessels enter the eye. The acquisition of fundus images is inexpensive, non-invasive and easy to perform. Therefore they are adapted for large scale screening purposes.

DR can be mainly classified into two classes: non-proliferative diabetic retinopathy (NPDR) and proliferative diabetic retinopathy (PDR). NPDR is the earliest stage of DR and can be described as mild, moderate or severe. With this condition, the walls of the blood vessels in the retina become weak. Tiny bulges protrude from the vessel walls, sometimes leaking or oozing fluid and blood into the retina. Also, sometimes, deposits of cholesterol or other fats from the blood may leak into the retina. NPDR can cause several changes in the eye, including microaneurysms (MAs), hemorrhages (HEMs) and bright lesions (BLs) (as for instance hard and soft exudates). PDR is the more advanced form of the disease, where fragile new blood vessels form on the surface of the retina over time. These abnormal vessels can bleed or develop scar tissue causing severe loss of vision. PDR may cause more severe vision loss than NPDR because it can affect both central and peripheral vision. Due to this reason it is very significant to diagnose and treat DR in the non-proliferative stage.

Computer-aided detection and diagnosis of DR with retinal fundus images significantly lessens the burden of the implementation of a large scale screening of the diabetic patients. Recent years have seen the development of methods for the accurate detection of MAs, HEMs and BLs by considering them individually and in a collective way. Without being exhaustive we mention here some of these works on automated detection of DR. A survey of various methods related to DR can be found in [1]. The segmentation of exudates using fuzzy c-means clustering algorithm is done in [2]. After extracting color, size, edge strength, and texture features from the regions, a multilayer neural network classifier is used to classify the images. In [3] a new hybrid classifier as an ensemble of Gaussian mixture model and support vector machine is proposed for exudate detection. In [4] a new candidate segmentation method, based on mathematical morphology, is proposed. After extracting some features, a random forest algorithm is used to detect the exudates among the candidates. An automatic MA detector based on template matching in wavelet space using a Gaussian template is proposed in [5]. The detection of MAs and HEMs based on recursive region growing segmentation algorithm and a moat operator is done in [6]. After extracting the potential candidates and formulating a set of features of MAs, HEMs and exudates, [7] used a hybrid classifier which is a weighted combination of multivariate m-Mediods and a Gaussian mixture model. An ensemble-based framework for the detection of MAs is proposed in [8]. The algorithm in [9] assessed the need for referral in DR detection with a decision based on the fusion of results by meta-classification. A novel splat feature classification method is proposed in [10] to detect retinal hemorrhages. In [11] a method for the diagnosis of diabetic macular edema based on exudate detection is proposed. This detection relies on a feature vector generated for each image that results from an exudate probability map (computed from the exudate candidate map in a pre-processing step), from color analysis and from wavelet analysis. In [12], the authors describe a method for segmentation of exudates in fundus images using image registration. A retinal statistical atlas based on ethnicity is built and the lesions on a diseased eye image are identified depending on the chromaticity differences between the mean atlas image and the diseased image.

The present paper describes an intelligent automated system for the binary classification of different types of DR lesions by processing eye fundus images. We derive some novel contextual detectors for MAs, HEMs and BLs, depending on the lesion intrinsic properties. The numerical features, which define each detector, rely on the analysis of several wavelet bands (resulting from the isotropic undecimated wavelet transform [13] decomposition of the retinal image), and on an appropriate combination of Hessian multiscale analysis (more precisely, using the Hessian eigenvalues), variational segmentation [14,15] and cartoon+texture decomposition [16]. The features are then used to classify the retinal images into separate categories of DR. The decision criteria, on whether a frame has or does not have one of these lesions, are based on simple thresholding approaches.

To the best of our knowledge, this is the first time that the variational segmentation [14,15] and cartoon+texture decomposition [16] (of high wavelet levels) are combined and used in retinal fundus images for the detection of medium/large HEMs or BLs (more noticeable in the cartoon part) and clusters of dotted BLs (more prominent in the texture part). In particular, in the segmented regions (containing the HEM or BL candidates) the discriminant descriptors, devised for classification, are based on suitable medical information related to the different characteristics of the lesions, such as shape, size and texture.

Concerning the proposed MA detector and the detector for identifying prominent dot isolated BLs, which have proven to be very effective, they involve low wavelet levels and a blob-like detector (based on Hessian multiscale analysis and corresponding eigenvalues properties). A very recent work [17] also uses scale-adapted blob analysis and semi-supervised learning for an automated detection of MAs in digital fundus images. Our MA detector is different and simpler than the one proposed in [17]. The main differences are that we perform several pre-processing steps directly in the low wavelets sub-bands, to enhance the MAs and suppress unwanted structures, we explicitly build a scale-adapted blob-like function and finally use a simple thresholding approach for classification.

We also perform a thorough testing of the proposed methods, as a system for DR detection, on several rich and large datasets (with thousands of images – a total of 45,770 fundus images from 11,511 patients) to ensure its good performance in realistic environment. It achieves an average 95–100% sensitivity and 70% specificity at a per patient basis. Further evaluation carried out on publicly available datasets, for comparison with the state-of-the art techniques, confirms the significance and potential of the proposed methods.

The rest of the paper is structured as follows. Section 2 describes the mathematical models and setting used throughout the paper. Section 3 presents in detail the methodology, by explaining the definition of the MA, HEM and BL detectors. This includes the extraction of the candidates for the different lesions, description of all the features and the binary classifiers for the lesions. Section 4 presents the experimental results on several medical datasets prepared by retinal experts. Then, the paper ends with a discussion of the results and some conclusions in Section 5.

The methodology developed in this paper for detecting different retinal lesions relies on four major mathematical techniques (i – wavelets, ii – multiscale analysis of the image Hessian matrix, iii – cartoon and texture image decomposition, iv – variational image segmentation) which are combined in a sequential and suitable way. This combination depends on the visual information transmitted by the different lesions (that by nature are very diverse in shape, size, texture and color). In this section we start by explaining the motivation that justifies the use of these aforementioned image processing techniques, and then for convenience of the reader, we outline these 4 techniques in an abstract framework, for a scalar image. The application of these techniques to retinal fundus images for lesion detection is afterwards explained in Section 3.

@&#MOTIVATION@&#

We briefly summarize now the main ideas that have motivated the choice of the aforementioned techniques for devising the lesion detectors, as well as some other subsequent related choices. Somewhat these ideas match with a clinician׳s strategy to identify the lesions:


                        
                           
                              (i)
                              We always do the image processing in the wavelet decomposition of the green channel of the retinal image. The green channel is chosen, because there MAs, HEMs, and BLs appear most contrasted, compared to the red or blue channels of the RGB retinal image. In addition, small lesions such as MAs or dot BLs are visible at low wavelet levels, while medium/large HEMs or BLs are better perceived at high wavelet levels. Since MAs and HEMs are dark red lesions, we need to work on the darkest pixels of the wavelet decomposition (typically either 10% or 20% darkest), while for BLs, that are white lesions, we work on the highest pixels (typically 20% highest). Filtering with adaptive filters (as Wiener filter) is also needed for smoothing and enhancing and also to remove noise and other unwanted structures, that can interfere with the detection of the lesions.

The Hessian multiscale analysis permits us to locate blob-like structures of different sizes, either dark (like MAs or HEMs) or bright (like BLs), using the correlation that exists between the values of the Hessian eigenvalues at a region and the shape of that region.

Based on the properties of the cartoon+texture decomposition of an image, homogeneous medium/large HEMs or BLs are located in the cartoon part, whereas clusters of small dotted BLs are located in the texture part. Therefore we explore as well the cartoon and texture parts.

With the variational image segmentation model we are able to automatically derive segmentation curves that identify candidate lesions.

Finally we observe that for some criteria, (ii), (iii) and (iv) are not applied separately, but in a suitable combined sequence. From the results obtained with (ii), (iii) and (iv) we devise appropriate numerical features for discriminating between frames with and without lesions. Then, the final decision criteria, on whether a frame has or does not have a lesion (MAs, HEMs or BLs), are based on thresholding approaches.

The Isotropic Undecimated Wavelet Transform (IUWT) [13] is characterized by a simple implementation of its direct and inverse transforms. Denoting by 
                           
                              
                                 C
                              
                              
                                 0
                              
                           
                           =
                           I
                         a scalar input image, at each subsequent iteration 
                           j
                           ,
                         the scaling coefficient C
                        
                           j
                         is computed by lowpass filtering (where filtering is applied by convolution and separably along each dimension), and the wavelet coefficient W
                        
                           j
                         (hereafter called wavelet level) is defined just by subtracting two adjacent scaling coefficients, i.e, 
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           ≔
                           
                              
                                 C
                              
                              
                                 j
                                 −
                                 1
                              
                           
                           −
                           
                              
                                 C
                              
                              
                                 j
                              
                           
                        . Starting with the filter 
                           
                              
                                 h
                              
                              
                                 0
                              
                           
                           =
                           [
                           1
                           /
                           16
                           ,
                           1
                           /
                           4
                           ,
                           3
                           /
                           8
                           ,
                           1
                           /
                           4
                           ,
                           1
                           /
                           16
                           ]
                        , which is derived from the cubic B-spline, at each scale 
                           j
                           ≥
                           1
                         the filter h
                        
                           j
                         is augmented by inserting 
                           
                              
                                 2
                              
                              
                                 j
                              
                           
                           −
                           1
                         zeros between each pair of adjacent coefficients of h
                        0. The scaling coefficient 
                           
                              
                                 C
                              
                              
                                 j
                                 +
                                 1
                              
                           
                         is defined from the previous coefficient C
                        
                           j
                         using separable convolution with h
                        
                           j
                         in each dimension. The reproduction of the original image I is achieved just by adding all the computed wavelet coefficients and the final computed scaling coefficient in the following way: 
                           I
                           :=
                           
                              
                                 C
                              
                              
                                 m
                              
                           
                           +
                           
                              
                                 ∑
                              
                              
                                 j
                                 =
                                 1
                              
                              
                                 m
                              
                           
                           
                              
                                 W
                              
                              
                                 j
                              
                           
                           .
                        
                     

In the sequel we denote by I
                        
                           n
                         a partial reconstruction of I defined by
                           
                              (1)
                              
                                 
                                    
                                       I
                                    
                                    
                                       n
                                    
                                 
                                 =
                                 
                                    
                                       ∑
                                    
                                    
                                       j
                                       =
                                       2
                                    
                                    
                                       n
                                    
                                 
                                 
                                    
                                       W
                                    
                                    
                                       j
                                    
                                 
                                 ,
                                 
                                 n
                                 =
                                 2
                                 ,
                                 3
                                 ,
                                 4
                                 ,
                                 5
                                 ,
                              
                           
                        with W
                        
                           j
                         being the wavelet level at iteration j.

We have noticed that very small lesions, such as micro-aneurysms or dot bright lesions, are visible and enhanced at wavelet level W
                        2, or at the sum of wavelet levels W
                        2 and W
                        3 of the green channel of the input fundus image. Moreover, large structures in the images, such as hemorrhages (as well as vessels) and medium/large bright lesions, are also better perceived by human sight at higher wavelet levels. Therefore all the subsequent procedures herein described for the detection of lesions (MAs, HEMs or BLs) rely on the wavelet decomposition (1) of the green channel of the fundus images.

To look for blob structures in a scalar image, we use herein a strategy based on the eigenvalues of the image Hessian matrix and multiscale image analysis. For a scalar image 
                           I
                           :
                           Ω
                           ⊆
                           
                              
                                 R
                              
                              
                                 2
                              
                           
                           →
                           R
                           ,
                         where Ω is the pixel domain, we first define the Hessian matrix of one point 
                           x
                           ∈
                           Ω
                        , and at a scale s, by 
                           
                              
                                 
                                    
                                       H
                                    
                                    
                                       s
                                    
                                 
                                 (
                                 x
                                 )
                                 :=
                                 (
                                 
                                    
                                       
                                          
                                             
                                                
                                                   I
                                                
                                                
                                                   11
                                                
                                                
                                                   s
                                                
                                             
                                             (
                                             x
                                             )
                                          
                                          
                                             
                                                
                                                   I
                                                
                                                
                                                   12
                                                
                                                
                                                   s
                                                
                                             
                                             (
                                             x
                                             )
                                          
                                       
                                       
                                          
                                             
                                                
                                                   I
                                                
                                                
                                                   12
                                                
                                                
                                                   s
                                                
                                             
                                             (
                                             x
                                             )
                                          
                                          
                                             
                                                
                                                   I
                                                
                                                
                                                   22
                                                
                                                
                                                   s
                                                
                                             
                                             (
                                             x
                                             )
                                          
                                       
                                    
                                 
                                 )
                                 .
                              
                           
                        Here 
                           
                              
                                 I
                              
                              
                                 11
                              
                              
                                 s
                              
                           
                           ,
                         
                        
                           
                              
                                 I
                              
                              
                                 12
                              
                              
                                 s
                              
                           
                         and 
                           
                              
                                 I
                              
                              
                                 22
                              
                              
                                 s
                              
                           
                         are the second-order partial derivatives of 
                           I
                         and the scale s is involved in the calculation of these derivatives (for instance using Gaussian convolution). Suppose 
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 1
                              
                           
                         and 
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 2
                              
                           
                         are the two eigenvalues of the Hessian matrix 
                           
                              
                                 H
                              
                              
                                 s
                              
                           
                        . Note that in a blob region, these two eigenvalues have the same sign and similar magnitudes (see [18]). Without loss of generality we assume that 
                           |
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 1
                              
                           
                           |
                           ≤
                           |
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 2
                              
                           
                           |
                        . Then, setting 
                           
                              
                                 F
                              
                              
                                 s
                              
                           
                           ≔
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 1
                              
                              
                                 2
                              
                           
                           +
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 2
                              
                              
                                 2
                              
                           
                         we define 
                           
                              
                                 
                                    
                                       f
                                    
                                    
                                       1
                                    
                                 
                                 ≔
                                 
                                 exp
                                 (
                                 
                                    −
                                    β
                                    
                                       
                                          F
                                       
                                       
                                          s
                                       
                                    
                                 
                                 )
                                 
                                 and
                                 
                                 
                                    
                                       f
                                    
                                    
                                       2
                                    
                                 
                                 ≔
                                 1
                                 −
                                 exp
                                 (
                                 
                                    −
                                    α
                                    
                                       
                                          (
                                          
                                             
                                                
                                                   
                                                      
                                                         λ
                                                      
                                                      
                                                         s
                                                         ,
                                                         1
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         λ
                                                      
                                                      
                                                         s
                                                         ,
                                                         2
                                                      
                                                   
                                                
                                             
                                          
                                          )
                                       
                                       
                                          2
                                       
                                    
                                 
                                 )
                                 .
                              
                           
                        Then motivated by [18,19], and for enforcing the detection of blob-like regions, we combine f
                        1 and f
                        2 and define the blob-like 
                           (
                           
                              
                                 B
                              
                              
                                 s
                              
                           
                           )
                         detector (at each point of the domain) by 
                           
                              
                                 
                                    
                                       B
                                    
                                    
                                       s
                                    
                                 
                                 ≔
                                 {
                                 
                                    
                                       
                                          
                                             0
                                          
                                          
                                             if
                                             
                                             
                                                
                                                   λ
                                                
                                                
                                                   s
                                                   ,
                                                   1
                                                
                                             
                                             
                                                
                                                   λ
                                                
                                                
                                                   s
                                                   ,
                                                   2
                                                
                                             
                                             <
                                             0
                                             
                                             or
                                             
                                             |
                                             
                                                
                                                   λ
                                                
                                                
                                                   s
                                                   ,
                                                   2
                                                
                                             
                                             −
                                             
                                                
                                                   λ
                                                
                                                
                                                   s
                                                   ,
                                                   1
                                                
                                             
                                             |
                                             >
                                             δ
                                          
                                       
                                       
                                          
                                             (
                                             1
                                             −
                                             
                                                
                                                   f
                                                
                                                
                                                   1
                                                
                                             
                                             )
                                             
                                                
                                                   f
                                                
                                                
                                                   2
                                                
                                             
                                          
                                          
                                             otherwise
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The parameters α and β control the sensitivity (sensitivity in the sense of general performance) of the function B
                        
                           s
                         and δ a user chosen threshold.

We note that F
                        
                           s
                         is the square of the Frobenius norm of the Hessian matrix H
                        
                           s
                        , and therefore F
                        
                           s
                         will be big in regions with high contrast compared to the background pixels (where the magnitude of the derivatives, and consequently the eigenvalues, is small). So f
                        1 measures the strength of the gray level variation of the image, and it will be close to zero if the magnitude of the eigenvalues is big (and close to one otherwise). Concerning f
                        2 we remark that the blob regions are not in general perfect blobs, but rather blob-like, and in addition the blob-like detector B
                        
                           s
                         will be computed for a frame that has already undergone several pre-processing steps (like filtering and smoothing). This is the reason why the parameter α was introduced in the definition of f
                        2. Consequently the blob-like detector B
                        
                           s
                         will be much higher in blob-like regions than elsewhere (only locations with 
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 1
                              
                           
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 2
                              
                           
                           ≥
                           0
                         or 
                           |
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 2
                              
                           
                           −
                           
                              
                                 λ
                              
                              
                                 s
                                 ,
                                 1
                              
                           
                           |
                           ≤
                           δ
                         are of interest, because of the aforementioned properties of the eigenvalues).

In the numerical experiments the values of 
                           α
                           ,
                         
                        β and δ are considered to be 
                           1
                           ,
                         1 and 10−4, respectively (see Table 3).

In order to automatically detect blobs of different sizes, a multiscale approach is necessary. The response of the detector function B
                        
                           s
                         will be maximum at a scale that approximately matches the size of the blob to be detected. Hence, at each point of the domain, we define the function
                           
                              (2)
                              
                                 B
                                 ≔
                                 
                                    
                                       max
                                    
                                    
                                       
                                          
                                             s
                                          
                                          
                                             min
                                          
                                       
                                       ≤
                                       s
                                       ≤
                                       
                                          
                                             s
                                          
                                          
                                             max
                                          
                                       
                                    
                                 
                                 (
                                 
                                    
                                       
                                          B
                                       
                                       
                                          s
                                       
                                    
                                    ·
                                    I
                                 
                                 )
                                 ,
                              
                           
                        where the dot means element-by-element multiplication, s
                        
                           min
                         and s
                        
                           max
                         are, respectively, the minimum and maximum scales at which the blobs are expected to be found. Finally, in the subsequent sections we consider the maximum of the function B as an input to our binary (blob) classifier:
                           
                              (3)
                              
                                 
                                    
                                       B
                                    
                                    
                                       max
                                    
                                 
                                 ≔
                                 
                                    
                                       
                                          max
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    
                                       
                                          B
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                 
                                 ,
                                 
                                 1
                                 ≤
                                 i
                                 ≤
                                 
                                    
                                       N
                                    
                                    
                                       x
                                    
                                 
                                 ,
                                 
                                 1
                                 ≤
                                 j
                                 ≤
                                 
                                    
                                       N
                                    
                                    
                                       y
                                    
                                 
                                 ,
                              
                           
                        where N
                        
                           x
                         and N
                        
                           y
                         are the width and the height of the image in pixels, respectively.

In Section 3 we look for roundish small/medium/large structures in the images, either dark-red (like MAs or HEMs) or bright (like BLs), using this type of function B, where the input image I is an appropriate wavelet level or sum of wavelet levels (see (1)) of the green channel of the retina image (the choice of the levels depends on the lesion size, as remarked in Section 2.2). We note that in some cases HEMs and BLs can exhibit elongated shapes, with uneven density but surrounding smaller blob regions, which justifies the search for blob regions. Therefore, in this paper the blob-like function B in (2) is a fundamental tool in the definition of the detectors in all these cases (MAs, HEMs and BLs).

Given a scalar image 
                           I
                           :
                           Ω
                           ⊆
                           
                              
                                 R
                              
                              
                                 2
                              
                           
                           →
                           R
                        , we decompose it into the cartoon (or geometric) part C and the texture (or oscillatory) part T using an algorithm of Buades et al. [16]. This algorithm is briefly described as follows. We define the local total variation (LTV) for each pixel x in Ω, by the convolution (denoted by ’⁎’) 
                           
                              
                                 
                                    
                                       LTV
                                    
                                    
                                       σ
                                    
                                 
                                 (
                                 I
                                 )
                                 (
                                 x
                                 )
                                 ≔
                                 
                                    
                                       G
                                    
                                    
                                       σ
                                    
                                 
                                 ⁎
                                 |
                                 ∇
                                 I
                                 |
                                 (
                                 x
                                 )
                              
                           
                        where 
                           
                              
                                 G
                              
                              
                                 σ
                              
                           
                         is a Gaussian kernel of variance σ (in the experiments σ is fixed to 5, see Table 3) and for a smooth I, 
                           |
                           ∇
                           I
                           |
                         represents the gradient magnitude of I. The main characteristic of a textural region is its high total variation (due to its oscillations) and the property of decreasing very fast under low-pass filtering (as opposed to cartoon, or equivalently, non-oscillatory regions). We then compute the relative reduction rate of LTV by 
                           
                              
                                 λ
                                 (
                                 x
                                 )
                                 
                                 ≔
                                 
                                 
                                    
                                       
                                          
                                             LTV
                                          
                                          
                                             σ
                                          
                                       
                                       (
                                       I
                                       )
                                       (
                                       x
                                       )
                                       −
                                       
                                          
                                             LTV
                                          
                                          
                                             σ
                                          
                                       
                                       (
                                       
                                          
                                             R
                                          
                                          
                                             σ
                                          
                                       
                                       ⁎
                                       I
                                       )
                                       (
                                       x
                                       )
                                    
                                    
                                       
                                          
                                             LTV
                                          
                                          
                                             σ
                                          
                                       
                                       (
                                       I
                                       )
                                       (
                                       x
                                       )
                                    
                                 
                                 ,
                              
                           
                        where 
                           
                              
                                 R
                              
                              
                                 σ
                              
                           
                         is a low pass filter. Therefore, due to the aforementioned properties of a textural region, λ is a local indicator of the oscillations in I: if 
                           λ
                           (
                           x
                           )
                           ≈
                           0
                         there is little reduction of LTV with the low-pass filter, but if 
                           λ
                           (
                           x
                           )
                           ≈
                           1
                        , this means the reduction is strong, and consequently the pixel x belongs to a textured region.

Depending on the relative reduction rate of LTV, λ, and taking the weighted average of I and 
                           
                              
                                 R
                              
                              
                                 σ
                              
                           
                           ⁎
                           I
                           ,
                         we get the cartoon part 
                           C
                           ,
                         and hence the texture part T. These are defined by
                           
                              (4)
                              
                                 C
                                 (
                                 x
                                 )
                                 ≔
                                 w
                                 (
                                 
                                    λ
                                    (
                                    x
                                    )
                                 
                                 )
                                 (
                                 
                                    
                                       
                                          R
                                       
                                       
                                          σ
                                       
                                    
                                    ⁎
                                    I
                                 
                                 )
                                 (
                                 x
                                 )
                                 +
                                 (
                                 
                                    1
                                    −
                                    w
                                    (
                                    
                                       λ
                                       (
                                       x
                                       )
                                    
                                    )
                                 
                                 )
                                 I
                                 (
                                 x
                                 )
                                 ,
                                 T
                                 (
                                 x
                                 )
                                 ≔
                                 I
                                 (
                                 x
                                 )
                                 −
                                 C
                                 (
                                 x
                                 )
                                 .
                              
                           
                        The weight 
                           w
                           :
                           [
                           0
                           ,
                           1
                           ]
                           →
                           [
                           0
                           ,
                           1
                           ]
                         is a nondecreasing piecewise affine function that is constant and equal to zero, near zero, and constant and equal to 1, near 1 (we refer to [16], for the definition of w). Thus, if 
                           λ
                           (
                           x
                           )
                         is very small, then I is non-oscillatory around x and therefore 
                           w
                           ≈
                           0
                        , so 
                           C
                           ≈
                           I
                        , that is the image is cartoon. If instead 
                           λ
                           (
                           x
                           )
                         is big, then the image I is locally oscillatory in the neighborhood of x.

In the experiments the low pass filtered image 
                           
                              
                                 R
                              
                              
                                 σ
                              
                           
                           ⁎
                           I
                         is obtained by convolving I with the low pass filter 
                           
                              
                                 R
                              
                              
                                 σ
                              
                           
                           :=
                           (
                           Id
                           −
                           (
                           Id
                           −
                           
                              
                                 G
                              
                              
                                 σ
                              
                           
                           )
                           n
                           )
                        , indicating n that the convolution is iterated n times. In the numerical experiments n is fixed to 5 and σ is also fixed to 5 (see Table 3).

We apply this cartoon+texture decomposition to the sum of some wavelet levels and use it for the location of HEMs (in Section 3.3.3) and BLs (in Sections 3.4.2 and 3.4.3). In fact, we have remarked that clusters of small dotted BLs, that are spread across the image, are more enhanced in the texture part. On the other hand, large/medium BLs as well as large/medium HEMs are better captured in the cartoon (or geometric) part.

The (two-phase) segmentation scheme, we have applied, relies on a reformulation of the Chan and Vese variational model [15], and can be briefly described in the following steps (see [14]):
                           
                              •
                              
                                 Step 1: Firstly, the initial constants c
                                 1 and c
                                 2 (representing the two average intensities of the given input scalar image 
                                    I
                                    :
                                    Ω
                                    ⊆
                                    
                                       
                                          R
                                       
                                       
                                          2
                                       
                                    
                                    →
                                    R
                                    ,
                                  in a set of (possibly non-connected) image regions) are computed.


                                 Step 2: Then we solve the following minimization problem:
                                    
                                       (5)
                                       
                                          
                                             
                                                min
                                             
                                             
                                                u
                                                ,
                                                v
                                             
                                          
                                          {
                                          
                                             
                                                
                                                   TV
                                                
                                                
                                                   g
                                                
                                             
                                             (
                                             u
                                             )
                                             +
                                             
                                                
                                                   1
                                                
                                                
                                                   2
                                                   θ
                                                
                                             
                                             ∥
                                             u
                                             −
                                             v
                                             
                                                
                                                   ∥
                                                
                                                
                                                   
                                                      
                                                         L
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                   (
                                                   Ω
                                                   )
                                                
                                                
                                                   2
                                                
                                             
                                             +
                                             
                                                
                                                   ∫
                                                
                                                
                                                   Ω
                                                
                                             
                                             (
                                             
                                                λ
                                                
                                                r
                                                (
                                                I
                                                ,
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      1
                                                   
                                                
                                                ,
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      2
                                                   
                                                
                                                )
                                                
                                                v
                                                +
                                                α
                                                
                                                ν
                                                (
                                                v
                                                )
                                             
                                             )
                                             
                                             dx
                                          
                                          }
                                          .
                                       
                                    
                                 Here 
                                    
                                       
                                          L
                                       
                                       
                                          2
                                       
                                    
                                    (
                                    Ω
                                    )
                                  is the space of square-integrable functions in Ω ; 
                                    
                                       
                                          TV
                                       
                                       
                                          g
                                       
                                    
                                    (
                                    u
                                    )
                                    ≔
                                    
                                       
                                          ∫
                                       
                                       
                                          Ω
                                       
                                    
                                    g
                                    (
                                    x
                                    )
                                    |
                                    ∇
                                    u
                                    |
                                    
                                    dx
                                  is the total variation norm of the function u, weighted by a positive function g, and acts as a regularizing term; 
                                    θ
                                    >
                                    0
                                  is a fixed small parameter, and 
                                    ∥
                                    u
                                    −
                                    v
                                    
                                       
                                          ∥
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                2
                                             
                                          
                                          (
                                          Ω
                                          )
                                       
                                       
                                          2
                                       
                                    
                                  and 
                                    α
                                    
                                    ν
                                    (
                                    v
                                    )
                                  are two terms resulting from a reformulation of the original segmentation model [15] as a convex unconstrained minimization problem, where v is an auxiliary unknown (see [14, Theorem 3]) ; finally, 
                                    r
                                    (
                                    I
                                    ,
                                    
                                       
                                          c
                                       
                                       
                                          1
                                       
                                    
                                    ,
                                    
                                       
                                          c
                                       
                                       
                                          2
                                       
                                    
                                    )
                                    (
                                    x
                                    )
                                    v
                                    (
                                    x
                                    )
                                    ≔
                                    (
                                    
                                       
                                          
                                             (
                                             
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      1
                                                   
                                                
                                                −
                                                I
                                                (
                                                x
                                                )
                                             
                                             )
                                          
                                          
                                             2
                                          
                                       
                                       −
                                       
                                          
                                             (
                                             
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      2
                                                   
                                                
                                                −
                                                I
                                                (
                                                x
                                                )
                                             
                                             )
                                          
                                          
                                             2
                                          
                                       
                                    
                                    )
                                    v
                                    (
                                    x
                                    )
                                  is the fitting term, trying to match the input image I as a set of (non-connected) regions with only two different values c
                                 1 and c
                                 2; 
                                    λ
                                    >
                                    0
                                  is a constant parameter weighting this fitting term.

In (5) 
                                 u represents the two-phase segmentation (or in other words, the two, non-connected, image regions with only two values c
                                 1 and c
                                 2). The segmentation curve, which divides the image into two disjoint parts, is a level set of u, 
                                    {
                                    x
                                    ∈
                                    Ω
                                    :
                                    
                                    u
                                    (
                                    x
                                    )
                                    =
                                    μ
                                    }
                                 , where in general 
                                    μ
                                    =
                                    0.5
                                  (but μ can be any number between 0 and 1, without changing the segmentation result, because u is very close to a binary function).


                                 Step 3: After solving (5) we update the constants c
                                 1 and c
                                 2 by 
                                    
                                       
                                          
                                             
                                                c
                                             
                                             
                                                1
                                             
                                          
                                          =
                                          average
                                          
                                          of
                                          
                                          I
                                          
                                          in
                                          
                                          {
                                          x
                                          ∈
                                          Ω
                                          :
                                          
                                          u
                                          (
                                          x
                                          )
                                          ≥
                                          μ
                                          }
                                          
                                             
                                                c
                                             
                                             
                                                2
                                             
                                          
                                          =
                                          average
                                          
                                          of
                                          
                                          I
                                          
                                          in
                                          
                                          {
                                          x
                                          ∈
                                          Ω
                                          :
                                          
                                          u
                                          (
                                          x
                                          )
                                          <
                                          μ
                                          }
                                       
                                    
                                 and return to Step 2, using the updated c
                                 1 and c
                                 2.


                                 Step 4: Stop when a stopping criterion imposed to u and v is verified.

The above minimization problem (5) is solved by minimizing u and v separately, and iterated until convergence. In short, the following two steps are performed:
                           
                              1.
                              With v being fixed, we look for u that solves
                                    
                                       (6)
                                       
                                          
                                             
                                                min
                                             
                                             
                                                u
                                             
                                          
                                          {
                                          
                                             
                                                
                                                   TV
                                                
                                                
                                                   g
                                                
                                             
                                             (
                                             u
                                             )
                                             +
                                             
                                                
                                                   1
                                                
                                                
                                                   2
                                                   θ
                                                
                                             
                                             ∥
                                             u
                                             −
                                             v
                                             
                                                
                                                   ∥
                                                
                                                
                                                   
                                                      
                                                         L
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                   (
                                                   Ω
                                                   )
                                                
                                                
                                                   2
                                                
                                             
                                          
                                          }
                                          .
                                       
                                    
                                 
                              

With u being fixed, we look for v that solves
                                    
                                       (7)
                                       
                                          
                                             
                                                min
                                             
                                             
                                                v
                                             
                                          
                                          {
                                          
                                             
                                                
                                                   1
                                                
                                                
                                                   2
                                                   θ
                                                
                                             
                                             ∥
                                             u
                                             −
                                             v
                                             
                                                
                                                   ∥
                                                
                                                
                                                   
                                                      
                                                         L
                                                      
                                                      
                                                         2
                                                      
                                                   
                                                   (
                                                   Ω
                                                   )
                                                
                                                
                                                   2
                                                
                                             
                                             +
                                             
                                                
                                                   ∫
                                                
                                                
                                                   Ω
                                                
                                             
                                             (
                                             
                                                λ
                                                
                                                r
                                                (
                                                I
                                                ,
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      1
                                                   
                                                
                                                ,
                                                
                                                   
                                                      c
                                                   
                                                   
                                                      2
                                                   
                                                
                                                )
                                                
                                                v
                                                +
                                                α
                                                
                                                ν
                                                (
                                                v
                                                )
                                             
                                             )
                                             
                                             dx
                                             
                                             dy
                                          
                                          }
                                          .
                                       
                                    
                                 
                              

We refer to [14, Propositions 3, 4] for the solution of (6) and (7). In particular, (6) is solved by using a dual formulation of the TV
                        
                           g
                        -norm, which leads to a fast algorithm. For our experiments g is considered to be the edge indicator function 
                           g
                           (
                           ∇
                           u
                           )
                           ≔
                           1
                           /
                           (
                           1
                           +
                           η
                           ∥
                           ∇
                           u
                           
                              
                                 ∥
                              
                              
                                 2
                              
                           
                           )
                         with 
                           η
                           =
                           
                              
                                 10
                              
                              
                                 −
                                 3
                              
                           
                         (
                           ∥
                           ·
                           ∥
                         denotes the Euclidean norm and ∇ the gradient operator). In the experiments the values of θ and λ are considered to be 1 and 0.01, respectively (see Table 3). The term 
                           α
                           
                           ν
                           (
                           v
                           )
                         can be ignored as explained in [14, Appendix].

This automatic segmentation method is used for locating medium/large hemorrhages (HEM Criterion 3, in Section 3.3.3) and also clusters of small dotted bright lesions (BL Criterion 2, in Section 3.4.2), as well as medium/large bright lesions (BL Criterion 3, in Section 3.4.3). The segmentation is performed in the sum of appropriate wavelet levels, that are processed in a suitable way, as explained in the following sections. In particular, for BLs the segmentation is done either in the texture or the cartoon part, using the cartoon+texture decomposition that is summarized in Section 2.4. Afterwards particular features in the segmented regions are quantified for discriminating between frames with lesions and normal frames.

In this section we present a detailed explanation of the method for detecting the different lesions. We start with the first step of the method: the pre-processing step and the optic disk detection in retinal fundus images. Afterwards we give the description of the three lesion detectors for microaneurysms (MAs), hemorrhages (HEMs) and bright lesions (BLs). Once these feature detectors are extracted, the decision criteria, on whether a frame has or does not have one of these lesions, are based on simple thresholding approaches. Moreover, for each detector a schematic summary of its definition is presented.

Retinal fundus images normally contain a main region at the center of the image, which is called the field of view (FOV), surrounded by dark background pixels. For automated detection of lesions we only need to process the main region, so we separate it from the background, in a preprocessing step. The separation is done by first performing a binary segmentation via thresholding of the green channel I
                        
                           G
                        . The corresponding binary image is 
                           
                              
                                 I
                              
                              
                                 G
                              
                              
                                 FOV
                              
                           
                           (
                           x
                           )
                           ≔
                           H
                           (
                           
                              
                                 I
                              
                              
                                 G
                              
                           
                           (
                           x
                           )
                           −
                           γ
                           )
                        , where 
                           H
                         is the Heaviside function taken pixel-wise (that is 
                           H
                           (
                           z
                           )
                           =
                           0
                         if 
                           z
                           <
                           0
                         and 
                           H
                           (
                           z
                           )
                           =
                           1
                         if 
                           z
                           >
                           0
                        ) and the scalar threshold γ is defined by 
                           γ
                           ≔
                           0.1
                           
                              
                                 max
                              
                              
                                 i
                                 ,
                                 j
                              
                           
                           
                              
                                 I
                              
                              
                                 G
                                 ;
                                 i
                                 ,
                                 j
                              
                           
                        , for 
                           1
                           ≤
                           i
                           ≤
                           
                              
                                 N
                              
                              
                                 x
                              
                           
                           ,
                           1
                           ≤
                           j
                           ≤
                           
                              
                                 N
                              
                              
                                 y
                              
                           
                         (with N
                        
                           x
                         and N
                        
                           y
                         being the width and the height of the image in pixels, respectively). Afterwards, using a square unit matrix of size 3 as structuring element (more precisely, we have used the imerode function of the software 
                           
                              
                                 
                                    MATLAB
                                 
                              
                              
                                 ®
                              
                           
                         R2012a (The Mathworks, Inc.)) we perform the erosion in I
                        
                           G
                        
                        
                           FOV
                        . From this eroded binary image we then create a mask that separates FOV and background.

It is also needed to extract the optic disc (OD) from each image to eliminate any spurious and false regions caused by their similarities with bright lesions. The segmentation of the OD is done in two steps. We first localize the OD using its geometric features and then use the circular Hough transform (CHT) in the localized region to detect the OD boundary. The herein proposed approach for the OD detection was presented by the authors in a conference paper in [20], and it is briefly summarized here for convenience of the reader.

It is well known that the OD appears most contrasted in the green channel compared to the red and blue channels of the RGB image (see [1]). More importantly, it appears as a concave region (protrusion) in the green channel. Motivated from [21,22], we define 
                           
                              
                                 
                                    
                                       OD
                                    
                                    
                                       loc
                                    
                                 
                                 ≔
                                 −
                                 K
                                 
                                 min
                                 (
                                 H
                                 ,
                                 0
                                 )
                                 ,
                              
                           
                        where 
                           K
                         and 
                           H
                         are, respectively, the Gaussian and mean curvatures of I
                        
                           G
                        , the green channel image (see for instance in [20] the definition of these curvatures). This geometrical function was introduced in [21,22] as a protrusion measure for detecting colonic polyps (which are round-shaped protrusion objects) in wireless capsule endoscopy images. Mathematically, the value of the 
                           
                              
                                 OD
                              
                              
                                 loc
                              
                           
                         function is closely related to the size of the protrusions in the images. Therefore, the optic disc location in the frame can be inferred by identifying the locations where 
                           
                              
                                 OD
                              
                              
                                 loc
                              
                           
                         is higher. Hence, applying a threshold we can separate the candidate region(s) for the location of the optic disc. We extract the highest 15% of pixels of 
                           
                              
                                 OD
                              
                              
                                 loc
                              
                           
                        . The corresponding entire thresholded image is scanned to count the number of connected components. The connected components are found using an algorithm by Haralick and Shapiro [23]. For each connected component, in the thresholded image, we compute the area and the 
                           
                              
                                 OD
                              
                              
                                 loc
                              
                           
                         mean pixel intensity. The component corresponding to the maximum of the product between the area and the 
                           
                              
                                 OD
                              
                              
                                 loc
                              
                           
                         mean pixel intensity is considered to be the location of the OD. We then compute the centroid of the same component, which is identified with the estimated OD center and consequently the OD location.

The previous procedure only detects the location of the OD. Finally to segment the OD boundary from the retinal image we apply the circular Hough transform (see [20]).

The OD detection for a non-disease and a disease image (exhibiting BLs) is shown in Fig. 1
                        .

A microaneurysm is a round dark-red structure (a very small spot whose size is approximately less than 125μm in its longest dimension) caused by thickening of capillary basement membranes within the retina. We have observed that MAs are visible and enhanced at wavelet level W
                        2, or at the sum of wavelets levels W
                        2 and W
                        3, of the green channel of the input fundus image. These facts have motivated us to devise a MA detector, based on circular blob detection in these two wavelet images, as described in the sequel of the current section. We rely on Hessian multiscale analysis and corresponding eigenvalues properties: we first perform different pre-processing steps in the low wavelets׳ sub-bands, to enhance the MAs and suppress unwanted structures, then we explicitly build a scale-adapted blob-like function and finally use a simple thresholding approach for classification.

For each image we take 
                              I
                              ≔
                              
                                 
                                    I
                                 
                                 
                                    G
                                 
                              
                            (in Section 2.2), with I
                           
                              G
                            being the green channel of the input fundus image, and we compute (1), i.e. 
                           
                              
                                 
                                    I
                                 
                                 
                                    n
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    j
                                    =
                                    2
                                 
                                 
                                    n
                                 
                              
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                              ,
                            
                           n=2, 3. Then, we extract the 20% darkest pixels within the FOV of I
                           
                              n
                            to identify the MA candidates. Afterwards we take the product of this thresholded image with I
                           
                              n
                           , denote this product by T
                           
                              n
                           , and remove from it the pixels corresponding to the vessels and OD.

The segmentation of the vessels is done by using an approach similar to [24]. Briefly it includes the following procedure described in points (i)–(iii) : (i) We compute the sum of the wavelet levels W
                           2 and W
                           3 of the green channel of the image and extract the darkest 10% of the pixels within the FOV of the same. (ii) The vasculature can be seen as a large connected structure in the binary image, along with some isolated small objects, which are removed from the binary image. In a similar way we fill small holes present within the thresholded regions. (iii) We remove objects of size less than 150 pixels and fill holes of size smaller than 20 pixels.

After removing the vessels from T
                           
                              n
                            we also apply to T
                           
                              n
                            the adaptive Wiener filter, using neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                           , for smoothing and enhancing. This filter is a type of linear filter that performs little smoothing when the variance is large and more smoothing when it is small. For implementing it we have used the wiener2 function of the software 
                              
                                 
                                    
                                       MATLAB
                                    
                                 
                                 
                                    ®
                                 
                              
                            R2012a (The Mathworks, Inc.). This function uses a pixel-wise adaptive Wiener method based on statistics (like the image mean and standard deviation) estimated from a local neighborhood of each pixel.

After applying the adaptive Wiener filter we have observed that there are still some elongated structures left in 
                              
                                 
                                    T
                                 
                                 
                                    n
                                 
                              
                           . To remove them we apply a technique similar to the vessel segmentation. We take the sum of the wavelet levels 
                              
                                 
                                    W
                                 
                                 
                                    1
                                 
                              
                              ,
                            
                           W
                           2 and W
                           3 of T
                           
                              n
                            and extract the darkest 10% of the pixels within the FOV of the same. From the same binary image we remove objects of size less than 75 pixels and fill holes of size smaller than 20 pixels. The pixels corresponding to the resulting binary image are then removed from T
                           
                              n
                            and the corresponding image is denoted by 
                              
                                 
                                    F
                                 
                                 
                                    n
                                 
                              
                           . Afterwards, we perform the inversion of the image in the following way:
                              
                                 (8)
                                 
                                    
                                       
                                          M
                                       
                                       
                                          n
                                          ;
                                          i
                                          ,
                                          j
                                       
                                    
                                    ≔
                                    (
                                    
                                       
                                          
                                             max
                                             
                                          
                                          
                                             i
                                             ,
                                             j
                                          
                                       
                                       
                                          
                                             F
                                          
                                          
                                             n
                                             ;
                                             i
                                             ,
                                             j
                                          
                                       
                                    
                                    )
                                    −
                                    
                                       
                                          F
                                       
                                       
                                          n
                                          ;
                                          i
                                          ,
                                          j
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    i
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          x
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    j
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          y
                                       
                                    
                                    ,
                                 
                              
                           where N
                           
                              x
                            and N
                           
                              y
                            are the width and the height of the image F
                           
                              n
                            in pixels, respectively. We then look for blob structures in each image M
                           
                              n
                            (n=2, 3), using the eigenvalues of the Hessian matrix of M
                           
                              n
                            and multiscale image analysis (as described in Section 2.3, with 
                              I
                              ≔
                              
                                 
                                    M
                                 
                                 
                                    n
                                 
                              
                           ). Hence, at each point of the domain we define the functions, see (2): 
                              
                                 
                                    
                                       
                                          MA
                                       
                                       
                                          n
                                       
                                    
                                    ≔
                                    
                                       
                                          max
                                       
                                       
                                          
                                             
                                                s
                                             
                                             
                                                min
                                             
                                          
                                          ≤
                                          s
                                          ≤
                                          
                                             
                                                s
                                             
                                             
                                                max
                                             
                                          
                                       
                                    
                                    (
                                    
                                       
                                          
                                             B
                                          
                                          
                                             s
                                          
                                       
                                       ·
                                       
                                          
                                             M
                                          
                                          
                                             n
                                          
                                       
                                    
                                    )
                                    ,
                                    
                                    n
                                    =
                                    2
                                    ,
                                    
                                    3
                                 
                              
                           where s
                           
                              min
                            and s
                           
                              max
                            are, respectively, the minimum and maximum scales at which the MAs are expected to be found. For our experiments we consider scale s to vary between 2 and 8.
                        

Finally, we consider the maximum of each function 
                              
                                 
                                    MA
                                 
                                 
                                    n
                                 
                              
                            as an input to our MA binary classifier (or equivalently the Ma detector), see (3): 
                              
                                 
                                    
                                       
                                          MA
                                       
                                       
                                          n
                                       
                                       
                                          max
                                       
                                    
                                    ≔
                                    
                                       
                                          max
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    
                                       
                                          MA
                                       
                                       
                                          n
                                          ;
                                          i
                                          ,
                                          j
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    i
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          x
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    j
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          y
                                       
                                    
                                    ,
                                    
                                    n
                                    =
                                    2
                                    ,
                                    
                                    3
                                    .
                                 
                              
                           Consequently, if for a frame
                              
                                 (9)
                                 
                                    (
                                    
                                       
                                          MA
                                       
                                       
                                          2
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          MA
                                       
                                       
                                          2
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          MA
                                       
                                       
                                          3
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          MA
                                       
                                       
                                          3
                                       
                                       
                                          L
                                       
                                    
                                    )
                                 
                              
                           then it is classified as a frame containing a MA, otherwise the frame is considered to be a normal frame. Here the pair of lower bounds 
                              (
                              
                                 
                                    MA
                                 
                                 
                                    2
                                 
                                 
                                    L
                                 
                              
                              ,
                              
                                 
                                    MA
                                 
                                 
                                    3
                                 
                                 
                                    L
                                 
                              
                              )
                            filters out frames that are unlikely to have MAs (in the experiments we consider the values (3.5, 5.5), see Table 2
                            in Section 4).

The previous functions, I
                           2, I
                           3, 
                              
                                 
                                    MA
                                 
                                 
                                    2
                                 
                              
                           , 
                              
                                 
                                    MA
                                 
                                 
                                    3
                                 
                              
                           , involved in the definition of the MA detector are illustrated in Fig. 2
                            for two retinal fundus images exhibiting MAs.


                           MA Criterion schematic summary:
                              
                                 1.
                                 For a frame compute, for the green channel, the two wavelet sums 
                                       ⟶
                                       
                                          
                                             I
                                          
                                          
                                             n
                                          
                                       
                                       =
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             2
                                          
                                          
                                             n
                                          
                                       
                                       
                                          
                                             W
                                          
                                          
                                             j
                                          
                                       
                                    , n=2,3.

Extract the 20% darkest pixels in I
                                    
                                       n
                                     
                                    
                                       ⟶
                                     get images T
                                    
                                       n
                                    , n=2, 3.

Remove from T
                                    
                                       n
                                     the vessels and OD 
                                       ⟶
                                     get images F
                                    
                                       n
                                    , n=2, 3.

Reverse images F
                                    
                                       n
                                     
                                    
                                       ⟶
                                     get images M
                                    
                                       n
                                    , n=2, 3.

Look for blob structures in M
                                    
                                       n
                                     
                                    
                                       ⟶
                                     get the scalar values 
                                       
                                          
                                             MA
                                          
                                          
                                             n
                                          
                                          
                                             max
                                          
                                       
                                    , n=2, 3.

Final decision criterion 
                                       ⟶
                                     if 
                                       (
                                       
                                          
                                             MA
                                          
                                          
                                             2
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             MA
                                          
                                          
                                             2
                                          
                                          
                                             L
                                          
                                       
                                       )
                                       ∧
                                       (
                                       
                                          
                                             MA
                                          
                                          
                                             3
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             MA
                                          
                                          
                                             3
                                          
                                          
                                             L
                                          
                                       
                                       )
                                    , the frame is positive (
                                       
                                          
                                             MA
                                          
                                          
                                             2
                                          
                                          
                                             L
                                          
                                       
                                     and 
                                       
                                          
                                             MA
                                          
                                          
                                             3
                                          
                                          
                                             L
                                          
                                       
                                     are fixed thresholds).

Retinal hemorrhage is the abnormal bleeding of the blood vessels in the retina. Hemorrhages are very difficult to detect due to their variability in appearance (size, color, shape and texture). In general they appear as darker regions with brighter surroundings. Additional difficulties to automated detection arise when for example there are hemorrhages whose contrast against the background is very weak or when the hemorrhages are connected to the eye vasculature. It is important for doctors to have an information of the hemorrhage size. In effect, as reported in [10] “the size of the lesion is another important factor to consider, because it is closely related to the severity of disease that needs timely treatment”. Large hemorrhages (that occur infrequently and have a highly variable appearance) indicate more severe disease.

Based on clinical information and on our experimental image observation, we have defined three criteria for HEMs : HEM Criteria 1, 2 and 3 (the last one includes 3 sub-criteria depending on hemorrhage size). Therefore there is a total of five criteria for HEMs. In particular, the HEM Criterion 3, proposed in the paper, permits us to give an approximate size of the medium/large size hemorrhages and thus it is an extra information that is related to the severity of the disease.

Then a frame is considered as containing an HEM if it satisfies at least one of these five criteria. The motivation for the definition of each criterion (that relies essentially on the hemorrhage visible information) is justified for each case. The input for each HEM criterion is always the green channel of the retinal fundus image, because it exhibits the best contrast for visual HEM detection in wavelets bands.

This first criterion is targeted for small dot hemorrhages and is quite similar to the detection of MAs. The main difference is that because hemorrhages have a bigger size than MAs, and as we know that larger features are visible with improved contrast on higher wavelet levels, we use 
                              
                                 
                                    I
                                 
                                 
                                    4
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    j
                                    =
                                    2
                                 
                                 
                                    4
                                 
                              
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                            (see (1), where the input scalar image is the green channel of the fundus image), instead of I
                           2 or I
                           3 as for MAs. To identify the hemorrhage regions we extract the 20% darkest pixels in I
                           4, which we call 
                              
                                 
                                    R
                                 
                                 
                                    h
                                 
                              
                           . As small hemorrhages are known to be medium size dark red spots, we create a binary mask by extracting objects of size between 40 and 500 pixels from R
                           
                              h
                            and call this mask 
                              
                                 
                                    M
                                 
                                 
                                    h
                                 
                              
                           . Finally, we consider the product 
                              
                                 
                                    I
                                 
                                 
                                    4
                                 
                              
                              ·
                              
                                 
                                    M
                                 
                                 
                                    h
                                 
                              
                              ,
                            and remove the pixels corresponding to the OD. To the resulting image we apply the adaptive Wiener filter using neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                            and do the inversion similar to (8) to get the image 
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                           . As a result of these thresholding and smoothing operations, the HEM lesions appear as isolated bright patches or blobs outstanding to their surroundings in 
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                           .

We then look for blob structures in 
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                              ,
                            using the technique described previously in Section 2.3 (with 
                              I
                              ≔
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                           ), and where now s
                           
                              min
                            and s
                           
                              max
                            are, respectively, the minimum and maximum scales at which the HEMs are expected to be found (in the experiments the scale s varies between 2 and 12, more precisely 
                              s
                              =
                              [
                              2
                              
                              5
                              
                              8
                              
                              10
                              
                              12
                              ]
                           , see Table 3
                           ). From that we get the measure 
                              
                                 
                                    HEM
                                 
                                 
                                    max
                                 
                              
                            for our binary classifier (see (3)).

If the frame passes the criterion
                              
                                 (10)
                                 
                                    
                                       
                                          HEM
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          HEM
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                1
                                             
                                          
                                       
                                    
                                 
                              
                           then the frame is labelled as an hemorrhage frame. The threshold 
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          1
                                       
                                    
                                 
                              
                            is chosen very high (12 in the experiments, see Table 2 in Section 4) so that we can detect HEM with marginal false positives. In Fig. 3
                           , the subfigure (d) depicts the blob function, and there for this particular frame we can see that 
                              
                                 
                                    HEM
                                 
                                 
                                    max
                                 
                              
                            attains a value lower than 12.


                           HEM Criterion 1 schematic summary:
                              
                                 1.
                                 For a frame compute, for the green channel, the wavelet sum 
                                       ⟶
                                       
                                          
                                             I
                                          
                                          
                                             4
                                          
                                       
                                       =
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             4
                                          
                                          
                                             n
                                          
                                       
                                       
                                          
                                             W
                                          
                                          
                                             j
                                          
                                       
                                    .

Extract the 20% darkest pixels in I
                                    4 
                                    
                                       ⟶
                                     get image R
                                    
                                       h
                                    .

Extract from R
                                    
                                       h
                                     objects of size between 40 and 500 pixels 
                                       ⟶
                                     get binary mask M
                                    
                                       h
                                    .

Remove from 
                                       
                                          
                                             I
                                          
                                          
                                             4
                                          
                                       
                                       ·
                                       
                                          
                                             M
                                          
                                          
                                             h
                                          
                                       
                                     the OD and reverse the resulting image 
                                       ⟶
                                     get image H
                                    
                                       h
                                    .

Look for blob structures in H
                                    
                                       h
                                     
                                    
                                       ⟶
                                     get the scalar value 
                                       
                                          
                                             HEM
                                          
                                          
                                             max
                                          
                                       
                                    .

Final decision criterion 
                                       ⟶
                                     if 
                                       
                                          
                                             HEM
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             HEM
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   1
                                                
                                             
                                          
                                       
                                    , the frame is positive (
                                       
                                          
                                             HEM
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   1
                                                
                                             
                                          
                                       
                                     is a fixed threshold).

One of the most common types of hemorrhage is a red spot, with uneven density and surrounding a smaller punctuate lesion considered to be a MA. This second criterion is a procedure that intends to quantify this property, and in short it can be defined as HEM Criterion 1 with two extra features that enforce this particular property. We compute essentially a set of features from H
                           
                              h
                            and also use 
                              
                                 
                                    HEM
                                 
                                 
                                    max
                                 
                              
                            (H
                           
                              h
                            and 
                              
                                 
                                    HEM
                                 
                                 
                                    max
                                 
                              
                            are both defined in HEM Criterion 1), to describe these HEM characteristics.

We use a binary segmentation via thresholding of H
                           
                              h
                           , such that for a pixel x 
                           
                              
                                 
                                    S
                                    (
                                    x
                                    )
                                    ≔
                                    H
                                    (
                                    
                                       
                                          H
                                       
                                       
                                          h
                                       
                                    
                                    (
                                    x
                                    )
                                    −
                                    γ
                                    )
                                 
                              
                           where 
                              H
                            is the Heaviside function taken pixel-wise: 
                              
                                 
                                    H
                                    (
                                    z
                                    )
                                    ≔
                                    {
                                    
                                       
                                          
                                             
                                                0
                                             
                                             
                                                if
                                                
                                                z
                                                <
                                                0
                                                ,
                                             
                                          
                                          
                                             
                                                1
                                             
                                             
                                                if
                                                
                                                z
                                                ≥
                                                0
                                                ,
                                             
                                          
                                       
                                    
                                 
                              
                           and the scalar threshold γ is defined by 
                              
                                 
                                    γ
                                    ≔
                                    
                                       
                                          1
                                       
                                       
                                          2
                                       
                                    
                                    
                                    
                                       
                                          max
                                       
                                       
                                          i
                                          ,
                                          j
                                       
                                    
                                    
                                       
                                          H
                                       
                                       
                                          h
                                          ;
                                          i
                                          ,
                                          j
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    i
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          x
                                       
                                    
                                    ,
                                    
                                    1
                                    ≤
                                    j
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          y
                                       
                                    
                                    .
                                 
                              
                           Then we find the connected components of the binary image S using an algorithm by Haralick and Shapiro [23]. For each connected component we compute the mean pixel intensity in 
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                           .

We consider the maximum of the mean intensities as a feature for our binary classification and denote it by 
                              
                                 
                                    H
                                 
                                 
                                    mean
                                 
                              
                           . Since we expect the mean of the pixels to be high in a HEM, the component corresponding to the maximum mean locates a selected HEM region. We also compute the eccentricity of this component, corresponding to the maximum mean, and denote it by 
                              
                                 
                                    H
                                 
                                 
                                    ecc
                                 
                              
                           . This eccentricity feature is useful since we expect the selected HEM region to be round in shape after the thresholding and smoothing operations performed before, and according to the aforementioned definition of this kind of hemorrhages (a red spot, with uneven density and surrounding a smaller punctuate lesion).

Finally criterion 2 is
                              
                                 (11)
                                 
                                    (
                                    
                                       
                                          HEM
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          HEM
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                2
                                             
                                          
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          H
                                       
                                       
                                          mean
                                       
                                    
                                    ≥
                                    
                                       
                                          H
                                       
                                       
                                          mean
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          H
                                       
                                       
                                          ecc
                                       
                                    
                                    ≤
                                    
                                       
                                          H
                                       
                                       
                                          ecc
                                       
                                       
                                          U
                                       
                                    
                                    )
                                    .
                                 
                              
                           The frame is checked for this criterion. If it passes, then it is classified as a HEM frame, otherwise we continue to the next criterion of our HEMs classification. The lower bounds 
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          2
                                       
                                    
                                 
                              
                           , 
                              
                                 
                                    H
                                 
                                 
                                    mean
                                 
                                 
                                    L
                                 
                              
                            and the upper bound 
                              
                                 
                                    H
                                 
                                 
                                    ecc
                                 
                                 
                                    U
                                 
                              
                            discard frames without HEMs (the chosen values in the experiments are 6, 9 and 0.7, respectively, see Table 2 in Section 4).

The main steps of this HEM Criterion 2 are illustrated in Fig. 3.


                           HEM Criterion 2 schematic summary:
                              
                                 1.
                                 For a frame, consider the image H
                                    
                                       h
                                     and the scalar value 
                                       
                                          
                                             HEM
                                          
                                          
                                             max
                                          
                                       
                                     (defined in HEM Criterion 1 summary).

Apply a binary segmentation via thresholding to H
                                    
                                       h
                                     
                                    
                                       ⟶
                                     get the binary image S.

Find the connected components in S and compute for each one, the mean pixel intensity in H
                                    
                                       h
                                     and then their maximum H
                                    
                                       mean
                                    .

For the component in S, corresponding to H
                                    
                                       mean
                                    , compute its eccentricity H
                                    
                                       ecc
                                    .

Final decision criterion 
                                       ⟶
                                     if 
                                       (
                                       
                                          
                                             HEM
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             HEM
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                       )
                                       ∧
                                       (
                                       
                                          
                                             H
                                          
                                          
                                             mean
                                          
                                       
                                       ≥
                                       
                                          
                                             H
                                          
                                          
                                             mean
                                          
                                          
                                             L
                                          
                                       
                                       )
                                       ∧
                                       (
                                       
                                          
                                             H
                                          
                                          
                                             ecc
                                          
                                       
                                       ≤
                                       
                                          
                                             H
                                          
                                          
                                             ecc
                                          
                                          
                                             U
                                          
                                       
                                       )
                                    , the frame is positive (
                                       
                                          
                                             HEM
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                    , 
                                       
                                          
                                             H
                                          
                                          
                                             mean
                                          
                                          
                                             L
                                          
                                       
                                     and 
                                       
                                          
                                             H
                                          
                                          
                                             ecc
                                          
                                          
                                             U
                                          
                                       
                                     are fixed thresholds).

This final criterion is directed to medium/large HEMs and includes 3 subcriteria denoted by 3-a, 3-b and 3-c. It is based on different sizes of HEMs. Essentially we look for three sizes of hemorrhages regardless of their shapes: between 100 and 500 pixels, or between 500 and 1100 pixels, or big objects but less than 1500 pixels.

To this end, and for each size class, we basically perform, firstly, a suitable segmentation of the HEM regions in the frame, then select (with an appropriate procedure that involves the cartoon part of the image) the best candidate hemorrhage region and finally quantify some features in this selected candidate. In particular we use an appropriate procedure that involves the measurement of the feature solidity of the hemorrhage (broadly it measures the hemorrhage width), needed for the binary HEM classification. We explain with all the details Criterion 3-a, and shorten the descriptions of Criteria 3-b and 3-c, which are similar.


                           HEM Criterion 3-a: To be able to locate the HEMs and to achieve a better segmentation, we first enhance and smooth the HEMs that consequently will display a more roundish shape. To this end we compute the Laplacian of H
                           
                              h
                            (defined in HEM Criterion 1, but using the adaptive Wiener filter with neighborhoods of size 
                              [
                              25
                              ,
                              25
                              ]
                           ). We set
                              
                                 (12)
                                 
                                    
                                       
                                          L
                                       
                                       
                                          s
                                       
                                    
                                    ≔
                                    −
                                    
                                       
                                          s
                                       
                                       
                                          2
                                       
                                    
                                    Δ
                                    
                                       
                                          G
                                       
                                       
                                          s
                                       
                                    
                                    ⁎
                                    
                                       
                                          H
                                       
                                       
                                          h
                                       
                                    
                                    ,
                                 
                              
                           where G
                           
                              s
                            is a Gaussian kernel of variance s, Δ is the Laplacian operator and ⁎ represents the convolution. Taking the maximum with respect to the scales we get
                              
                                 (13)
                                 
                                    L
                                    ≔
                                    
                                       
                                          max
                                       
                                       
                                          
                                             
                                                s
                                             
                                             
                                                min
                                             
                                          
                                          ≤
                                          s
                                          ≤
                                          
                                             
                                                s
                                             
                                             
                                                max
                                             
                                          
                                       
                                    
                                    
                                       
                                          L
                                       
                                       
                                          s
                                       
                                    
                                    ,
                                 
                              
                           (in the experiments the scale vector 
                              s
                              =
                              [
                              10
                              
                              12
                              
                              14
                              
                              16
                              ]
                           , see Table 3). We then normalize the pixel intensity values of L and H
                           
                              h
                            in the range 0–255 and to emphasize the hemorrhage regions we consider the sum 
                              
                                 
                                    D
                                 
                                 
                                    h
                                 
                              
                              ≔
                              L
                              +
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                              
                           . Secondly, we apply the blob detection algorithm described previously in Section 2.3 to D
                           
                              h
                            and denote the resulting image by P
                           
                              h
                            (that is in (2) 
                           
                              I
                              ≔
                              
                                 
                                    D
                                 
                                 
                                    h
                                 
                              
                           , B is denoted by P
                           
                              h
                            and in the experiments the scale vector 
                              s
                              =
                              [
                              10
                              
                              12
                              
                              14
                              
                              16
                              ]
                           ). We now perform the two-phase variational segmentation, described in Section 2.5, on the scalar image 
                              
                                 
                                    P
                                 
                                 
                                    h
                                 
                              
                              ,
                            aiming at separating the hemorrhage regions, from the other parts: the segmentation mask is denoted by u and contains the HEM candidates.

Decomposing 
                              
                                 
                                    I
                                 
                                 
                                    4
                                 
                              
                              =
                              
                                 
                                    C
                                 
                                 
                                    h
                                 
                              
                              +
                              
                                 
                                    T
                                 
                                 
                                    h
                                 
                              
                              ,
                            into the cartoon (geometric) part C
                           
                              h
                            and the texture (oscillatory) part T
                           
                              h
                           , using the algorithm of Section 2.4, we set then 
                              
                                 
                                    S
                                 
                                 
                                    h
                                 
                              
                              =
                              
                                 
                                    C
                                 
                                 
                                    h
                                 
                              
                              ·
                              
                                 
                                    R
                                 
                                 
                                    h
                                 
                              
                              ·
                              u
                            (where R
                           
                              h
                            is defined in HEM Criterion 1 in Section 3.3.1 and corresponds to the binary image containing the 20% darkest pixels within the FOV of I
                           4), for discarding some superfluous segments from the segmentation mask u. In S
                           
                              h
                            we use C
                           
                              h
                           , because as HEMs appear as medium/large size geometric objects in I
                           4, they go to the cartoon part C
                           
                              h
                            (rather than to T
                           
                              h
                           ). For each connected component in S
                           
                              h
                            we compute the area and the mean intensity of the pixels. Afterwards, we consider at most five components corresponding to the higher values of the product between the area and the mean intensity for the location of the HEMs. The resulting group of components is denoted by 
                              C
                              ,
                            and constitutes the 5 hemorrhage candidates.

Then, within the FOV of the sum of the wavelet levels W
                           2 and 
                              
                                 
                                    W
                                 
                                 
                                    3
                                 
                              
                              ,
                            we compute the darkest 10% pixels. From the resulting image a binary image is created and the objects of size less than 150 pixels are removed and the holes of size smaller than 20 pixels are filled. We denote the resulting binary image by 
                              
                                 
                                    Q
                                 
                                 
                                    h
                                 
                              
                              ,
                            which typically in normal frames will contain a part of the vessel network, that is crossed tube-like structures. We shall compute some measures for hemorrhage classification from Q
                           
                              h
                            for the 3 criteria (HEM Criteria 3-a, 3-b, 3-c).

In this first Criterion 3-a we quantify some properties related to HEMs of size between 100 and 500 pixels from a binary image M
                           
                              h
                           
                           
                              a
                           , created by extracting the 20% darkest pixels from I
                           4 and afterwards selecting objects of size between 100 and 500 pixels. Then to the product 
                              
                                 
                                    I
                                 
                                 
                                    4
                                 
                              
                              .
                              
                                 
                                    M
                                 
                                 
                                    h
                                 
                                 
                                    a
                                 
                              
                            we proceed exactly as in HEM Criterion 1 to generate an image H
                           
                              h
                           
                           
                              a
                            for which we compute 
                              
                                 
                                    HEM
                                 
                                 
                                    a
                                 
                                 
                                    max
                                 
                              
                            (following the technique of Section 2.3, with 
                              I
                              ≔
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                                 
                                    a
                                 
                              
                            and in the experiments the scale vector 
                              s
                              =
                              [
                              5
                              
                              8
                              
                              10
                              
                              12
                              ]
                           , see Table 3), where the subscript letter a symbolizes Criterion 3-a.

If the location of the previous value 
                              
                                 
                                    HEM
                                 
                                 
                                    a
                                 
                                 
                                    max
                                 
                              
                            matches with the location of a candidate region in 
                              C
                              ,
                            then probably, this candidate region, hereafter denoted by c
                           
                              match
                           
                           
                              a
                           , is an hemorrhage (if there is no match found then we continue to the next step, HEM criterion 3-b). To be sure we perform the following further analysis: based on the location of the centroid of c
                           
                              match
                           
                           
                              a
                            we define a region of interest (ROI) of size 60×60 pixels in Q
                           
                              h
                           . In the ROI we look for the object which is at the minimum Euclidean distance from the centroid of c
                           
                              match
                           
                           
                              a
                           . For the same object we compute the solidity (a scalar value specifying the proportion of the pixels in the convex hull of the object that are also in the object) and denote it by 
                              
                                 
                                    S
                                 
                                 
                                    a
                                 
                              
                           . We remark that, if c
                           
                              match
                           
                           
                              a
                            happens to be an hemorrhage, the solidity measures the width of this hemorrhage in Q
                           
                              h
                           , thus a high value, i.e. close to one, for the solidity, is an indicator of an hemorrhage. In fact, in normal frames the ROI, that is included in Q
                           
                              h
                           , will display only crossed tube-like structures, for which the solidity has a low value.

If for the frame the following condition is satisfied:
                              
                                 (14)
                                 
                                    (
                                    
                                       
                                          HEM
                                       
                                       
                                          a
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          HEM
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                3
                                             
                                          
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          S
                                       
                                       
                                          a
                                       
                                    
                                    ≥
                                    
                                       
                                          S
                                       
                                       
                                          a
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    ,
                                 
                              
                           (where 
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          3
                                       
                                    
                                 
                              
                            and 
                              
                                 
                                    S
                                 
                                 
                                    a
                                 
                                 
                                    L
                                 
                              
                            are pre-defined values) then the frame is a HEM frame, else we continue to look for the objects of other sizes.


                           HEM Criterion 3-b: This criterion is similar to the previous HEM Criterion 3-a (including formulas (12), (13) and the group of candidates 
                              C
                           , obtained via I
                           4). The only difference now is that we extract the 20% darkest pixels from the sum of wavelet levels up to level 5, i.e. 
                           
                              
                                 
                                    I
                                 
                                 
                                    5
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    j
                                    =
                                    2
                                 
                                 
                                    5
                                 
                              
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                           , and then from there we select the objects of size between 500 and 1100 pixels, to create the binary image M
                           
                              h
                           
                           
                              b
                           . Again we consider the product of I
                           5 and M
                           
                              h
                           
                           
                              b
                           , remove from it the OD, and the resulting image is smoothed using the adaptive Wiener filter of neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                           . We obtain an image H
                           
                              h
                           
                           
                              b
                            (as in the previous criterion) and applying the blob detection technique of Section 2.3 to H
                           
                              h
                           
                           
                              b
                            (in the experiments the scale vector is 
                              s
                              =
                              [
                              10
                              
                              12
                              
                              14
                              
                              16
                              ]
                           ) we obtain the scalar value 
                              
                                 
                                    HEM
                                 
                                 
                                    b
                                 
                                 
                                    max
                                 
                              
                           , where the subscript letter b symbolizes Criterion 3-b.

If the location of 
                              
                                 
                                    HEM
                                 
                                 
                                    b
                                 
                                 
                                    max
                                 
                              
                            matches with the location of a candidate region in 
                              C
                            (as defined exactly in HEM Criterion 3-a), denoted by c
                           
                              match
                           
                           
                              b
                           , then based on the location of the centroid of c
                           
                              match
                           
                           
                              b
                            we apply the previously described procedure for checking the matching in Q
                           
                              h
                            (creating a ROI, as explained in HEM Criterion 3-a) and obtain the solidity measure 
                              
                                 
                                    S
                                 
                                 
                                    b
                                 
                              
                           . If there is no c
                           
                              match
                           
                           
                              b
                            candidate found, then we continue to the next step, HEM Criterion 3-c.

If for the frame
                              
                                 (15)
                                 
                                    (
                                    
                                       
                                          HEM
                                       
                                       
                                          b
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          HEM
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                4
                                             
                                          
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          S
                                       
                                       
                                          b
                                       
                                    
                                    ≥
                                    
                                       
                                          S
                                       
                                       
                                          b
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    ,
                                 
                              
                           (where 
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          4
                                       
                                    
                                 
                              
                            and 
                              
                                 
                                    S
                                 
                                 
                                    b
                                 
                                 
                                    L
                                 
                              
                            are pre-defined values) then the frame is a HEM frame, else we move to our final HEM step.


                           HEM Criterion 3-c: This criterion is again analogous to the previous HEM criteria (including formulas (12), (13) and the group of candidates 
                              C
                           , obtained via I
                           4). The main alteration is that the binary mask, denoted by M
                           
                              h
                           
                           
                              c
                           , is now created from the extraction of the 20% darkest pixels of I
                           5 and by removing objects of size less than 1500 pixels (in this process we also fill the holes of size smaller than 20 pixels). Again we consider the product of I
                           5 and M
                           
                              h
                           
                           
                              c
                           , remove from it the OD, and the resulting image is smoothed using the adaptive Wiener filter of neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                           . After that, the inversion is performed similar to (8) to obtain 
                              
                                 
                                    H
                                 
                                 
                                    h
                                 
                                 
                                    c
                                 
                              
                           . We again apply the blob detection technique of Section 2.3 to H
                           
                              h
                            (in the experiments the scale vector 
                              s
                              =
                              [
                              2
                              
                              5
                              
                              8
                              
                              10
                              
                              12
                              ]
                           ), to get a scalar value 
                              
                                 
                                    HEM
                                 
                                 
                                    c
                                 
                                 
                                    max
                                 
                              
                            (the subscript letter c symbolizes Criterion 3-c), whose location is used to obtain the solidity measure 
                              
                                 
                                    S
                                 
                                 
                                    c
                                 
                              
                           , by using the c
                           
                              match
                           
                           
                              c
                            candidate in 
                              C
                            that matches the location of 
                              
                                 
                                    HEM
                                 
                                 
                                    c
                                 
                                 
                                    max
                                 
                              
                            (in a similar way to the previous two criteria). If no match candidate c
                           
                              match
                           
                           
                              c
                            is found in the procedure, then the frame is considered to be a normal frame.

Our final criterion is
                              
                                 (16)
                                 
                                    (
                                    
                                       
                                          HEM
                                       
                                       
                                          c
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          HEM
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                5
                                             
                                          
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          S
                                       
                                       
                                          c
                                       
                                    
                                    ≥
                                    
                                       
                                          S
                                       
                                       
                                          c
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    .
                                 
                              
                           If the frame satisfies this criterion then it is considered to be a HEM frame, otherwise a normal frame.

Again in these Criteria 3-a, 3-b, 3-c, the pairs of lower bounds 
                              (
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          3
                                       
                                    
                                 
                              
                              ,
                              
                                 
                                    S
                                 
                                 
                                    a
                                 
                                 
                                    L
                                 
                              
                              )
                            , 
                              (
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          4
                                       
                                    
                                 
                              
                              ,
                              
                                 
                                    S
                                 
                                 
                                    b
                                 
                                 
                                    L
                                 
                              
                              )
                           , and 
                              (
                              
                                 
                                    HEM
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          5
                                       
                                    
                                 
                              
                              ,
                              
                                 
                                    S
                                 
                                 
                                    c
                                 
                                 
                                    L
                                 
                              
                              )
                            filter out frames that are unlikely to have HEMs. In the experiments we consider the values 
                              (
                              6
                              ,
                              0.7
                              )
                           , 
                              (
                              7
                              ,
                              0.7
                              )
                            and 
                              (
                              8
                              ,
                              0.7
                              )
                           , respectively (see Table 2 in Section 4).

The segmentation of the HEM candidates as well as the main steps of HEM Criteria 3a, 3-b and 3-c, for retinal images with HEMs, are displayed in Figs. 4, 5 and 6
                           
                           
                           , respectively.


                           HEM Criterion 3 schematic summary:
                              
                                 1.
                                 For a frame consider the image H
                                    
                                       h
                                     (defined in HEM Criterion 1 and by using an adaptive Wiener filter with neighborhoods of size 
                                    
                                       [
                                       25
                                       ,
                                       25
                                       ]
                                    ), compute its Laplacian L (after appropriately pre-processed), normalize both in the range 0–255 
                                       ⟶
                                     get the image 
                                       
                                          
                                             D
                                          
                                          
                                             h
                                          
                                       
                                       ≔
                                       
                                          
                                             H
                                          
                                          
                                             h
                                          
                                       
                                       +
                                       L
                                    .

From D
                                    
                                       h
                                     
                                    
                                       ⟶
                                     get the blob like function P
                                    
                                       h
                                    .

Apply the variational segmentation to P
                                    
                                       h
                                     
                                    
                                       ⟶
                                     get the segmentation mask u containing HEM candidates.

Decompose the wavelet sum 
                                       
                                          
                                             I
                                          
                                          
                                             4
                                          
                                       
                                       =
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             4
                                          
                                          
                                             n
                                          
                                       
                                       
                                          
                                             W
                                          
                                          
                                             j
                                          
                                       
                                     into cartoon+texture parts 
                                       ⟶
                                       
                                          
                                             I
                                          
                                          
                                             4
                                          
                                       
                                       =
                                       
                                          
                                             C
                                          
                                          
                                             h
                                          
                                       
                                       +
                                       
                                          
                                             T
                                          
                                          
                                             h
                                          
                                       
                                    .

Extract the 20% darkest pixels in I
                                    4, for obtaining image R
                                    
                                       h
                                     
                                    
                                       ⟶
                                     get 
                                       
                                          
                                             S
                                          
                                          
                                             h
                                          
                                       
                                       =
                                       
                                          
                                             C
                                          
                                          
                                             h
                                          
                                       
                                       ·
                                       
                                          
                                             R
                                          
                                          
                                             h
                                          
                                       
                                       ·
                                       u
                                    .

Find the connected components in S
                                    
                                       h
                                     and for each one compute the area and mean intensity of the pixels. Select the 5 components corresponding to the higher values of the product “mean intensity 
                                       ×
                                     area” 
                                       ⟶
                                     get C the group of these 5 candidates of HEMs.

Consider the wavelet sum 
                                       
                                          
                                             I
                                          
                                          
                                             3
                                          
                                       
                                       =
                                       
                                          
                                             W
                                          
                                          
                                             2
                                          
                                       
                                       +
                                       
                                          
                                             W
                                          
                                          
                                             3
                                          
                                       
                                    , extract the 10% darkest pixels 
                                       ⟶
                                     get the binary image Q
                                    
                                       h
                                     (for computing the solidity).


                                    HEM Criteria 3-a, 3-b, 3-c:
                                       
                                          (a)
                                          Extract from I
                                             4 the 20% darkest pixels and afterwards objects of size between 100 and 500 pixels 
                                                ⟶
                                              get the binary mask M
                                             
                                                h
                                             
                                             
                                                a
                                             , for Criterion 3-a. Extract from I
                                             5 the 20% darkest pixels and afterwards objects of size between 500 and 1100 pixels 
                                                ⟶
                                              get the binary mask M
                                             
                                                h
                                             
                                             
                                                b
                                             , for Criterion 3-b. Extract from I
                                             5 the 20% darkest pixels and afterwards objects of size less than 1500 pixels 
                                                ⟶
                                              get the binary mask M
                                             
                                                h
                                             
                                             
                                                c
                                             , for Criterion 3-c.

Remove the OD from the products 
                                                
                                                   
                                                      I
                                                   
                                                   
                                                      4
                                                   
                                                
                                                .
                                                
                                                   
                                                      M
                                                   
                                                   
                                                      h
                                                   
                                                   
                                                      a
                                                   
                                                
                                             , 
                                                
                                                   
                                                      I
                                                   
                                                   
                                                      5
                                                   
                                                
                                                .
                                                
                                                   
                                                      M
                                                   
                                                   
                                                      h
                                                   
                                                   
                                                      b
                                                   
                                                
                                             , 
                                                
                                                   
                                                      I
                                                   
                                                   
                                                      5
                                                   
                                                
                                                .
                                                
                                                   
                                                      M
                                                   
                                                   
                                                      h
                                                   
                                                   
                                                      c
                                                   
                                                
                                             , then reverse the resulting images 
                                                ⟶
                                              get the new images H
                                             
                                                h
                                             
                                             
                                                a
                                             , H
                                             
                                                h
                                             
                                             
                                                b
                                             , H
                                             
                                                h
                                             
                                             
                                                c
                                             .

Look for blob structures in H
                                             
                                                h
                                             
                                             
                                                a
                                             , H
                                             
                                                h
                                             
                                             
                                                b
                                             , H
                                             
                                                h
                                             
                                             
                                                c
                                              
                                             
                                                ⟶
                                              get the scalar values 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      a
                                                   
                                                   
                                                      max
                                                   
                                                
                                             , 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      b
                                                   
                                                   
                                                      max
                                                   
                                                
                                             , 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      c
                                                   
                                                   
                                                      max
                                                   
                                                
                                             .

If the location of 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      a
                                                   
                                                   
                                                      max
                                                   
                                                
                                              or 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      b
                                                   
                                                   
                                                      max
                                                   
                                                
                                              or 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      c
                                                   
                                                   
                                                      max
                                                   
                                                
                                              matches with the location of a candidate in C 
                                             
                                                ⟶
                                              define, respectively, ROI
                                                a
                                              or ROI
                                                b
                                              or ROI
                                                c
                                              (each with size 60×60 pixels) in Q
                                             
                                                h
                                             , centered at the centroid of the corresponding intersection component, respectively, c
                                             
                                                match
                                             
                                             
                                                a
                                              or c
                                             
                                                match
                                             
                                             
                                                b
                                              or c
                                             
                                                match
                                             
                                             
                                                c
                                             .

If there are matches (one up to three), then consider in each ROI
                                                a
                                              or ROI
                                                b
                                              or ROI
                                                c
                                              the objects closer to the centroids 
                                                ⟶
                                              compute the solidity 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      a
                                                   
                                                
                                              or 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      b
                                                   
                                                
                                              or 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      c
                                                   
                                                
                                              of each object.

Final decision criterion 
                                                ⟶
                                              if 
                                                (
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      a
                                                   
                                                   
                                                      max
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            3
                                                         
                                                      
                                                   
                                                
                                                )
                                                ∧
                                                (
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      a
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      a
                                                   
                                                   
                                                      L
                                                   
                                                
                                                )
                                             , or 
                                                (
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      b
                                                   
                                                   
                                                      max
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            4
                                                         
                                                      
                                                   
                                                
                                                )
                                                ∧
                                                (
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      b
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      b
                                                   
                                                   
                                                      L
                                                   
                                                
                                                )
                                              or 
                                                (
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      c
                                                   
                                                   
                                                      max
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            5
                                                         
                                                      
                                                   
                                                
                                                )
                                                ∧
                                                (
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      c
                                                   
                                                
                                                ≥
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      c
                                                   
                                                   
                                                      L
                                                   
                                                
                                                )
                                             , the frame is positive (
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            3
                                                         
                                                      
                                                   
                                                
                                             , 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            4
                                                         
                                                      
                                                   
                                                
                                             , 
                                                
                                                   
                                                      HEM
                                                   
                                                   
                                                      
                                                         
                                                            L
                                                         
                                                         
                                                            5
                                                         
                                                      
                                                   
                                                
                                             , 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      a
                                                   
                                                   
                                                      L
                                                   
                                                
                                             , 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      b
                                                   
                                                   
                                                      L
                                                   
                                                
                                             , and 
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      c
                                                   
                                                   
                                                      L
                                                   
                                                
                                              are fixed thresholds).

BLs (such as exudates) appear in general as small white or yellowish deposits in the retina. The herein proposed technique for the BLs detection is an improved and extended version of the approach presented by the authors in a conference paper in [25]. To detect BLs our strategy is based on identifying separately small and medium/large BL lesion regions. We propose three criteria. The first is similar to the MA Criterion and aims at identifying isolated small dot BLs (essentially we use a low wavelet level and there we look for bright dots using the scale-adapted blob-like function). After that, for the other two criteria we utilize the high wavelet levels and the corresponding texture+cartoon decomposition. In fact, by doing this decomposition, we have observed that clusters of small dotted BLs, that are spread across the image, are more prominent in the texture part. On the other hand, large/medium BL regions, that are more homogeneous, go to the cartoon part and, in general, create void or very smooth regions in the texture part. These facts are also in good agreement with the comments reported in Section 2.4, explaining the cartoon+texture decomposition. Finally, in the texture and cartoon parts we segment the regions with BLs, and in these segmented regions we quantify some geometric features for discriminating between retinal images with BLs and without BLs (namely the high oscillations and the holes generated in the image by the dotted BLs or the low or nonexistent oscillations when there are homogeneous large/medium BL regions).

This first criterion is proposed for prominent isolated dot BLs. We start by computing 
                              
                                 
                                    W
                                 
                                 
                                    2
                                 
                              
                              ,
                            the wavelet level at iteration 2 of the green channel image. Extracting the 20% highest pixels in W
                           2 we consider the product of the thresholded image with W
                           2 and remove the pixels corresponding to the OD. The resulting image denoted by F
                           
                              b
                            contains the small dotted BLs. To smooth and enhance these lesions, we apply the adaptive Wiener filter to F
                           
                              b
                            using neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                           . Consequently, the small dotted BLs appear as isolated bright patches or blobs outstanding to their surroundings. We then apply the previously described blob detection technique (of Section 2.3 and in the experiments the scale vector 
                              s
                              =
                              [
                              2
                              
                              5
                              
                              8
                              
                              11
                              
                              14
                              ]
                           , see Table 3) to the scalar image F
                           
                              b
                            and obtain the measure 
                              
                                 
                                    BL
                                 
                                 
                                    max
                                 
                              
                            (see (2)) for the binary classification. If
                              
                                 (17)
                                 
                                    
                                       
                                          BL
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          BL
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                1
                                             
                                          
                                       
                                    
                                 
                              
                           then the frame is classified as containing BLs (the lower bound 
                              
                                 
                                    BL
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          1
                                       
                                    
                                 
                              
                            discards frames without BL and its value is 11, see Table 2 in Section 4).


                           BL Criterion 1 schematic summary:
                              
                                 1.
                                 For a frame compute, for the green channel, the wavelet 
                                       ⟶
                                       
                                          
                                             I
                                          
                                          
                                             2
                                          
                                       
                                       =
                                       
                                          
                                             W
                                          
                                          
                                             2
                                          
                                       
                                    .

Extract the 20% darkest pixels in I
                                    2, remove from it the OD 
                                       ⟶
                                     get image F
                                    
                                       b
                                    .

Look for blob structures in F
                                    
                                       b
                                     
                                    
                                       ⟶
                                     get the scalar value 
                                       
                                          
                                             BL
                                          
                                          
                                             max
                                          
                                       
                                    .

Final decision criterion 
                                       ⟶
                                     if 
                                       
                                          
                                             BL
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             BL
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   1
                                                
                                             
                                          
                                       
                                    , the frame is positive (
                                       
                                          
                                             BL
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   1
                                                
                                             
                                          
                                       
                                     is a fixed threshold).

The approach for BL detection in [25] utilized only a criterion similar to (17). Our next two BL criteria are different from [25]. Now we look for clusters of small dotted BLs and also large/medium BLs that appear as more homogeneous structures. To describe these criteria we consider higher wavelet levels 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    j
                                    =
                                    2
                                 
                                 
                                    4
                                 
                              
                              
                                 
                                    W
                                 
                                 
                                    j
                                 
                              
                           , where W
                           
                              j
                            is the wavelet level at iteration j of the green channel of the image, as defined in (1). Let I
                           
                              b
                           
                           
                              t
                            denote the binary image corresponding to the 20% highest pixels in 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                           . We decompose I
                           
                              b
                            into 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                              =
                              
                                 
                                    C
                                 
                                 
                                    b
                                 
                              
                              +
                              
                                 
                                    T
                                 
                                 
                                    b
                                 
                              
                              ,
                            where C
                           
                              b
                            and T
                           
                              b
                            represent, respectively, the cartoon and texture decomposition of I
                           
                              b
                           , according to the algorithm of Section 2.4.

The BL Criterion 2 aims at identifying clusters of dotted BLs, and an additional motivation for defining this criterion is to avoid or decrease the number of possible failures of the BL Criterion 1. After some pre-processing steps, we convolve the textural part (of the sum of wavelet levels 2–4, of the green channel) with a Gaussian kernel, in order to smooth the target region containing the clusters of BLs and to be able to perform a two-phase segmentation for automatically locating the target region. Among the segmented regions the selected region is the one that matches the location of the maximum of the scale-adapted blob-like function in the wavelet level 2 (this is justified since we are searching for dotted BLs). Then we quantify some features in this selected region (namely the high oscillations and the holes generated in the image by the dotted BLs) for final classification.

To extract the candidate regions corresponding to clusters of dotted BLs spread regions, we perform the nonlinear convolution-type transform of 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                                 
                                    t
                                 
                              
                              ·
                              
                                 
                                    T
                                 
                                 
                                    b
                                 
                              
                            in the following way: 
                              
                                 
                                    
                                       
                                          χ
                                       
                                       
                                          t
                                       
                                    
                                    =
                                    
                                       
                                          L
                                       
                                       
                                          s
                                       
                                    
                                    (
                                    |
                                    
                                       
                                          I
                                       
                                       
                                          b
                                       
                                       
                                          t
                                       
                                    
                                    ·
                                    
                                       
                                          T
                                       
                                       
                                          b
                                       
                                    
                                    
                                       
                                          |
                                       
                                       
                                          τ
                                       
                                    
                                    )
                                    ,
                                 
                              
                           where 
                              
                                 
                                    L
                                 
                                 
                                    s
                                 
                              
                            is a linear operator convolving the image with a Gaussian kernel with variance 
                              s
                              =
                              15
                           , and τ is a positive scalar, such that 
                              τ
                              =
                              0.5
                              <
                              1
                            for de-emphasizing very small regions with strong texture (see [26], where we have used a similar argument). Here, the convolution is performed separably along each dimension.

After computing χ
                           
                              t
                            we apply a two-phase segmentation on χ
                           
                              t
                            as described in Section 2.5. As a result of this we obtain the segmentation mask containing the candidate BLs regions. After removing the pixels corresponding to the OD, we look for the region in the segmented mask that matches the location of the value 
                              
                                 
                                    BL
                                 
                                 
                                    max
                                 
                              
                            (defined in (17)), because if there is a match the probability of existing BLs in this location is high. The selected candidate is denoted by 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                           . Afterwards we compute two features in 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                              .
                           
                        

For the first feature, we sharpen the lesions by applying unsharp masking. The sharpening process works by utilizing a slightly blurred version of the image, that is 
                              
                                 
                                    
                                       
                                          U
                                       
                                       
                                          b
                                       
                                    
                                    =
                                    
                                       
                                          I
                                       
                                       
                                          b
                                       
                                       
                                          t
                                       
                                    
                                    ·
                                    
                                       
                                          T
                                       
                                       
                                          b
                                       
                                    
                                    +
                                    (
                                    
                                       
                                          I
                                       
                                       
                                          b
                                       
                                       
                                          t
                                       
                                    
                                    ·
                                    
                                       
                                          T
                                       
                                       
                                          b
                                       
                                    
                                    −
                                    
                                       
                                          χ
                                       
                                       
                                          t
                                       
                                    
                                    )
                                    .
                                 
                              
                           From 
                              
                                 
                                    U
                                 
                                 
                                    b
                                 
                              
                            we define the first feature 
                              
                                 
                                    N
                                 
                                 
                                    t
                                 
                              
                              =
                              (
                              1
                              /
                              |
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                              |
                              )
                              ∥
                              ∇
                              
                                 
                                    U
                                 
                                 
                                    b
                                 
                              
                              
                                 
                                    ∥
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          2
                                       
                                    
                                    (
                                    
                                       
                                          M
                                       
                                       
                                          t
                                       
                                    
                                    )
                                 
                              
                              ,
                            where 
                              |
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                              |
                            is the sum of the pixels in 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                           , ∇ is the gradient operator and 
                              ∥
                              ·
                              ∥
                            is the norm in 
                              
                                 
                                    L
                                 
                                 
                                    2
                                 
                              
                              (
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                              )
                           , the space of square-integrable functions in 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                           . A high value for 
                              
                                 
                                    N
                                 
                                 
                                    t
                                 
                              
                            indicates that 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                            is a high textured (oscillatory) region, and thus most probably a region with BLs.

Our next feature, in this criterion, is based on the observation that clusters of small dotted BLs, that are more spread, create holes in the vessel segmentation. We obtain the segmentation of the vessels from the sum of the wavelet levels W
                           2 and W
                           3 of the green channel image using the method described in Section 3.2. Then in the region resulting from the intersection of 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                            with the detected vessels we compute the feature 
                              E
                           , which is the difference between the number of components and the number of holes in the region (a negative value indicates many holes, and thus dotted BLs probably exist in 
                              
                                 
                                    M
                                 
                                 
                                    t
                                 
                              
                           ).

Finally the criterion for the detection of clusters of small dotted BLs is
                              
                                 (18)
                                 
                                    (
                                    
                                       
                                          BL
                                       
                                       
                                          max
                                       
                                    
                                    ≥
                                    
                                       
                                          BL
                                       
                                       
                                          
                                             
                                                L
                                             
                                             
                                                2
                                             
                                          
                                       
                                    
                                    )
                                    ∧
                                    (
                                    
                                       
                                          N
                                       
                                       
                                          t
                                       
                                    
                                    ≥
                                    
                                       
                                          N
                                       
                                       
                                          t
                                       
                                       
                                          L
                                       
                                    
                                    )
                                    ∧
                                    (
                                    E
                                    ≤
                                    
                                       
                                          E
                                       
                                       
                                          U
                                       
                                    
                                    )
                                    .
                                 
                              
                           If the frame satisfies this criterion, then it is a BL frame, otherwise we continue to our final criterion of the BL classification. In the experiments (see Table 2 in Section 4) the lower bounds BL
                              L
                           
                           2 and 
                              
                                 
                                    N
                                 
                                 
                                    t
                                 
                                 
                                    L
                                 
                              
                            are 6 and 3.3, respectively, and the upper bound 
                              
                                 
                                    E
                                 
                                 
                                    U
                                 
                              
                            is 0.

Fig. 7
                            illustrates the main computations, described in this BL Criterion 2, for one frame, with very bad quality, but clearly exhibiting a cluster of dotted BLs.


                           BL Criterion 2 schematic summary:
                              
                                 1.
                                 For a frame compute, for the green channel, the sum of wavelet levels 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                       
                                       =
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             4
                                          
                                          
                                             n
                                          
                                       
                                       
                                          
                                             W
                                          
                                          
                                             j
                                          
                                       
                                     and let I
                                    
                                       b
                                    
                                    
                                       t
                                     be the binary image corresponding to the highest 20% pixels in I
                                    
                                       b
                                    .

Decompose 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                       
                                       =
                                       
                                          
                                             C
                                          
                                          
                                             b
                                          
                                       
                                       +
                                       
                                          
                                             T
                                          
                                          
                                             b
                                          
                                       
                                       ,
                                     into cartoon C
                                    
                                       b
                                     and texture T
                                    
                                       b
                                    . Apply a convolution type transform to the thresholded textural part 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                          
                                             t
                                          
                                       
                                       .
                                       
                                          
                                             T
                                          
                                          
                                             b
                                          
                                       
                                     
                                    
                                       ⟶
                                     get χ
                                    
                                       t
                                    .

Apply the variational segmentation to χ
                                    
                                       t
                                     
                                    
                                       ⟶
                                     get the segmented mask containing the candidates of clusters of dotted BLs.

Remove the OD from the segmented mask and do the intersection with the location of 
                                       
                                          
                                             BL
                                          
                                          
                                             max
                                          
                                       
                                     (defined in BL Criterion 1 summary) 
                                       ⟶
                                     get the selected BL location candidate 
                                       
                                          
                                             M
                                          
                                          
                                             t
                                          
                                       
                                    .

Compute feature 
                                       
                                          
                                             N
                                          
                                          
                                             t
                                          
                                       
                                     in 
                                       
                                          
                                             M
                                          
                                          
                                             t
                                          
                                       
                                    , by using the gradient of the sharpened textural part 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                          
                                             t
                                          
                                       
                                       ·
                                       
                                          
                                             T
                                          
                                          
                                             b
                                          
                                       
                                     (it measures the oscillations generated by the dotted BLs).

Do the intersection of 
                                       
                                          
                                             M
                                          
                                          
                                             t
                                          
                                       
                                     with the retinal vessel network, and compute feature 
                                       E
                                     (it measures the number of holes generated by the dotted BLs).

Final decision criterion 
                                       ⟶
                                     if 
                                       (
                                       
                                          
                                             BL
                                          
                                          
                                             max
                                          
                                       
                                       ≥
                                       
                                          
                                             BL
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                       )
                                       ∧
                                       (
                                       
                                          
                                             N
                                          
                                          
                                             t
                                          
                                       
                                       ≥
                                       
                                          
                                             N
                                          
                                          
                                             t
                                          
                                          
                                             L
                                          
                                       
                                       )
                                       ∧
                                       (
                                       E
                                       ≤
                                       
                                          
                                             E
                                          
                                          
                                             U
                                          
                                       
                                       )
                                    , the frame is positive (
                                       
                                          
                                             BL
                                          
                                          
                                             
                                                
                                                   L
                                                
                                                
                                                   2
                                                
                                             
                                          
                                       
                                    , 
                                       
                                          
                                             N
                                          
                                          
                                             t
                                          
                                          
                                             L
                                          
                                       
                                     and 
                                       
                                          
                                             E
                                          
                                          
                                             U
                                          
                                       
                                     are fixed thresholds).

In our final BL Criterion 3 we look for large/medium BLs that appear to be more homogeneous in the images. Such regions are missed by the previous BL criteria. Instead of the textural part, like in BL Criterion 2, we now use the cartoon part (of the sum of wavelet levels 2–4, of the green channel), convolve it with a Gaussian kernel and then we perform a two-phase segmentation for automatically locating the target region. Among the segmented regions the selected region is the one that matches the location of the maximum of the scale-adapted blob-like function in the sum of wavelet levels 2 to 4. And then we quantify some appropriate features (namely the low or nonexistent oscillations in the textural part) in this selected region for final classification.

Firstly, we consider 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                              ·
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                                 
                                    t
                                 
                              
                            (I
                           
                              b
                           
                           
                              t
                            denotes the binary image corresponding to the 20% highest pixels in I
                           
                              b
                           ) and remove the pixels corresponding to the OD. We also apply the adaptive Wiener filter using neighborhoods of size 
                              [
                              15
                              ,
                              15
                              ]
                           . Similar to the procedure described in BL Criterion 1, for the wavelet level W
                           2, we apply the blob detection technique, starting from 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                              ·
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                                 
                                    t
                                 
                              
                            (and not W
                           2), and obtain the feature 
                              
                                 
                                    BL
                                 
                                 
                                    2
                                    :
                                    4
                                 
                                 
                                    max
                                 
                              
                            (as in (3) of Section 2.3, with the scale vector 
                              s
                              =
                              [
                              2
                              
                              5
                              
                              8
                              
                              11
                              
                              14
                              ]
                            for the experiments). The subscript 2:4 means that in I
                           
                              b
                            the sum of wavelet levels from 2 up to 4 is used.

Secondly, we extract the candidate regions corresponding to the large/medium BLs. These structures go to the cartoon part C
                           
                              b
                            (
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                              
                              =
                              
                                 
                                    C
                                 
                                 
                                    b
                                 
                              
                              +
                              
                                 
                                    T
                                 
                                 
                                    b
                                 
                              
                           ), and therefore we compute the nonlinear convolution-type transform of 
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                                 
                                    t
                                 
                              
                              ·
                              
                                 
                                    C
                                 
                                 
                                    b
                                 
                              
                           : 
                              
                                 
                                    
                                       
                                          χ
                                       
                                       
                                          c
                                       
                                    
                                    =
                                    
                                       
                                          L
                                       
                                       
                                          s
                                       
                                    
                                    (
                                    |
                                    
                                       
                                          I
                                       
                                       
                                          b
                                       
                                       
                                          t
                                       
                                    
                                    .
                                    
                                       
                                          C
                                       
                                       
                                          b
                                       
                                    
                                    
                                       
                                          |
                                       
                                       
                                          τ
                                       
                                    
                                    )
                                    ,
                                 
                              
                           with 
                              τ
                              =
                              0.5
                              <
                              1
                            and 
                              s
                              =
                              15
                           . Afterwards we perform a two-phase segmentation on χ
                           
                              c
                            (as described in Section 2.5) to get the segmentation mask containing the candidates. We then remove the pixels corresponding to the OD and search for the segmented region that matches the location of the 
                              
                                 
                                    BL
                                 
                                 
                                    2
                                    :
                                    4
                                 
                                 
                                    max
                                 
                              
                           , determined above, to get the selected candidate region 
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                            (when this match exists the probability of having BLs in the match location is high). Here we quantify some features, in order to define discriminant descriptors for classification.

We compute the maximum intensity value in the image region 
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                              ∩
                              (
                              
                                 
                                    
                                       C
                                    
                                    
                                       b
                                    
                                 
                                 .
                                 
                                    
                                       I
                                    
                                    
                                       b
                                    
                                    
                                       t
                                    
                                 
                              
                              )
                            and denote it by C
                           
                              max
                            (if it has a high value probably it corresponds to BLs). We also compute the feature 
                              
                                 
                                    N
                                 
                                 
                                    c
                                 
                              
                              =
                              (
                              1
                              /
                              |
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                              |
                              )
                              ∥
                              ∇
                              (
                              
                                 
                                    I
                                 
                                 
                                    b
                                 
                                 
                                    t
                                 
                              
                              .
                              
                                 
                                    T
                                 
                                 
                                    b
                                 
                              
                              )
                              
                                 
                                    ∥
                                 
                                 
                                    
                                       
                                          L
                                       
                                       
                                          2
                                       
                                    
                                    (
                                    
                                       
                                          M
                                       
                                       
                                          c
                                       
                                    
                                    )
                                 
                              
                              ,
                            where 
                              |
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                              |
                            is the sum of the pixels in 
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                            and 
                              
                                 
                                    L
                                 
                                 
                                    2
                                 
                              
                              (
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                              )
                            is the space of square-integrable functions in 
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                           . As opposed to 
                              
                                 
                                    N
                                 
                                 
                                    t
                                 
                              
                            in BL Criterion 2, a low value of 
                              
                                 
                                    N
                                 
                                 
                                    c
                                 
                              
                            indicates that 
                              
                                 
                                    M
                                 
                                 
                                    c
                                 
                              
                            is a cartoon region (since piecewise-smooth regions, that go to the cartoon part, should create void or smooth regions in the texture part, thus with corresponding small gradients).

Our final criterion is
                              
                                 (19)
                                 
                                    (
                                    
                                       
                                          B
                                       
                                       
                                          L
                                       
                                    
                                    ≤
                                    
                                       
                                          BL
                                       
                                       
                                          2
                                          :
                                          4
                                       
                                       
                                          max
                                       
                                    
                                    ≤
                                    
                                       
                                          B
                                       
                                       
                                          U
                                       
                                    
                                    )
                                    ∧
                                    
                                    (
                                    
                                       
                                          N
                                       
                                       
                                          c
                                       
                                       
                                          L
                                       
                                    
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          c
                                       
                                    
                                    ≤
                                    
                                       
                                          N
                                       
                                       
                                          c
                                       
                                       
                                          U
                                       
                                    
                                    )
                                    ∧
                                    
                                    (
                                    
                                       
                                          C
                                       
                                       
                                          L
                                       
                                    
                                    ≤
                                    
                                       
                                          C
                                       
                                       
                                          max
                                       
                                    
                                    ≤
                                    
                                       
                                          C
                                       
                                       
                                          U
                                       
                                    
                                    )
                                    .
                                 
                              
                           If the frame satisfies this criterion, then it is considered to be a BL frame, otherwise it is considered to be a normal frame. The values for the lower and upper bounds are indicated in Table 2 in Section 4. The upper bounds 
                              
                                 
                                    B
                                 
                                 
                                    U
                                 
                              
                            and 
                              
                                 
                                    C
                                 
                                 
                                    U
                                 
                              
                            are imposed for deleting frames with artifacts and 
                              [
                              
                                 
                                    N
                                 
                                 
                                    c
                                 
                                 
                                    L
                                 
                              
                              ,
                              
                                 
                                    N
                                 
                                 
                                    c
                                 
                                 
                                    U
                                 
                              
                              ]
                            is an estimated low valued interval for the feature 
                              
                                 
                                    N
                                 
                                 
                                    c
                                 
                              
                           . Fig. 8
                            displays the computations of this BL Criterion 3, for one frame which has medium/large BL lesions.


                           BL Criterion 3 schematic summary:
                              
                                 1.
                                 For a frame compute, for the green channel, the sum of wavelet levels 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                       
                                       =
                                       
                                          
                                             ∑
                                          
                                          
                                             j
                                             =
                                             4
                                          
                                          
                                             n
                                          
                                       
                                       
                                          
                                             W
                                          
                                          
                                             j
                                          
                                       
                                     and let I
                                    
                                       b
                                    
                                    
                                       t
                                     be the binary image corresponding to the highest 20% pixels in I
                                    
                                       b
                                    .

Apply the blob detector technique to 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                       
                                       .
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                          
                                             t
                                          
                                       
                                     
                                    
                                       ⟶
                                     get feature 
                                       
                                          
                                             BL
                                          
                                          
                                             2
                                             :
                                             4
                                          
                                          
                                             max
                                          
                                       
                                    .

Decompose 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                       
                                       =
                                       
                                          
                                             C
                                          
                                          
                                             b
                                          
                                       
                                       +
                                       
                                          
                                             T
                                          
                                          
                                             b
                                          
                                       
                                       ,
                                     into cartoon C
                                    
                                       b
                                     and texture T
                                    
                                       b
                                    . Apply a convolution type transform to the thresholded cartoon part 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                          
                                             t
                                          
                                       
                                       .
                                       
                                          
                                             C
                                          
                                          
                                             b
                                          
                                       
                                     
                                    
                                       ⟶
                                     get χ
                                    
                                       b
                                    .

Apply the variational segmentation to χ
                                    
                                       b
                                     
                                    
                                       ⟶
                                     get the segmented mask containing the candidates of large/medium BLs.

Remove the OD from the segmented mask and do the intersection with the location of 
                                       
                                          
                                             BL
                                          
                                          
                                             2
                                             :
                                             4
                                          
                                          
                                             max
                                          
                                       
                                     
                                    
                                       ⟶
                                     get the selected BL location candidate 
                                       
                                          
                                             M
                                          
                                          
                                             c
                                          
                                       
                                     .

Compute feature 
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                       
                                     in 
                                       
                                          
                                             M
                                          
                                          
                                             c
                                          
                                       
                                    , by using the gradient of the texture part 
                                       
                                          
                                             I
                                          
                                          
                                             b
                                          
                                          
                                             t
                                          
                                       
                                       .
                                       
                                          
                                             T
                                          
                                          
                                             c
                                          
                                       
                                    .

Compute the maximum intensity value in the candidate region 
                                       
                                          
                                             M
                                          
                                          
                                             c
                                          
                                       
                                       ∩
                                       (
                                       
                                          
                                             
                                                C
                                             
                                             
                                                b
                                             
                                          
                                          .
                                          
                                             
                                                I
                                             
                                             
                                                b
                                             
                                             
                                                t
                                             
                                          
                                       
                                       )
                                     
                                    
                                       ⟶
                                     get feature 
                                       
                                          
                                             C
                                          
                                          
                                             max
                                          
                                       
                                    .

Final decision criterion 
                                       ⟶
                                     if 
                                       (
                                       
                                          
                                             B
                                          
                                          
                                             L
                                          
                                       
                                       ≤
                                       
                                          
                                             BL
                                          
                                          
                                             2
                                             :
                                             4
                                          
                                          
                                             max
                                          
                                       
                                       ≤
                                       
                                          
                                             B
                                          
                                          
                                             U
                                          
                                       
                                       )
                                       ∧
                                       (
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                          
                                             L
                                          
                                       
                                       ≤
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                       
                                       ≤
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                          
                                             U
                                          
                                       
                                       )
                                       ∧
                                       
                                       (
                                       
                                          
                                             C
                                          
                                          
                                             L
                                          
                                       
                                       ≤
                                       
                                          
                                             C
                                          
                                          
                                             max
                                          
                                       
                                       ≤
                                       
                                          
                                             C
                                          
                                          
                                             U
                                          
                                       
                                       )
                                    , the frame is positive (B
                                    
                                       L
                                    , B
                                    
                                       U
                                    , 
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                          
                                             L
                                          
                                       
                                    , 
                                       
                                          
                                             N
                                          
                                          
                                             c
                                          
                                          
                                             U
                                          
                                       
                                    , C
                                    
                                       L
                                     and C
                                    
                                       U
                                     are fixed thresholds).

@&#EXPERIMENTS@&#

We now assess the performance of the proposed methodology for automated detection and diagnosis of DR. We have done two different evaluations: first by applying each detector individually and then by considering the detectors in a collective way (that is, a patient is considered a DR patient if he is a positive patient for at least one detector).

All the experiments were implemented with the software MATLAB® (The Mathworks, Inc.). We note that this implementation is unoptimized, so there is margin for improvement concerning the processing times. With MATLAB version R2011b in a 64 bit Windows7 machine, with Intel i5 processor running at 2.4 GHz and 4.00 Gb RAM, the computation time per image (with size 1024 × 682), is no more than several seconds. For Ma's detector is 5.15s, for HEM's detector is 14.15s and for BL's detector is 15.97s.

For evaluating the performance of the MA, HEM and BL detectors, individually, three datasets, named D
                        
                           MA
                        , D
                        
                           HEM
                         and D
                        
                           BL
                        , were prepared by retinal experts (that classified all the retinal images). Each dataset consists of normal and lesion frames. By a normal frame we mean that it is free of any type of lesion. By a lesion frame, for example in D
                        
                           MA
                         dataset, we mean that this frame has MAs, and it may or may not have other lesions (such as HEMs and BLs). A similar definition of lesion and normal frames applies to datasets D
                        
                           HEM
                         and D
                        
                           BL
                        . D
                        
                           MA
                         contains 484 frames out of which 316 are normal and 168 contain MAs, D
                        
                           HEM
                         contains 492 frames out of which 309 are normal and 183 frames contain HEMs and D
                        
                           BL
                         contains 607 frames out of which 396 are normal and 211 frames contain BLs.

Secondly for using the proposed detectors as a system for automated diagnosis of diabetic retinopathy (DR), and test the system performance, we consider four datasets prepared by retinal specialists, named DR1, DR2, DR3 and DR4 (see Table 1). By a DR patient we mean that at least one image of that patient contains one type of lesion (MAs, HEMs and BLs) and that image can also have one or more types of lesions present.

All these images are provided by the company Retmarker (http://www.retmarker.com/), and were obtained from patients screened according to the Diabetic Retinopathy Screening Program of Portugal. The screening includes the acquisition of 2 images per eye and per patient (except in DR3 and DR4, where a small number of the normal patients have less than 4 images) without pupil dilation. The images corresponding to the datasets DR1 and DR2 are taken by the Topcon TRC NW-100 non-mydriatic retinal camera, and those corresponding to the datasets DR3 and DR4 by a non-mydriatic 45-degree fixed Canon CR6-45NM fundus camera attached to a Sony Power HD 3CCD digital color camera. The images were stored in jpeg files (no compression) with resolutions of 
                           1024
                           ×
                           682
                           ,
                         
                        
                           768
                           ×
                           584
                           ,
                         and 768×768 pixels. The true classification of the disease patients, with DR, and normal patients (without DR) is shown in Table 1. The classification is done on a per patient basis. This means that if at least one image of a patient contains any type of lesion related to the definition of DR, it is considered as a disease (DR) patient. This ground truth classification is also provided by the company Retmarker and is the human grading at the Diabetic Retinopathy Screening Program.

We remark that only a part of the images in the aforementioned datasets D
                        
                           MA
                        , D
                        
                           HEM
                         and D
                        
                           BL
                         belong to the four datasets DR1, DR2, DR3 and DR4. The other images belong to other proprietary datasets owned by the company Retmarker (http://www.retmarker.com/)), and were also obtained from patients screened according to the Diabetic Retinopathy Screening Program of Portugal.

@&#RESULTS@&#

Our binary classifier depends on certain thresholds which are listed in Table 2 along with their values. These values were chosen based on the intrinsic definitions of the associated criteria: see the qualitative justification of these values for MAs in (9), for HEMs in (10)–(11) and after in (16), and finally for BLs in (17)–(19). The values were selected from the common sense considerations, not from the goal of improving the performance for any particular dataset that we used. In fact we utilized several big datasets and images acquired with different devices, and it can be seen from the tables displayed in this section (Tables 4 and 5
                        
                        ) that the detectors have a consistent performance. Moreover, we would like to stress that the generality of these thresholds were set by analysing the ROC (receiver operating characteristic) curves for each individual criterion, first in training subsets and then in large datasets.


                        Table 3 collects and summarizes the list of parameters used in the definition of each detector and the corresponding values (already indicated in the sections where the detectors were defined).

We use sensitivity and specificity to assess the performance of our methodology, which are widely used measures in the medical community. Their definitions are illustrated in the following formulas:
                           
                              (20)
                              
                                 sensitivity
                                 =
                                 
                                    
                                       number
                                       
                                       of
                                       
                                       TP
                                    
                                    
                                       number
                                       
                                       of
                                       
                                       TP
                                       +
                                       number
                                       
                                       of
                                       
                                       FN
                                    
                                 
                                 ,
                              
                           
                        
                        
                           
                              (21)
                              
                                 specificity
                                 =
                                 
                                    
                                       number
                                       
                                       of
                                       
                                       TN
                                    
                                    
                                       number
                                       
                                       of
                                       
                                       TN
                                       +
                                       number
                                       
                                       of
                                       
                                       FP
                                    
                                 
                                 ,
                              
                           
                        where TP, FN, FP and TN represent the number of true positives, false negatives, false positives and true negatives frames, respectively. If the frame belongs to the class of disease (DR) frames and it is classified by the algorithm as negative, it is counted as a false negative; if it is classified as positive, it is counted as a true positive. If the frame belongs to the class of non-disease frames (i.e. normal, free of lesions) and it is classified as positive, it is counted as a false positive; if it is classified as negative, it is counted as a true negative.

Sensitivity represents the ability of the method to correctly classify the frame containing a lesion (in our case MAs, HEMs and BLs) as lesion frame, while specificity represents the ability of the method to correctly classify a non-lesion frame as normal frame. The above definitions are on a per frame basis, and are used to assess the performance of each individual detector (MA׳s detector or HEM׳s detector or BL׳s detector).

We explain now how we have done this assessment. We first remark that each detector is a binary classifier that can be seen as a conjunction of different conditions (2 conditions for MA׳s detector, 10 conditions for HEM׳s detector and 10 conditions for BL׳s detector). The thresholds associated to the binary classifiers are the lower bounds of these conditions and that filter out frames without lesions. We first choose a training subset in each one of the datasets D
                        
                           MA
                        , D
                        
                           HEM
                         and D
                        
                           BL
                        . We set a desired high level of specificity for each detector individually. Then we compute the decision parameters for all the frames in the 3 training datasets, that is
                           
                              •
                              
                                 
                                    
                                       
                                          MA
                                       
                                       
                                          2
                                       
                                       
                                          max
                                       
                                    
                                  and 
                                    
                                       
                                          MA
                                       
                                       
                                          3
                                       
                                       
                                          max
                                       
                                    
                                  for frames in the training subset of D
                                 
                                    MA
                                 .


                                 
                                    
                                       
                                          HEM
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          HEM
                                       
                                       
                                          mean
                                       
                                    
                                 , 
                                    
                                       
                                          HEM
                                       
                                       
                                          ecc
                                       
                                    
                                 , 
                                    
                                       
                                          HEM
                                       
                                       
                                          a
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          HEM
                                       
                                       
                                          b
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          HEM
                                       
                                       
                                          c
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          S
                                       
                                       
                                          a
                                       
                                    
                                 , 
                                    
                                       
                                          S
                                       
                                       
                                          b
                                       
                                    
                                 , and 
                                    
                                       
                                          S
                                       
                                       
                                          c
                                       
                                    
                                  for frames in the training subset of D
                                 
                                    HEM
                                 .


                                 
                                    
                                       
                                          BL
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          N
                                       
                                       
                                          t
                                       
                                    
                                 , 
                                    E
                                 , 
                                    
                                       
                                          BL
                                       
                                       
                                          2
                                          :
                                          4
                                       
                                       
                                          max
                                       
                                    
                                 , 
                                    
                                       
                                          N
                                       
                                       
                                          c
                                       
                                    
                                 , and 
                                    
                                       
                                          C
                                       
                                       
                                          max
                                       
                                    
                                  for frames in the training subset of D
                                 
                                    BL
                                 .

As mentioned before we have also used ROC curves to assess partially the performance of each detector. A ROC curve is a graphical plot of the sensitivity versus the specificity at various threshold values, for a decision parameter. For each detector we have classified the decision parameters as primary and secondary. The primary are the parameters we consider most important and the secondary correspond to extra conditions, used to extract different features of the lesions and to enforce the role of the primary parameters. The primary parameters are 
                           
                              
                                 MA
                              
                              
                                 2
                              
                              
                                 max
                              
                           
                         and 
                           
                              
                                 MA
                              
                              
                                 3
                              
                              
                                 max
                              
                           
                         for MA׳s detector, 
                           
                              
                                 HEM
                              
                              
                                 max
                              
                           
                        , 
                           
                              
                                 HEM
                              
                              
                                 mean
                              
                           
                        , 
                           
                              
                                 HEM
                              
                              
                                 ecc
                              
                           
                        , 
                           
                              
                                 HEM
                              
                              
                                 a
                              
                              
                                 max
                              
                           
                        , 
                           
                              
                                 HEM
                              
                              
                                 b
                              
                              
                                 max
                              
                           
                         and 
                           
                              
                                 HEM
                              
                              
                                 c
                              
                              
                                 max
                              
                           
                         for HEM׳s detector, and 
                           
                              
                                 BL
                              
                              
                                 max
                              
                           
                         and 
                           
                              
                                 BL
                              
                              
                                 2
                                 :
                                 4
                              
                              
                                 max
                              
                           
                         for BL׳s detector. The remaining decision parameters are the secondary ones. We have plotted the ROC curves for all these primary parameters, for the corresponding whole datasets D
                        
                           MA
                        , D
                        
                           HEM
                         and D
                        
                           BL
                        . Clearly, for each detector, the conjunction of conditions (with primary and secondary parameters) will improve the specificity of the detector, and the analysis of the shape of the ROC curves has shown that by relaxing a little bit the thresholds associated to the primary parameters the sensitivity of the detector will be kept.

Next we evaluate the performance of the methods in a collective way as a system for the detection and diagnosis of DR. Since here we have the classification that is on a per patient basis, the assessment of the performance of our system was done on a per patient basis. For this purpose we use a modified definition of sensitivity and specificity, in (20) and (21), where there TP, FN, FP and TN are considered on a per patient basis instead of a per frame basis. A patient is labelled to be a positive patient (i.e. belonging to the class of DR patients) if at least one frame of the patient is classified as a positive frame by our methodology, i.e. if it is positive for at least one of the three detectors (MAs, HEMs or BLs). Accordingly we compute the number of TP, FN, FP and TN, and hence the sensitivity and specificity.

The evaluation of the proposed system in terms of sensitivity and specificity is given in Table 5. This table shows that the sensitivity and specificity values in datasets DR3 and DR4 are worse than in DR1 and DR2. This is because the datasets DR3 and DR4 contain images with very bad quality and artifacts (in fact these images are non-mydriatic photographs without pupil dilation, which originates low quality images). Some examples of frames with non-uniform illumination, bad contrast and blurred are shown in Fig. 9
                        . This leads to an increase of false positives and some false negatives. Therefore, a quality metric for analyzing the input image quality (and thus for detecting poor quality images or treat them separately), prior to the application of the proposed lesion detectors, would substantially improve the performance of these detectors. With this respect we refer to the quality metric proposed in [27], that is based on the hypothesis that the overall quality of the image is directly related to a correct segmentation of the eye vasculature.

We also remark that in these proprietary data-sets many frames exhibited bright artifacts and non-uniform illumination. Therefore for the BL detection a preprocessing step was essential to algorithm success, aimed at reducing the intra- and inter-image variability. We employed the technique proposed in [28,29] to normalize luminosity and contrast in fundus images based on a statistical model of the image. Thus the BL detectors were always applied to the corresponding contrast-enhanced images, for the proprietary datasets, in order to obtain a better BL detection. On the contrary, for MAs and HEMs detection we did not apply this preprocessing step.

For further evaluation of the proposed detectors we have also conducted tests in the following publicly available datasets: DIARETDB0 [30], DIARETDB1 [31], MESSIDOR [32] and HEI-MED [11]. The DIARETDB0 dataset contains a total of 130 images, 110 with MAs, 78 with HEMs and 20 normals (i.e. frames free of lesions). The DIARETDB1 contains a total of 89 images, 84 with MAs, 53 with HEMs and 5 normals. The MESSIDOR dataset is composed of 1200 images, grouped in 3 sets, one per ophthalmologic department. We have considered a subset of the MESSIDOR dataset corresponding to 400 images, acquired at Service d׳Ophtalmologie - Hôpital Lariboisière Paris, where 229 with signs of MAs or HEMs and 171 normals. The HEI-MED dataset consists of 169 images, where 115 do not exhibit signs of BLs and 54 contain BLs. The results with the proposed methods are exhibited in Table 6
                        .

For dataset MESSIDOR we present the results for a simultaneous detection of MAs or HEMs, due to the retinopathy grade provided by MESSIDOR (grade 0 if there are no MAs and no HEMs, grade 1 if there are no HEMs and the number of MAs is less than or equal to 5, grade 2 if the number of MAs is between 5 and 15 or the number of HEMs is less than or equal to 5 and there is no neovascularization, and finally grade 3 if the number of MAs is bigger than 15 or the number of HEMs is bigger than 5 or there is neovascularization). We remark that for the public dataset HEI-MED, the results shown in this table were obtained by applying the BL detector directly to the original images, and not to the corresponding contrast-enhanced images. Certainly the application of a contrast-enhanced method, prior to the application of the proposed BL detector, would improve the results in the public dataset HEI-MED.


                        Table 6 also displays the results obtained with some other existing approaches, for comparison reasons. All the displayed results are in terms of sensitivity and specificity at the image level (where an image is categorized either as “normal”, if it is free of lesions, or “abnormal” if it contains at least a lesion).

In addition we refer that the method proposed in [5], for MA׳s detection, achieves a sensitivity of 89.62% and a positive predictive value (PPV) of 89.50%, in a private dataset of color photographs. Also in [39] a study is conducted to compare the performance of two competitive DR detection algorithms (Challenge2009, that won the Retinopathy Online Challenge Competition in 2009 and EyeCheck, a computer-aided early DR detection project), focusing on the detection of microaneurysms. The dataset used for performance evaluation consists of fundus photographs from 16,670 patients (with 2 fundus images from each eye): at a 90% sensitivity the specificity of EyeCheck was 47.7% and that of the Challenge2009 algorithm was 43.6% (compare with Table 5).

All these results demonstrate that the methods proposed in this paper are comparable and competitive with the state-of-the art methods, and therefore anticipate the high potential these detectors have when considered collectively as an automated screening system for DR.

@&#DISCUSSION AND CONCLUSIONS@&#

We developed a system for automated detection and diagnosis of DR, by devising appropriate MA, HEM and BL binary classifier detectors in retinal fundus images. The preprocessing phase involves the extraction of the background pixels that enables further computations on the foreground pixels only, as well as the removal of main image structures, such as the optic disk and blood vessels, so that they cannot interfere in the detection of the lesions. The extraction of the candidates for different types of lesions (MAs, HEMs and BLs) is done by analysing different sub-band wavelet images (resulting from the isotropic undecimated wavelet transform decomposition of the green channel of the retinal image), and applying Hessian multiscale analysis, variational segmentation, cartoon+texture decomposition. These techniques, that are combined in a sequential and suitable way, are appropriate for exploring the particular characteristics of the lesions (that by nature are very diverse in shape, size, texture and color). Some novel contextual features are derived and quantified, for each lesion depending on the lesion specific properties. Then the corresponding numerical feature values are used to obtain a binary classification method. Standard performance measures such as sensitivity and specificity are used for its evaluation. Firstly, the testing of the proposed methods for MA, HEM and BL detection is done individually. The performance, per frame, of the MA detector is 93% sensitivity and 89% specificity, of the HEM detector is 86% sensitivity and 90% specificity, and of the BL detector is 90% sensitivity and 97% specificity. Secondly, we consider the proposed methods as a system for DR detection and performed a thorough testing of the system on rich datasets to ensure its good performance in realistic situations. The proposed system achieves an average 95–100% sensitivity and 70% specificity at a per patient basis. Further, we tested the proposed methodology on publicly available datasets, for comparison with the state-of-the art techniques. The results confirm the significance and potential of the proposed methodology.

In this work a simple thresholding approach was used for combining the MA, HEM and BL detectors to classify DR. In the future other methods, as for instance some classification algorithms, e.g. support vector machines or neural networks, will be studied for combining the proposed different detectors.

None declared.

@&#ACKNOWLEDGMENTS@&#

This work was partially supported by the FCT (Portugal) project PTDC/MATNAN/0593/2012, and also by CMUC (Center for Mathematics, University of Coimbra) through European program COMPETE/ FEDER and project PEst-C/MAT/UI0324/2013. The Messidor dataset was kindly provided by the Messidor program partners (see http://messidor.crihan.fr). The authors would also like to thank Dr. Gonçalo Quadros for having suggested the study of the interesting and challenging retina topic. The authors also thank the anonymous referees for valuable comments and suggestions that helped to improve the manuscript.

@&#REFERENCES@&#

