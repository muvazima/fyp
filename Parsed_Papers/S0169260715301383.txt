@&#MAIN-TITLE@&#Medical image denoising via optimal implementation of non-local means on hybrid parallel architecture

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           The symmetric weight scheme allows reducing the computation time by a factor 2.


                        
                        
                           
                           Our implementation of NL-Means reduces computation time by a factor of 510.


                        
                        
                           
                           Self-adaptive method is proposed to allow the filter to be more efficient.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Parallel computing

High performance computing

Image denoising

Image enhancement

@&#ABSTRACT@&#


               
               
                  The Non-local means denoising filter has been established as gold standard for image denoising problem in general and particularly in medical imaging due to its efficiency. However, its computation time limited its applications in real world application, especially in medical imaging. In this paper, a distributed version on parallel hybrid architecture is proposed to solve the computation time problem and a new method to compute the filters’ coefficients is also proposed, where we focused on the implementation and the enhancement of filters’ parameters via taking the neighborhood of the current voxel more accurately into account. In terms of implementation, our key contribution consists in reducing the number of shared memory accesses. The different tests of the proposed method were performed on the brain-web database for different levels of noise. Performances and the sensitivity were quantified in terms of speedup, peak signal to noise ratio, execution time, the number of floating point operations. The obtained results demonstrate the efficiency of the proposed method. Moreover, the implementation is compared to that of other techniques, recently published in the literature.
               
            

@&#INTRODUCTION@&#

Image denoising is an operation that aims to reduce noise and to preserve features. Reducing noise on images can be used as a post or pre-processing step, often desirable when the signal to noise ratio is low as in ultrasound imaging (US), medium in the case of low-dose CT scan, high in magnetic resonance images (MRI) [26].

The present trends in the field of medical imaging, and particularly 3D imaging modalities, with high resolutions represent an important challenge for the processing of these big block of data. In order to archive real-time objectives the algorithms should be parallelized and mapped in an optimal way onto state-of-art parallel processing architectures i.e. [30]. This work is dedicated to the enhancement of a data parallel version of the Non-Local Means (NL-Means) filter proposed by Buades et al.  [7].

The proposed algorithm was validated on Brainweb database [1] and the obtained results show that the processing can be done in more practical time frames. Indeed, the NL-Means is a powerful algorithm that can potentially uses massive amounts of information in filtering each pixel of an image. However, the main drawback of the NL-Means filter resides in computational cost. A number of recent papers propose many improvements of the NL-Means filter [6,12,14–16,19,20,22–24,27,29,33–35].

Furthermore, the nonlocal means filter was widely applied to different kind of medical images as in ultrasound images [13,17], and in computed tomography [10,11]. A review of all applications will be too consuming, we suggest to the reader these Refs.  [18,21,31].

In this paper, we propose to hybridize a pre-selection procedure and a symmetric weight method to reduce the execution time. In addition, an implementation scheme on a HPC (High performance Computing) platform is proposed.

The rest of the paper is organized as follows: in the next section, we state the problem addressed by this work, and present related work. The proposed method is exposed in Section 3. In Section 4 the parallel implementation is detailed, while the experimental results, discussion, and comparison study are in Section 5. Section 6 ends the paper.

@&#RELATED WORK@&#

First introduced by Buades et al. in [7], the NL-Means filter takes profit from the redundancy property of periodic images, textured images or natural images to remove noise. The NL-Means filter allows to combine the two most important attributes of a denoising algorithm: edge preservation and noise removal.

The classical formulation for a given a noisy image b
                        ={b
                        
                           i
                        
                        ∣
                        i
                        ∈
                        I}, where I is the set of all coordinates of the pixels in the image space, the estimated value NL[b
                        
                           i
                        ], for a pixel i can be defined as the average value of all pixels in the image:
                           
                              (1)
                              
                                 NL
                                 [
                                 
                                    b
                                    i
                                 
                                 ]
                                 =
                                 
                                    ∑
                                    
                                       j
                                       ∈
                                       I
                                    
                                 
                                 w
                                 (
                                 i
                                 ,
                                 j
                                 )
                                 
                                    b
                                    j
                                 
                              
                           
                        where the weight 
                           w
                           (
                           i
                           ,
                           j
                           )
                         reflects the similarity between neighborhoods N
                        
                           i
                         and N
                        
                           j
                        . N
                        
                           i
                         is a cubic local neighborhood of a fixed size and centered at the pixel i. The weighting parameters 
                           0
                           ≤
                           w
                           (
                           i
                           ,
                           j
                           )
                           ≤
                           1
                         and (
                           
                              ∑
                              
                                 i
                                 ,
                                 j
                              
                           
                           w
                           (
                           i
                           ,
                           j
                           )
                           =
                           1
                        ). This similarity measure function decreases when the weighted Euclidean distance increases: 
                           |
                           |
                           v
                           (
                           
                              N
                              i
                           
                           )
                           −
                           v
                           (
                           
                              N
                              j
                           
                           )
                           |
                           
                              |
                              
                                 2
                                 ,
                                 α
                              
                              2
                           
                        , where α
                        >0 is the standard deviation of the Gaussian kernel. The application of the Euclidean distance to the noisy neighborhoods raises the following equality:
                           
                              (2)
                              
                                 
                                    |
                                    |
                                    v
                                    (
                                    
                                       N
                                       i
                                    
                                    )
                                    −
                                    v
                                    (
                                    
                                       N
                                       j
                                    
                                    )
                                    |
                                    
                                       |
                                       
                                          2
                                          ,
                                          α
                                       
                                       2
                                    
                                 
                                 =
                                 E
                                 
                                    
                                       
                                          |
                                          |
                                          u
                                          (
                                          
                                             N
                                             i
                                          
                                          )
                                          −
                                          u
                                          (
                                          
                                             N
                                             j
                                          
                                          )
                                          |
                                          
                                             |
                                             
                                                2
                                                ,
                                                α
                                             
                                             2
                                          
                                       
                                    
                                 
                                 +
                                 2
                                 
                                    σ
                                    2
                                 
                              
                           
                        where u(N
                        
                           j
                        ) is the exact value of the intensity of the voxel N
                        
                           j
                         and 
                           v
                           (
                           
                              N
                              j
                           
                           )
                         is the intensity observed at the voxel N
                        
                           j
                        .

The pixels with a similar gray level neighborhood to 
                           v
                           (
                           
                              N
                              i
                           
                           )
                         have larger weights in the average, these weights are defined by:
                           
                              (3)
                              
                                 w
                                 (
                                 i
                                 ,
                                 j
                                 )
                                 =
                                 
                                    1
                                    
                                       
                                          Z
                                          i
                                       
                                    
                                 
                                    
                                 
                                    e
                                    
                                       −
                                       
                                          
                                             |
                                             |
                                             v
                                             (
                                             
                                                N
                                                i
                                             
                                             )
                                             −
                                             v
                                             (
                                             
                                                N
                                                j
                                             
                                             )
                                             |
                                             
                                                |
                                                
                                                   2
                                                   ,
                                                   α
                                                
                                                2
                                             
                                          
                                          
                                             
                                                h
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where Z
                        
                           i
                         is a normalization constant given by:
                           
                              (4)
                              
                                 
                                    Z
                                    i
                                 
                                 =
                                 
                                    ∑
                                    
                                       j
                                       ∈
                                       
                                          V
                                          i
                                       
                                    
                                 
                                 
                                    e
                                    
                                       −
                                       
                                          
                                             |
                                             |
                                             v
                                             (
                                             
                                                N
                                                i
                                             
                                             )
                                             −
                                             v
                                             (
                                             
                                                N
                                                j
                                             
                                             )
                                             |
                                             
                                                |
                                                
                                                   2
                                                   ,
                                                   α
                                                
                                                2
                                             
                                          
                                          
                                             
                                                h
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where V
                        
                           i
                         is the search region of pixel i. h is a constant, proportional to the noise variance 
                           
                              σ
                              n
                              2
                           
                        . The weights 
                           w
                           (
                           i
                           ,
                           j
                           )
                         decay at an exponential rate.

The NL-means filter does not only compare the gray level in a single point, but also the geometrical configuration within the whole neighborhood. This behavior provides improved performance compared to the neighborhood filters. The pseudo code of the traditional (sequential) NL-means filter is presented in Algorithm 1.
                           Algorithm 1
                           Classical NL-Means algorithm. 
                                 
                                    
                                       
                                       
                                          
                                             
                                                for 
                                                each voxel of the input image 
                                                do
                                             
                                          
                                          
                                             
                                                Initialize the cumulative sum of the weights
                                          
                                          
                                             
                                                
                                                for 
                                                each voxel of the search window V 
                                                do
                                             
                                          
                                          
                                             
                                                  
                                                for 
                                                each voxel of the similarity window 
                                                do
                                             
                                          
                                          
                                             
                                                    
                                                Compute the Euclidean distance
                                          
                                          
                                             
                                                  Compute the weight of the voxel within the search window
                                          
                                          
                                             
                                                Normalize the sum of the weights
                                          
                                       
                                    
                                 
                              
                           

It is known that the original NL-Means algorithm is a powerful method for denoising images. Its performances in terms of the peak signal to noise ratio (PSNR) and visual results are somewhat less than those of other modified versions  [7,8,12]. However, its main drawback is still the high computation time due to the excessive amount of evaluations of the weighting function given by Eq. (3). Let N
                        3 denotes the size of a given 3D image, rk denotes the kernel radius and rw the search region radius. The complexity of the filter is given by: O((N(2rk
                        +1)(2rw
                        +1)3)). To have an idea about the computation time, we consider an example of denoising a 3D MRI image of size 181×217×181 with the smallest possible value of rk and rw (rk
                        =1, rw
                        =5), on a CPU 3.0GHz. Then, the corresponding execution time is about 6 hours [12].

Indeed, many improvements of NL-Means filter have been proposed in the literature. In [12] the authors determined the relationship h
                        2
                        =
                        f(σ
                        2, |N
                        
                           i
                        |, β) where β is a constant that allows to fit the smoothing parameter h. In [27] authors reduced the original quadratic computational complexity to a linear, by restricting the number of contributing weights and by pre-classifying neighborhoods (based on average gray values and gradients), while Coupe et al. in [12] used the mean and the variance of the neighborhood as pre-classification conditions. Orchard et al. classify neighborhoods via singular value decomposition (SVD) 
                        [29]. Brox et al. [6] arranged image data in a cluster tree, which allows a fast and accurate pre-selection of similar neighborhoods. Wang et al. [32] replaced the mean squared distance (MSD) calculations with an efficient summed square image scheme based on the fast Fourier transform in a given search region. Since most of distance measures between neighborhoods, such as the MSD, are symmetrical, Gosseenes et al. [19] reduced the computation time by approximately a factor 2 by taking profit from the symmetry property of the weighting functions (i.e. 
                           w
                           (
                           i
                           ,
                           j
                           )
                           =
                           w
                           (
                           j
                           ,
                           i
                           )
                        ).

In first, to make easy the fitting of the smoothing parameter, an automatic tuning method inspired from [12] is proposed. Indeed, in the case of an additive white Gaussian noise, the standard deviation of this noise can be estimated via pseudo-residuals ϵ
                        
                           i
                         as defined in [25]. Then, for each voxel i
                        ∈
                        Ω
                        3 it is given by:
                           
                              (5)
                              
                                 
                                    ϵ
                                    i
                                 
                                 =
                                 
                                    
                                       
                                          6
                                          7
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             v
                                             i
                                          
                                          −
                                          
                                             1
                                             6
                                          
                                          
                                             ∑
                                             
                                                j
                                                ∈
                                                
                                                   P
                                                   i
                                                
                                             
                                          
                                          
                                             v
                                             j
                                          
                                       
                                    
                                 
                              
                           
                        where P
                        
                           i
                         is the 6-neighborhood at voxel x
                        
                           i
                        , and the constant 
                           
                              
                                 6
                                 /
                                 7
                              
                           
                         is used to ensure that 
                           
                              
                                 E
                              
                           
                           [
                           
                              ϵ
                              2
                           
                           ]
                           =
                           
                              
                                 
                                    σ
                                    ˆ
                                 
                              
                              2
                           
                         in an homogeneous areas. Thus, the estimated variance of noise 
                           
                              
                                 
                                    σ
                                    ˆ
                                 
                              
                              2
                           
                         is computed as the least square estimator:
                           
                              (6)
                              
                                 
                                    
                                       
                                          σ
                                          ˆ
                                       
                                    
                                    2
                                 
                                 =
                                 
                                    1
                                    
                                       |
                                       
                                          Ω
                                          3
                                       
                                       |
                                    
                                 
                                 
                                    ∑
                                    
                                       i
                                       ∈
                                       
                                          Ω
                                          3
                                       
                                    
                                 
                                 
                                    ϵ
                                    i
                                    2
                                 
                              
                           
                        
                     

Initially, the NL-Means filter was defined with a Gaussian-weighted Euclidean distance 
                           |
                           |
                           .
                           |
                           
                              |
                              
                                 2
                                 ,
                                 α
                              
                              2
                           
                         defined in [7].

However, in order to make the filter independent of |N
                        
                           i
                        |, to simplify the complexity of the problem, and to reduce the computational time, in [12] they used the classical Euclidean distance 
                           |
                           |
                           .
                           |
                           
                              |
                              2
                              2
                           
                         normalized by the number of elements:
                           
                              (7)
                              
                                 |
                                 |
                                 v
                                 (
                                 
                                    N
                                    i
                                 
                                 )
                                 −
                                 v
                                 (
                                 
                                    N
                                    j
                                 
                                 )
                                 |
                                 
                                    |
                                    
                                       2
                                       ,
                                       α
                                    
                                    2
                                 
                                 =
                                 
                                    1
                                    
                                       |
                                       
                                          N
                                          i
                                       
                                       |
                                    
                                 
                                 
                                    ∑
                                    
                                       p
                                       =
                                       1
                                       ,
                                       2
                                       ,
                                       …
                                       ,
                                       |
                                       
                                          N
                                          i
                                       
                                       |
                                    
                                 
                                 
                                    
                                       (
                                       
                                          v
                                          p
                                       
                                       (
                                       
                                          N
                                          i
                                       
                                       )
                                       −
                                       
                                          v
                                          p
                                       
                                       (
                                       
                                          N
                                          j
                                       
                                       )
                                       )
                                    
                                    2
                                 
                              
                           
                        
                     

Then, Eq. (3) becomes:
                           
                              (8)
                              
                                 w
                                 (
                                 i
                                 ,
                                 j
                                 )
                                 =
                                 
                                    1
                                    
                                       
                                          Z
                                          i
                                       
                                    
                                 
                                    
                                 
                                    e
                                    
                                       
                                          
                                             −
                                             
                                                
                                                   
                                                      ∑
                                                      
                                                         p
                                                         =
                                                         1
                                                         ,
                                                         2
                                                         ,
                                                         …
                                                         ,
                                                         |
                                                         
                                                            N
                                                            i
                                                         
                                                         |
                                                      
                                                   
                                                   
                                                      
                                                         (
                                                         
                                                            v
                                                            p
                                                         
                                                         (
                                                         
                                                            N
                                                            i
                                                         
                                                         )
                                                         −
                                                         
                                                            v
                                                            p
                                                         
                                                         (
                                                         
                                                            N
                                                            j
                                                         
                                                         )
                                                         )
                                                      
                                                      2
                                                   
                                                
                                                
                                                   2
                                                   β
                                                   
                                                      
                                                         
                                                            σ
                                                            ˆ
                                                         
                                                      
                                                      2
                                                   
                                                   |
                                                   
                                                      N
                                                      i
                                                   
                                                   |
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where only the adjusting constant β needs to be fitted manually. In the case of Gaussian noise, theoretically, β must be close to 1, when the estimation 
                           
                              σ
                              ˆ
                           
                         of the standard deviation of the noise is perfect.

In [14,12,27] authors reduced computation time by ignoring the small weight using mean and the variance of the neighborhood as the pre-classification conditions. Maps of local means and local variances are simple estimators that allow to discriminate different tissue classes, and edges in an images. In this way, these maps are precomputed to avoid the recurrent computation for the same neighborhood.

The selection heuristic can be expressed as follows:
                           
                              (9)
                              
                                 w
                                 (
                                 i
                                 ,
                                 j
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   Eq
                                                   (
                                                   8
                                                   )
                                                
                                                
                                                   if
                                                      
                                                   
                                                      μ
                                                      r
                                                   
                                                   <
                                                   
                                                      
                                                         
                                                            μ
                                                            i
                                                         
                                                      
                                                      
                                                         
                                                            μ
                                                            j
                                                         
                                                      
                                                   
                                                   <
                                                   
                                                      1
                                                      
                                                         
                                                            μ
                                                            r
                                                         
                                                      
                                                   
                                                      
                                                   &
                                                      
                                                   
                                                      σ
                                                      r
                                                      2
                                                   
                                                   <
                                                   
                                                      
                                                         
                                                            σ
                                                            i
                                                            2
                                                         
                                                      
                                                      
                                                         
                                                            σ
                                                            j
                                                            2
                                                         
                                                      
                                                   
                                                   <
                                                   
                                                      1
                                                      
                                                         
                                                            σ
                                                            r
                                                            2
                                                         
                                                      
                                                   
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   otherwise
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where μ
                        
                           i
                         and 
                           
                              σ
                              i
                              2
                           
                         are the mean and the variance of the local neighborhood N
                        
                           i
                         of voxel i, respectively. The μ
                        
                           r
                         and 
                           
                              σ
                              r
                              2
                           
                         are the mean ratio and the variance ratio, respectively. These parameters must be provided by the user. With this kind of selection, the NL-means filter tends to preserve better the details inside regions, while it slightly spoils the denoising of the flat regions. Indeed, in flat regions increasing the number of voxels tends to improve denoising performance because there is a large number of similar voxels. In a region with more cluttered features, increasing the number of voxels tends to remove the details during smoothing because there is few similar voxels.

In our approach, the acceleration is obtained by using the neighborhoods’ means μ
                        
                           i
                         and μ
                        
                           j
                         to compute the weight, where i and j are barycenter of two homogeneous blocs. A bloc is considered homogeneous if its variance is less than the average estimated value 
                           
                              
                                 
                                    σ
                                    ˆ
                                 
                              
                              2
                           
                         using Eq. (5). So, the expression in Eq. (9) becomes:
                           
                              (10)
                              
                                 w
                                 (
                                 i
                                 ,
                                 j
                                 )
                                 =
                                 
                                    
                                       
                                          
                                             
                                                
                                                   Eq
                                                   (
                                                   8
                                                   )
                                                
                                                
                                                   if
                                                      
                                                   
                                                      c
                                                      1
                                                   
                                                
                                             
                                             
                                                
                                                   |
                                                   
                                                      N
                                                      i
                                                   
                                                   |
                                                   
                                                      
                                                         (
                                                         
                                                            μ
                                                            i
                                                         
                                                         −
                                                         
                                                            μ
                                                            j
                                                         
                                                         )
                                                      
                                                      2
                                                   
                                                
                                                
                                                   if
                                                      
                                                   
                                                      c
                                                      2
                                                   
                                                
                                             
                                             
                                                
                                                   0
                                                
                                                
                                                   otherwise
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                        
                           
                              
                                 
                                    
                                       
                                          
                                             c
                                             1
                                          
                                          :
                                          
                                             μ
                                             r
                                          
                                          <
                                          
                                             
                                                
                                                   μ
                                                   i
                                                
                                             
                                             
                                                
                                                   μ
                                                   j
                                                
                                             
                                          
                                          <
                                          
                                             1
                                             
                                                
                                                   μ
                                                   r
                                                
                                             
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             r
                                             2
                                          
                                          <
                                          
                                             
                                                
                                                   σ
                                                   i
                                                   2
                                                
                                             
                                             
                                                
                                                   σ
                                                   j
                                                   2
                                                
                                             
                                          
                                          <
                                          
                                             1
                                             
                                                
                                                   σ
                                                   r
                                                   2
                                                
                                             
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             i
                                             2
                                          
                                          >
                                          
                                             
                                                
                                                   σ
                                                   ˆ
                                                
                                             
                                             2
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             j
                                             2
                                          
                                          >
                                          
                                             
                                                
                                                   σ
                                                   ˆ
                                                
                                             
                                             2
                                          
                                       
                                    
                                    
                                       
                                          
                                             c
                                             2
                                          
                                          :
                                          
                                             μ
                                             r
                                          
                                          <
                                          
                                             
                                                
                                                   μ
                                                   i
                                                
                                             
                                             
                                                
                                                   μ
                                                   j
                                                
                                             
                                          
                                          <
                                          
                                             1
                                             
                                                
                                                   μ
                                                   r
                                                
                                             
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             r
                                             2
                                          
                                          <
                                          
                                             
                                                
                                                   σ
                                                   i
                                                   2
                                                
                                             
                                             
                                                
                                                   σ
                                                   j
                                                   2
                                                
                                             
                                          
                                          <
                                          
                                             1
                                             
                                                
                                                   σ
                                                   r
                                                   2
                                                
                                             
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             i
                                             2
                                          
                                          ≤
                                          
                                             
                                                
                                                   σ
                                                   ˆ
                                                
                                             
                                             2
                                          
                                             
                                          &
                                             
                                          
                                             σ
                                             j
                                             2
                                          
                                          ≤
                                          
                                             
                                                
                                                   σ
                                                   ˆ
                                                
                                             
                                             2
                                          
                                       
                                    
                                    
                                       
                                          0
                                          ≤
                                          
                                             μ
                                             i
                                          
                                          ≤
                                          1
                                          
                                          and
                                          
                                          0
                                          ≤
                                          
                                             μ
                                             j
                                          
                                          ≤
                                          1
                                       
                                    
                                 
                              
                           
                        
                     

Since most distance measures’ between neighborhoods, such as the MSD (means squared distance), are symmetric, Gosseenes et al. [19] reduced the computation time by approximately a factor 2 by taking profit from the symmetry weighting functions. So in our work, we first initialize the accumulated weight matrix and the accumulated contribution matrix with zeros. These both matrices have the same size and are equal to that of the input image. They represent the numerator (i.e. the accumulated contribution matrix) and the denominator (i.e. the accumulated weight matrix) of Eq. (3). For instance, for a given pixel i with the contribution of a pixel j, the products 
                           w
                           (
                           i
                           ,
                           j
                           )
                           
                              v
                              i
                           
                         and 
                           w
                           (
                           j
                           ,
                           i
                           )
                           
                              v
                              j
                           
                         are added to the accumulated contribution matrix at the pixel positions i and j, respectively.

The accumulated weight matrix is updated at the same pixel positions with the weight 
                           w
                           (
                           i
                           ,
                           j
                           )
                        . Consequently, only required weights of neighborhoods for i
                        >
                        j are computed. However, this does not mean that the accumulated weights on positions i and j are equal, and the update of both accumulated matrices on positions i and j must be performed. Finally, the accumulated contribution is normalized.

In the next section we present the proposed implementation, that consists in a combination of two accelerations of NL-Means method (symmetric weight presented on Section 3.3 and Voxel Pre-selection Enhancement in Eq. (10)) using different parallel technologies (MPI (Message Passing interface) [4], Multi-threading on multi-cores machine and GPU acceleration) is proposed. The pseudo-code for a given image is presented in Algorithm 2 and the noisy image are from the brain-web database.
                           Algorithm 2
                           Proposed NL-Means algorithm 
                                 
                                    
                                       
                                       
                                          
                                             
                                                Input: 
                                                
                                                   v
                                                   [
                                                      
                                                   ]
                                                   ,
                                                   
                                                      v
                                                      ¯
                                                   
                                                   [
                                                      
                                                   ]
                                                   ,
                                                   
                                                      σ
                                                      2
                                                   
                                                   [
                                                      
                                                   ]
                                                   ,
                                                   wc
                                                   [
                                                      
                                                   ]
                                                   ,
                                                   wn
                                                   [
                                                      
                                                   ]
                                                   ,
                                                   N
                                                   ,
                                                   
                                                      σ
                                                      r
                                                      2
                                                   
                                                   ,
                                                   
                                                      μ
                                                      r
                                                   
                                                   ,
                                                   rk
                                                   ,
                                                   rw
                                                
                                             
                                          
                                          
                                             
                                                Output: 
                                                u[ ]
                                          
                                          
                                             
                                                for 
                                                ip
                                                ←0 to 
                                                N 
                                                do
                                             
                                          
                                          
                                             
                                                
                                                
                                                   sum
                                                   ←
                                                   0
                                                   ,
                                                   w
                                                   ←
                                                   0
                                                   ,
                                                   wmax
                                                   ←
                                                   0
                                                   ,
                                                   tw
                                                   ←
                                                   0
                                                
                                             
                                          
                                          
                                             
                                                
                                                for 
                                                iq
                                                ← −
                                                rw 
                                                to 
                                                rw 
                                                do
                                             
                                          
                                          
                                             
                                                  
                                                if 
                                                ip
                                                ≠
                                                iq 
                                                then
                                             
                                          
                                          
                                             
                                                    
                                                if 
                                                
                                                   
                                                      σ
                                                      r
                                                      2
                                                   
                                                   ≤
                                                   
                                                      
                                                         
                                                            σ
                                                            2
                                                         
                                                         [
                                                         ip
                                                         ]
                                                      
                                                      
                                                         
                                                            σ
                                                            2
                                                         
                                                         [
                                                         iq
                                                         ]
                                                      
                                                   
                                                   ≤
                                                   
                                                      1
                                                      
                                                         
                                                            σ
                                                            r
                                                            2
                                                         
                                                      
                                                   
                                                 
                                                and 
                                                
                                                   
                                                      μ
                                                      r
                                                   
                                                   ≤
                                                   
                                                      
                                                         
                                                            v
                                                            ¯
                                                         
                                                         [
                                                         ip
                                                         ]
                                                      
                                                      
                                                         
                                                            v
                                                            ¯
                                                         
                                                         [
                                                         iq
                                                         ]
                                                      
                                                   
                                                   ≤
                                                   
                                                      1
                                                      
                                                         
                                                            μ
                                                            r
                                                         
                                                      
                                                   
                                                 
                                                then
                                             
                                          
                                          
                                             
                                                      
                                                if 
                                                
                                                   
                                                      σ
                                                      2
                                                   
                                                   [
                                                   iq
                                                   ]
                                                   ≤
                                                   
                                                      
                                                         
                                                            σ
                                                            ˆ
                                                         
                                                      
                                                      2
                                                   
                                                 
                                                and 
                                                
                                                   
                                                      σ
                                                      2
                                                   
                                                   [
                                                   ip
                                                   ]
                                                   ≤
                                                   
                                                      
                                                         
                                                            σ
                                                            ˆ
                                                         
                                                      
                                                      2
                                                   
                                                 
                                                and 
                                                
                                                   
                                                      v
                                                      ¯
                                                   
                                                   [
                                                   ip
                                                   ]
                                                   ≠
                                                   
                                                      v
                                                      ¯
                                                   
                                                   [
                                                   iq
                                                   ]
                                                 
                                                then
                                             
                                          
                                          
                                             
                                                        
                                                
                                                   d
                                                   ←
                                                   
                                                      
                                                         (
                                                         
                                                            v
                                                            ¯
                                                         
                                                         [
                                                         ip
                                                         ]
                                                         −
                                                         
                                                            v
                                                            ¯
                                                         
                                                         [
                                                         iq
                                                         ]
                                                         )
                                                      
                                                      2
                                                   
                                                   ×
                                                   (
                                                   2
                                                   ×
                                                   k
                                                   +
                                                   1
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                      
                                                else
                                             
                                          
                                          
                                             
                                                        
                                                d
                                                ←0
                                          
                                          
                                             
                                                        
                                                for 
                                                i
                                                ← −
                                                rk 
                                                to 
                                                rk 
                                                do
                                             
                                          
                                          
                                             
                                                          
                                                
                                                   d
                                                   ←
                                                   d
                                                   +
                                                   
                                                      
                                                         (
                                                         v
                                                         [
                                                         ip
                                                         +
                                                         i
                                                         ]
                                                         −
                                                         v
                                                         [
                                                         iq
                                                         +
                                                         i
                                                         ]
                                                         )
                                                      
                                                      2
                                                   
                                                
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   w
                                                   ←
                                                   
                                                      
                                                         exp
                                                      
                                                   
                                                   (
                                                   −
                                                   
                                                      d
                                                      
                                                         
                                                            h
                                                            2
                                                         
                                                      
                                                   
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                    
                                                else
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   wmax
                                                   ←
                                                   MAX
                                                   (
                                                   w
                                                   ,
                                                   wmax
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   tw
                                                   ←
                                                   tw
                                                   +
                                                   w
                                                
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   wn
                                                   [
                                                   iq
                                                   ]
                                                   ←
                                                   wn
                                                   [
                                                   iq
                                                   ]
                                                   +
                                                   w
                                                
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   wc
                                                   [
                                                   iq
                                                   ]
                                                   ←
                                                   v
                                                   [
                                                   ip
                                                   ]
                                                   ×
                                                   w
                                                
                                             
                                          
                                          
                                             
                                                  
                                                else
                                             
                                          
                                          
                                             
                                                    
                                                
                                                   wmax
                                                   ←
                                                   MAX
                                                   (
                                                   w
                                                   ,
                                                   wmax
                                                   )
                                                
                                             
                                          
                                          
                                             
                                                    
                                                
                                                   tw
                                                   ←
                                                   tw
                                                   +
                                                   w
                                                
                                             
                                          
                                          
                                             
                                                    
                                                if 
                                                sum
                                                =0 and 
                                                tw
                                                =0 then
                                             
                                          
                                          
                                             
                                                      
                                                
                                                   sum
                                                   ←
                                                   
                                                      v
                                                      ¯
                                                   
                                                   [
                                                   ip
                                                   ]
                                                
                                             
                                          
                                          
                                             
                                                      
                                                tw
                                                ←1.0f
                                             
                                          
                                          
                                             
                                                    
                                                wc[ip]←
                                                wc[ip]+
                                                sum
                                             
                                          
                                          
                                             
                                                    
                                                wn[ip]←
                                                wn[ip]+
                                                tw
                                             
                                          
                                          
                                             
                                                for 
                                                ip
                                                ←0 to 
                                                N 
                                                do
                                             
                                          
                                          
                                             
                                                
                                                
                                                   u
                                                   [
                                                   ip
                                                   ]
                                                   ←
                                                   
                                                      
                                                         wc
                                                         [
                                                         ip
                                                         ]
                                                      
                                                      
                                                         wn
                                                         [
                                                         ip
                                                         ]
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           

For all experiments, we used a cluster of eight Xeon processor at 2.8GHz, four of them has two Nvidia GPUs Tesla C2050. To communicate between clusters’ node, we used MPI implemented by Bull [2]. In our system the host, and accelerator devices (GPUs) have physically distinct memories and data transfer are controlled by the host. Fig. 2
                        (a) shows the design of our system. The main advantage this architecture is that we have different possible implementations, in example, using only the MPI or combining with PThread and multi device accelerator (Fig. 1
                        ).

It is known that the intrinsic nature of NL-Means algorithm allows to use multi-threading, MPI, GPGPU or hybrid implementation. In this work, we propose a hybrid parallelization scheme. So, we divided the volume into sub-volumes, each of them separately. However, the NL-Means filter has a boundary condition. Then, the search region is reduced at boundary zone. To avoid all boundary problems, we split the image into superimposed images with superposition of search region radius. Fig. 2(b) illustrates our implementation scheme. Indeed, in this example we considered a cluster of four nodes, the normalized input image (between 0 and 1) is divided into four superimposed images. Then, the master (node 0) broadcast to all other nodes via MPI its superimposed image part. In each node we perform our proposed NL-means algorithm using PThreads (or GPUs).

For a GPU-based implementation, we used the library CUDA-7.5 provided by NVidia [5]. We also used the ITK-4.2 library [3] for reading, writing and rescaling images. All of them are compiled with gnu-gcc-4.5.0 compiler. A 3D input image is mapped on a 2D grid CUDA's thread and the best configuration that was found, empirically, is 128 threads per block (4 warps of 32 threads) and allows to maximize the memory occupancy. The proposed NL-Means kernel uses 37 registers per thread. In other terms: 4736 registers per block. The specifications of the Nvidia Tesla C2050 show that it can provide more than 32,768 registers for each block. As the kernel uses 4736 registers for each block each steaming multiprocessor (SM) and it is limited to simultaneously executing 6 blocks (24 warps), then, the ratio of occupancy of 50% was achieved.

The difference between our implementation and those that can be found in the literature is that each CUDA's thread processes a voxel of the input image, thus, the denoising algorithm is called by each thread. Moreover, the global memory of the GPU is used to store the whole input image. The mean and variance of the input image are computed by the host using all CPU threads available and then send to the GPU device. In the case of multi GPUs device, each one is controlled by one host thread. Then, the normalized input image is split into superimposed images, afterwards, send to the device to compute. Finally, the final result is collected by the host.

@&#RESULTS AND DISCUSSION@&#

In this subsection, the sensitivity of the proposed NL-Means algorithm versus the variations of parameters’ values is presented. These parameters are search region size, local neighborhood size, smoothing parameter, mean ratio, and variance ratio. In all experiments, the used MRI image from Brain-web database [1] and are of size 181×217×181.

The noise in the simulated images has Rayleigh distribution in the background and Rician statistics in the signal regions. The “percent noise” number represents the percent ratio of the standard deviation of the white Gaussian noise versus the signal for a reference tissue. For T1 image, the noise reference tissue is the White-Matter, its gray level is 150 in 8-bit unsigned image. The noised histogram is obtained by subtraction from the noisy image to ground truth (free noise) image. Fig. 3
                            shows the histogram of 9% noise image and the statistical measurement of noise for different degrees of noise. Different statistical properties of the noise are presented in Table 1
                           .


                           Fig. 4
                           e shows the influence of automatic determination of the smoothing parameter 
                              
                                 h
                                 2
                              
                              =
                              2
                              β
                              
                                 
                                    
                                       σ
                                       ˆ
                                    
                                 
                                 2
                              
                              |
                              
                                 N
                                 i
                              
                              |
                           . As described on Section 3.1, h is a function of the global standard deviation 
                              
                                 σ
                                 ˆ
                              
                            of the noise. The parameter β allows to adjust the estimation of h
                           2. The obtained best value of β is 0.5 for low and medium noise level (σ
                           =9%, 15%). For high noise level (σ
                           =21%), the noise estimation has some bias, and the best value of β is 2.


                           Fig. 4c and d shows the influence of the size of the search region and the local neighborhood (kernel) on the performance of the proposed NL-Means algorithm. One can notice that that the optimal search region depends on the input image. Indeed, the increase of the search region radius decreases PSNR i.e. the search region radius is greater than 5 for a low and medium noise level. For high noise level the PSNR does not vary, so the minimum search region is fitted looking to the obtained performance. Regarding the kernel radius, as it can be seen its increase decreases the PSNR value. Then, the best values of the kernel and the search region radius are 1 and 5, respectively.

the voxels that have the mean and the variance (of the local neighborhood) whose verify the Eq. (10) are selected to compute the weight. This heuristic takes into account the influence of the small weights. It allows to accelerate the algorithm and also to increase the PSNR of the denoised image. Fig. 4a and b illustrate influence of mean ratio and variance ration. In the first study, the mean ratio goes from 0.5 to 1, the variance ratio=0.5, β
                           =0.5, kernel radius=1, and the search region radius=5. While in the second study, the variance ratio goes from 0.1 to 1, and the mean ratio=0.95. From these experiments, one can notice that the optimal values for the mean ratio is 0.95 and for variance ratio is 0.5.

Many comparative study between NL-Means filter and others denoising filters has demonstrated the power of this filter [9,14,19]. In this work, we compare the proposed NL-Means enhancement to the original NL-Means. In this experiment the peak signal to noise ratio (PSNR) is computed with an eclipse mask image of radius 43×50×45 in 
                           
                              OX
                              →
                           
                           ,
                           
                              OY
                              →
                           
                        , and 
                           
                              OZ
                              →
                           
                         directions, respectively.

As it can be seen in Fig. 4f, the proposed NL-Means algorithm provides the best values of PSNR whatever the noise level. Moreover, an average enhance of 4.07dB is observed compared with the original NL-Means. The Fig. 5
                         shows the visual result of our proposed NL-Means denoising method compared to the original NL-Means in simulated MRI image from the considered database  [1]. The subtraction image obtained from the real image and the noisy image, the original NL-Means result, and the proposed NL-Means result are presented on Fig. 6
                        . The bottom of this Figure shows the histogram of the subtraction images. The obtained standard deviations are: 15.36 for the noisy image (σ
                        =9%), 9.42 and 8.05 for the original NL-Means and for the proposed NL-Means, respectively.

Moreover, the proposed approach was applied on a real world MRI images. To illustrate the obtained result, the Fig. 7
                         where an image of size 347×383×295 is considered. On can notice that the proposed method in this case does not perform better than the original approach.

To measure the speed-up, we exclude the loading and rescaling image time. We first observe the execution times of different NL-Means schemes with previous configuration on Fig. 8
                        (a). The complexity in term of number of floating-point operations is shown on Fig. 8(b). “Org”, “SW”, “PV”, “Pro” denote original NL-Means, Symmetric Weight, Voxel Preselection and the proposed NL-Means, respectively. “PV+SW” denotes fusion of Symmetric Weight and Voxel Preselection. The proposed NL-Means achieves an acceleration of 12.6 in terms of complexity. One can notice from Fig. 8(a) that the original NL-Means is suitable for the parallelization because of the linear increase of its speed-up when the number of processors used goes from 1 to 32.

The Fig. 9
                         presents the performances in terms of speed-ups, herein, a comparison to the sequential implementation of the original (traditional) NL-Means is performed. One can see that the symmetric weight scheme allows to reduce the computation time by approximately a factor 2. Furthermore, it can be seen that the proposed NL-Means method has a higher gain but the increase of its speed-up is not linear when the number of processors increases. It can be also noticed that the estimator has a bias when the noise level is low.

In Fig. 10
                        , we present a comparison of the performances in terms of speed-up between the different parallel implementations. One can notice that our implementation outperforms all other versions. However, these performances are not linear and depend on the dataset at hand, but, at least we obtained the same performance as other versions.

In Table 2
                         the total speed-up of different improvements of the NL-Means schemes is compared with the sequential version of the original NL-Means. In the case of the hybrid implementation (MPI and PThread and GPUs), the proposed NL-Means leads to an overall reduction of computation time by a factor 
                           
                              798.1192
                              1.5635
                           
                           =
                           510.46
                         using four GPUs on two clusters of eight cores. A factor of 
                           
                              798.1192
                              5.3864
                           
                           =
                           148.17
                         has been obtained using four clusters of eight cores (total of 32 cores).

@&#DISCUSSION@&#

One can see that the speed-up of our proposed NL-Means is not linear versus the number of used processors. This is due to the pre-selection procedure. Indeed, at the start, the volume is split into number of processors. One of the consequences of the pre-selection procedure is that some processors have less number of weights to compute. To avoid this imbalance of the task, one can first search from all procedures those that can be ignored, then, the image is divided on a certain number that depends on the number of ignored procedures. Besides, on the CUDA implementation, the atomic operation on the global memory to update safely the normalized and the accumulated weights handicaps the performance of the proposed NL-Means. A drawback of our proposed NL-Means implementation is its high memory usage. It needs three times more than the original method does.

@&#CONCLUSION@&#

This paper presents an optimized version of Non Local Means algorithm in terms of visual and acceleration applied to 3D medical data. The validation is based on Brainweb database [1] and the visual quality and the PSNR indicator were used for objective and subjective evaluations. Our proposed implementation combines the voxels’ preselection and the symmetric weight enhanced associated to an optimal distributed multi-threading and multi-GPUs implementation. The obtained results showed a considerably decrease of the required computation time (up to a factor of 510). The sources of the proposed algorithm are available at [28]. In works under progress, we will work on 4D data by extending our approach and streaming pipeline to reduce memory consummation. Moreover, we will do an implementation of the proposed filter on OpenCL (Open Computing Language) to allow the use of the same code for the CPU and the GPU. Additionally, the OpenCL compiler for the CPU will often vectorize the code, to provide additional speedup compared to only using several CPU threads.

@&#REFERENCES@&#

