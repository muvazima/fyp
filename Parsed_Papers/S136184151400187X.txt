@&#MAIN-TITLE@&#Robust whole-brain segmentation: Application to traumatic brain injury

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           A robust and fully-automatic segmentation framework for MR brain scans is proposed.


                        
                        
                           
                           A heterogeneous cohort of 125 scans of patients who had sustained TBI is segmented.


                        
                        
                           
                           The approach compares favourably to the state-of-the-art on benchmark and TBI data.


                        
                        
                           
                           MRI based biomarkers correlate with outcome-relevant clinical variables in TBI.


                        
                        
                           
                           Evidence that subcortical structures are particularly affected in TBI is presented.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Traumatic brain injury

Magnetic resonance imaging

Multi-atlas segmentation

Brain image segmentation

Expectation–maximisation

@&#ABSTRACT@&#


               
               
                  We propose a framework for the robust and fully-automatic segmentation of magnetic resonance (MR) brain images called “Multi-Atlas Label Propagation with Expectation–Maximisation based refinement” (MALP-EM). The presented approach is based on a robust registration approach (MAPER), highly performant label fusion (joint label fusion) and intensity-based label refinement using EM. We further adapt this framework to be applicable for the segmentation of brain images with gross changes in anatomy. We propose to account for consistent registration errors by relaxing anatomical priors obtained by multi-atlas propagation and a weighting scheme to locally combine anatomical atlas priors and intensity-refined posterior probabilities. The method is evaluated on a benchmark dataset used in a recent MICCAI segmentation challenge. In this context we show that MALP-EM is competitive for the segmentation of MR brain scans of healthy adults when compared to state-of-the-art automatic labelling techniques. To demonstrate the versatility of the proposed approach, we employed MALP-EM to segment 125 MR brain images into 134 regions from subjects who had sustained traumatic brain injury (TBI). We employ a protocol to assess segmentation quality if no manual reference labels are available. Based on this protocol, three independent, blinded raters confirmed on 13 MR brain scans with pathology that MALP-EM is superior to established label fusion techniques. We visually confirm the robustness of our segmentation approach on the full cohort and investigate the potential of derived symmetry-based imaging biomarkers that correlate with and predict clinically relevant variables in TBI such as the Marshall Classification (MC) or Glasgow Outcome Score (GOS). Specifically, we show that we are able to stratify TBI patients with favourable outcomes from non-favourable outcomes with 64.7% accuracy using acute-phase MR images and 66.8% accuracy using follow-up MR images. Furthermore, we are able to differentiate subjects with the presence of a mass lesion or midline shift from those with diffuse brain injury with 76.0% accuracy. The thalamus, putamen, pallidum and hippocampus are particularly affected. Their involvement predicts TBI disease progression.
               
            

@&#INTRODUCTION@&#

With an estimated annual global incidence of 6.8million cases, traumatic brain injury (TBI) imposes a significant burden on patients, their families, and health services (Irimia et al., 2012). Usually caused by sudden acceleration/deceleration or focal impacts, the lesions caused can be focal as in the case of contusions or more diffuse (diffuse axonal injury (DAI)) (Meythaler et al., 2001; Warner et al., 2010b). It is common for patients to have a combination of these. After the acute injury secondary processes including complex metabolic cascades, alterations in cerebral blood flow and raised intracranial pressure may occur contributing to the burden of injury. It is well recognised that complex pathophysiological processes including secondary Wallerian-type degeneration continue to occur months to years after the initial insult (Meythaler et al., 2001; Ding et al., 2008; Warner et al., 2010a). In order to improve treatment stratification and patient outcomes, as well as more accurately predict outcome, we need to better understand the complexity and heterogeneity of TBI both in the acute and chronic stages.

Although patterns of abnormalities have been shown to be predictors of outcome, such use of imaging data is mainly based on expert interpretation of visually inspected X-ray computed tomography (CT) images. Standard models to predict the outcome of TBI patients remain unavailable (Irimia et al., 2012). To assist the understanding of TBI disease progression, accurate quantitative assessment of the structural changes occurring during and after TBI is crucial. Segmentation of structural magnetic resonance (MR) images offers a potential way to gain more insight. For example, in Bendlin et al. (2008) brain volume loss following TBI has been identified using tissue segmentation techniques on structural MR images (MRIs) and diffusion tensor imaging (DTI). In Irimia et al. (2011) an intra-patient time point comparison has been performed on three representative TBI patients using semi-automatic methods for tissue and lesion classification and 3D model generation. Ramlackhansingh et al. (2011) used structural MRI and positron emission tomography (PET) to demonstrate inflammatory processes that remain active for months or years following brain trauma. An overview of existing structural MRI findings in mild TBI is provided in Shenton et al. (2012). Most of the few existing studies (Strangman et al., 2010; Warner et al., 2010a,b) that analyse structural morphometric measures are based on the segmentation techniques available in FreeSurfer (Fischl et al., 2002) and investigate small patient cohorts (Warner et al., 2010a,b). In Warner et al. (2010b) the authors investigate the correlation between structural brain atrophy of 25 patients with DAI and functional outcome. Several brain structures showed significantly increased structural atrophy when compared to a control group 8months post injury (Warner et al., 2010b). In Strangman et al. (2010), fifty patients that sustained TBI were enrolled in a memory rehabilitation program and their individual progress recorded. The study investigated the predictive value of structural brain volumes with respect to the outcome of the rehabilitation (Strangman et al., 2010). Both studies (Strangman et al., 2010; Warner et al., 2010b) identified several structures, including the thalamus and hippocampus that are particularly affected by TBI and are of significant value when predicting clinical outcome.

The automatic structural segmentation of MR brain scans of TBI patients remains, however, a difficult endeavour as most existing methods lack robustness towards TBI-related changes in anatomy (Irimia et al., 2011, 2012). In the acute phase contusions, the presence of blood, hydrocephalus and/or oedema can greatly affect the ability to accurately segment a brain. In more chronic scans gliosis and atrophy are also often poorly dealt with using currently available segmentation methods. It is this high variability and extent of brain change following a moderate or severe TBI that makes the segmentation task so demanding. An exemplar subject with highly abnormal brain configuration is shown with overlaid automatic segmentations in Fig. 1
                      to illustrate the difficulty of the segmentation task.

A popular class of automatic segmentation algorithms is multi-atlas label propagation with origins in Rohlfing et al. (2004b) and Heckemann et al. (2006). In multi-atlas label propagation, each of the semi-automatically or completely manually annotated atlases is individually aligned with the unsegmented target image. The propagated segmentations are then merged into a consensus label at each voxel in the target image. Voxelwise label conflicts can be resolved using either simple, unweighted approaches (Rohlfing et al., 2004a; Heckemann et al., 2006; Aljabar et al., 2009) or by weighting individual contributions locally based on the intensity information from the atlas and target images (Artaechevarria et al., 2009; Sabuncu et al., 2010). Alternative fusion strategies based on statistical optimisation have been proposed, with the most popular representative being STAPLE (Warfield et al., 2004) and its modifications (Asman and Landman, 2011, 2013; Landman et al., 2012; Cardoso et al., 2013a). A more detailed overview of atlas-based methods is provided by Cabezas et al. (2011). A particular successful strategy called joint label fusion was recently proposed by Wang et al. (2013). In this state-of-the-art approach, as evaluated in (Landman and Warfield, 2012), segmentation bias is reduced by estimating joint segmentation errors of different atlas pairs (Wang et al., 2013).

Atlas propagation techniques rely on the accurate registration of the atlas and unsegmented MR image to determine the spatial transformation of the atlas labels into the target space. This can be difficult if the target image differs from the available atlases due to the presence of pathology.

Recently, Liu et al. (2014) presented a promising approach based on low-rank matrix decomposition to register multiple images of TBI patients simultaneously to a reference image. In Niethammer et al. (2011), the authors formulated a geometric metamorphosis model to address the challenges arising in the registration of images from TBI, tumour or stroke patients. Other approaches iteratively register and segment the images simultaneously to identify missing correspondences (Periaswamy and Farid, 2006; Chitphakdithai and Duncan, 2010). Based on a seed, Zacharaki et al. (2009) simulated tumour growth in an atlas image before registering it to a tumour patient. Next to this, more standard approaches often rely on a mask to ignore abnormal regions during the registration process (Brett et al., 2001; Stefanescu et al., 2004; Andersen et al., 2010). However, methods that rely on strong prior knowledge such as masks or tumour growth models are in general not applicable for the segmentation of subjects with heterogeneous pathologies as they are often present in TBI patients. Bauer et al. (2013) provide a comprehensive overview on image analysis in the context of brain tumours.

In addition, there have been several methods proposed to address the challenge of registering abnormal adult brain images of Alzheimer’s Disease (AD) patients. In Wolz et al. (2010a) a manifold of atlases and unsegmented MR images is learned to robustly propagate the atlas label sets to all unsegmented images within the manifold. Another approach, “Multi-Atlas Propagation with Enhanced Registration” (MAPER) (Heckemann et al., 2010, 2011), employs automatically calculated tissue classification into the registration process to enable robust image alignment, even if the target image shows severe brain atrophy. Recently, methods based on nonlocal patch-based label fusion have been proposed (Coupé et al., 2011; Rousseau et al., 2011) that rely on affine alignment with a template library and thus relax the requirement for accurate nonrigid registrations. Patch-based methods have been developed further, often with focus on a particular application. For example Tong et al. (2013) used dictionary learning and sparse coding for hippocampal segmentation in patients with AD, while Wang et al. (2014) applied patch-driven level sets to tissue segmentation in neonates. However, while in AD brain changes are consistent with disease progression, MR brain images of patients with TBI can show inconsistent and gross pathological change as demonstrated in Fig. 1. Fig. 1 further shows that established registration techniques such as MAPER (Heckemann et al., 2010) or SyN (Avants et al., 2008) struggle to establish a plausible mapping between the available atlas images and an image of an abnormal brain. Both the presence of gross deformation and the potential absence of brain tissue prevent an accurate anatomical correspondence estimation. Even the application of a state-of-the-art label fusion technique (Wang et al., 2013) is not able to correct the substantial and consistent errors of alignment.

Atlas-based segmentation can be further improved by incorporating intensity information from the unseen image through a Gaussian mixture model (GMM) (Van Leemput et al., 1999; Fischl et al., 2002). The resulting optimisation problem is often solved using expectation–maximisation (EM) (Van Leemput et al., 1999; Lötjönen et al., 2010; Cardoso et al., 2011; Cardoso et al., 2013b; Ledig et al., 2012) or graph cuts (van der Lijn et al., 2008; Wolz et al., 2010b). While the EM approach enables simultaneous probabilistic segmentation of multiple brain structures, graph-cut based methods yield binary labels for individual structures. Also approaches that propagate atlas labels over a graph (Wolz et al., 2010a; Cardoso et al., 2013c) or within clusters (Ribbens et al., 2014) enjoy increasing attention in the community. In the context of brain tissue segmentation it has been further shown that the relaxation of anatomical atlas priors can improve segmentation quality (Cardoso et al., 2011, 2013b).

As an alternative or complement to either approach, Wang et al. (2011) proposed to use machine learning techniques to learn systematic segmentation errors that are then corrected in a post-processing step.

Atlas-based approaches require a number of brain atlases that, in the ideal case, have been generated by expert manual delineation. In this work we use an atlas set that was the basis of a recent whole-brain segmentation challenge (MICCAI 2012 Grand Challenge and Workshop on Multi-Atlas Labeling, Landman and Warfield (2012)). We can thus provide a direct comparison to the methods that were evaluated in this competition. In general, other whole-brain atlases are equally suitable for the proposed approach.

The main motivation for our work was to devise a fully automatic and robust segmentation method that allows accurate measurement of various brain structures in MR images in the presence of severe pathologies, as exemplified in Fig. 1. Specifically, we are interested in the analysis of MR brain scans acquired of patients that had sustained traumatic brain injury.

The method described in this work addresses a key need in the management of TBI, that was identified by Irimia et al. (2012): “[…] the key methodological hurdle that must be overcome in order to make structural neuroimaging a powerful tool for predicting TBI outcome is the current paucity of automated image processing methods that can allow researchers to analyse large numbers of TBI CT/MRI volumes without the need for excessive user input or intervention.”

We pursue this objective on three levels. First, we combine the best features of state-of-the-art atlas-based segmentation tools into a new framework, MALP-EM, by building on MAPER and adding the benefits of joint label fusion and an intensity-based refinement using EM. Second, we adapt this method for the challenges posed by highly abnormal brain configurations. To achieve this, we use a prior relaxation scheme that corrects anatomical atlas priors in regions where accurate alignment of the images is impossible due to missing brain tissue or severe deformation. We further employ a data-driven and locally adaptive weighting scheme to combine anatomical atlas prior probabilities and intensity-refined posterior probabilities for maximum benefit. Third, we use the modified MALP-EM algorithm to segment 125 MR brain scans of a heterogeneous population of 101 subjects who had sustained TBI. To assess segmentation accuracy on this TBI cohort, we devised a specific protocol that was independently followed by three blinded raters. This protocol enables an expert to rate hippocampus, thalamus, putamen and occipital pole segmentation quality in the absence of manual reference segmentations.

We then derive volumetric biomarkers based on an index that quantifies asymmetry between structures appearing both in the left and right brain hemisphere (absolute asymmetry index, AAI). We show the potential of single time-point MR imaging based variables to correlate with and predict outcome-relevant clinical variables.

@&#MATERIAL AND METHODS@&#

We obtained 
                              
                                 
                                    
                                       T
                                    
                                    
                                       1
                                    
                                 
                              
                           -weighted MR brain images of 101 TBI patients provided through the University Division of Anaesthesia, Cambridge University, UK. The images were acquired using an MPRAGE sequence on a Siemens MAGNETOM TrioTim Syngo with parameters: TR 2300ms, TE 2.98ms, TI 900ms, flip angle 9°, matrix size 256
                           
                              
                                 ×
                              
                           
                           240
                           
                              
                                 ×
                              
                           
                           176 and an isotropic voxel size of 1.0mm
                           
                              
                                 ×
                              
                           
                           1.0mm
                           
                              
                                 ×
                              
                           
                           1.0mm. Patients underwent MRI in the acute-phase, as part of the follow-up, or both. As only 24 patients had MR scans at both time points, we focus on a cross-sectional analysis in this work. In total we had 125 datasets available, including 61 acute and 64 follow-up MR brain scans. Information about the patients’ gender and age distributions, the elapsed time between scanning date and injury and the Glasgow Coma Score (GCS) is summarised in Table 1
                           . The GCS is a clinical score that quantifies a patient’s level of consciousness in the acute stage of the injury (Teasdale and Jennett, 1974). The datasets were further grouped by clinical scores using Marshall Classification (MC, Marshall et al. (1991)) and the Glasgow Outcome Score (GOS, Jennett and Bond (1975)), as shown in Table 2
                           . MC is a score based on the worst acute computed tomography (CT) image within 24h of injury. MC takes into account brain pathology such as lesion load, the presence of oedema and midline shift caused by the injury. In contrast, the GOS is a clinical measure categorising the outcome of TBI and is assessed 6months after injury or once the TBI outcome is considered stable. In Section 3.2.3 we describe correlations of these clinical scores with asymmetry biomarkers derived from brain MR scans. Details of the definition of the Marshall Classification and Glasgow Outcome Scale are provided in Appendices B and C.

The atlas cohort used in this study consisted of 35 manually annotated MR brain images of 30 subjects of the OASIS database (Marcus et al., 2007). The manual segmentation into 138 anatomical structures has been carried out by experts according to publicly available protocols
                              1
                              
                                 http://www.cma.mgh.harvard.edu/manuals/segmentation/ and http://www.braincolor.org (last accessed: 8 December 2014).
                           
                           
                              1
                            and were provided by Neuromorphometrics, Inc. (http://Neuromorphometrics.com/, last accessed: 8 December 2014) under academic subscription. The same atlas cohort was used in the recent “MICCAI 2012 Grand Challenge and Workshop on Multi-Atlas Labeling” (Landman and Warfield, 2012). As suggested by Landman and Warfield (2012), the small regions (order of 100 voxels each) “vessel” and “cerebral exterior” were excluded in our experiments in both the left and the right hemisphere, so that we effectively investigated 134 structures. In five of the subjects, repeat scans were acquired in a second session within 90days of the original scan (Marcus et al., 2007).

The 134 atlas labels comprise 63 anatomical structures which have symmetric counterparts in their opposite hemisphere, in total 126 labels (see Appendix A). The remaining eight unpaired structures are: 3rd ventricle, 4th ventricle, brain stem, CSF, optic chiasm, cerebellar vermal lobules I–V, cerebellar vermal lobules VI–VII, cerebellar vermal lobules VIII–X.

To present our framework called “Multi-Atlas Label Propagation with Expectation–Maximisation based refinement” (MALP-EM), we employ the following notation:

We label an unsegmented 
                              
                                 
                                    
                                       T
                                    
                                    
                                       1
                                    
                                 
                              
                           -weighted MR image 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                            into 
                              
                                 K
                                 =
                                 134
                              
                            structural regions. We index 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                                 =
                                 {
                                 
                                    
                                       y
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 
                                    
                                       y
                                    
                                    
                                       2
                                    
                                 
                                 ,
                                 …
                                 ,
                                 
                                    
                                       y
                                    
                                    
                                       n
                                    
                                 
                                 }
                              
                            where 
                              
                                 
                                    
                                       y
                                    
                                    
                                       i
                                    
                                 
                                 ∈
                                 R
                              
                           , with 
                              
                                 i
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 n
                              
                           , denotes the intensity value of the ith voxel. To incorporate expert knowledge into the segmentation process, we employ M manually annotated brain atlases denoted by 
                              
                                 
                                    
                                       A
                                    
                                    
                                       m
                                    
                                 
                              
                            with 
                              
                                 m
                                 =
                                 1
                                 ,
                                 …
                                 ,
                                 M
                              
                           . 
                              
                                 
                                    
                                       ϕ
                                    
                                    
                                       m
                                    
                                 
                              
                            denotes the calculated transformation from the atlas space of 
                              
                                 
                                    
                                       A
                                    
                                    
                                       m
                                    
                                 
                              
                            in the coordinate system of 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                            and 
                              
                                 
                                    
                                       A
                                    
                                    
                                       m
                                    
                                    
                                       ϕ
                                    
                                 
                              
                            denotes the propagated atlas. Employing multi-atlas label fusion we then create a subject specific probabilistic segmentation 
                              
                                 Π
                                 =
                                 {
                                 
                                    
                                       π
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 
                                    
                                       π
                                    
                                    
                                       2
                                    
                                 
                                 ,
                                 …
                                 ,
                                 
                                    
                                       π
                                    
                                    
                                       n
                                    
                                 
                                 }
                              
                            that is, based on image intensities, relaxed to 
                              
                                 
                                    
                                       Π
                                    
                                    
                                       R
                                    
                                 
                              
                            and used as spatial prior in the EM framework. Using an EM approach, we then estimate an intensity-refined probabilistic segmentation of 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                           , denoted by 
                              
                                 Z
                                 =
                                 {
                                 
                                    
                                       z
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 
                                    
                                       z
                                    
                                    
                                       2
                                    
                                 
                                 ,
                                 …
                                 ,
                                 
                                    
                                       z
                                    
                                    
                                       n
                                    
                                 
                                 }
                              
                           . Here 
                              
                                 
                                    
                                       π
                                    
                                    
                                       i
                                    
                                 
                                 ,
                                 
                                    
                                       π
                                    
                                    
                                       i
                                    
                                    
                                       R
                                    
                                 
                              
                            and 
                              
                                 
                                    
                                       z
                                    
                                    
                                       i
                                    
                                 
                              
                            are vectors of size K and the 
                              
                                 
                                    
                                       k
                                    
                                    
                                       th
                                    
                                 
                              
                            component represents the probability that a voxel i belongs to a region k. Thus 
                              
                                 Π
                              
                            denotes the subject specific probabilistic segmentation before intensity-based refinement and Z after intensity-based refinement respectively. We abbreviate the normal distribution 
                              
                                 N
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       k
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       k
                                    
                                 
                                 )
                              
                            with 
                              
                                 
                                    
                                       N
                                    
                                    
                                       k
                                    
                                 
                              
                            where 
                              
                                 
                                    
                                       μ
                                    
                                    
                                       k
                                    
                                 
                              
                            is the mean and 
                              
                                 
                                    
                                       σ
                                    
                                    
                                       k
                                    
                                 
                              
                            the standard deviation of the intensity distribution within label k.

For each unsegmented image 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                           , we obtain M transformations 
                              
                                 
                                    
                                       ϕ
                                    
                                    
                                       m
                                    
                                 
                              
                            by registering M manually generated atlases to the coordinate space of 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                           . In this study we employ the enhanced registration approach that has been developed as part of MAPER (Heckemann et al., 2010). MAPER incorporates tissue probability maps into a nonrigid registration scheme based on free-form deformations (Rueckert et al., 1999; Modat et al., 2010).

A probabilistic map 
                              
                                 
                                    
                                       π
                                    
                                    
                                       k
                                    
                                 
                              
                            of each anatomical structure k is then formed from the M transformed atlases 
                              
                                 
                                    
                                       A
                                    
                                    
                                       m
                                    
                                    
                                       ϕ
                                    
                                 
                              
                            using the joint label fusion strategy presented by Wang et al. (2013). We employed the publicly available implementation at https://www.nitrc.org/projects/picsl_malf/ (Version 1.2, last accessed: 8 December 2014) with standard parameters. We have used joint label fusion as it has been shown to be a leading label fusion technique (Landman and Warfield, 2012). This procedure is illustrated in Fig. 2
                           .

Segmentation refinement based on image intensities relies heavily on the probabilistic priors 
                              
                                 Π
                              
                           . As a consequence, the segmentation at voxel i cannot be refined if all atlases agreed on a certain label k (
                              
                                 
                                    
                                       π
                                    
                                    
                                       ik
                                    
                                 
                              
                            close to or equal to 1). In general, this is a sensible constraint assuming that at least a subset of the propagated atlases votes for the correct label. When segmenting MR scans showing significant pathologies or abnormalities, however, there is evidence that this assumption is no longer justified. Especially in regions that undergo large deformations, for example the inferior lateral ventricles when the target region is enlarged due to injury, swelling or atrophy, we observed unanimous bias in all individual segmentations. Label fusion approaches can thus return substantial mislabelling of subcortical grey matter structures such as the hippocampus, as well as of cortical regions. This problem is illustrated in the top left image of Fig. 3
                           . The intensity-based EM-refinement is restricted by these high prior label probabilities 
                              
                                 Π
                              
                            and thus unable to entirely correct this systematic error.

We tackle this problem by calculating relaxed priors 
                              
                                 
                                    
                                       Π
                                    
                                    
                                       R
                                    
                                 
                              
                            from the label probabilities 
                              
                                 Π
                              
                           . Specifically we relax the probabilistic priors based on the probabilistic label fusion estimates and the actual image intensities. Assuming a Gaussian distribution, we estimate a common parameter set 
                              
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       CSF
                                       -
                                       like
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       CSF
                                       -
                                       like
                                    
                                 
                                 )
                              
                            of eight “CSF-like” structures. We define the set of structures denoted as “CSF-like” as {background (essentially external CSF), 3rd ventricle, 4th ventricle, CSF, right/left inferior lateral ventricle, right/left lateral ventricle}. We furthermore estimate for each structure k an individual parameter set 
                              
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       k
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       k
                                    
                                 
                                 )
                              
                            based on the probabilistic prior segmentation 
                              
                                 Π
                              
                           :
                              
                                 (1)
                                 
                                    
                                       
                                          μ
                                       
                                       
                                          k
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                             
                                          
                                          
                                             
                                                π
                                             
                                             
                                                ik
                                             
                                          
                                          
                                             
                                                y
                                             
                                             
                                                i
                                             
                                          
                                       
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                             
                                          
                                          
                                             
                                                π
                                             
                                             
                                                ik
                                             
                                          
                                       
                                    
                                    ,
                                    
                                    
                                    
                                    
                                       
                                          σ
                                       
                                       
                                          k
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                   
                                                
                                                
                                                   
                                                      π
                                                   
                                                   
                                                      ik
                                                   
                                                
                                                
                                                   
                                                      (
                                                      
                                                         
                                                            y
                                                         
                                                         
                                                            i
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            μ
                                                         
                                                         
                                                            k
                                                         
                                                      
                                                      )
                                                   
                                                   
                                                      2
                                                   
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                   
                                                
                                                
                                                   
                                                      π
                                                   
                                                   
                                                      ik
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        

In the actual relaxation step we then redistribute a fraction 
                              
                                 
                                    
                                       α
                                    
                                    
                                       ik
                                    
                                 
                              
                            of the prior probability, 
                              
                                 
                                    
                                       π
                                    
                                    
                                       ik
                                    
                                 
                              
                           , from a structure k to one of the eight CSF-like structures 
                              
                                 
                                    
                                       k
                                    
                                    
                                       CSF
                                    
                                 
                              
                           . At an image voxel i, we determine 
                              
                                 
                                    
                                       k
                                    
                                    
                                       CSF
                                    
                                 
                              
                            as the CSF-like structure with the highest prior probability or the label that is spatially closest to the voxel i:
                              
                                 (2)
                                 
                                    
                                       
                                          k
                                       
                                       
                                          CSF
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            
                                                               arg
                                                               
                                                               max
                                                            
                                                            
                                                               k
                                                               
                                                               is
                                                               
                                                               CSF
                                                               -
                                                               like
                                                            
                                                         
                                                      
                                                      
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                   
                                                   
                                                      if
                                                      
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                      
                                                      ≠
                                                      
                                                      0
                                                      
                                                      for
                                                      
                                                      at
                                                      
                                                      least
                                                      
                                                      one
                                                      
                                                      k
                                                      
                                                      ∈
                                                      
                                                      CSF
                                                      -
                                                      like
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            
                                                               arg
                                                               
                                                               min
                                                            
                                                            
                                                               k
                                                               
                                                               is
                                                               
                                                               CSF
                                                               -
                                                               like
                                                            
                                                         
                                                      
                                                      
                                                      d
                                                      (
                                                      k
                                                      ,
                                                      i
                                                      )
                                                   
                                                   
                                                      else
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           Here 
                              
                                 d
                                 (
                                 k
                                 ,
                                 i
                                 )
                              
                            denotes the Euclidean distance of voxel i to the closest point in label k. We then calculate 
                              
                                 
                                    
                                       α
                                    
                                    
                                       ik
                                    
                                 
                              
                            based on the probability that the voxel with intensity 
                              
                                 
                                    
                                       y
                                    
                                    
                                       i
                                    
                                 
                              
                            comes either from the intensity distribution 
                              
                                 
                                    
                                       N
                                    
                                    
                                       k
                                    
                                    
                                       Π
                                    
                                 
                              
                            estimated in label k or 
                              
                                 
                                    
                                       N
                                    
                                    
                                       CSF
                                       -
                                       like
                                    
                                    
                                       Π
                                    
                                 
                              
                            accordingly. We set 
                              
                                 α
                              
                            to:
                              
                                 (3)
                                 
                                    
                                       
                                          α
                                       
                                       
                                          ik
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      0
                                                   
                                                   
                                                      if
                                                      
                                                      
                                                         
                                                            N
                                                         
                                                         
                                                            k
                                                         
                                                         
                                                            Π
                                                         
                                                      
                                                      (
                                                      
                                                         
                                                            y
                                                         
                                                         
                                                            i
                                                         
                                                      
                                                      )
                                                      ⩾
                                                      
                                                         
                                                            N
                                                         
                                                         
                                                            CSF
                                                            -
                                                            like
                                                         
                                                         
                                                            Π
                                                         
                                                      
                                                      (
                                                      
                                                         
                                                            y
                                                         
                                                         
                                                            i
                                                         
                                                      
                                                      )
                                                   
                                                
                                                
                                                   
                                                      max
                                                      (
                                                      0
                                                      ,
                                                      min
                                                      (
                                                      0.5
                                                      -
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            
                                                               
                                                                  ik
                                                               
                                                               
                                                                  CSF
                                                               
                                                            
                                                         
                                                      
                                                      ,
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                      )
                                                      )
                                                   
                                                   
                                                      else
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           We thus do not allow the CSF-like label to exceed 50% probability and correct only voxels that have a higher probability of belonging to the CSF-like label 
                              
                                 
                                    
                                       k
                                    
                                    
                                       CSF
                                    
                                 
                              
                           , as defined in Eq. (2), than to k. Finally the relaxed prior probability 
                              
                                 
                                    
                                       Π
                                    
                                    
                                       R
                                    
                                 
                              
                            is calculated as:
                              
                                 (4)
                                 
                                    
                                       
                                          π
                                       
                                       
                                          ik
                                       
                                       
                                          R
                                       
                                    
                                    =
                                    
                                       
                                          
                                             
                                                
                                                   
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                      +
                                                      
                                                         
                                                            ∑
                                                         
                                                         
                                                            l
                                                            ≠
                                                            
                                                               
                                                                  k
                                                               
                                                               
                                                                  CSF
                                                               
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            α
                                                         
                                                         
                                                            il
                                                         
                                                      
                                                   
                                                   
                                                      if
                                                      
                                                      k
                                                      =
                                                      
                                                         
                                                            k
                                                         
                                                         
                                                            CSF
                                                         
                                                      
                                                   
                                                
                                                
                                                   
                                                      
                                                         
                                                            π
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                      -
                                                      
                                                         
                                                            α
                                                         
                                                         
                                                            ik
                                                         
                                                      
                                                   
                                                   
                                                      else
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           The two images on the left in Fig. 4
                            show where the voxel priors are relaxed by the proposed method, both for a distinctly abnormal brain and for a brain with a normal configuration.

The whole pipeline including registration, joint label fusion and prior relaxation is illustrated in Figs. 2 and 3.

We refine the relaxed probabilistic priors 
                              
                                 
                                    
                                       Π
                                    
                                    
                                       R
                                    
                                 
                              
                           , calculated using the joint label fusion and the prior relaxation as described in Section 2.2.3, based on the observed intensities of 
                              
                                 
                                    
                                       I
                                    
                                    
                                       u
                                    
                                 
                              
                            by employing the widely used EM-optimisation presented by Van Leemput et al. (1999). To be consistent with the published literature (Wells et al., 1996; Van Leemput et al., 1999; Zhang et al., 2001; Cardoso et al., 2011), we assume a normal distribution of the log-transformed intensities of voxels of a given label k. Each class k is then described by its mean 
                              
                                 
                                    
                                       μ
                                    
                                    
                                       k
                                    
                                 
                              
                            and standard deviation 
                              
                                 
                                    
                                       σ
                                    
                                    
                                       k
                                    
                                 
                              
                           .

The complete model parameters are 
                              
                                 {
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       1
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       1
                                    
                                 
                                 )
                                 ,
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       2
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       2
                                    
                                 
                                 )
                                 ,
                                 …
                                 ,
                                 (
                                 
                                    
                                       μ
                                    
                                    
                                       K
                                    
                                 
                                 ,
                                 
                                    
                                       σ
                                    
                                    
                                       K
                                    
                                 
                                 )
                                 }
                              
                           . A full description of the model can be found in Appendix D.

Smoothness of the final segmentation is enforced with a global and stationary Markov Random Field (MRF), which is integrated using the mean field approximation (Zhang, 1992), following the example of Van Leemput et al. (1999) and Cardoso et al. (2011).

In order to increase samples for small non-cortical brain structures and thus increase the robustness of the parameter estimate, we model symmetric brain structures (e.g. hippocampus left/right) with a single Gaussian distribution. This also allows a more consistent segmentation and thus subsequent volume comparison or symmetry inference. Furthermore, we model all voxels in cortical brain structures with a single Gaussian distribution.

Adjacent brain structures often have very similar intensity distributions, which makes an intensity-based refinement of their shared boundary difficult. Examples are adjacent cortical brain regions or the boundary between the hippocampus and the amygdala.

Furthermore, the presented intensity-based optimisation approach tends to calculate well-separated intensity distributions by reducing the intraclass variances 
                              
                                 
                                    
                                       
                                          
                                             
                                                σ
                                             
                                             
                                                k
                                             
                                             
                                                2
                                             
                                          
                                       
                                    
                                 
                              
                            within labels (Ledig et al., 2012). However, this often degrades segmentation results as it does not necessarily reflect manual labelling protocols. For example, the boundary between thalamus and adjacent white matter is determined by geometric characteristics, rather than by intensity characteristics (Hammers et al., 2003). As the boundaries of subcortical structures are not only defined by intensities, their intensity profile tends to have a wider spread (larger 
                              
                                 
                                    
                                       σ
                                    
                                    
                                       k
                                    
                                 
                              
                           ). This has been observed previously in Ledig et al. (2012) for subcortical structures such as the thalamus, caudate or putamen. For instance, the standard EM-optimisation is likely to relabel high intensity, ‘thalamus voxels’ in the vicinity of the thalamus/white matter boundary as ‘white matter’. This results in a reduced intraclass variance for the thalamus class and higher model likelihood. The segmentation accuracy is reduced, however, as the estimated boundary does not represent the manual protocol of the expert rater.

While intensity-based EM-refinement often provides little or no value for subcortical regions of healthy brains, it is a powerful technique to correct consistent registration failures, e.g. in the hippocampal region or in cortical regions. Here, the label estimate of a certain class k often contains several types of brain tissue resulting in large intraclass variance. These intensity distributions can effectively be optimised using the intensity-based refinement as described in Section 2.2.4.

We propose not to rely exclusively on either joint label fusion or EM-refined fusion, but to combine their probabilistic estimates into a common segmentation. Here, we describe the simple global formulation of the proposed model before introducing the spatially variant extension in Section 2.2.6.

Depending on a global weighting factor 
                              
                                 Γ
                                 ∈
                                 [
                                 0
                                 ;
                                 1
                                 ]
                              
                            we combine the spatial priors obtained by joint label fusion, 
                              
                                 Π
                              
                           , and the posteriors calculated based on intensity-based EM-optimisation, Z.

Specifically we combine the final posterior probability 
                              
                                 
                                    
                                       z
                                    
                                    
                                       ik
                                    
                                 
                              
                            and the spatial prior 
                              
                                 
                                    
                                       π
                                    
                                    
                                       ik
                                    
                                 
                              
                            to calculate a new probabilistic estimate 
                              
                                 
                                    
                                       z
                                    
                                    
                                       ik
                                    
                                    
                                       merged
                                    
                                 
                              
                            as:
                              
                                 (5)
                                 
                                    
                                       
                                          z
                                       
                                       
                                          ik
                                       
                                       
                                          merged
                                       
                                    
                                    =
                                    (
                                    1.0
                                    -
                                    Γ
                                    )
                                    
                                       
                                          z
                                       
                                       
                                          ik
                                       
                                    
                                    +
                                    Γ
                                    
                                       
                                          π
                                       
                                       
                                          ik
                                       
                                    
                                 
                              
                           
                        

A straightforward extension of this formulation is to model the weighting parameter 
                              
                                 Γ
                              
                            dependent on the spatial position i. This allows a variable weight for the contribution of either registration-driven (multi-atlas label propagation) or intensity-driven (EM-refinement) label estimates in the final segmentation. With the known characteristics of EM-refined results (cf. Section 2.2.5) in mind, we aim to formulate a model, which favours the geometry-driven and registration-based priors over the intensity-based refinement if there are no indications of substantial registration failures. On the other hand, our model must be flexible and consider the intensity-refined posterior probabilities if it is assumed that the multi-atlas propagation failed. This is often observed if the subject of interest shows severe brain abnormality due to disease related atrophy, traumatic deformation, or surgical resection of brain tissue (cf. Fig. 1).

Our basic assumption for an automatic choice of 
                              
                                 Γ
                              
                            is that the EM-refined segmentation Z should get a higher weight with increasing deviation from the segmentation obtained through label fusion 
                              
                                 Π
                              
                           .

Here, we assume that if a label has a similar intensity distribution before and after the intensity-based refinement, the result obtained through the label fusion 
                              
                                 Π
                              
                            is reliable for this label, and thus 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                            should be close to 1. In contrast, if for example the hippocampal label in 
                              
                                 Π
                              
                            erroneously contains ventricular CSF, the intensity distribution has a rather large standard deviation, because the label contains two tissue types. However, after intensity-based refinement the intensity distribution of the label in Z is rather sharp, because the mislabelling of CSF is corrected due to the intensity-based refinement. In this case – two or more intensity distributions within a label based on 
                              
                                 Π
                              
                            and Z – we aim to set 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                                 ≪
                                 1
                              
                           . This means that the more the EM-refined segmentation deviates from the prior the more it contributes to the final segmentation estimate.

To model this behaviour, we choose 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                            dependent on the most likely labels assigned to a certain voxel by the label fusion, 
                              
                                 
                                    
                                       k
                                    
                                    
                                       max
                                       ,
                                       i
                                    
                                 
                                 =
                                 
                                    
                                       arg
                                       
                                       max
                                    
                                    
                                       k
                                    
                                 
                                 
                                    
                                       π
                                    
                                    
                                       ik
                                    
                                 
                              
                           , and the EM-refinement, 
                              
                                 
                                    
                                       z
                                    
                                    
                                       max
                                       ,
                                       i
                                    
                                 
                                 =
                                 
                                    
                                       arg
                                       
                                       max
                                    
                                    
                                       k
                                    
                                 
                                 
                                    
                                       z
                                    
                                    
                                       ik
                                    
                                 
                              
                           . Specifically, we use the overlap of the normal distributions estimated on label 
                              
                                 
                                    
                                       z
                                    
                                    
                                       max
                                       ,
                                       i
                                    
                                 
                              
                            in both Z and 
                              
                                 Π
                              
                           , and for 
                              
                                 
                                    
                                       k
                                    
                                    
                                       max
                                       ,
                                       i
                                    
                                 
                              
                            accordingly. We thus calculate 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                            as:
                              
                                 (6)
                                 
                                    
                                       
                                          Γ
                                       
                                       
                                          i
                                       
                                    
                                    =
                                    
                                       ∫
                                       
                                          -
                                          ∞
                                       
                                       
                                          +
                                          ∞
                                       
                                    
                                    min
                                    
                                       
                                          
                                             
                                                
                                                   N
                                                
                                                
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         max
                                                         ,
                                                         i
                                                      
                                                   
                                                
                                                
                                                   Π
                                                
                                             
                                             (
                                             y
                                             )
                                             ,
                                             
                                                
                                                   N
                                                
                                                
                                                   
                                                      
                                                         k
                                                      
                                                      
                                                         max
                                                         ,
                                                         i
                                                      
                                                   
                                                
                                                
                                                   Z
                                                
                                             
                                             (
                                             y
                                             )
                                          
                                       
                                    
                                    dy
                                    
                                       ∫
                                       
                                          -
                                          ∞
                                       
                                       
                                          +
                                          ∞
                                       
                                    
                                    min
                                    
                                       
                                          
                                             
                                                
                                                   N
                                                
                                                
                                                   
                                                      
                                                         z
                                                      
                                                      
                                                         max
                                                         ,
                                                         i
                                                      
                                                   
                                                
                                                
                                                   Π
                                                
                                             
                                             (
                                             y
                                             )
                                             ,
                                             
                                                
                                                   N
                                                
                                                
                                                   
                                                      
                                                         z
                                                      
                                                      
                                                         max
                                                         ,
                                                         i
                                                      
                                                   
                                                
                                                
                                                   Z
                                                
                                             
                                             (
                                             y
                                             )
                                          
                                       
                                    
                                    dy
                                 
                              
                           
                        

This weighting approach is exemplified in Fig. 3. In this example, the common scenario is shown, in which joint label fusion labels a voxel as hippocampus, and the intensity-based refinement approach labels the same voxel as CSF. The two images on the right in Fig. 4 illustrate exemplary weights 
                              
                                 (
                                 1
                                 -
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                                 )
                              
                            for normal and abnormal images.

@&#EXPERIMENTS AND RESULTS@&#

The goal of this work was to devise a robust segmentation framework that can be employed to segment brain MRI with potentially highly abnormal brain configuration. Specifically we aimed to segment a database of traumatic brain injury patients and to extract biomarkers that can be correlated with clinical variables.

However, before applying the proposed methodology to clinical data in Section 3.2 we conducted quantitative experiments investigating our method’s performance and characteristics on a well-studied benchmark dataset. For this dataset reference labels, which were manually annotated by experts, are available. This allowed us to calculate label overlaps, to perform a test–retest analysis and to compare our method to other state-of-the-art approaches in Section 3.1.

For evaluating MALP-EM, we used the dataset provided in the course of the “MICCAI 2012 Grand Challenge and Workshop on Multi-Atlas Labeling” (Landman and Warfield, 2012) (cf. Section 2.1.2). The dataset consists of 35 
                           
                              
                                 
                                    T
                                 
                                 
                                    1
                                 
                              
                           
                        -weighted MR images with corresponding labels created manually by experts. As in the Grand Challenge, we divided the cohort into a training set of 15 subjects (10 female, 5 male, age: 23
                        
                           
                              ±
                           
                        
                        4.3 (mean
                        
                           
                              ±
                           
                        
                        SD) years, minimum age 19, maximum age 34) and a test set of 15 subjects (10 female, 5 male, age 45.7
                        
                           
                              ±
                           
                        
                        24.4, minimum age 18, maximum age 90). Including the 5 repeat scans, the test set consists of 20 images.

In total we compared five different approaches:
                              
                                 •
                                 MAPER (Multi-Atlas Propagation with Enhanced Registration): Standard MAPER as proposed by Heckemann et al. (2010).

MALP-JF (Multi-Atlas Label Propagation with Joint label Fusion): Segmentations obtained through joint label fusion using the implementation of Wang et al. (2013) with standard parameters.
                                       2
                                       Implementation publicly available at https://www.nitrc.org/projects/picsl_malf/ (Version 1.2, last accessed: 8 December 2014).
                                    
                                    
                                       2
                                    
                                 


                                    
                                       
                                          
                                             
                                                MALP-EM
                                             
                                             
                                                
                                                   
                                                      Γ
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                          
                                       
                                     (Multi-Atlas Label Propagation with Expectation–Maximisation based refinement): MALP-JF followed by the proposed prior relaxation (Section 2.2.3), the EM-refinement (Section 2.2.4) and the spatially varying merging strategy (Section 2.2.6).


                                    
                                       
                                          
                                             
                                                MALP-EM
                                             
                                             
                                                
                                                   
                                                      Γ
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                          
                                       
                                    -BC: 
                                       
                                          
                                             
                                                MALP-EM
                                             
                                             
                                                
                                                   
                                                      Γ
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                          
                                       
                                     with additional learning-based segmentation bias correction
                                       2
                                     as proposed by Wang et al. (2011). We consider this as the setup yielding the highest accuracy on this benchmark dataset.

PICSL-BC (PICSL research group - Bias Correction): best performing method in the Grand Challenge (Landman and Warfield, 2012) using SyN registration from the Advanced Normalization Tools (ANTs) and employs joint label fusion (Wang et al., 2013) and bias correction (Wang et al., 2011).

A further overview over the compared methods is provided in Table 3
                           .

We segmented each of the 20 test images into 134 regions and calculated Dice overlaps (similarity indices, SI, Dice (1945)) with the available manual segmentations. SI values for the different segmentation methods are shown in Table 4
                           . Individual SI values of non-cortical structures are shown in Appendix E.

We also compared our results to the best performing method in the Grand Challenge (Landman and Warfield, 2012) called PICSL-BC. PICSL-BC employs the joint label fusion presented in Wang et al. (2013) and a learning-based wrapper method presented in Wang et al. (2011) where segmentation bias with respect to the gold-standard segmentations is learned. Moreover, PICSL-BC has been evaluated on the same images (including the same split into training and test images) using the same 134 regions. No significant differences (
                              
                                 p
                                 >
                                 0.01
                              
                           ) could be found between our proposed flexible 
                              
                                 
                                    
                                       MALP-EM
                                    
                                    
                                       
                                          
                                             Γ
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                            and PICSL-BC for the averaged similarity indices over all regions. Applying additional segmentation bias correction (Wang et al., 2011) to 
                              
                                 
                                    
                                       MALP-EM
                                    
                                    
                                       
                                          
                                             Γ
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                            significantly (Student’s two-sided paired t-test, 
                              
                                 p
                                 <
                                 
                                    
                                       10
                                    
                                    
                                       -
                                       4
                                    
                                 
                              
                           ) improved segmentation results. Since normal distribution cannot be assumed for similarity indices, we repeated the hypothesis testing using the non-parametric Wilcoxon signed-rank test. All differences shown in Table 4 remained significant at least at 
                              
                                 p
                                 <
                                 
                                    
                                       10
                                    
                                    
                                       -
                                       2
                                    
                                 
                              
                           .

As illustrated in Fig. 5
                           , a weighting factor of 
                              
                                 Γ
                                 =
                                 0.8
                              
                            yields the best segmentation results on the training data set. This result shows that joint fusion yields accurate labels for the majority of voxels. For voxels with a high uncertainty (more than one label has a high non-zero probability) the EM-refined result should be considered as additional weighting. Using the more flexible model with a spatially varying 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                           , we observed comparable overlaps to 
                              
                                 Γ
                                 =
                                 0.8
                              
                           . This is encouraging, because a global and fixed 
                              
                                 Γ
                              
                            leads to a stricter model that is assumed to perform well on healthy, normal data while only a data-driven choice of 
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                            allows the flexibility to cope with highly abnormal images of TBI subjects.

To investigate the consistency of segmentations calculated with the proposed method, we evaluated its test–retest reliability. We quantified this characteristic using the 5 subjects in our set for whom repeat images are available. We used the intraclass correlation coefficient (ICC; two-way random single measures, absolute agreement) following Shrout and Fleiss (1979). Specifically, we calculated the reproducibility of label volumes calculated on images of the same subject at different time points (scan interval less than 90days). The assumption is that brains of healthy subjects do not change substantially within short periods. ICC is widely used to quantify test–retest reliability (Kempton et al., 2011; Nugent et al., 2013).

On the manual segmentations we calculated an average ICC of 
                              
                                 0.80
                                 ±
                                 0.28
                              
                            for non-cortical and 
                              
                                 0.78
                                 ±
                                 0.25
                              
                            for cortical regions. Using the proposed method 
                              
                                 
                                    
                                       MALP-EM
                                    
                                    
                                       
                                          
                                             Γ
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                            we obtained an average ICC of 
                              
                                 0.97
                                 ±
                                 0.04
                              
                            for non-cortical and 
                              
                                 0.94
                                 ±
                                 0.08
                              
                            for cortical regions. These results are slightly better than the average ICC obtained using joint label fusion only (non-cortical: 
                              
                                 0.96
                                 ±
                                 0.06
                              
                           , cortical: 
                              
                                 0.94
                                 ±
                                 0.09
                              
                           ).

We further assessed the relative volume difference (
                              
                                 
                                    
                                       Δ
                                    
                                    
                                       vol
                                    
                                 
                              
                           ) between a structure’s volume at two time points, 
                              
                                 
                                    
                                       V
                                    
                                    
                                       
                                          
                                             t
                                          
                                          
                                             1
                                          
                                       
                                    
                                 
                              
                            and 
                              
                                 
                                    
                                       V
                                    
                                    
                                       
                                          
                                             t
                                          
                                          
                                             2
                                          
                                       
                                    
                                 
                              
                           , which we define as:
                              
                                 (7)
                                 
                                    
                                       
                                          Δ
                                       
                                       
                                          vol
                                       
                                    
                                    =
                                    100
                                    %
                                    
                                       
                                          |
                                          
                                             
                                                V
                                             
                                             
                                                
                                                   
                                                      t
                                                   
                                                   
                                                      1
                                                   
                                                
                                             
                                          
                                          -
                                          
                                             
                                                V
                                             
                                             
                                                
                                                   
                                                      t
                                                   
                                                   
                                                      2
                                                   
                                                
                                             
                                          
                                          |
                                       
                                       
                                          0.5
                                          (
                                          
                                             
                                                V
                                             
                                             
                                                
                                                   
                                                      t
                                                   
                                                   
                                                      1
                                                   
                                                
                                             
                                          
                                          +
                                          
                                             
                                                V
                                             
                                             
                                                
                                                   
                                                      t
                                                   
                                                   
                                                      2
                                                   
                                                
                                             
                                          
                                          )
                                       
                                    
                                 
                              
                           
                        

On the manual segmentations we calculated an average 
                              
                                 
                                    
                                       Δ
                                    
                                    
                                       vol
                                    
                                 
                              
                            of 
                              
                                 8.3
                                 ±
                                 7.5
                                 %
                              
                            for non-cortical and 
                              
                                 12.3
                                 ±
                                 8.4
                                 %
                              
                            for cortical regions. Using the proposed method 
                              
                                 
                                    
                                       MALP-EM
                                    
                                    
                                       
                                          
                                             Γ
                                          
                                          
                                             i
                                          
                                       
                                    
                                 
                              
                            we obtained an average 
                              
                                 
                                    
                                       Δ
                                    
                                    
                                       vol
                                    
                                 
                              
                            of 
                              
                                 2.4
                                 ±
                                 1.4
                                 %
                              
                            for non-cortical and 
                              
                                 4.1
                                 ±
                                 2.3
                                 %
                              
                            for cortical regions. These results are similar to the average 
                              
                                 
                                    
                                       Δ
                                    
                                    
                                       vol
                                    
                                 
                              
                            obtained using joint label fusion only (non-cortical: 
                              
                                 2.7
                                 ±
                                 2.5
                                 %
                              
                           , cortical: 
                              
                                 3.8
                                 ±
                                 2.2
                                 %
                              
                           ).

More extensive quantitative results can be found in Appendix E in Table E.9.

We used 
                           
                              
                                 
                                    MALP-EM
                                 
                                 
                                    
                                       
                                          Γ
                                       
                                       
                                          i
                                       
                                    
                                 
                              
                           
                         (in the following referred to as MALP-EM) to automatically segment 125 MR brain scans of TBI subjects with potential pathology. This database is described in Section 2.1.1. For the segmentation we used all available atlas datasets, except the 5 repeat images, i.e., a total of 30.

All MR images were corrected for intensity inhomogeneities using the N4 algorithm (Tustison et al., 2010). The images were further brain extracted with a fully-automatic in-house brain extraction method called Extended Tissue Classification (ETC). In this method, first, an expectation–maximisation classifier based on Van Leemput et al. (1999) was applied for producing a coarse tissue segmentation, which is used as an initial brain mask. Thereafter, a deformable model-based approach combined with morphological operations was applied to tune the mask.

We devised a scoring protocol to semi-quantitatively assess the quality of automatically generated segmentations of TBI images. We selected four paired regions that frequently show morphological change in patients (hippocampus, thalamus, putamen, and occipital pole). We selected thalamus, putamen and occipital cortices because these structures are frequently implicated in TBI and its sequelae (Warner et al., 2010a; Strangman et al., 2010; Ramlackhansingh et al., 2011). We added the hippocampus because it is a challenging structure to segment (cf. Fig. 1). Consideration of the hippocampus is biologically justified, as it is typically involved in dementia, which in turn is a frequent long-term consequence of severe TBI. The protocol calls for the raters to assign a score on a six point scale (0, worst to 5, best). Three experienced raters (JCL, 1year of clinical service; RAH, 12years of clinical service; AH, 16years of clinical service) developed the protocol by consensus, using 9 images with corresponding segmentations calculated with both MALP-EM and joint label fusion (MALP-JF). All raters had basic (JCL) or advanced (RAH, AH) training in neuroanatomy, neuropathology, radiology, and neuroimaging. The 9 images had been selected from the TBI database using an ad hoc approach that ensured that the sample was broadly representative (MC 2–6; 4 baseline and 5 follow up scans). The detailed protocol is provided as supplementary material to this manuscript.

Based on this protocol the three independent raters assessed 13 images using the tool rview from the Image Registration Toolkit (IRTK, https://github.com/BioMedIA/IRTK, last accessed: 8 December 2014). All raters were blind to the method (MALP-JF or MALP-EM). Results of both methods were presented in a balanced, randomised fashion. The raters viewed both methods’ results of each subject back to back in order to break the tie if the two scores were equal. None were directly involved in the development of MALP-EM. The set of test scans did not intersect with the set of scans used for protocol development. Ten scans were randomly chosen with the constraint that five scans be of subjects with MC
                           
                              
                                 <
                              
                           
                           4 and five with MC
                           
                              
                                 ⩾
                              
                           
                           4. In addition, a non-rater chose three further subjects to ensure scans with severe pathology were represented in the evaluation set.

The findings obtained through this expert validation confirm that MALP-EM is superior to joint label fusion in traumatic brain injury patients with severe pathology. The average expert scores are shown in Table 5
                           . The distribution of the scores for the individual structures is shown in Fig. 6
                           . Further, Fig. 7
                            shows the fraction of test images on which a method performs better than the other.

To further assess inter-rater variance we have calculated the intraclass correlation coefficient (ICC; two-way random single measures, absolute agreement, Shrout and Fleiss (1979)) between the available raters. The calculated ICCs are summarised in Table 5. We observed moderate inter-rater agreement between all three raters for hippocampus, thalamus and putamen. The inter-rater agreement for the occipital pole, which was rated by two raters of rather different experience, is at a lower level. However, both raters agreed that MALP-EM yields significantly better results on this structure.

We considered segmentation quality sufficient if no major parts of the brain were missing due to a overly restrictive brain extraction, and the cortical grey matter/white matter and visually dominant non-cortical boundaries (e.g. ventricles/grey matter) were matched by label boundaries. Inclusion or exclusion of structures that are not present in the atlases (e.g. lesions or contusions) was not regarded as failure. In a small subset (
                              
                                 ≈
                                 5
                                 –
                                 10
                                 %
                              
                           ) of the processed images, we accepted local inaccuracies in the shape of brain extractions in the cortical region, e.g. Fig. 9, if most cortical and especially subcortical structures were segmented successfully.

After visual inspection we identified five segmentations of insufficient quality. One failure originated in misregistration due to significant intensity inhomogeneities that remained after the N4 bias correction. On this single subject we reapplied the bias correction using the generated brain mask to further reduce inhomogeneities. Registration and segmentation were subsequently successful; we therefore retained the image. For another three subjects the generated brain mask was of insufficient quality. One of the corresponding scans was acquired from a subject with a follow up image for which the brain extraction was fine. We thus used the brain mask of the follow up time point to extract the brain at the acute stage. The subsequent segmentation result was satisfactory. The remaining two subjects (cf. Fig. 8
                           ), which were highly abnormal and the scans had very poor quality, could not be processed. A single image was excluded due to consistency problems in the NIfTI format file after image conversion. We conclude that none of these failures were directly related to MALP-EM. Overall we were able to process 122 out of 125 available scans successfully.

On visual inspection, all segmentations of these 122 images were considered reasonable, allowing for pathology. Visual examples of calculated segmentation results are shown in Fig. 9
                           . The image pair illustrates the advantages of MALP-EM over sole label fusion in images with substantial pathology. Fig. 9 also clearly reveals improved segmentation results obtained with MALP-EM at boundaries of anatomical regions with large intensity contrast. Improvements in both the hippocampal region and at the cortical grey matter/cerebrospinal fluid boundary are particularly striking.

Labels obtained with MALP-EM on images with little pathology (Fig. 10
                           ) are visually convincing for both non-cortical and cortical structures in most instances. When substantial pathology is present (Fig. 9), we observed some inaccuracies. A frequent problem is unlabelled cortical grey matter due to imperfections of the brain mask. Voxels excluded during brain extraction are not reconsidered during the segmentation process. A subject for which this problem is most striking is illustrated in Fig. 9. However, we still kept this subject for our analysis since even in subjects with significant pathology only a few cortical and no subcortical structures are affected by this problem. In regions showing severe deformations or atrophy, such as the hippocampal region in the subject shown in Fig. 9, the nonrigid atlas alignment may consistently fail. Due to the proposed prior relaxation step and spatially varying label combination we were able to relax this problem and improve upon non-intensity based approaches. We conclude from visual comparison that MALP-EM is superior to standard label fusion.

To assess the clinical usefulness of our method, we attempted a clinical classification of the available TBI subjects based on morphometric results. We used a classification of the brain images performed by an experienced clinician as a gold-standard reference. We assessed correlations with a widely used clinical scheme primarily devised for categorising admission X-ray CT images, applied to acute-phase MR images (MC) and one of the most common clinical outcome scores used in TBI (GOS). We focused on the particularly relevant differentiation between patients who would not be able to live an independent life (GOS
                           
                              
                                 <
                              
                           
                           4) and those with a more favourable outcome. The comparison with the GOS provided a means of estimating the prognostic value of automatically segmented acute-phase MR images. For the MC, we additionally dichotomised images into those without (MC
                           
                              
                                 <
                              
                           
                           4 
                              
                                 ≙
                              
                            DI I, DI II and DI III) or with (MC
                           
                              
                                 ⩾
                              
                           
                           4
                           
                              
                                 ≙
                              
                           
                           DI IV, EML, NEML) significant mass effect and midline shift. We employed MALP-EM for individual and independent cross-sectional experiments at the acute stage (60 subjects) and follow-up stage (62 subjects).

As classifier we used a linear discriminant analysis (LDA) implemented through the MATLAB function classify. For validation, we performed 1000 repetitions of a 10-fold cross validation. As feature we quantified structural asymmetry of the paired 63 structures (cf. Sections 2.1.2 and A). We employed an absolute asymmetry index (AAI) (Galaburda et al., 1987; Bonilha et al., 2014) based on a structure’s volume (V) in the left and right hemisphere, defined as:
                              
                                 (8)
                                 
                                    AAI
                                    =
                                    100
                                    %
                                    
                                       
                                          |
                                          
                                             
                                                V
                                             
                                             
                                                left
                                             
                                          
                                          -
                                          
                                             
                                                V
                                             
                                             
                                                right
                                             
                                          
                                          |
                                       
                                       
                                          0.5
                                          (
                                          
                                             
                                                V
                                             
                                             
                                                left
                                             
                                          
                                          +
                                          
                                             
                                                V
                                             
                                             
                                                right
                                             
                                          
                                          )
                                       
                                    
                                 
                              
                           Specifically, we used the sum of the absolute asymmetry indices of either all 14 non-cortical structures, all 49 cortical structures or all 63 structures.

The results for distinguishing two MC (MC
                           
                              
                                 <
                              
                           
                           4, MC
                           
                              
                                 ⩾
                              
                           
                           4) and GOS (GOS
                           
                              
                                 <
                              
                           
                           4, GOS
                           
                              
                                 ⩾
                              
                           
                           4) groups respectively, using either acute-phase or follow-up images, are summarised in Table 6
                           . Since the clinical variables MC and GOS were missing for 3 (MC), respectively 5 (GOS) subjects, we reduced the number of subjects in each classification experiment accordingly. As groups were unbalanced we employed the balanced accuracy measure (Brodersen et al., 2010), the average of sensitivity and specificity, to report classification accuracy. Table 6 shows that our method yields 76.0% accuracy in distinguishing groups in the Marshall Classification system based on acute-phase images. The Marshall Classification system is not a linear scale as it takes both midline shift and the size of lesions into account (compare Appendix B). However, in the classification experiment we were able to discriminate between classes without (MC
                           
                              
                                 <
                              
                           
                           4) and with (MC
                           
                              
                                 ⩾
                              
                           
                           4) significant midline shift or mass effect.

Furthermore, we were able to estimate from a single acute-phase MRI whether a TBI patient will be able to live an independent life (GOS
                           
                              
                                 ⩾
                              
                           
                           4) or not with 64.7% accuracy. In comparison, when predicting outcome based on the MC score at baseline we calculated 59.3% accuracy. Based on the segmentations of non-cortical structures in the follow-up images, we achieved 66.8% accuracy in GOS classification. The classification results are summarised in Table 6. The high specificity for MC classification shows that the presented method does very well in detecting normal appearing brains at the acute stage. The high specificity for GOS classification confirms that the presented approach is able to predict a favourable outcome of a TBI. These findings suggest that structural brain asymmetry could be a sufficient criterion to indicate an unfavourable disease outcome. On the other hand, symmetry seems to be a necessary criterion for favourable disease outcome. It is not, however, a sufficient criterion to rule out an unfavourable outcome. Receiver operating characteristic (ROC) curves for these classification experiments are shown in Fig. 11
                           .

A detailed summary of results for individual non-cortical structures for both MC and GOS classification is provided in Appendix F, including p-values for group separation. These results suggest structural asymmetry of non-cortical brain structures does not correlate well with MC.

We calculated p-values for group separation using MALP-JF without the proposed processing. Unlike MALP-EM, this setup did not reveal any significant symmetry differences between GOS groups for the thalamus (at the acute time point) or for the caudate, hippocampus and inferior lateral ventricle (at the follow up time point). All the structures that show significant symmetry differences between groups of clinical variables in the MALP-JF setup are also found in the MALP-EM setup.

In an additional set of 1000 rounds of the 10-fold cross-validation, we determined in each run the p-value for the group separation on the training set using an unpaired two-sided Student’s t-test for each of the 63 symmetry features (AAI). We calculated a histogram of the 10 most significant structures in each run. Fig. 12
                            shows the histogram for the GOS separation and thus the regions that are particularly correlated with the disease outcome. The plots show the 10 consistently most relevant structures for GOS group separation using acute-phase (left) or follow-up (right) MR images. This experiment reveals that asymmetry in subcortical structures is particularly correlated with poor patient recovery. Notably, asymmetry in the thalamus, pallidum, hippocampus, putamen and occipital pole was found to discriminate TBI patients with favourable from non-favourable outcome. Both thalamus and hippocampus are known to be involved in TBI disease progression (Bigler, 2001) and were found to have predictive value in previous studies based on MR imaging (Strangman et al., 2010; Warner et al., 2010b; Warner et al., 2010a; Irimia et al., 2012). Our results also confirm the findings of Ramlackhansingh et al. (2011), where inflammation markers following a head trauma were significantly raised in the thalamus, putamen and occipital cortices.

In this work we introduced a framework called “Multi-Atlas Label Propagation with Expectation–Maximisation based refinement” (MALP-EM) for robust MR brain image segmentation. Building on state-of-the-art registration and label fusion techniques, we proposed to relax spatial priors obtained through multi-atlas label propagation and to combine segmentation results obtained with registration- and intensity-based approaches to exploit individual benefits. For prior relaxation we detect incorrect label priors at low intensity voxels or cisterns and redistribute corresponding probabilities to the most probable CSF-like structure. Here we assumed that low intensity voxels belong to cisterns that are filled with CSF. Potentially these low intensity voxels could also, especially in TBI patients, result from edema, hemorrhage, or direct injury. The employed atlas is built from healthy patients and our model does not allow for the detection of outliers or the classification of lesions, which is very challenging (Rao et al., 2014). Dependent on the disease, segmentation failures due to pathologies, such as contusions in TBI, could be addressed by an explicit lesion segmentation (Rao et al., 2014) or an outlier detection approach (Asman et al., 2013). This is, however, left for future work. In general, imaging features derived from automatic segmentations, such as structural volumes, need to be interpreted carefully, when pathologies are present.

We showed that MALP-EM significantly improves segmentation quality compared to non-intensity refined label fusion. Specifically, we observed significant improvements by combining results from joint label fusion and EM-refined fusion using a locally varying weighting factor 
                        
                           Γ
                        
                     . This approach is similar to the weighting of different energy terms in the formulation presented by van der Lijn et al. (2008). Our formulation allows any combination of segmentation results calculated with independent models or unrelated labelling techniques. In the future it will be interesting to investigate how more sophisticated combination strategies and intensity models can further improve this approach.

Previously, the objective evaluation procedure of the “MICCAI Multi-Atlas-Segmentation Challenge 2012” (Landman and Warfield, 2012) has shown MALP-EM to be among the leading segmentation methods. While the implementation used in the challenge was preliminary and highly tuned, the implementation used for the present work is more generic and less dependent on parameter settings. Thanks to an improved registration and more sophisticated and general fusion strategy, we achieved significantly higher overlaps for both MAPER (overall SI: 74.9% vs. 74.1%) and MALP-EM (overall SI: 76.4% vs. 75.8%) than in the Grand Challenge. Additional application of a learning-based segmentation bias correction method (Wang et al., 2011) further improves our segmentation results (overall SI: 77.2%), yielding small but significant improvements over the best method (PICSL-BC; overall SI: 76.5%) in the Grand Challenge. We acknowledge that in the development of MALP-EM we benefitted from the experience of participating in the Grand Challenge, where the timeframe for algorithm development and tuning was tight. However, we did not use the testing set from the Grand Challenge to tune MALP-EM.

While the segmentation bias correction significantly improves label overlaps on the MICCAI Segmentation Challenge dataset, we did not employ this post processing technique to segment the TBI subjects. We reason that it is difficult to justify the application of a correction classifier that was trained exclusively on a homogeneous cohort of healthy subjects to a heterogeneous cohort of brain scans with severe pathology.

To evaluate MALP-EM on a TBI database, we specifically developed a protocol for the expert assessment of segmentation quality of the hippocampus, thalamus, putamen and occipital pole. The protocol is publicly available as supplementary material to this work. Using the protocol-based ratings of three independent experts, we showed on 13 subjects of the TBI cohort that the proposed modifications based on image intensities improve on pure label fusion.

The proposed method is shown to be robust: 120 out of 125 TBI images were segmented successfully into 134 regions. After manual intervention on the preprocessing step, the successful record increased to 122/125. This is a solid basis for future research into image-based quantification of brain abnormality. Derived morphometric biomarkers, such as a structural asymmetry index, can serve as features for automatic classifiers, predicting how the image will be rated by an expert (MC) and prognosticating clinical outcome (GOS). Given that MC is assessed at the acute stage quantifying brain pathology (cf. Appendix B) it seems reasonable that structural asymmetry in acute MRIs correlates well with this score. In contrast to this, GOS is an outcome score assessed several months after the injury. It was expected that MRI features derived from follow up scans are more consistent with the outcome measure than features available at the acute stage. The segmentation setup for the TBI subjects inherently differs from the intra-atlas experiments (15 training, 20 test images) in that we used more atlases for the segmentation of the TBI subjects, the image source (scanner) differs from the atlas database, and, most importantly, we are segmenting subjects with potentially substantial pathology. Visual inspection confirmed the robustness and advantages of the proposed method under these new challenges (cf. Fig. 9). The generated segmentations of the TBI data set are a valuable resource for investigating further potential biomarkers for TBI disease progress.

This work also motivates further research and discussion about how meaningful or generalisable high Dice overlaps on a homogeneous cohort of healthy patients are. More informative similarity measures are desirable (Ledig et al., 2014). In many studies, e.g. Alzheimer’s disease or TBI, the subjects of interest show high variability in both brain appearance and disease burden. More restrictive models might lead to a high labelling accuracy on subjects that are very similar to the atlas cohort. However, they are potentially too rigid to cope with images of subjects with significant pathology. Here more flexible formulations might be desirable, even if they are slightly less performant in intra-atlas cohort validations.

We conclude from our experiments that 
                        
                           
                              
                                 MALP-EM
                              
                              
                                 
                                    
                                       Γ
                                    
                                    
                                       i
                                    
                                 
                              
                           
                        
                      yields a segmentation accuracy that is on healthy subjects comparable to other state-of-the-art methods while offering sufficient flexibility to cope with gross pathology. Most inaccuracies, as visually confirmed in the segmented TBI datasets, were due to minor problems in the brain extraction. This highlights the necessity of further improvement of fully automatic brain extraction tools, which is a very challenging task for brains in the presence of pathology.

@&#CONCLUSIONS@&#

We presented a fully automatic, highly robust and accurate segmentation framework called MALP-EM. This includes a new paradigm: We suggest the spatially weighted combination of probabilistic segmentation results obtained through different techniques into a common segmentation exploiting individual benefits. Extensive quantitative evaluation on a manually annotated atlas cohort of healthy subjects confirmed that MALP-EM significantly improves on existing label fusion techniques. Based on the ratings of three independent experts, MALP-EM is superior to joint label fusion for hippocampus, thalamus, putamen and occipital pole segmentation on TBI brain scans. We have demonstrated the benefits regarding robustness through intensity based refinement on 125 MR brain images of TBI subjects. Using MALP-EM we were able to segment 122 out of 125 available TBI brain images into 134 different anatomical regions. We observed correlations between asymmetry indices of paired structures and clinical variables, using acute-phase or follow-up MR images. We also observed and confirmed evidence that subcortical brain structures such as the thalamus, putamen and hippocampus have strong potential to predict the clinical outcome of individual TBI patients.

@&#ACKNOWLEDGEMENTS@&#

This work was partially funded under the 7th Framework Programme by the European Commission (http://cordis.europa.eu/ist/, TBIcare: http://www.tbicare.eu/, last accessed: 8 December 2014). The research was further supported by the National Institute for Health Research (NIHR) Biomedical Research Centre (BRC) based at Imperial College Healthcare NHS Trust and Imperial College London. AH is supported by the Department of Health via the NIHR comprehensive BRC award to Guy’s & St Thomas’ NHS Foundation Trust in partnership with King’s College London and Kings College Hospital NHS Foundation Trust. This work was further supported by a Medical Research Council (UK) Program Grant (Acute brain injury: heterogeneity of mechanisms, therapeutic targets and outcome effects [G9439390 ID 65883]), the UK National Institute of Health Research Biomedical Research Centre at Cambridge, the Technology Platform funding provided by the UK Department of Health and an EPSRC Pathways to Impact award. VFJN is supported by a Health Foundation/Academy of Medical Sciences Clinician Scientist Fellowship. DKM is supported by an NIHR Senior Investigator Award. The views expressed are those of the authors and not necessarily those of the NHS, the NIHR or the Department of Health. The funders had no role in study design, data collection and analyses, decision to publish, or preparation of the manuscript.

1: accumbens area, 2: amygdala, 3: caudate, 4: cerebellum exterior, 5: cerebellum white matter, 6: cerebral white matter, 7: hippocampus, 8: inf lat ventricle, 9: lateral ventricle, 10: pallidum, 11: putamen, 12: thalamus, 13: ventral DC, 14: forebrain, 15: ACgG anterior cingulate gyrus, 16: AIns anterior insula, 17: AOrG anterior orbital gyrus, 18: AnG angular gyrus, 19: Calc calcarine cortex, 20: CO central operculum, 21: Cun cuneus, 22: Ent entorhinal area, 23: FO frontal operculum, 24: FRP frontal pole, 25: FuG fusiform gyrus, 26: GRe gyrus rectus, 27: IOG inferior occipital gyrus, 28: ITG inferior temporal gyrus, 29: LiG lingual gyrus, 30: LOrG lateral orbital gyrus, 31: MCgG middle cingulate gyrus, 32: MFC medial frontal cortex, 33: MFG middle frontal gyrus, 34: MOG middle occipital gyrus, 35: MOrG medial orbital gyrus, 36: MPoG postcentral gyrus medial segment, 37: MPrG precentral gyrus medial segment, 38: MSFG superior frontal gyrus medial segment, 39: MTG middle temporal gyrus, 40: OCP occipital pole, 41: OFuG occipital fusiform gyrus, 42: OpIFG opercular part of the inferior frontal gyrus, 43: OrIFG orbital part of the inferior frontal gyrus, 44: PCgG posterior cingulate gyrus, 45: PCu precuneus, 46: PHG parahippocampal gyrus, 47: PIns posterior insula, 48: PO parietal operculum, 49: PoG postcentral gyrus, 50: POrG posterior orbital gyrus, 51: PP planum polare, 52: PrG precentral gyrus, 53: PT planum temporale, 54: SCA subcallosal area, 55: SFG superior frontal gyrus, 56: SMC supplementary motor cortex, 57: SMG supramarginal gyrus, 58: SOG superior occipital gyrus, 59: SPL superior parietal lobule, 60: STG superior temporal gyrus, 61: TMP temporal pole, 62: TrIFG triangular part of the inferior frontal gyrus, 63: TTG transverse temporal gyrus.


                     Table B.7
                     .


                     Table C.8
                     .

For the sake of readability and consistency with existing literature we have followed the notation used in Van Leemput et al. (1999), Cardoso et al. (2011), Ledig et al. (2012). Our implementation builds on the framework described in Ledig et al. (2012).

Given the parameters 
                        
                           Φ
                           =
                           {
                           (
                           
                              
                                 μ
                              
                              
                                 1
                              
                           
                           ,
                           
                              
                                 σ
                              
                              
                                 1
                              
                           
                           )
                           ,
                           (
                           
                              
                                 μ
                              
                              
                                 2
                              
                           
                           ,
                           
                              
                                 σ
                              
                              
                                 2
                              
                           
                           )
                           ,
                           …
                           ,
                           (
                           
                              
                                 μ
                              
                              
                                 K
                              
                           
                           ,
                           
                              
                                 σ
                              
                              
                                 K
                              
                           
                           )
                           }
                        
                      of K structural classes the likelihood of observing, the log-transformed, intensity 
                        
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                        
                      at voxel i is given as:
                        
                           (D.1)
                           
                              f
                              (
                              
                                 
                                    y
                                 
                                 
                                    i
                                 
                              
                              |
                              Φ
                              )
                              =
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       k
                                    
                                 
                              
                              f
                              (
                              
                                 
                                    y
                                 
                                 
                                    i
                                 
                              
                              |
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    e
                                 
                                 
                                    k
                                 
                              
                              ,
                              Φ
                              )
                              f
                              (
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    e
                                 
                                 
                                    k
                                 
                              
                              )
                           
                        
                     
                  

It is commonly assumed that the probability, 
                        
                           f
                           (
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 e
                              
                              
                                 k
                              
                           
                           ,
                           Φ
                           )
                        
                     , of a voxel i to have intensity 
                        
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                        
                     , given that it belongs to class 
                        
                           k
                           ,
                           (
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 e
                              
                              
                                 k
                              
                           
                           )
                        
                     , is described by a normal distribution (Wells et al., 1996; Van Leemput et al., 1999; Zhang et al., 2001; Cardoso et al., 2011). We thus model 
                        
                           f
                           (
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                           |
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 e
                              
                              
                                 k
                              
                           
                           ,
                           Φ
                           )
                           =
                           
                              
                                 N
                              
                              
                                 k
                              
                           
                           (
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                           )
                        
                      where 
                        
                           
                              
                                 N
                              
                              
                                 k
                              
                           
                        
                      denotes the Gaussian distribution with corresponding parameters 
                        
                           (
                           
                              
                                 μ
                              
                              
                                 k
                              
                           
                           ,
                           
                              
                                 σ
                              
                              
                                 k
                              
                           
                           )
                        
                     . The prior probability 
                        
                           f
                           (
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 e
                              
                              
                                 k
                              
                           
                           )
                        
                      that a voxel i belongs to structure k is given by the relaxed version, 
                        
                           
                              
                                 Π
                              
                              
                                 R
                              
                           
                        
                      (cf. Section 2.2.3), of the probabilistic label estimates after multi-atlas label propagation.

Next to the spatial information provided by the prior estimates, 
                        
                           
                              
                                 Π
                              
                              
                                 R
                              
                           
                        
                     , we further account for topological knowledge by incorporating a Markov Random Field (MRF). We thus expand 
                        
                           f
                           (
                           
                              
                                 z
                              
                              
                                 i
                              
                           
                           =
                           
                              
                                 e
                              
                              
                                 k
                              
                           
                           )
                           =
                           
                              
                                 Π
                              
                              
                                 ik
                              
                              
                                 R
                              
                           
                        
                      to
                        
                           (D.2)
                           
                              f
                              (
                              
                                 
                                    z
                                 
                                 
                                    i
                                 
                              
                              =
                              
                                 
                                    e
                                 
                                 
                                    k
                                 
                              
                              |
                              
                                 
                                    p
                                 
                                 
                                    
                                       
                                          S
                                       
                                       
                                          i
                                       
                                    
                                 
                                 
                                    (
                                    m
                                    )
                                 
                              
                              ,
                              G
                              )
                              =
                              
                                 
                                    
                                       
                                          π
                                       
                                       
                                          ik
                                       
                                       
                                          R
                                       
                                    
                                    
                                       
                                          e
                                       
                                       
                                          -
                                          
                                             
                                                U
                                             
                                             
                                                MRF
                                             
                                          
                                          (
                                          
                                             
                                                e
                                             
                                             
                                                k
                                             
                                          
                                          |
                                          
                                             
                                                p
                                             
                                             
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                             
                                                (
                                                m
                                                )
                                             
                                          
                                          ,
                                          G
                                          )
                                       
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          j
                                          =
                                          1
                                       
                                       
                                          K
                                       
                                    
                                    
                                       
                                          π
                                       
                                       
                                          ij
                                       
                                       
                                          R
                                       
                                    
                                    
                                       
                                          e
                                       
                                       
                                          -
                                          
                                             
                                                U
                                             
                                             
                                                MRF
                                             
                                          
                                          (
                                          
                                             
                                                e
                                             
                                             
                                                j
                                             
                                          
                                          |
                                          
                                             
                                                p
                                             
                                             
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      i
                                                   
                                                
                                             
                                             
                                                (
                                                m
                                                )
                                             
                                          
                                          ,
                                          G
                                          )
                                       
                                    
                                 
                              
                           
                        
                     
                  

We calculate the MRF energy function 
                        
                           
                              
                                 U
                              
                              
                                 MRF
                              
                           
                        
                      based on the probabilistic label estimates in iteration 
                        
                           m
                           ,
                           
                              
                                 p
                              
                              
                                 ik
                              
                              
                                 m
                              
                           
                        
                     , in the first-order neighbourhood of voxel 
                        
                           i
                           ,
                           
                              
                                 S
                              
                              
                                 i
                              
                           
                        
                     , as:
                        
                           (D.3)
                           
                              
                                 
                                    U
                                 
                                 
                                    MRF
                                 
                              
                              (
                              
                                 
                                    e
                                 
                                 
                                    k
                                 
                              
                              |
                              
                                 
                                    p
                                 
                                 
                                    
                                       
                                          S
                                       
                                       
                                          i
                                       
                                    
                                 
                                 
                                    (
                                    m
                                    )
                                 
                              
                              ,
                              G
                              )
                              =
                           
                        
                     
                     
                        
                           (D.4)
                           
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       j
                                       =
                                       1
                                    
                                    
                                       K
                                    
                                 
                              
                              
                                 
                                    G
                                 
                                 
                                    kj
                                 
                              
                              
                                 
                                    
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                l
                                                ∈
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      i
                                                   
                                                   
                                                      x
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             s
                                          
                                          
                                             x
                                          
                                       
                                       
                                          
                                             p
                                          
                                          
                                             lj
                                          
                                          
                                             (
                                             m
                                             )
                                          
                                       
                                       +
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                l
                                                ∈
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      i
                                                   
                                                   
                                                      y
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             s
                                          
                                          
                                             y
                                          
                                       
                                       
                                          
                                             p
                                          
                                          
                                             lj
                                          
                                          
                                             (
                                             m
                                             )
                                          
                                       
                                       +
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                l
                                                ∈
                                                
                                                   
                                                      S
                                                   
                                                   
                                                      i
                                                   
                                                   
                                                      z
                                                   
                                                
                                             
                                          
                                       
                                       
                                          
                                             s
                                          
                                          
                                             z
                                          
                                       
                                       
                                          
                                             p
                                          
                                          
                                             lj
                                          
                                          
                                             (
                                             m
                                             )
                                          
                                       
                                    
                                 
                              
                           
                        
                     Here, G denotes a 
                        
                           K
                           ×
                           K
                        
                      matrix defining the connectivity between class k and j and 
                        
                           s
                           =
                           {
                           
                              
                                 1
                              
                              
                                 
                                    
                                       d
                                    
                                    
                                       x
                                    
                                 
                              
                           
                           ,
                           
                              
                                 1
                              
                              
                                 
                                    
                                       d
                                    
                                    
                                       y
                                    
                                 
                              
                           
                           ,
                           
                              
                                 1
                              
                              
                                 
                                    
                                       d
                                    
                                    
                                       z
                                    
                                 
                              
                           
                           }
                        
                      accounts for the anisotropic voxel spacing in world coordinates. We have defined G as:
                        
                           (D.5)
                           
                              G
                              (
                              k
                              ,
                              j
                              )
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                0
                                                ,
                                             
                                             
                                                if
                                                
                                                k
                                                =
                                                j
                                             
                                          
                                          
                                             
                                                β
                                                ,
                                             
                                             
                                                if
                                                
                                                structures
                                                
                                                k
                                                
                                                and
                                                
                                                j
                                                
                                                share
                                                
                                                a
                                                
                                                boundary
                                             
                                          
                                          
                                             
                                                γ
                                                ,
                                             
                                             
                                                if
                                                
                                                structures
                                                
                                                k
                                                
                                                and
                                                
                                                j
                                                
                                                are
                                                
                                                distant
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     Here 
                        
                           β
                        
                      and 
                        
                           γ
                        
                     , with 
                        
                           0
                           ⩽
                           β
                           ⩽
                           γ
                        
                     , are parameters describing the penalty for certain neighbourhood configurations. By assuming that voxels are statistically independent, the probability of observing an image 
                        
                           
                              
                                 I
                              
                              
                                 u
                              
                           
                        
                     , given that the parameters 
                        
                           Φ
                        
                      are known, is given by 
                        
                           f
                           (
                           
                              
                                 I
                              
                              
                                 u
                              
                           
                           |
                           Φ
                           )
                           =
                           
                              
                                 ∏
                              
                              
                                 i
                              
                           
                           f
                           (
                           
                              
                                 y
                              
                              
                                 i
                              
                           
                           |
                           Φ
                           )
                        
                     . We can now solve this model by interleaving the expectation of the class probabilities 
                        
                           
                              
                                 p
                              
                              
                                 ik
                              
                              
                                 (
                                 m
                                 )
                              
                           
                        
                      and the maximisation of the model by updating the model parameters 
                        
                           
                              
                                 Φ
                              
                              
                                 (
                                 m
                                 )
                              
                           
                        
                     . We then assume that the label probabilities, 
                        
                           
                              
                                 p
                              
                              
                                 ik
                              
                              
                                 (
                                 m
                                 +
                                 1
                                 )
                              
                           
                        
                     , are known in iteration 
                        
                           (
                           m
                           +
                           1
                           )
                        
                      and update the model parameters as:
                        
                           (D.6)
                           
                              
                                 
                                    μ
                                 
                                 
                                    k
                                 
                                 
                                    (
                                    m
                                    +
                                    1
                                    )
                                 
                              
                              =
                              
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                       
                                    
                                    
                                       
                                          p
                                       
                                       
                                          ik
                                       
                                       
                                          (
                                          m
                                          +
                                          1
                                          )
                                       
                                    
                                    
                                       
                                          y
                                       
                                       
                                          i
                                       
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                       
                                    
                                    
                                       
                                          p
                                       
                                       
                                          ik
                                       
                                       
                                          (
                                          m
                                          +
                                          1
                                          )
                                       
                                    
                                 
                              
                              ,
                              
                              
                              
                              
                                 
                                    σ
                                 
                                 
                                    k
                                 
                                 
                                    (
                                    m
                                    +
                                    1
                                    )
                                 
                              
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                             
                                          
                                          
                                             
                                                p
                                             
                                             
                                                ik
                                             
                                             
                                                (
                                                m
                                                +
                                                1
                                                )
                                             
                                          
                                          
                                             
                                                (
                                                
                                                   
                                                      y
                                                   
                                                   
                                                      i
                                                   
                                                
                                                -
                                                
                                                   
                                                      μ
                                                   
                                                   
                                                      k
                                                   
                                                   
                                                      (
                                                      m
                                                      +
                                                      1
                                                      )
                                                   
                                                
                                                )
                                             
                                             
                                                2
                                             
                                          
                                       
                                       
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                             
                                          
                                          
                                             
                                                p
                                             
                                             
                                                ik
                                             
                                             
                                                (
                                                m
                                                +
                                                1
                                                )
                                             
                                          
                                       
                                    
                                 
                              
                           
                        
                     
                  

Given the updated model parameters 
                        
                           Φ
                        
                      we can then estimate the class probabilities in the next iteration as:
                        
                           (D.7)
                           
                              
                                 
                                    p
                                 
                                 
                                    ik
                                 
                                 
                                    (
                                    m
                                    +
                                    1
                                    )
                                 
                              
                              =
                              
                                 
                                    f
                                    (
                                    
                                       
                                          y
                                       
                                       
                                          i
                                       
                                    
                                    |
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    =
                                    
                                       
                                          e
                                       
                                       
                                          k
                                       
                                    
                                    ,
                                    
                                       
                                          Φ
                                       
                                       
                                          (
                                          m
                                          )
                                       
                                    
                                    )
                                    f
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    =
                                    
                                       
                                          e
                                       
                                       
                                          k
                                       
                                    
                                    |
                                    
                                       
                                          p
                                       
                                       
                                          
                                             
                                                S
                                             
                                             
                                                i
                                             
                                          
                                       
                                       
                                          (
                                          m
                                          )
                                       
                                    
                                    ,
                                    G
                                    )
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          j
                                          =
                                          1
                                       
                                       
                                          K
                                       
                                    
                                    f
                                    (
                                    
                                       
                                          y
                                       
                                       
                                          i
                                       
                                    
                                    |
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    =
                                    
                                       
                                          e
                                       
                                       
                                          j
                                       
                                    
                                    ,
                                    
                                       
                                          Φ
                                       
                                       
                                          (
                                          m
                                          )
                                       
                                    
                                    )
                                    f
                                    (
                                    
                                       
                                          z
                                       
                                       
                                          i
                                       
                                    
                                    =
                                    
                                       
                                          e
                                       
                                       
                                          j
                                       
                                    
                                    |
                                    
                                       
                                          p
                                       
                                       
                                          
                                             
                                                S
                                             
                                             
                                                i
                                             
                                          
                                       
                                       
                                          (
                                          m
                                          )
                                       
                                    
                                    ,
                                    G
                                    )
                                 
                              
                           
                        
                     
                  

Usually the model converges after a few iterations. In our experiments, we have performed ten iterations to better control the runtime of the algorithm. The parameters for describing the MRF were set to 
                        
                           β
                           =
                           1.0
                        
                      and 
                        
                           γ
                           =
                           1.5
                        
                     . The background was modelled with an explicit class.


                     Table E.9
                     .


                     Tables F.10, F.11, F.12
                     
                     
                     .

Supplementary data associated with this article can be found, in the online version, at http://dx.doi.org/10.1016/j.media.2014.12.003.


                     
                        
                           
                        
                     
                  

@&#REFERENCES@&#

