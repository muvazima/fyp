@&#MAIN-TITLE@&#Probabilistic model for 3D interactive segmentation

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           Interactive 3D medical image segmentation based on a Bayesian inference is suggested.


                        
                        
                           
                           User-machine “dialogue” is allowed by a few mouse clicks in regions of disagreement.


                        
                        
                           
                           User input is formulated as a probabilistic spatial term in a level-set functional.


                        
                        
                           
                           A generic method which accommodates different modalities, e.g. CT and multimodal MRI.


                        
                        
                           
                           GUI for clinical uses allows real-time, high performance with minimal user feedback.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Image segmentation

User interaction

Probabilistic model

MR 

&

 CT Brain imaging

Modality fusion

@&#ABSTRACT@&#


               
               
                  Fully-automated segmentation algorithms offer fast, objective, and reproducible results for large data collections. However, these techniques cannot handle tasks that require contextual knowledge not readily available in the images alone. Thus, the supervision of an expert is necessary.
                  We present a generative model for image segmentation, based on a Bayesian inference. Not only does our approach support an intuitive and convenient user interaction subject to the bottom-up constraints introduced by the image intensities, it also circumvents the main limitations of a human observer—3D visualization and modality fusion. The user “dialogue” with the segmentation algorithm via several mouse clicks in regions of disagreement, is formulated as a continuous probability map, that represents the user’s certainty to whether the current segmentation should be modified. Considering this probability map as the voxel-vise Bernoulli priors on the image labels allows spatial encoding of the user-provided input. The method is exemplified for the segmentation of cerebral hemorrhages (CH) in human brain CT scans; ventricles in degenerative mice brain MRIs, and tumors in multi-modal human brain MRIs and is shown to outperform three interactive, state-of-the-art segmentation methods in terms of accuracy, efficiency and user-workload.
               
            

@&#INTRODUCTION@&#

Being fundamental to medical imaging analysis, image segmentation is actively studied, and numerous approaches exist. Recent trends focus on fully automatic segmentation frameworks, which is much faster than manual annotation, less biased, and repeatable. Usually, the required workload for processing and analyzing large datasets is far behind the ability of a human rater. Moreover, the computational advancements of the machine in cases that require modality fusion or 3D visualization cannot be achieved even by an expert. Nevertheless, as the outcome of the image analysis process might have critical implications on patient recuperation prospects, the expertise of a clinician must be considered.

Interactive segmentation (IS) approaches can be classified based on the form and the type of input provided by the user as well as the underlying segmentation framework (see He et al. (2013) and Zhao and Xie (2013) and references therein). The pioneering IS work, which led to the development of the live wire technique or intelligent scissors, independently suggested by  Falcao et. al. (1998) and Mortensen and Barrett (1998), is based on the image edge map. The shortest paths between the user’s mouse clicks calculated by the Dijkstra algorithm form the contour of the region of interest (ROI). Here, as well as in the united snakes framework (Liang et al., 2006), which relies on a classical active contour framework known as snakes (Kass et al., 1988), the user ‘plants’ anchors or seed points along the desired boundary, providing guidance for the segmentation.

Mouse scribbles seem to be the most common form of user interaction. The marked regions provide information about the ROI and the background intensity distributions. A well known IS approach is the GrabCut technique (Rother et al., 2004), which is based on the graph-cut method (Boykov et al., 2001). Representing the image pixels by nodes in a graph, the graph-cut addresses a foreground-background image segmentation by solving a min-cut, max-flow problem. The user’s annotated regions are assigned to either the source or the sink of the graph. In a recent paper by Nieuwenhuis and Cremers (2013), marked regions via mouse scribbles were used for gathering spatially varying color statistics for multi-label segmentation.

While the techniques above are very effective when prior information on the image to segment is not available, they do not handle local ambiguities resulting from overlaps between the ROI and the background intensity distributions. Moreover, often, in medical image analysis problems the ROI is well specified and image statistics can be estimated based on similar examples. The user input is required only for resolving local discrepancies based on contextual information.

In Ben-Zadok et al. (2009) and Cremers et al. (2007a) the level-set framework of Chan and Vese (2001), which implicitly models the foreground and the background intensities by two distinct normal distributions, was extended to include a spatial term provided via user interaction. This additional spatial information is provided in regions that (according to the user) are not compatible with the assumed intensity distribution model. A random walk algorithm is the foundation of the IS framework proposed in Yang et al. (2010). The method combines soft and hard input constraints to spatially guide the segmentation as well as foreground and background user strokes to learn the image statistics. Split and merge interactive operations were suggested in Paulhac et al. (2011) via region adjacency graph representation. More recently, Gao et al. proposed to use local robust statistics to describe the object features, which are learned adaptively from the strokes drawn by the user (Gao et al., 2012). Their framework allows the partition of the image into multiple regions via the simultaneous evolution of two active contours and using the ‘action–reaction’ principle to avoid overlaps. The idea of a concurrent evolution of a pair of level-set functions has been used in another interesting approach, based on concepts from control theory (Karasev et al., 2013). In that framework, the user’s accumulated input guides the evolution of one of the contours while the evolution of the other contour is based on image intensities and smoothness term, as in Chan and Vese (2001). The two level-set functions interact with each other, leading to a closed loop behavior.

In this paper, we present a novel generative approach for interactive 3D segmentation of medical images. The proposed framework is also extended to address the extraction of a common ROI in a multi-modal image set. The key contribution is the probabilistic formulation of the user interaction. Specifically, the discrete set of 3D coordinates provided by mouse clicks in regions of disagreement is converted into a continuous probability map, that represents the user’s certainty to whether the current segmentation should be modified. This continuous representation defines the voxel-vise Bernoulli priors on the image labels. The maximum a posteriori (MAP) estimate of the segmentation is therefore based on a user-provided spatial information in addition to the conventional image likelihood term and a regularization term.

The MAP problem is solved via calculus of variation, using level-set formulation, in the spirit of Riklin Raviv et al. (2010). Interaction with mouse clicks via level-set based segmentation has been suggested before by Ben-Zadok et al. (2009) and Cremers et al. (2007b). Nevertheless, there are essential differences. In  Ben-Zadok et al. (2009) and Cremers et al. (2007b) binary (hard) segmentation is considered where each pixel is assigned to either the ROI or to the background. The interaction that follows the automatic segmentation is represented by a map containing clouds of positive and negative values (based on the user provided clicks) directly affecting the level-set evolution by a simple summation. In contrast to these works and to others mentioned above, the proposed framework is entirely based on probabilistic principles. First, the segmentation is fuzzy (soft) such that the value assigned to each voxel represents the likelihood that this voxel belongs to the ROI. Therefore, voxels within or nearby the ROI boundaries have maximum labeling uncertainty. Second, the user interactive map is constructed such that it spatially reflects the user’s certainty that the soft labels of the current (automatic) segmentation estimate should be altered. Finally, the probability that each of the image voxels ‘flips’ its ROI-background assignment is determined by the user-certainty map by considering it as voxel-wise Bernoulli parameters.

The suggested probabilistic framework leads to a flexible and tolerable interaction, taking into account occasional user mistakes. Note that the user does not edit the segmentation. Instead, our model provides an elegant framework to refine segmentation by resolving voxel annotation ambiguities, through a user-machine dialogue. The user term in the unified cost functional is constructed such that voxels that are not within the user’s regions of influence do not contribute to the evolution of the segmentation (due to the user). In other words, ‘neglecting’ a region is not interpreted as ‘supporting’ its segmentation. Therefore, regions that are incorrectly labeled by the current segmentation and are missed by the user, can be easily corrected in a subsequent interaction step. In contrast, regions that are assigned with high probability to either the ROI or the background by the current soft segmentation are less likely to alter their assignment, if marked by mistake by the user. It turns out that this mechanism, while requiring user persistency in high confidence regions (in which apparently intensity-based segmentation should work well) eventually leads to a reduction in user effort.

Our user-interactive segmentation method is exemplified on the segmentation of three different datasets including cerebral hemorrhages (CH) in human brain CT scans; ventricles in degenerative mice brain MRIs and tumors in multi-modal human brain MRIs.

We developed a GUI to allow a convenient interaction with the software. The tool was tested by our clinical collaborators who acknowledged its operating convenience and accuracy (measured subjectively by rating user satisfaction). Usually, not more than a couple of user interaction steps were needed in order to obtain almost a complete overlap with an independent, fully manual annotation.

The accuracy of the results, measured via Dice scores (Dice, 1945), the method’s efficiency (which is inversely proportional to the total duration of the interactive segmentation), as well as the user’s workload (indicated by the average number of required interactions) were favorably compared to those obtained by three different state-of-the-art user interactive (UI) segmentation tools, namely the Grabcut (Rother et al., 2004), the TurtleSeg (Hamarneh et al., 2005; Poon et al., 2007, 2008; Top et al., 2010, 2011) and the ilastik (Sommer et al., 2011). Brain tumor segmentation results of multi-modal MRI scans were favorably compared to those reported in the BRATS paper (Menze et al., 2015) suggesting IS as a means to break the limits of fully automatic segmentation approaches, when dealing with extremely challenging data.

The rest of the paper is organized as follows: In Section 2 we define the underlying probabilistic model followed by the introduction of the corresponding level-set formulation (Section 3). Implementation details are discussed in Section 4. Section 5 presents the experimental results. We summarize the paper and suggest future directions in Section 6. Finally, the GUI is described in the Appendix A.

Let 
                           
                              
                                 I
                                 1
                              
                              ,
                              …
                              ,
                              
                                 I
                                 M
                              
                           
                         be an ensemble of gray-level images defined on the same 3D image domain Ω. Here, we assume that 
                           
                              
                                 I
                                 1
                              
                              ,
                              …
                              ,
                              
                                 I
                                 M
                              
                           
                         are aligned multi-modal scans of the same subject, acquired at the same time. Our goal is to extract the common ROI denoted by ω ∈ Ω. Let S: Ω → {0, 1} denote the corresponding, unknown binary voxel annotation of Ω. We assume that the observed images 
                           
                              
                                 I
                                 1
                              
                              ,
                              …
                              
                                 I
                                 M
                              
                           
                         are generated by the segmentation S with probability 
                           
                              p
                              (
                              
                                 I
                                 1
                              
                              ,
                              …
                              
                                 I
                                 M
                              
                              |
                              S
                              ;
                              ψ
                              )
                              ,
                           
                         where ψ denotes the model parameters of the ensemble intensities. A fully automatic segmentation can be stated by the following MAP problem:

                           
                              (1)
                              
                                 
                                    p
                                    
                                       (
                                       S
                                       |
                                       
                                          I
                                          1
                                       
                                       ,
                                       …
                                       
                                          I
                                          M
                                       
                                       ;
                                       ψ
                                       )
                                    
                                    ∝
                                    p
                                    
                                       (
                                       
                                          I
                                          1
                                       
                                       ,
                                       …
                                       ,
                                       
                                          I
                                          M
                                       
                                       |
                                       S
                                       ;
                                       ψ
                                       )
                                    
                                    p
                                    
                                       (
                                       S
                                       )
                                    
                                    =
                                    
                                       ∏
                                       
                                          m
                                          =
                                          1
                                       
                                       M
                                    
                                    p
                                    
                                       (
                                       
                                          I
                                          m
                                       
                                       |
                                       S
                                       ,
                                       
                                          ψ
                                          m
                                       
                                       )
                                    
                                    p
                                    
                                       (
                                       S
                                       )
                                    
                                    ,
                                 
                              
                           
                        where the prior p(S) is used for regularization as we show below. Here, in accordance with Ashburner and Friston (2005), we further assume that the images 
                           
                              
                                 I
                                 1
                              
                              ,
                              …
                              ,
                              
                                 I
                                 M
                              
                           
                         are conditionally independent and ψm
                         are the univariate Gaussian mixture (GM) parameters modeling the intensity distribution of Im
                        . For reasons that will be clarified in Section 4.3 and Section 5.3, ψ is not a multivariate GMM of the joint ensemble intensities.

Incorporating the user input, the proposed segmentation framework is carried out iteratively, where at each interaction step k the user provides a set of seed points (using the mouse), after observing the previous segmentation estimate, i.e. 
                           
                              S
                              
                                 k
                                 −
                                 1
                              
                           
                        . We denote this set by Uk
                         and use it to construct a continuous user map ηk: Ω → [0, 1]. We assume that Sk
                         is generated with probability p(Sk
                        |ηk
                        ). Given the intensity distribution parameters of the observed images and the user input, i.e. ηk
                        , we can define the posterior probability of Sk
                        , using the Bayes theorem and the chain rule, as follows:

                           
                              (2)
                              
                                 
                                    p
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       |
                                       
                                          I
                                          1
                                       
                                       ,
                                       …
                                       
                                          I
                                          M
                                       
                                       ;
                                       
                                          ψ
                                          1
                                       
                                       ,
                                       …
                                       ,
                                       
                                          ψ
                                          M
                                       
                                       ,
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    ∝
                                    
                                       ∏
                                       
                                          m
                                          =
                                          1
                                       
                                       M
                                    
                                    p
                                    
                                       (
                                       
                                          I
                                          m
                                       
                                       |
                                       
                                          S
                                          k
                                       
                                       ,
                                       
                                          ψ
                                          m
                                       
                                       )
                                    
                                    p
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       ;
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                        
                        Fig. 1
                         graphically illustrates the probabilistic model defined above.

Following Cremers et al. (2007b) and others, we define a Gibbs distribution 
                           
                              p
                              
                                 (
                                 
                                    S
                                    k
                                 
                                 )
                              
                              ∝
                              exp
                              
                                 (
                                 −
                                 β
                                 E
                                 
                                    (
                                    
                                       S
                                       k
                                    
                                    )
                                 
                                 )
                              
                              ,
                           
                         where β is a free parameter. This allows the derivation of a level-set cost functional 
                           
                              E
                              (
                              
                                 S
                                 k
                              
                              )
                           
                         based on probabilistic principles. Using the logarithm of the expression in Eq. (2), we look for 
                           
                              
                                 
                                    S
                                    ^
                                 
                                 k
                              
                              =
                              arg
                              
                              max
                              
                                 p
                                 
                                    S
                                    k
                                 
                              
                              
                                 (
                                 
                                    S
                                    k
                                 
                                 |
                                 
                                    I
                                    1
                                 
                                 ,
                                 …
                                 ,
                                 
                                    I
                                    M
                                 
                                 ;
                                 
                                    ψ
                                    1
                                 
                                 ,
                                 …
                                 ,
                                 
                                    ψ
                                    M
                                 
                                 ,
                                 
                                    η
                                    k
                                 
                                 )
                              
                           
                         by minimizing the following cost functional:

                           
                              (3)
                              
                                 
                                    E
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       )
                                    
                                    =
                                    −
                                    
                                       ∑
                                       
                                          m
                                          =
                                          1
                                       
                                       M
                                    
                                    log
                                    p
                                    
                                       (
                                       
                                          I
                                          m
                                       
                                       |
                                       
                                          S
                                          k
                                       
                                       ;
                                       
                                          ψ
                                          m
                                       
                                       )
                                    
                                    −
                                    log
                                    p
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       ;
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                        
                     

In the following, an explicit formulation of the image likelihood terms p(Im
                        |Sk; ψm
                        ) and the user input term p(Sk; ηk
                        ) will be presented. We assume i.i.d. distribution of the image voxels. Therefore, the probability over the entire image domain will be presented by the product of probabilities of each voxel. A continuous form of 
                           E
                         based on a level-set framework will be introduced next, followed by a gradient descent (GD) optimization process to estimate Sk
                        .

Let 
                           
                              
                                 U
                                 k
                              
                              =
                              
                                 
                                    {
                                    
                                       x
                                       l
                                       k
                                    
                                    }
                                 
                                 
                                    l
                                    =
                                    1
                                 
                                 
                                    L
                                    k
                                 
                              
                           
                         denote a collection of user seed points at a time step k, defined on the 3D image domain, where 
                           
                              
                                 x
                                 l
                                 k
                              
                              =
                              
                                 (
                                 
                                    x
                                    l
                                    k
                                 
                                 ,
                                 
                                    y
                                    l
                                    k
                                 
                                 ,
                                 
                                    z
                                    l
                                    k
                                 
                                 )
                              
                           
                         are the coordinates of a seed voxel and Lk
                         is the number of seed points at the kth interaction step. The probabilistic UI framework described in the following, is a key contribution of the proposed framework. Let 
                           
                              
                                 ω
                                 ^
                              
                              
                                 in
                              
                              
                                 k
                                 −
                                 1
                              
                           
                         be the ROI estimate at step 
                           
                              k
                              −
                              1
                              ,
                           
                         and let 
                           
                              
                                 
                                    ω
                                    ^
                                 
                                 
                                    out
                                 
                                 
                                    k
                                    −
                                    1
                                 
                              
                              ≜
                              Ω
                              ∖
                              
                                 
                                    ω
                                    ^
                                 
                                 
                                    in
                                 
                                 
                                    k
                                    −
                                    1
                                 
                              
                           
                         define the background. We partition Uk
                         into 
                           
                              
                                 U
                                 in
                                 k
                              
                              ≜
                              
                                 {
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    U
                                    k
                                 
                                 |
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    
                                       ω
                                       ^
                                    
                                    
                                       in
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 }
                              
                           
                         and 
                           
                              
                                 U
                                 out
                                 k
                              
                              ≜
                              
                                 {
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    U
                                    k
                                 
                                 |
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    
                                       ω
                                       ^
                                    
                                    
                                       out
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 }
                              
                              ,
                           
                         which are the foreground and the background seed points, respectively. Let R define the extent of user influence and let 
                           
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                           
                         define the distance of a voxel x from a seed point 
                           
                              
                                 x
                                 l
                                 k
                              
                              ,
                           
                         assuming that both voxels belong either to the foreground or to the background. The regions of user influence are all image voxels x ∈ Ω that belong to either of the following subgroups: 
                           
                              
                                 R
                                 in
                                 k
                              
                              ≜
                              
                                 {
                                 x
                                 ∈
                                 
                                    
                                       ω
                                       ^
                                    
                                    
                                       in
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 |
                                 
                                    D
                                    k
                                 
                                 
                                    (
                                    x
                                    ,
                                    
                                       x
                                       l
                                       k
                                    
                                    )
                                 
                                 <
                                 R
                                 ,
                                 where
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    U
                                    
                                       in
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 }
                              
                              ,
                           
                         and 
                           
                              
                                 R
                                 out
                                 k
                              
                              ≜
                              
                                 {
                                 x
                                 ∈
                                 
                                    
                                       ω
                                       ^
                                    
                                    
                                       out
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 |
                                 
                                    D
                                    k
                                 
                                 
                                    (
                                    x
                                    ,
                                    
                                       x
                                       l
                                       k
                                    
                                    )
                                 
                                 <
                                 R
                                 ,
                                 where
                                 
                                    x
                                    l
                                    k
                                 
                                 ∈
                                 
                                    U
                                    
                                       out
                                    
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 }
                              
                           
                        . If 
                           
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                           
                         is a Euclidean distance, then 
                           
                              R
                              in
                              k
                           
                         and 
                           
                              R
                              out
                              k
                           
                         are collections of Lk
                         spheres with radius R. In the general case, 
                           
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                           
                         is a geodesic distance and the sub-regions defined by the seed points may not be isotropic. For example, the distance of a voxel x to a user’s marked voxel can take into account image gradients and intensity differences, as in Arbelle et al. (2015). This extension is the subject of a future study. We note that the calculation of 
                           
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                           
                         is performed for every seed point 
                           
                              x
                              l
                              k
                           
                         using fast marching algorithm (Sethian, 1999), such that in case of an overlap the nearest point (minimal distance) is chosen, i.e. 
                           
                              
                                 x
                                 min
                                 k
                              
                              =
                              
                                 
                                    arg
                                    min
                                 
                                 
                                    x
                                    l
                                    k
                                 
                              
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                              .
                           
                         We now construct a continuous probability map ηk: Ω → [0, 1] that represents the user’s ‘belief’ about the appropriateness of the current segmentation. Since the user provides input in regions of disagreement, then according to the user, 
                           
                              R
                              in
                              k
                           
                         and 
                           
                              R
                              out
                              k
                           
                         should be reassigned to the background and to the ROI (respectively). Let 
                           
                              f
                              
                                 (
                                 d
                                 ,
                                 λ
                                 )
                              
                              =
                              
                                 exp
                                 
                                    −
                                    λ
                                    d
                                 
                              
                              ,
                           
                         where λ is set such that 
                           
                              
                                 lim
                                 
                                    d
                                    →
                                    R
                                 
                              
                              f
                              
                                 (
                                 d
                                 ,
                                 λ
                                 )
                              
                              =
                              0
                              .
                           
                         Again, if 
                           
                              d
                              =
                              
                                 D
                                 k
                              
                              
                                 (
                                 x
                                 ,
                                 
                                    x
                                    l
                                    k
                                 
                                 )
                              
                           
                         is an Euclidean distance, the operation of f is equivalent to smoothing the user seed points by a Gaussian kernel. We now define the user’s probability map as follows:

                           
                              (4)
                              
                                 
                                    
                                       η
                                       k
                                    
                                    
                                       (
                                       x
                                       )
                                    
                                    =
                                    
                                       {
                                       
                                          
                                             
                                                
                                                   
                                                      (
                                                      1
                                                      +
                                                      f
                                                      
                                                         (
                                                         min
                                                         
                                                            (
                                                            0
                                                            ,
                                                            
                                                               D
                                                               k
                                                            
                                                            
                                                               (
                                                               x
                                                               ,
                                                               
                                                                  x
                                                                  l
                                                                  k
                                                               
                                                               )
                                                            
                                                            −
                                                            R
                                                            )
                                                         
                                                         ,
                                                         λ
                                                         )
                                                      
                                                      )
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                             
                                             
                                                
                                                   if
                                                   
                                                   x
                                                   ∈
                                                   
                                                      
                                                         ω
                                                         ^
                                                      
                                                      
                                                         in
                                                      
                                                      
                                                         k
                                                         −
                                                         1
                                                      
                                                   
                                                
                                             
                                          
                                          
                                             
                                                
                                                   
                                                      (
                                                      1
                                                      +
                                                      f
                                                      
                                                         (
                                                         max
                                                         
                                                            (
                                                            0
                                                            ,
                                                            R
                                                            −
                                                            
                                                               D
                                                               k
                                                            
                                                            
                                                               (
                                                               x
                                                               ,
                                                               
                                                                  x
                                                                  l
                                                                  k
                                                               
                                                               )
                                                            
                                                            )
                                                         
                                                         ,
                                                         λ
                                                         )
                                                      
                                                      )
                                                   
                                                   
                                                      −
                                                      1
                                                   
                                                
                                             
                                             
                                                otherwise
                                             
                                          
                                       
                                    
                                 
                              
                           
                        The map ηk
                        (x) represents the user’s certainty that a voxel x should be assigned to the ROI. It is built such that ηk
                        (x) ∈ [0, 0.5] and ηk
                        (x) ∈ [0.5, 1], in the foreground and the background regions, respectively. For example, if ηk
                        (x) < p and p < 0.5, then x is by construction an ROI voxel and the user ‘believes’ it should be assigned to the ROI with probability p and with probability 
                           
                              q
                              =
                              1
                              −
                              p
                           
                         to the background (q > 0.5). Note that 
                           
                              
                                 η
                                 k
                              
                              
                                 (
                                 x
                                 )
                              
                              =
                              0.5
                           
                         for all image voxels that do not belong to the regions of influence. This can be interpreted as being ‘neutral’ about the current assignment or having maximum uncertainty. In contrast, 
                           
                              η
                              (
                              x
                              )
                              =
                              0
                           
                         if x is an ROI seed point and 
                           
                              η
                              (
                              x
                              )
                              =
                              1
                           
                         if x is a background seed point.


                        Fig. 2
                         illustrates the main concept. Fig. 2a presents an example image (a 2D slice of a 3D MRI brain scan of a low grade glioma patient) along with a segmentation estimate (green contour) of the ROI (tumor) and three user clicks in regions of disagreement. The red stars mark the centers of regions within the the ROI that according to the user should be excluded. The yellow star marks the center of a region in the background that should be part of the ROI according to the user. The respective probability map, η is visually demonstrated by the gray-level image shown in Fig. 2b. The region within the ROI contour (shown here in green as a reference) ranges between zero (for the ROI seed voxels) to 0.5, while the region outside the ROI ranges from 1 (for the background seed voxels) to 0.5.

The user term is a function of the logarithm of the Bernoulli distribution

                           
                              (5)
                              
                                 
                                    
                                       E
                                       UI
                                    
                                    =
                                    −
                                    log
                                    p
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       ;
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    =
                                    −
                                    p
                                    
                                       (
                                       
                                          S
                                          k
                                       
                                       )
                                    
                                    log
                                    
                                       (
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    −
                                    
                                       (
                                       1
                                       −
                                       p
                                       
                                          (
                                          
                                             S
                                             k
                                          
                                          )
                                       
                                       )
                                    
                                    log
                                    
                                       (
                                       1
                                       −
                                       
                                          η
                                          k
                                       
                                       )
                                    
                                    .
                                 
                              
                           
                        Note that while voxels x that are outside the regions of user influence (
                           
                              
                                 η
                                 k
                              
                              
                                 (
                                 x
                                 )
                              
                              =
                              0.5
                           
                        ) do not contribute to the cost; the added cost of voxels within those regions (either in 
                           
                              R
                              in
                           
                         or in 
                           
                              R
                              out
                           
                        ) grows and approaches infinity as the voxels are closer to the seed points.

We use mixtures of Gaussians to model the intensity distribution within and outside the ROI of each image Im
                        . For clarity, the subscript m is omitted from the distribution parameters. Let 
                           
                              
                                 ψ
                                 m
                                 in
                              
                              =
                              
                                 
                                    {
                                    
                                       μ
                                       i
                                       in
                                    
                                    ,
                                    
                                       σ
                                       i
                                       in
                                    
                                    ,
                                    
                                       α
                                       i
                                       in
                                    
                                    }
                                 
                                 
                                    i
                                    =
                                    1
                                 
                                 
                                    N
                                    in
                                 
                              
                           
                         and let 
                           
                              
                                 ψ
                                 m
                                 out
                              
                              =
                              
                                 
                                    {
                                    
                                       μ
                                       i
                                       out
                                    
                                    ,
                                    
                                       σ
                                       i
                                       out
                                    
                                    ,
                                    
                                       α
                                       i
                                       out
                                    
                                    }
                                 
                                 
                                    i
                                    =
                                    1
                                 
                                 
                                    N
                                    out
                                 
                              
                              ,
                           
                         where N
                        
                           in
                         and N
                        
                           out
                         are the respective numbers of Gaussians and αi
                         are the weights. For each image voxel x with intensity Im
                        (x) we define

                           
                              (6)
                              
                                 
                                    
                                       
                                          
                                             
                                                P
                                                in
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   in
                                                
                                                )
                                             
                                          
                                       
                                       
                                          ∝
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                
                                                   N
                                                   in
                                                
                                             
                                             
                                                α
                                                i
                                                in
                                             
                                             exp
                                             
                                                (
                                                −
                                                
                                                   
                                                      
                                                         (
                                                         
                                                            I
                                                            m
                                                         
                                                         
                                                            (
                                                            x
                                                            )
                                                         
                                                         −
                                                         
                                                            μ
                                                            i
                                                            in
                                                         
                                                         )
                                                      
                                                      2
                                                   
                                                   
                                                      2
                                                      
                                                         
                                                            (
                                                            
                                                               σ
                                                               i
                                                               in
                                                            
                                                            )
                                                         
                                                         2
                                                      
                                                   
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                P
                                                out
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   out
                                                
                                                )
                                             
                                          
                                       
                                       
                                          ∝
                                       
                                       
                                          
                                             
                                                ∑
                                                
                                                   i
                                                   =
                                                   1
                                                
                                                
                                                   N
                                                   out
                                                
                                             
                                             
                                                α
                                                i
                                                out
                                             
                                             exp
                                             
                                                (
                                                −
                                                
                                                   
                                                      
                                                         (
                                                         
                                                            I
                                                            m
                                                         
                                                         
                                                            (
                                                            x
                                                            )
                                                         
                                                         −
                                                         
                                                            μ
                                                            i
                                                            out
                                                         
                                                         )
                                                      
                                                      2
                                                   
                                                   
                                                      2
                                                      
                                                         
                                                            (
                                                            
                                                               σ
                                                               i
                                                               out
                                                            
                                                            )
                                                         
                                                         2
                                                      
                                                   
                                                
                                                )
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The image likelihood cost, for a given ROI, could be defined as follows:

                           
                              (7)
                              
                                 
                                    
                                       
                                          
                                             E
                                             IL
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             −
                                             
                                                ∑
                                                
                                                   m
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                [
                                                
                                                   ∑
                                                   
                                                      x
                                                      ∈
                                                      
                                                         ω
                                                         k
                                                      
                                                   
                                                
                                                log
                                                
                                                   P
                                                   in
                                                
                                                
                                                   (
                                                   
                                                      I
                                                      m
                                                   
                                                   
                                                      (
                                                      x
                                                      )
                                                   
                                                   ;
                                                   
                                                      ψ
                                                      m
                                                      in
                                                   
                                                   )
                                                
                                                
                                                +
                                                
                                                
                                                   ∑
                                                   
                                                      x
                                                      ∈
                                                      Ω
                                                      ∖
                                                      
                                                         ω
                                                         k
                                                      
                                                   
                                                
                                                log
                                                
                                                   P
                                                   out
                                                
                                                
                                                   (
                                                   
                                                      I
                                                      m
                                                   
                                                   
                                                      (
                                                      x
                                                      )
                                                   
                                                   ;
                                                   
                                                      ψ
                                                      m
                                                      out
                                                   
                                                   )
                                                
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                          =
                                       
                                       
                                          
                                             −
                                             
                                                ∑
                                                
                                                   m
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                ∑
                                                
                                                   x
                                                   ∈
                                                   Ω
                                                
                                             
                                             
                                                [
                                             
                                             
                                                S
                                                k
                                             
                                             
                                                (
                                                x
                                                )
                                             
                                             log
                                             
                                                P
                                                in
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   in
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                                (
                                                1
                                                −
                                                
                                                   S
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             log
                                             
                                                P
                                                out
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   out
                                                
                                                )
                                             
                                             
                                                ]
                                             
                                          
                                       
                                    
                                 
                              
                           
                        Note, that both the ROI (or equivalently, the segmentation Sk
                        ) and the intensity distribution parameters {ψm
                        } are unknown, and are therefore estimated via an alternating minimization scheme that is detailed in the following.

We use a level-set framework to formulate the UI-segmentation problem (Osher and Sethian, 1988). Let ϕk
                         define a level-set function, such that 
                           
                              ∂
                              
                                 ω
                                 k
                              
                              =
                              
                                 {
                                 x
                                 |
                                 
                                    ϕ
                                    k
                                 
                                 
                                    (
                                    x
                                    )
                                 
                                 =
                                 0
                                 }
                              
                           
                         denotes the estimated common ROI boundaries in 
                           
                              
                                 I
                                 1
                              
                              ,
                              …
                              ,
                              
                                 I
                                 M
                              
                           
                         at step k, and let ωk
                         denote the corresponding ROI domain. As in Chan and Vese (2001), the binary segmentation Sk
                         can be represented by applying the Heaviside function to ϕk
                        , i.e. H(ϕk
                        ). Adopting the probabilistic approach in Riklin Raviv et al. (2010), we use the logistic regression sigmoid, which can be used as a regularized form of the Heaviside function, to represent the soft segmentation p(Sk
                        ):

                           
                              (8)
                              
                                 
                                    
                                       H
                                       ϵ
                                    
                                    
                                       (
                                       
                                          ϕ
                                          k
                                       
                                       )
                                    
                                    =
                                    
                                       1
                                       2
                                    
                                    
                                       (
                                       1
                                       +
                                       tanh
                                       
                                          (
                                          
                                             
                                                ϕ
                                                k
                                             
                                             
                                                2
                                                ϵ
                                             
                                          
                                          )
                                       
                                       )
                                    
                                    =
                                    
                                       1
                                       
                                          1
                                          +
                                          
                                             e
                                             
                                                −
                                                
                                                   ϕ
                                                   k
                                                
                                                /
                                                ϵ
                                             
                                          
                                       
                                    
                                    ,
                                 
                              
                           
                        where ϵ can be use to determine the fuzziness of the estimated ROI boundaries (Riklin Raviv et al., 2010). As in  Riklin Raviv et al. (2010), we now define the level-set function ϕk
                        , as follows:

                           
                              (9)
                              
                                 
                                    
                                       
                                          
                                             
                                                ϕ
                                                k
                                             
                                             
                                                (
                                                x
                                                )
                                             
                                          
                                       
                                       
                                          ≜
                                       
                                       
                                          
                                             ϵ
                                             logit
                                             
                                                (
                                                p
                                                )
                                             
                                             =
                                             ϵ
                                             log
                                             
                                                
                                                   p
                                                   (
                                                   x
                                                   ∈
                                                   
                                                      ω
                                                      k
                                                   
                                                   )
                                                
                                                
                                                   1
                                                   −
                                                   p
                                                   (
                                                   x
                                                   ∈
                                                   
                                                      ω
                                                      k
                                                   
                                                   )
                                                
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                          =
                                       
                                       
                                          
                                             ϵ
                                             log
                                             
                                                
                                                   p
                                                   (
                                                   x
                                                   ∈
                                                   
                                                      ω
                                                      k
                                                   
                                                   )
                                                
                                                
                                                   p
                                                   (
                                                   x
                                                   ∈
                                                   Ω
                                                   ∖
                                                   
                                                      ω
                                                      k
                                                   
                                                   )
                                                
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        It can be shown by substitution of Eq. (9) into Eq. (8) that H
                        ϵ(ϕk
                        ) is equivalent to p(x ∈ ωk
                        ). This relation is fundamental in the proposed probabilistic level-set framework. The level-set function ϕk
                         is developed in an iterative manner, using a gradient descent framework. Note that k counts the number of user interaction steps, as opposed to the iteration index of the gradient descent process, which will be denoted by τ. Usually, not more than 
                           
                              2
                              −
                              5
                           
                         interaction steps are needed. We next use the equivalence between p(Sk
                        ) and H
                        ϵ(ϕk
                        ), and the continuous forms of the equations above to resolve the segmentation problem via a level-set based gradient descent optimization.

The proposed cost functional for a level-set based segmentation includes an image likelihood term - 
                           
                              
                                 E
                                 IL
                              
                              ,
                           
                         a regularization term - 
                           
                              
                                 E
                                 REG
                              
                              ,
                           
                         and a user interaction term 
                           
                              
                                 E
                                 UI
                              
                              :
                           
                        
                        
                           
                              (10)
                              
                                 
                                    
                                       
                                          
                                             E
                                             (
                                             
                                                ϕ
                                                k
                                             
                                             |
                                             
                                                I
                                                1
                                             
                                             ,
                                             …
                                             
                                                I
                                                M
                                             
                                             ,
                                             
                                                ψ
                                                1
                                             
                                             ,
                                             …
                                             
                                                ψ
                                                M
                                             
                                             ,
                                             
                                                η
                                                k
                                             
                                             )
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                E
                                                IL
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                |
                                                
                                                   I
                                                   1
                                                
                                                ,
                                                …
                                                
                                                   I
                                                   M
                                                
                                                ,
                                                
                                                   ψ
                                                   1
                                                
                                                ,
                                                …
                                                
                                                   ψ
                                                   M
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                E
                                                UI
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                ;
                                                
                                                   η
                                                   k
                                                
                                                )
                                             
                                             +
                                             
                                                E
                                                REG
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                )
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        Adopting a continuous formulation and a soft definition of the ROI, the sum over the image voxels, i.e. ∑
                           x
                         ∈ Ω, is replaced with an integration ∫
                           Ω
                        
                        d
                        x, and the binary segmentation Sk
                        (x) is replaced by the probability that a voxel x belongs to the ROI: p(Sk
                        (x)) or, using the level-set formulation, by H
                        ϵ(ϕk
                        (x)). The explicit form of the energy functional in Eq. (10) is as follows:

                           
                              (11)
                              
                                 
                                    
                                       
                                          
                                             E
                                             (
                                             
                                                ϕ
                                                k
                                             
                                             )
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             −
                                             
                                                ∫
                                                Ω
                                             
                                             
                                                {
                                                
                                                   W
                                                   UI
                                                
                                                [
                                             
                                             
                                                H
                                                ϵ
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             log
                                             
                                                η
                                                k
                                             
                                             
                                                (
                                                x
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                H
                                                ϵ
                                             
                                             
                                                (
                                                −
                                                
                                                   ϕ
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             log
                                             
                                                (
                                                1
                                                −
                                                
                                                   η
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                W
                                                IL
                                             
                                             
                                                ∑
                                                
                                                   m
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                [
                                             
                                             
                                                H
                                                ϵ
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             log
                                             
                                                p
                                                in
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   in
                                                
                                                )
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                H
                                                ϵ
                                             
                                             
                                                (
                                                −
                                                
                                                   ϕ
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             log
                                             
                                                p
                                                out
                                             
                                             
                                                (
                                                
                                                   I
                                                   m
                                                
                                                ;
                                                
                                                   ψ
                                                   m
                                                   out
                                                
                                                )
                                             
                                             
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                W
                                                LEN
                                             
                                             
                                                |
                                                ∇
                                             
                                             
                                                H
                                                ϵ
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                
                                                   (
                                                   x
                                                   )
                                                
                                                )
                                             
                                             
                                                |
                                                }
                                             
                                             d
                                             x
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        The last term in Eq. (11), i.e. |∇H
                        ϵ(ϕk
                        (x))|, is known in the level-set literature as the smoothness or regularization term (Chan and Vese, 2001). The relation to 
                           
                              −
                              log
                              p
                              (
                              
                                 S
                                 k
                              
                              )
                           
                         where p(Sk
                        ) is the prior in Eq. (1) is shown in Riklin Raviv et al. (2010). The weights W
                        
                           UI
                        , W
                        
                           IL
                        , W
                        
                           LEN
                         are positive scalars that balance the contribution of each term. Setting these weights is discussed in Section 4.2.

We look for the segmentation ϕk
                         that optimizes the energy functional (Eq. (11)) via a gradient descent process. The gradient descent step 
                           
                              
                                 ∂
                                 
                                    ϕ
                                    k
                                 
                              
                              
                                 ∂
                                 τ
                              
                           
                         is derived from the first variation of the functional above and determines the evolution of the segmentation

                           
                              (12)
                              
                                 
                                    
                                       
                                          
                                             
                                                ∂
                                                
                                                   ϕ
                                                   k
                                                
                                             
                                             
                                                ∂
                                                τ
                                             
                                          
                                       
                                       
                                          =
                                       
                                       
                                          
                                             
                                                δ
                                                ϵ
                                             
                                             
                                                (
                                                
                                                   ϕ
                                                   k
                                                
                                                )
                                             
                                             {
                                             
                                                W
                                                UI
                                             
                                             
                                                [
                                                log
                                                
                                                   (
                                                   
                                                      η
                                                      k
                                                   
                                                   )
                                                
                                                −
                                                log
                                                
                                                   (
                                                   1
                                                   −
                                                   
                                                      η
                                                      k
                                                   
                                                   )
                                                
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                W
                                                IL
                                             
                                             
                                                ∑
                                                
                                                   m
                                                   =
                                                   1
                                                
                                                M
                                             
                                             
                                                [
                                                log
                                                
                                                   p
                                                   in
                                                
                                                
                                                   (
                                                   
                                                      I
                                                      m
                                                   
                                                   ;
                                                   
                                                      ψ
                                                      m
                                                      in
                                                   
                                                   )
                                                
                                                −
                                                log
                                                
                                                   p
                                                   out
                                                
                                                
                                                   (
                                                   
                                                      I
                                                      m
                                                   
                                                   ;
                                                   
                                                      ψ
                                                      m
                                                      out
                                                   
                                                   )
                                                
                                                ]
                                             
                                          
                                       
                                    
                                    
                                       
                                       
                                       
                                          
                                             +
                                             
                                             
                                                W
                                                LEN
                                             
                                             
                                             div
                                             
                                                (
                                                
                                                   
                                                      ∇
                                                      
                                                         ϕ
                                                         k
                                                      
                                                   
                                                   
                                                      
                                                         |
                                                         ∇
                                                      
                                                      
                                                         ϕ
                                                         k
                                                      
                                                      
                                                         |
                                                      
                                                   
                                                
                                                )
                                             
                                             }
                                             ,
                                          
                                       
                                    
                                 
                              
                           
                        where div is the divergence operator and δ
                        ϵ(ϕk
                        ) is the derivative of H
                        ϵ(ϕk
                        ) with respect to ϕk
                        : 
                           
                              
                                 δ
                                 ϵ
                              
                              
                                 (
                                 ϕ
                                 )
                              
                              =
                              
                                 
                                    d
                                    
                                       H
                                       ϵ
                                    
                                    
                                       (
                                       ϕ
                                       )
                                    
                                 
                                 
                                    d
                                    ϕ
                                 
                              
                              =
                              
                                 1
                                 
                                    4
                                    ϵ
                                 
                              
                              
                                 sech
                                 2
                              
                              
                                 (
                                 
                                    ϕ
                                    
                                       2
                                       ϵ
                                    
                                 
                                 )
                              
                              .
                           
                         The scalar maps 
                           
                              
                                 p
                                 in
                              
                              
                                 (
                                 
                                    S
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    η
                                    in
                                    k
                                 
                                 )
                              
                              ,
                              
                                 p
                                 out
                              
                              
                                 (
                                 
                                    S
                                    
                                       k
                                       −
                                       1
                                    
                                 
                                 ,
                                 
                                    η
                                    out
                                    k
                                 
                                 )
                              
                           
                         are updated once after each UI step, and remain constant throughout the gradient descent iterations. The GMM of the image intensities 
                           
                              ψ
                              m
                              in
                           
                         and 
                           
                              ψ
                              m
                              out
                           
                         are re-estimated in correspondence to 
                           
                              
                                 ϕ
                                 
                                    τ
                                 
                                 k
                              
                              ,
                           
                         which determines the ROI boundaries, using expectation maximization (EM) (Dempster et al., 1977). Therefore, 
                           
                              
                                 p
                                 in
                              
                              
                                 (
                                 
                                    I
                                    m
                                 
                                 ;
                                 
                                    ψ
                                    m
                                    in
                                 
                                 )
                              
                              ,
                              
                                 p
                                 out
                              
                              
                                 (
                                 
                                    I
                                    m
                                 
                                 ;
                                 
                                    ψ
                                    m
                                    out
                                 
                                 )
                              
                           
                         are calculated at every iteration, based on the updated intensity distribution parameters.

@&#IMPLEMENTATION DETAILS@&#

The proposed UI segmentation algorithm for the extraction of a common ROI given an ensemble of multi-modal images is as follows:

                           
                              1.
                              
                                 Initialize
                                 
                                    
                                       (a)
                                       For each modality m, initialize ψm
                                           based on the estimated probability density functions (PDFs) of the intensities of the available labeled examples 
                                             
                                                {
                                                
                                                   I
                                                   m
                                                   f
                                                
                                                ,
                                                
                                                   S
                                                   f
                                                
                                                }
                                                ,
                                             
                                           where 
                                             
                                                I
                                                m
                                                f
                                             
                                           is a training image of the same modality and Sf
                                           denotes its corresponding segmentation. The PDFs for the ROI and the background 
                                             
                                                
                                                   ψ
                                                   m
                                                   INIT
                                                
                                                =
                                                
                                                   {
                                                   
                                                      ψ
                                                      m
                                                      
                                                         in
                                                         ,
                                                         INIT
                                                      
                                                   
                                                   ,
                                                   
                                                      ψ
                                                      m
                                                      
                                                         out
                                                         ,
                                                         INIT
                                                      
                                                   
                                                   }
                                                
                                             
                                           are modeled by a mixture of Gaussians.

Construct a preliminary segmentation ϕ
                                          
                                             INIT
                                           based on the learned PDFs 
                                             
                                                ψ
                                                m
                                                INIT
                                             
                                           according to Eq. (6).

Set 
                                             
                                                
                                                   ϕ
                                                   k
                                                
                                                =
                                                
                                                   ϕ
                                                   INIT
                                                
                                                ,
                                             
                                          
                                          
                                             
                                                k
                                                =
                                                0
                                                .
                                             
                                           Soft (fuzzy) segmentation is defined by H
                                          ϵ(ϕk
                                          ), where binary (hard) segmentation Sk
                                           is obtained by thresholding ϕk
                                           at zero.


                                 Repeat until the user is satisfied
                                 
                                    
                                       (a)
                                       Set 
                                             
                                                k
                                                =
                                                k
                                                +
                                                1
                                                .
                                             
                                          
                                       

Provide 3D and 2D visualizations of 
                                             
                                                S
                                                
                                                   k
                                                   −
                                                   1
                                                
                                             
                                           and allow UI using the GUI (detailed in Appendix A ).

If the user is satisfied, set 
                                             
                                                S
                                                =
                                                
                                                   S
                                                   
                                                      k
                                                      −
                                                      1
                                                   
                                                
                                             
                                           and go to step 3, otherwise, receive user input in the form of a list of 3D coordinates defined by mouse clicks.

Calculate the current user probability map ηk
                                           according to Eq. (4) based on 
                                             
                                                
                                                   S
                                                   
                                                      k
                                                      −
                                                      1
                                                   
                                                
                                                .
                                             
                                          
                                       

Set 
                                             
                                                
                                                   S
                                                   k
                                                
                                                
                                                   (
                                                   τ
                                                   =
                                                   0
                                                   )
                                                
                                                =
                                                
                                                   S
                                                   
                                                      k
                                                      −
                                                      1
                                                   
                                                
                                                .
                                             
                                          
                                       

Set 
                                             
                                                τ
                                                =
                                                1
                                                .
                                             
                                          
                                       


                                          Repeat until convergence or until a (predefined) maximum number of iterations 
                                          T
                                          is reached.
                                          
                                             
                                                (i)
                                                Calculate the unimodal GMMs of the ROI and the background for each modality in the currently examined test case: 
                                                      
                                                         
                                                            I
                                                            1
                                                         
                                                         ,
                                                         …
                                                         
                                                            I
                                                            M
                                                         
                                                      
                                                    based on 
                                                      
                                                         
                                                            S
                                                            k
                                                         
                                                         
                                                            (
                                                            τ
                                                            −
                                                            1
                                                            )
                                                         
                                                         .
                                                      
                                                   
                                                

Calculate the gradient descent equation of ϕk
                                                    (i.e. 
                                                      
                                                         
                                                            ∂
                                                            ϕ
                                                         
                                                         
                                                            ∂
                                                            τ
                                                         
                                                      
                                                   ) according to Eq. (12).

Update: 
                                                      
                                                         
                                                            ϕ
                                                            k
                                                         
                                                         
                                                            (
                                                            τ
                                                            +
                                                            Δ
                                                            τ
                                                            )
                                                         
                                                         =
                                                         
                                                            ϕ
                                                            k
                                                         
                                                         
                                                            (
                                                            τ
                                                            )
                                                         
                                                         +
                                                         Δ
                                                         τ
                                                         
                                                            
                                                               ∂
                                                               ϕ
                                                            
                                                            
                                                               ∂
                                                               τ
                                                            
                                                         
                                                         .
                                                      
                                                   
                                                

Set 
                                             
                                                
                                                   S
                                                   k
                                                
                                                =
                                                
                                                   S
                                                   k
                                                
                                                
                                                   (
                                                   τ
                                                   =
                                                   T
                                                   )
                                                
                                                .
                                             
                                          
                                       

Present measurements based on the final segmentation S via the GUI.

Starting from the second interaction step (
                           
                              k
                              =
                              2
                           
                        ) we enforce a balance between the weights of the energy terms in Eq. (11) and the respective GD equation. We therefore adaptively tune the weights such that the maximum of the absolute value of the contribution of each term is set to one (Riklin-Raviv et al., 2007). However, in the first interaction step, we effectively set the weight of the UI term ( W
                        
                           UI
                        ) to a higher value, allowing stronger user influence when there is a mismatch between the learned PDFs and the intensity distribution of the images in the examined case. The size of the gradient descent update step (Δτ) decreases as a function of the number of gradient descent (GD) iterations. To limit the runtime and allow reasonable response time to the user interaction, we set an upper limit on the number of GD steps.

The image likelihood term, presented in Eq. (7), is based on a GM model of the multi-modal image ensemble intensities. As the different modalities represent the same ROI and therefore are dependent, a mixture of multivariate Gaussians seems to be an adequate representation of the gray-levels PDF. Nevertheless, we chose to estimate the PDF of each modality by univariate GMM, although there is no equivalency between the two models, when the off-diagonal elements of a covariance matrix of a multivariate Gaussian are not negligible. This allows faster convergence in case the number of Gaussians in the mixture is not properly estimated or varies between the modalities (see Fig. 8
                         in Section 5.3 for illustrative examples). In addition, weighting down or eliminating the influence of corrupted, missing or noisy images is easier when the contribution of each image is separable.
                        
                        
                     

We used the Dice score measure (Dice, 1945) to quantify the overlap between the manual segmentations and the segmentations generated using our proposed framework. Let Γ: Ω → {0, 1} define the manual segmentation, provided independently by an expert, and let S: Ω → {0, 1} be the hard (binary) segmentation obtained by our method by thresholding the final level-set function ϕ at zero. The Dice score measure is calculated as follows:

                           
                              (13)
                              
                                 
                                    
                                       2
                                       |
                                       Γ
                                       ∩
                                       S
                                       |
                                    
                                    
                                       |
                                       Γ
                                       |
                                       +
                                       |
                                       S
                                       |
                                    
                                 
                              
                           
                        where | · | is the size of a set (cardinality) and  ∩  is the intersection of two sets.

@&#EXPERIMENTAL RESULTS@&#

The proposed method was implemented and tested using Matlab. Visualization and user interaction were carried out via our unique graphical user interface (GUI)—detailed in the Appendix A. We applied the UI algorithm to three different datasets for the segmentation of different ROIs: cerebral hemorrhages in human brain CT scans; ventricles in degenerative mice brain MRIs and tumors in multi-modal human brain MRIs. The data for the first two experiments was unimodal, i.e. 
                        
                           M
                           =
                           1
                           .
                        
                      Brain tumor data allowed us to test the algorithm for M > 1. We emphasize that the entire segmentation process in all of the examples is 3D. Axial, sagittal and coronal slices of the volumetric scans and the corresponding segmentations are presented, to allow a fair visual assessment of the 3D segmentation. Quantitative evaluations of the results are based on comparisons to independent manual annotations by experts via Dice scores. To ensure an appropriate evaluation of the effort required from the user, we limit each UI step to 10 mouse clicks. Therefore, each of the segmentation results, which was included in the average Dice score calculations (reported in Tables 1–3) was generated with k × 10 mouse clicks, at most. Obviously, the proposed system can accomodate as many clicks as the user requires at each interaction step.


                        Data: CH volume estimates provided by the segmentation are critical to the determination of the therapy procedure, which may involve surgery in addition to medicine intake. In this experiment we tested 15 cases of CH seizures. Brain CT scans were acquired with Philips Brilliance CT 64 system without radiocontrast agents injection. The data resolution is 
                           
                              512
                              ×
                              512
                              ×
                              
                                 [
                                 90
                                 −
                                 100
                                 ]
                              
                           
                         with voxel size of 
                           
                              0.4
                              
                              mm
                              ×
                              0.48
                              
                              mm
                              ×
                              3
                              
                              mm
                              ,
                           
                         with 
                           
                              1.5
                              
                              
                                 [
                                 mm
                                 ]
                              
                           
                         overlap in the axial direction.


                        PDFs and Initialization: Voxelwise labeling based on the learned PDFs of the image intensities usually provides good preliminary segmentation for the brain CT examples as CHs (blood) have well defined density range, expressed in Hounsfield units (CT numbers). Fig. 3
                         presents the image intensities histogram of an arbitrarily selected example. We note that all the cases we examined had very similar PDFs. In these cases the insight of a physician is required only in the presence of calcification, which may have similar gray-level values or when the CH is adjacent to the skull bone.


                        Segmentation results: Qualitative results of some of the cases are shown in Fig. 4
                        . Quantitative results, which were obtained with respect to manual annotation by clinical experts, are shown in Table 1. This includes the Dice scores, sensitivity, specificity and accuracy of the segmentation results obtained by the proposed method.


                        Data and motivation: The proposed UI algorithm was applied to longitudinal brain MRI data of 19 mice acquired (weekly or semi-weekly) along 12 weeks. Scans were acquired by 9.4 Tesla BioSpec 94/20 USR MRI (Bruker) 20 mm receive loop coil combined with a quadrature transmit coil - turbo RARE high resolution 100 × 100 × 400 µm. The data was composed of Alzheimer’s disease (AD)-like ck-p25 transgenic mice and normal controls. Over-expression of p25 protein leads to neuronal death and memory impairments (Cruz et al., 2003). Ventricle segmentations (by the proposed UI segmentation framework) were generated (as a part of an ongoing study) for the construction of a spatio-temporal model for brain degeneration. Segmentation of healthy mouse brain tissues and structures is routinely done by registration of corresponding ROIs between a mouse brain atlas (generated from high-resolution histological data) and the images (Oh et al., 2014). Nevertheless, in the presence of significant atrophies (as in this case), the available healthy brain atlas is useless and the common atlas-based segmentation approaches are prone to errors. The latent spatio-temporal atlas approach provides a good solution, yet it requires several annotated examples along with the temporal series of scans (Dittrich et al., 2011, 2014). On the other hand, manual annotation of a multi-modal or a longitudinal ensemble of scans, which has to be performed in a slice-by-slice manner, is impractical in many cases even for a moderately sized dataset. Moreover, even a specialist cannot avoid holes and structural anomalies that can be inspected only when the segmented slices are combined to construct the complete 3D segmentation. On top of that, inconsistencies between the segmentations of same-case scans are prevalent. Therefore, a semi-automatic framework combines the benefits of both manual and fully automatic segmentation.


                        PDFs and initialization: The mice MR scans underwent bias field correction (according to Zhang et al., 2001) such that a reasonable initialization of the segmentation based on the PDFs was possible. Fig. 5
                         presents two typical gray-level histograms of the ventricles and the background (white and gray matter).


                        Segmentation results: 
                        Fig. 6
                         presents sagittal, axial and coronal slices of four longitudinal 3D scans of an AD-like ck-p25 mouse brain along with the ventricles segmentation (magenta) using the proposed UI segmentation framework. The last row in Fig. 6 shows 3D visualization of the segmented ventricles. Note the significant extension of the ventricles and the subarachnoid during the three months after the onset of the disease. Visual comparison between the available (week 0 only, before the onset of the disease) independent manual annotations, guided by atlas registration as described above, and the proposed UI segmentation method are presented in Fig. 7
                        . Average Dice score obtained by a comparison to the manually annotated subset of the data (11 mice, for which we have manual annotations) is 0.869 ± 0.0391.


                        Data and motivation: We used the BRATS challenge datasets
                           1
                        
                        
                           1
                           The Brain Tumor Segmentation (BRATS) challenge (http://www.imm.dtu.dk/projects/BRATS2012) organized by Menze et al. (2015).
                         containing brain MRI of low grade (LG) and high-grade (HG) glioma patients for evaluation of the proposed algorithm for multi-modal scans. We tested 33 different cases (20 HG and 13 LG cases), which were part of the BRATS 2012 training and test examples, performing whole tumor segmentation based on FLAIR and T2-weighted images.


                        PDFs and initialization: Tumor area and its surrounding can be partitioned into four different pathological regions: 1. non-brain, non-tumor, necrosis, cyst, hemorrhage; 2. surrounding edema; 3. non-enhancing tumor; 4. enhancing tumor core. Each region has a different appearance in each of the modalities. Assuming that the appearance of the same type of pathological region acquired at the same modality across different patients is approximately similar, we learned the whole tumor PDFs from the annotated training scans (excluding the currently examined case, if it belongs to the training examples). The learned PDFs are used to automatically initialize the segmentation. Nevertheless, as gray-level variability does exist, the significance of user feedback is huge. Fig. 8 presents different intensity histograms of tumor scans of different patients. Note the differences in the number of Gaussians in the mixtures. We chose to model the multi-modal intensity distribution by two univariate distributions rather than a single multi-variate distribution, as the former model is more tolerable (see Section 4.3 for further details). In addition, the comparison of the Dice scores (see Table 2) shows that the segmentation using the univariate approach provides more accurate results.


                        Segmentation results: Segmentation results and their comparison with the available gold standard (the manual annotations provided along with the BRATS training set) for five cases are demonstrated in Fig. 9
                        . Note that each line presents scans of a different patient and the right-most column shows the respective 3D tumor segmentation. Table 3 presents quantitative results of the comparisons between the fully automatic segmentations (prior to the UI, 
                           
                              k
                              =
                              0
                           
                        ), the semi-automatic segmentation (after k interaction steps, 
                           
                              k
                              =
                              1
                              −
                              3
                           
                        ) with respect to the manual annotations, for the training set cases. Table 4
                         compares the Dice scores obtained by the suggested IS method for the test BRATS dataset with the results reported in the BRATS challenge paper (Menze et al., 2015). Our results outperform the highest scored algorithms participating in the challenge (rightmost columns) of Zhao (see also Wu et al., 2014) and Menze et. al (see also  Menze et al., 2016, 2010). The ‘best combination’ BRATS results reported in the table were generated by calculating the average Dice scores for the best algorithm of each case. These scores are considered as an upper limit. The scores obtained by our algorithm are slightly inferior. For some of the cases, this was partly due to inconsistencies between our experts’ annotations and the manual segmentations provided by the BRATS challenge experts.

In this section we present a comparison of the proposed method to three commonly known UI algorithms: TurtleSeg, GrabCut and ilastik for the segmentation of CH in 3D CT scans. Five cases were tested. These cases were different than the ones used in Section 5.1. It is difficult to fully evaluate user interactive tools since important aspects such as convenience and satisfaction as subjective. Evaluation of the different methods therefore focuses on quantitative measures, which include: Dice scores with respect to independent manual segmentation; the number of interaction phases (k); the average number of interactions per phase; and the duration of the entire segmentation process. The results are shown in Table 5
                        . The comparison shows that the proposed method outperforms the ilastik, the Grabcut and the TurtleSeg in terms of segmentation accuracy (Dice scores), user workload (average number of interactions) and efficiency (the time required to complete the segmentation task to the user’s satisfaction). A visual comparison of the segmentation results for different cases (exemplified on 2D slices out of the 3D volumes) is presented in Fig. 10
                        . For fair comparison all the tools were tested by the same radiologist.


                           TurtleSeg (Hamarneh et al., 2005; Poon et al., 2007, 2008; Top et al., 2010, 2011) is a publicly available 3D segmentation tool that is based on the 2D live wire (Falcao et. al., 1998). The 3D semi-automatic segmentation process is based on seed points provided by the user for 2D live-wire segmentations on slices in any two orthogonal orientations. These 2D contours are then used to determine the live-wire seed points to be used in the third orthogonal orientation.

The ilastik is an interactive learning and segmentation toolkit that is designed for the analysis of 2D high-throughput microscopy images (Sommer et al., 2011). It is widely used for semi-automatic segmentation of biological cells. To be adapted for the segmentation of 3D medical imaging data, each of the tested brain CT volumes is sliced into a set of 2D images. Segmentation is performed in a slice-by-slice manner. At the end of the process the 2D segmentation are merged into a single volume. Using ilastik each image has been partitioned into two labels the ROI (CH) and a background (brain tissues and skull). The interaction is carried out by mouse scribbles. Each scribble assigns a label to the collection of pixels it covers. These pixels, along with their labels and corresponding set of features, are used to train a Random Forrest classifier (Breiman, 2001). Then, each of the non-marked pixels is classified based on its own set of features. As opposed to the proposed method, ilastik classifies each pixel regardless of its neighbors. It can therefore be considered as a classification (rather than segmentation) framework. We note that the set of features to be used (intensities, gradients, image coordinate, etc.) should be pre-selected by the user, a task that is usually not trivial to a non-technology oriented user. In addition, the Random Forrest technique has high computational complexity and therefore is much slower even with respect to the fully manual segmentation (68 vs. 38 minutes for a single 3D case, on the average).


                           Grabcut (Rother et al., 2004) is an interactive segmentation method based on graph-cut. It was designed for object extraction in 2D color images. Based on a user-defined bounding box around the object of interest (first form of interaction), GMM models of the color distributions of the object and the background are estimated. A Markov random field over the pixel labels is constructed, with an energy function that prefers similar labels of neighboring pixels. Segmentation can be further corrected by the user by pointing out misclassified regions by scribbles or clicks and rerunning the optimization. The Grabcut is relatively fast and accurate. Nevertheless, the implementation we used (OpenCV) works for 2D images. The clinician encountered difficulties when trying to segment small objects as the gray-level statistics were not sufficient.

In our opinion, the main advantage of the proposed framework over ilastik or GrabCut) is the fact that since in CT or MR brain images the textural properties are known in advance, possible ambiguities can be resolved only when the user-provided input originates from external, top-down considerations.

Image segmentation is necessary for measuring ROI features, such as pose, size, location, texture, etc., which may be critical for diagnosis, treatment planning and image guided therapy. User interaction is therefore essential for resolving classification ambiguities and errors due to imaging artifacts, poor contrast and noise. We proposed a novel probabilistic model for a semi-automatic segmentation of multi-modal imaging data in which the user interacts with the segmentation algorithm providing spatial information.

Establishing our method on a probabilistic model and using soft segmentation opens doors to several future directions. For example, regions of high uncertainty can be marked for the user to trigger a more effective interaction in the spirit of Prassni et al. (2010). In addition, the soft assignment of the image voxels allows the flexibility that may be needed when dealing with data of different modalities or sources; each derives a different user feedback. Moreover, it provides an elegant platform for the integration of input from multiple users.

Accurate segmentation results, with a minimal user input are obtained for the segmentation of CH in brain CT images, ventricles in degenerative mice brain MRIs and tumors in multi-modal human brain MRIs. A toolbox with a user friendly GUI was developed as a part of this research project. Our GUI was tested by expert radiologists and a neuroscientist who found it convenient and easy to use. While this feedback is subjective, to the best of our knowledge, quantitative tools to evaluate user friendliness are yet to be developed. The reader is referred to  http://youtu.be/_bIu6fHiYY0 (CH extraction in brain CT scans) and http://youtu.be/OvdU7FpKj90 (brain tumor delineation in multi-modal MRI) for live demonstrations of our user interactive segmentation toolbox.

@&#ACKNOWLEDGEMENT@&#

Itamar Kahn was supported by the Israel Science Foundation 225/11 and by the Allen and Jewel Prince Center for Neurodegenerative Disorders of the Brain.

We developed a friendly and convenient UI platform to allow feedback from radiologists and other specialists. Figs. A.11–A.13
                     
                     
                      show screen shots of the UI panel, that was designed to be minimal and easy to understand. A newer version of the UI that was developed in C++ is shown in A.14
                     . Once a specific case is selected by the user, a fully automated segmentation takes place. The user can interact with the segmentation by providing mouse clicks in regions of disagreement, by paging the coronal, sagittal and axial slices of the 3D scans. As the interaction coordinates are 3D, a click on a coronal slice (for example) would influence in all orientations. To facilitate the examination of the current segmentation, a 3D view of the segmented ROI is shown as well. In addition, in the case of multi-model data, the user can toggle between the modalities and watch each along with the contours of the current segmentation. The user can choose between providing a single click or a line of clicks. After each interaction step, which may contain as many clicks as provided by the user, the system starts a gradient descent process that takes into account the updated gray-level PDFs and the spatial contraints introduced by the user, via the mouse clicks.

@&#REFERENCES@&#

