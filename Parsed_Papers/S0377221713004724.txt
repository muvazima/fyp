@&#MAIN-TITLE@&#Adaptive and robust radiation therapy optimization for lung cancer

@&#HIGHLIGHTS@&#


               
               
                  
                     
                        
                           
                           Considers fractionated intensity-modulated radiation therapy of lung cancer under breathing motion uncertainty.


                        
                        
                           
                           Proposes a method that generalizes robust optimization and adaptive radiation therapy.


                        
                        
                           
                           Provides computational results with real data that show an improvement over the non-adaptive method.


                        
                        
                           
                           Develops theoretical results that explain the multiple phenomena observed in the computational study.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

OR in health services

Intensity-modulated radiation therapy

Adaptive radiation therapy

Robust optimization

Linear programming

@&#ABSTRACT@&#


               
               
                  A previous approach to robust intensity-modulated radiation therapy (IMRT) treatment planning for moving tumors in the lung involves solving a single planning problem before the start of treatment and using the resulting solution in all of the subsequent treatment sessions. In this paper, we develop an adaptive robust optimization approach to IMRT treatment planning for lung cancer, where information gathered in prior treatment sessions is used to update the uncertainty set and guide the reoptimization of the treatment for the next session. Such an approach allows for the estimate of the uncertain effect to improve as the treatment goes on and represents a generalization of existing robust optimization and adaptive radiation therapy methodologies. Our method is computationally tractable, as it involves solving a sequence of linear optimization problems. We present computational results for a lung cancer patient case and show that using our adaptive robust method, it is possible to attain an improvement over the traditional robust approach in both tumor coverage and organ sparing simultaneously. We also prove that under certain conditions our adaptive robust method is asymptotically optimal, which provides insight into the performance observed in our computational study. The essence of our method – solving a sequence of single-stage robust optimization problems, with the uncertainty set updated each time – can potentially be applied to other problems that involve multi-stage decisions to be made under uncertainty.
               
            

@&#INTRODUCTION@&#

Lung cancer is the leading cause of death due to cancer in North America, killing an estimated 180,000 people in 2010 (American Cancer Society, 2010; Canadian Cancer Society’s Steering Committee, 2010) and accounting for over 25% of all cancer deaths. Lung cancer is often treated using radiation therapy (Toschi, Cappuzzo, & Janne, 2007). Of the different types of radiation therapy, one of the most commonly used in practice for treating cancer in general is intensity-modulated radiation therapy (IMRT) (Mell, Mehrotra, & Mundt, 2005). In an IMRT treatment, the patient is irradiated from multiple beams, each of which is decomposed into a large number of small beamlets. The beamlet intensities can be controlled through the use of a multileaf collimator (MLC) that moves metal leaves in and out of the beam field in order to block certain parts of the beam. By appropriately setting the beamlet intensities, the volume that is irradiated can be made to closely conform to the shape of the target. The basic problem in planning an IMRT treatment is to determine how the beamlet intensities or weights should be set so that the target receives an adequate dose while the healthy tissue receives a minimal dose. This is known as the beamlet weight optimization problem or the fluence map optimization problem. Since the inception of IMRT, much research has focused on modeling and solving this problem as a mathematical program (see Romeijn & Dempsey, 2008 for a comprehensive overview).

In practice, the beamlet weight optimization problem is complicated by the presence of uncertainties, such as those arising from errors in beam positioning and patient placement, internal organ motion during treatment, and changes in organ position between treatment sessions. All of these factors affect the relative position of the tumor with respect to the beams, which in turn affects how much dose is deposited in the tumor and the healthy tissue. For tumors in the lung, the most significant uncertainty arises from breathing motion. During treatment, the patient is constantly breathing, and the tumor moves with the expansion and contraction of the patient’s lungs. Furthermore, the patient’s breathing pattern during treatment is not known exactly beforehand and can vary from day to day. If a treatment is planned with a specific breathing pattern in mind but a different pattern is realized during treatment, the tumor may end up being underdosed and the quality of the treatment may thus be greatly compromised (Lujan, Balter, & Ten Haken, 2003; Sheng et al., 2006). At the same time, if the treatment is designed to deliver the prescription dose to the tumor under any breathing pattern, regardless of how unlikely some of those patterns may be, then an unnecessarily high amount of damage will be done to the healthy tissue. There exist approaches that aim to mitigate the effect of uncertainty by only activating the beam when the patient is in a certain phase of the breathing cycle (Ohara et al., 1989), but these approaches have the disadvantage of prolonging the treatment time, leading to reduced throughput in the treatment center.

One methodology that allows for tumor coverage under uncertainty to be balanced with healthy tissue sparing, without extending the treatment time, is robust optimization. There are many robust optimization approaches to IMRT treatment planning. In this paper, we build on the method developed in Bortfeld, Chan, Trofimov, and Tsitsiklis (2008) and Chan, Bortfeld, and Tsitsiklis (2006), which is specifically designed to manage the instantaneous breathing motion uncertainty that may be realized during treatment sessions. Although robust optimization has been shown to be a valuable methodology for managing uncertainty due to breathing motion, it can be further improved by leveraging the fact that treatments are typically fractionated. Fractionation refers to the practice of dividing up the prescription dose and delivering small amounts in daily treatment sessions over multiple weeks, in order to exploit the more capable repair mechanism that healthy tissue has over cancerous tissue (Thames & Hendry, 1987).

To date, the typical approach to fractionated treatment planning and delivery has been to determine what the beamlet intensities should be to deliver a certain prescription dose, scale them by 1/n where n is the number of fractions, and use the resulting intensities in every treatment fraction. This, however, does not take advantage of the dynamics that fractionation injects into IMRT treatment planning and the underlying uncertainty. For example, it may be the case that the pre-treatment estimates of the patient’s breathing pattern are erroneous, and the breathing patterns that are planned for differ from those realized over the treatment. In this case, the wrong beamlet intensities would be used for every fraction, without the possibility of correcting them. On the other hand, the beamlet intensities may be optimized in such a way that the prescription dose is delivered under a very large range of breathing patterns, when in actuality the patient’s breathing pattern does not vary significantly from fraction to fraction. In this case, there would be no way to correct the conservatism of the treatment, and the patient’s healthy tissue will incur more damage than necessary. Another example comes from the possibility that the patient’s breathing pattern may change over the course of treatment as the patient becomes more comfortable in the treatment room or as the evolution of the underlying disease affects the patient’s respiratory ability. As a result, latter treatment sessions may deliver insufficient dose to the tumor and more dose than anticipated to healthy tissue. These issues motivate the incorporation of adaptive re-optimization into robust optimization models.

To deal with fractionation in more general IMRT treatment planning contexts, much research has been conducted in the medical physics community in what is known as off-line adaptive radiation therapy (ART). In off-line ART, after the current fraction is delivered, new information, typically obtained from imaging devices, is fed back into the planning process to design the beamlet intensities of the next fraction (Yan, Vicini, Wong, & Martinez, 1997a). To date, off-line ART and robust optimization have largely been considered independently of each other.

In this paper, we propose a novel method that generalizes the framework of off-line adaptive radiation therapy and the robust optimization methodology of Bortfeld et al. (2008) and Chan et al. (2006) to treat lung cancer in the presence of breathing motion uncertainty. Our method is based on adaptively updating an uncertainty set that models the breathing motion uncertainty and then solving a robust optimization problem with the new uncertainty set prior to each fraction. As a result, our method is able to combat both the instantaneous uncertainty realized in each fraction as well as changes in this uncertainty that occur from day to day. The clinical value of this method is that it has the potential to improve upon the non-adaptive robust optimization method in both tumor coverage and healthy tissue sparing. This is significant because patient survival rates have been shown to improve when the tumor dose is increased (see Perez, Bauer, Edelstein, Gillespie, & Birch, 1986). Unfortunately, dose escalation to the tumor is limited by the radiation tolerance of healthy tissue, particularly the lungs (Cox et al., 1990). If it is possible to increase tumor dose and reduce healthy tissue dose from the levels achieved by non-adaptive robust optimization, further dose escalation will become viable, and improvements in patient survival rate may be realized.

Our specific contributions in this paper are as follows:
                        
                           1.
                           We develop a method that combines robust optimization with adaptive radiation therapy and suitably generalizes both frameworks. This method has modest computational requirements and can be easily generalized to other types of cancer and other types of uncertainty.

Using real patient data, we demonstrate computationally that this method generates treatments that improve upon treatments obtained by non-adaptive robust methods in both tumor coverage and lung dose. We show that the quality of the final treatment does not vary significantly with the choice of initial uncertainty set. We also show that the achieved performance is comparable to that of two “prescient” solutions, which correctly anticipate the patient’s breathing over the entire treatment.

We prove an asymptotic optimality result: if the patient breathing pattern converges over the treatment course, then the dose distribution produced by our adaptive robust method converges to an “ideal” set of dose distributions that exhibit no tumor underdose or overdose and low healthy tissue dose. We use this result to explain multiple phenomena observed in our computational study.

The rest of the paper is organized as follows. In Section 2, we briefly review some of the relevant literature in robust optimization and off-line ART. In Section 3, we provide an overview of the non-adaptive robust optimization method on which this paper builds. In Section 4, we provide a detailed description of the proposed adaptive robust method. In Section 5, we provide results from our computational study with clinical lung cancer patient data. In Section 6, we conduct a theoretical analysis of the adaptive robust method. Finally, in Section 7, we provide some conclusions and directions for future work.

@&#LITERATURE REVIEW@&#

Robust optimization has been extensively developed in the OR community (see Ben-Tal, El Ghaoui, & Nemirovski, 2009 and Bertsimas, Brown, & Caramanis, 2011), and has received increasing focus in the last decade as a methodology for IMRT treatment planning under uncertainty. In Chu, Zinchenko, Henderson, and Sharpe (2005), tumor position uncertainty due to interfraction motion (organ position changes that occur between treatment sessions) and setup error was modeled using an ellipsoidal uncertainty set and the authors showed that the resulting robust solution achieves the same level of tumor coverage as a clinical margin solution but with less healthy tissue dose. In Ólafsson and Wright (2006), the uncertainty due to dose calculation error and interfraction organ motion was also modeled using an ellipsoidal uncertainty set, and the authors showed for a nasopharyngeal case that a robust solution achieves better tumor coverage than the nominal solution (one which assumes a dose matrix known with certainty) and leads to better organ sparing than the clinically prescribed margin solution. In Chan et al. (2006) and Bortfeld et al. (2008), uncertainty due to intrafraction breathing motion was modeled using a polyhedral uncertainty set, and it was shown that the robust solution provides improved tumor coverage over the nominal solution, while providing tumor coverage comparable to the margin solution at reduced healthy tissue dose. All of the robust IMRT optimization methods described above are non-adaptive.

With regard to off-line ART, a variety of procedures have been proposed for how to treat a patient based on information obtained in the most recent fraction. Many studies have proposed using daily computed tomography (CT) images as a form of feedback. For example, Mohan et al. (2005), Lu et al. (2006), Wu, Liang, and Yan (2006) and Wu et al. (2008) all studied schemes where daily CT images are used to periodically assess the treatment plan for errors in dose delivery due to organ deformation and intrafraction motion (organ motion that occurs during a treatment session), and to aid either the re-adjustment or complete re-optimization of the treatment for subsequent fractions. Other imaging methods have also been proposed for off-line ART. For instance, de la Zerda, Armbruster, and Xing (2007) proposed algorithms for generating new treatment plans from fraction to fraction in response to changes in the patient geometry detected from cone beam CT (CBCT) images, as well as to the cumulative delivered dose. Another example is Yan et al. (1998), who tested an ART method where the daily setup error is measured using portal imaging and is used to correct the treatment if the error becomes sufficiently large.

Some ART studies have also incorporated probabilistic models of uncertainty into their proposed planning methods. Yan et al. (1997a) studied an ART method where the daily treatment target and beam placement variation are measured and used to modify the treatment dose and field margin in each fraction under the assumption that the error is normally distributed. Löf, Lind, and Brahme (1998) studied an ART scheme where the daily setup position is measured in every fraction, but assumed that the probabilistic dynamics of the internal organ motion are known beforehand. Rehbinder, Forsgren, and Löf (2004) applied linear quadratic control to ART planning and showed that using this form of adaptation removes the need for a margin, allowing for safer dose escalation. The problem of ART can also be seen as a problem of sequential decision making under uncertainty and as such, several studies have considered dynamic programming techniques. For example, Sir, Epelman, and Pollock (2012) showed that an adaptive open-loop feedback control (OLFC) policy achieves better performance than a non-adaptive OLFC policy. Ferris and Voelker (2004) and Deng and Ferris (2008) applied neuro-dynamic programming (NDP) to ART and similarly showed that their NDP policy offers an improvement over a constant, non-adaptive policy.

The limitation of the majority of algorithms for off-line ART is in how they have approached uncertainty. Many studies have not explicitly included uncertain effects into their treatment planning process. Of the studies that have, most have assumed that realizations of the uncertain effect from fraction to fraction are independent and identically distributed – although this may be appropriate for setup error and patient positioning, it may not be suitable for other types of uncertainty. The most significant assumption present in studies that have incorporated probabilistic models of uncertainty is that the underlying probability distribution of the uncertain effect is known precisely before the start of the treatment. In actuality, the distribution which underlies an uncertain effect for a particular patient in a particular treatment is never known precisely, and as already discussed, the quality of a treatment designed with a specific probability distribution in mind can deteriorate significantly if a different distribution is realized.

The fundamental difference between the approach proposed in this paper and the majority of prior ART work lies in the assumptions that are made about the uncertainty. In our approach, we do not assume that the nature of the uncertainty is known precisely a priori nor that it needs to stay constant from fraction to fraction. There has been some prior research into using previous measurements of uncertainty to update an estimate of the uncertain effect, using such methods as Kalman filtering (Yan et al., 1997b; Keller, Ritter, & Mackie, 2003) and Bayesian updating (Lam, Haken, Litzenberg, Balter, & Pollock, 2005; Sir, 2007). Very few studies have considered these methods with treatment re-planning (Yan et al., 1997b & Sir, 2007 are exceptions) and these studies assume that the uncertain effect follows a particular distribution. No studies have combined such estimation methods with the kind of robust optimization approach we consider.

In this section, we review the robust optimization approach of Chan et al. (2006) and Bortfeld et al. (2008). In their approach, the planner decides on an uncertainty set before treatment and solves the robust optimization problem corresponding to that uncertainty set. The optimal solution of the robust problem is a vector that specifies the intensity of each beamlet in the ensemble of beams to be used for treatment. These optimized beamlet intensities are robust to the uncertain effect whenever it takes on values from the uncertainty set: whenever the uncertain effect realizes a value inside the uncertainty set while the patient is being irradiated according to the optimized intensities, the dose to every part of the tumor will be within the prescribed bounds. We will refer to this approach as the static robust optimization approach, as the beamlet intensity vector is fixed and does not change over the course of the treatment (in each fraction, 1/nth of the intensity vector is delivered, where n is the number of fractions). The patient’s breathing motion is modeled using a probability mass function (PMF). The breathing motion PMF for a patient in a particular fraction specifies the proportion of time the patient spends in each of a finite number of breathing motion states during that fraction. Each breathing motion state corresponds to a particular displacement or snapshot of the patient geometry during the patient’s respiratory cycle. The uncertainty set is then a set of breathing motion PMFs that could be realized during treatment. We note here that in the method of Bortfeld et al. (2008), the set of breathing motion states is determined from pre-treatment breathing-correlated 4D computed tomography (4D-CT) images. This assumes that the amplitude of the tumor motion observed in these pre-treatment images represents the full extent of the tumor motion, and that the amplitude of the motion that will be observed during the ensuing treatment sessions will not exceed these limits. This potential issue can be circumvented by having the patient take deep breaths during the pre-treatment 4D-CT imaging session, allowing the treatment planner to more accurately construct the set of breathing motion states.

We now define the static robust IMRT optimization problem. Let 
                        
                           B
                        
                      be the set of beamlets and let w
                     
                        b
                      denote the intensity of beamlet 
                        
                           b
                           ∈
                           B
                        
                     ; the w
                     
                        b
                      variables are the decision variables of the robust optimization problem. The patient geometry (the healthy organs and tumor tissue) is divided into three dimensional voxels, or volume elements. Let 
                        
                           V
                        
                      denote the set of all voxels and 
                        
                           T
                        
                      denote the set of tumor voxels. Let X denote the finite set of breathing motion states. Each breathing motion state is associated with a particular displacement of the patient geometry (the voxels), so to each beamlet 
                        
                           b
                           ∈
                           B
                        
                     , breathing motion state x
                     ∈
                     X and voxel 
                        
                           v
                           ∈
                           V
                        
                     , we associate a dose deposition coefficient Δ
                        v,x,b
                     . This coefficient specifies the amount of dose deposited in voxel v when the patient is in breathing motion state x and the beamlet b is at unit intensity. Let p(x) be the probability of the patient being in motion state x at any given time during a treatment session. The dose that is delivered to voxel v is then given by
                        
                           
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       x
                                       ∈
                                       X
                                    
                                 
                              
                              
                                 
                                    
                                       ∑
                                    
                                    
                                       b
                                       ∈
                                       B
                                    
                                 
                              
                              
                                 
                                    Δ
                                 
                                 
                                    v
                                    ,
                                    x
                                    ,
                                    b
                                 
                              
                              p
                              (
                              x
                              )
                              
                                 
                                    w
                                 
                                 
                                    b
                                 
                              
                              ,
                           
                        
                     which is the sum of the doses to voxel v that would be delivered under each breathing motion state weighted by the corresponding proportions of time spent in those states. Due to the use of beamlet intensities, this model does not account for the interplay effect between the motion of the MLC leaves and the tumor motion (see, for example, Yu, Jaffray, & Wong (1998) and Bortfeld, Jokivarsi, Goitein, Kung, & Jiang (2002)); the impact of such an effect, however, is small in practice (Bortfeld, Jiang, & Rietzel, 2004). For each tumor voxel 
                        
                           v
                           ∈
                           T
                        
                     , let θ
                     
                        v
                      be the prescribed minimum dose and let γθ
                     
                        v
                      be the prescribed maximum dose, where γ
                     ⩾1.

Let 
                        
                           P
                        
                      be the set of all PMFs on the finite set X, defined as
                        
                           
                              P
                              =
                              
                                 
                                    
                                       p
                                       ∈
                                       
                                          
                                             R
                                          
                                          
                                             |
                                             X
                                             |
                                          
                                       
                                       
                                       
                                          
                                             
                                                
                                                For
                                                
                                                each
                                                
                                                x
                                                ∈
                                                X
                                                ,
                                                
                                                p
                                                (
                                                x
                                                )
                                                ⩾
                                                0
                                                ;
                                                
                                                
                                                   
                                                      
                                                         ∑
                                                      
                                                      
                                                         x
                                                         ∈
                                                         X
                                                      
                                                   
                                                
                                                p
                                                (
                                                x
                                                )
                                                =
                                                1
                                             
                                          
                                       
                                    
                                 
                              
                              .
                           
                        
                     The set 
                        
                           P
                        
                      defines the (∣X∣−1)-dimensional unit simplex. Let 
                        
                           P
                           ⊆
                           P
                        
                      be the uncertainty set, which is a bounded polyhedron defined by a lower bound vector ℓ and an upper bound vector u:
                        
                           
                              P
                              =
                              
                                 
                                    
                                       p
                                       ∈
                                       P
                                       |
                                       
                                       For
                                       
                                       each
                                       
                                       x
                                       ∈
                                       X
                                       ,
                                       
                                       ℓ
                                       (
                                       x
                                       )
                                       ⩽
                                       p
                                       (
                                       x
                                       )
                                       ⩽
                                       u
                                       (
                                       x
                                       )
                                    
                                 
                              
                              .
                           
                        
                     
                  

With these definitions, the static robust problem from Bortfeld et al. (2008) is
                        
                           (1)
                           
                              
                                 
                                    
                                       
                                          minimize
                                       
                                    
                                    
                                       
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   v
                                                   ∈
                                                   V
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   x
                                                   ∈
                                                   X
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   b
                                                   ∈
                                                   B
                                                
                                             
                                          
                                          
                                             
                                                Δ
                                             
                                             
                                                v
                                                ,
                                                x
                                                ,
                                                b
                                             
                                          
                                          
                                             
                                                p
                                             
                                             
                                                ¯
                                             
                                          
                                          (
                                          x
                                          )
                                          
                                             
                                                w
                                             
                                             
                                                b
                                             
                                          
                                       
                                    
                                 
                                 
                                    
                                       
                                          subject
                                          
                                          to
                                       
                                    
                                    
                                       
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   x
                                                   ∈
                                                   X
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   b
                                                   ∈
                                                   B
                                                
                                             
                                          
                                          
                                             
                                                Δ
                                             
                                             
                                                v
                                                ,
                                                x
                                                ,
                                                b
                                             
                                          
                                          p
                                          (
                                          x
                                          )
                                          
                                             
                                                w
                                             
                                             
                                                b
                                             
                                          
                                          ⩾
                                          
                                             
                                                θ
                                             
                                             
                                                v
                                             
                                          
                                          ,
                                          
                                          ∀
                                          v
                                          ∈
                                          T
                                          ,
                                          
                                          p
                                          ∈
                                          P
                                          ,
                                       
                                    
                                 
                                 
                                    
                                    
                                       
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   x
                                                   ∈
                                                   X
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   b
                                                   ∈
                                                   B
                                                
                                             
                                          
                                          
                                             
                                                Δ
                                             
                                             
                                                v
                                                ,
                                                x
                                                ,
                                                b
                                             
                                          
                                          p
                                          (
                                          x
                                          )
                                          
                                             
                                                w
                                             
                                             
                                                b
                                             
                                          
                                          ⩽
                                          γ
                                          
                                             
                                                θ
                                             
                                             
                                                v
                                             
                                          
                                          ,
                                          
                                          ∀
                                          v
                                          ∈
                                          T
                                          ,
                                          
                                          p
                                          ∈
                                          P
                                          ,
                                       
                                    
                                 
                                 
                                    
                                    
                                       
                                          
                                          
                                             
                                                w
                                             
                                             
                                                b
                                             
                                          
                                          ⩾
                                          0
                                          ,
                                          
                                          ∀
                                          b
                                          ∈
                                          B
                                          ,
                                       
                                    
                                 
                              
                           
                        
                     where 
                        
                           
                              
                                 p
                              
                              
                                 ¯
                              
                           
                        
                      is some nominal PMF chosen by the treatment planner before the start of treatment as approximately representative of the patient’s overall breathing pattern. The optimal solution of (1) is a beamlet intensity vector w
                     ∗ that meets minimum and maximum tumor dose requirements no matter which breathing motion PMF p
                     ∈
                     P is realized, while ensuring the lowest possible total dose to the patient under the nominal PMF. In the case that p
                     ∉
                     P, it was shown empirically in Bortfeld et al. (2008) that w
                     ∗ remains feasible with high probability. Due to the linearity of this model and the use of polyhedral uncertainty sets, this model is capable of accommodating robust versions of many other types of clinically relevant constraints, such as partial volume constraints based on conditional-value-at-risk (see Romeijn, Ahuja, Dempsey, & Kumar, 2006) or constraints involving αEUD (Thieke, Bortfeld, & Küfer, 2002), which is a linear approximation to the popular equivalent uniform dose (EUD) metric. Our goal in this paper is to elucidate the potential benefits of a framework that combines adaptation and robustness, not to design clinic-ready solutions. We therefore consider the stylized model above, which only enforces lower and upper dose bounds on the tumor.

There are two special cases of (1) that will be referred to later. The first is the case when P consists of a single PMF. The resulting problem is called the nominal problem; when P
                     ={p}, we refer to problem (1) as the nominal problem with respect to 
                     p. The solution of the nominal problem is the least conservative treatment we can deliver, as we are assuming that the PMF that will be realized during treatment will be the exact PMF that we are guarding against. The second is the case when P consists of all possible PMFs on X, that is, 
                        
                           P
                           =
                           P
                        
                     ; this problem is called the margin problem. The solution of the margin problem is the most conservative treatment that we can deliver, because we assume that any PMF is possible. These two types of formulations represent two extremes of a continuum of robustness (Chan et al., 2006), with the nominal problem being the least robust and the margin problem being the most robust. The robust problem with a general uncertainty set (which is neither a singleton nor 
                        
                           P
                        
                     ) is somewhere in between. With increasing levels of robustness, characterized by larger uncertainty sets, the level of tumor coverage increases, but at the cost of increased dose to healthy tissue.

In the adaptive robust approach that we propose, we allow the beamlet intensities to be re-optimized from fraction to fraction in the following way. On a given day, the patient is irradiated with a beamlet intensity vector obtained by solving (1) with the current uncertainty set as input. During or immediately after the fraction is delivered, the patient’s breathing motion PMF is measured. This measurement, together with the current uncertainty set, is used to generate a new uncertainty set. The robust problem is then solved with this new uncertainty set, leading to a new beamlet intensity vector to be used on the next day. This process is repeated for each fraction until the end of the treatment. This procedure is presented as Algorithm 1.

Although in theory one could measure the patient’s PMF before the delivery of a fraction and plan the fraction using the resulting PMF, this approach would constrain the amount of time that would be available for treatment planning and quality assurance, as the patient would have to wait between measurement and fraction delivery. By measuring the patient’s PMF during or after the delivery of the fraction, this temporal constraint can be avoided by having treatment planning and quality assurance done offline between treatment fractions, which would be more desirable from an operational point of view. Furthermore, we will show in Section 6 that these two methods have the same asymptotic performance.
                        Algorithm 1
                        Adaptive robust optimization method 
                              
                                 
                                    
                                    
                                       
                                          
                                             Require: Total number of fractions n, initial uncertainty set P
                                             1
                                          
                                       
                                       
                                          1: Initialize i
                                             =1
                                       
                                       
                                          2: Solve problem (1) with P
                                             =
                                             P
                                             1 to obtain a beamlet intensity vector w
                                             1
                                          
                                       
                                       
                                          3: Deliver w
                                             1/n to the patient
                                       
                                       
                                          4: while 
                                             i
                                             ⩽
                                             n
                                             −1 do
                                          
                                       
                                       
                                          5:Measure the patient’s breathing motion and construct the PMF p
                                             
                                                i
                                             
                                          
                                       
                                       
                                          6:Generate the new uncertainty set P
                                             
                                                i+1 from P
                                             
                                                i
                                             , p
                                             
                                                i
                                             
                                          
                                       
                                       
                                          7:Solve problem (1) with P
                                             =
                                             P
                                             
                                                i+1 to obtain a new beamlet intensity vector w
                                             
                                                i+1
                                          
                                       
                                       
                                          8:Deliver w
                                             
                                                i+1/n to the patient
                                       
                                       
                                          9:Set i
                                             =
                                             i
                                             +1
                                       
                                       
                                          10: end while
                                          
                                       
                                    
                                 
                              
                           
                        

One major step in the adaptive robust approach specified as Algorithm 1 is the generation of the new uncertainty set from the old uncertainty set and the most recent measurement of the patient’s breathing motion PMF. We refer to any procedure that can be used to perform this step as an uncertainty set update algorithm. In our computational study we consider two such update algorithms, exponential smoothing and running average, though our theoretical analysis generalizes to a larger class of update algorithms.

Recall that we define an uncertainty set P in terms of a lower bound vector ℓ and an upper bound vector u. Therefore, the uncertainty set for fraction i, denoted P
                        
                           i
                        , is defined by lower and upper bound vectors ℓ
                        
                           i
                         and u
                        
                           i
                        , respectively. The update algorithms we present will determine lower and upper bound vectors ℓ
                        
                           i+1, u
                        
                           i+1 from the most recent vectors ℓ
                        
                           i
                        , u
                        
                           i
                         and the most recent PMF p
                        
                           i
                        .

The exponential smoothing update algorithm generates a new uncertainty set by taking a convex combination of the most recent lower and upper bound vectors with the most recent PMF. Specifically, given ℓ
                        
                           i
                        , u
                        
                           i
                         and p
                        
                           i
                         for day i, ℓ
                        
                           i+1 and u
                        
                           i+1 are defined as
                           
                              (2)
                              
                                 
                                    
                                       ℓ
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 (
                                 x
                                 )
                                 =
                                 (
                                 1
                                 -
                                 α
                                 )
                                 
                                    
                                       ℓ
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 +
                                 α
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 ,
                              
                           
                        
                        
                           
                              (3)
                              
                                 
                                    
                                       u
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 (
                                 x
                                 )
                                 =
                                 (
                                 1
                                 -
                                 α
                                 )
                                 
                                    
                                       u
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 +
                                 α
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 ,
                              
                           
                        for each x
                        ∈
                        X, where α
                        ∈[0,1].

The running average update algorithm generates a new uncertainty set by averaging the PMFs that have been observed so far, together with the very first lower and upper bound vectors. Specifically, given ℓ
                        1, u
                        1 and p
                        1, …, p
                        
                           i
                         on day i, ℓ
                        
                           i+1 and u
                        
                           i+1 are defined as
                           
                              
                                 
                                    
                                       
                                       
                                          
                                             
                                                
                                                   ℓ
                                                
                                                
                                                   i
                                                   +
                                                   1
                                                
                                             
                                             (
                                             x
                                             )
                                             =
                                             
                                                
                                                   1
                                                
                                                
                                                   i
                                                   +
                                                   1
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            ℓ
                                                         
                                                         
                                                            1
                                                         
                                                      
                                                      (
                                                      x
                                                      )
                                                      +
                                                      
                                                         
                                                            
                                                               ∑
                                                            
                                                            
                                                               j
                                                               =
                                                               1
                                                            
                                                            
                                                               i
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            p
                                                         
                                                         
                                                            j
                                                         
                                                      
                                                      (
                                                      x
                                                      )
                                                   
                                                
                                             
                                             ,
                                          
                                       
                                    
                                    
                                       
                                       
                                          
                                             
                                                
                                                   u
                                                
                                                
                                                   i
                                                   +
                                                   1
                                                
                                             
                                             (
                                             x
                                             )
                                             =
                                             
                                                
                                                   1
                                                
                                                
                                                   i
                                                   +
                                                   1
                                                
                                             
                                             
                                                
                                                   
                                                      
                                                         
                                                            u
                                                         
                                                         
                                                            1
                                                         
                                                      
                                                      (
                                                      x
                                                      )
                                                      +
                                                      
                                                         
                                                            
                                                               ∑
                                                            
                                                            
                                                               j
                                                               =
                                                               1
                                                            
                                                            
                                                               i
                                                            
                                                         
                                                      
                                                      
                                                         
                                                            p
                                                         
                                                         
                                                            j
                                                         
                                                      
                                                      (
                                                      x
                                                      )
                                                   
                                                
                                             
                                             .
                                          
                                       
                                    
                                 
                              
                           
                        for each x
                        ∈
                        X. These expressions can be rewritten as functions of only ℓ
                           i
                        (x), u
                        
                           i
                        (x) and p
                        
                           i
                        (x):
                           
                              (4)
                              
                                 
                                    
                                       ℓ
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 (
                                 x
                                 )
                                 =
                                 
                                    
                                       i
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 
                                    
                                       ℓ
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 +
                                 
                                    
                                       1
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 ,
                              
                           
                        
                        
                           
                              (5)
                              
                                 
                                    
                                       u
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 (
                                 x
                                 )
                                 =
                                 
                                    
                                       i
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 
                                    
                                       u
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 +
                                 
                                    
                                       1
                                    
                                    
                                       i
                                       +
                                       1
                                    
                                 
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 .
                              
                           
                        
                     

Because the update algorithms are myopic and are not guaranteed to correctly anticipate the patient’s breathing motion PMF in every fraction, it is important to be able to measure the loss of optimality with respect to a “prescient” solution – one that would be generated if we knew p
                        1, …, p
                        
                           n
                         ahead of time.

We consider two kinds of prescient solutions. The first type of prescient solution that we define is the daily prescient solution. This solution is obtained by setting each w
                        
                           i
                         to the solution of problem (1) with P
                        =
                        P
                        
                           i
                        
                        ={p
                        
                           i
                        }. It is clear that using this solution, the dose to each tumor voxel v is between θ
                        
                           v
                        /n and γθ
                        
                           v
                        /n in each fraction, which ensures that the cumulative dose to every tumor voxel v is within the prescribed bounds θ
                        
                           v
                         and γθ
                        
                           v
                        . Furthermore, because each w
                        
                           i
                         is obtained from a nominal problem, the overall dose delivered to the patient should be low compared to other treatments that also deliver the minimum required dose to every tumor voxel.

The second type of prescient solution that we define is the average prescient solution. This solution is obtained by solving the nominal problem with P
                        ={p
                        avg}, where 
                           
                              
                                 
                                    p
                                 
                                 
                                    avg
                                 
                              
                              =
                              1
                              /
                              n
                              ·
                              
                                 
                                    ∑
                                 
                                 
                                    i
                                    =
                                    1
                                 
                                 
                                    n
                                 
                              
                              
                                 
                                    p
                                 
                                 
                                    i
                                 
                              
                           
                         and setting each w
                        
                           i
                         to the corresponding optimal solution w of this problem. It can be easily verified that under this solution, the final dose to every tumor voxel is within the prescribed bounds for that voxel. Furthermore, because the intensity vector of every fraction is obtained from a nominal problem, the overall dose delivered to the patient should be low compared to other treatments that also deliver the minimum required dose to every tumor voxel. While each tumor voxel 
                           
                              v
                              ∈
                              T
                           
                         is not guaranteed to receive θ
                        
                           v
                        /n in each fraction, the fact that w
                        
                           i
                        
                        =
                        w
                        
                           j
                         for any two fractions i and j ensures that the dose delivered by this solution in any fraction cannot be too low.

@&#BACKGROUND@&#

In order to compare our results with previous static robust optimization results, the patient geometry and beam geometry used in this paper were exactly the same as in Bortfeld et al. (2008). The patient geometry consisted of 110,275 voxels, of which 5495 were tumor voxels, and each voxel was of size 2.93×2.5×2.93mm. The set of tumor voxels for this patient case corresponded to the clinical target volume (CTV). The robust problem solved in each fraction of the adaptive method had 122,515 variables and 65,940 constraints. The parameter γ was set to 1.1, while the minimum dose θ
                        
                           v
                         was set to 72gray for every tumor voxel v. The set X consisted of five motion states. The nominal PMF used in the objective function was the same nominal PMF used previously. The adaptive robust and the static robust methods were tested using two different PMF sequences derived from clinical lung cancer patient data obtained at Massachusetts General Hospital; details on these PMF sequences can be found in Section A of the Online Supplement.

The two PMF sequences consisted of the first 30 PMFs from the two experiments, respectively, used in Bortfeld et al. (2008). This number of PMFs was chosen to simulate a realistic 6-week, Monday-to-Friday treatment course. In the discussion that follows, we will focus on the first PMF sequence, as the results obtained from the second PMF sequence were qualitatively very similar; for completeness, results for the second PMF sequence are provided in Section B of the Online Supplement. For the adaptive robust method, we tested the exponential smoothing update algorithm with α equal to 0.1, 0.5, 0.9 and 1, and the running average update algorithm. The specific values of α for the exponential smoothing method were chosen to demonstrate the performance of the approach at varying speeds of adaptation (as α increases, the uncertainty set is adjusted more rapidly to follow the realized PMFs). Three different initial uncertainty sets were used for the adaptive and static robust methods. The first type of uncertainty set was a nominal uncertainty set, with ℓ and u both equal to the nominal PMF. The second uncertainty set was the margin uncertainty set (
                           
                              P
                              =
                              P
                           
                        , the entire unit simplex)–for this patient case, the margin uncertainty set treatment corresponds to treating the internal target volume (ITV), which is the volume obtained by taking the union of the tumor volume at all of the different phases of the breathing cycle. The third uncertainty set was a robust (intermediately-sized) uncertainty set, which was neither a singleton nor the whole space of PMFs 
                           
                              P
                           
                        ; for each PMF sequence we used the corresponding robust uncertainty set from Bortfeld et al. (2008). In addition to the adaptive and static robust methods, both prescient solutions were calculated for each of the two PMF sequences.

The experiments were performed on a Dell workstation with a quad-core Intel Xeon 2.67gigahertz processor and 6gigabytes of memory. All of the steps of the adaptive robust method – with the exception of the step where the robust problem is solved to obtain w
                        
                           i+1 – were implemented in MATLAB (The MathWorks, Inc., Natick, Massachusetts). The robust problem in each fraction was solved using CPLEX 12.1 (IBM Corp., Armonk, NY) via AMPL (AMPL Optimization LLC, Albuquerque, NM) and took no more than 20minutes to solve in the majority of cases using CPLEX 12.1’s barrier method.

After the adaptive and static robust methods were executed with each of the PMF sequences described above, the resulting treatments were evaluated by calculating the final dose distribution. The final dose distribution is a vector 
                           
                              d
                              ∈
                              
                                 
                                    R
                                 
                                 
                                    |
                                    V
                                    |
                                 
                              
                           
                         of doses delivered to the voxels in the patient geometry, defined component-wise as
                           
                              
                                 
                                    
                                       d
                                    
                                    
                                       v
                                    
                                 
                                 =
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          x
                                          ∈
                                          X
                                       
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          b
                                          ∈
                                          B
                                       
                                    
                                 
                                 
                                    
                                       Δ
                                    
                                    
                                       v
                                       ,
                                       x
                                       ,
                                       b
                                    
                                 
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 (
                                 x
                                 )
                                 
                                    
                                       
                                          
                                             w
                                          
                                          
                                             b
                                          
                                          
                                             i
                                          
                                       
                                    
                                    
                                       n
                                    
                                 
                                 .
                              
                           
                        From the final dose distribution, we calculated three key statistics: the minimum tumor dose, 
                           
                              
                                 
                                    d
                                 
                                 
                                    T
                                 
                                 
                                    min
                                 
                              
                              =
                              
                                 
                                    min
                                 
                                 
                                    v
                                    ∈
                                    T
                                 
                              
                              
                                 
                                    d
                                 
                                 
                                    v
                                 
                              
                           
                        ; the mean left lung dose, 
                           
                              
                                 
                                    d
                                 
                                 
                                    L
                                 
                                 
                                    mean
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    v
                                    ∈
                                    L
                                 
                              
                              
                                 
                                    d
                                 
                                 
                                    v
                                 
                              
                              /
                              |
                              L
                              |
                           
                        , where 
                           
                              L
                           
                         is the set of voxels belonging to the left lung; and the mean normal tissue dose, 
                           
                              
                                 
                                    d
                                 
                                 
                                    N
                                 
                                 
                                    mean
                                 
                              
                              =
                              
                                 
                                    ∑
                                 
                                 
                                    v
                                    ∈
                                    N
                                 
                              
                              
                                 
                                    d
                                 
                                 
                                    v
                                 
                              
                              /
                              |
                              N
                              |
                           
                        , where 
                           
                              N
                           
                         is the set of normal tissue (non-tumor) voxels. In addition to these statistics, we also compute two other metrics. The mean left lung dose-scaled (MLLD-scaled) tumor dose of a treatment is the minimum dose to the tumor when the dose to the patient is scaled so that the mean left lung dose of the treatment matches the mean left lung dose of the static margin treatment. Similarly, the left lung V20-scaled (LLV20-scaled) tumor dose of a treatment is the minimum dose to the tumor when the dose to the patient is scaled so that the lung V20 value (the volume of the lung receiving 20gray or more) of the treatment matches the lung V20 value of the static margin treatment.

@&#RESULTS@&#


                        Table 1
                         displays dose statistics for the first PMF sequence. In Figs. 1 and 2
                        
                        , we plot the minimum tumor dose as a percentage of 72gray versus the mean left lung dose as a percentage of the static margin solution for each method applied to the first PMF sequence. Fig. 1 shows all of the treatments, while Fig. 2 zooms in on the adaptive and prescient treatments. On these plots, points obtained by the same method (static, exponential smoothing with parameter α or running average) from different initial uncertainty sets are joined together by straight lines to illustrate the approximate Pareto frontiers generated by the corresponding method.

In Fig. 3
                        , we also provide dose volume histograms (DVHs) for two treatments obtained from the first patient sequence–the exponential smoothing algorithm with smoothing factor 0.5 and robust uncertainty set (implementation (ES (0.5),R)) and the static method with the same uncertainty set (implementation (S,R)). A DVH is a plot for a particular structure which indicates, for a given level of dose, what volume of the structure receives at least that dose. Ideally, the healthy organ DVHs would be step functions from 100% to 0% at 0gray (i.e., no dose is delivered to the healthy organs), and the tumor DVH would be a step function from 100% to 0% at 72gray (i.e., the whole tumor volume receives exactly 72gray).

@&#DISCUSSION@&#

The computational results generate three important insights. First, the adaptive robust method generally dominates the static robust method, generating solutions that can simultaneously improve on tumor coverage and healthy tissue dose. As an example of this, compare the dose statistics of the static and the exponential smoothing with α
                        =0.5 methods for the first PMF sequence in Table 1. For the margin (M) uncertainty set, moving from the static (implementation (S,M)) to the exponential smoothing with α
                        =0.5 (implementation (ES (0.5),M)) treatment results in a reduction in the mean left lung dose of 12.73% of the static margin dose, with virtually no change in tumor coverage. For the robust (R) uncertainty set, moving from the static (implementation (S,R)) to the exponential smoothing with α
                        =0.5 (implementation (ES (0.5),R)) treatment results in an increase in minimum tumor dose of 0.85% of the prescribed dose, and a decrease in the mean left lung dose of 2.65% of the static margin dose – both objectives are improved. For the nominal (N) uncertainty set, moving from the static (implementation (S,N)) to the exponential smoothing with α
                        =0.5 (implementation (ES (0.5),N)) treatment results in a significant increase in the minimum tumor dose of 6.23% of the prescription dose with only a marginal increase in mean left lung dose of 0.91% of the static margin dose. Clinically, the marginal increase in lung dose (0.18gray) would be acceptable given the increase in minimum tumor dose (4.49gray). The dominance of the adaptive robust method over the static robust method is also evident in Figs. 1 and 2. On these plots, we can see that the frontiers of all of the adaptive methods are generally below and to the left of the static frontier. The DVHs in Fig. 3 further support this insight. From Fig. 3, we can see that the left lung, esophagus and heart curves for the adaptive treatment are mostly to the left of the corresponding curves for the static treatment, indicating an overall reduction of dose in these structures. The maximum spinal cord dose is slightly higher in the adaptive treatment, but is still clinically acceptable. The homogeneity of the tumor dose is slightly better in the static treatment, as can be seen in the sharper decline of the static treatment tumor dose-volume curve. However, the adaptive treatment has less tumor underdose and still satisfies the maximum tumor dose constraint. Again, Fig. 3 supports the observation that the adaptive robust method generally leads to simultaneous improvement in tumor coverage and healthy tissue sparing.

Alternatively, we can analyze these simultaneous improvements from an isodose perspective, where the dose delivered to the patient under each treatment is normalized to match the static margin treatment in certain lung dose metrics and the resulting (scaled) tumor doses are then compared. From this perspective, our results show that adaptation allows for significant dose escalation beyond the existing static robust approach. For example, if the prescription dose for the static robust treatment (implementation (S,R)) for the first PMF sequence is scaled up so that the mean left lung dose matches that of the static margin treatment (implementation (S,M)), the resulting minimum tumor dose (the MLLD-scaled tumor dose in Table 1) is 80.01gray. Doing the same for the exponential smoothing treatment with α
                        =0.5 and the robust uncertainty set (implementation (ES (0.5),R)) for the first PMF sequence, the MLLD-scaled tumor dose is 83.18gray – an increase of 3.17gray (≃4% of the original prescription dose of 72gray) from the static robust value. Using the estimated relationship between the 5-year local tumor control rate and tumor dose from Kong et al. (2005) for non-small cell lung cancer (NSCLC), this difference of 3.17gray translates to a 4% increase in local tumor control. In addition to the mean lung dose, dose can also be escalated according to the commonly used lung V20 metric, which is defined as the volume of the lung tissue that receives a dose of 20gray or higher; the minimum tumor dose that results from this type of escalation is given under the column labeled “LLV20-scaled tumor dose” in Table 1. If the prescription dose is escalated so that the (ES (0.5),R) and (S,R) treatments for the first PMF sequence have the same left lung V20 as the (S,M) treatment, then the adaptive robust solution leads to an additional minimum tumor dose escalation of 6.40gray (≃9% of the original prescription dose of 72gray) beyond that of the static robust approach. Using the relationship from Kong et al. (2005), this difference of 6.40gray translates approximately to an 8% increase in 5-year local tumor control. Given that the 5-year control rates for tumor doses in the 63–69gray and 74–84gray ranges are on the order of 12% and 35% respectively (Kong et al., 2005), the tumor dose escalation and the associated gains in local control rate using both the mean left lung dose and left lung V20 methods that we have described have the potential to be significant.

The second insight that can be drawn is that even though the adaptive robust method is myopic and does not know what PMFs will be realized in future fractions, its performance for this patient case comes close to the performance of solutions that correctly anticipate future PMFs. This is evident in the fact that the treatments obtained from the adaptive robust method are very close in tumor coverage and healthy tissue dose to the two types of prescient solutions. For example, for the first PMF sequence, when the robust (R) uncertainty set is chosen and exponential smoothing with α
                        =0.9 is applied (implementation (ES (0.9),R) in Table 1), the minimum tumor dose as a percentage is 99.97% and the mean left lung dose as a percentage is 86.33%. For both the daily and average prescient treatments, the minimum tumor dose as a percentage is 100%; for the daily prescient treatment, the mean left lung dose as a percentage is 86.18%, whereas for the average prescient treatment, the mean left lung dose as a percentage is 86.02%. Even at slower rates of adaptation, the adaptive robust treatments perform similarly to the prescient solutions. For instance, using exponential smoothing with α
                        =0.1 and starting with the robust (R) uncertainty set (implementation (ES (0.1),R)), the minimum tumor dose as a percentage of 72gray is within 0.5% of the prescient solutions in minimum tumor dose and within 1.5% of the prescient solutions in mean left lung dose. Although our present computational results provide a specific example of this phenomenon, and our analysis in Section 6 provides theoretical justification for this phenomenon under quite general circumstances, further testing on other patient cases is needed to verify the degree to which this insight holds more broadly in practice.

The third insight is that the final dose distribution from any of the adaptive robust methods is far less sensitive to the choice of initial uncertainty set compared to the static method. For instance, for the first PMF sequence, consider the treatments that use exponential smoothing with α
                        =0.9 (implementations (ES (0.9),N), (ES (0.9),R) and (ES (0.9),M)). For the nominal (N), robust (R) and margin (M) uncertainty sets, the minimum tumor doses achieved using exponential smoothing with α
                        =0.9 are 71.83, 71.98 and 72.02gray respectively, while the mean left lung doses are 17.57, 17.60 and 17.71gray respectively. Visually, this insight is evident in the fact that the adaptive method frontiers are much smaller than the static frontier on both Figs. 1. This insight is significant because it indicates that the success of this method is not contingent on having accurate knowledge of what the PMFs will be before the treatment begins. From a clinical standpoint, this eliminates an important barrier to clinical implementation, as the treatment planner may not have enough detailed knowledge of a particular patient’s breathing patterns before the start of treatment to create a single uncertainty set suitable for the entire treatment course. Moreover, the method proposed in Bortfeld et al. (2008) for the design of uncertainty sets requires historical breathing data from prior patients that is similar to the breathing data of the current patient, which may not always be available.

Given the third insight, it may seem that adding adaptation diminishes the value of robust optimization, as the adaptive treatments that begin with a nominal uncertainty set have similar performance to the adaptive treatments that begin with the other two larger uncertainty sets. Furthermore, the treatments from exponential smoothing with α
                        =1 ((ES (1),N), (ES (1),R) and (ES (1),M)), for which the uncertainty set from fraction 2 on is always a singleton, perform almost as well as the prescient solutions with respect to the final dose distribution. Although this may be true for the PMF sequences that we study here, it may not be true in general, as the PMF sequences that we have used here are well-behaved and relatively stable. For instance, sequences that exhibit more variability may cause poor performance if there is too much adaptation and too little robustness (i.e., α is set close to one and the initial uncertainty set is small); we explore such a sequence in Section C of the Online Supplement. Similarly, sequences that exhibit transient behavior and drift outside of the initial uncertainty set towards a new value could also necessitate the use of a large uncertainty set early on while the lower and upper bound vectors are still “homing in” on the PMFs. The value of the methodology that we have described in this paper is that it allows the treatment planner to balance robustness, which provides protection during the early fractions of the treatment, and adaptation, which provides protection in the later fractions of the treatment. Thus, this methodology is flexible enough to be applied to settings where the patient’s breathing will be very stable over the course of the treatment (such as the PMF sequences that we study here) and settings where the patient’s breathing could be highly variable early in the treatment or even throughout the entire treatment (such as the PMF sequence studied in Section C of the Online Supplement). Lastly, our computational results correspond to a standard treatment schedule of 30 fractions. When the number of fractions is reduced, as in hypofractionated treatments, a larger proportion of the total prescription dose needs to be delivered in each fraction. In such treatments, the consequences of selecting an inappropriate uncertainty set in each fraction therefore become more severe. Furthermore, the errors in delivered dose made in the early fractions can no longer be “averaged out” due to a large number of fractions. We expect that in such hypofractionated treatments, the quality of the treaments resulting from our method will be more strongly tied to the choice of initial uncertainty set. Thus, the performance of the adaptive robust method (using a non-singleton uncertainty set) will be further differentiated in a positive way from the performance of a nominal (no robustness) adaptive method.

In Section 5.3, we observed that the adaptive robust treatments are (a) generally better than the static robust treatments in both lung dose and tumor coverage, (b) very close in quality to both prescient solutions, and (c) relatively insensitive to the choice of initial uncertainty set. In this section, we describe our core theoretical result, which we use to explain these observations. Our result is as follows: if the sequence of breathing motion PMFs 
                        
                           
                              
                                 (
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 )
                              
                              
                                 i
                                 =
                                 1
                              
                              
                                 ∞
                              
                           
                        
                      converges to p
                     ∗ and the uncertainty set update algorithm belongs to a special class of update algorithms, then as the number of fractions n tends to infinity, the dose distribution eventually enters the epsilon neighborhood of a set D of “ideal” dose distributions. The set D is the set of dose distributions obtained when any optimal solution to the nominal problem with respect to p
                     ∗ is delivered while the patient is actually breathing according to p
                     ∗. The proof of this statement, along with the assumptions and the auxiliary results leading to it, is given in Section D of the Online Supplement.

We define the epsilon neighborhood U(V,
                     ∊) of a subset 
                        
                           V
                           ⊆
                           
                              
                                 R
                              
                              
                                 n
                              
                           
                        
                      as
                        
                           
                              U
                              (
                              V
                              ,
                              ∊
                              )
                              =
                              
                                 
                                    
                                       ⋃
                                    
                                    
                                       x
                                       ∈
                                       V
                                    
                                 
                              
                              B
                              (
                              x
                              ,
                              ∊
                              )
                              ,
                           
                        
                     where B(x,
                     ∊) is the open ball of radius ∊ about 
                        
                           x
                           
                           (
                           B
                           (
                           x
                           ,
                           ∊
                           )
                           =
                           {
                           
                              
                                 x
                              
                              
                                 ′
                              
                           
                           ∈
                           
                              
                                 R
                              
                              
                                 n
                              
                           
                           |
                           
                           ‖
                           x
                           -
                           
                              
                                 x
                              
                              
                                 ′
                              
                           
                           ‖
                           <
                           ∊
                           }
                           )
                        
                     . The norm ∥·∥ is the 1-norm on the appropriate finite dimensional real vector space, although technically any p-norm can be used.

We say that an uncertainty set update algorithm is a convex-convergent update algorithm if it satisfies two conditions:
                        
                           1.
                           For every 
                                 
                                    i
                                    ∈
                                    
                                       
                                          Z
                                       
                                       
                                          +
                                       
                                    
                                 
                               (the set of positive integers), ℓ
                              
                                 i+1 and u
                              
                                 i+1 can be written as convex combinations of p
                              
                                 i
                               with ℓ
                              
                                 i
                               and u
                              
                                 i
                               respectively; that is, there exists an α
                              
                                 i
                              
                              ∈[0,1] such that
                                 
                                    
                                       
                                          
                                             
                                             
                                                
                                                   
                                                      
                                                         ℓ
                                                      
                                                      
                                                         i
                                                         +
                                                         1
                                                      
                                                   
                                                   =
                                                   (
                                                   1
                                                   -
                                                   
                                                      
                                                         α
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   )
                                                   
                                                      
                                                         ℓ
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         α
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   
                                                      
                                                         p
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   ,
                                                
                                             
                                          
                                          
                                             
                                             
                                                
                                                   
                                                      
                                                         u
                                                      
                                                      
                                                         i
                                                         +
                                                         1
                                                      
                                                   
                                                   =
                                                   (
                                                   1
                                                   -
                                                   
                                                      
                                                         α
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   )
                                                   
                                                      
                                                         u
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   +
                                                   
                                                      
                                                         α
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   
                                                      
                                                         p
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   .
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           

If p
                              
                                 i
                              
                              →
                              p
                              ∗ as i
                              →∞, then ℓ
                              
                                 i
                              
                              →
                              p
                              ∗ and u
                              
                                 i
                              
                              →
                              p
                              ∗ as i
                              →∞.

It can be easily verified that both the exponential smoothing and running average update algorithms are convex-convergent.

Let w
                     ∗(ℓ,
                     u) denote the set of optimal solutions for the robust problem (1) with its uncertainty set P defined by lower and upper bound vectors ℓ and u. Let w
                     ∗(p
                     ∗) denote the set of optimal solutions for the nominal problem with respect to p
                     ∗.

Define the set D, the set of dose distributions when p
                     ∗ is realized while w
                     ∈
                     w
                     ∗(p
                     ∗) is being delivered, as
                        
                           
                              D
                              =
                              {
                              d
                              ∈
                              
                                 
                                    R
                                 
                                 
                                    |
                                    V
                                    |
                                 
                              
                              |
                              d
                              =
                              Δ
                              
                                 
                                    p
                                 
                                 
                                    ∗
                                 
                              
                              w
                              
                              for
                              
                              some
                              
                              w
                              ∈
                              
                                 
                                    w
                                 
                                 
                                    ∗
                                 
                              
                              (
                              
                                 
                                    p
                                 
                                 
                                    ∗
                                 
                              
                              )
                              }
                           
                        
                     where the product Δpw is defined as
                        
                           
                              Δ
                              pw
                              =
                              
                                 
                                    
                                       
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   x
                                                   ∈
                                                   X
                                                
                                             
                                          
                                          
                                             
                                                
                                                   ∑
                                                
                                                
                                                   b
                                                   ∈
                                                   B
                                                
                                             
                                          
                                          
                                             
                                                Δ
                                             
                                             
                                                v
                                                ,
                                                x
                                                ,
                                                b
                                             
                                          
                                          p
                                          (
                                          x
                                          )
                                          
                                             
                                                w
                                             
                                             
                                                b
                                             
                                          
                                       
                                    
                                 
                                 
                                    v
                                    ∈
                                    V
                                 
                              
                              .
                           
                        
                     For an n fraction treatment during which the intensity vectors were w
                     1, …, w
                     
                        n
                      and the realized PMFs were p
                     1, …, p
                     
                        n
                     , the final dose distribution is given by 
                        
                           1
                           /
                           n
                           ·
                           
                              
                                 ∑
                              
                              
                                 i
                                 =
                                 1
                              
                              
                                 n
                              
                           
                           Δ
                           
                              
                                 p
                              
                              
                                 i
                              
                           
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                        
                     . Our core result can be stated as Theorem 1.
                        Theorem 1
                        (Adaptive robust dose convergence) Let 
                              
                                 
                                    
                                       (
                                       
                                          
                                             p
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            be a sequence of PMFs that converges to p
                           ∗. Let 
                              
                                 
                                    
                                       (
                                       
                                          
                                             ℓ
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            and 
                              
                                 
                                    
                                       (
                                       
                                          
                                             u
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            be lower and upper bound sequences generated from 
                              
                                 
                                    
                                       (
                                       
                                          
                                             p
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            by a convex-convergent update algorithm. For each 
                              
                                 i
                                 ∈
                                 
                                    
                                       Z
                                    
                                    
                                       +
                                    
                                 
                              
                           , let w
                           
                              i
                           
                           ∈
                           w
                           ∗(ℓ
                           
                              i
                           ,u
                           
                              i
                           ). Then for every ∊
                           >0, there exists an 
                              
                                 N
                                 ∈
                                 
                                    
                                       Z
                                    
                                    
                                       +
                                    
                                 
                              
                            such that for all n
                           >
                           N,
                              
                                 
                                    
                                       
                                          1
                                       
                                       
                                          n
                                       
                                    
                                    
                                       
                                          
                                             ∑
                                          
                                          
                                             i
                                             =
                                             1
                                          
                                          
                                             n
                                          
                                       
                                    
                                    Δ
                                    
                                       
                                          p
                                       
                                       
                                          i
                                       
                                    
                                    
                                       
                                          w
                                       
                                       
                                          i
                                       
                                    
                                    ∈
                                    U
                                    (
                                    D
                                    ,
                                    ∊
                                    )
                                    .
                                 
                              
                           
                        

The theorem states that the dose distribution obtained via any convex-convergent update algorithm approaches a set of optimal dose distributions D. The intuition behind this result is that as i
                     →∞, w
                     
                        i
                      is increasingly similar to some solution in w
                     ∗(p
                     ∗), and p
                     
                        i
                      is increasingly similar to p
                     ∗. Therefore, as n tends to infinity, each term in the tail of the sum 
                        
                           
                              
                                 ∑
                              
                              
                                 i
                                 =
                                 1
                              
                              
                                 n
                              
                           
                           Δ
                           
                              
                                 p
                              
                              
                                 i
                              
                           
                           
                              
                                 w
                              
                              
                                 i
                              
                           
                        
                      becomes increasingly similar to some d
                     ∈
                     D.

This set D of optimal dose distributions is the same set that is approached by both the daily prescient and average prescient dose distributions.
                        Theorem 2
                        
                           Let 
                           
                              
                                 
                                    
                                       (
                                       
                                          
                                             p
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            
                           be a sequence of PMFs that converges to 
                           p
                           ∗
                           .
                           
                              
                                 (a)
                                 
                                    (Daily prescient dose convergence.) For each 
                                    
                                       
                                          i
                                          ∈
                                          
                                             
                                                Z
                                             
                                             
                                                +
                                             
                                          
                                       
                                    
                                    , let 
                                    w
                                    
                                       i
                                    
                                    ∈
                                    w
                                    ∗
                                    (
                                    p
                                    
                                       i
                                    
                                    ,
                                    p
                                    
                                       i
                                    
                                    ). Then for every ∊
                                    >
                                    0, there exists an 
                                    
                                       
                                          N
                                          ∈
                                          
                                             
                                                Z
                                             
                                             
                                                +
                                             
                                          
                                       
                                     
                                    such that for all n
                                    >
                                    N,
                                    
                                       
                                          
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   i
                                                
                                             
                                             ∈
                                             U
                                             (
                                             D
                                             ,
                                             ∊
                                             )
                                             .
                                          
                                       
                                    
                                 


                                    (Average prescient dose convergence.) For each 
                                    
                                       
                                          n
                                          ∈
                                          
                                             
                                                Z
                                             
                                             
                                                +
                                             
                                          
                                       
                                    
                                    , let 
                                    
                                       
                                          
                                             
                                                w
                                             
                                             
                                                n
                                             
                                          
                                          ∈
                                          
                                             
                                                w
                                             
                                             
                                                ∗
                                             
                                          
                                          
                                             
                                                
                                                   1
                                                   /
                                                   n
                                                   ·
                                                   
                                                      
                                                         ∑
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      
                                                         n
                                                      
                                                   
                                                   
                                                      
                                                         p
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                   ,
                                                   1
                                                   /
                                                   n
                                                   ·
                                                   
                                                      
                                                         ∑
                                                      
                                                      
                                                         i
                                                         =
                                                         1
                                                      
                                                      
                                                         n
                                                      
                                                   
                                                   
                                                      
                                                         p
                                                      
                                                      
                                                         i
                                                      
                                                   
                                                
                                             
                                          
                                       
                                    
                                    . Then for every ∊
                                    >
                                    0, there exists an 
                                    
                                       
                                          N
                                          ∈
                                          
                                             
                                                Z
                                             
                                             
                                                +
                                             
                                          
                                       
                                     
                                    such that for all n
                                    >
                                    N,
                                    
                                       
                                          
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   n
                                                
                                             
                                             ∈
                                             U
                                             (
                                             D
                                             ,
                                             ∊
                                             )
                                             .
                                          
                                       
                                    
                                 

When the nominal problem with respect to p
                     ∗ has a unique optimal solution, the difference between the adaptive robust and either prescient dose distribution tends to zero.
                        Corollary 1
                        
                           Let 
                           
                              
                                 
                                    
                                       (
                                       
                                          
                                             p
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            
                           be a sequence of PMFs that converges to 
                           p
                           ∗
                           . For each 
                           
                              
                                 i
                                 ∈
                                 
                                    
                                       Z
                                    
                                    
                                       +
                                    
                                 
                              
                           
                           , let 
                           w
                           
                              AR
                           
                           
                              i
                           
                           ∈
                           w
                           ∗
                           (
                           ℓ
                           
                              i
                           
                           ,
                           
                           u
                           
                              i
                           
                           ) (the adaptive robust intensity vector for fraction i), where 
                           
                              
                                 
                                    
                                       (
                                       
                                          
                                             ℓ
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            
                           and 
                           
                              
                                 
                                    
                                       (
                                       
                                          
                                             u
                                          
                                          
                                             i
                                          
                                       
                                       )
                                    
                                    
                                       i
                                       =
                                       1
                                    
                                    
                                       ∞
                                    
                                 
                              
                            
                           are obtained by a convex-convergent update algorithm, and let 
                           w
                           
                              DP
                           
                           
                              i
                           
                           ∈
                           w
                           ∗
                           (
                           p
                           
                              i
                           
                           ,
                           
                           p
                           
                              i
                           
                           ) (the daily prescient intensity vector for fraction i). For each 
                           
                              
                                 n
                                 ∈
                                 
                                    
                                       Z
                                    
                                    
                                       +
                                    
                                 
                              
                           
                           , let 
                           
                              
                                 
                                    
                                       w
                                    
                                    
                                       AP
                                    
                                    
                                       n
                                    
                                 
                                 ∈
                                 
                                    
                                       w
                                    
                                    
                                       ∗
                                    
                                 
                                 
                                    
                                       
                                          1
                                          /
                                          n
                                          ·
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                                =
                                                1
                                             
                                             
                                                n
                                             
                                          
                                          
                                             
                                                p
                                             
                                             
                                                i
                                             
                                          
                                          ,
                                          1
                                          /
                                          n
                                          ·
                                          
                                             
                                                ∑
                                             
                                             
                                                i
                                                =
                                                1
                                             
                                             
                                                n
                                             
                                          
                                          
                                             
                                                p
                                             
                                             
                                                i
                                             
                                          
                                       
                                    
                                 
                              
                            
                           (the average prescient intensity vector for fraction i). If the nominal problem with respect to 
                           p
                           ∗ 
                           has a unique optimal solution (i.e., 
                           w
                           ∗
                           (
                           p
                           ∗
                           ) is a singleton), then
                           
                              
                                 
                                    
                                       
                                          
                                             lim
                                          
                                          
                                             n
                                             →
                                             ∞
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   AR
                                                
                                                
                                                   i
                                                
                                             
                                             -
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   DP
                                                
                                                
                                                   i
                                                
                                             
                                          
                                       
                                    
                                    =
                                    
                                       
                                          
                                             lim
                                          
                                          
                                             n
                                             →
                                             ∞
                                          
                                       
                                    
                                    
                                       
                                          
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   AR
                                                
                                                
                                                   i
                                                
                                             
                                             -
                                             
                                                
                                                   1
                                                
                                                
                                                   n
                                                
                                             
                                             
                                                
                                                   
                                                      ∑
                                                   
                                                   
                                                      i
                                                      =
                                                      1
                                                   
                                                   
                                                      n
                                                   
                                                
                                             
                                             Δ
                                             
                                                
                                                   p
                                                
                                                
                                                   i
                                                
                                             
                                             
                                                
                                                   w
                                                
                                                
                                                   AP
                                                
                                                
                                                   n
                                                
                                             
                                          
                                       
                                    
                                    =
                                    0
                                    .
                                 
                              
                           
                        

These results directly relate to the three insights of Section 5.3. With regard to the first insight – that adaptive robust treatments generally dominate static robust treatments – suppose that w is a solution of the robust problem with uncertainty set P. The static robust dose distribution after n fractions is given by
                           
                              
                                 
                                    
                                       1
                                    
                                    
                                       n
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                 
                                 Δ
                                 
                                    
                                       p
                                    
                                    
                                       i
                                    
                                 
                                 w
                                 =
                                 Δ
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          i
                                          =
                                          1
                                       
                                       
                                          n
                                       
                                    
                                 
                                 
                                    
                                       
                                          
                                             p
                                          
                                          
                                             i
                                          
                                       
                                    
                                    
                                       n
                                    
                                 
                                 w
                                 .
                              
                           
                        If 
                           
                              
                                 
                                    (
                                    
                                       
                                          p
                                       
                                       
                                          i
                                       
                                    
                                    )
                                 
                                 
                                    i
                                    =
                                    1
                                 
                                 
                                    ∞
                                 
                              
                           
                         converges to p
                        ∗, then this dose distribution converges to Δp
                        ∗
                        w. Whether or not this dose distribution is satisfactory depends on whether or not p
                        ∗ is in P. If p
                        ∗
                        ∈
                        P, then every tumor voxel will receive sufficient dose in the limiting dose distribution. However, if p
                        ∗
                        ∉
                        P, then there is no guarantee that every tumor voxel will sufficient dose. In contrast to the static method, the adaptive robust method always leads to sufficient tumor dose in the limit. The reason for this is that every dose distribution d in D has the property that all tumor voxels receive the minimum prescription dose. This property is a consequence of the fact that d
                        =Δp
                        ∗
                        w for some intensity vector w corresponding to the singleton uncertainty set {p
                        ∗}; by the definition of problem (1), it is straightforward to see that the dose to tumor voxel v satisfies
                           
                              
                                 
                                    
                                       d
                                    
                                    
                                       v
                                    
                                 
                                 =
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          x
                                          ∈
                                          X
                                       
                                    
                                 
                                 
                                    
                                       
                                          ∑
                                       
                                       
                                          b
                                          ∈
                                          B
                                       
                                    
                                 
                                 
                                    
                                       Δ
                                    
                                    
                                       v
                                       ,
                                       x
                                       ,
                                       b
                                    
                                 
                                 
                                    
                                       p
                                    
                                    
                                       ∗
                                    
                                 
                                 (
                                 x
                                 )
                                 
                                    
                                       w
                                    
                                    
                                       b
                                    
                                 
                                 ⩾
                                 
                                    
                                       θ
                                    
                                    
                                       v
                                    
                                 
                                 .
                              
                           
                        
                     

Furthermore, observe that every beamlet intensity vector in w
                        ∗(p
                        ∗) is an optimal solution of the nominal problem with respect to p
                        ∗. As we discussed earlier, solutions to nominal problems are ones that generally result in the lowest level of normal tissue damage. Therefore, not only do the dose distributions in D meet the tumor dose requirements, but they are also likely to lead to low levels of healthy tissue dose. In contrast, a static robust treatment will generally not possess both of these qualities simultaneously. If the treatment planner selects P to be a singleton (i.e. w is the solution of the nominal problem with a specific PMF), then the treatment is likely to result in low healthy tissue dose, but the treatment planner is taking a major risk by assuming what p
                        ∗ will be. If the treatment planner selects a larger P, then there is a better chance that p
                        ∗ will be contained in P, but at the cost of increased healthy tissue dose.

With regard to the second insight – that the adaptive robust and prescient treatments become very similar – we know that both the average and daily prescient dose distributions also approach D. When the nominal problem with respect to p
                        ∗ has a unique optimal solution, the difference between the adaptive robust dose distribution and either prescient dose distribution must tend to zero by Corollary 1. In the case that there are multiple optimal solutions to the nominal problem with respect to p
                        ∗, it seems reasonable to expect that the dose distributions that are achieved when these solutions are delivered and the patient breathes according to p
                        ∗ should not differ significantly. Therefore, the difference between either prescient dose distribution and the adaptive robust dose distribution should also become small in the limit.

With regard to the third insight – that the adaptive robust method is relatively insensitive to the choice of initial uncertainty set – we can see that in the proof of Theorem 1, the choice of ℓ
                        1 and u
                        1 is not important: the dose distribution always approaches the set D, no matter what ℓ
                        1 and u
                        1 are. Again, if D is a singleton, then any two dose distributions that are obtained using the same adaptive method but different ℓ
                        1 and u
                        1 vectors will converge to the single distribution in D. Since the two dose distributions converge to the same limiting dose distribution, the difference between those dose distributions must tend to zero. In practice, we will still see some dependence on the initial uncertainty set due to the finite number of fractions, but with a large number of fractions, the effect of the initial uncertainty set will become diminished.

We note that although the theoretical results we have developed are helpful in understanding the performance of our methods, it is unlikely that a patient PMF sequence in real life will converge to a single limiting PMF. A more plausible scenario may be that after a transient period, during which the patient is being acclimated to the treatment, the PMF sequence converges to a set of PMFs, and on each day the patient’s PMF varies within this set, without converging to a single limiting PMF. Our results cannot directly answer this question without modifications. However, our core theoretical result (Theorem 1) relies on the fact that for every ∊, which represents the error between the set of ideal dose distributions D corresponding to a limiting p
                        ∗ and the realized dose distribution 
                           
                              1
                              /
                              n
                              ·
                              
                                 
                                    ∑
                                 
                                 
                                    i
                                    =
                                    1
                                 
                                 
                                    n
                                 
                              
                              Δ
                              
                                 
                                    p
                                 
                                 
                                    i
                                 
                              
                              
                                 
                                    w
                                 
                                 
                                    i
                                 
                              
                           
                        , we are able to get p
                        
                           i
                         within a suitable distance of p
                        ∗. In the case that we can only say that p
                        
                           i
                         gets arbitrarily close to a set of limiting PMFs, we expect that Theorem 1 can be modified to hold for ∊
                        ⩾
                        ∊
                        0, where ∊
                        0
                        >0 depends on the size of the set of limiting PMFs, as opposed to any arbitrary ∊
                        >0. We expect that as the size of the limiting set of PMFs decreases, the error between the realized dose distribution and an ideal set of distributions (obtained by applying the daily prescient method to the sequence) will also decrease; Theorem 1 would then present an extreme case where the limiting set of PMFs is a singleton. The real patient PMF sequences used in Section 5 are relatively stable, which is why our present theoretical results agree with our computational insights. We also expect that when the PMFs converge only to a set, the performance may be more sensitive to the choice of the update algorithm, and how the convergence to a set is preserved (or not preserved) for the sequence of lower and upper bound vectors generated by the update algorithm. In Section C of the Online Supplement, we provide an example of such a PMF sequence that does not stabilize. For this sequence, we indeed find that the performance gap between the exponential smoothing and prescient solutions is generally quite large; however, the running average algorithm is still able to achieve good performance.

@&#CONCLUSIONS@&#

In this study, we developed an optimization method for fractionated IMRT treatment planning that combats breathing motion uncertainty by generalizing the methodologies of adaptive radiation therapy and robust optimization. We studied the effectiveness of our method on two PMF sequences obtained from clinical lung cancer patients and showed that our adaptive robust optimization method improves upon the static method in both tumor coverage and healthy tissue sparing simultaneously. We also studied the effectiveness of our method from a theoretical standpoint and proved that the adaptive robust dose distribution approaches a limiting set of optimal dose distributions. Even though this adaptive approach is myopic, it performs well when the PMF sequence converges, and for some uncertainty set update algorithms, performs well even when the PMF sequence does not converge. Also, as we have shown empirically and theoretically, our method does not require perfectly accurate information to be available before the start of treatment. Overall, the clinical value of this method is that it allows for the tumor dose to be safely escalated without leading to additional healthy tissue toxicity, which may ultimately improve the rate of patient survival.

Future work should consider what results can be obtained when the convergence assumption is relaxed and the PMFs are instead drawn from a distribution on the probability simplex. The adaptive robust method we have studied can also be modified by changing the right hand side of problem (1) after each fraction, in order for the treatment to account for the dose delivered in prior fractions and to compensate for daily underdosages and overdosages in prior fractions. With such a method, we hypothesize that the daily dose delivered to the tumor will become increasingly inhomogeneous as the treatment progresses, with some parts of the tumor receiving significantly less than the daily prescribed amount. This seems to be the case in some preliminary computational tests and is the subject of ongoing work.

Finally, we note that although we have specifically studied fractionated IMRT planning under breathing motion uncertainty, the methodology and analysis we have presented here is of value to other practical problems outside of the domain of healthcare. Specifically, this method can be applied to problems involving sequential decision making under uncertainty, when new measurements of the uncertain effect are obtained over the planning horizon. This approach may be particularly attractive when it is computationally inexpensive to solve the robust optimization problem with the updated uncertainty set at each stage. Overall, the empirical performance and theoretical properties we have shown in this paper suggest that this type of adaptive robust optimization method could be a viable approach for other multi-stage decision making problems under uncertainty.

@&#ACKNOWLEDGEMENTS@&#

The authors thank the referees for their careful reading of the paper and for their thoughtful comments which have helped to improve the paper. The authors thank Thomas Bortfeld of Massachusetts General Hospital for providing the patient data used in Section 5. The work of both authors was partially supported by the Natural Sciences and Engineering Research Council of Canada (NSERC) and the Canadian Institutes of Health Research (CIHR). The work of the second author was partially supported by an NSERC CGS-M award.

Supplementary data associated with this article can be found, in the online version, at http://dx.doi.org/10.1016/j.ejor.2013.06.003.


                     
                        
                           
                        
                     
                  

@&#REFERENCES@&#

