@&#MAIN-TITLE@&#Group sparsity model for stain unmixing in brightfield multiplex immunohistochemistry images

@&#HIGHLIGHTS@&#


               
                  
                  
                     
                        
                           
                           Unmixing RGB image into more than three colors is hardly studied in literature.


                        
                        
                           
                           A novel IHC image unmixing algorithm is proposed based on group sparsity model.


                        
                        
                           
                           Biological biomarker co-localization information is used as prior in this model.


                        
                        
                           
                           It unmixes more than three dyes while preserving the biological constraints.


                        
                        
                           
                           The new algorithm demonstrates better results than the existing strategies.


                        
                     
                  
               
            

@&#KEYPHRASES@&#

Group sparsity

Multiplex immunohistochemistry image

Color deconvolution

RGB image unmixing

@&#ABSTRACT@&#


               
               
                  Multiplex immunohistochemistry (IHC) staining is a new, emerging technique for the detection of multiple biomarkers within a single tissue section. The initial key step in multiplex IHC image analysis in digital pathology is of tremendous clinical importance due to its ability to accurately unmix the IHC image and differentiate each of the stains. The technique has become popular due to its significant efficiency and the rich diagnostic information it contains. The intriguing task of unmixing a three-channel CCD color camera acquired RGB image into more than three colors is very challenging, and to the best of our knowledge, hardly studied in academic literature.
                  This paper presents a novel stain unmixing algorithm for brightfield multiplex IHC images based on a group sparsity model. The proposed framework achieves robust unmixing for more than three chromogenic dyes while preserving the biological constraints of the biomarkers. Typically, a number of biomarkers co-localize in the same cell parts named priori. With this biological information in mind, the number of stains at one pixel therefore has a fixed up-bound, i.e. equivalent to the number of co-localized biomarkers. By leveraging the group sparsity model, the fractions of stain contributions from the co-localized biomarkers are explicitly modeled into one group to yield the least square solution within the group. A sparse solution is obtained among the groups since ideally only one group of biomarkers is present at each pixel. The algorithm is evaluated on both synthetic and clinical data sets, and demonstrates better unmixing results than the existing strategies.
               
            

@&#INTRODUCTION@&#

As one of the most life-threatening group of diseases, cancer causes millions of deaths each year. Traditional TNM staging system is often used to provide prognostic information, however, it relies solely on the tumor cells and leads to significant variation of outcomes within the same tumor stage. Therefore, it is of great clinical importance to have a reliable, reproducible, clinically relevant and biologically meaningful system for cancer identification and staging in contrast to TNM [1]. Recently, the study of immune regulation within the tumor microenvironment has gained tremendous attention in cancer research [2,1,3] and it has been evidenced that the immune cells are associated with the clinical outcome of certain cancer types [2]. A quantitative and objective evaluation of different types of immune cells within the tumor microenvironment hence needs to be achieved in both research and clinical studies, wherein digital pathology plays an important role.

While the popular primary staining Hematoxylin and Eosin (H&E) slides are widely investigated in digital pathology to study the tissue morphologies, classify the cancer types, or grade the cancer [4–9], the special staining techniques such as immunohistochemistry staining also convey important information. A multiplex immunohistochemistry (IHC) slide has the potential advantage of simultaneously identifying multiple biomarkers in one tissue section as opposed to single biomarker labeling in multiple slides (see Fig. 1
                      for example). Therefore, multiplex immunohistochemistry staining is often used for simultaneous assessment of multiple biomarkers in cancerous tissue. For example, tumors often contain infiltrates of immune cells, which may prevent the development of tumors, or favor the outgrowth of tumors [2]. In this scenario, multiple biomarkers are used to target different types of immune cells, and then using the population distribution of each immune cell type to study the clinical outcome of the patients. The biomarkers of the immune cells are stained by using different chromogenic dyes. The correct unmixing of the IHC digital image into its individual constituent dyes for each biomarker, while also, obtaining the proportion of each dye in the color mixture remain prerequisites for accurate detection and classification of immune cells in multiplex IHC image analysis.

A typical digital pathology workflow for multiplex staining, and stain unmixing is shown in Fig. 2
                     . A tissue slide is stained with the multiplex assay. The stained slide is then imaged using a CCD color camera mounted on a microscope, or a scanner. The acquired RGB color image is a mixture of the underlying co-localized biomarker expressions. Several techniques have been proposed in literature to decompose each pixel of the RGB image into a collection of constituent stains and the fractions of the contributions from each of them, that is, to convert the RGB image into biomarker-specific image channels. Stain unmixing is therefore a prerequisite step for the application of the following image analysis algorithms: cell detection, segmentation and classification for each biomarker. Ruifrok et al. developed an unmixing method called color deconvolution [10] to unmix the RGB image with up to three stains in the converted optical density space. Given the reference color vectors x
                     
                        i
                     
                     ∈
                     R
                     3 of the pure stains, the method assumes that each pixel of the color mixture y
                     ∈
                     R
                     3 is a linear combination of the pure stain colors and solves a linear system to obtain the combination weights b
                     ∈
                     R
                     
                        M
                     . The linear system is denoted as y
                     =
                     Xb, where X
                     =[x
                     1, …, x
                     
                        M
                     ], M
                     ≤3 is the matrix of reference colors. This technique is currently most widely used in the domain of digital pathology. However, the maximum number of stains which can be resolved is limited to three, as the linear system is deficient for not having enough equations in cases of more than three stains. A multilayer perceptron learning based technique has been proposed in [11] for three color brightfield image unmixing. In [12], Rabinovich et al. formulated the color unmixing problem into non-negative matrix factorization and proposed a system capable of performing the color decomposition in a fully automated manner, wherein no reference stain color selection is required. Again, these methods have the same limitation when dealing with large stain numbers due to solving y
                     =
                     Xb. To the best of our knowledge, the method of unmixing brightfield IHC image with more than three stains is not available in literature. In order to compare with Ruifrok's method, we divide the color space into several systems with up to three colors in each system based on the nearest color matching of each pixel to one of the systems. Ruifrok's method can therefore be used in solving each individual system. Due to the independent assignment of each pixel into different systems, the spatial continuity is lost in the unmixed images and artifacts such as holes are observed. However, this is the most straightforward modification of Ruifrok's method to be feasible on more than three color multiplex brightfield image unmixing for comparison purposes.

Alternatively, there exists another class of methods for multi-spectral image unmixing that works for a larger number of stain colors [13–17]. In fact, the multi-spectral image differs from the RGB image in terms of image acquisition. A multi-spectral imaging system is used to capture the image using a set of spectral narrow-band filters, rather than using the CCD color camera. The number of filters K can be as few as a dozen to as many as a hundred, and ultimately lead to a multi-channel image that provides much richer information than the bright field RGB image. The linear system constructed from it is always an over-determined system with X being a K
                     ×
                     M (K
                     ≫
                     M) matrix that leads to a unique solution. However, the scanning process in the multi-spectral imaging system is time consuming and provides only a single field of view, manually selected by a trained technician, rather than a whole slide scan. As an example of the multi-spectral imaging unmixing, the two-stage methods [14,15] are developed in the remote sensing domain to first learn the reference colors from the image context and then use them to unmix the image. Sparse models have been widely used in radiology image analysis for image registration, segmentation, shape modeling and low dose CT analysis, etc. [18–26] and demonstrate improved performance with respect to the classical models. More recently, a sparse model is proposed by Greer in [17] for high dimensional multi-spectral image unmixing. It adopts the L
                     0 norm to regularize the combination weights b of the reference colors hence leads to a solution that only a small number of reference colors are contributed to the stain color mixture. These serve as valuable sources of inspiration for selecting regularization terms for the linear system. However, the method proposed in [17] is also designed for multi-spectral image and no prior biological information about the biomarkers are used in that framework which may lead to undesired solution for real data.

In this paper, we propose a novel color unmixing algorithm for multiplex IHC image (scanned using CCD color camera) that can handle more than three stain colors, and maintain the biological properties of the biomarkers. Intuitively, the unmixing algorithm for the multiplex IHC image should work as following. (1) Only one group of stains has non-zero contribution in the color mixture for each pixel. (2) Within that group, the fractions of the contributions from each constituent stain should be correctly estimated. These conditions motivate us to model the unmixing problem within the group sparsity [27] framework so as to ensure the sparsity among the group, but non-sparsity within the group.

@&#METHODOLOGY@&#

In this section, we present the methodology of our algorithm. We begin with illustrating the basic framework in Fig. 3
                      using the following example. In the analysis of cancerous tissues, different biomarkers are specified to one or more types of immune cells. For instance, CD3 is a known universal marker for all T-cells, and CD8 only stains the membranes of the cytotoxic T-cells. FoxP3 marks only the regulatory T-cells in the nuclei, and hematoxylin (HTX) stains all the nuclei. A summary of the aforementioned markers are shown in Fig. 4
                     . Therefore, the co-localization information of the markers can be inferred from the biological knowledge, i.e. CD3 and CD8 co-locate in the membrane while FoxP3 and HTX may appear in the same nucleus. We can also have tumor marker on the tumor cell's cytoplasmic region and B-cell marker on the B-cell's membrane. The framework of our proposed algorithm is shown in Fig. 3 using the previous immune cell example. Based on the provided biological co-localization information of the biomarkers, we conclude that only two colors can co-exist at each pixel for this case. The six chromogenic stains are therefore grouped into four different groups where co-localized stains are in the same group, as shown in the right panel of Fig. 3.

For the preprocessing, the RGB image I is converted into the optical density (OD) space using the following formula derived from Beer's law based on optical density being proportional to the stain concentration.


                        
                           
                              (1)
                              
                                 
                                    O
                                    c
                                 
                                 =
                                 −
                                 log
                                 
                                    
                                       
                                          
                                             
                                                
                                                   I
                                                   c
                                                
                                             
                                             
                                                
                                                   I
                                                   
                                                      0
                                                      ,
                                                      c
                                                   
                                                
                                             
                                          
                                       
                                    
                                 
                              
                           
                        where c is the index of the RGB color channels, I
                        0 is the RGB value of the white points and O is the optical density image obtained. Similar to [10], O will be image to work with in the rest of the paper. The RGB optical density space is shown in Fig. 5
                        , the observed absorbance vector for each pixel (e.g. red dot A) is a linear combination of the underlying reference stain absorbance vectors (e.g. Stain 1 and Stain 2).

We begin with illustrating the notations used in this paper. Let y be a pixel of O and it is a three-dimensional column vector corresponding to the OD values converted from RGB. Assume there are M biomarkers available in the multiplex IHC slide. We have M stain colors. Let b be the combination weight vector of the stains and b
                        
                           m
                        , m
                        =1, …, M is the m
                        
                           th
                         element of b. The typical unmixing problem thus is formulated as the following:
                           
                              (2)
                              
                                 
                                    min
                                    
                                       
                                          b
                                       
                                    
                                 
                                 |
                                 |
                                 
                                    
                                       y
                                    
                                 
                                 −
                                 X
                                 
                                    
                                       b
                                    
                                 
                                 |
                                 
                                    |
                                    2
                                    2
                                 
                              
                           
                        Each column of X corresponds to a reference stain color sampled from the control slide of pure stain. As discussed before, this linear system has a solution only when the column of X is less than or equal to 3 for y
                        ∈
                        R
                        3. Therefore, meaningful regularization is needed for the linear system to have a solution.

The biomarker co-localization information provides a partition of b into a set of groups g
                        1, g
                        2, …, g
                        
                           N
                        , N being the total number of groups. Within each group, the biomarkers are known to have the co-localization possibility. We adopt this biological information to formulate the regularization term of the cost function. Let g
                        
                           i
                         be a q
                        
                           i
                        -dimensional column vector representing the combination weights of the stains within the i
                        
                           th
                         group and q
                        
                           i
                         be the number of stains within the group g
                        
                           i
                        . We have q
                        1
                        +
                        q
                        2
                        +⋯+
                        q
                        
                           N
                        
                        =
                        M. x
                        
                           i
                         denotes the i
                        
                           th
                         group of reference colors, which is a 3×
                        q
                        
                           i
                         matrix. Fig. 3 shows an example of the stain group setting. Six stains are available in this example (M
                        =6). Two of them are co-localized membrane stains and two are co-localized nucleus stains. One is tumor cytokeratin stain and the last is a membrane stain, but only for B-cells. This information allows us to divide the stains into four groups (N
                        =4) as shown in Fig. 3. For instance, g
                        2 contains b
                        2 and b
                        3 that are corresponding to the two co-located nucleus stains and x
                        2 contains the reference color vectors for all the stains within the 2
                           nd
                         group. However, the 4
                           th
                         stain of B-cell marker does not co-localize with other biomarkers, so g
                        3 only has one single member b
                        4 and x
                        3 is its reference color vector.

More specifically, the unmixing problem is formulated as the following convex optimization problem with the aforementioned notations:
                           
                              (3)
                              
                                 
                                    min
                                    
                                       
                                          b
                                       
                                    
                                 
                                 |
                                 |
                                 
                                    
                                       y
                                    
                                 
                                 −
                                 
                                    ∑
                                    
                                       i
                                       =
                                       1
                                    
                                    N
                                 
                                 
                                    x
                                    i
                                 
                                 
                                    g
                                    i
                                 
                                 |
                                 
                                    |
                                    2
                                    2
                                 
                                 +
                                 λ
                                 
                                    ∑
                                    
                                       i
                                       =
                                       1
                                    
                                    N
                                 
                                 
                                    
                                       
                                          q
                                          i
                                       
                                    
                                 
                                 |
                                 |
                                 
                                    g
                                    i
                                 
                                 |
                                 
                                    |
                                    2
                                 
                              
                           
                        where 
                           
                              
                                 b
                              
                           
                           =
                           
                              
                                 [
                                 
                                    b
                                    1
                                 
                                 ,
                                 
                                    b
                                    2
                                 
                                 ,
                                 …
                                 ,
                                 
                                    b
                                    M
                                 
                                 ]
                              
                              t
                           
                           =
                           
                              
                                 [
                                 
                                    g
                                    1
                                    t
                                 
                                 ,
                                 
                                    g
                                    2
                                    t
                                 
                                 ,
                                 …
                                 ,
                                 
                                    g
                                    N
                                    t
                                 
                                 ]
                              
                              t
                           
                         and ||·||2 is the Euclidean norm with out squared. The first term in Eq. (3) solves for the linear system that is equivalent to [10], which minimize the least square error between the intensity of the raw image and the possible linear combination of the reference colors that approximates the raw image. λ is the regularization parameter that controls the amount of the group sparsity constraint in the second term. This model will act like LASSO at the group level. The entire groups will be dropped out when optimal b (or g) is found, that is only a small number of g
                        
                           i
                         are non-zero.

Note that when the size of each group q
                        
                           i
                        
                        =1, the model becomes equivalent to LASSO. In this case, no biological co-localization information is used in the model, however, the system remains to be solvable due to the sparsity constraints. The background noise is suppressed in this setting, comparing to the conventional Ruifrok's method. In the experiment section, we will also demonstrate the efficacy of LASSO unmixing by limiting the size of the group to 1.

Alternative direction method of multipliers (ADMM) algorithm [28] is used to solve Eq. (3). ADMM is an optimization technique for convex programming. It linearly separates the objective function into multiple individual convex functions, for example minimizing f(x)+
                        g(z) subject to Ax
                        +
                        Bz
                        =
                        c. The algorithm consists of x-minimization step 
                           
                              x
                              
                                 k
                                 +
                                 1
                              
                           
                           =
                           
                              argmin
                              x
                           
                           
                              L
                              ρ
                           
                           (
                           x
                           ,
                           
                              z
                              k
                           
                           ,
                           
                              y
                              k
                           
                           )
                         of the augmented Lagrangian L
                        
                           ρ
                        (x, z, y)=
                        f(x)+
                        g(z)+
                        y
                        
                           T
                        (Ax
                        +
                        Bz
                        −
                        c)+(ρ/2)||Ax
                        +
                        Bz
                        −
                        c||2, and z-minimization step 
                           
                              z
                              
                                 x
                                 +
                                 1
                              
                           
                           =
                           
                              argmin
                              z
                           
                           
                              L
                              ρ
                           
                           (
                           
                              x
                              
                                 k
                                 +
                                 1
                              
                           
                           ,
                           z
                           ,
                           
                              y
                              k
                           
                           )
                        , followed by a dual variable y update step y
                        
                           k+1
                        =
                        y
                        
                           k
                        
                        +
                        ρ(Ax
                        
                           k+1
                        +
                        Bz
                        
                           k+1
                        −
                        c).

We implemented the algorithm in C++ to provide fast computation. It costs an estimated 7s to unmix a 750 by 1400 image on an Intel Core i7 1.87GHZ PC.

@&#EXPERIMENTS@&#

In this section, we empirically validate our unmixing algorithm and compare it against the existing techniques.

Typically, there is no method for quantitative evaluation of the unmixing results. A pathologist can exam the unmixed images and visually compare to the raw data to find the biologically flawed regions. We may use a multi-spectral scanner to obtain the images at different color channels, however, this also cannot be used for quantitative evaluation since it is difficult to get a color filter that exactly matches the stain color. As ground truth unmixing results are not available for real clinical data, we created a synthetic multiplex image from ground truth unmixed channels to quantitatively validate our algorithm. We first synthetically generated six unmixed images, as shown in the first row of Fig. 8, following the stain co-localization and grouping rule in the example framework (Fig. 3). The vectorized binary masks of the unmixed channels were multiplied by the reference color matrix to create the multiplex image in Fig. 6
                        . More specifically, a pixel of multiplex image y here is generated by y
                        =
                        Ax, where A is the reference color matrix and x is a vector of pixels corresponding to the pre-defined unmixed images. To demonstrate the algorithm performance w.r.t. the group sparsity regularization parameter λ variation, we plotted the average intensity error between the algorithm outputs and the ground truth unmixed channels in Fig. 7
                         for λ within the range 0–2. The plot shows that the system has stable solutions when λ
                        >0.3. In Fig. 8
                        , we also show the unmixing results when increasing λ. Note that when λ
                        =0.01, the system is close to deficient as in Eq. (2), hence unmixing errors are observed as shown in the second row of Fig. 8.

A clinical data set containing several different cancer tissue samples was used to demonstrate the proposed algorithm. 32 fields of view (FOVs) from colorectal cancer, non-small cell lung cancer, and breast cancer were included in the data set. The tissues were stained with the following assays as shown in Fig. 9
                        : yellow chromogen for tumor cell cytokeratin, purple for regulatory T-cell nucleus, blue for universal nucleus, light blue for B-cell membrane, orange for universal T-cell membrane, and dark green for cytotoxic T-cell membrane. Fig. 11
                         shows the unmixing examples of decomposing the multiplexed image into single stain channels using modified Ruifrok's method based on nearest neighbor color assignment and the proposed group sparsity method. Note that λ is set to be 0.5 through the clinical data experiments. We obtain λ through a cross-validation type of experiment on this data set. Since ground truth unmixing result is unavailable, the pathologist visually exams the unmixed images and picks the best result based on domain knowledge, finally the λ that is associated with the selected unmixing result is preferred. Pixel discontinuities, unmixing errors, and artifacts were observed from the modified Ruifrok's method by solving multiple three color systems using the color similarity for system assignment. The proposed method instead solves one single system for all the pixels which lead to smoother unmixed images while maintaining the biological constraints and reducing the background noise due to the group sparsity regularization.

Since the cytotoxic T-cell is a subset of the universal T-cell, the green cytotoxic T-cell membrane marker always co-localizes with the orange universal T-cell membrane marker, but the orange marker can present alone. Fig. 12
                         shows an example of the orange only cell, and the green and orange co-localized cell. We can see that the algorithm is able to handle both cases. This demonstrates that the L
                        2 norm constraint is used within the group to linearly separate the color mixture into different stain channels. Meanwhile, the modified Ruifrok's method is prone to unmixing errors due to the hard assignment of the unmixing system based on color similarity.

The algorithm can also be applied in cases of less than or equal to three color unmixing. When the group size becomes 1, the algorithm is equivalent to Ruifrok's unmixing plus a sparse constraint on the combination weights. The system can be solved by LASSO. In this experiment, we set the group size to 1 and compared to Ruifrok's method [10] for two-stain unmixing on a clinical breast cancer data set containing 217 FOVs. The proposed technique consistently showed better performance than Ruifrok's method. Example results are shown in Fig. 10
                         with significantly less background noise observed when using the proposed sparse unmixing method.

A cohort of breast cancer tissue was stained with a marker panel consisting of FP3, CD3, CD8, as well as a tumor marker. As shown in Fig. 13
                        , a tissue block was cutted into parallel thin pieces and each piece was stained by the same multiple dyes. Left of the figure shows the three thumbnails of the whole slide images and right of the figure shows the FOVs indicated by the red boxes in the thumbnails. Due to the fact that the serially sectioned slides are close to each other (e.g. 4μm thickness), the tissue contexts on the images are similar. As a result, similar cell counts are expected on the serially sectioned slides for FP3, CD3 and CD8. Since no ground truth unmixing is available for the true clinical data set, we designed the following experiment to assess the unmixing performance. The data set contains 47 FOVs annotated by an expert pathologist. The stained slides were scanned at 40× on the Ventana iScan HT scanner. We first applied the proposed unmixing algorithm to obtain the individual channels for each marker and then trained a convolutional neural nets based cell detector [29] to detect different types of immune cells. The example detection results are shown in Fig. 14
                        . Finally, we compare the cell counts detected from different serial sections to see if similar counts were reported. As shown in Fig. 15
                        , the x-,y- and z-axes indicate the cell counts from each slide in the serial sections and the blue line shows the coordinates of the same counts from the three serial sectional slides. Thus, each red dot represents one triplet of counts. We observed consistent counting results from the serial sections as the red dots are clustered around the blue line. This experiment also serves as an application to the proposed unmixing algorithm.

@&#CONCLUSION@&#

In this paper, we introduced a novel color unmixing strategy for multiplexed bright field histopathology images based on a group sparsity model. The biological co-localization information of the biomarkers is explicitly defined in the regularization term to produce biologically meaningful unmixing results. The experiments of both synthetic and clinical data demonstrate the efficacy of the proposed algorithm in terms of accuracy and stability when compared to the existing techniques. A promising immediate avenue for future research is the incorporation of the structural preserving constraint [30] to the group sparse unmixing.

@&#REFERENCES@&#

